<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <link rel="dns-prefetch" href="http://zy84338719.github.io/blog">
  <title>Murphy Yi site</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="学习总结">
<meta property="og:type" content="website">
<meta property="og:title" content="Murphy Yi site">
<meta property="og:url" content="http://zy84338719.github.io/blog/page/2/index.html">
<meta property="og:site_name" content="Murphy Yi site">
<meta property="og:description" content="学习总结">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Murphy Yi">
<meta name="twitter:card" content="summary">
  
    <link rel="alternative" href="/atom.xml" title="Murphy Yi site" type="application/atom+xml">
  
  
    <link rel="icon" href="img/favicon.png">
  
  <link rel="stylesheet" type="text/css" href="/./main.0cf68a.css">
  <style type="text/css">
  
    #container.show {
      background: linear-gradient(200deg,#a0cfe4,#e8c37e);
    }
  </style>
  

  
<script>
var _hmt = _hmt || [];
(function() {
	var hm = document.createElement("script");
	hm.src = "https://hm.baidu.com/hm.js?910a5dff7e42c4e5203432203dc26436";
	var s = document.getElementsByTagName("script")[0]; 
	s.parentNode.insertBefore(hm, s);
})();
</script>


<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container" q-class="show:isCtnShow">
    <canvas id="anm-canvas" class="anm-canvas"></canvas>
    <div class="left-col" q-class="show:isShow">
      
<div class="overlay" style="background: #4d4d4d"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img src="img/head.png" class="js-avatar">
		</a>
		<hgroup>
		  <h1 class="header-author"><a href="/"></a></h1>
		</hgroup>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
				<li><a href="/archives/">归档</a></li>
	        
				<li><a target="_blank" rel="noopener" href="https://cv.murphyyi.com">个人主页</a></li>
	        
				<li><a target="_blank" rel="noopener" href="https://www.yuque.com/murphyyi/blog/">语雀</a></li>
	        
				<li><a target="_blank" rel="noopener" href="https://ework.murphyyi.com">导航</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
    		
    			
    			<a q-on="click: openSlider(e, 'innerArchive')" href="javascript:void(0)">所有文章</a>
    			
            
    			
    			<a q-on="click: openSlider(e, 'friends')" href="javascript:void(0)">友链</a>
    			
            
    			
    			<a q-on="click: openSlider(e, 'aboutme')" href="javascript:void(0)">关于我</a>
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="https://github.com/zy84338719" title="github"><i class="icon-github"></i></a>
		        
					<a class="jianshu" target="_blank" href="https://www.jianshu.com/u/872f0bfc7a2b" title="jianshu"><i class="icon-jianshu"></i></a>
		        
					<a class="mail" target="_blank" href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=SzEyc394eHN8enILPSI7ZTo6ZSgkJg" title="mail"><i class="icon-mail"></i></a>
		        
					<a class="rss" target="_blank" href="/atom.xml" title="rss"><i class="icon-rss"></i></a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col" q-class="show:isShow,hide:isShow|isFalse">
      
<nav id="mobile-nav">
  	<div class="overlay js-overlay" style="background: #4d4d4d"></div>
	<div class="btnctn js-mobile-btnctn">
  		<div class="slider-trigger list" q-on="click: openSlider(e)"><i class="icon icon-sort"></i></div>
	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img src="img/head.png" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author js-header-author"></h1>
			</hgroup>
			
			
			
				
			
				
			
				
			
				
			
				
			
			
			
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/zy84338719" title="github"><i class="icon-github"></i></a>
			        
						<a class="jianshu" target="_blank" href="https://www.jianshu.com/u/872f0bfc7a2b" title="jianshu"><i class="icon-jianshu"></i></a>
			        
						<a class="mail" target="_blank" href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=SzEyc394eHN8enILPSI7ZTo6ZSgkJg" title="mail"><i class="icon-mail"></i></a>
			        
						<a class="rss" target="_blank" href="/atom.xml" title="rss"><i class="icon-rss"></i></a>
			        
				</div>
			</nav>

			<nav class="header-menu js-header-menu">
				<ul style="width: 70%">
				
				
					<li style="width: 20%"><a href="/">主页</a></li>
		        
					<li style="width: 20%"><a href="/archives/">归档</a></li>
		        
					<li style="width: 20%"><a target="_blank" rel="noopener" href="https://cv.murphyyi.com">个人主页</a></li>
		        
					<li style="width: 20%"><a target="_blank" rel="noopener" href="https://www.yuque.com/murphyyi/blog/">语雀</a></li>
		        
					<li style="width: 20%"><a target="_blank" rel="noopener" href="https://ework.murphyyi.com">导航</a></li>
		        
				</ul>
			</nav>
		</header>				
	</div>
	<div class="mobile-mask" style="display:none" q-show="isShow"></div>
</nav>

      <div id="wrapper" class="body-wrap">
        <div class="menu-l">
          <div class="canvas-wrap">
            <canvas data-colors="#eaeaea" data-sectionHeight="100" data-contentId="js-content" id="myCanvas1" class="anm-canvas"></canvas>
          </div>
          <div id="js-content" class="content-ll">
            
  
    <article id="post-yuque/HTTP 协议入门（HTTP0.9-HTTP!3）" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/04/17/yuque/HTTP%20%E5%8D%8F%E8%AE%AE%E5%85%A5%E9%97%A8%EF%BC%88HTTP0.9-HTTP!3%EF%BC%89/">HTTP 协议入门（HTTP0.9-HTTP/3）</a>
    </h1>
  

        
        <a href="/2021/04/17/yuque/HTTP%20%E5%8D%8F%E8%AE%AE%E5%85%A5%E9%97%A8%EF%BC%88HTTP0.9-HTTP!3%EF%BC%89/" class="archive-article-date">
  	<time datetime="2021-04-17T08:10:15.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2021-04-17</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>HTTP 协议是互联网的基础协议，也是网页开发的必备知识，最新版本 HTTP/2 更是让它成为技术热点。<br>本文介绍 HTTP 协议的历史演变和设计思路。<br><img src="https://cdn.nlark.com/yuque/0/2021/jpeg/190217/1618647033120-a95f8401-0de1-464f-9f43-2aca7cf0a18a.jpeg#clientId=ub15e04e4-d048-4&from=paste&height=180&id=Yqo9v&margin=%5Bobject%20Object%5D&originHeight=180&originWidth=478&originalType=url&status=done&style=none&taskId=ub34df6f9-f37f-4284-a8cd-8fa8489ee78&width=478"></p>
<h2 id="一、HTTP-0-9"><a href="#一、HTTP-0-9" class="headerlink" title="一、HTTP/0.9"></a>一、HTTP/0.9</h2><p>HTTP 是基于 TCP/IP 协议的<a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2012/05/internet_protocol_suite_part_i.html">应用层协议</a>。它不涉及数据包（packet）传输，主要规定了客户端和服务器之间的通信格式，默认使用 80 端口。<br>最早版本是 1991 年发布的 0.9 版。该版本极其简单，只有一个命令 GET。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /index.html</span><br></pre></td></tr></table></figure>

<p>上面命令表示，TCP 连接（connection）建立后，客户端向服务器请求（request）网页 index.html。<br>协议规定，服务器只能回应 HTML 格式的字符串，不能回应别的格式。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    Hello World</span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>服务器发送完毕，就关闭 TCP 连接。</p>
<h2 id="二、HTTP-1-0"><a href="#二、HTTP-1-0" class="headerlink" title="二、HTTP/1.0"></a>二、HTTP/1.0</h2><h3 id="2-1-简介"><a href="#2-1-简介" class="headerlink" title="2.1 简介"></a>2.1 简介</h3><p>1996 年 5 月，HTTP/1.0 版本发布，内容大大增加。<br>首先，任何格式的内容都可以发送。这使得互联网不仅可以传输文字，还能传输图像、视频、二进制文件。这为互联网的大发展奠定了基础。<br>其次，除了 GET 命令，还引入了 POST 命令和 HEAD 命令，丰富了浏览器与服务器的互动手段。<br>再次，HTTP 请求和回应的格式也变了。除了数据部分，每次通信都必须包括头信息（HTTP header），用来描述一些元数据。<br>其他的新增功能还包括状态码（status code）、多字符集支持、多部分发送（multi-part type）、权限（authorization）、缓存（cache）、内容编码（content encoding）等。</p>
<h3 id="2-2-请求格式"><a href="#2-2-请求格式" class="headerlink" title="2.2 请求格式"></a>2.2 请求格式</h3><p>下面是一个 1.0 版的 HTTP 请求的例子。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET / HTTP/1.0 User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_5)</span><br><span class="line">Accept: */*</span><br></pre></td></tr></table></figure>

<p>可以看到，这个格式与 0.9 版有很大变化。<br>第一行是请求命令，必须在尾部添加协议版本（HTTP/1.0）。后面就是多行头信息，描述客户端的情况。</p>
<h3 id="2-3-回应格式"><a href="#2-3-回应格式" class="headerlink" title="2.3 回应格式"></a>2.3 回应格式</h3><p>服务器的回应如下。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">HTTP/1.0 200 OK</span><br><span class="line">Content-Type: text/plain</span><br><span class="line">Content-Length: 137582</span><br><span class="line">Expires: Thu, 05 Dec 1997 16:00:00 GMT</span><br><span class="line">Last-Modified: Wed, 5 August 1996 15:55:28 GMT</span><br><span class="line">Server: Apache 0.84</span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;body&gt;Hello World&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>回应的格式是”头信息 + 一个空行（\r\n） + 数据”。其中，第一行是”协议版本 + 状态码（status code） + 状态描述”。</p>
<h3 id="2-4-Content-Type-字段"><a href="#2-4-Content-Type-字段" class="headerlink" title="2.4 Content-Type 字段"></a>2.4 Content-Type 字段</h3><p>关于字符的编码，1.0 版规定，头信息必须是 ASCII 码，后面的数据可以是任何格式。因此，服务器回应的时候，必须告诉客户端，数据是什么格式，这就是 Content-Type 字段的作用。<br>下面是一些常见的 Content-Type 字段的值。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">text/plain</span><br><span class="line">text/html</span><br><span class="line">text/css</span><br><span class="line">image/jpeg</span><br><span class="line">image/png</span><br><span class="line">image/svg+xml</span><br><span class="line">audio/mp4</span><br><span class="line">video/mp4</span><br><span class="line">application/javascript</span><br><span class="line">application/pdf</span><br><span class="line">application/zip</span><br><span class="line">application/atom+xml</span><br></pre></td></tr></table></figure>

<p>这些数据类型总称为 MIME type，每个值包括一级类型和二级类型，之间用斜杠分隔。<br>除了预定义的类型，厂商也可以自定义类型。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">application / vnd.debian.binary - package</span><br></pre></td></tr></table></figure>

<p>上面的类型表明，发送的是 Debian 系统的二进制数据包。<br>MIME type 还可以在尾部使用分号，添加参数。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Type: text/html; charset=utf-8</span><br></pre></td></tr></table></figure>

<p>上面的类型表明，发送的是网页，而且编码是 UTF-8。<br>客户端请求的时候，可以使用 Accept 字段声明自己可以接受哪些数据格式。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Accept: */*</span><br></pre></td></tr></table></figure>

<p>上面代码中，客户端声明自己可以接受任何格式的数据。<br>MIME type 不仅用在 HTTP 协议，还可以用在其他地方，比如 HTML 网页。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html; charset=UTF-8&quot;</span> /&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 等同于 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-5-Content-Encoding-字段"><a href="#2-5-Content-Encoding-字段" class="headerlink" title="2.5 Content-Encoding 字段"></a>2.5 Content-Encoding 字段</h3><p>由于发送的数据可以是任何格式，因此可以把数据压缩后再发送。Content-Encoding 字段说明数据的压缩方法。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Content-Encoding: gzip</span><br><span class="line">Content-Encoding: compress</span><br><span class="line">Content-Encoding: deflate</span><br></pre></td></tr></table></figure>

<p>客户端在请求时，用 Accept-Encoding 字段说明自己可以接受哪些压缩方法。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Accept-Encoding: gzip, deflate</span><br></pre></td></tr></table></figure>

<h3 id="2-6-缺点"><a href="#2-6-缺点" class="headerlink" title="2.6 缺点"></a>2.6 缺点</h3><p>HTTP/1.0 版的主要缺点是，每个 TCP 连接只能发送一个请求。发送数据完毕，连接就关闭，如果还要请求其他资源，就必须再新建一个连接。<br>TCP 连接的新建成本很高，因为需要客户端和服务器三次握手，并且开始时发送速率较慢（slow start）。所以，HTTP 1.0 版本的性能比较差。随着网页加载的外部资源越来越多，这个问题就愈发突出了。<br>为了解决这个问题，有些浏览器在请求时，用了一个非标准的 Connection 字段。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Connection: keep-alive</span><br></pre></td></tr></table></figure>

<p>这个字段要求服务器不要关闭 TCP 连接，以便其他请求复用。服务器同样回应这个字段。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Connection: keep-alive</span><br></pre></td></tr></table></figure>

<p>一个可以复用的 TCP 连接就建立了，直到客户端或服务器主动关闭连接。但是，这不是标准字段，不同实现的行为可能不一致，因此不是根本的解决办法。</p>
<h2 id="三、HTTP-1-1"><a href="#三、HTTP-1-1" class="headerlink" title="三、HTTP/1.1"></a>三、HTTP/1.1</h2><p>1997 年 1 月，HTTP/1.1 版本发布，只比 1.0 版本晚了半年。它进一步完善了 HTTP 协议，一直用到了 20 年后的今天，直到现在还是最流行的版本。</p>
<h3 id="3-1-持久连接"><a href="#3-1-持久连接" class="headerlink" title="3.1 持久连接"></a>3.1 持久连接</h3><p>1.1 版的最大变化，就是引入了持久连接（persistent connection），即 TCP 连接默认不关闭，可以被多个请求复用，不用声明 Connection: keep-alive。<br>客户端和服务器发现对方一段时间没有活动，就可以主动关闭连接。不过，规范的做法是，客户端在最后一个请求时，发送 Connection: close，明确要求服务器关闭 TCP 连接。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Connection: close</span><br></pre></td></tr></table></figure>

<p>目前，对于同一个域名，大多数浏览器允许同时建立 6 个持久连接。</p>
<h3 id="3-2-管道机制"><a href="#3-2-管道机制" class="headerlink" title="3.2 管道机制"></a>3.2 管道机制</h3><p>1.1 版还引入了管道机制（pipelining），即在同一个 TCP 连接里面，客户端可以同时发送多个请求。这样就进一步改进了 HTTP 协议的效率。<br>举例来说，客户端需要请求两个资源。以前的做法是，在同一个 TCP 连接里面，先发送 A 请求，然后等待服务器做出回应，收到后再发出 B 请求。管道机制则是允许浏览器同时发出 A 请求和 B 请求，但是服务器还是按照顺序，先回应 A 请求，完成后再回应 B 请求。</p>
<h3 id="3-3-Content-Length-字段"><a href="#3-3-Content-Length-字段" class="headerlink" title="3.3 Content-Length 字段"></a>3.3 Content-Length 字段</h3><p>一个 TCP 连接现在可以传送多个回应，势必就要有一种机制，区分数据包是属于哪一个回应的。这就是 Content-length 字段的作用，声明本次回应的数据长度。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Length: 3495</span><br></pre></td></tr></table></figure>

<p>上面代码告诉浏览器，本次回应的长度是 3495 个字节，后面的字节就属于下一个回应了。<br>在 1.0 版中，Content-Length 字段不是必需的，因为浏览器发现服务器关闭了 TCP 连接，就表明收到的数据包已经全了。</p>
<h3 id="3-4-分块传输编码"><a href="#3-4-分块传输编码" class="headerlink" title="3.4 分块传输编码"></a>3.4 分块传输编码</h3><p>使用 Content-Length 字段的前提条件是，服务器发送回应之前，必须知道回应的数据长度。<br>对于一些很耗时的动态操作来说，这意味着，服务器要等到所有操作完成，才能发送数据，显然这样的效率不高。更好的处理方法是，产生一块数据，就发送一块，采用”流模式”（stream）取代”缓存模式”（buffer）。<br>因此，1.1 版规定可以不使用 Content-Length 字段，而使用<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%88%86%E5%9D%97%E4%BC%A0%E8%BE%93%E7%BC%96%E7%A0%81">“分块传输编码”</a>（chunked transfer encoding）。</p>
<blockquote>
<p><strong>分块传输编码</strong>（<strong>Chunked transfer encoding</strong>）是超文本传输协议（HTTP）中的一种数据传输机制，允许<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/HTTP">HTTP</a>由<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%B6%B2%E9%A0%81%E4%BC%BA%E6%9C%8D%E5%99%A8">网页服务器</a>发送给<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%AE%A2%E6%88%B7%E7%AB%AF">客户端</a><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%BA%94%E7%94%A8%E8%BD%AF%E4%BB%B6">应用</a>（ 通常是<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%BD%91%E9%A1%B5%E6%B5%8F%E8%A7%88%E5%99%A8">网页浏览器</a>）的数据可以分成多个部分。分块传输编码只在 HTTP 协议 1.1 版本（HTTP/1.1）中提供。<br>通常，HTTP 应答消息中发送的数据是整个发送的，Content-Length 消息头字段表示数据的长度。数据的长度很重要，因为客户端需要知道哪里是应答消息的结束，以及后续应答消息的开始。然而，使用分块传输编码，数据分解成一系列数据块，并以一个或多个块发送，这样服务器可以发送数据而不需要预先知道发送内容的总大小。通常数据块的大小是一致的，但也不总是这种情况。</p>
</blockquote>
<p>只要请求或回应的头信息有 Transfer-Encoding 字段，就表明回应将由数量未定的数据块组成。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Transfer-Encoding: chunked</span><br></pre></td></tr></table></figure>

<p>每个非空的数据块之前，会有一个 16 进制的数值，表示这个块的长度。最后是一个大小为 0 的块，就表示本次回应的数据发送完了。下面是一个例子。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK Content-Type: text/plain Transfer-Encoding: chunked 25 This is</span><br><span class="line">the data in the first chunk 1C and this is the second one 3 con 8 sequence 0</span><br></pre></td></tr></table></figure>

<h3 id="3-5-其他功能"><a href="#3-5-其他功能" class="headerlink" title="3.5 其他功能"></a>3.5 其他功能</h3><p>1.1 版还新增了许多动词方法：PUT、PATCH、HEAD、OPTIONS、DELETE。<br>另外，客户端请求的头信息新增了 Host 字段，用来指定服务器的域名。</p>
<p>Host: <a target="_blank" rel="noopener" href="http://www.example.com/">www.example.com</a></p>
<p>有了 Host 字段，就可以将请求发往同一台服务器上的不同网站，为虚拟主机的兴起打下了基础。</p>
<h3 id="3-6-缺点"><a href="#3-6-缺点" class="headerlink" title="3.6 缺点"></a>3.6 缺点</h3><p>虽然 1.1 版允许复用 TCP 连接，但是同一个 TCP 连接里面，所有的数据通信是按次序进行的。服务器只有处理完一个回应，才会进行下一个回应。要是前面的回应特别慢，后面就会有许多请求排队等着。这称为<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E9%98%9F%E5%A4%B4%E9%98%BB%E5%A1%9E">“队头堵塞”</a>（Head-of-line blocking）。</p>
<blockquote>
<p><strong>队头阻塞</strong>（英語：<strong>Head-of-line blocking</strong>，缩写：HOL blocking）在<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C">计算机网络</a>的范畴中是一种性能受限的现象。它的原因是一列的第一个数据包（队头）受阻而导致整列数据包受阻。例如它有可能在缓存式输入的交换机中出现，有可能因为传输顺序错乱而出现，亦有可能在 HTTP 流水线中有多个请求的情况下出现。</p>
</blockquote>
<p>为了避免这个问题，只有两种方法：一是减少请求数，二是同时多开持久连接。这导致了很多的网页优化技巧，比如合并脚本和样式表、将图片嵌入 CSS 代码、域名分片（domain sharding）等等。如果 HTTP 协议设计得更好一些，这些额外的工作是可以避免的。</p>
<h2 id="四、SPDY-协议"><a href="#四、SPDY-协议" class="headerlink" title="四、SPDY 协议"></a>四、SPDY 协议</h2><p>2009 年，谷歌公开了自行研发的 SPDY 协议，主要解决 HTTP/1.1 效率不高的问题。<br>这个协议在 Chrome 浏览器上证明可行以后，就被当作 HTTP/2 的基础，主要特性都在 HTTP/2 之中得到继承。</p>
<h2 id="五、HTTP-2"><a href="#五、HTTP-2" class="headerlink" title="五、HTTP/2"></a>五、HTTP/2</h2><p>2015 年，HTTP/2 发布。它不叫 HTTP/2.0，是因为标准委员会不打算再发布子版本了，下一个新版本将是 HTTP/3。</p>
<h3 id="5-1-二进制协议"><a href="#5-1-二进制协议" class="headerlink" title="5.1 二进制协议"></a>5.1 二进制协议</h3><p>HTTP/1.1 版的头信息肯定是文本（ASCII 编码），数据体可以是文本，也可以是二进制。HTTP/2 则是一个彻底的二进制协议，头信息和数据体都是二进制，并且统称为”帧”（frame）：头信息帧和数据帧。<br>二进制协议的一个好处是，可以定义额外的帧。HTTP/2 定义了近十种帧，为将来的高级应用打好了基础。如果使用文本实现这种功能，解析数据将会变得非常麻烦，二进制解析则方便得多。</p>
<h3 id="5-2-多工"><a href="#5-2-多工" class="headerlink" title="5.2 多工"></a>5.2 多工</h3><p>HTTP/2 复用 TCP 连接，在一个连接里，客户端和浏览器都可以同时发送多个请求或回应，而且不用按照顺序一一对应，这样就避免了”队头堵塞”。<br>举例来说，在一个 TCP 连接里面，服务器同时收到了 A 请求和 B 请求，于是先回应 A 请求，结果发现处理过程非常耗时，于是就发送 A 请求已经处理好的部分， 接着回应 B 请求，完成后，再发送 A 请求剩下的部分。<br>这样双向的、实时的通信，就叫做多工（Multiplexing）。</p>
<h3 id="5-3-数据流"><a href="#5-3-数据流" class="headerlink" title="5.3 数据流"></a>5.3 数据流</h3><p>因为 HTTP/2 的数据包是不按顺序发送的，同一个连接里面连续的数据包，可能属于不同的回应。因此，必须要对数据包做标记，指出它属于哪个回应。<br>HTTP/2 将每个请求或回应的所有数据包，称为一个数据流（stream）。每个数据流都有一个独一无二的编号。数据包发送的时候，都必须标记数据流 ID，用来区分它属于哪个数据流。另外还规定，客户端发出的数据流，ID 一律为奇数，服务器发出的，ID 为偶数。<br>数据流发送到一半的时候，客户端和服务器都可以发送信号（RST_STREAM 帧），取消这个数据流。1.1 版取消数据流的唯一方法，就是关闭 TCP 连接。这就是说，HTTP/2 可以取消某一次请求，同时保证 TCP 连接还打开着，可以被其他请求使用。<br>客户端还可以指定数据流的优先级。优先级越高，服务器就会越早回应。</p>
<h3 id="5-4-头信息压缩"><a href="#5-4-头信息压缩" class="headerlink" title="5.4 头信息压缩"></a>5.4 头信息压缩</h3><p>HTTP 协议不带有状态，每次请求都必须附上所有信息。所以，请求的很多字段都是重复的，比如 Cookie 和 User Agent，一模一样的内容，每次请求都必须附带，这会浪费很多带宽，也影响速度。<br>HTTP/2 对这一点做了优化，引入了头信息压缩机制（header compression）。一方面，头信息使用 gzip 或 compress 压缩后再发送；另一方面，客户端和服务器同时维护一张头信息表，所有字段都会存入这个表，生成一个索引号，以后就不发送同样字段了，只发送索引号，这样就提高速度了。</p>
<h3 id="5-5-服务器推送"><a href="#5-5-服务器推送" class="headerlink" title="5.5 服务器推送"></a>5.5 服务器推送</h3><p>HTTP/2 允许服务器未经请求，主动向客户端发送资源，这叫做服务器推送（server push）。<br>常见场景是客户端请求一个网页，这个网页里面包含很多静态资源。正常情况下，客户端必须收到网页后，解析 HTML 源码，发现有静态资源，再发出静态资源请求。其实，服务器可以预期到客户端请求网页后，很可能会再请求静态资源，所以就主动把这些静态资源随着网页一起发给客户端了。</p>
<h2 id="六、HTTP-3"><a href="#六、HTTP-3" class="headerlink" title="六、HTTP/3"></a>六、HTTP/3</h2><p>上节提到 HTTP3 通过更加底层的传输层的优化来提升效率，究竟如何，让我们一起看一下。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/190217/1618647942864-a92110af-72e7-4444-ab69-eef754081c84.png#clientId=ua837cce1-549d-4&from=paste&height=618&id=ubccf37cc&margin=%5Bobject%20Object%5D&originHeight=618&originWidth=1200&originalType=binary&size=385379&status=done&style=none&taskId=uc82c80a2-2c7f-4eaf-82e6-29a3710c0eb&width=1200"><br>通过这个图片，我们可以很清楚的看到，HTTP2 和 HTTP3 的传输层是完全不同的协议，HTTP3 的传输层是 UDP 协议。我们知道 UDP 协议是个不可靠的协议，而 TCP 协议是可靠协议，怎样保证可靠的呢，重传。</p>
<h3 id="QUIC-协议"><a href="#QUIC-协议" class="headerlink" title="QUIC 协议"></a>QUIC 协议</h3><p>在 UDP 协议之上，新增了 QUIC 协议。我的理解是由于 TCP 协议相对于 UDP 协议控制比较复杂耗时，因此针对 HTTP 应用贴身开发了 QUIC 协议代替 TCP 协议中关于可靠、流量控制的部分。</p>
<ul>
<li><p>QUIC 协议特性</p>
<ul>
<li>QUIC 协议提供类似于 HTTP2 的流功能</li>
<li>QUIC 协议使用流 ID 取代 IP 和端口，这样就能实现连接迁移。例如说从 4G 信号切换到 wifi，下层的 IP 和端口变了，但是由于 QUIC 的流 ID 没有变，这个连接不会变，可以继续使用这个连接。</li>
</ul>
</li>
</ul>
<p>然后我们看一下 HTTP3 在 QUIC 上有什么变化呢？HTTP3 由 HTTP2 进化，HTTP2 最大的变化就是基于二进制流的传输。那么到 HTTP3，由于 QUIC 已经管理了流，HTTP3 本身就减负了，将流管理下移 QUIC，而本身就直接调用 QUIC 的接口就可以了。</p>
<h3 id="HTTP3-如何工作"><a href="#HTTP3-如何工作" class="headerlink" title="HTTP3 如何工作"></a>HTTP3 如何工作</h3><ul>
<li>我们回想一下 HTTPS，HTTPS 是类似于 TCP 握手的工作方式，先工作在 HTTP1 上，通过 HTTP1 传递交换得到秘钥，然后切换到 HTTPS 上工作。</li>
<li>接着我们回想一下 HTTP2，HTTP2 也是基于 TLS 的，所以 HTTP2 的工作方式和 HTTPS 也是同样的过程，需要握手建立 TLS 连接，只是 TLS 连接完成后，发送一个 HTTP2 的连接确认消息，确认后，客户端服务器使用 HTTP2 进行连接通讯。</li>
<li>最后让我们看下 HTTP3 如何工作。首先要建立好 HTTP2 连接，然后发送 HTTP2 扩展帧，这个帧包含 IP 和端口，浏览器收到扩展帧，使用该 IP 和端口，使用 QUIC 建立连接，如果成功，断开 HTTP2，升级为 HTTP3。</li>
</ul>
<p>这三者，都用 TCP 的握手协议去理解，都是握手，不同的是握手方式不一样。</p>
<h1 id="七、参考链接"><a href="#七、参考链接" class="headerlink" title="七、参考链接"></a>七、参考链接</h1><ul>
<li><a target="_blank" rel="noopener" href="http://kamranahmed.info/blog/2016/08/13/http-in-depth/">Journey to HTTP/2</a>, by Kamran Ahmed</li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol">HTTP</a>, by Wikipedia</li>
<li><a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc1945">HTTP/1.0 Specification</a></li>
<li><a target="_blank" rel="noopener" href="https://http2.github.io/http2-spec/">HTTP/2 Specification</a></li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2021/04/17/yuque/HTTP%20%E5%8D%8F%E8%AE%AE%E5%85%A5%E9%97%A8%EF%BC%88HTTP0.9-HTTP!3%EF%BC%89/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-yuque/《代码整洁之道》" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/15/yuque/%E3%80%8A%E4%BB%A3%E7%A0%81%E6%95%B4%E6%B4%81%E4%B9%8B%E9%81%93%E3%80%8B/">《代码整洁之道》</a>
    </h1>
  

        
        <a href="/2021/03/15/yuque/%E3%80%8A%E4%BB%A3%E7%A0%81%E6%95%B4%E6%B4%81%E4%B9%8B%E9%81%93%E3%80%8B/" class="archive-article-date">
  	<time datetime="2021-03-15T18:57:25.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2021-03-15</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id=""><a href="#" class="headerlink" title=""></a></h1><h2 id="代码猴子与童子军军规"><a href="#代码猴子与童子军军规" class="headerlink" title="代码猴子与童子军军规"></a>代码猴子与童子军军规</h2><ol>
<li>我们就像一群代码猴子，上蹿下跳，自以为领略了编程的真谛。可惜，当我们抓着几个酸桃子，得意洋洋坐到树枝上，却对自己造成的混乱熟视无睹。那堆“可以运行”的乱麻程序，就在我们的眼皮底下慢慢腐坏。</li>
</ol>
<h2 id="第一章-整洁代码"><a href="#第一章-整洁代码" class="headerlink" title="第一章 整洁代码"></a>第一章 整洁代码</h2><ol>
<li>勒布朗法则：稍后等于永不（Later equals never）。</li>
<li>制造混乱无助于赶上期限。混乱只会立刻拖慢你，叫你错过期限。赶上期限的唯一方法——做的快的唯一方法——就是始终尽可能保持代码整洁。</li>
<li>Javadoc 中的 <code>@author</code> 字段告诉我们自己是什么人。我们是作者，作者都有读者。实际上，作者有责任与读者做良好沟通。下次你写代码的时候，记得自己是作者，要为评判你工作的读者写代码。</li>
</ol>
<h2 id="第三章-函数"><a href="#第三章-函数" class="headerlink" title="第三章 函数"></a>第三章 函数</h2><ol>
<li>函数的第一规则是要短小。第二条规则是还要更短小…经过漫长的试错，经验告诉我，函数就该小。</li>
<li>函数应该做一件事。做好这件事。只做这一件事。判断函数是否不止做了一件事，有一个方法，就是看是否能再拆出一个函数，该函数不仅只是单纯地重新诠释其实现。</li>
<li>要确保函数只做一件事，函数中的语句都要在同一抽象层级上。函数中混杂不同的抽象层级，往往让人迷惑。读者可能无法判断某个表达式是基础概念还是细节。更恶劣的是，就像破损的窗户，一旦细节与基础概念混杂，更多的细节就会在函数中纠结起来。</li>
<li>写出短小的 <code>switch</code> 语句往往很难。写出只做一件事的 <code>switch</code> 语句也很难。我们总不发避开 <code>switch</code> 语句，不过还是能够确保 <code>switch</code> 都埋藏在较低的抽象层级，而且永远不重复。</li>
<li>最理想的参数数量是零，其次是一，再次是二…从测试的角度看，参数甚至更叫人为难。想想看，要编写能确保参数的各种组合运行正常的测试用例，是多么困难的事。如果没有参数，就是小菜一碟。</li>
<li>函数承诺只做一件事，但还是会做其它被藏起来的事。有时，它会对自己类中的变量做出未能预期的改动，导致古怪的时序性耦合及顺序依赖。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserValidator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Cryptographer cryptographer;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkPassword</span><span class="params">(String userName, String password)</span> </span>&#123;</span><br><span class="line">        User user = UserGateway.findByName(userName);</span><br><span class="line">        <span class="keyword">if</span> (user != <span class="keyword">null</span>) &#123;</span><br><span class="line">            String codePhrase = user.getPhraseEncodeByPassword();</span><br><span class="line">            String phrase = cryptographer.decrypt(codePhrase, password);</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;Valid Password&quot;</span>.equals(phrase)) &#123;</span><br><span class="line">                Session.initialize();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>副作用就在于对 <code>Session.initialize()</code> 的调用。<code>checkPassword</code> 函数是用来检查密码的。该名称未暗示它会初始化该次会话。当某个误信了函数名的调用者想要检查用户有效性时，就得冒着抹除现有会话数据的风险。这一副作用造成了一次时序性耦合。也就是说，<code>checkPassword</code> 只能在特定时刻调用。</p>
<h2 id="第四章-注释"><a href="#第四章-注释" class="headerlink" title="第四章 注释"></a>第四章 注释</h2><ol>
<li>注释的恰当用法是弥补我们在用代码表达意图时遭遇的失败。注释总是一种失败。我们总无法找到不用注释就能表达自我的方法，所以总要有注释，这并不值得庆贺。</li>
<li>如果你发现自己需要写注释，再想想看是否有办法翻盘，用代码来表达。</li>
<li>有时，有理由用 <code>// TODO</code> 形式在源代码中放置要做的工作列表。<code>TODO</code> 是一种程序员认为应该做，但由于某些原因目前还没做的工作。</li>
<li>没有什么比被良好描述的公共 API 更有用和令人满意的了。如果你在编写公共 API，就该为它编写良好的 Javadoc。</li>
<li>删掉无用而多余的 Javadoc 吧，这些注释只是一味将代码搞得含糊不明，完全没有文档上的价值。</li>
<li>所谓每个函数都要有 Javadoc 或每个变量都要有注释的规矩全然是愚蠢可笑的。这类注释徒然让代码变得散乱，满口胡言，令人迷惑不解。</li>
<li>20 世纪 60 年代，曾经有那么一段时间，注释掉的代码可能有用。但我们已经拥有优良的源代码控制系统如此之久，这些系统可以为我们记住不要的代码。我们无需再用注释来标记，删掉即可，它们丢不了，我担保。</li>
</ol>
<h2 id="第五章-格式"><a href="#第五章-格式" class="headerlink" title="第五章 格式"></a>第五章 格式</h2><ol>
<li>代码格式很重要，必须严肃对待。代码格式关乎沟通，而沟通是专业开发者的头等大事。</li>
<li>你今天编写的功能，极有可能在下一版本中被修改，但代码的可读性却会对以后可能发生的修改行为产生深远影响。原始代码修改之后很久，其代码风格和可读性仍会影响到可维护性和扩展性。即便代码不复存在，你的风格和律条仍会存活下来。</li>
<li>若某个函数调用了另外一个，就应该把它们放在一起，而且调用者应该尽可能放在被调用者上面。</li>
</ol>
<h2 id="第六章-对象和数据结构"><a href="#第六章-对象和数据结构" class="headerlink" title="第六章 对象和数据结构"></a>第六章 对象和数据结构</h2><ol>
<li>最为精炼的数据结构，是一个只有公共变量、没有函数的类。这种数据结构有时被称为数据传送对象，或 <code>DTO</code>（Data Transfer Objects）。DTO 是非常有用的结构，尤其是在于数据库通信、或解析套接字传输的消息之类的场景中。</li>
</ol>
<h2 id="第七章-使用异常而非返回码"><a href="#第七章-使用异常而非返回码" class="headerlink" title="第七章 使用异常而非返回码"></a>第七章 使用异常而非返回码</h2><ol>
<li>在很久以前，许多语言都不支持异常。这些语言处理和汇报错误的手段都有限。你要么设置一个错误标识，要么返回给调用者检查的错误码。这类手段的问题在于，它们搞乱了调用者代码。调用者必须在调用之后即可检查错误。不幸的是，这个步骤很容易被遗忘。最好是抛出一个异常，这样其逻辑不会被错误处理搞乱。</li>
<li>使用不可控异常。可控异常 <code>checked exception</code> 的代价是违反开闭原则。如果你在方法中抛出可控异常，而 catch 语句在三个层级之上，你就得在 catch 语句和抛出异常处之间的每个方法签名中声明该异常。这意味着对软件中低层级的修改，都将涉及较高层级的签名。最终得到的就是一个从软件最底端贯穿到最高端的修改链。</li>
<li>别返回 null 值。我不想去计算曾经见过多少每行代码都在检查 null 值的应用程序。Java 中有 <code>Colletions.emptyList()</code> 方法，该方法返回一个预定义不可变列表，这样编码，就能尽量避免 <code>NullPointerException</code> 的出现，代码也就更整洁了。</li>
<li>别传递 null 值。在大多数编程语言中，没有良好的方法能对付由调用者意外传入 null 值。事已如此，恰当的做法就是禁止传入 null 值。</li>
</ol>
<h2 id="第八章-边界"><a href="#第八章-边界" class="headerlink" title="第八章 边界"></a>第八章 边界</h2><ol>
<li>第三方代码帮助我们在更少时间内发布更丰富的功能。在利用第三方程序包时，该从何处入手呢？我们没有测试第三方代码的职责，但为要使用的第三方代码编写测试，可能最符合我们的利益。</li>
<li>学习第三方代码很难，整合第三方代码也很难，同时做这两件事难上加难。不要在生产代码中试验新东西，而是编写测试来遍览和理解第三方代码，这叫“学习性测试”。</li>
</ol>
<h2 id="第九章-单元测试"><a href="#第九章-单元测试" class="headerlink" title="第九章 单元测试"></a>第九章 单元测试</h2><ol>
<li>TDD 三定律：<ul>
<li><strong>定律一</strong> 在编写不能通过的单元测试前，不可编写生产代码。</li>
<li><strong>定律二</strong> 只可编写刚好无法通过的单元测试，不能编译也算不通过。</li>
<li><strong>定律三</strong> 只可编写刚好足以通过当前失败测试的生产代码。</li>
</ul>
</li>
<li>TDD 三定律其实说的是，先写失败的 Case，写完之后才开始写功能 Code，只要 Code 通过了 Case，就不要再写功能代码了。也就是说，写完一个测试，就要写对应的生产代码。</li>
<li>测试代码和生产代码一样重要。它可不是二等公民。它需要被思考、被设计和被照料。它该像生产代码一般保持整洁。</li>
<li>如果测试不能保持整洁，你就会失去它们。没有了测试，你就会失去保证生产代码可扩展的一切要素。有了测试，你就不担心对代码的修改！没有测试，每次修改都可能带来缺陷。</li>
<li>覆盖了生产代码的自动化单元测试程序组能尽可能地保持设计和架构的整洁。测试带来了一切好处，因为测试使改动变得可能。</li>
<li>整洁的测试有三个要素：可读性、可读性、可读性。测试应该明确、简洁，还有足够的表达力。在测试中，要以尽量少的文字表达大量的内容。</li>
<li>F.I.R.S.T 规则：<ul>
<li><strong>Fast</strong>（快速） 测试应该能快速运行。测试运行缓慢，你就不会想要频繁地运行它。如果你不频繁运行测试，就不能尽早发现问题，也无法轻易修正。</li>
<li><strong>Independent</strong>（独立） 测试应该相互独立。某个测试不应为下一个测试设定条件。你应该可以单独运行每个测试，及以任何顺序运行测试。</li>
<li><strong>Repeatable</strong>（可重复） 测试应当可在任何环境中重复通过。</li>
<li><strong>Self-Validating</strong> （自足验证） 测试应该有布尔值输出。</li>
<li><strong>Timely</strong>（及时） 测试应及时编写。单元测试应该恰好在使其通过的生产代码之前编写。</li>
</ul>
</li>
</ol>
<h2 id="第十章-类"><a href="#第十章-类" class="headerlink" title="第十章 类"></a>第十章 类</h2><ol>
<li>面向对象的其中一个设计原则是“开放——闭合原则”，即类应当对扩展开放，对修改封闭。我们希望将系统打造成在添加或修改特性时尽可能少惹麻烦的架子。在理想系统中，我们通过扩展系统而不是修改现有代码来添加新特性。</li>
<li>类的另一条设计原则是“依赖倒置原则”（Dependency Inversion Principle, DIP），DIP 认为类应该依赖于抽象而不是依赖于具体细节。</li>
</ol>
<h2 id="第十一章-系统"><a href="#第十一章-系统" class="headerlink" title="第十一章 系统"></a>第十一章 系统</h2><ol>
<li>有一种强大的机制可以实现分离构造与使用，那就是依赖注入（Dependency Injection, DI），它是控制反转（Inversion of Control, IoC）在依赖管理中的一种应用手段。控制反转将第二权责从对象中拿出来，转移到另一个专注于此的对象中，从而遵循了<strong>单一权责原则</strong>。在依赖管理情境中，对象不应负责实体化对自身的依赖，而应当将这份权责移交给其它“有权力”的机制，从而实现控制的反转。</li>
<li>“一开始就做对系统”纯属神话。反之，我们应该只去实现今天的用户故事，然后重构，明天再扩展系统、实现新的用户故事。这就是迭代和增量敏捷的精髓所在。</li>
</ol>
<h2 id="第十二章-迭进"><a href="#第十二章-迭进" class="headerlink" title="第十二章 迭进"></a>第十二章 迭进</h2><ol>
<li>简单设计的四条规则，按重要程度排序：<ul>
<li>运行所有测试；</li>
<li>不可重复；</li>
<li>表达了程序员的意图；</li>
<li>尽可能减少类和方法的数量。</li>
</ul>
</li>
<li>全面测试并持续通过所有测试的系统，就是可测试的系统。看似浅显，但却重要。不可测试的系统同样不可验证。不可验证的系统，绝不应该部署。</li>
<li>重复是拥有良好设计系统的大敌，它代表着额外的工作、额外的风险和额外且不必要的复杂度。要想创建整洁的系统，需要有消除重复的意愿。</li>
<li>软件项目的主要成本在于长期维护。代码应当清晰地表达其作者的意图。作者把代码写得越清晰，其他人花在理解代码上的时间也就越少，从而减少缺陷，缩减维护成本。</li>
<li>为了保持类和函数短小，我们可能会造出太多的细小类和方法。所以这条规则也主张函数和类的数量要少。我们的目标是在保持函数和类短小的同时，保持整个系统短小精悍。不过更重要的是测试、消除重复和表达力。</li>
</ol>
<h2 id="第十三章-并发编程"><a href="#第十三章-并发编程" class="headerlink" title="第十三章 并发编程"></a>第十三章 并发编程</h2><ol>
<li>并发是一种解耦策略。它帮助我们把<strong>做什么</strong>（目的）和<strong>何时做</strong>（时机）分解开。解耦目的与时机能明显地改进应用程序的吞吐量和结构。</li>
<li>并发有时能改进性能，但只在多个线程或处理器之间能分享大量等待时间的时候管用，事情没那么简单。</li>
<li>并发算法的设计有可能与单线程系统的设计极不相同。目的与时机的解耦往往对系统结构产生巨大影响。</li>
<li>并发编程中的一些基础定义：<ul>
<li><strong>限定资源</strong>：并发环境中有着固定尺寸或数量的资源。</li>
<li><strong>互斥</strong>：每一时刻仅有一个线程能访问共享数据或共享资源。</li>
<li><strong>线程饥饿</strong>：一个或一组线程在很长时间内或永久被禁止。例如，总是让执行得快的线程先运行，加入执行得快得线程没完没了，则执行时间长的线程就会“饥饿”。</li>
<li><strong>死锁</strong>：两个或多个线程互相等待执行结束。每个线程都拥有其它线程需要的资源，得不到其它线程拥有的资源，就无法终止。</li>
<li><strong>活锁</strong>：执行次序一致的线程，每个都想要起步，但发现其它线程已经“在路上”。由于竞步的原因，线程会持续尝试起步，但在很长时间内却无法如愿，甚至永远无法启动。</li>
</ul>
</li>
</ol>
<h2 id="第十四章-逐步改进"><a href="#第十四章-逐步改进" class="headerlink" title="第十四章 逐步改进"></a>第十四章 逐步改进</h2><ol>
<li>代码能工作还不够，能工作的代码经常会严重崩溃。满足于仅仅让代码工作的程序员不够专业。他们会害怕没时间改进代码的结构和设计，我不敢苟同。没什么比糟糕的代码给开发项目带来更深远和长期的损害了。</li>
<li>进度可以重订，需求可以重新定义，团队动态可以修正。糟糕的代码只会一直腐败发酵，无情地拖着团队的后腿。</li>
<li>保持代码持续整洁和简单，永不让腐坏有机会开始。</li>
</ol>
<h2 id="第十五章-JUnit-框架"><a href="#第十五章-JUnit-框架" class="headerlink" title="第十五章 JUnit 框架"></a>第十五章 JUnit 框架</h2><ol>
<li>成员变量的前缀可以删除。在现今的运行环境中，这类范围性编码纯属多余。</li>
<li>条件判断应当封装起来，从而更清晰地表达代码的意图。可以拆解处一个方法，解释这个条件判断。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">compact</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (expected == <span class="keyword">null</span> || actual == <span class="keyword">null</span> || areStringsEqual()) &#123;</span><br><span class="line">        <span class="keyword">return</span> Assert.format(message, expected, actual);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 拆解后...</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">compact</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (shouldNotCompact()) &#123;</span><br><span class="line">        <span class="keyword">return</span> Assert.format(message, expected, actual);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">shouldNotCompact</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> expected == <span class="keyword">null</span> || actual == <span class="keyword">null</span> || areStringsEqual();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="第十七章-味道与启发"><a href="#第十七章-味道与启发" class="headerlink" title="第十七章 味道与启发"></a>第十七章 味道与启发</h2><ol>
<li>让注释传达本该更好地在源代码控制系统、问题追踪系统或任何其它记录系统中保存的信息，是不恰当的。</li>
<li>除函数签名之外什么也没说的 Javadoc，也是多余的。</li>
<li>看到注释掉的代码，就删除它！别担心，源代码控制系统还会记得它。</li>
<li>每次看到重复代码，都代表遗漏了抽象。将重复代码叠放进类似的抽象，增加了你的设计语言的词汇量。其它程序员可以用到你创建的抽象设施。编码变得越来越快，错误越来越少，因为你提升了抽象层级。</li>
<li>死代码就是不执行的代码，可以在检查不会发生的条件的 if 语句中找到，可以在从不抛出异常的 try/catch 块中找到，可以在从不调用的小工具方法中找到，也可以在不会发生 switch/case 条件中找到。如果你找到死代码，就体面地埋葬它，将它从系统中删除掉。</li>
<li>特性依恋是 Martin Fowler 提出的代码味道之一。类的方法只应对其所属类中的变量和函数感兴趣，不该垂青其它类中的变量和函数。我们要消除特性依恋。</li>
<li>用多态替代 if/else 或 switch/case。对于给定的选择类型，不应有多于一个 switch 语句。在那个 switch 语句中的多个 case，必须创建多态对象，取代系统中其它类似 switch 语句。</li>
<li>用命名常量替代魔术数。</li>
<li>现在 enum 已经加入 java 语言了，放心用吧！别再用那个 <code>public static final int</code> 老花招。那样做 int 的意义就丧失了，而用 enum 则不然，因为它们隶属于有名称的枚举。</li>
</ol>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2021/03/15/yuque/%E3%80%8A%E4%BB%A3%E7%A0%81%E6%95%B4%E6%B4%81%E4%B9%8B%E9%81%93%E3%80%8B/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-yuque/深挖 Redis 6.0 源码——SDS" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/15/yuque/%E6%B7%B1%E6%8C%96%20Redis%206.0%20%E6%BA%90%E7%A0%81%E2%80%94%E2%80%94SDS/">深挖 Redis 6.0 源码——SDS</a>
    </h1>
  

        
        <a href="/2021/03/15/yuque/%E6%B7%B1%E6%8C%96%20Redis%206.0%20%E6%BA%90%E7%A0%81%E2%80%94%E2%80%94SDS/" class="archive-article-date">
  	<time datetime="2021-03-15T18:53:59.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2021-03-15</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>SDS（Simple Dynamic Strings, 简单动态字符串）是 Redis 的一种基本数据结构，主要是用于存储字符串和整数。</strong> 这篇文章里，我们就来探讨一下 Redis SDS 这种数据结构的底层实现原理。</p>
<p>学习之前，首先我们要明确，Redis 是一个<strong>使用 C 语言编写的键值对存储系统</strong>。</p>
<h2 id="前置思考"><a href="#前置思考" class="headerlink" title="前置思考"></a>前置思考</h2><p>我们首先考虑一个问题，如何实现一个二进制安全的字符串？</p>
<p>在 C 语言中，<code>\0</code> 表示字符串结束，如果字符串中本身就包含 <code>\0</code> 字符，那么字符串就会在 <code>\0</code> 处被截断，即非二进制安全；若通过使用一个 len 属性，来判断字符串是否结束，就可以保证读写字符串时不受到 <code>\0</code> 的影响，则是二进制安全。同时 len 属性也能保证在 O(1) 时间内获取字符串的长度。</p>
<h2 id="Redis-3-2-以前的-SDS-实现"><a href="#Redis-3-2-以前的-SDS-实现" class="headerlink" title="Redis 3.2 以前的 SDS 实现"></a>Redis 3.2 以前的 SDS 实现</h2><p>在 Redis 3.2 版本以前，SDS 的结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sdshdr</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> len;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="built_in">free</span>;</span><br><span class="line">    <span class="keyword">char</span> buf[];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>其中，<strong>buf 表示数据空间，用于存储字符串；len 表示 buf 中已占用的字节数，也即字符串长度；free 表示 buf 中剩余可用字节数。</strong></p>
<p>字段 len 和 free 各占 4 字节，紧接着存放字符串。</p>
<p>这样做有以下几个好处：</p>
<ul>
<li>用单独的变量 len 和 free，可以<strong>方便地获取字符串长度和剩余空间</strong>；</li>
<li>内容存储在动态数组 buf 中，<strong>SDS 对上层暴露的指针指向 buf，而不是指向结构体 SDS</strong>。因此，上层可以像读取 C 字符串一样读取 SDS 的内容，兼容 C 语言处理字符串的各种函数，同时也能通过 buf 地址的偏移，方便地获取其他变量；</li>
<li>读写字符串不依赖于 <code>\0</code>，保证<strong>二进制安全</strong>。</li>
</ul>
<p>但其实以上的设计是存在一些问题的，对于不同长度的字符串，是否有必要使用 len 和 free 这 2 个 4 字节的变量？4 字节的 len，可表示的字符串长度为 <code>2^32</code>，而在实际应用中，存放于 Redis 中的字符串往往没有这么长，因此，空间的使用上能否进一步压缩？</p>
<p>那么接下来，我们就来看看最新的 Redis 是<strong>如何根据字符串的长度，使用不同的数据结构进行存储的</strong>。</p>
<h2 id="Redis-SDS-最新实现"><a href="#Redis-SDS-最新实现" class="headerlink" title="Redis SDS 最新实现"></a>Redis SDS 最新实现</h2><p>在 Redis 3.2 版本之后（v3.2 - v6.0），Redis 将 SDS 划分为 5 种类型：</p>
<ul>
<li>sdshdr5：长度小于 1 字节</li>
<li>sdshdr8：长度 1 字节</li>
<li>sdshdr16：长度 2 字节</li>
<li>sdshdr32：长度 4 字节</li>
<li>sdshdr64：长度 8 字节</li>
</ul>
<p>Redis 增加了一个 flags 字段来标识类型，用一个字节(8 位)来存储。</p>
<p>其中：前 3 位表示字符串的类型；剩余 5 位，可以用来存储长度小于 32 的短字符串。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">sdshdr5</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> flags; <span class="comment">/* 前3位存储类型，后5位存储长度 */</span></span><br><span class="line">    <span class="keyword">char</span> buf[]; <span class="comment">/* 动态数组，存放字符串 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>而对于长度大于 31 的字符串，仅仅靠 flags 的后 5 位来存储长度明显是不够的，需要用另外的变量来存储。sdshdr8、sdshdr16、sdshdr32、sdshdr64 的数据结构定义如下，其中 len 表示已使用的长度，alloc 表示总长度，buf 存储实际内容，而 flags 的前 3 位依然存储类型，后 5 位则预留。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">sdshdr8</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint8_t</span> len; <span class="comment">/* 已使用长度，1字节 */</span></span><br><span class="line">    <span class="keyword">uint8_t</span> alloc; <span class="comment">/* 总长度，1字节 */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> flags; <span class="comment">/* 前3位存储类型，后5位预留 */</span></span><br><span class="line">    <span class="keyword">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">sdshdr16</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint16_t</span> len; <span class="comment">/* 已使用长度，2字节 */</span></span><br><span class="line">    <span class="keyword">uint16_t</span> alloc; <span class="comment">/* 总长度，2字节 */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> flags; <span class="comment">/* 前3位存储类型，后5位预留 */</span></span><br><span class="line">    <span class="keyword">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">sdshdr32</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> len; <span class="comment">/* 已使用长度，4字节 */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> alloc; <span class="comment">/* 总长度，4字节 */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> flags; <span class="comment">/* 前3位存储类型，后5位预留 */</span></span><br><span class="line">    <span class="keyword">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">sdshdr64</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> len; <span class="comment">/* 已使用长度，8字节 */</span></span><br><span class="line">    <span class="keyword">uint64_t</span> alloc; <span class="comment">/* 总长度，8字节 */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> flags; <span class="comment">/* 前3位存储类型，后5位预留 */</span></span><br><span class="line">    <span class="keyword">char</span> buf[];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>注意，一般情况下，结构体会按照所有变量大小的最小公倍数做字节对齐，而用 <code>packed</code> 修饰后，结构体则变为 1 字节对齐。这样做的好处有二：一是<strong>节省内存</strong>，比如 sdshdr32 可节约 3 个字节；二是 <strong>SDS 返回给上层的是指向 buf 的指针，此时按 1 字节对齐，所以可在创建 SDS 后，通过 <code>(char*)sh+hdrlen</code> 得到 buf 指针地址，也可以通过 <code>buf[-1]</code> 找到 flags</strong>。</p>
<p>以上，Redis 根据字符串长度的不同，选择对应的数据结构进行存储。接下来，我们就来看看 Redis 字符串的相关 API 实现。</p>
<h2 id="SDS-API-实现"><a href="#SDS-API-实现" class="headerlink" title="SDS API 实现"></a>SDS API 实现</h2><h3 id="1-创建字符串"><a href="#1-创建字符串" class="headerlink" title="1. 创建字符串"></a>1. 创建字符串</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">sds <span class="title">sdsnewlen</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *init, <span class="keyword">size_t</span> initlen)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">void</span> *sh;</span><br><span class="line">    sds s;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据字符串长度计算相应类型</span></span><br><span class="line">    <span class="keyword">char</span> type = sdsReqType(initlen);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果创建的是&quot;&quot;字符串，强转为SDS_TYPE_8</span></span><br><span class="line">    <span class="keyword">if</span> (type == SDS_TYPE_5 &amp;&amp; initlen == <span class="number">0</span>) type = SDS_TYPE_8;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据类型计算头部所需长度（头部包含 len、alloc、flags）</span></span><br><span class="line">    <span class="keyword">int</span> hdrlen = sdsHdrSize(type);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 指向flags的指针</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *fp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建字符串，+1是因为 `\0` 结束符</span></span><br><span class="line">    sh = s_malloc(hdrlen+initlen+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (sh == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (init==SDS_NOINIT)</span><br><span class="line">        init = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!init)</span><br><span class="line">        <span class="built_in">memset</span>(sh, <span class="number">0</span>, hdrlen+initlen+<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// s指向buf</span></span><br><span class="line">    s = (<span class="keyword">char</span>*)sh+hdrlen;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// s减1得到flags</span></span><br><span class="line">    fp = ((<span class="keyword">unsigned</span> <span class="keyword">char</span>*)s)<span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在s末尾添加\0结束符</span></span><br><span class="line">    s[initlen] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回指向buf的指针s</span></span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建 SDS 的大致流程是这样的：首先根据字符串长度计算得到 type，根据 type 计算头部所需长度，然后动态分配内存空间。</p>
<p>注意：</p>
<ol>
<li>创建空字符串时，<code>SDS_TYPE_5</code> 被强制转换为 <code>SDS_TYPE_8</code>（原因是创建空字符串后，内容可能会频繁更新而引发扩容操作，故直接创建为 sdshdr8）</li>
<li>长度计算有 <code>+1</code> 操作，因为结束符 <code>\0</code> 会占用一个长度的空间。</li>
<li>返回的是指向 buf 的指针 s。</li>
</ol>
<h3 id="2-清空字符串"><a href="#2-清空字符串" class="headerlink" title="2. 清空字符串"></a>2. 清空字符串</h3><p>SDS 提供了两种清空字符串的方法。</p>
<p>一种是通过 s 偏移得到结构体的地址，然后调用 <code>s_free</code> 直接释放内存。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sdsfree</span><span class="params">(sds s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (s == <span class="literal">NULL</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// s减去头部的大小得到结构体的地址</span></span><br><span class="line">    s_free((<span class="keyword">char</span>*)s-sdsHdrSize(s[<span class="number">-1</span>]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另一种是通过重置 len 属性值而达到清空字符串的目的，本质上 buf 并没有被真正清除，新的数据会直接覆盖 buf 中原有的数据，无需申请新的内存空间。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sdsclear</span><span class="params">(sds s)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将len属性置为0</span></span><br><span class="line">    sdssetlen(s, <span class="number">0</span>);</span><br><span class="line">    s[<span class="number">0</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-拼接字符串"><a href="#3-拼接字符串" class="headerlink" title="3. 拼接字符串"></a>3. 拼接字符串</h3><p>SDS 拼接字符串的实现如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">sds <span class="title">sdscatsds</span><span class="params">(sds s, <span class="keyword">const</span> sds t)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sdscatlen(s, t, sdslen(t));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到 <code>sdscatsds</code> 内部调用的是 <code>sdscatlen</code>。</p>
<p>而 <code>sdscatlen</code> 内部的实现相对复杂一些，由于拼接字符串可能涉及 SDS 的扩容，因此 <code>sdscatlen</code> 内部调用 <code>sdsMakeRoomFor</code> 对拼接的字符串做检查：若无需扩容，直接返回 s；若需要扩容，则返回扩容好的新字符串 s。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">sds <span class="title">sdscatlen</span><span class="params">(sds s, <span class="keyword">const</span> <span class="keyword">void</span> *t, <span class="keyword">size_t</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 计算当前字符串长度</span></span><br><span class="line">    <span class="keyword">size_t</span> curlen = sdslen(s);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 确保s的剩余空间足以拼接上t</span></span><br><span class="line">    s = sdsMakeRoomFor(s,len);</span><br><span class="line">    <span class="keyword">if</span> (s == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拼接s、t</span></span><br><span class="line">    <span class="built_in">memcpy</span>(s+curlen, t, len);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新s的len属性</span></span><br><span class="line">    sdssetlen(s, curlen+len);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// s末尾添加\0结束符</span></span><br><span class="line">    s[curlen+len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SDS 的扩容策略是这样的：</p>
<ol>
<li>若 SDS 中剩余空闲长度 avail 大于或等于新增内容的长度 addlen，无需扩容。</li>
<li>若 SDS 中剩余空闲长度 avail 小于或等于 addlen，则分情况讨论：新增后总长度 <code>len+addlen &lt; 1MB</code> 的，按新长度的 2 倍扩容；新增后总长度 <code>len+addlen &gt;= 1MB</code> 的，按新长度加上 <code>1MB</code> 扩容。</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">sds <span class="title">sdsMakeRoomFor</span><span class="params">(sds s, <span class="keyword">size_t</span> addlen)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">void</span> *sh, *newsh;</span><br><span class="line">    <span class="comment">// 当前剩余长度</span></span><br><span class="line">    <span class="keyword">size_t</span> avail = sdsavail(s);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> len, newlen;</span><br><span class="line">    <span class="keyword">char</span> type, oldtype = s[<span class="number">-1</span>] &amp; SDS_TYPE_MASK;</span><br><span class="line">    <span class="keyword">int</span> hdrlen;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 剩余长度&gt;=新增字符串长度，直接返回 */</span></span><br><span class="line">    <span class="keyword">if</span> (avail &gt;= addlen) <span class="keyword">return</span> s;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算当前字符串长度len</span></span><br><span class="line">    len = sdslen(s);</span><br><span class="line"></span><br><span class="line">    sh = (<span class="keyword">char</span>*)s-sdsHdrSize(oldtype);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算新长度</span></span><br><span class="line">    newlen = (len+addlen);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 新长度&lt;1MB，按新长度的2倍扩容</span></span><br><span class="line">    <span class="keyword">if</span> (newlen &lt; SDS_MAX_PREALLOC)</span><br><span class="line">        newlen *= <span class="number">2</span>;</span><br><span class="line">    <span class="comment">// 否则按新长度+1MB扩容</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        newlen += SDS_MAX_PREALLOC;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算新长度所属类型</span></span><br><span class="line">    type = sdsReqType(newlen);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* type5不支持扩容，强转为type8 */</span></span><br><span class="line">    <span class="keyword">if</span> (type == SDS_TYPE_5) type = SDS_TYPE_8;</span><br><span class="line"></span><br><span class="line">    hdrlen = sdsHdrSize(type);</span><br><span class="line">    <span class="keyword">if</span> (oldtype==type) &#123;</span><br><span class="line">        <span class="comment">// 类型没变，直接通过realloc扩大动态数组即可。</span></span><br><span class="line">        newsh = s_realloc(sh, hdrlen+newlen+<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (newsh == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        s = (<span class="keyword">char</span>*)newsh+hdrlen;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 类型改变了，则说明头部长度也发生了变化，不进行realloc操作，而是直接重新开辟内存</span></span><br><span class="line">        newsh = s_malloc(hdrlen+newlen+<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (newsh == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 原内存拷贝到新的内存地址上</span></span><br><span class="line">        <span class="built_in">memcpy</span>((<span class="keyword">char</span>*)newsh+hdrlen, s, len+<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 释放原先空间</span></span><br><span class="line">        s_free(sh);</span><br><span class="line">        s = (<span class="keyword">char</span>*)newsh+hdrlen;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 为flags赋值</span></span><br><span class="line">        s[<span class="number">-1</span>] = type;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 为len属性赋值</span></span><br><span class="line">        sdssetlen(s, len);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 为alloc属性赋值</span></span><br><span class="line">    sdssetalloc(s, newlen);</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li>SDS 返回的是指向 buf 的指针，兼容了 C 语言操作字符串的函数，读取内容时，通过 len 属性来限制读取的长度，不受 <code>\0</code> 影响，从而保证二进制安全；</li>
<li>Redis 根据字符串长度的不同，定义了多种数据结构，包括：sdshdr5/sdshdr8/sdshdr16/sdshdr32/sdshdr64。</li>
<li>SDS 在设计字符串修改出会调用 <code>sdsMakeRoomFor</code> 函数进行检查，根据不同情况进行扩容。</li>
</ol>
<p>全文完！</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2021/03/15/yuque/%E6%B7%B1%E6%8C%96%20Redis%206.0%20%E6%BA%90%E7%A0%81%E2%80%94%E2%80%94SDS/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-yuque/曹春晖：谈一谈 Go 和 Syscall" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/15/yuque/%E6%9B%B9%E6%98%A5%E6%99%96%EF%BC%9A%E8%B0%88%E4%B8%80%E8%B0%88%20Go%20%E5%92%8C%20Syscall/">曹春晖：谈一谈 Go 和 Syscall</a>
    </h1>
  

        
        <a href="/2021/03/15/yuque/%E6%9B%B9%E6%98%A5%E6%99%96%EF%BC%9A%E8%B0%88%E4%B8%80%E8%B0%88%20Go%20%E5%92%8C%20Syscall/" class="archive-article-date">
  	<time datetime="2021-03-15T03:13:36.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2021-03-15</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>▎<strong>阅读索引</strong><br>**</p>
<ul>
<li><p>概念</p>
</li>
<li><p>入口</p>
</li>
<li><p>系统调用管理</p>
</li>
<li><p>runtime 中的 SYSCALL</p>
</li>
<li><p>和调度的交互</p>
<ul>
<li><p>entersyscall</p>
</li>
<li><p>exitsyscallfast</p>
</li>
<li><p>exitsyscall</p>
</li>
<li><p>entersyscallblock</p>
</li>
<li><p>entersyscallblock_handoff</p>
</li>
<li><p>entersyscall_sysmon</p>
</li>
<li><p>entersyscall_gcwait</p>
</li>
</ul>
</li>
<li><p>总结</p>
</li>
</ul>
<p>**</p>
<h2 id="▎概念"><a href="#▎概念" class="headerlink" title="▎概念"></a>▎<strong>概念</strong></h2><p><img src="https://cdn.nlark.com/yuque/0/2021/webp/190217/1615778187154-daf8b288-50e6-482b-952b-1a6c95980d91.webp#align=left&display=inline&height=110&margin=%5Bobject%20Object%5D&originHeight=846&originWidth=1080&size=0&status=done&style=none&width=140"></p>
<h2 id="▎入口"><a href="#▎入口" class="headerlink" title="▎入口"></a>▎<strong>入口</strong></h2><p>syscall 有下面几个入口，在 syscall/asm_linux_amd64.s 中。</p>
<p>1func Syscall(trap, a1, a2, a3 uintptr) (r1, r2 uintptr, err syscall.Errno)<br>2<br>3func Syscall6(trap, a1, a2, a3, a4, a5, a6 uintptr) (r1, r2 uintptr, err syscall.Errno)<br>4<br>5func RawSyscall(trap, a1, a2, a3 uintptr) (r1, r2 uintptr, err syscall.Errno)<br>6<br>7func RawSyscall6(trap, a1, a2, a3, a4, a5, a6 uintptr) (r1, r2 uintptr, err syscall.Errno)<br>8</p>
<p>这些函数的实现都是汇编，按照 linux 的 syscall 调用规范，我们只要在汇编中把参数依次传入寄存器，并调用 SYSCALL 指令即可进入内核处理逻辑，系统调用执行完毕之后，返回值放在 RAX 中：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/webp/190217/1615778187077-65fb0753-f95e-4987-a305-da25dd23ad04.webp#align=left&display=inline&height=78&margin=%5Bobject%20Object%5D&originHeight=78&originWidth=505&size=0&status=done&style=none&width=505"></p>
<p>Syscall  和  Syscall6  的区别只有传入参数不一样:</p>
<p>1// func Syscall(trap int64, a1, a2, a3 uintptr) (r1, r2, err uintptr);<br>2TEXT ·Syscall(SB),NOSPLIT,$0-56<br> 3    CALL    runtime·entersyscall(SB)<br> 4    MOVQ    a1+8(FP), DI<br> 5    MOVQ    a2+16(FP), SI<br> 6    MOVQ    a3+24(FP), DX<br> 7    MOVQ    $0, R10<br> 8    MOVQ    $0, R8<br> 9    MOVQ    $0, R9<br>10    MOVQ    trap+0(FP), AX    // syscall entry<br>11    SYSCALL<br>12    // 0xfffffffffffff001 是 linux MAX_ERRNO 取反 转无符号，<a target="_blank" rel="noopener" href="http://lxr.free-electrons.com/source/include/linux/err.h#L17">http://lxr.free-electrons.com/source/include/linux/err.h#L17</a><br>13    CMPQ    AX, $0xfffffffffffff001<br>14    JLS    ok<br>15    MOVQ    $-1, r1+32(FP)<br>16    MOVQ    $0, r2+40(FP)<br>17    NEGQ    AX<br>18    MOVQ    AX, err+48(FP)<br>19    CALL    runtime·exitsyscall(SB)<br>20    RET<br>21ok:<br>22    MOVQ    AX, r1+32(FP)<br>23    MOVQ    DX, r2+40(FP)<br>24    MOVQ    $0, err+48(FP)<br>25    CALL    runtime·exitsyscall(SB)<br>26    RET<br>27<br>28// func Syscall6(trap, a1, a2, a3, a4, a5, a6 uintptr) (r1, r2, err uintptr)<br>29TEXT ·Syscall6(SB),NOSPLIT,$0-80<br>30    CALL    runtime·entersyscall(SB)<br>31    MOVQ    a1+8(FP), DI<br>32    MOVQ    a2+16(FP), SI<br>33    MOVQ    a3+24(FP), DX<br>34    MOVQ    a4+32(FP), R10<br>35    MOVQ    a5+40(FP), R8<br>36    MOVQ    a6+48(FP), R9<br>37    MOVQ    trap+0(FP), AX    // syscall entry<br>38    SYSCALL<br>39    CMPQ    AX, $0xfffffffffffff001<br>40    JLS    ok6<br>41    MOVQ    $-1, r1+56(FP)<br>42    MOVQ    $0, r2+64(FP)<br>43    NEGQ    AX<br>44    MOVQ    AX, err+72(FP)<br>45    CALL    runtime·exitsyscall(SB)<br>46    RET<br>47ok6:<br>48    MOVQ    AX, r1+56(FP)<br>49    MOVQ    DX, r2+64(FP)<br>50    MOVQ    $0, err+72(FP)<br>51    CALL    runtime·exitsyscall(SB)<br>52    RET</p>
<p>两个函数没什么大区别，为啥不用一个呢？个人猜测，Go 的函数参数都是栈上传入，可能是为了节省一点栈空间。。在正常的 Syscall 操作之前会通知 runtime，接下来我要进行 syscall 操作了 <strong>runtime·entersyscall **，退出时会调用</strong> runtime·exitsyscall **。</p>
<p>1// func RawSyscall(trap, a1, a2, a3 uintptr) (r1, r2, err uintptr)<br>2TEXT ·RawSyscall(SB),NOSPLIT,$0-56<br> 3    MOVQ    a1+8(FP), DI<br> 4    MOVQ    a2+16(FP), SI<br> 5    MOVQ    a3+24(FP), DX<br> 6    MOVQ    $0, R10<br> 7    MOVQ    $0, R8<br> 8    MOVQ    $0, R9<br> 9    MOVQ    trap+0(FP), AX    // syscall entry<br>10    SYSCALL<br>11    CMPQ    AX, $0xfffffffffffff001<br>12    JLS    ok1<br>13    MOVQ    $-1, r1+32(FP)<br>14    MOVQ    $0, r2+40(FP)<br>15    NEGQ    AX<br>16    MOVQ    AX, err+48(FP)<br>17    RET<br>18ok1:<br>19    MOVQ    AX, r1+32(FP)<br>20    MOVQ    DX, r2+40(FP)<br>21    MOVQ    $0, err+48(FP)<br>22    RET<br>23<br>24// func RawSyscall6(trap, a1, a2, a3, a4, a5, a6 uintptr) (r1, r2, err uintptr)<br>25TEXT ·RawSyscall6(SB),NOSPLIT,$0-80<br>26    MOVQ    a1+8(FP), DI<br>27    MOVQ    a2+16(FP), SI<br>28    MOVQ    a3+24(FP), DX<br>29    MOVQ    a4+32(FP), R10<br>30    MOVQ    a5+40(FP), R8<br>31    MOVQ    a6+48(FP), R9<br>32    MOVQ    trap+0(FP), AX    // syscall entry<br>33    SYSCALL<br>34    CMPQ    AX, $0xfffffffffffff001<br>35    JLS    ok2<br>36    MOVQ    $-1, r1+56(FP)<br>37    MOVQ    $0, r2+64(FP)<br>38    NEGQ    AX<br>39    MOVQ    AX, err+72(FP)<br>40    RET<br>41ok2:<br>42    MOVQ    AX, r1+56(FP)<br>43    MOVQ    DX, r2+64(FP)<br>44    MOVQ    $0, err+72(FP)<br>45    RET</p>
<p>RawSyscall  和  Syscall  的区别也非常微小，就只是在进入  Syscall  和退出的时候没有通知  runtime，这样  runtime  理论上是没有办法通过调度把这个  g  的  m  的  p  调度走的，所以如果用户代码使用了  RawSyscall  来做一些阻塞的系统调用，是有可能阻塞其它的  g  的，下面是官方开发的原话:</p>
<p><em>Yes, if you call RawSyscall you may block other goroutines from running. The system monitor may start them up after a while, but I think there are cases where it won’t. I would say that Go programs should always call Syscall. RawSyscall exists to make it slightly more efficient to call system calls that never block, such as getpid. But it’s really an internal mechanism.</em></p>
<p>1// func gettimeofday(tv *Timeval) (err uintptr)<br>2TEXT ·gettimeofday(SB),NOSPLIT,$0-16<br>3    MOVQ    tv+0(FP), DI<br>4    MOVQ    $0, SI<br>5    MOVQ    runtime·__vdso_gettimeofday_sym(SB), AX<br>6    CALL    AX<br>7<br>8    CMPQ    AX, $0xfffffffffffff001<br>9    JLS    ok7<br>10    NEGQ    AX<br>11    MOVQ    AX, err+8(FP)<br>12    RET<br>13ok7:<br>14    MOVQ    $0, err+8(FP)<br>15    RET</p>
<h2 id="▎系统调用管理"><a href="#▎系统调用管理" class="headerlink" title="▎系统调用管理"></a>▎<strong>系统调用管理</strong></h2><p>先是系统调用的定义文件:</p>
<p>1/syscall/syscall_linux.go</p>
<p>可以把系统调用分为三类:</p>
<ul>
<li><p>阻塞系统调用</p>
</li>
<li><p>非阻塞系统调用</p>
</li>
<li><p>wrapped 系统调用</p>
</li>
</ul>
<p>阻塞系统调用会定义成下面这样的形式:</p>
<p>1//sys   Madvise(b []byte, advice int) (err error)</p>
<p>非阻塞系统调用:</p>
<p>1//sysnb    EpollCreate(size int) (fd int, err error)</p>
<p>然后，根据这些注释，mksyscall.pl 脚本会生成对应的平台的具体实现。mksyscall.pl 是一段 perl 脚本，感兴趣的同学可以自行查看，这里就不再赘述了。</p>
<p>看看阻塞和非阻塞的系统调用的生成结果:</p>
<p>1func Madvise(b []byte, advice int) (err error) {<br>2    var _p0 unsafe.Pointer<br>3    if len(b) &gt; 0 {<br>4        _p0 = unsafe.Pointer(&amp;b[0])<br>5    } else {<br>6        _p0 = unsafe.Pointer(&amp;_zero)<br>7    }<br>8    _, *, e1 := Syscall(SYS_MADVISE, uintptr(_p0), uintptr(len(b)), uintptr(advice))<br>9    if e1 != 0 {<br>10        err = errnoErr(e1)<br>11    }<br>12    return<br>13}<br>14<br>15func EpollCreate(size int) (fd int, err error) {<br>16    r0, *, e1 := RawSyscall(SYS_EPOLL_CREATE, uintptr(size), 0, 0)<br>17    fd = int(r0)<br>18    if e1 != 0 {<br>19        err = errnoErr(e1)<br>20    }<br>21    return<br>22}</p>
<p>显然，标记为 sys 的系统调用使用的是 Syscall 或者 Syscall6，标记为 sysnb 的系统调用使用的是 RawSyscall 或 RawSyscall6。</p>
<p>wrapped 的系统调用是怎么一回事呢？</p>
<p>1func Rename(oldpath string, newpath string) (err error) {<br>2    return Renameat(_AT_FDCWD, oldpath, _AT_FDCWD, newpath)<br>3}</p>
<p>可能是觉得系统调用的名字不太好，或者参数太多，我们就简单包装一下。没啥特别的。</p>
<h2 id="▎runtime-中的-SYSCALL"><a href="#▎runtime-中的-SYSCALL" class="headerlink" title="▎runtime 中的 SYSCALL"></a>▎<strong>runtime 中的 SYSCALL</strong></h2><p>除了上面提到的阻塞非阻塞和 wrapped syscall，runtime 中还定义了一些 low-level 的 syscall，这些是不暴露给用户的。</p>
<p>提供给用户的 syscall 库，在使用时，会使 goroutine 和 p 分别进入 Gsyscall 和 Psyscall 状态。但 runtime 自己封装的这些 syscall 无论是否阻塞，都不会调用 entersyscall 和 exitsyscall。虽说是 “low-level” 的 syscall。</p>
<p>不过和暴露给用户的 syscall 本质是一样的。这些代码在 runtime/sys_linux_amd64.s 中，举个具体的例子:</p>
<p>1TEXT runtime·write(SB),NOSPLIT,$0-28<br> 2    MOVQ    fd+0(FP), DI<br> 3    MOVQ    p+8(FP), SI<br> 4    MOVL    n+16(FP), DX<br> 5    MOVL    $SYS_write, AX<br>6    SYSCALL<br>7    CMPQ    AX, $0xfffffffffffff001<br> 8    JLS    2(PC)<br> 9    MOVL    $-1, AX<br>10    MOVL    AX, ret+24(FP)<br>11    RET<br>12<br>13TEXT runtime·read(SB),NOSPLIT,$0-28<br>14    MOVL    fd+0(FP), DI<br>15    MOVQ    p+8(FP), SI<br>16    MOVL    n+16(FP), DX<br>17    MOVL    $SYS_read, AX<br>18    SYSCALL<br>19    CMPQ    AX, $0xfffffffffffff001<br>20    JLS    2(PC)<br>21    MOVL    $-1, AX<br>22    MOVL    AX, ret+24(FP)<br>23    RET</p>
<p>下面是所有  runtime  另外定义的  syscall  列表:</p>
<p>1#define SYS_read        0<br>2#define SYS_write        1<br>3#define SYS_open        2<br>4#define SYS_close        3<br>5#define SYS_mmap        9<br>6#define SYS_munmap        11<br>7#define SYS_brk         12<br>8#define SYS_rt_sigaction    13<br>9#define SYS_rt_sigprocmask    14<br>10#define SYS_rt_sigreturn    15<br>11#define SYS_access        21<br>12#define SYS_sched_yield     24<br>13#define SYS_mincore        27<br>14#define SYS_madvise        28<br>15#define SYS_setittimer        38<br>16#define SYS_getpid        39<br>17#define SYS_socket        41<br>18#define SYS_connect        42<br>19#define SYS_clone        56<br>20#define SYS_exit        60<br>21#define SYS_kill        62<br>22#define SYS_fcntl        72<br>23#define SYS_getrlimit        97<br>24#define SYS_sigaltstack     131<br>25#define SYS_arch_prctl        158<br>26#define SYS_gettid        186<br>27#define SYS_tkill        200<br>28#define SYS_futex        202<br>29#define SYS_sched_getaffinity    204<br>30#define SYS_epoll_create    213<br>31#define SYS_exit_group        231<br>32#define SYS_epoll_wait        232<br>33#define SYS_epoll_ctl        233<br>34#define SYS_pselect6        270<br>35#define SYS_epoll_create1    291</p>
<p>这些 syscall 理论上都是不会在执行期间被调度器剥离掉 p 的，所以执行成功之后 goroutine 会继续执行，而不像用户的 goroutine 一样，若被剥离 p 会进入等待队列。</p>
<h2 id="▎和调度的交互"><a href="#▎和调度的交互" class="headerlink" title="▎和调度的交互"></a>▎<strong>和调度的交互</strong></h2><p>既然要和调度交互，那友好地通知我要 syscall 了: entersyscall，我完事了: exitsyscall。</p>
<p>所以这里的交互指的是用户代码使用 syscall 库时和调度器的交互。<strong>runtime 里的 syscall 不走这套流程。</strong></p>
<h2 id="▎entersyscall"><a href="#▎entersyscall" class="headerlink" title="▎entersyscall"></a><strong>▎entersyscall</strong></h2><p>1// syscall  库和  cgo  调用的标准入口<br>2//go:nosplit<br>3func entersyscall() {<br>4    reentersyscall(getcallerpc(), getcallersp())<br>5}<br>6<br>7//go:nosplit<br>8func reentersyscall(pc, sp uintptr) {<br>9    <em>g</em> := getg()<br>10<br>11    //  需要禁止  g  的抢占<br>12    <em>g</em>.m.locks++<br>13<br>14    // entersyscall  中不能调用任何会导致栈增长/分裂的函数<br>15    <em>g</em>.stackguard0 = stackPreempt<br>16    //  设置  throwsplit，在  newstack  中，如果发现  throwsplit  是  true<br>17    //  会直接  crash<br>18    //  下面的代码是  newstack  里的<br>19    // if thisg.m.curg.throwsplit {<br>20    //     throw(“runtime: stack split at bad time”)<br>21    // }<br>22    <em>g</em>.throwsplit = true<br>23<br>24    // Leave SP around for GC and traceback.<br>25    //  保存现场，在  syscall  之后会依据这些数据恢复现场<br>26    save(pc, sp)<br>27    <em>g</em>.syscallsp = sp<br>28    <em>g</em>.syscallpc = pc<br>29    casgstatus(<em>g</em>, <em>Grunning, _Gsyscall)<br>30    if _g</em>.syscallsp &lt; <em>g</em>.stack.lo || <em>g</em>.stack.hi &lt; <em>g</em>.syscallsp {<br>31        systemstack(func() {<br>32            print(“entersyscall inconsistent “, hex(<em>g</em>.syscallsp), “ [“, hex(<em>g</em>.stack.lo), “,”, hex(<em>g</em>.stack.hi), “]\n”)<br>33            throw(“entersyscall”)<br>34        })<br>35    }<br>36<br>37    if atomic.Load(&amp;sched.sysmonwait) != 0 {<br>38        systemstack(entersyscall<em>sysmon)<br>39        save(pc, sp)<br>40    }<br>41<br>42    if _g</em>.m.p.ptr().runSafePointFn != 0 {<br>43        // runSafePointFn may stack split if run on this stack<br>44        systemstack(runSafePointFn)<br>45        save(pc, sp)<br>46    }<br>47<br>48    <em>g</em>.m.syscalltick = <em>g</em>.m.p.ptr().syscalltick<br>49    <em>g</em>.sysblocktraced = true<br>50    <em>g</em>.m.mcache = nil<br>51    <em>g</em>.m.p.ptr().m = 0<br>52    atomic.Store(&amp;<em>g</em>.m.p.ptr().status, <em>Psyscall)<br>53    if sched.gcwaiting != 0 {<br>54        systemstack(entersyscall_gcwait)<br>55        save(pc, sp)<br>56    }<br>57<br>58    _g</em>.m.locks–<br>59}</p>
<p>可以看到，进入 syscall 的 G 是铁定不会被抢占的。</p>
<h2 id="▎exitsyscall"><a href="#▎exitsyscall" class="headerlink" title="▎exitsyscall"></a><strong>▎exitsyscall</strong></h2><p>1// g  已经退出了  syscall<br>2//  需要准备让  g  在  cpu  上重新运行<br>3//  这个函数只会在  syscall  库中被调用，在  runtime  里用的  low-level syscall<br>4//  不会用到<br>5//  不能有  write barrier，因为  P  可能已经被偷走了<br>6//go:nosplit<br>7//go:nowritebarrierrec<br>8func exitsyscall(dummy int32) {<br>9    <em>g</em> := getg()<br>10<br>11    <em>g</em>.m.locks++ // see comment in entersyscall<br>12    if getcallersp(unsafe.Pointer(&amp;dummy)) &gt; <em>g</em>.syscallsp {<br>13        // throw calls print which may try to grow the stack,<br>14        // but throwsplit == true so the stack can not be grown;<br>15        // use systemstack to avoid that possible problem.<br>16        systemstack(func() {<br>17            throw(“exitsyscall: syscall frame is no longer valid”)<br>18        })<br>19    }<br>20<br>21    <em>g</em>.waitsince = 0<br>22    oldp := <em>g</em>.m.p.ptr()<br>23    if exitsyscallfast() {<br>24        if <em>g</em>.m.mcache == nil {<br>25            systemstack(func() {<br>26                throw(“lost mcache”)<br>27            })<br>28        }<br>29        //  目前有  p，可以运行<br>30        <em>g</em>.m.p.ptr().syscalltick++<br>31        //  把  g  的状态修改回  running<br>32        casgstatus(<em>g</em>, <em>Gsyscall, _Grunning)<br>33<br>34        //  垃圾收集未在运行(因为我们这段逻辑在执行)<br>35        //  所以清理掉  syscallsp  是安全的<br>36        _g</em>.syscallsp = 0<br>37        <em>g</em>.m.locks–<br>38        if <em>g</em>.preempt {<br>39            //  防止在  newstack  中清理掉  preemption  标记<br>40            <em>g</em>.stackguard0 = stackPreempt<br>41        } else {<br>42            //  否则恢复在  entersyscall/entersyscallblock  中破坏掉的正常的  <em>StackGuard<br>43            _g</em>.stackguard0 = <em>g</em>.stack.lo + <em>StackGuard<br>44        }<br>45        _g</em>.throwsplit = false<br>46        return<br>47    }<br>48<br>49    <em>g</em>.sysexitticks = 0<br>50    <em>g</em>.m.locks–<br>51<br>52    //  调用  scheduler<br>53    mcall(exitsyscall0)<br>54<br>55    if <em>g</em>.m.mcache == nil {<br>56        systemstack(func() {<br>57            throw(“lost mcache”)<br>58        })<br>59    }<br>60<br>61    //  调度器返回了，所以我们可以清理掉在  syscall  期间为垃圾收集器<br>62    //  准备的  syscallsp  信息了<br>63    //  需要一直等待到  gosched  返回，我们不确定垃圾收集器是不是在运行<br>64    <em>g</em>.syscallsp = 0<br>65    <em>g</em>.m.p.ptr().syscalltick++<br>66    <em>g</em>.throwsplit = false<br>67}</p>
<p>这里还调用了 exitsyscallfast 和 exitsyscall0。</p>
<h2 id="▎exitsyscallfast"><a href="#▎exitsyscallfast" class="headerlink" title="▎exitsyscallfast"></a><strong>▎exitsyscallfast</strong></h2><p>1//go:nosplit<br>2func exitsyscallfast() bool {<br>3    <em>g</em> := getg()<br>4<br>5    // Freezetheworld sets stopwait but does not retake P’s.<br>6    if sched.stopwait == freezeStopWait {<br>7        <em>g</em>.m.mcache = nil<br>8        <em>g</em>.m.p = 0<br>9        return false<br>10    }<br>11<br>12    // Try to re-acquire the last P.<br>13    if <em>g</em>.m.p != 0 &amp;&amp; <em>g</em>.m.p.ptr().status == <em>Psyscall &amp;&amp; atomic.Cas(&amp;_g</em>.m.p.ptr().status, <em>Psyscall, _Prunning) {<br>14        // There’s a cpu for us, so we can run.<br>15        exitsyscallfast_reacquired()<br>16        return true<br>17    }<br>18<br>19    // Try to get any other idle P.<br>20    oldp := _g</em>.m.p.ptr()<br>21    <em>g</em>.m.mcache = nil<br>22    <em>g</em>.m.p = 0<br>23    if sched.pidle != 0 {<br>24        var ok bool<br>25        systemstack(func() {<br>26            ok = exitsyscallfast_pidle()<br>27        })<br>28        if ok {<br>29            return true<br>30        }<br>31    }<br>32    return false<br>33}</p>
<p>总之就是努力获取一个 P 来执行 syscall 之后的逻辑。如果哪都没有 P 可以给我们用，那就进入 exitsyscall0 了。</p>
<p>1mcall(exitsyscall0)</p>
<p>调用 exitsyscall0 时，会切换到 g0 栈。</p>
<h2 id="▎exitsyscall0"><a href="#▎exitsyscall0" class="headerlink" title="▎exitsyscall0"></a><strong>▎exitsyscall0</strong></h2><p>1//  在  exitsyscallfast  中吃瘪了，没办法，慢慢来<br>2//  把  g  的状态设置成  runnable，先进  runq  等着<br>3//go:nowritebarrierrec<br>4func exitsyscall0(gp *g) {<br>5    <em>g</em> := getg()<br>6<br>7    casgstatus(gp, <em>Gsyscall, _Grunnable)<br>8    dropg()<br>9    lock(&amp;sched.lock)<br>10    _p</em> := pidleget()<br>11    if <em>p</em> == nil {<br>12        //  如果  P  被人偷跑了<br>13        globrunqput(gp)<br>14    } else if atomic.Load(&amp;sched.sysmonwait) != 0 {<br>15        atomic.Store(&amp;sched.sysmonwait, 0)<br>16        notewakeup(&amp;sched.sysmonnote)<br>17    }<br>18    unlock(&amp;sched.lock)<br>19    if <em>p</em> != nil {<br>20        //  如果现在还有  p，那就用这个  p  执行<br>21        acquirep(<em>p</em>)<br>22        execute(gp, false) // Never returns.<br>23    }<br>24    if <em>g</em>.m.lockedg != 0 {<br>25        //  设置了  LockOsThread  的  g  的特殊逻辑<br>26        stoplockedm()<br>27        execute(gp, false) // Never returns.<br>28    }<br>29    stopm()<br>30    schedule() // Never returns.<br>31}</p>
<h2 id="▎entersyscallblock"><a href="#▎entersyscallblock" class="headerlink" title="▎entersyscallblock"></a><strong>▎entersyscallblock</strong></h2><p>知道自己会 block，直接就把 p 交出来了。</p>
<p>1//  和  entersyscall  一样，就是会直接把  P  给交出去，因为知道自己是会阻塞的<br>2//go:nosplit<br>3func entersyscallblock(dummy int32) {<br>4    <em>g</em> := getg()<br>5<br>6    <em>g</em>.m.locks++ // see comment in entersyscall<br>7    <em>g</em>.throwsplit = true<br>8    <em>g</em>.stackguard0 = stackPreempt // see comment in entersyscall<br>9    <em>g</em>.m.syscalltick = <em>g</em>.m.p.ptr().syscalltick<br>10    <em>g</em>.sysblocktraced = true<br>11    <em>g</em>.m.p.ptr().syscalltick++<br>12<br>13    // Leave SP around for GC and traceback.<br>14    pc := getcallerpc()<br>15    sp := getcallersp(unsafe.Pointer(&amp;dummy))<br>16    save(pc, sp)<br>17    <em>g</em>.syscallsp = <em>g</em>.sched.sp<br>18    <em>g</em>.syscallpc = <em>g</em>.sched.pc<br>19    if <em>g</em>.syscallsp &lt; <em>g</em>.stack.lo || <em>g</em>.stack.hi &lt; <em>g</em>.syscallsp {<br>20        sp1 := sp<br>21        sp2 := <em>g</em>.sched.sp<br>22        sp3 := <em>g</em>.syscallsp<br>23        systemstack(func() {<br>24            print(“entersyscallblock inconsistent “, hex(sp1), “ “, hex(sp2), “ “, hex(sp3), “ [“, hex(<em>g</em>.stack.lo), “,”, hex(<em>g</em>.stack.hi), “]\n”)<br>25            throw(“entersyscallblock”)<br>26        })<br>27    }<br>28    casgstatus(<em>g</em>, <em>Grunning, _Gsyscall)<br>29    if _g</em>.syscallsp &lt; <em>g</em>.stack.lo || <em>g</em>.stack.hi &lt; <em>g</em>.syscallsp {<br>30        systemstack(func() {<br>31            print(“entersyscallblock inconsistent “, hex(sp), “ “, hex(<em>g</em>.sched.sp), “ “, hex(<em>g</em>.syscallsp), “ [“, hex(<em>g</em>.stack.lo), “,”, hex(<em>g</em>.stack.hi), “]\n”)<br>32            throw(“entersyscallblock”)<br>33        })<br>34    }<br>35<br>36    //  直接调用  entersyscallblock<em>handoff  把  p  交出来了<br>37    systemstack(entersyscallblock_handoff)<br>38<br>39    // Resave for traceback during blocked call.<br>40    save(getcallerpc(), getcallersp(unsafe.Pointer(&amp;dummy)))<br>41<br>42    _g</em>.m.locks–<br>43}</p>
<p>这个函数只有一个调用方 notesleepg，这里就不再赘述了。</p>
<h2 id="▎entersyscallblock-handoff"><a href="#▎entersyscallblock-handoff" class="headerlink" title="▎entersyscallblock_handoff"></a><strong>▎entersyscallblock_handoff</strong></h2><p>1func entersyscallblock_handoff() {<br>2    handoffp(releasep())<br>3}</p>
<p>比较简单。</p>
<h2 id="▎entersyscall-sysmon"><a href="#▎entersyscall-sysmon" class="headerlink" title="▎entersyscall_sysmon"></a><strong>▎entersyscall_sysmon</strong></h2><p>1func entersyscall_sysmon() {<br>2    lock(&amp;sched.lock)<br>3    if atomic.Load(&amp;sched.sysmonwait) != 0 {<br>4        atomic.Store(&amp;sched.sysmonwait, 0)<br>5        notewakeup(&amp;sched.sysmonnote)<br>6    }<br>7    unlock(&amp;sched.lock)<br>8}</p>
<h2 id="▎entersyscall-gcwait"><a href="#▎entersyscall-gcwait" class="headerlink" title="▎entersyscall_gcwait"></a><strong>▎entersyscall_gcwait</strong></h2><p>1func entersyscall<em>gcwait() {<br>2    _g</em> := getg()<br>3    <em>p</em> := <em>g</em>.m.p.ptr()<br>4<br>5    lock(&amp;sched.lock)<br>6    if sched.stopwait &gt; 0 &amp;&amp; atomic.Cas(&amp;<em>p</em>.status, <em>Psyscall, _Pgcstop) {<br>7        _p</em>.syscalltick++<br>8        if sched.stopwait–; sched.stopwait == 0 {<br>9            notewakeup(&amp;sched.stopnote)<br>10        }<br>11    }<br>12    unlock(&amp;sched.lock)<br>13}</p>
<h2 id="▎-总结"><a href="#▎-总结" class="headerlink" title="▎**总结**"></a><strong>▎**</strong>总结**</h2><p>提供给用户使用的系统调用，基本都会通知 runtime，以 entersyscall，exitsyscall 的形式来告诉 runtime，在这个 syscall 阻塞的时候，由 runtime 判断是否把 P 腾出来给其它的 M 用。解绑定指的是把 M 和 P 之间解绑，如果绑定被解除，在 syscall 返回时，这个 g 会被放入执行队列 runq 中。</p>
<p>同时 runtime 又保留了自己的特权，在执行自己的逻辑的时候，我的 P 不会被调走，这样保证了在 Go 自己“底层”使用的这些 syscall 返回之后都能被立刻处理。</p>
<p>所以同样是 epollwait，runtime 用的是不能被别人打断的，你用的 syscall.EpollWait 那显然是没有这种特权的。</p>
<h2 id="▎-END"><a href="#▎-END" class="headerlink" title="▎**END**"></a><strong>▎**</strong>END**</h2><p>参考资料如下<br><a target="_blank" rel="noopener" href="https://z.didi.cn/1HecgP">https://z.didi.cn/1HecgP</a></p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2021/03/15/yuque/%E6%9B%B9%E6%98%A5%E6%99%96%EF%BC%9A%E8%B0%88%E4%B8%80%E8%B0%88%20Go%20%E5%92%8C%20Syscall/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-yuque/Go 与异步 IO - io_uring 的思考" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/15/yuque/Go%20%E4%B8%8E%E5%BC%82%E6%AD%A5%20IO%20-%20io_uring%20%E7%9A%84%E6%80%9D%E8%80%83/">Go 与异步 IO - io_uring 的思考</a>
    </h1>
  

        
        <a href="/2021/03/15/yuque/Go%20%E4%B8%8E%E5%BC%82%E6%AD%A5%20IO%20-%20io_uring%20%E7%9A%84%E6%80%9D%E8%80%83/" class="archive-article-date">
  	<time datetime="2021-03-15T03:11:09.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2021-03-15</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Golang-中并发-IO-的现状"><a href="#Golang-中并发-IO-的现状" class="headerlink" title="Golang 中并发 IO 的现状"></a>Golang 中并发 IO 的现状</h1><p>对于 Go 这种本身便是为并发而生的语言来说，使用 <code>io_uring</code> 这种系统级异步接口也不是那么的迫切<br>比如对于普通文件的读写以及 socket 的操作都会通过 <code>netpoll</code> 来进行优化，当文件/套接字可读可写时 netpoll 便会唤醒相应 goroutine 来对文件进行读写<br>而对于可能会阻塞的系统调用，在 syscall 底层调用 <code>syscall.Syscall/Syscall6</code> 时配合 runtime 判断是否将 P 和 G 绑定的 M 解绑，然后将 P 交给其他 M 来使用，通过这种机制可以减少系统调用从用户态切换到内核态对整个程序带来的损耗<br>Go runtime 实际上已经实现了用户态的并发 IO，现在 Linux 内核提供了新的异步 IO 接口，那又该如何去利用这种新的技术呢<br>我们首先先看一下当前 Go 是如何做到异步 IO 的</p>
<h2 id="IO-与-netpoll"><a href="#IO-与-netpoll" class="headerlink" title="IO 与 netpoll"></a>IO 与 netpoll</h2><h3 id="文件-IO-与-netpoll"><a href="#文件-IO-与-netpoll" class="headerlink" title="文件 IO 与 netpoll"></a>文件 IO 与 netpoll</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; src&#x2F;os&#x2F;file.go</span><br><span class="line">func OpenFile(name string, flag int, perm FileMode) (*File, error) &#123;</span><br><span class="line">    f, err :&#x3D; openFileNolog(name, flag, perm)</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; src&#x2F;os&#x2F;file_unix.go</span><br><span class="line">func openFileNolog(name string, flag int, perm FileMode) (*File, error) &#123;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    r, e &#x3D; syscall.Open(name, flag|syscall.O_CLOEXEC, syscallMode(perm))</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    return newFile(uintptr(r), name, kindOpenFile), nil</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; src&#x2F;os&#x2F;file_unix.go</span><br><span class="line">func newFile(fd uintptr, name string, kind newFileKind) *File &#123;</span><br><span class="line">    fdi :&#x3D; int(fd)</span><br><span class="line">    f :&#x3D; &amp;File&#123;&amp;file&#123;</span><br><span class="line">        pfd: poll.FD&#123;</span><br><span class="line">            Sysfd:     fdi,</span><br><span class="line">            IsStream:      true,</span><br><span class="line">            ZeroReadIsEOF: true,</span><br><span class="line">        &#125;,</span><br><span class="line">        name:    name,</span><br><span class="line">        stdoutOrErr: fdi &#x3D;&#x3D; 1 || fdi &#x3D;&#x3D; 2,</span><br><span class="line">    &#125;&#125;</span><br><span class="line">    pollable :&#x3D; kind &#x3D;&#x3D; kindOpenFile || kind &#x3D;&#x3D; kindPipe || kind &#x3D;&#x3D; kindNonBlock</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    if err :&#x3D; f.pfd.Init(&quot;file&quot;, pollable); err !&#x3D; nil &#123;</span><br><span class="line">        &#x2F;&#x2F; ...</span><br><span class="line">    &#125; else if pollable &#123;</span><br><span class="line">        if err :&#x3D; syscall.SetNonblock(fdi, true); err &#x3D;&#x3D; nil &#123;</span><br><span class="line">            f.nonblock &#x3D; true</span><br><span class="line">        &#125;</span><br><span class="line">        return f</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从 <code>os.Open</code> 到 <code>newFile</code>，可以看到文件的 <code>文件描述符</code> 被放到 <code>poll.FD</code> 进行初始化了, <code>poll.FD.Init</code> 便是将<code>文件描述符</code>注册到 <code>netpoll(epoll)</code> 中</p>
<blockquote>
<p>需要注意当文件被注册到 <code>netpoll(epoll)</code> 后，会将它置为非阻塞模式(<code>SetNonblock</code>)，因为 <code>netpoll(epoll)</code> 采用的是边缘触发模式<br>比如说非阻塞文件描述符中有可读事件时，<code>epoll</code> 只会通知一次(除非有新的数据被写入文件会再次通知)，也就说需要所有数据读出来直到返回 <code>-EAGAIN</code>，对于阻塞模式的 socket 文件，当从 socket 中读取数据时就可能会阻塞等待，这样也就失去了 epoll 的意义</p>
</blockquote>
<p>我们可以再看一下 <code>poll.FD</code> 是如何利用 <code>netpoll</code> 进行读取的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; src&#x2F;internal&#x2F;poll&#x2F;fd_unix.go</span><br><span class="line">func (fd *FD) Read(p []byte) (int, error) &#123;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    for &#123;</span><br><span class="line">        n, err :&#x3D; ignoringEINTR(syscall.Read, fd.Sysfd, p)</span><br><span class="line">        if err !&#x3D; nil &#123;</span><br><span class="line">            n &#x3D; 0</span><br><span class="line">            if err &#x3D;&#x3D; syscall.EAGAIN &amp;&amp; fd.pd.pollable() &#123;</span><br><span class="line">                continue</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        err &#x3D; fd.eofError(n, err)</span><br><span class="line">        return n, err</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到 <code>ignoringEINTR</code> 中调用 <code>syscall.Read</code> 读取文件，如果出现 <code>syscall.EAGAIN</code>，那么就调用 <code>fd.pd.waitRead</code> 来等待数据可读</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; src&#x2F;internal&#x2F;poll&#x2F;fd_unix.go</span><br><span class="line">type FD struct &#123;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    Sysfd int</span><br><span class="line">    pd pollDesc</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>pollDesc</code> Go 对 <code>netpoll</code> 的抽象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; src&#x2F;internal&#x2F;poll&#x2F;fd_poll_runtime.go</span><br><span class="line">func runtime_pollServerInit()</span><br><span class="line">func runtime_pollOpen(fd uintptr)(uintptr, int)</span><br><span class="line">func runtime_pollClose(ctx uintptr)</span><br><span class="line">&#x2F;&#x2F; ...</span><br><span class="line">type pollDesc struct &#123;</span><br><span class="line">    runtimeCtx uintptr</span><br><span class="line">&#125;</span><br><span class="line">func (pd *pollDesc) init(fd *FD) error &#123;</span><br><span class="line">    serverInit.Do(runtime_pollServerInit)</span><br><span class="line">    ctx, errno :&#x3D; runtime_pollOpen(uintptr(fd.Sysfd))</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    pd.runtimeCtx &#x3D; ctx</span><br><span class="line">    return nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>runtime_poll*</code> 这些函数才是真正的 netpoll，而这些函数是在<em>src/runtime/netpoll.go</em> 中实现，并通过 <code>go:linkname</code> 来链接到 <em>internal/poll</em> 中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; src&#x2F;runtime&#x2F;netpoll.go</span><br><span class="line">&#x2F;&#x2F; go:linkname poll_runtime_pollServerInit internal&#x2F;poll.runtime_pollServerInit</span><br><span class="line">func poll_runtime_pollServerInit() &#123;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据具体的平台来实现 poller，对于 Linux，便是使用 <code>epoll</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; src&#x2F;runtime&#x2F;netpoll_epoll.go</span><br><span class="line">&#x2F;&#x2F; 注册文件到 netpoll 中</span><br><span class="line">func netpolllopen(fd uintptr, pd *pollDesc) int32 &#123;</span><br><span class="line">    var ev epollevent</span><br><span class="line">    ev.events &#x3D; _EPOLLIN | _EPOLLOUT | _EPOLLRDHUP | _EPOLLET</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    return -epollctr(epfd, _EPOLL_CTL_ADD, int32(fd), &amp;ev)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加新的文件描述符时，可以发现<code>fd</code>是以 <code>边缘触发</code> 的方式注册到 <code>netpoll(epoll)</code> 中</p>
<h3 id="socket-IO-与-netpoll"><a href="#socket-IO-与-netpoll" class="headerlink" title="socket IO 与 netpoll"></a>socket IO 与 netpoll</h3><p>从 <code>netpoll</code> 这个名字上就可以看出，<code>netpoll</code> 是 Go 为了高性能的异步网络而实现的<br>看一下创建 TCPListener socket 的流程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; src&#x2F;net&#x2F;tcpsock.go</span><br><span class="line">type TCPListener struct &#123;</span><br><span class="line">    fd *netFD</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; src&#x2F;net&#x2F;fd_posix.go</span><br><span class="line">type netFD struct &#123;</span><br><span class="line">    pfd poll.FD</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; 1.</span><br><span class="line">&#x2F;&#x2F; src&#x2F;net&#x2F;tcpsock.go</span><br><span class="line">func ListenTCP(network string, laddr *TCPAddr) (*TCPListener, error) &#123;</span><br><span class="line">    sl :&#x3D; &amp;sysListener&#123;network: network, address: laddr.String()&#125;</span><br><span class="line">    ln, err :&#x3D; sl.listenTCP(context.Background(), laddr)</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; 2.</span><br><span class="line">&#x2F;&#x2F; src&#x2F;net&#x2F;tcpsock_posix.go</span><br><span class="line">func (sl *sysListener) listenTCP(ctx context.Context, laddr *TCPAddr) (*TCPListener, error) &#123;</span><br><span class="line">    fd, err :&#x3D; internetSocket(ctx, sl.network, laddr, nil, syscall.SOCK_STREAM, 0, &quot;listen&quot;, sl.ListenConfig.Control)</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    return &amp;TCPListener&#123;fd: fd, lc, sl.ListenConfig&#125;, nil</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; 3.</span><br><span class="line">&#x2F;&#x2F; src&#x2F;net&#x2F;ipsock_posix.go</span><br><span class="line">func internelSocket(ctx context.Context, ...) (fd *netFD, err error) &#123;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    return socket(ctx, net, family, sotype, proto, ipv6only, laddr, radddr, ctrlFn)</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; 4.</span><br><span class="line">&#x2F;&#x2F; src&#x2F;sock_posix.go</span><br><span class="line">func socket(...) (fd *netFD, err error) &#123;</span><br><span class="line">    s, err :&#x3D; sysSocket(family, sotype, proto)</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    fd, err &#x3D; newFD(s, family, sotype, net)</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; 5.</span><br><span class="line">&#x2F;&#x2F; src&#x2F;fd_unix.go</span><br><span class="line">func newFD(sysfd, family, sotype int, net string) (*netFD, error) &#123;</span><br><span class="line">    ret :&#x3D; &amp;netFD&#123;</span><br><span class="line">        pfd: poll.FD&#123;</span><br><span class="line">            Sysfd:    sysfd,</span><br><span class="line">            IsStream: sotype &#x3D;&#x3D; syscall.SOCK_STREAM,</span><br><span class="line">            &#x2F;&#x2F; ...</span><br><span class="line">        &#125;,</span><br><span class="line">        &#x2F;&#x2F; ...</span><br><span class="line">    &#125;</span><br><span class="line">    return ret, nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建 TCPListener 链路还是挺长的，不过在第四步 <code>socket</code> 函数中可以看到调用 <code>newFD</code> 来返回 <code>netFD</code> 实例，而 <code>netFD.pfd</code> 便是 <code>poll.FD</code>, 而对 <code>netFD</code> 的读写和文件 IO 一样便都会通过 <code>poll.FD</code> 来利用 <code>netpoll</code>。</p>
<h3 id="netpoll-唤醒-goroutine"><a href="#netpoll-唤醒-goroutine" class="headerlink" title="netpoll 唤醒 goroutine"></a>netpoll 唤醒 goroutine</h3><h4 id="挂起-goroutine"><a href="#挂起-goroutine" class="headerlink" title="挂起 goroutine"></a>挂起 goroutine</h4><p>通过 <code>poll.pollDesc</code> 将文件描述符加入到 <code>netpoll</code> 后，当对文件描述符进行读写时，如果 <code>syscall.Read</code> 返回 <code>syscall.EAGAIN</code> 的话就需要调用 <code>pollDesc.waitRead/waitWrite</code> 来等待可读可写</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; src&#x2F;internal&#x2F;poll&#x2F;fd_poll_runtime.go</span><br><span class="line">func (pd *pollDesc) waitRead(isFile bool) error&#123;</span><br><span class="line">    return pd.wait(&#39;r&#39;, isFile)</span><br><span class="line">&#125;</span><br><span class="line">func (pd *pollDesc) waitWrite(isFile bool) error&#123;</span><br><span class="line">    return pd.wait(&#39;w&#39;, isFile)</span><br><span class="line">&#125;</span><br><span class="line">func (pd *pollDesc) wait(mode int, isFile bool) error&#123;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    res :&#x3D; runtime_pollWait(pd.runtimeCtx, mode)</span><br><span class="line">    return convertErr(res, isFile)</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; src&#x2F;runtime&#x2F;netpoll.go</span><br><span class="line">&#x2F;&#x2F;go:linkname poll_runtime_pollWait internal&#x2F;poll.runtime_pollWait</span><br><span class="line">func poll_runtime_pollWait(pd *pollDesc, mode int) int &#123;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    for !netpollblock(pd, int32(mode), false) &#123;</span><br><span class="line">        &#x2F;&#x2F; ...</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br><span class="line">func netpollblock(pd *pollDesc, mode int32, waitio bool) bool &#123;</span><br><span class="line">    gpp :&#x3D; &amp;pd.rg</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    &#x2F;&#x2F; 状态检查</span><br><span class="line">    if waitio || netpollcheckerr(pd, mode) &#x3D;&#x3D; 0 &#123;</span><br><span class="line">        gopark(netpollblockcommit, unsafe.Pointer(gpp), waitReasonIOWait, traceEvGoBlockNet, 5)</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br><span class="line">func netpollblockcommit(gp *g, gpp unsafe.Pointer) bool &#123;</span><br><span class="line">    r :&#x3D; atomic.Casuintptr((*uintptr)(gpp), pdWait, uintptr(unsafe.Pointer(gp)))</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>等待文件可读写，最终会调用 <code>netpollblock</code> 函数，并不会直接调用 epoll wait 的系统调用，而是挂起当前 goroutine, 并等待唤醒</p>
<h4 id="唤醒-goroutine"><a href="#唤醒-goroutine" class="headerlink" title="唤醒 goroutine"></a>唤醒 goroutine</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; src&#x2F;runtime&#x2F;netpoll_epoll.go</span><br><span class="line">func netpoll(delay int64) gList &#123;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    var waitms int32</span><br><span class="line">    &#x2F;&#x2F; 计算 waitms，大概规则：</span><br><span class="line">    &#x2F;&#x2F; delay &lt; 0, waitms &#x3D; -1，阻塞等待</span><br><span class="line">    &#x2F;&#x2F; delay &#x3D;&#x3D; 0, waitms &#x3D; 0, 不阻塞</span><br><span class="line">    &#x2F;&#x2F; delay &gt; 0, delay 以纳秒为单位作为 waitms</span><br><span class="line">    var events [128]epollevent</span><br><span class="line">retry:</span><br><span class="line">    n :&#x3D; epollwait(epfd, &amp;events[0], int32(len(events)), waitms)</span><br><span class="line">    if n &lt; 0 &#123;</span><br><span class="line">        &#x2F;&#x2F; ...</span><br><span class="line">    &#125;</span><br><span class="line">    var toRun gList</span><br><span class="line">    for i :&#x3D; int32(0); i &lt; n; i++ &#123;</span><br><span class="line">        ev :&#x3D; &amp;events[i]</span><br><span class="line">        &#x2F;&#x2F; ...</span><br><span class="line">        var mode int32</span><br><span class="line">        if ev.events&amp;(_EPOLLIN|_EPOLLRDHUP|_EPOLLHUP|_EPOLLERR) !&#x3D; 0 &#123;</span><br><span class="line">            mode +&#x3D; &#39;r&#39;</span><br><span class="line">        &#125;</span><br><span class="line">        if ev.events&amp;(_EPOLLOUT|_EPOLLHUP|_EPOLLERR) !&#x3D; 0 &#123;</span><br><span class="line">            mode +&#x3D; &#39;w&#39;</span><br><span class="line">        &#125;</span><br><span class="line">        if mode !&#x3D; 0 &#123;</span><br><span class="line">            pd :&#x3D; *(**pollDesc)(unsafe.Pointer(&amp;ev.data))</span><br><span class="line">            pd.everr &#x3D; false</span><br><span class="line">            if ev.events &#x3D;&#x3D; _EPOLLERR &#123;</span><br><span class="line">                pd.everr &#x3D; true</span><br><span class="line">            &#125;</span><br><span class="line">            netpollready(&amp;toRun, pd, mode)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return toRun</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>netpoll</code> 会调用 <code>epollWait</code> 来获取 epoll 事件，而在 runtime 中很多地方都会调用 <code>netpoll</code> 函数<br><strong>监控函数 <code>sysmon</code></strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; src&#x2F;runtime&#x2F;proc.go</span><br><span class="line">func sysmon() &#123;</span><br><span class="line">    &#x2F;&#x2F; ....</span><br><span class="line">    for &#123;</span><br><span class="line">        &#x2F;&#x2F; ...</span><br><span class="line">        list :&#x3D; netpoll(0)</span><br><span class="line">        if !list.empty() &#123;</span><br><span class="line">            &#x2F;&#x2F;...</span><br><span class="line">            injectglist(&amp;list) &#x2F;&#x2F; 将 goroutine 放到 runable 队列中</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>查找可运行的 goroutine</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; src&#x2F;runtime&#x2F;proc.go</span><br><span class="line">func findrunable() (gp *g, inheritTIme bool) &#123;</span><br><span class="line">top:</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    if list :&#x3D; netpoll(0); !list.empty() &#123;</span><br><span class="line">        gp :&#x3D; list.pop()</span><br><span class="line">        injectglist(&amp;list)</span><br><span class="line">        &#x2F;&#x2F; ...</span><br><span class="line">        return gp, false</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; ....</span><br><span class="line">stop:</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    list :&#x3D; netpoll(delta) &#x2F;&#x2F; block until new work is available</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>GC 时调用 <code>startTheWorld</code></strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; src&#x2F;runtime&#x2F;proc.go</span><br><span class="line">func startTheWorld() &#123;</span><br><span class="line">    systemstack(func() &#123;startTheWorldWithSema(false)&#125;)</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line"> &#125;</span><br><span class="line">func startTheWorldWithSema(emitTraceEvent bool) int64 &#123;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    list :&#x3D; netpoll(0)</span><br><span class="line">    injectglist(&amp;list)</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通常获取可用的 goroutine 时都可能有机会去调用 <code>netpoll</code>，然后再调用 <code>injectglist(&amp;list)</code> 将可运行 goroutine 加入到<code>runq</code>队列中</p>
<h1 id="系统级异步接口-——-io-uring"><a href="#系统级异步接口-——-io-uring" class="headerlink" title="系统级异步接口 —— io_uring"></a>系统级异步接口 —— io_uring</h1><blockquote>
<p>本节不会详细介绍 io_uring 的具体操作，关于 io_uring 的使用，可以查看 <a target="_blank" rel="noopener" href="https://unixism.net/loti/index.html">Lord of the io_uring</a></p>
</blockquote>
<p>Linux kernel 5.1 新增了异步接口 <code>io_uring</code>，它是 Jens Axboe 以高效，可扩展，易用为目的设计的一种全新异步接口，为什么是全新呢，因为 Linux 已经提供了异步 IO 接口 —— AIO，不过就连 Linus 都对它一阵吐槽<br><a target="_blank" rel="noopener" href="https://lwn.net/Articles/671657/">Re: [PATCH 09/13] aio: add support for async openat()</a></p>
<blockquote>
<p>So I think this is ridiculously ugly.<br>AIO is a horrible ad-hoc design, with the main excuse being “other,<br>less gifted people, made that design, and we are implementing it for<br>compatibility because database people - who seldom have any shred of<br>taste - actually use it”.<br>But AIO was always really really ugly.</p>
</blockquote>
<p>io_uring 提供的异步接口，不仅仅可以使用 文件 IO，套接字 IO，甚至未来可以扩展加入其它系统调用<br>而且 <code>io_uring</code> 采用应用程序和内核共享内存的方式，来提交请求和获取完成事件</p>
<blockquote>
<p>使用共享内存的方式可能是内核对接口优化的一种趋势</p>
</blockquote>
<p><strong>io<em>uring 名称的意思便是 _io use ring</em>，而 ring 便是指和内核内存共享的 <code>提交队列</code>和<code>完成队列</code>两个环形缓冲区</strong></p>
<h2 id="SubmissionQueueEntry"><a href="#SubmissionQueueEntry" class="headerlink" title="SubmissionQueueEntry"></a>SubmissionQueueEntry</h2><p>我们来看一下 io_uring 用来提交请求的结构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">struct io_uring_sqe &#123;</span><br><span class="line">        __u8    opcode;         &#x2F;* 请求的操作类型 *&#x2F;</span><br><span class="line">        __u8    flags;          &#x2F;* IOSQE_ flags *&#x2F;</span><br><span class="line">        __u16   ioprio;         &#x2F;* ioprio for the request *&#x2F;</span><br><span class="line">        __s32   fd;             &#x2F;* 用于 IO 的文件描述符 *&#x2F;</span><br><span class="line">        union &#123;</span><br><span class="line">                __u64   off;    &#x2F;* offset into file *&#x2F;</span><br><span class="line">                __u64   addr2;</span><br><span class="line">        &#125;;</span><br><span class="line">        union &#123;</span><br><span class="line">                __u64   addr;   &#x2F;* pointer to buffer or iovecs *&#x2F;</span><br><span class="line">                __u64   splice_off_in;</span><br><span class="line">        &#125;;</span><br><span class="line">        __u32   len;            &#x2F;* buffer size or number of iovecs *&#x2F;</span><br><span class="line"></span><br><span class="line">        &#x2F;*</span><br><span class="line">         * 用于特定操作的字段</span><br><span class="line">         *&#x2F;</span><br><span class="line">        union &#123;</span><br><span class="line">                __kernel_rwf_t  rw_flags;</span><br><span class="line">                __u32           fsync_flags;</span><br><span class="line">                __u16           poll_events;    &#x2F;* compatibility *&#x2F;</span><br><span class="line">                __u32           poll32_events;  &#x2F;* word-reversed for BE *&#x2F;</span><br><span class="line">                __u32           sync_range_flags;</span><br><span class="line">                __u32           msg_flags;</span><br><span class="line">                __u32           timeout_flags;</span><br><span class="line">                __u32           accept_flags;</span><br><span class="line">                __u32           cancel_flags;</span><br><span class="line">                __u32           open_flags;</span><br><span class="line">                __u32           statx_flags;</span><br><span class="line">                __u32           fadvise_advice;</span><br><span class="line">                __u32           splice_flags;</span><br><span class="line">        &#125;;</span><br><span class="line">        __u64   user_data;      &#x2F;* 用来关联请求的完成事件 *&#x2F;</span><br><span class="line">        union &#123;</span><br><span class="line">                struct &#123;</span><br><span class="line">                        &#x2F;* pack this to avoid bogus arm OABI complaints *&#x2F;</span><br><span class="line">                        union &#123;</span><br><span class="line">                                &#x2F;* index into fixed buffers, if used *&#x2F;</span><br><span class="line">                                __u16   buf_index;</span><br><span class="line">                                &#x2F;* for grouped buffer selection *&#x2F;</span><br><span class="line">                                __u16   buf_group;</span><br><span class="line">                        &#125; __attribute__((packed));</span><br><span class="line">                        &#x2F;* personality to use, if used *&#x2F;</span><br><span class="line">                        __u16   personality;</span><br><span class="line">                        __s32   splice_fd_in;</span><br><span class="line">                &#125;;</span><br><span class="line">                __u64   __pad2[3];</span><br><span class="line">        &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>io_uring_sqe</code> 一个非常复杂的结构，最核心的三个字段 <code>opcode</code>，<code>fd</code>，<code>user_data</code></p>
<ul>
<li><code>opcode</code> 指定具体是什么操作，比如 <code>IORING_OP_READV</code>，<code>IORING_OP_ACCEPT</code>，<code>IORING_OP_OPENAT</code>，现在支持 35 种操作</li>
<li><code>fd</code> 表示用于 IO 操作的文件描述符</li>
<li><code>user_data</code> 当请求操作完成后，io_uring 会生成一个完成事件放到 <code>完成队列(CompletionQueue)</code> 中，而 <code>user_data</code> 便是用来和<code>完成队列</code>中的事件进行绑定的，他会原封不动的复制到<code>完成队列的事件(cqe)</code>中</li>
<li><code>flags</code> 字段用来实现链式请求之类的功能<blockquote>
<p>可以发现 <code>opcode</code> 是 uint8，也就是现在来看最多支持 256 个系统调用，但是整个 <code>io_uring_sqe</code> 还为未来预留了一些空间 <code>__pad2</code></p>
</blockquote>
</li>
</ul>
<p><strong>通过 <code>opcode</code> 结合结合其他 <code>union</code> 的字段，便实现了扩展性极强的 <code>io_uring</code> 接口</strong></p>
<h2 id="CompletionQueueEvent"><a href="#CompletionQueueEvent" class="headerlink" title="CompletionQueueEvent"></a>CompletionQueueEvent</h2><p><code>完成队列事件(CompletionQueueEvent)</code> 的结构就比较简单了，主要是表示提交的异步操作执行的结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">struct io_uring_cqe &#123;</span><br><span class="line">        __u64   user_data;      &#x2F;* 直接复制 sqe-&gt;data *&#x2F;</span><br><span class="line">        __s32   res;            &#x2F;* 异步操作的结果 *&#x2F;</span><br><span class="line">        __u32   flags;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>user_data</code> 便是从 <code>sqe-&gt;data</code> 直接复制过来了，可以通过 <code>user_data</code> 绑定到对应的 <code>sqe</code><br><code>res</code> 便是异步操作执行的结果，如果 res &lt; 0，通常说明操作执行错误<br><code>flags</code> 暂时没有使用</p>
<h2 id="io-uring-setup"><a href="#io-uring-setup" class="headerlink" title="io_uring_setup"></a>io_uring_setup</h2><p><strong>io_uring 使用共享内存的方式，来提交请求和获取执行结果，减少内存拷贝带来的损耗</strong><br><code>io_uring_setup</code> 接口会接受一个指定提交队列大小的 <code>uint32</code> 类型参数和一个 <code>io_uring_params</code> 对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;linux&#x2F;io_uring.h&gt;</span><br><span class="line">int io_uring_setup(u32 entries, struct io_uring_params *p);</span><br></pre></td></tr></table></figure>

<p>调用成功会返回一个<code>文件描述符</code>，用于后续的操作</p>
<h4 id="io-uring-params"><a href="#io-uring-params" class="headerlink" title="io_uring_params"></a>io_uring_params</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">struct io_uring_params &#123;</span><br><span class="line">        __u32 sq_entries;</span><br><span class="line">        __u32 cq_entries;</span><br><span class="line">        __u32 flags;</span><br><span class="line">        __u32 sq_thread_cpu;</span><br><span class="line">        __u32 sq_thread_idle;</span><br><span class="line">        __u32 features;</span><br><span class="line">        __u32 wq_fd;</span><br><span class="line">        __u32 resv[3];</span><br><span class="line">        struct io_sqring_offsets sq_off;</span><br><span class="line">        struct io_cqring_offsets cq_off;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>io_uring_params</code> 不只用来配置 <code>io_uring</code> 实例，内核也会填充 <code>io_uring_params</code> 中关于 <code>io_uring</code> 实例的信息，比如用来映射共享内存的请求队列和完成队列字段的偏移量 - <code>io_sqring_offsets</code> 和 <code>io_cqring_offsets</code></p>
<h5 id="配置-io-uring"><a href="#配置-io-uring" class="headerlink" title="配置 io_uring"></a>配置 io_uring</h5><p><code>flags</code> 以位掩码的方式，结合相应 <code>sq_thread_cpu</code>，<code>sq_thread_idle</code> ，<code>wq_fd</code>，<code>cq_entries</code> 字段来配置 io_uring 实例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * io_uring_setup() flags</span><br><span class="line"> *&#x2F;</span><br><span class="line">#define IORING_SETUP_IOPOLL     (1U &lt;&lt; 0)       &#x2F;* io_context is polled *&#x2F;</span><br><span class="line">#define IORING_SETUP_SQPOLL     (1U &lt;&lt; 1)       &#x2F;* SQ poll thread *&#x2F;</span><br><span class="line">#define IORING_SETUP_SQ_AFF     (1U &lt;&lt; 2)       &#x2F;* sq_thread_cpu is valid *&#x2F;</span><br><span class="line">#define IORING_SETUP_CQSIZE     (1U &lt;&lt; 3)       &#x2F;* app defines CQ size *&#x2F;</span><br><span class="line">#define IORING_SETUP_CLAMP      (1U &lt;&lt; 4)       &#x2F;* clamp SQ&#x2F;CQ ring sizes *&#x2F;</span><br><span class="line">#define IORING_SETUP_ATTACH_WQ  (1U &lt;&lt; 5)       &#x2F;* attach to existing wq *&#x2F;</span><br><span class="line">#define IORING_SETUP_R_DISABLED (1U &lt;&lt; 6)       &#x2F;* start with ring disabled *&#x2F;</span><br></pre></td></tr></table></figure>

<p>通常 cq_entries 为 sq_entries 的两倍，通过 <code>flags</code> 指定 <code>IORING_SETUP_CQSIZE</code> ，然后设置 <code>cq_entries</code> 字段为指定大小</p>
<blockquote>
<p>cq_entries 不能小于 sq_entries</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/iceber/iouring-go">iouring-go</a> 提供了初始化 io_uring 对象时的配置函数，可以看一下这些函数的具体实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">type IOURingOption func(*IOURing)</span><br><span class="line">func New(entries uint, opts ...IOURingOption) (iour *IOURing, err error)</span><br><span class="line">func WithParams(params *iouring_syscall.IOURingParams) IOURingOption</span><br><span class="line">func WithAsync() IOURingOption</span><br><span class="line">func WithDisableRing() IOURingOption</span><br><span class="line">func WithCQSize(size uint32) IOURingOption</span><br><span class="line">func WithSQPoll() IOURingOption</span><br><span class="line">func WithSQPollThreadCPU(cpu uint32) IOURingOption</span><br><span class="line">func WithSQPollThreadIdle(idle time.Duration) IOURingOption</span><br></pre></td></tr></table></figure>

<h5 id="内核填充信息"><a href="#内核填充信息" class="headerlink" title="内核填充信息"></a>内核填充信息</h5><p>内核会向 <code>io_uring_params</code> 填充跟 io_uring 实例相关的信息<br><code>sq_entries</code> 请求队列的大小，<code>io_uring_setup</code> 会传递请求队列的大小 <code>entries</code>，io_uring 会根据 <code>entries</code> 设置 <code>sq_entries</code> 为 2 的次方大小<br><code>cq_entries</code> 完成队列的大小，通常为 <code>sq_entries</code> 的两倍，即使通过 <code>IORING_SETUP_CQSIZE</code> flag 设置了 <code>cq_enries</code> ，内核依然会以 2 的次方重新计算出 <code>cq_entries</code> 的大小<br><code>features</code> 记录了当前内核版本支持的一些功能</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * io_uring_params-&gt;features flags</span><br><span class="line"> *&#x2F;</span><br><span class="line">#define IORING_FEAT_SINGLE_MMAP         (1U &lt;&lt; 0)</span><br><span class="line">#define IORING_FEAT_NODROP              (1U &lt;&lt; 1)</span><br><span class="line">#define IORING_FEAT_SUBMIT_STABLE       (1U &lt;&lt; 2)</span><br><span class="line">#define IORING_FEAT_RW_CUR_POS          (1U &lt;&lt; 3)</span><br><span class="line">#define IORING_FEAT_CUR_PERSONALITY     (1U &lt;&lt; 4)</span><br><span class="line">#define IORING_FEAT_FAST_POLL           (1U &lt;&lt; 5)</span><br><span class="line">#define IORING_FEAT_POLL_32BITS         (1U &lt;&lt; 6)</span><br><span class="line">#define IORING_FEAT_SQPOLL_NONFIXED     (1U &lt;&lt; 7)</span><br></pre></td></tr></table></figure>

<p><code>io_sqring_offsets</code> 和 <code>io_cqring_offsets</code> 便是<code>SQ</code>和<code>CQ</code>在共享内存中的偏移量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">struct io_sqring_offsets &#123;</span><br><span class="line">        __u32 head;</span><br><span class="line">        __u32 tail;</span><br><span class="line">        __u32 ring_mask;</span><br><span class="line">        __u32 ring_entries;</span><br><span class="line">        __u32 flags;</span><br><span class="line">        __u32 dropped;</span><br><span class="line">        __u32 array;</span><br><span class="line">        __u32 resv1;</span><br><span class="line">        __u64 resv2;</span><br><span class="line">&#125;;</span><br><span class="line">struct io_cqring_offsets &#123;</span><br><span class="line">        __u32 head;</span><br><span class="line">        __u32 tail;</span><br><span class="line">        __u32 ring_mask;</span><br><span class="line">        __u32 ring_entries;</span><br><span class="line">        __u32 overflow;</span><br><span class="line">        __u32 cqes;</span><br><span class="line">        __u32 flags;</span><br><span class="line">        __u32 resv1;</span><br><span class="line">        __u64 resv2;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>根据这些偏移量便可以调用 mmap 来映射 SQ 和 CQ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ptr &#x3D; mmap(0, sq_off.array + sq_entries * sizeof(__u32),</span><br><span class="line">           PROT_READ|PROT_WRITE, MAP_SHARED|MAP_POPULATE,</span><br><span class="line">           ring_fd, IORING_OFF_SQ_RING);</span><br></pre></td></tr></table></figure>

<p>可以参考 <a target="_blank" rel="noopener" href="https://github.com/Iceber/iouring-go">iouring-go</a> 对 IOURing 对象的初始化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; iouring-go&#x2F;iouring.go</span><br><span class="line">func New(entries uint, opts ...IOURingOption) (*IOURing, error) &#123;</span><br><span class="line">    iour :&#x3D; &amp;IOURing&#123;</span><br><span class="line">        params:    &amp;iouring_syscall.IOURingParams&#123;&#125;,</span><br><span class="line">        userDatas: make(map[uint64]*UserData),</span><br><span class="line">        cqeSign:   make(chan struct&#123;&#125;, 1),</span><br><span class="line">        closer:    make(chan struct&#123;&#125;),</span><br><span class="line">        closed:    make(chan struct&#123;&#125;),</span><br><span class="line">    &#125;</span><br><span class="line">    for _, opt :&#x3D; range opts &#123;</span><br><span class="line">        opt(iour)</span><br><span class="line">    &#125;</span><br><span class="line">    var err error</span><br><span class="line">    iour.fd, err &#x3D; iouring_syscall.IOURingSetup(entries, iour.params)</span><br><span class="line">    if err !&#x3D; nil &#123;</span><br><span class="line">        return nil, err</span><br><span class="line">    &#125;</span><br><span class="line">    if err :&#x3D; mmapIOURing(iour); err !&#x3D; nil &#123;</span><br><span class="line">        munmapIOURing(iour)</span><br><span class="line">        return nil, err</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>mmapIOURing</code> 中实现了对请求队列以及完成队列的内存映射</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; iouring-go&#x2F;mmap.go</span><br><span class="line">func mmapIOURing(iour *IOURing) (err error) &#123;</span><br><span class="line">    defer func() &#123;</span><br><span class="line">        if err !&#x3D; nil &#123;</span><br><span class="line">            munmapIOURing(iour)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line">    iour.sq &#x3D; new(SubmissionQueue)</span><br><span class="line">    iour.cq &#x3D; new(CompletionQueue)</span><br><span class="line">    if err &#x3D; mmapSQ(iour); err !&#x3D; nil &#123;</span><br><span class="line">        return err</span><br><span class="line">    &#125;</span><br><span class="line">    if (iour.params.Features &amp; iouring_syscall.IORING_FEAT_SINGLE_MMAP) !&#x3D; 0 &#123;</span><br><span class="line">        iour.cq.ptr &#x3D; iour.sq.ptr</span><br><span class="line">    &#125;</span><br><span class="line">    if err &#x3D; mmapCQ(iour); err !&#x3D; nil &#123;</span><br><span class="line">        return err</span><br><span class="line">    &#125;</span><br><span class="line">    if err &#x3D; mmapSQEs(iour); err !&#x3D; nil &#123;</span><br><span class="line">        return err</span><br><span class="line">    &#125;</span><br><span class="line">    return nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里不再详细介绍 <code>io_uring</code> 的使用 ，想要了解更多可以查看文末的<a target="_blank" rel="noopener" href="http://icebergu.com/archives/go-iouring#%E6%8E%A8%E8%8D%90%E9%98%85%E8%AF%BB">推荐阅读</a></p>
<h2 id="io-uring-的功能"><a href="#io-uring-的功能" class="headerlink" title="io_uring 的功能"></a>io_uring 的功能</h2><p>这里简单介绍一下 <code>io_uring</code> 提供的一些功能，以及在 Go 中如何去使用</p>
<h3 id="顺序执行"><a href="#顺序执行" class="headerlink" title="顺序执行"></a>顺序执行</h3><p>设置 <code>sqe-&gt;flags</code> 的 <code>IOSQE_IO_DRAIN</code> 标记，这样只有当该 <code>sqe</code> 之前所有的 <code>sqes</code> 都完成后，才会执行该 <code>sqe</code>，而后续的 <code>sqe</code> 也会在该 <code>sqe</code> 完成后才会执行<br>在 <a target="_blank" rel="noopener" href="https://github.com/iceber/iouring-go">iouring-go</a> 中可以在构建 <code>IOURing</code> 对象时使用 <a target="_blank" rel="noopener" href="https://godoc.org/github.com/Iceber/iouring-go#WithDrain"><code>WithDrain</code></a> 来全局设置请求顺序执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iour :&#x3D; iouring.New(8, WithDrain())</span><br></pre></td></tr></table></figure>

<p>针对单一请求设置 <a target="_blank" rel="noopener" href="https://godoc.org/github.com/Iceber/iouring-go#PrepRequest.WithDrain"><code>WithDrain</code></a>，保证请求会在之前所有的请求都完成才会执行，而后续的请求也都会在该请求完成之后才会开始执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request, err :&#x3D; iour.SubmitRequest(iouring.Read(fd, buf).WithDrain(), nil)</span><br></pre></td></tr></table></figure>

<h3 id="链式请求"><a href="#链式请求" class="headerlink" title="链式请求"></a>链式请求</h3><p><code>io_uring</code> 提供了一组请求的链式/顺序执行的方法，可以让链中的请求会在上一个请求执行完成后才会执行，而且不影响链外其他请求的并发执行<br>设置 <code>sqe-&gt;flags</code> 的 <code>IOSQE_IO_LINK</code> 标记后，下一个 <code>sqe</code> 和当前 <code>sqe</code> 自动组成新链或者当前 <code>sqe</code> 的链中，链中没有设置 <code>IOSQWE_IO_LINK</code> 的 <code>sqe</code> 便是链尾<br>如果链中的有请求执行失败了，那么链中后续的 <code>sqe</code> 都会被取消( <code>cqe.res</code> 为 <code>-ECANCELED</code>)<br><strong><code>io_uring</code> 还提供了以外一种设置链式请求的方式，设置 <code>sqe-&gt;flags</code> 为 <code>IOSQE_IO_HARDLINK</code> flag，这种方式会让链中的请求忽略之前请求的结果，也就是说即使链中之前的请求执行失败了，也不会取消链中后边的请求</strong><br><a target="_blank" rel="noopener" href="https://github.com/iceber/iouring-go">iouring-go</a> 中可以使用 <a target="_blank" rel="noopener" href="https://godoc.org/github.com/Iceber/iouring-go#IOURing.SubmitLinkRequests"><code>SubmitLinkRequests</code></a> 或者 <a target="_blank" rel="noopener" href="https://godoc.org/github.com/Iceber/iouring-go#IOURing.SubmitHardLinkRequests"><code>SubmitHardLinkRequests</code></a> 方法来设置链式请求</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">preps :&#x3D; []iouring.PrepRequest&#123; iouring.Read(fd1, buf), iouring.Write(fd2, buf) &#125;</span><br><span class="line">requests, err :&#x3D; iour.SubmitLinkRequest(preps, nil)</span><br></pre></td></tr></table></figure>

<h3 id="请求取消"><a href="#请求取消" class="headerlink" title="请求取消"></a>请求取消</h3><p>当请求提交后，还可以提交取消请求的请求，这样如果请求还没有执行或者请求的操作可以被中断(比如 socket IO)，那么就可以被异步的取消，而对于已经启动的磁盘 IO 请求则无法取消<br>在 <a target="_blank" rel="noopener" href="https://github.com/iceber/iouring-go">iouring-go</a> 中，提交请求后会返回一个 <a target="_blank" rel="noopener" href="https://godoc.org/github.com/Iceber/iouring-go#Request"><code>iouring.Request</code></a> 对象，通过<code>request.Cancel</code> 方法就可以取消请求</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">request, err :&#x3D; iour.SubmitRequest(iouring.Timeout(1 * time.Second), nil)</span><br><span class="line">cancelRequest, err :&#x3D; request.Cancel()</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://godoc.org/github.com/Iceber/iouring-go#Request"><code>Cancel</code></a> 方法会返回一个 cancelRequest 对象，表示提交的取消请求<br>可以监听 <code>request</code> 的执行是否失败，并且失败原因是否为 <code>iouring.ErrRequestCanceled</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;- request.Done()</span><br><span class="line">if err :&#x3D; request.Err(); if err !&#x3D; nil &#123;</span><br><span class="line">    if err &#x3D;&#x3D; iouring.ErrRequestCanceled &#123;</span><br><span class="line">        fmt.Println(&quot;request is canceled&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也可去监听 cancelRequest 的执行结果，如果<code>cancelRequest.Err</code> 方法返回 <code>nil</code>，便是可能成功取消了，注意是可能取消了，因为一些操作是无法被取消的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;- cancelRequest.Done()</span><br><span class="line">if err :&#x3D; cancelRequest.Err(); if err !&#x3D; nil&#123;</span><br><span class="line">    if err &#x3D;&#x3D; iouring.ErrRequestNotFound()&#123;</span><br><span class="line">        fmt.Println(&quot;canceled request is not found&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; do something</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="定时和请求完成计数"><a href="#定时和请求完成计数" class="headerlink" title="定时和请求完成计数"></a>定时和请求完成计数</h3><p><code>io_uring</code> 提供了 <code>IORING_OP_TIMEOUT</code> 请求，可以用来提交超时请求<br>超时请求可以分为三种:</p>
<ul>
<li>相对时间超时</li>
<li>绝对时间超时</li>
<li>对请求完成计数，到达指定的完成事件数量后，超时请求就会完成</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/iceber/iouring-go">iouring-go</a> 对这三种情况封装了三个函数 <a target="_blank" rel="noopener" href="https://godoc.org/github.com/Iceber/iouring-go#Timeout"><code>iouring.Timeout</code></a>，<a target="_blank" rel="noopener" href="https://godoc.org/github.com/Iceber/iouring-go#TimeoutWithTime"><code>iouring.TimeoutWithTime</code></a>，<a target="_blank" rel="noopener" href="https://godoc.org/github.com/Iceber/iouring-go#CountCompletionEvent"><code>iouring.CountCompletionEvent</code></a> 来分别代表三种超时请求</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">now :&#x3D; time.Now()</span><br><span class="line">request, err :&#x3D; iouring.SubmitRequest(iouring.Timeout(2 * time.Second), nil)</span><br><span class="line">if err !&#x3D; nil &#123;</span><br><span class="line">    panic(err)</span><br><span class="line">&#125;</span><br><span class="line">&lt;- request.Done()</span><br><span class="line">fmt.Println(time.Now().Sub(now))</span><br></pre></td></tr></table></figure>

<p><strong>根据 <code>io_uring</code> 提供的超时请求，可以实现系统级的异步定时器</strong></p>
<h3 id="请求超时"><a href="#请求超时" class="headerlink" title="请求超时"></a>请求超时</h3><p><code>io_uring</code> 通过 <code>IOSQE_IO_LINK</code> 将一个请求和 <code>IORING_OP_LINK_TIMEOUT</code> 请求链接在一起，那么就可以做到请求的超时控制<br><a target="_blank" rel="noopener" href="https://github.com/iceber/iouring-go">iouring-go</a> 同样提供了简便方法 <a target="_blank" rel="noopener" href="https://godoc.org/github.com/Iceber/iouring-go#PrepRequest.WithTimeout"><code>WithTimeout</code></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">preps :&#x3D; iouring.Read(fd, buf).WithTimeout()</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://godoc.org/github.com/Iceber/iouring-go#PrepRequest.WithTimeout"><code>WithTimeout</code></a> 方法会返回两个 <a target="_blank" rel="noopener" href="https://godoc.org/github.com/Iceber/iouring-go#PrepRequest"><code>PrepRequest</code></a> 对象，所以需要使用 <a target="_blank" rel="noopener" href="https://godoc.org/github.com/Iceber/iouring-go#IOURing.SubmitRequests"><code>SubmitRequests</code></a> 来提交</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/iceber/iouring-go">iouring-go</a> 中请求超时的一些操作使用起来感觉还不是特别友好，有待优化</p>
</blockquote>
<h3 id="注册文件"><a href="#注册文件" class="headerlink" title="注册文件"></a>注册文件</h3><p><code>io_uring</code> 的一些 IO 操作需要提供文件描述符，而频繁的将文件和内核之间进行映射也会导致一定的性能损耗，所以可以使用 <code>io_uring</code> 的 <code>io_uring_register</code> 接口来提前注册文件描述符<br>详细的概念可以参考 <a target="_blank" rel="noopener" href="https://unixism.net/loti/ref-iouring/io_uring_register.html#io-uring-register">io_uring_register</a><br><a target="_blank" rel="noopener" href="https://github.com/iceber/iouring-go">iouring-go</a> 也提供了文件描述符的注册功能，而且对于已经注册的文件描述符会自动使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">func (iour *IOURing) RegisterFile(file *os.File) error</span><br><span class="line">func (iour *IOURing) RegisterFiles(files []*os.File) error</span><br><span class="line">func (iour *IOURing) UnregisterFile(file *os.File) error</span><br><span class="line">func (iour *IOURing) UnregisterFiles(files []*os.File) error</span><br></pre></td></tr></table></figure>

<p>当 <code>io_uring</code> 的文件描述符被关闭后，这些注册的文件会自动注销<br><em>需要注意，调用 <code>io_uring_register</code> 来注册文件描述符时，如果有其他的正在进行的请求的话，会等到这些请求都完成才会注册</em><br>注册文件描述符在 Go 中带来的并发问题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">type fileRegister struct &#123;</span><br><span class="line">    lock sync.Mutex</span><br><span class="line">    iouringFd int</span><br><span class="line">    fds          []int32</span><br><span class="line">    sparseindexs map[int]int</span><br><span class="line"></span><br><span class="line">    registered bool</span><br><span class="line">    indexs     sync.Map</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要注意由于存在对索引 <code>fileRegister.indexs</code> 的并发读写，所以使用 <code>sync.Map</code>，也就意味着，使用注册文件描述符，会带来一定的并发问题，经过简单的测试，<code>sync.Map</code> 带来的性能损耗导致注册文件描述符带来的优势并没有那么大的</p>
<blockquote>
<p>在 Go 中使用 <code>io_uring</code> 的最大问题便是对 <code>io_uring</code> 实例的竞争问题，而通过 Go 暴露给外部使用的并发机制，并不能让 <code>io_uring</code> 带来的异步 IO 发挥最大的性能<br>将 <code>io_uring</code> 融入 runtime 中，才是最终的解决方案</p>
</blockquote>
<h3 id="注册缓冲区"><a href="#注册缓冲区" class="headerlink" title="注册缓冲区"></a>注册缓冲区</h3><p>和注册文件描述符类似， <code>io_uring</code> 为了减少 IO 请求中缓冲区的映射，同样可以使用 <code>io_uring_register</code> 来注册缓冲区<br>如果要在请求中使用缓冲区的话，需要使用 <code>IORING_OP_READ_FIXED</code> 或者 <code>IORING_OP_WRITE_FIXED</code> 请求<br>具体可以参考 <a target="_blank" rel="noopener" href="https://unixism.net/loti/ref-iouring/io_uring_register.html#io-uring-register">io_uring_register</a></p>
<h3 id="内核侧请求队列轮询"><a href="#内核侧请求队列轮询" class="headerlink" title="内核侧请求队列轮询"></a>内核侧请求队列轮询</h3><p>将请求放到<code>SQ</code>的环形缓冲区后，需要调用 <code>io_uring_enter</code> 来通知内核有请求需要处理<br>io_uring 为了进一步减少系统调用，可以在 <code>io_uring_setup</code> 是设置 <code>io_uring_params-&gt;flags</code> 的 <code>IORING_SETUP_SQPOLL</code> flags，内核就会创建一个轮询请求队列的线程<br>可以通过 <code>ps</code> 命令查看用来轮询的内核线程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps --ppid 2 | grep io_uring-sq</span><br></pre></td></tr></table></figure>

<p>需要注意在 5.10 之前的版本，需要使用特权用户来执行，而 5.10 以后只需 <code>CAP_SYS_NICE</code> 权限即可<br>并且 5.10 之前，SQPoll 需要配合注册的文件描述符一起使用，而 5.10 以后则不需要，可以通过查看内核填充的 <code>io_uring_params-&gt;features</code> 是否设置了 <code>IORING_FEAT_SQPOLL_NONFIXED</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; iouring-go&#x2F;iouring.go</span><br><span class="line">func (iour *IOURing) doRequest(sqe *iouring_syscall.SubmissionQueueEntry, request PrepRequest, ch chan&lt;- Result) (*UserData, error) &#123;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    if sqe.Fd() &gt;&#x3D; 0 &#123;</span><br><span class="line">        if index, ok :&#x3D; iour.fileRegister.GetFileIndex(int32(sqe.Fd())); ok &#123;</span><br><span class="line">            sqe.SetFdIndex(int32(index))</span><br><span class="line">        &#125; else if iour.Flags&amp;iouring_syscall.IORING_SETUP_SQPOLL !&#x3D; 0 &amp;&amp;</span><br><span class="line">            iour.Features&amp;iouring_syscall.IORING_FEAT_SQPOLL_NONFIXED &#x3D;&#x3D; 0 &#123;</span><br><span class="line">            return nil, ErrUnregisteredFile</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>iouring-go 同样提供了开启 SQPoll 的 <a target="_blank" rel="noopener" href="https://godoc.org/github.com/Iceber/iouring-go#WithSQPoll"><code>WithSQPoll</code></a> 以及设置与 SQPoll 内核线程的相关配置 <a target="_blank" rel="noopener" href="https://godoc.org/github.com/Iceber/iouring-go#WithSQPollThreadCPU"><code>WithSQPollThreadCpu</code></a> 和 <a target="_blank" rel="noopener" href="https://godoc.org/github.com/Iceber/iouring-go#WithSQPollThreadIdle"><code>WithSQPollThreadIdle</code></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iour, err :&#x3D; iouring.New(8, iouring.WithSQPoll())</span><br></pre></td></tr></table></figure>

<p>但是在 Go 简单的设置 <code>io_uring_params</code> 并不能正常的工作，可能是由于 Go 的 GMP 模型导致的一些问题。暂时还在思考解决方案</p>
<h3 id="注册-eventfd，利用-epoll"><a href="#注册-eventfd，利用-epoll" class="headerlink" title="注册 eventfd，利用 epoll"></a>注册 eventfd，利用 epoll</h3><p>通过 <code>io_uring_register</code> 可以将 <code>eventfd</code> 注册到 io_uring 实例中，然后将 <code>eventfd</code> 加入到 <code>epoll</code> 中，如果当 io_uring 中有完成事件时，便会通知 <code>eventfd</code><br>在 <a target="_blank" rel="noopener" href="https://github.com/iceber/iouring-go">iouring-go</a> 中，对于完成事件的监听便是使用了 <code>eventfd</code> 和 <code>epoll</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">type IOURing struct &#123;</span><br><span class="line">    eventfd int</span><br><span class="line">    cqeSign chan struct&#123;&#125;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br><span class="line">func New() (*IOURing, error) &#123;</span><br><span class="line">    &#x2F;&#x2F; ....</span><br><span class="line">    if err :&#x3D; iour.registerEventfd(); err !&#x3D; nil &#123;</span><br><span class="line">        return nil, err</span><br><span class="line">    &#125;</span><br><span class="line">    if err :&#x3D; registerIOURing(iour); err !&#x3D; nil &#123;</span><br><span class="line">        return nil, err</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br><span class="line">func (iour *IOURing) registerEventfd() error &#123;</span><br><span class="line">    eventfd, err :&#x3D; unix.Eventfd(0, unix.EFD_NONBLOCK|unix.FD_CLOEXEC)</span><br><span class="line">    if err !&#x3D; nil &#123;</span><br><span class="line">         return os.NewSyscallError(&quot;eventfd&quot;, err)</span><br><span class="line">    &#125;</span><br><span class="line">    iour.eventfd &#x3D; eventfd</span><br><span class="line">    return iouring_syscall.IOURingRegister(</span><br><span class="line">        iour.fd,</span><br><span class="line">        iouring_syscall.IOURING_REGISTER_EVENTFD,</span><br><span class="line">        unsafe.Pointer(&amp;iour.eventfd), 1,</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line">func registerIOURing(iour *IOURing) error &#123;</span><br><span class="line">    if err :&#x3D; initpoller(); err !&#x3D; nil &#123;</span><br><span class="line">        return err</span><br><span class="line">    &#125;</span><br><span class="line">    if err :&#x3D; unix.EpollCtl(poller.fd, unix.EPOLL_CTL_ADD, iour.eventfd,</span><br><span class="line">         &amp;unix.EpollEvent&#123;Fd: int32(iour.eventfd), Events: unix.EPOLLIN | unix.EPOLLET&#125;,</span><br><span class="line">    ); err !&#x3D; nil &#123;</span><br><span class="line">         return os.NewSyscallError(&quot;epoll_ctl_add&quot;, err)</span><br><span class="line">    &#125;</span><br><span class="line">    poller.Lock()</span><br><span class="line">    poller.iours[iour.eventfd] &#x3D; iour</span><br><span class="line">    poller.Unlock()</span><br><span class="line">    return nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>poller</code> 会调用 EpollWait 等待<code>完成队列</code>中有完成事件，并通知相应的 IOURing 对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; iouring-go&#x2F;iouring.go</span><br><span class="line">func (iour *IOURing) getCQEvent(wait bool) (cqe *iouring_syscall.CompletionQueueEvent, err error) &#123;</span><br><span class="line">    var tryPeeks int</span><br><span class="line">    for &#123;</span><br><span class="line">        if cqe &#x3D; iour.cq.peek(); cqe !&#x3D; nil &#123;</span><br><span class="line">            iour.cq.advance(1)</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line">        if !wait &amp;&amp; !iour.sq.cqOverflow() &#123;</span><br><span class="line">            err &#x3D; syscall.EAGAIN</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line">        if iour.sq.cqOverflow() &#123;</span><br><span class="line">            _, err &#x3D; iouring_syscall.IOURingEnter(iour.fd, 0, 0, iouring_syscall.IORING_ENTER_FLAGS_GETEVENTS, nil)</span><br><span class="line">            if err !&#x3D; nil &#123;</span><br><span class="line">                return</span><br><span class="line">            &#125;</span><br><span class="line">            continue</span><br><span class="line">        &#125;</span><br><span class="line">        if tryPeeks++; tryPeeks &lt; 3 &#123;</span><br><span class="line">            runtime.Gosched()</span><br><span class="line">            continue</span><br><span class="line">        &#125;</span><br><span class="line">        select &#123;</span><br><span class="line">        case &lt;-iour.cqeSign:</span><br><span class="line">        case &lt;-iour.closer:</span><br><span class="line">            return nil, ErrIOURingClosed</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; iouring-go&#x2F;poller.go</span><br><span class="line">func (poller *iourPoller) run() &#123;</span><br><span class="line">    for &#123;</span><br><span class="line">        n, err :&#x3D; unix.EpollWait(poller.fd, poller.events, -1)</span><br><span class="line">        if err !&#x3D; nil &#123;</span><br><span class="line">            continue</span><br><span class="line">        &#125;</span><br><span class="line">        for i :&#x3D; 0; i &lt; n; i++ &#123;</span><br><span class="line">            fd :&#x3D; int(poller.events[i].Fd)</span><br><span class="line">            poller.Lock()</span><br><span class="line">            iour, ok :&#x3D; poller.iours[fd]</span><br><span class="line">            poller.Unlock()</span><br><span class="line">            if !ok &#123;</span><br><span class="line">                continue</span><br><span class="line">            &#125;</span><br><span class="line">            select &#123;</span><br><span class="line">            case iour.cqeSign &lt;- struct&#123;&#125;&#123;&#125;:</span><br><span class="line">            default:</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        poller.adjust()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="保证数据不丢失"><a href="#保证数据不丢失" class="headerlink" title="保证数据不丢失"></a>保证数据不丢失</h3><p>默认情况下， CQ 环的大小是 SQ 环的 两倍，为什么 SQ 环的大小会小于 CQ 环，是因为 SQ 环中的 sqe 一旦被内核发现，便会被内核消耗掉，也就意味着 sqe 的生命周期很短，而请求的完成事件都会放到 CQ 环中<br>我们也可以通过 <code>IORING_SETUP_CQSIZE</code> 或者 <code>iouring-go</code> 的 <code>WithCQSize</code> Option 里设置 CQ 环的大小<br>但是依然会存在 CQ 环溢出的情况，而内核会在内部存储溢出的时间，直到 CQ 环有空间容纳更多事件。</p>
<blockquote>
<p>可以通过 io_uring_params-&gt;features 是否设置 IORING_FEAT_NODROP 来判断当前内核是否支持该功能</p>
</blockquote>
<p>如果 CQ 环溢出，那么提交请求时可能会以 <code>-EBUSY</code> 错误失败，需要重新提交<br>并且当 CQ 环中数据被消耗后，需要调用 <code>io_uring_enter</code> 来通知内核 CQ 环中有空余空间</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">func (iour *IOURing) getCQEvent(wait bool) (cqe *iouring_syscall.CompletionQueueEvent, err error) &#123;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    if iour.sq.cqOverflow() &#123;</span><br><span class="line">        _, err :&#x3D; iour.syscall.IOURingEnter(iour.fd, 0, 0, iouring_syscall.IORING_ENTER_FLAGS_GETEVENTS, nil)</span><br><span class="line">        if err !&#x3D; nil&#123;</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line">        continue</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="io-uring-与-Go-——-iouring-go"><a href="#io-uring-与-Go-——-iouring-go" class="headerlink" title="io_uring 与 Go —— iouring-go"></a>io_uring 与 Go —— iouring-go</h1><h3 id="竞争问题"><a href="#竞争问题" class="headerlink" title="竞争问题"></a>竞争问题</h3><p>在实现 <a target="_blank" rel="noopener" href="https://github.com/iceber/iouring-go">iouring-go</a> 中遇到的问题，一个是并发导致对 <code>io_uring</code> 的竞争问题<br><strong>对于 CQ 环的竞争是使用单一的 CQ 环消费 goroutine <code>IOURing.run()</code> 来完成 <code>cqe</code> 的消费</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">func New(entries int, opts ...IOURingOption) (iour *IOURing, err error) &#123;</span><br><span class="line">    iour :&#x3D; &amp;IOURing&#123;...&#125;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    go iour.run()</span><br><span class="line">    return</span><br><span class="line">&#125;</span><br><span class="line">func (iour *IOURing) run() &#123;</span><br><span class="line">    for &#123;</span><br><span class="line">        cqe, err :&#x3D; iour.getCQEvent(true)</span><br><span class="line">        &#x2F;&#x2F; ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SQ 环的解决方案有两种</p>
<ol>
<li><strong>使用单独的提交 goroutine，将需要提交的请求通过内部 channel 发送给提交 goroutine，这样保证了 SQ 环的单一生产者</strong></li>
<li><strong>使用锁的方式，对于提交请求的函数加锁，保证同一时间只有一个 goroutine 在提交请求</strong></li>
</ol>
<p>第一种方式听起来使用 channel 更优雅一些，但是 channel 内部依然使用锁的方式以及额外的内存复制<br>另外最大的弊端就是将 <a target="_blank" rel="noopener" href="https://godoc.org/github.com/Iceber/iouring-go#IOURing"><code>IOURIng</code></a> 的<code>提交函数</code>（_将请求发送给提交 channel_）和真正将请求提交给内核（_调用 <code>io_uring_enter</code>通知内核有新的请求_）分开<br>当多个<code>提交函数</code> 向 channel 发送的请求的顺序无法保证，这样链式请求就无法实现（除非对于链式请求再次加锁）<br>第二种方式，采用加锁的方式，保证了同一时间只有一个提交函数在处理 SQ 环，并且可以立即是否真正提交成功（_调用 <code>IOURing.submit</code> 方法通知内核有新的请求_）<br><a target="_blank" rel="noopener" href="https://github.com/iceber/iouring-go">iouring-go</a> 采用了第二种方式<br>真正去解决这个问题的方式，估计可能只有 runtime 才能给出答案，为每一个 P 创建一个 io_uring 实例在 runtime 内部解决竞争问题，内部使用 eventfd 注册到 <code>netpoll</code> 中来获取<code>完成队列</code>通知</p>
<h3 id="io-uring-与-channel"><a href="#io-uring-与-channel" class="headerlink" title="io_uring 与 channel"></a>io_uring 与 channel</h3><p>对于 <a target="_blank" rel="noopener" href="https://github.com/iceber/iouring-go">iouring-go</a> 设计比较好的地方，我感觉便是对 channel 的利用，异步 IO 加上 channel，可以将异步在并发的程序中发挥出最大的作用<br><em>当然，如果只是简单的使用 channel 的话又会引入其他一些问题，后续会进行说明</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func (iour *IOURing) SubmitRequest(request PrepRequest, ch chan&lt;- Result) (Request, error)</span><br></pre></td></tr></table></figure>

<p><code>SubmitRequest</code> 方法接收一个 channel，当请求完成后，会将结果发送到 channel 中，这样通过多个请求复用同一个 channel，程序便可以监听一组请求的完成情况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">func (iour *IOURing) run() &#123;</span><br><span class="line">    for &#123;</span><br><span class="line">        cqe, err :&#x3D; iour.getCQEvent(true)</span><br><span class="line">        &#x2F;&#x2F; ...</span><br><span class="line">        userData :&#x3D; iour.userData[cqe.UserData]</span><br><span class="line">        &#x2F;&#x2F; ...</span><br><span class="line">        userData.request.complate(cqe)</span><br><span class="line">        if userData.resulter !&#x3D; nil &#123;</span><br><span class="line">            userData.resulter &lt;- userData.request</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而 <code>SubmitRequest</code> 方法同样会返回一个 Request 接口对象，通过 Request 我们同样可以去查看请求的是否完成已经它的完成结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">type Request interface &#123;</span><br><span class="line">	Result</span><br><span class="line">	Cancel() (Request, error)</span><br><span class="line">	Done() &lt;-chan struct&#123;&#125;</span><br><span class="line">	GetRes() (int, error)</span><br><span class="line">	&#x2F;&#x2F; Can Only be used in ResultResolver</span><br><span class="line">	SetResult(r0, r1 interface&#123;&#125;, err error) error</span><br><span class="line">&#125;</span><br><span class="line">type Result interface &#123;</span><br><span class="line">	Fd() int</span><br><span class="line">	Opcode() uint8</span><br><span class="line">	GetRequestBuffer() (b0, b1 []byte)</span><br><span class="line">	GetRequestBuffers() [][]byte</span><br><span class="line">	GetRequestInfo() interface&#123;&#125;</span><br><span class="line">	FreeRequestBuffer()</span><br><span class="line">	Err() error</span><br><span class="line">	ReturnValue0() interface&#123;&#125;</span><br><span class="line">	ReturnValue1() interface&#123;&#125;</span><br><span class="line">	ReturnFd() (int, error)</span><br><span class="line">	ReturnInt() (int, error)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>利用 channel 便可以完成对异步 IO 的异步监听和同步监听</p>
<h4 id="channel-带来的问题"><a href="#channel-带来的问题" class="headerlink" title="channel 带来的问题"></a>channel 带来的问题</h4><p>当然使用 channel 又会带来其他的问题，比如 channel 满了以后，对 io_uring 完成队列的消费便会阻塞在向 channel 发送数据，阻塞时间过长也会导致 CQ 环溢出<br>比较好的解决方案是，在 channel 上抽象出一层 <code>Resulter</code>，<code>Resulter</code> 会对完成事件进行自动缓冲，当然这也会带来一定的代码复杂度，所以 <a target="_blank" rel="noopener" href="https://github.com/iceber/iouring-go">iouring-go</a> 便将 channel 阻塞的问题交给使用者，要求 channel 的消费端尽快消费掉数据</p>
<h1 id="思考-io-uring-在-Go-中的发展"><a href="#思考-io-uring-在-Go-中的发展" class="headerlink" title="思考 io_uring 在 Go 中的发展"></a>思考 io_uring 在 Go 中的发展</h1><p><code>netpoll</code> 在 Linux 平台下使用了 <code>epoll</code>，而且 <code>epoll</code> 在使用上并没有竞争问题，当然如果要使用 <code>io_uring</code> 来替代 <code>epoll</code> 来实现 <code>netpoll</code> 的话并不是不可能，只是这样对于工作很好的 epoll 来说并没有什么必要，而且是否能够带来可观的性能收益也都是不确定的<br>在高并发的情况下，有限的 SQ 环和 CQ 环，对于请求数量大于完成事件的消费速度的情况，CQ 环的大量溢出带来对内核的压力以及新的请求提交带来的错误处理，都会提高真正利用 <code>io_uring</code> 的难度<br>对于 SQ 环和 CQ 环的大小限制，也许需要通过 Pool 的方式来解决，初始化多个 io_uring 实例，当一个实例的 SQ 环满，那么就使用另外的实例来提交请求<br>而使用 Pool 又会增加一定的复杂度<br><code>io_uring</code> 的功能实际可以覆盖了 <code>epoll</code> 的，比如提交的阻塞 IO 请求便相当于 <code>epoll</code> + <code>syscall</code>，另外 <code>io_uring</code> 还提供了超时设置和请求的超时控制，相当于实现了系统级的定时器以及 <code>netpoll</code> 的 deadline<br>但是 epoll 自身的优势，比如没有竞争问题，没有监听文件描述符的数量限制，都让 epoll 在实际的使用中更加好用，而这些问题对于 <code>io_uring</code> 在本身设计上就会导致的问题<br>比如竞争问题，使用环形缓冲区可以协调应用和内核对请求队列的访问，但是应用中多个线程或者 goroutine 就会引发对环形缓冲区的竞争问题<br>而请求数量的限制，那么就需要考虑到请求完成事件的溢出问题，内核不能无限制的去保存溢出的完成事件，当然这个问题通过应用中在 <code>io_uring</code> 实例上抽象出 <code>io_uring 池</code>的方式来解决<br>使用 <code>io_uring</code> 来实现异步网络框架，对已有的网络模型会是非常大的冲击，怎么去使用 <code>io_uring</code> 来发挥最大的能力依然处于探索阶段，毕竟 <code>io_uring</code> 是一个出现才 1 年的技术<br>而对于普通的磁盘 IO 来说，<code>io_uring</code> 还是有很大的发挥空间的，利用 Go 中已有的并发机制，结合具体的性能评估，对于文件服务器来说，也许会带来极大的提升<br><strong>另外一个问题便是，对于 5.1 引入，5.6 开始功能变得丰富成熟的 <code>io_uring</code> 来说，现在大量的环境处于 3.X，4.X，甚至 2.X ， <code>io_uring</code> 仍然需要等待时机才能去发挥它真正的作用，而这段时间便是留给我们去探讨怎么让 <code>io_uring</code> 更好用</strong></p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2021/03/15/yuque/Go%20%E4%B8%8E%E5%BC%82%E6%AD%A5%20IO%20-%20io_uring%20%E7%9A%84%E6%80%9D%E8%80%83/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-yuque/Goroutine 并发调度模型深度解析之手撸一个高性能 goroutine 池" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/14/yuque/Goroutine%20%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%A8%A1%E5%9E%8B%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%E4%B9%8B%E6%89%8B%E6%92%B8%E4%B8%80%E4%B8%AA%E9%AB%98%E6%80%A7%E8%83%BD%20goroutine%20%E6%B1%A0/">Goroutine 并发调度模型深度解析之手撸一个高性能 goroutine 池</a>
    </h1>
  

        
        <a href="/2021/03/14/yuque/Goroutine%20%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%A8%A1%E5%9E%8B%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%E4%B9%8B%E6%89%8B%E6%92%B8%E4%B8%80%E4%B8%AA%E9%AB%98%E6%80%A7%E8%83%BD%20goroutine%20%E6%B1%A0/" class="archive-article-date">
  	<time datetime="2021-03-14T12:26:38.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2021-03-14</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>并发（并行），一直以来都是一个编程语言里的核心主题之一，也是被开发者关注最多的话题；Go 语言作为一个出道以来就自带 『高并发』光环的富二代编程语言，它的并发（并行）编程肯定是值得开发者去探究的，而 Go 语言中的并发（并行）编程是经由 goroutine 实现的，goroutine 是 golang 最重要的特性之一，具有使用成本低、消耗资源低、能效高等特点，官方宣称原生 goroutine 并发成千上万不成问题，于是它也成为 Gopher 们经常使用的特性。</p>
<blockquote>
<p>Goroutine 是优秀的，但不是完美的，在极大规模的高并发场景下，也可能会暴露出问题，什么问题呢？又有什么可选的解决方案？本文将通过 runtime 对 goroutine 的调度分析，帮助大家理解它的机理和发现一些内存和调度的原理和问题，并且基于此提出一种个人的解决方案 — 一个高性能的 Goroutine Pool（协程池）。</p>
</blockquote>
<h1 id="Goroutine-amp-Scheduler"><a href="#Goroutine-amp-Scheduler" class="headerlink" title="Goroutine &amp; Scheduler"></a>Goroutine &amp; Scheduler</h1><p><strong>Goroutine</strong>，Go 语言基于并发（并行）编程给出的自家的解决方案。goroutine 是什么？通常 goroutine 会被当做 coroutine（协程）的 golang 实现，从比较粗浅的层面来看，这种认知也算是合理，但实际上，goroutine 并非传统意义上的协程，现在主流的线程模型分三种：内核级线程模型、用户级线程模型和两级线程模型（也称混合型线程模型），传统的协程库属于<strong>用户级线程模型</strong>，而 goroutine 和它的 <code>Go Scheduler</code> 在底层实现上其实是属于<strong>两级线程模型</strong>，因此，有时候为了方便理解可以简单把 goroutine 类比成协程，但心里一定要有个清晰的认知 — goroutine 并不等同于协程。</p>
<h2 id="线程那些事儿"><a href="#线程那些事儿" class="headerlink" title="线程那些事儿"></a>线程那些事儿</h2><p>互联网时代以降，由于在线用户数量的爆炸，单台服务器处理的连接也水涨船高，迫使编程模式由从前的串行模式升级到并发模型，而几十年来，并发模型也是一代代地升级，有 IO 多路复用、多进程以及多线程，这几种模型都各有长短，现代复杂的高并发架构大多是几种模型协同使用，不同场景应用不同模型，扬长避短，发挥服务器的最大性能，而多线程，因为其轻量和易用，成为并发编程中使用频率最高的并发模型，而后衍生的协程等其他子产品，也都基于它，而我们今天要分析的 goroutine 也是基于线程，因此，我们先来聊聊线程的三大模型：<br>线程的实现模型主要有 3 种：内核级线程模型、用户级线程模型和两级线程模型（也称混合型线程模型），它们之间最大的差异就在于用户线程与内核调度实体（KSE，Kernel Scheduling Entity）之间的对应关系上。而所谓的内核调度实体 KSE 就是指可以被操作系统内核调度器调度的对象实体（这说的啥玩意儿，敢不敢通俗易懂一点？）。简单来说 KSE 就是<strong>内核级线程</strong>，是操作系统内核的最小调度单元，也就是我们写代码的时候通俗理解上的线程了（这么说不就懂了嘛！装什么 13）。</p>
<h3 id="用户级线程模型"><a href="#用户级线程模型" class="headerlink" title="用户级线程模型"></a>用户级线程模型</h3><p>用户线程与内核线程 KSE 是多对一（N : 1）的映射模型，多个用户线程的一般从属于单个进程并且多线程的调度是由用户自己的线程库来完成，线程的创建、销毁以及多线程之间的协调等操作都是由用户自己的线程库来负责而无须借助系统调用来实现。一个进程中所有创建的线程都只和同一个 KSE 在运行时动态绑定，也就是说，操作系统只知道用户进程而对其中的线程是无感知的，内核的所有调度都是基于用户进程。许多语言实现的 <strong>协程库</strong> 基本上都属于这种方式（比如 python 的 gevent）。由于线程调度是在用户层面完成的，也就是相较于内核调度不需要让 CPU 在用户态和内核态之间切换，这种实现方式相比内核级线程可以做的很轻量级，对系统资源的消耗会小很多，因此可以创建的线程数量与上下文切换所花费的代价也会小得多。但该模型有个原罪：并不能做到真正意义上的并发，假设在某个用户进程上的某个用户线程因为一个阻塞调用（比如 I/O 阻塞）而被 CPU 给中断（抢占式调度）了，那么该进程内的所有线程都被阻塞（因为单个用户进程内的线程自调度是没有 CPU 时钟中断的，从而没有轮转调度），整个进程被挂起。即便是多 CPU 的机器，也无济于事，因为在用户级线程模型下，一个 CPU 关联运行的是整个用户进程，进程内的子线程绑定到 CPU 执行是由用户进程调度的，内部线程对 CPU 是不可见的，此时可以理解为 CPU 的调度单位是用户进程。所以很多的<strong>协程库</strong>会把自己一些阻塞的操作重新封装为完全的非阻塞形式，然后在以前要阻塞的点上，主动让出自己，并通过某种方式通知或唤醒其他待执行的用户线程在该 KSE 上运行，从而避免了内核调度器由于 KSE 阻塞而做上下文切换，这样整个进程也不会被阻塞了。</p>
<h3 id="内核级线程模型"><a href="#内核级线程模型" class="headerlink" title="内核级线程模型"></a>内核级线程模型</h3><p>用户线程与内核线程 KSE 是一对一（1 : 1）的映射模型，也就是每一个用户线程绑定一个实际的内核线程，而线程的调度则完全交付给操作系统内核去做，应用程序对线程的创建、终止以及同步都基于内核提供的系统调用来完成，大部分编程语言的线程库(比如 Java 的 java.lang.Thread、C++11 的 std::thread 等等)都是对操作系统的线程（内核级线程）的一层封装，创建出来的每个线程与一个独立的 KSE 静态绑定，因此其调度完全由操作系统内核调度器去做，也就是说，一个进程里创建出来的多个线程每一个都绑定一个 KSE。这种模型的优势和劣势同样明显：优势是实现简单，直接借助操作系统内核的线程以及调度器，所以 CPU 可以快速切换调度线程，于是多个线程可以同时运行，因此相较于用户级线程模型它真正做到了并行处理；但它的劣势是，由于直接借助了操作系统内核来创建、销毁和以及多个线程之间的上下文切换和调度，因此资源成本大幅上涨，且对性能影响很大。</p>
<h3 id="两级线程模型"><a href="#两级线程模型" class="headerlink" title="两级线程模型"></a>两级线程模型</h3><p>两级线程模型是博采众长之后的产物，充分吸收前两种线程模型的优点且尽量规避它们的缺点。在此模型下，用户线程与内核 KSE 是多对多（N : M）的映射模型：首先，区别于用户级线程模型，两级线程模型中的一个进程可以与多个内核线程 KSE 关联，也就是说一个进程内的多个线程可以分别绑定一个自己的 KSE，这点和内核级线程模型相似；其次，又区别于内核级线程模型，它的进程里的线程并不与 KSE 唯一绑定，而是可以多个用户线程映射到同一个 KSE，当某个 KSE 因为其绑定的线程的阻塞操作被内核调度出 CPU 时，其关联的进程中其余用户线程可以重新与其他 KSE 绑定运行。所以，两级线程模型既不是用户级线程模型那种完全靠自己调度的也不是内核级线程模型完全靠操作系统调度的，而是中间态（自身调度与系统调度协同工作），也就是 — 『薛定谔的模型』（误），因为这种模型的高度复杂性，操作系统内核开发者一般不会使用，所以更多时候是作为第三方库的形式出现，而 Go 语言中的 runtime 调度器就是采用的这种实现方案，实现了 Goroutine 与 KSE 之间的动态关联，不过 Go 语言的实现更加高级和优雅；该模型为何被称为两级？<strong>即用户调度器实现用户线程到 KSE 的『调度』，内核调度器实现 KSE 到 CPU 上的『调度』</strong>。</p>
<h2 id="G-P-M-模型概述"><a href="#G-P-M-模型概述" class="headerlink" title="G-P-M 模型概述"></a>G-P-M 模型概述</h2><p>每一个 OS 线程都有一个固定大小的内存块(一般会是 2MB)来做栈，这个栈会用来存储当前正在被调用或挂起(指在调用其它函数时)的函数的内部变量。这个固定大小的栈同时很大又很小。因为 2MB 的栈对于一个小小的 goroutine 来说是很大的内存浪费，而对于一些复杂的任务（如深度嵌套的递归）来说又显得太小。因此，Go 语言做了它自己的『线程』。<br>在 Go 语言中，每一个 goroutine 是一个独立的执行单元，相较于每个 OS 线程固定分配 2M 内存的模式，goroutine 的栈采取了动态扩容方式， 初始时仅为 2KB，随着任务执行按需增长，最大可达 1GB（64 位机器最大是 1G，32 位机器最大是 256M），且完全由 golang 自己的调度器 <strong>Go Scheduler</strong> 来调度。此外，GC 还会周期性地将不再使用的内存回收，收缩栈空间。 因此，Go 程序可以同时并发成千上万个 goroutine 是得益于它强劲的调度器和高效的内存模型。Go 的创造者大概对 goroutine 的定位就是屠龙刀，因为他们不仅让 goroutine 作为 golang 并发编程的最核心组件（开发者的程序都是基于 goroutine 运行的）而且 golang 中的许多标准库的实现也到处能见到 goroutine 的身影，比如 net/http 这个包，甚至语言本身的组件 runtime 运行时和 GC 垃圾回收器都是运行在 goroutine 上的，作者对 goroutine 的厚望可见一斑。<br>任何用户线程最终肯定都是要交由 OS 线程来执行的，goroutine（称为 G）也不例外，但是 G 并不直接绑定 OS 线程运行，而是由 Goroutine Scheduler 中的 P - <em>Logical Processor</em> （逻辑处理器）来作为两者的『中介』，P 可以看作是一个抽象的资源或者一个上下文，一个 P 绑定一个 OS 线程，在 golang 的实现里把 OS 线程抽象成一个数据结构：M，G 实际上是由 M 通过 P 来进行调度运行的，但是在 G 的层面来看，P 提供了 G 运行所需的一切资源和环境，因此在 G 看来 P 就是运行它的 “CPU”，由 G、P、M 这三种由 Go 抽象出来的实现，最终形成了 Go 调度器的基本结构：</p>
<ul>
<li>G: 表示 Goroutine，每个 Goroutine 对应一个 G 结构体，G 存储 Goroutine 的运行堆栈、状态以及任务函数，可重用。G 并非执行体，每个 G 需要绑定到 P 才能被调度执行。</li>
<li>P: Processor，表示逻辑处理器， 对 G 来说，P 相当于 CPU 核，G 只有绑定到 P(在 P 的 local runq 中)才能被调度。对 M 来说，P 提供了相关的执行环境(Context)，如内存分配状态(mcache)，任务队列(G)等，P 的数量决定了系统内最大可并行的 G 的数量（前提：物理 CPU 核数 &gt;= P 的数量），P 的数量由用户设置的 GOMAXPROCS 决定，但是不论 GOMAXPROCS 设置为多大，P 的数量最大为 256。</li>
<li>M: Machine，OS 线程抽象，代表着真正执行计算的资源，在绑定有效的 P 后，进入 schedule 循环；而 schedule 循环的机制大致是从 Global 队列、P 的 Local 队列以及 wait 队列中获取 G，切换到 G 的执行栈上并执行 G 的函数，调用 goexit 做清理工作并回到 M，如此反复。M 并不保留 G 状态，这是 G 可以跨 M 调度的基础，M 的数量是不定的，由 Go Runtime 调整，为了防止创建过多 OS 线程导致系统调度不过来，目前默认最大限制为 10000 个。</li>
</ul>
<p>关于 P，我们需要再絮叨几句，在 Go 1.0 发布的时候，它的调度器其实 G-M 模型，也就是没有 P 的，调度过程全由 G 和 M 完成，这个模型暴露出一些问题：</p>
<ul>
<li>单一全局互斥锁(Sched.Lock)和集中状态存储的存在导致所有 goroutine 相关操作，比如：创建、重新调度等都要上锁；</li>
<li>goroutine 传递问题：M 经常在 M 之间传递『可运行』的 goroutine，这导致调度延迟增大以及额外的性能损耗；</li>
<li>每个 M 做内存缓存，导致内存占用过高，数据局部性较差；</li>
<li>由于 syscall 调用而形成的剧烈的 worker thread 阻塞和解除阻塞，导致额外的性能损耗。</li>
</ul>
<p>这些问题实在太扎眼了，导致 Go1.0 虽然号称原生支持并发，却在并发性能上一直饱受诟病，然后，Go 语言委员会中一个核心开发大佬看不下了，亲自下场重新设计和实现了 Go 调度器（在原有的 G-M 模型中引入了 P）并且实现了一个叫做 <a target="_blank" rel="noopener" href="https://supertech.csail.mit.edu/papers/steal.pdf"><em>work-stealing</em></a> 的调度算法：</p>
<ul>
<li>每个 P 维护一个 G 的本地队列；</li>
<li>当一个 G 被创建出来，或者变为可执行状态时，就把他放到 P 的可执行队列中；</li>
<li>当一个 G 在 M 里执行结束后，P 会从队列中把该 G 取出；如果此时 P 的队列为空，即没有其他 G 可以执行， M 就随机选择另外一个 P，从其可执行的 G 队列中取走一半。</li>
</ul>
<p>该算法避免了在 goroutine 调度时使用全局锁。<br><em><strong>至此，Go 调度器的基本模型确立：</strong></em><br><img src="https://cdn.nlark.com/yuque/0/2021/png/190217/1615724818570-42edf3ee-6769-4abf-b5d9-66bb7af1fb04.png#align=left&display=inline&height=409&margin=%5Bobject%20Object%5D&originHeight=409&originWidth=506&size=0&status=done&style=none&width=506"></p>
<h2 id="G-P-M-模型调度"><a href="#G-P-M-模型调度" class="headerlink" title="G-P-M 模型调度"></a>G-P-M 模型调度</h2><p>Go 调度器工作时会维护两种用来保存 G 的任务队列：一种是一个 Global 任务队列，一种是每个 P 维护的 Local 任务队列。<br>当通过 <code>go</code> 关键字创建一个新的 goroutine 的时候，它会优先被放入 P 的本地队列。为了运行 goroutine，M 需要持有（绑定）一个 P，接着 M 会启动一个 OS 线程，循环从 P 的本地队列里取出一个 goroutine 并执行。当然还有上文提及的 <code>work-stealing</code> 调度算法：当 M 执行完了当前 P 的 Local 队列里的所有 G 后，P 也不会就这么在那躺尸啥都不干，它会先尝试从 Global 队列寻找 G 来执行，如果 Global 队列为空，它会随机挑选另外一个 P，从它的队列里中拿走一半的 G 到自己的队列中执行。<br><strong>如果一切正常，调度器会以上述的那种方式顺畅地运行，但这个世界没这么美好，总有意外发生，以下分析 goroutine 在两种例外情况下的行为。</strong><br>Go runtime 会在下面的 goroutine 被阻塞的情况下运行另外一个 goroutine：</p>
<ul>
<li>blocking syscall (for example opening a file)</li>
<li>network input</li>
<li>channel operations</li>
<li>primitives in the sync package</li>
</ul>
<p>这四种场景又可归类为两种类型：</p>
<h3 id="用户态阻塞-唤醒"><a href="#用户态阻塞-唤醒" class="headerlink" title="用户态阻塞/唤醒"></a>用户态阻塞/唤醒</h3><p>当 goroutine 因为 channel 操作或者 network I/O 而阻塞时（实际上 golang 已经用 netpoller 实现了 goroutine 网络 I/O 阻塞不会导致 M 被阻塞，仅阻塞 G，这里仅仅是举个栗子），对应的 G 会被放置到某个 wait 队列(如 channel 的 waitq)，该 G 的状态由 <code>_Gruning</code> 变为 <code>_Gwaitting</code> ，而 M 会跳过该 G 尝试获取并执行下一个 G，如果此时没有 runnable 的 G 供 M 运行，那么 M 将解绑 P，并进入 sleep 状态；当阻塞的 G 被另一端的 G2 唤醒时（比如 channel 的可读/写通知），G 被标记为 runnable，尝试加入 G2 所在 P 的 runnext，然后再是 P 的 Local 队列和 Global 队列。</p>
<h3 id="系统调用阻塞"><a href="#系统调用阻塞" class="headerlink" title="系统调用阻塞"></a>系统调用阻塞</h3><p>当 G 被阻塞在某个系统调用上时，此时 G 会阻塞在 <code>_Gsyscall</code> 状态，M 也处于 block on syscall 状态，此时的 M 可被抢占调度：执行该 G 的 M 会与 P 解绑，而 P 则尝试与其它 idle 的 M 绑定，继续执行其它 G。如果没有其它 idle 的 M，但 P 的 Local 队列中仍然有 G 需要执行，则创建一个新的 M；当系统调用完成后，G 会重新尝试获取一个 idle 的 P 进入它的 Local 队列恢复执行，如果没有 idle 的 P，G 会被标记为 runnable 加入到 Global 队列。<br><strong>以上就是从宏观的角度对 Goroutine 和它的调度器进行的一些概要性的介绍，当然，Go 的调度中更复杂的抢占式调度、阻塞调度的更多细节，大家可以自行去找相关资料深入理解，本文只讲到 Go 调度器的基本调度过程，为后面自己实现一个 Goroutine Pool 提供理论基础，这里便不再继续深入上述说的那几个调度了，事实上如果要完全讲清楚 Go 调度器，一篇文章的篇幅也实在是捉襟见肘，所以想了解更多细节的同学可以去看看 Go 调度器 G-P-M 模型的设计者 Dmitry Vyukov 写的该模型的设计文档《<a target="_blank" rel="noopener" href="https://docs.google.com/document/d/1ETuA2IOmnaQ4j81AtTGT40Y4_Jr6_IDASEKg0t0dBR8/edit#!">Go Preemptive Scheduler Design</a>》以及直接去看源码，G-P-M 模型的定义放在 <code>src/runtime/runtime2.go</code> 里面，而调度过程则放在了 <code>src/runtime/proc.go</code> 里。</strong></p>
<h1 id="大规模-Goroutine-的瓶颈"><a href="#大规模-Goroutine-的瓶颈" class="headerlink" title="大规模 Goroutine 的瓶颈"></a>大规模 Goroutine 的瓶颈</h1><p>既然 Go 调度器已经这么<del>牛逼</del>优秀了，我们为什么还要自己去实现一个 golang 的 Goroutine Pool 呢？事实上，优秀不代表完美，任何不考虑具体应用场景的编程模式都是耍流氓！有基于 G-P-M 的 Go 调度器背书，go 程序的并发编程中，可以任性地起大规模的 goroutine 来执行任务，官方也宣称用 golang 写并发程序的时候随便起个成千上万的 goroutine 毫无压力。<br>然而，你起 1000 个 goroutine 没有问题，10000 也没有问题，10w 个可能也没问题；那，100w 个呢？1000w 个呢？（这里只是举个极端的例子，实际编程起这么大规模的 goroutine 的例子极少）这里就会出问题，什么问题呢？</p>
<ol>
<li>首先，即便每个 goroutine 只分配 2KB 的内存，但如果是恐怖如斯的数量，聚少成多，内存暴涨，就会对 GC 造成极大的负担，写过 Java 的同学应该知道 jvm GC 那万恶的 STW（Stop The World）机制，也就是 GC 的时候会挂起用户程序直到垃圾回收完，虽然 Go1.8 之后的 GC 已经去掉了 STW 以及优化成了并行 GC，性能上有了不小的提升，但是，如果太过于频繁地进行 GC，依然会有性能瓶颈；</li>
<li>其次，还记得前面我们说的 runtime 和 GC 也都是 goroutine 吗？是的，如果 goroutine 规模太大，内存吃紧，runtime 调度和垃圾回收同样会出问题，虽然 G-P-M 模型足够优秀，韩信点兵，多多益善，但你不能不给士兵发口粮（内存）吧？巧妇难为无米之炊，没有内存，Go 调度器就会阻塞 goroutine，结果就是 P 的 Local 队列积压，又导致内存溢出，这就是个死循环…，甚至极有可能程序直接 Crash 掉，本来是想享受 golang 并发带来的<del>快感</del>效益，结果却得不偿失。</li>
</ol>
<h2 id="一个-http-标准库引发的血案"><a href="#一个-http-标准库引发的血案" class="headerlink" title="一个 http 标准库引发的血案"></a>一个 http 标准库引发的血案</h2><p>我想，作为 golang 拥趸的 Gopher 们一定都使用过它的 net/http 标准库，很多人都说用 golang 写 Web server 完全可以不用借助第三方的 Web framework，仅用 net/http 标准库就能写一个高性能的 Web server，的确，我也用过它写过 Web server，简洁高效，性能表现也相当不错，除非有比较特殊的需求否则一般的确不用借助第三方 Web framework，但是天下没有白吃的午餐，net/http 为啥这么快？要搞清这个问题，从源码入手是最好的途径。孔子曾经曰过：源码面前，如同裸奔。所以，<del>高清</del>无码是阻碍程序猿发展大大滴绊脚石啊，源码才是我们进步阶梯，切记切记！<br>接下来我们就来先看看 net/http 内部是怎么实现的。<br>net/http 接收请求且开始处理的源码放在 <code>src/net/http/server.go</code> 里，先从入口函数 <code>ListenAndServe</code> 进去：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1func (srv *Server) ListenAndServe() error &#123;</span><br><span class="line"> 2	addr :&#x3D; srv.Addr</span><br><span class="line"> 3	if addr &#x3D;&#x3D; &quot;&quot; &#123;</span><br><span class="line"> 4		addr &#x3D; &quot;:http&quot;</span><br><span class="line"> 5	&#125;</span><br><span class="line"> 6	ln, err :&#x3D; net.Listen(&quot;tcp&quot;, addr)</span><br><span class="line"> 7	if err !&#x3D; nil &#123;</span><br><span class="line"> 8		return err</span><br><span class="line"> 9	&#125;</span><br><span class="line">10	return srv.Serve(tcpKeepAliveListener&#123;ln.(*net.TCPListener)&#125;)</span><br><span class="line">11&#125;</span><br></pre></td></tr></table></figure>

<p>看到最后那个 srv.Serve 调用了吗？没错，这个 <code>Serve</code> 方法里面就是实际处理 http 请求的逻辑，我们再进入这个方法内部：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1func (srv *Server) Serve(l net.Listener) error &#123;</span><br><span class="line"> 2	defer l.Close()</span><br><span class="line"> 3	...</span><br><span class="line"> 4    &#x2F;&#x2F; 不断循环取出TCP连接</span><br><span class="line"> 5	for &#123;</span><br><span class="line"> 6        &#x2F;&#x2F; 看我看我！！！</span><br><span class="line"> 7		rw, e :&#x3D; l.Accept()</span><br><span class="line"> 8        ...</span><br><span class="line"> 9        &#x2F;&#x2F; 再看我再看我！！！</span><br><span class="line">10		go c.serve(ctx)</span><br><span class="line">11	&#125;</span><br><span class="line">12&#125;</span><br></pre></td></tr></table></figure>

<p><strong>首先，这个方法的参数<code>(l net.Listener)</code> ，是一个 TCP 监听的封装，负责监听网络端口， <code>rw, e := l.Accept()</code> 则是一个阻塞操作，从网络端口取出一个新的 TCP 连接进行处理，最后 <code>go c.serve(ctx)</code> 就是最后真正去处理这个 http 请求的逻辑了，看到前面的 go 关键字了吗？没错，这里启动了一个新的 goroutine 去执行处理逻辑，而且这是在一个无限循环体里面，所以意味着，每来一个请求它就会开一个 goroutine 去处理，相当任性粗暴啊…，不过有 Go 调度器背书，一般来说也没啥压力，然而，如果，我是说如果哈，突然一大波请求涌进来了（比方说黑客搞了成千上万的肉鸡 DDOS 你，没错！就这么倒霉！），这时候，就很成问题了，他来 10w 个请求你就要开给他 10w 个 goroutine，来 100w 个你就要老老实实开给他 100w 个，线程调度压力陡升，内存爆满，再然后，你就跪了…</strong></p>
<h2 id="釜底抽薪"><a href="#釜底抽薪" class="headerlink" title="釜底抽薪"></a>釜底抽薪</h2><p>有问题，就一定有解决的办法，那么，有什么方案可以减缓大规模 goroutine 对系统的调度和内存压力？要想解决问题，最重要的是找到造成问题的根源，这个问题根源是什么？goroutine 的数量过多导致资源侵占，那要解决这个问题就要限制运行的 goroutine 数量，合理复用，节省资源，具体就是 — goroutine 池化。<br>超大规模并发的场景下，不加限制的大规模的 goroutine 可能造成内存暴涨，给机器带来极大的压力，吞吐量下降和处理速度变慢还是其次，更危险的是可能使得程序 crash。所以，goroutine 池化是有其现实意义的。<br>首先，100w 个任务，是不是真的需要 100w 个 goroutine 来处理？未必！用 1w 个 goroutine 也一样可以处理，让一个 goroutine 多处理几个任务就是了嘛，池化的核心优势就在于对 goroutine 的复用。此举首先极大减轻了 runtime 调度 goroutine 的压力，其次，便是降低了对内存的消耗。<br><img src="https://cdn.nlark.com/yuque/0/2021/jpeg/190217/1615724818520-6432e7ff-f730-4e8c-8e74-343e8bd2af64.jpeg#align=left&display=inline&height=200&margin=%5Bobject%20Object%5D&originHeight=200&originWidth=200&size=0&status=done&style=none&width=200"><br>有一个商场，来了 1000 个顾客买东西，那么该如何安排导购员服务这 1000 人呢？有两种方案：<br>第一，我雇 1000 个导购员实行一对一服务，这种当然是最高效的，但是太浪费资源了，雇 1000 个人的成本极高且管理困难，这些可以先按下不表，但是每个顾客到商场买东西也不是一进来就马上买，一般都得逛一逛，选一选，也就是得花时间挑，1000 个导购员一对一盯着，效率极低；这就引出第二种方案：我只雇 10 个导购员，就在商场里待命，有顾客需要咨询的时候招呼导购员过去进行处理，导购员处理完之后就回来，等下一个顾客需要咨询的时候再去，如此往返反复…<br>第二种方案有没有觉得很眼熟？没错，其基本思路就是模拟一个 I/O 多路复用，通过一种机制，可以监视多个描述符，一旦某个描述符就绪（一般是读就绪或者写就绪），能够通知程序进行相应的读写操作。关于多路复用，不在本文的讨论范围之内，便不再赘述，详细原理可以参考 <a target="_blank" rel="noopener" href="https://www.zybuluo.com/phper/note/595507">I/O 多路复用</a>。<br>第一种方案就是 net/http 标准库采用的：来一个请求开一个 goroutine 处理；第二种方案就是 Goroutine Pool（I/O 多路复用）。</p>
<h1 id="实现一个-Goroutine-Pool"><a href="#实现一个-Goroutine-Pool" class="headerlink" title="实现一个 Goroutine Pool"></a>实现一个 Goroutine Pool</h1><p>因为上述陈列的一些由于 goroutine 规模过大而可能引发的问题，需要有方案来解决这些问题，上文已经分析过，把 goroutine 池化是一种行之有效的方案，基于此，可以实现一个 Goroutine Pool，复用 goroutine，减轻 runtime 的调度压力以及缓解内存压力，依托这些优化，在大规模 goroutine 并发的场景下可以极大地提高并发性能。</p>
<blockquote>
<p>哎玛！前面絮絮叨叨了这么多，终于进入正题了，接下来就开始讲解如何实现一个高性能的 Goroutine Pool，秒杀原生并发的 goroutine，在执行速度和占用内存上提高并发程序的性能。好了，话不多说，开始<del>装逼</del>分析。</p>
</blockquote>
<h2 id="设计思路"><a href="#设计思路" class="headerlink" title="设计思路"></a>设计思路</h2><p>Goroutine Pool 的实现思路大致如下：</p>
<blockquote>
<p>启动服务之时先初始化一个 Goroutine Pool 池，这个 Pool 维护了一个类似栈的 LIFO 队列 ，里面存放负责处理任务的 Worker，然后在 client 端提交 task 到 Pool 中之后，在 Pool 内部，接收 task 之后的核心操作是：</p>
<ol>
<li>检查当前 Worker 队列中是否有可用的 Worker，如果有，取出执行当前的 task；</li>
<li>没有可用的 Worker，判断当前在运行的 Worker 是否已超过该 Pool 的容量：{是 —&gt; 再判断工作池是否为非阻塞模式：[是 ——&gt; 直接返回 nil，否 ——&gt; 阻塞等待直至有 Worker 被放回 Pool]，否 —&gt; 新开一个 Worker（goroutine）处理}；</li>
<li>每个 Worker 执行完任务之后，放回 Pool 的队列中等待。</li>
</ol>
</blockquote>
<p>核心调度流程如下：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/190217/1615724818568-4b5a554e-916f-4d36-b322-71208fd3e7f6.png#align=left&display=inline&height=2266&margin=%5Bobject%20Object%5D&originHeight=2266&originWidth=1690&size=0&status=done&style=none&width=1690"><br>按照这个设计思路，我实现了一个高性能的 Goroutine Pool，较好地解决了上述的大规模调度和资源占用的问题，在执行速度和内存占用方面相较于原生 goroutine 并发占有明显的优势，尤其是内存占用，因为复用，所以规避了无脑启动大规模 goroutine 的弊端，可以节省大量的内存。<br>此外，该调度系统还有一个清理过期 Worker 的定时任务，该任务在初始化一个 Pool 之时启动，每隔一定的时间间隔去检查空闲 Worker 队列中是否有已经过期的 Worker，有则清理掉，通过定时清理过期 worker，进一步节省系统资源。<br>完整的项目代码可以在我的 GitHub 上获取：<a target="_blank" rel="noopener" href="https://github.com/panjf2000/ants">传送门</a>，也欢迎提意见和交流。</p>
<h2 id="实现细节"><a href="#实现细节" class="headerlink" title="实现细节"></a>实现细节</h2><p>Goroutine Pool 的设计原理前面已经讲过了，整个调度过程相信大家应该可以理解了，但是有一句老话说得好，空谈误国，实干兴邦，设计思路有了，具体实现的时候肯定会有很多细节、难点，接下来我们通过分析这个 Goroutine Pool 的几个核心实现以及它们的联动来引导大家过一遍 Goroutine Pool 的原理。</p>
<h3 id="首先是-Pool-struct-："><a href="#首先是-Pool-struct-：" class="headerlink" title="首先是 Pool struct ："></a>首先是 <code>Pool struct</code> ：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">type sig struct&#123;&#125;</span><br><span class="line"></span><br><span class="line">type f func() error</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Pool accept the tasks from client,it limits the total</span><br><span class="line">&#x2F;&#x2F; of goroutines to a given number by recycling goroutines.</span><br><span class="line">type Pool struct &#123;</span><br><span class="line">	&#x2F;&#x2F; capacity of the pool.</span><br><span class="line">	capacity int32</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; running is the number of the currently running goroutines.</span><br><span class="line">	running int32</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; expiryDuration set the expired time (second) of every worker.</span><br><span class="line">	expiryDuration time.Duration</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; workers is a slice that store the available workers.</span><br><span class="line">	workers []*Worker</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; release is used to notice the pool to closed itself.</span><br><span class="line">	release chan sig</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; lock for synchronous operation.</span><br><span class="line">	lock sync.Mutex</span><br><span class="line"></span><br><span class="line">	once sync.Once</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Pool</code> 是一个通用的协程池，支持不同类型的任务，亦即每一个任务绑定一个函数提交到池中，批量执行不同类型任务，是一种广义的协程池；本项目中还实现了另一种协程池 — 批量执行同类任务的协程池 <code>PoolWithFunc</code> ，每一个 <code>PoolWithFunc</code> 只会绑定一个任务函数 <code>pf</code> ，这种 Pool 适用于大批量相同任务的场景，因为每个 Pool 只绑定一个任务函数，因此 <code>PoolWithFunc</code> 相较于 <code>Pool</code> 会更加节省内存，但通用性就不如前者了，为了让大家更好地理解协程池的原理，这里我们用通用的 <code>Pool</code> 来分析。<br><code>capacity</code> 是该 Pool 的容量，也就是开启 worker 数量的上限，每一个 worker 绑定一个 goroutine； <code>running</code> 是当前正在执行任务的 worker 数量； <code>expiryDuration</code> 是 worker 的过期时长，在空闲队列中的 worker 的最新一次运行时间与当前时间之差如果大于这个值则表示已过期，定时清理任务会清理掉这个 worker； <code>workers</code> 是一个 slice，用来存放空闲 worker，请求进入 Pool 之后会首先检查 <code>workers</code> 中是否有空闲 worker，若有则取出绑定任务执行，否则判断当前运行的 worker 是否已经达到容量上限，是—阻塞等待，否—新开一个 worker 执行任务； <code>release</code> 是当关闭该 Pool 支持通知所有 worker 退出运行以防 goroutine 泄露； <code>lock</code> 是一个锁，用以支持 Pool 的同步操作； <code>once</code> 用在确保 Pool 关闭操作只会执行一次。</p>
<h3 id="初始化-Pool-并启动定期清理过期-worker-任务"><a href="#初始化-Pool-并启动定期清理过期-worker-任务" class="headerlink" title="初始化 Pool 并启动定期清理过期 worker 任务"></a>初始化 Pool 并启动定期清理过期 worker 任务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; NewPool generates a instance of ants pool</span><br><span class="line"> func NewPool(size int) (*Pool, error) &#123;</span><br><span class="line"> 	return NewTimingPool(size, DefaultCleanIntervalTime)</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> &#x2F;&#x2F; NewTimingPool generates a instance of ants pool with a custom timed task</span><br><span class="line"> func NewTimingPool(size, expiry int) (*Pool, error) &#123;</span><br><span class="line"> 	if size &lt;&#x3D; 0 &#123;</span><br><span class="line"> 		return nil, ErrInvalidPoolSize</span><br><span class="line">	&#125;</span><br><span class="line">	if expiry &lt;&#x3D; 0 &#123;</span><br><span class="line">		return nil, ErrInvalidPoolExpiry</span><br><span class="line">	&#125;</span><br><span class="line">	p :&#x3D; &amp;Pool&#123;</span><br><span class="line">		capacity:       int32(size),</span><br><span class="line">		freeSignal:     make(chan sig, math.MaxInt32),</span><br><span class="line">		release:        make(chan sig, 1),</span><br><span class="line">		expiryDuration: time.Duration(expiry) * time.Second,</span><br><span class="line">	&#125;</span><br><span class="line">	&#x2F;&#x2F; 启动定期清理过期worker任务，独立goroutine运行，</span><br><span class="line">	&#x2F;&#x2F; 进一步节省系统资源</span><br><span class="line">	p.monitorAndClear()</span><br><span class="line">	return p, nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="提交任务到-Pool"><a href="#提交任务到-Pool" class="headerlink" title="提交任务到 Pool"></a>提交任务到 Pool</h3><p><code>p.Submit(task f)</code> 如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Submit submit a task to pool</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">Submit</span><span class="params">(task f)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(p.release) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> ErrPoolClosed</span><br><span class="line">	&#125;</span><br><span class="line">	w := p.getWorker()</span><br><span class="line">	w.task &lt;- task</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一个 if 判断当前 Pool 是否已被关闭，若是则不再接受新任务，否则获取一个 Pool 中可用的 worker，绑定该 <code>task</code> 执行。</p>
<h3 id="获取可用-worker（核心）"><a href="#获取可用-worker（核心）" class="headerlink" title="获取可用 worker（核心）"></a>获取可用 worker（核心）</h3><p><code>p.getWorker()</code> 源码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// getWorker returns a available worker to run the tasks.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">getWorker</span><span class="params">()</span> *<span class="title">Worker</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> w *Worker</span><br><span class="line">	<span class="comment">// 标志变量，判断当前正在运行的worker数量是否已到达Pool的容量上限</span></span><br><span class="line">	waiting := <span class="literal">false</span></span><br><span class="line">	<span class="comment">// 加锁，检测队列中是否有可用worker，并进行相应操作</span></span><br><span class="line">	p.lock.Lock()</span><br><span class="line">	idleWorkers := p.workers</span><br><span class="line">	n := <span class="built_in">len</span>(idleWorkers) - <span class="number">1</span></span><br><span class="line">	<span class="comment">// 当前队列中无可用worker</span></span><br><span class="line">	<span class="keyword">if</span> n &lt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="comment">// 判断运行worker数目已达到该Pool的容量上限，置等待标志</span></span><br><span class="line">		waiting = p.Running() &gt;= p.Cap()</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 当前队列有可用worker，从队列尾部取出一个使用</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		w = idleWorkers[n]</span><br><span class="line">		idleWorkers[n] = <span class="literal">nil</span></span><br><span class="line">		p.workers = idleWorkers[:n]</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 检测完成，解锁</span></span><br><span class="line">	p.lock.Unlock()</span><br><span class="line">	<span class="comment">// Pool容量已满，新请求等待</span></span><br><span class="line">	<span class="keyword">if</span> waiting &#123;</span><br><span class="line">		<span class="comment">// 利用锁阻塞等待直到有空闲worker</span></span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			p.lock.Lock()</span><br><span class="line">			idleWorkers = p.workers</span><br><span class="line">			l := <span class="built_in">len</span>(idleWorkers) - <span class="number">1</span></span><br><span class="line">			<span class="keyword">if</span> l &lt; <span class="number">0</span> &#123;</span><br><span class="line">				p.lock.Unlock()</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">			w = idleWorkers[l]</span><br><span class="line">			idleWorkers[l] = <span class="literal">nil</span></span><br><span class="line">			p.workers = idleWorkers[:l]</span><br><span class="line">			p.lock.Unlock()</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 当前无空闲worker但是Pool还没有满，</span></span><br><span class="line">		<span class="comment">// 则可以直接新开一个worker执行任务</span></span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> w == <span class="literal">nil</span> &#123;</span><br><span class="line">		w = &amp;Worker&#123;</span><br><span class="line">			pool: p,</span><br><span class="line">			task: <span class="built_in">make</span>(<span class="keyword">chan</span> f, <span class="number">1</span>),</span><br><span class="line">		&#125;</span><br><span class="line">		w.run()</span><br><span class="line">		<span class="comment">// 运行worker数加一</span></span><br><span class="line">		p.incRunning()</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> w</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的源码中加了较为详细的注释，结合前面的设计思路，相信大家应该能理解获取可用 worker 绑定任务执行这个协程池的核心操作，主要就是实现一个 LIFO 队列用来存取可用 worker 达到资源复用的效果，之所以采用 LIFO 后进先出队列是因为后进先出可以保证空闲 worker 队列是按照每个 worker 的最后运行时间从远到近的顺序排列，方便在后续定期清理过期 worker 时排序以及清理完之后重新分配空闲 worker 队列，这里还要关注一个地方：达到 Pool 容量限制之后，额外的任务请求需要阻塞等待 idle worker，这里是为了防止无节制地创建 goroutine，事实上 Go 调度器有一个复用机制，每次使用 <code>go</code> 关键字的时候它会检查当前结构体 M 中的 P 中，是否有可用的结构体 G。如果有，则直接从中取一个，否则，需要分配一个新的结构体 G。如果分配了新的 G，需要将它挂到 runtime 的相关队列中，但是调度器却没有限制 goroutine 的数量，这在瞬时性 goroutine 爆发的场景下就可能来不及复用 G 而依然创建了大量的 goroutine，所以 <code>ants</code> 除了复用还做了限制 goroutine 数量。<br>其他部分可以依照注释理解，这里不再赘述。</p>
<h3 id="任务执行"><a href="#任务执行" class="headerlink" title="任务执行"></a>任务执行</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">1&#x2F;&#x2F; Worker is the actual executor who runs the tasks,</span><br><span class="line"> 2&#x2F;&#x2F; it starts a goroutine that accepts tasks and</span><br><span class="line"> 3&#x2F;&#x2F; performs function calls.</span><br><span class="line"> 4type Worker struct &#123;</span><br><span class="line"> 5	&#x2F;&#x2F; pool who owns this worker.</span><br><span class="line"> 6	pool *Pool</span><br><span class="line"> 7</span><br><span class="line"> 8	&#x2F;&#x2F; task is a job should be done.</span><br><span class="line"> 9	task chan f</span><br><span class="line">10</span><br><span class="line">11	&#x2F;&#x2F; recycleTime will be update when putting a worker back into queue.</span><br><span class="line">12	recycleTime time.Time</span><br><span class="line">13&#125;</span><br><span class="line">14</span><br><span class="line">15&#x2F;&#x2F; run starts a goroutine to repeat the process</span><br><span class="line">16&#x2F;&#x2F; that performs the function calls.</span><br><span class="line">17func (w *Worker) run() &#123;</span><br><span class="line">18	go func() &#123;</span><br><span class="line">19		&#x2F;&#x2F; 循环监听任务列表，一旦有任务立马取出运行</span><br><span class="line">20		for f :&#x3D; range w.task &#123;</span><br><span class="line">21			if f &#x3D;&#x3D; nil &#123;</span><br><span class="line">22				&#x2F;&#x2F; 退出goroutine，运行worker数减一</span><br><span class="line">23				w.pool.decRunning()</span><br><span class="line">24				return</span><br><span class="line">25			&#125;</span><br><span class="line">26			f()</span><br><span class="line">27			&#x2F;&#x2F; worker回收复用</span><br><span class="line">28			w.pool.putWorker(w)</span><br><span class="line">29		&#125;</span><br><span class="line">30	&#125;()</span><br><span class="line">31&#125;</span><br></pre></td></tr></table></figure>

<p>结合前面的 <code>p.Submit(task f)</code> 和 <code>p.getWorker()</code> ，提交任务到 Pool 之后，获取一个可用 worker，每新建一个 worker 实例之时都需要调用 <code>w.run()</code> 启动一个 goroutine 监听 worker 的任务列表 <code>task</code> ，一有任务提交进来就执行；所以，当调用 worker 的 <code>sendTask(task f)</code> 方法提交任务到 worker 的任务队列之后，马上就可以被接收并执行，当任务执行完之后，会调用 <code>w.pool.putWorker(w *Worker)</code> 方法将这个已经执行完任务的 worker 从当前任务解绑放回 Pool 中，以供下个任务可以使用，至此，一个任务从提交到完成的过程就此结束，Pool 调度将进入下一个循环。</p>
<h3 id="Worker-回收（goroutine-复用）"><a href="#Worker-回收（goroutine-复用）" class="headerlink" title="Worker 回收（goroutine 复用）"></a>Worker 回收（goroutine 复用）</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1&#x2F;&#x2F; putWorker puts a worker back into free pool, recycling the goroutines.</span><br><span class="line">2func (p *Pool) putWorker(worker *Worker) &#123;</span><br><span class="line">3	&#x2F;&#x2F; 写入回收时间，亦即该worker的最后一次结束运行的时间</span><br><span class="line">4	worker.recycleTime &#x3D; time.Now()</span><br><span class="line">5	p.lock.Lock()</span><br><span class="line">6	p.workers &#x3D; append(p.workers, worker)</span><br><span class="line">7	p.lock.Unlock()</span><br><span class="line">8&#125;</span><br></pre></td></tr></table></figure>

<h3 id="动态扩容或者缩小池容量"><a href="#动态扩容或者缩小池容量" class="headerlink" title="动态扩容或者缩小池容量"></a>动态扩容或者缩小池容量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">1&#x2F;&#x2F; ReSize change the capacity of this pool</span><br><span class="line"> 2func (p *Pool) ReSize(size int) &#123;</span><br><span class="line"> 3	if size &#x3D;&#x3D; p.Cap() &#123;</span><br><span class="line"> 4		return</span><br><span class="line"> 5	&#125;</span><br><span class="line"> 6	atomic.StoreInt32(&amp;p.capacity, int32(size))</span><br><span class="line"> 7	diff :&#x3D; p.Running() - size</span><br><span class="line"> 8	if diff &gt; 0 &#123;</span><br><span class="line"> 9		for i :&#x3D; 0; i &lt; diff; i++ &#123;</span><br><span class="line">10			p.getWorker().task &lt;- nil</span><br><span class="line">11		&#125;</span><br><span class="line">12	&#125;</span><br><span class="line">13&#125;</span><br></pre></td></tr></table></figure>

<h3 id="定期清理过期-Worker"><a href="#定期清理过期-Worker" class="headerlink" title="定期清理过期 Worker"></a>定期清理过期 Worker</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">1&#x2F;&#x2F; clear expired workers periodically.</span><br><span class="line"> 2func (p *Pool) periodicallyPurge() &#123;</span><br><span class="line"> 3	heartbeat :&#x3D; time.NewTicker(p.expiryDuration)</span><br><span class="line"> 4	for range heartbeat.C &#123;</span><br><span class="line"> 5		currentTime :&#x3D; time.Now()</span><br><span class="line"> 6		p.lock.Lock()</span><br><span class="line"> 7		idleWorkers :&#x3D; p.workers</span><br><span class="line"> 8		if len(idleWorkers) &#x3D;&#x3D; 0 &amp;&amp; p.Running() &#x3D;&#x3D; 0 &amp;&amp; len(p.release) &gt; 0 &#123;</span><br><span class="line"> 9			p.lock.Unlock()</span><br><span class="line">10			return</span><br><span class="line">11		&#125;</span><br><span class="line">12		n :&#x3D; 0</span><br><span class="line">13		for i, w :&#x3D; range idleWorkers &#123;</span><br><span class="line">14			if currentTime.Sub(w.recycleTime) &lt;&#x3D; p.expiryDuration &#123;</span><br><span class="line">15				break</span><br><span class="line">16			&#125;</span><br><span class="line">17			n &#x3D; i</span><br><span class="line">18			w.task &lt;- nil</span><br><span class="line">19			idleWorkers[i] &#x3D; nil</span><br><span class="line">20		&#125;</span><br><span class="line">21		n++</span><br><span class="line">22		if n &gt;&#x3D; len(idleWorkers) &#123;</span><br><span class="line">23			p.workers &#x3D; idleWorkers[:0]</span><br><span class="line">24		&#125; else &#123;</span><br><span class="line">25			p.workers &#x3D; idleWorkers[n:]</span><br><span class="line">26		&#125;</span><br><span class="line">27		p.lock.Unlock()</span><br><span class="line">28	&#125;</span><br><span class="line">29&#125;</span><br></pre></td></tr></table></figure>

<p>定期检查空闲 worker 队列中是否有已过期的 worker 并清理：因为采用了 LIFO 后进先出队列存放空闲 worker，所以该队列默认已经是按照 worker 的最后运行时间由远及近排序，可以方便地按顺序取出空闲队列中的每个 worker 并判断它们的最后运行时间与当前时间之差是否超过设置的过期时长，若是，则清理掉该 goroutine，释放该 worker，并且将剩下的未过期 worker 重新分配到当前 Pool 的空闲 worker 队列中，进一步节省系统资源。<br>概括起来， <code>ants</code> Goroutine Pool 的调度过程图示如下：<br><img src="https://raw.githubusercontent.com/panjf2000/illustrations/master/go/ants-pool-1.png?imageView2/2/w/1280/format/jpg/interlace/1/q/100#align=left&display=inline&height=978&margin=%5Bobject%20Object%5D&originHeight=978&originWidth=3600&status=done&style=none&width=3600"><br><img src="https://raw.githubusercontent.com/panjf2000/illustrations/master/go/ants-pool-2.png?imageView2/2/w/1280/format/jpg/interlace/1/q/100#align=left&display=inline&height=1782&margin=%5Bobject%20Object%5D&originHeight=1782&originWidth=3600&status=done&style=none&width=3600"><br><img src="https://raw.githubusercontent.com/panjf2000/illustrations/master/go/ants-pool-3.png?imageView2/2/w/1280/format/jpg/interlace/1/q/100#align=left&display=inline&height=1404&margin=%5Bobject%20Object%5D&originHeight=1404&originWidth=3600&status=done&style=none&width=3600"><br><img src="https://raw.githubusercontent.com/panjf2000/illustrations/master/go/ants-pool-4.png?imageView2/2/w/1280/format/jpg/interlace/1/q/100#align=left&display=inline&height=987&margin=%5Bobject%20Object%5D&originHeight=987&originWidth=3600&status=done&style=none&width=3600"></p>
<h3 id="彩蛋"><a href="#彩蛋" class="headerlink" title="彩蛋"></a>彩蛋</h3><p>还记得前面我说除了通用的 <code>Pool struct</code> 之外，本项目还实现了一个 <code>PoolWithFunc struct</code> —一个执行批量同类任务的协程池， <code>PoolWithFunc</code> 相较于 <code>Pool</code> ，因为一个池只绑定一个任务函数，省去了每一次 task 都需要传送一个任务函数的代价，因此其性能优势比起 <code>Pool</code> 更明显，这里我们稍微讲一下一个协程池只绑定一个任务函数的细节：<br>上码！</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">1type pf func(interface&#123;&#125;) error</span><br><span class="line"> 2</span><br><span class="line"> 3&#x2F;&#x2F; PoolWithFunc accept the tasks from client,it limits the total</span><br><span class="line"> 4&#x2F;&#x2F; of goroutines to a given number by recycling goroutines.</span><br><span class="line"> 5type PoolWithFunc struct &#123;</span><br><span class="line"> 6	&#x2F;&#x2F; capacity of the pool.</span><br><span class="line"> 7	capacity int32</span><br><span class="line"> 8</span><br><span class="line"> 9	&#x2F;&#x2F; running is the number of the currently running goroutines.</span><br><span class="line">10	running int32</span><br><span class="line">11</span><br><span class="line">12	&#x2F;&#x2F; expiryDuration set the expired time (second) of every worker.</span><br><span class="line">13	expiryDuration time.Duration</span><br><span class="line">14</span><br><span class="line">15	&#x2F;&#x2F; workers is a slice that store the available workers.</span><br><span class="line">16	workers []*WorkerWithFunc</span><br><span class="line">17</span><br><span class="line">18	&#x2F;&#x2F; release is used to notice the pool to closed itself.</span><br><span class="line">19	release chan sig</span><br><span class="line">20</span><br><span class="line">21	&#x2F;&#x2F; lock for synchronous operation.</span><br><span class="line">22	lock sync.Mutex</span><br><span class="line">23</span><br><span class="line">24	&#x2F;&#x2F; pf is the function for processing tasks.</span><br><span class="line">25	poolFunc pf</span><br><span class="line">26</span><br><span class="line">27	once sync.Once</span><br><span class="line">28&#125;</span><br></pre></td></tr></table></figure>

<p><code>PoolWithFunc struct</code> 中的大部分字段和 <code>Pool struct</code> 基本一致，重点关注 <code>poolFunc pf</code> ，这是一个函数类型，也就是该 Pool 绑定的指定任务函数，而 client 提交到这种类型的 Pool 的数据就不再是一个任务函数 <code>task f</code> 了，而是 <code>poolFunc pf</code> 任务函数的形参，然后交由 <code>WorkerWithFunc</code> 处理：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">1&#x2F;&#x2F; WorkerWithFunc is the actual executor who runs the tasks,</span><br><span class="line"> 2&#x2F;&#x2F; it starts a goroutine that accepts tasks and</span><br><span class="line"> 3&#x2F;&#x2F; performs function calls.</span><br><span class="line"> 4type WorkerWithFunc struct &#123;</span><br><span class="line"> 5	&#x2F;&#x2F; pool who owns this worker.</span><br><span class="line"> 6	pool *PoolWithFunc</span><br><span class="line"> 7</span><br><span class="line"> 8	&#x2F;&#x2F; args is a job should be done.</span><br><span class="line"> 9	args chan interface&#123;&#125;</span><br><span class="line">10</span><br><span class="line">11	&#x2F;&#x2F; recycleTime will be update when putting a worker back into queue.</span><br><span class="line">12	recycleTime time.Time</span><br><span class="line">13&#125;</span><br><span class="line">14</span><br><span class="line">15&#x2F;&#x2F; run starts a goroutine to repeat the process</span><br><span class="line">16&#x2F;&#x2F; that performs the function calls.</span><br><span class="line">17func (w *WorkerWithFunc) run() &#123;</span><br><span class="line">18	go func() &#123;</span><br><span class="line">19		for args :&#x3D; range w.args &#123;</span><br><span class="line">20			if args &#x3D;&#x3D; nil &#123;</span><br><span class="line">21				w.pool.decRunning()</span><br><span class="line">22				return</span><br><span class="line">23			&#125;</span><br><span class="line">24			w.pool.poolFunc(args)</span><br><span class="line">25			w.pool.putWorker(w)</span><br><span class="line">26		&#125;</span><br><span class="line">27	&#125;()</span><br><span class="line">28&#125;</span><br></pre></td></tr></table></figure>

<p>上面的源码可以看到 <code>WorkerWithFunc</code> 是一个类似 <code>Worker</code> 的结构，只不过监听的是函数的参数队列，每接收到一个参数包，就直接调用 <code>PoolWithFunc</code> 绑定好的任务函数 <code>poolFunc pf</code> 任务函数执行任务，接下来的流程就和 <code>Worker</code> 是一致的了，执行完任务后就把 worker 放回协程池，等待下次使用。<br>至于其他逻辑如提交 <code>task</code> 、获取 <code>Worker</code> 绑定任务等基本复用自 <code>Pool struct</code> ，具体细节有细微差别，但原理一致，万变不离其宗，有兴趣的同学可以看我在 GitHub 上的源码：Goroutine Pool 协程池 <a target="_blank" rel="noopener" href="https://github.com/panjf2000/ants/">ants</a> 。</p>
<h1 id="Benchmarks"><a href="#Benchmarks" class="headerlink" title="Benchmarks"></a>Benchmarks</h1><p>吹了这么久的 Goroutine Pool，那都是虚的，理论上池化可以复用 goroutine，提升性能节省内存，没有 benchmark 数据之前，好像也不能服众哈！所以，本章就来进行一次实测，验证一下再大规模 goroutine 并发的场景下，Goroutine Pool 的表现是不是真的比原生 Goroutine 并发更好！<br>测试机器参数：</p>
<h2 id="Pool-测试"><a href="#Pool-测试" class="headerlink" title="Pool 测试"></a>Pool 测试</h2><p><a target="_blank" rel="noopener" href="https://github.com/panjf2000/ants/blob/master/ants_test.go">测试代码传送门</a><br>测试结果：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/190217/1615724818558-80144e90-9a10-425c-be57-0dabaf13cbd5.png#align=left&display=inline&height=1036&margin=%5Bobject%20Object%5D&originHeight=1036&originWidth=1322&size=0&status=done&style=none&width=1322"><br>这里为了模拟大规模 goroutine 的场景，两次测试的并发次数分别是 100w 和 1000w，前两个测试分别是执行 100w 个并发任务不使用 Pool 和使用了 <code>ants</code> 的 Goroutine Pool 的性能，后两个则是 1000w 个任务下的表现，可以直观的看出在执行速度和内存使用上， <code>ants</code> 的 Pool 都占有明显的优势。100w 的任务量，使用 <code>ants</code> ，执行速度与原生 goroutine 相当甚至略快，但只实际使用了不到 5w 个 goroutine 完成了全部任务，且内存消耗仅为原生并发的 40%；而当任务量达到 1000w，优势则更加明显了：用了 70w 左右的 goroutine 完成全部任务，执行速度比原生 goroutine 提高了 100%，且内存消耗依旧保持在不使用 Pool 的 40% 左右。</p>
<h2 id="PoolWithFunc-测试"><a href="#PoolWithFunc-测试" class="headerlink" title="PoolWithFunc 测试"></a>PoolWithFunc 测试</h2><p><a target="_blank" rel="noopener" href="https://github.com/panjf2000/ants/blob/master/ants_benchmark_test.go">测试代码传送门</a><br>测试结果：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/190217/1615724818565-a6baf060-16dd-43ab-8bf2-78ab03b16bf5.png#align=left&display=inline&height=668&margin=%5Bobject%20Object%5D&originHeight=668&originWidth=1730&size=0&status=done&style=none&width=1730"></p>
<ul>
<li>Benchmarkxxx-4 格式为 <code>基准测试函数名-GOMAXPROCS</code> ，后面的-4 代表测试函数运行时对应的 CPU 核数</li>
<li>1 表示执行的次数</li>
<li>xx ns/op 表示每次的执行时间</li>
<li>xx B/op 表示每次执行分配的总字节数（内存消耗）</li>
<li>xx allocs/op 表示每次执行发生了多少次内存分配</li>
</ul>
<p>因为 <code>PoolWithFunc</code> 这个 Pool 只绑定一个任务函数，也即所有任务都是运行同一个函数，所以相较于 <code>Pool</code> 对原生 goroutine 在执行速度和内存消耗的优势更大，上面的结果可以看出，执行速度可以达到原生 goroutine 的 300%，而内存消耗的优势已经达到了两位数的差距，原生 goroutine 的内存消耗达到了 <code>ants</code> 的 35 倍且原生 goroutine 的每次执行的内存分配次数也达到了 <code>ants</code> 45 倍，1000w 的任务量， <code>ants</code> 的初始分配容量是 5w，因此它完成了所有的任务依旧只使用了 5w 个 goroutine！事实上， <code>ants</code> 的 Goroutine Pool 的容量是可以自定义的，也就是说使用者可以根据不同场景对这个参数进行调优直至达到最高性能。</p>
<h2 id="吞吐量测试"><a href="#吞吐量测试" class="headerlink" title="吞吐量测试"></a>吞吐量测试</h2><p>上面的 benchmarks 出来以后，我当时的内心是这样的：<br><img src="https://cdn.nlark.com/yuque/0/2021/jpeg/190217/1615724818532-f8c96e85-4fc6-48ca-8ce5-ee7d12b4315b.jpeg#align=left&display=inline&height=360&margin=%5Bobject%20Object%5D&originHeight=360&originWidth=360&size=0&status=done&style=none&width=360"><br>但是太顺利反而让我疑惑，因为结合我过去这 20 几年的坎坷人生来看，事情应该不会这么美好才对，果不其然，细细一想，虽然 <code>ants</code> Groutine Pool 能在大规模并发下执行速度和内存消耗都对原生 goroutine 占有明显优势，但前面的测试 demo 相信大家注意到了，里面使用了 WaitGroup，也就是用来对 goroutine 同步的工具，所以上面的 benchmarks 中主进程会等待所有子 goroutine 完成任务后才算完成一次性能测试，然而又有多少场景是单台机器需要扛 100w 甚至 1000w 同步任务的？基本没有啊！结果就是造出了屠龙刀，可是世界上没有龙啊！也是无情…<br>彼时，我内心变成了这样：<br><img src="https://cdn.nlark.com/yuque/0/2021/jpeg/190217/1615724818562-26f0492a-8c66-4d36-891c-78d80f7dbcb6.jpeg#align=left&display=inline&height=336&margin=%5Bobject%20Object%5D&originHeight=336&originWidth=461&size=0&status=done&style=none&width=461"><br>幸好， <code>ants</code> 在同步批量任务方面有点曲高和寡，但是如果是异步批量任务的场景下，就有用武之地了，也就是说，在大批量的任务无须同步等待完成的情况下，可以再测一下 <code>ants</code> 和原生 goroutine 并发的性能对比，这个时候的性能对比也即是吞吐量对比了，就是在相同大规模数量的请求涌进来的时候， <code>ants</code> 和原生 goroutine 谁能用更快的速度、更少的内存『吞』完这些请求。<br><a target="_blank" rel="noopener" href="https://github.com/panjf2000/ants/blob/master/ants_benchmark_test.go">测试代码传送门</a><br>测试结果：</p>
<h3 id="10w-吞吐量"><a href="#10w-吞吐量" class="headerlink" title="10w 吞吐量"></a>10w 吞吐量</h3><p><img src="https://cdn.nlark.com/yuque/0/2021/png/190217/1615724818556-68806100-73bf-4f3a-bada-ae9d70cbced0.png#align=left&display=inline&height=810&margin=%5Bobject%20Object%5D&originHeight=810&originWidth=1630&size=0&status=done&style=none&width=1630"></p>
<h3 id="100w-吞吐量"><a href="#100w-吞吐量" class="headerlink" title="100w 吞吐量"></a>100w 吞吐量</h3><p><img src="https://cdn.nlark.com/yuque/0/2021/png/190217/1615724818574-826a69dc-444c-4a3f-9481-ecdb9306cc77.png#align=left&display=inline&height=546&margin=%5Bobject%20Object%5D&originHeight=546&originWidth=1660&size=0&status=done&style=none&width=1660"></p>
<h3 id="1000w-吞吐量"><a href="#1000w-吞吐量" class="headerlink" title="1000w 吞吐量"></a>1000w 吞吐量</h3><p><img src="https://cdn.nlark.com/yuque/0/2021/png/190217/1615724818575-7efe55db-b15e-4a91-8813-111910c1b26a.png#align=left&display=inline&height=324&margin=%5Bobject%20Object%5D&originHeight=324&originWidth=1614&size=0&status=done&style=none&width=1614"><br>因为在我的电脑上测试 1000w 吞吐量的时候原生 goroutine 已经到了极限，因此程序直接把电脑拖垮了，无法正常测试了，所以 1000w 吞吐的测试数据只有 <code>ants</code> Pool 的。<br><strong>从该 demo 测试吞吐性能对比可以看出，使用<code>ants</code> 的吞吐性能相较于原生 goroutine 可以保持在 2<del>6 倍的性能压制，而内存消耗则可以达到 10</del>20 倍的节省优势。</strong></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>至此，一个高性能的 Goroutine Pool 开发就完成了，事实上，原理不难理解，总结起来就是一个『复用』，具体落实到代码细节就是锁同步、原子操作、channel 通信等这些技巧的使用， <code>ant</code> 这整个项目没有借助任何第三方的库，用 golang 的标准库就完成了所有功能，因为本身 golang 的语言原生库已经足够优秀，很多时候开发 golang 项目的时候是可以保持轻量且高性能的，未必事事需要借助第三方库。<br>关于 <code>ants</code> 的价值，其实前文也提及过了， <code>ants</code> 在大规模的异步&amp;同步批量任务处理都有着明显的性能优势（特别是异步批量任务），而单机上百万上千万的同步批量任务处理现实意义不大，但是在异步批量任务处理方面有很大的应用价值，所以我个人觉得，Goroutine Pool 真正的价值还是在：</p>
<ol>
<li>限制并发的 goroutine 数量；</li>
<li>复用 goroutine，减轻 runtime 调度压力，提升程序性能；</li>
<li>规避过多的 goroutine 侵占系统资源（CPU&amp;内存）。</li>
</ol>
<h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p>Go 语言的三位最初的缔造者 — Rob Pike、Robert Griesemer 和 Ken Thompson 中，Robert Griesemer 参与设计了 Java 的 HotSpot 虚拟机和 Chrome 浏览器的 JavaScript V8 引擎，Rob Pike 在大名鼎鼎的 bell lab 侵淫多年，参与了 Plan9 操作系统、C 编译器以及多种语言编译器的设计和实现，Ken Thompson 更是图灵奖得主、Unix 之父、C 语言之父。这三人在计算机史上可是元老级别的人物，特别是 Ken Thompson ，是一手缔造了 Unix 和 C 语言计算机领域的上古大神，所以 Go 语言的设计哲学有着深深的 Unix 烙印：简单、模块化、正交、组合、pipe、功能短小且聚焦等；而令许多开发者青睐于 Go 的简洁、高效编程模式的原因，也正在于此。<br><img src="https://cdn.nlark.com/yuque/0/2021/png/190217/1615724818560-b5684d5e-9929-4c26-b5be-639fee8687f2.png#align=left&display=inline&height=355&margin=%5Bobject%20Object%5D&originHeight=355&originWidth=628&size=0&status=done&style=none&width=628"><br>本文从三大线程模型到 Go 并发调度器再到自定制的 Goroutine Pool，算是较为完整的窥探了整个 Go 语言并发模型的前世今生，我们也可以看到，Go 的设计当然不完美，比如一直被诟病的 error 处理模式、不支持泛型、差强人意的包管理以及面向对象模式的过度抽象化等等，实际上没有任何一门编程语言敢说自己是完美的，还是那句话，任何不考虑应用场景和语言定位的争执都毫无意义，而 Go 的定位从出道开始就是系统编程语言&amp;云计算编程语言（这个有点模糊），而 Go 的作者们也一直坚持的是用最简单抽象的工程化设计完成最复杂的功能，所以如果从这个层面去看 Go 的并发模型，就可以看出其实除了 G-P-M 模型中引入的 P ，并没有太多革新的原创理论，两级线程模型是早已成熟的理论，抢占式调度更不是什么新鲜的调度模式，Go 的伟大之处是在于它诞生之初就是依照<a target="_blank" rel="noopener" href="https://strikefreedom.top/Go%E5%9C%A8%E8%B0%B7%E6%AD%8C%EF%BC%9A%E4%BB%A5%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B%E4%B8%BA%E7%9B%AE%E7%9A%84%E7%9A%84%E8%AF%AD%E8%A8%80%E8%AE%BE%E8%AE%A1">Go 在谷歌：以软件工程为目的的语言设计</a>而设计的，Go 其实就是将这些经典的理论和技术以一种优雅高效的工程化方式组合了起来，并用简单抽象的 API 或语法糖开放给使用者，Go 一直致力于找寻一个高性能&amp;开发效率的双赢点，目前为止，它做得远不够完美，但足够优秀。另外 Go 通过引入 channel 与 goroutine 协同工作，将一种区别于锁&amp;原子操作的并发编程模式 — CSP 带入了 Go 语言，对开发人员在并发编程模式上的思考有很大的启发。<br>从本文中对 Go 调度器的分析以及 <code>ants</code> Goroutine Pool 的设计与实现过程，对 Go 的并发模型做了一次解构和优化思考，在 <code>ants</code> 中的代码实现对锁同步、原子操作、channel 通信的使用也做了一次较为全面的实践，希望对 Gopher 们在 Go 语言并发模型与并发编程的理解上能有所裨益。<br><strong>感谢阅读。</strong></p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2021/03/14/yuque/Goroutine%20%E5%B9%B6%E5%8F%91%E8%B0%83%E5%BA%A6%E6%A8%A1%E5%9E%8B%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%E4%B9%8B%E6%89%8B%E6%92%B8%E4%B8%80%E4%B8%AA%E9%AB%98%E6%80%A7%E8%83%BD%20goroutine%20%E6%B1%A0/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-yuque/mysql 优化" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/02/21/yuque/mysql%20%E4%BC%98%E5%8C%96/">mysql 优化</a>
    </h1>
  

        
        <a href="/2021/02/21/yuque/mysql%20%E4%BC%98%E5%8C%96/" class="archive-article-date">
  	<time datetime="2021-02-21T16:27:16.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2021-02-21</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>1、对查询进行优化，应尽量避免全表扫描，首先应考虑在 WHERE 及 ORDER BY 涉及的列上建立索引。<br>2、应尽量避免在 WHERE 子句中对字段进行 NULL 值判断，创建表时 NULL 是默认值，但大多数时候应该使用 NOT NULL，或者使用一个特殊的值，如 0，-1 作为默认值。<br>3、应尽量避免在 WHERE 子句中使用 != 或 &lt;&gt; 操作符。MySQL 只有对以下操作符才使用索引：&lt;，&lt;=，=，&gt;，&gt;=，BETWEEN，IN，以及某些时候的 LIKE。<br>4、应尽量避免在 WHERE 子句中使用 OR 来连接条件，否则将导致引擎放弃使用索引而进行全表扫描，可以使用 UNION 合并查询：select id from t where num=10 union all select id from t where num=20。<br>5、IN 和 NOT IN 也要慎用，否则会导致全表扫描。对于连续的数值，能用 BETWEEN 就不要用 IN：select id from t where num between 1 and 3。<br>6、下面的查询也将导致全表扫描：select id from t where name like‘%abc%’ 或者 select id from t where name like‘%abc’若要提高效率，可以考虑全文检索。而 select id from t where name like‘abc%’才用到索引。<br>7、如果在 WHERE 子句中使用参数，也会导致全表扫描。<br>8、应尽量避免在 WHERE 子句中对字段进行表达式操作，应尽量避免在 WHERE 子句中对字段进行函数操作。<br>9、很多时候用 EXISTS 代替 IN 是一个好的选择：select num from a where num in(select num from b)。用下面的语句替换：select num from a where exists(select 1 from b where num=a.num)。<br>10、索引固然可以提高相应的 SELECT 的效率，但同时也降低了 INSERT 及 UPDATE 的效。因为 INSERT 或 UPDATE 时有可能会重建索引，所以怎样建索引需要慎重考虑，视具体情况而定。一个表的索引数最好不要超过 6 个，若太多则应考虑一些不常使用到的列上建的索引是否有必要。<br>11、应尽可能的避免更新 clustered 索引数据列， 因为 clustered 索引数据列的顺序就是表记录的物理存储顺序，一旦该列值改变将导致整个表记录的顺序的调整，会耗费相当大的资源。若应用系统需要频繁更新 clustered 索引数据列，那么需要考虑是否应将该索引建为 clustered 索引。<br>12、尽量使用数字型字段，若只含数值信息的字段尽量不要设计为字符型，这会降低查询和连接的性能，并会增加存储开销。<br>13、尽可能的使用 varchar, nvarchar 代替 char, nchar。因为首先变长字段存储空间小，可以节省存储空间，其次对于查询来说，在一个相对较小的字段内搜索效率显然要高些。<br>14、最好不要使用返回所有：select from t ，用具体的字段列表代替 “*”，不要返回用不到的任何字段。<br>15、尽量避免向客户端返回大数据量，若数据量过大，应该考虑相应需求是否合理。<br>16、使用表的别名（Alias）：当在 SQL 语句中连接多个表时，请使用表的别名并把别名前缀于每个 Column 上。这样一来，就可以减少解析的时间并减少那些由 Column 歧义引起的语法错误。<br>17、使用“临时表”暂存中间结果 ：<br>简化 SQL 语句的重要方法就是采用临时表暂存中间结果。但是临时表的好处远远不止这些，将临时结果暂存在临时表，后面的查询就在 tempdb 中了，这可以避免程序中多次扫描主表，也大大减少了程序执行中“共享锁”阻塞“更新锁”，减少了阻塞，提高了并发性能。<br>18、一些 SQL 查询语句应加上 nolock，读、写是会相互阻塞的，为了提高并发性能。对于一些查询，可以加上 nolock，这样读的时候可以允许写，但缺点是可能读到未提交的脏数据。<br>使用 nolock 有 3 条原则：</p>
<ul>
<li>查询的结果用于“插、删、改”的不能加 nolock；</li>
<li>查询的表属于频繁发生页分裂的，慎用 nolock ；</li>
<li>使用临时表一样可以保存“数据前影”，起到类似 Oracle 的 undo 表空间的功能，能采用临时表提高并发性能的，不要用 nolock。</li>
</ul>
<p>19、常见的简化规则如下：<br>不要有超过 5 个以上的表连接（JOIN），考虑使用临时表或表变量存放中间结果。少用子查询，视图嵌套不要过深，一般视图嵌套不要超过 2 个为宜。<br>20、将需要查询的结果预先计算好放在表中，查询的时候再 Select。这在 SQL7.0 以前是最重要的手段，例如医院的住院费计算。<br>21、用 OR 的字句可以分解成多个查询，并且通过 UNION 连接多个查询。他们的速度只同是否使用索引有关，如果查询需要用到联合索引，用 UNION all 执行的效率更高。多个 OR 的字句没有用到索引，改写成 UNION 的形式再试图与索引匹配。一个关键的问题是否用到索引。<br>22、在 IN 后面值的列表中，将出现最频繁的值放在最前面，出现得最少的放在最后面，减少判断的次数。<br>23、尽量将数据的处理工作放在服务器上，减少网络的开销，如使用存储过程。<br>存储过程是编译好、优化过、并且被组织到一个执行规划里、且存储在数据库中的 SQL 语句，是控制流语言的集合，速度当然快。反复执行的动态 SQL，可以使用临时存储过程，该过程（临时表）被放在 Tempdb 中。<br>24、当服务器的内存够多时，配制<strong>线程数量 = 最大连接数+5</strong>，这样能发挥最大的效率；否则使用<strong>配制线程数量&lt; 最大连接数</strong>，启用 SQL SERVER 的线程池来解决，如果还是<strong>数量 = 最大连接数+5</strong>，严重的损害服务器的性能。<br>25、查询的关联同写的顺序 ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select a.personMemberID, * from chineseresume a,personmember b where personMemberID &#x3D; b.referenceid and a.personMemberID &#x3D; &#39;JCNPRH39681&#39; （A &#x3D; B, B &#x3D; &#39;号码&#39;） select a.personMemberID, * from chineseresume a,personmember b where a.personMemberID &#x3D; b.referenceid and a.personMemberID &#x3D; &#39;JCNPRH39681&#39; and b.referenceid &#x3D; &#39;JCNPRH39681&#39; （A &#x3D; B, B &#x3D; &#39;号码&#39;, A &#x3D; &#39;号码&#39;） select a.personMemberID, * from chineseresume a,personmember b where b.referenceid &#x3D; &#39;JCNPRH39681&#39; and a.personMemberID &#x3D; &#39;JCNPRH39681&#39; （B &#x3D; &#39;号码&#39;, A &#x3D; &#39;号码&#39;）</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>26、尽量使用 EXISTS 代替 select count(1) 来判断是否存在记录。count 函数只有在统计表中所有行数时使用，而且 count(1) 比 count(*) 更有效率。<br>27、尽量使用 “&gt;=”，不要使用 “&gt;”。<br>28、索引的使用规范：</p>
<ul>
<li>索引的创建要与应用结合考虑，建议大的 OLTP 表不要超过 6 个索引；</li>
<li>尽可能的使用索引字段作为查询条件，尤其是聚簇索引，必要时可以通过 index index_name 来强制指定索引；</li>
<li>避免对大表查询时进行 table scan，必要时考虑新建索引；</li>
<li>在使用索引字段作为条件时，如果该索引是联合索引，那么必须使用到该索引中的第一个字段作为条件时才能保证系统使用该索引，否则该索引将不会被使用；</li>
<li>要注意索引的维护，周期性重建索引，重新编译存储过程。</li>
</ul>
<p>29、下列 SQL 条件语句中的列都建有恰当的索引，但执行速度却非常慢：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM record WHERE substrINg(card_no, 1, 4) &#x3D; &#39;5378&#39; --13秒 SELECT * FROM record WHERE amount&#x2F;30 &lt; 1000 --11秒 SELECT * FROM record WHERE convert(char(10), date, 112) &#x3D; &#39;19991201&#39; --10秒</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>分析：<br>WHERE 子句中对列的任何操作结果都是在 SQL 运行时逐列计算得到的，因此它不得不进行表搜索，而没有使用该列上面的索引。<br>如果这些结果在查询编译时就能得到，那么就可以被 SQL 优化器优化，使用索引，避免表搜索，因此将 SQL 重写成下面这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM record WHERE card_no like &#39;5378%&#39; -- &lt; 1秒 SELECT * FROM record WHERE amount &lt; 1000*30 -- &lt; 1秒 SELECT * FROM record WHERE date &#x3D; &#39;1999&#x2F;12&#x2F;01&#39; -- &lt; 1秒</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>30、当有一批处理的插入或更新时，用批量插入或批量更新，绝不会一条条记录的去更新。<br>31、在所有的存储过程中，能够用 SQL 语句的，我绝不会用循环去实现。<br>例如：列出上个月的每一天，我会用 connect by 去递归查询一下，绝不会去用循环从上个月第一天到最后一天。<br>32、选择最有效率的表名顺序（只在基于规则的优化器中有效）：<br>Oracle 的解析器按照从右到左的顺序处理 FROM 子句中的表名，FROM 子句中写在最后的表（基础表 driving table）将被最先处理，在 FROM 子句中包含多个表的情况下，你必须选择记录条数最少的表作为基础表。<br>如果有 3 个以上的表连接查询，那就需要选择交叉表（intersection table）作为基础表，交叉表是指那个被其他表所引用的表。<br>33、提高 GROUP BY 语句的效率，可以通过将不需要的记录在 GROUP BY 之前过滤掉。下面两个查询返回相同结果，但第二个明显就快了许多。<br>低效：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT JOB, AVG(SAL) FROM EMP GROUP BY JOB HAVING JOB &#x3D; &#39;PRESIDENT&#39; OR JOB &#x3D; &#39;MANAGER&#39;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>高效：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT JOB, AVG(SAL) FROM EMPWHERE JOB &#x3D; &#39;PRESIDENT&#39; OR JOB &#x3D; &#39;MANAGER&#39; GROUP BY JOB</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>34、SQL 语句用大写，因为 Oracle 总是先解析 SQL 语句，把小写的字母转换成大写的再执行。<br>35、别名的使用，别名是大型数据库的应用技巧，就是表名、列名在查询中以一个字母为别名，查询速度要比建连接表快 1.5 倍。<br>36、避免死锁，在你的存储过程和触发器中访问同一个表时总是以相同的顺序；事务应经可能地缩短，在一个事务中应尽可能减少涉及到的数据量；永远不要在事务中等待用户输入。<br>37、避免使用临时表，除非却有需要，否则应尽量避免使用临时表，相反，可以使用表变量代替。大多数时候（99%），表变量驻扎在内存中，因此速度比临时表更快，临时表驻扎在 TempDb 数据库中，因此临时表上的操作需要跨数据库通信，速度自然慢。<br>38、最好不要使用触发器：</p>
<ul>
<li>触发一个触发器，执行一个触发器事件本身就是一个耗费资源的过程；</li>
<li>如果能够使用约束实现的，尽量不要使用触发器；</li>
<li>不要为不同的触发事件（Insert、Update 和 Delete）使用相同的触发器；</li>
<li>不要在触发器中使用事务型代码。</li>
</ul>
<p>39、索引创建规则：</p>
<ul>
<li>表的主键、外键必须有索引；</li>
<li>数据量超过 300 的表应该有索引；</li>
<li>经常与其他表进行连接的表，在连接字段上应该建立索引；</li>
<li>经常出现在 WHERE 子句中的字段，特别是大表的字段，应该建立索引；</li>
<li>索引应该建在选择性高的字段上；</li>
<li>索引应该建在小字段上，对于大的文本字段甚至超长字段，不要建索引；</li>
<li>复合索引的建立需要进行仔细分析，尽量考虑用单字段索引代替；</li>
<li>正确选择复合索引中的主列字段，一般是选择性较好的字段；</li>
<li>复合索引的几个字段是否经常同时以 AND 方式出现在 WHERE 子句中？单字段查询是否极少甚至没有？如果是，则可以建立复合索引；否则考虑单字段索引；</li>
<li>如果复合索引中包含的字段经常单独出现在 WHERE 子句中，则分解为多个单字段索引；</li>
<li>如果复合索引所包含的字段超过 3 个，那么仔细考虑其必要性，考虑减少复合的字段；</li>
<li>如果既有单字段索引，又有这几个字段上的复合索引，一般可以删除复合索引；</li>
<li>频繁进行数据操作的表，不要建立太多的索引；</li>
<li>删除无用的索引，避免对执行计划造成负面影响；</li>
<li>表上建立的每个索引都会增加存储开销，索引对于插入、删除、更新操作也会增加处理上的开销。另外，过多的复合索引，在有单字段索引的情况下，一般都是没有存在价值的；相反，还会降低数据增加删除时的性能，特别是对频繁更新的表来说，负面影响更大。</li>
<li>尽量不要对数据库中某个含有大量重复的值的字段建立索引。</li>
</ul>
<p>40、MySQL 查询优化总结：<br>使用慢查询日志去发现慢查询，使用执行计划去判断查询是否正常运行，总是去测试你的查询看看是否他们运行在最佳状态下。<br>久而久之性能总会变化，避免在整个表上使用 count(*)，它可能锁住整张表，使查询保持一致以便后续相似的查询可以使用查询缓存，在适当的情形下使用 GROUP BY 而不是 DISTINCT，在 WHERE、GROUP BY 和 ORDER BY 子句中使用有索引的列，保持索引简单，不在多个索引中包含同一个列。<br>有时候 MySQL 会使用错误的索引，对于这种情况使用 USE INDEX，检查使用 SQL_MODE=STRICT 的问题，对于记录数小于 5 的索引字段，在 UNION 的时候使用 LIMIT 不是是用 OR。<br>为了避免在更新前 SELECT，使用 INSERT ON DUPLICATE KEY 或者 INSERT IGNORE；不要用 UPDATE 去实现，不要使用 MAX；使用索引字段和 ORDER BY 子句 LIMIT M，N 实际上可以减缓查询在某些情况下，有节制地使用，在 WHERE 子句中使用 UNION 代替子查询，在重新启动的 MySQL，记得来温暖你的数据库，以确保数据在内存和查询速度快，考虑持久连接，而不是多个连接，以减少开销。<br>基准查询，包括使用服务器上的负载，有时一个简单的查询可以影响其他查询，当负载增加在服务器上，使用 SHOW PROCESSLIST 查看慢的和有问题的查询，在开发环境中产生的镜像数据中测试的所有可疑的查询。<br>41、MySQL 备份过程：</p>
<ul>
<li>从二级复制服务器上进行备份；</li>
<li>在进行备份期间停止复制，以避免在数据依赖和外键约束上出现不一致；</li>
<li>彻底停止 MySQL，从数据库文件进行备份；</li>
<li>如果使用 MySQL dump 进行备份，请同时备份二进制日志文件 – 确保复制没有中断；</li>
<li>不要信任 LVM 快照，这很可能产生数据不一致，将来会给你带来麻烦；</li>
<li>为了更容易进行单表恢复，以表为单位导出数据——如果数据是与其他表隔离的。</li>
<li>当使用 mysqldump 时请使用 –opt；</li>
<li>在备份之前检查和优化表；</li>
<li>为了更快的进行导入，在导入时临时禁用外键约束。；</li>
<li>为了更快的进行导入，在导入时临时禁用唯一性检测；</li>
<li>在每一次备份后计算数据库，表以及索引的尺寸，以便更够监控数据尺寸的增长；</li>
<li>通过自动调度脚本监控复制实例的错误和延迟；</li>
<li>定期执行备份。</li>
</ul>
<p>42、查询缓冲并不自动处理空格，因此，在写 SQL 语句时，应尽量减少空格的使用，尤其是在 SQL 首和尾的空格（因为查询缓冲并不自动截取首尾空格）。<br>43、member 用 mid 做标准进行分表方便查询么？一般的业务需求中基本上都是以 username 为查询依据，正常应当是 username 做 hash 取模来分表。<br>而分表的话 MySQL 的 partition 功能就是干这个的，对代码是透明的；在代码层面去实现貌似是不合理的。<br>44、我们应该为数据库里的每张表都设置一个 ID 做为其主键，而且最好的是一个 INT 型的（推荐使用 UNSIGNED），并设置上自动增加的 AUTO_INCREMENT 标志。<br>45、在所有的存储过程和触发器的开始处设置 SET NOCOUNT ON，在结束时设置 SET NOCOUNT OFF。无需在执行存储过程和触发器的每个语句后向客户端发送 DONE_IN_PROC 消息。<br>46、MySQL 查询可以启用高速查询缓存。这是提高数据库性能的有效 MySQL 优化方法之一。当同一个查询被执行多次时，从缓存中提取数据和直接从数据库中返回数据快很多。<br>47、EXPLAIN SELECT 查询用来跟踪查看效果：<br>使用 EXPLAIN 关键字可以让你知道 MySQL 是如何处理你的 SQL 语句的。这可以帮你分析你的查询语句或是表结构的性能瓶颈。EXPLAIN 的查询结果还会告诉你你的索引主键被如何利用的，你的数据表是如何被搜索和排序的。<br>48、当只要一行数据时使用 LIMIT 1 ：<br>当你查询表的有些时候，你已经知道结果只会有一条结果，但因为你可能需要去 fetch 游标，或是你也许会去检查返回的记录数。<br>在这种情况下，加上 LIMIT 1 可以增加性能。这样一来，MySQL 数据库引擎会在找到一条数据后停止搜索，而不是继续往后查少下一条符合记录的数据。<br>49、选择表合适存储引擎：</p>
<ul>
<li><p><strong>myisam：</strong>应用时以读和插入操作为主，只有少量的更新和删除，并且对事务的完整性，并发性要求不是很高的。</p>
</li>
<li><p><strong>InnoDB：</strong>事务处理，以及并发条件下要求数据的一致性。除了插入和查询外，包括很多的更新和删除。（InnoDB 有效地降低删除和更新导致的锁定）。<br>对于支持事务的 InnoDB 类 型的表来说，影响速度的主要原因是 AUTOCOMMIT 默认设置是打开的，而且程序没有显式调用 BEGIN 开始事务，导致每插入一条都自动提交，严重影响了速度。可以在执行 SQL 前调用 begin，多条 SQL 形成一个事物（即使 autocommit 打开也可以），将大大提高性能。</p>
</li>
</ul>
<p>50、优化表的数据类型，选择合适的数据类型：<br><strong>原则：</strong>更小通常更好，简单就好，所有字段都得有默认值，尽量避免 NULL。<br>例如：数据库表设计时候更小的占磁盘空间尽可能使用更小的整数类型。(mediumint 就比 int 更合适)<br>比如时间字段：datetime 和 timestamp。datetime 占用 8 个字节，timestamp 占用 4 个字节，只用了一半。而 timestamp 表示的范围是 1970—2037 适合做更新时间。<br>MySQL 可以很好的支持大数据量的存取，但是一般说来，数据库中的表越小，在它上面执行的查询也就会越快。<br>因此，在创建表的时候，为了获得更好的性能，我们可以将表中字段的宽度设得尽可能小。<br>例如：在定义邮政编码这个字段时，如果将其设置为 CHAR(255)，显然给数据库增加了不必要的空间。甚至使用 VARCHAR 这种类型也是多余的，因为 CHAR(6) 就可以很好的完成任务了。<br>同样的，如果可以的话，我们应该使用 MEDIUMINT 而不是 BIGIN 来定义整型字段，应该尽量把字段设置为 NOT NULL，这样在将来执行查询的时候，数据库不用去比较 NULL 值。<br>对于某些文本字段，例如“省份”或者“性别”，我们可以将它们定义为 ENUM 类型。因为在 MySQL 中，ENUM 类型被当作数值型数据来处理，而数值型数据被处理起来的速度要比文本类型快得多。这样，我们又可以提高数据库的性能。<br>51、字符串数据类型：char, varchar, text 选择区别。<br>52、任何对列的操作都将导致表扫描，它包括数据库函数、计算表达式等等，查询时要尽可能将操作移至等号右边。</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2021/02/21/yuque/mysql%20%E4%BC%98%E5%8C%96/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-yuque/相关书籍" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/02/17/yuque/%E7%9B%B8%E5%85%B3%E4%B9%A6%E7%B1%8D/">相关书籍</a>
    </h1>
  

        
        <a href="/2021/02/17/yuque/%E7%9B%B8%E5%85%B3%E4%B9%A6%E7%B1%8D/" class="archive-article-date">
  	<time datetime="2021-02-17T13:48:27.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2021-02-17</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ol>
<li><p> <a target="_blank" rel="noopener" href="https://chai2010.cn/advanced-go-programming-book/ch4-rpc/ch4-01-rpc-intro.html">https://chai2010.cn/advanced-go-programming-book/ch4-rpc/ch4-01-rpc-intro.html</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://wskdsgcf.gitbook.io/mastering-go-zh-cn/">https://wskdsgcf.gitbook.io/mastering-go-zh-cn/</a> 3.基础知识<br> <a target="_blank" rel="noopener" href="https://github.com/CyC2018/CS-Notes">https://github.com/CyC2018/CS-Notes</a> 4.规范<br> <a target="_blank" rel="noopener" href="https://github.com/nusr/hacker-laws-zh#%e5%a5%a5%e5%8d%a1%e5%a7%86%e5%89%83%e5%88%80-occams-razor">https://github.com/nusr/hacker-laws-zh#%e5%a5%a5%e5%8d%a1%e5%a7%86%e5%89%83%e5%88%80-occams-razor</a><br> 5.leetcode 题解<br> <a target="_blank" rel="noopener" href="https://books.halfrost.com/leetcode/">https://books.halfrost.com/leetcode/</a></p>
<p> 6.murphyyi 书籍<br> <a target="_blank" rel="noopener" href="http://godoc.murphyyi.com/">http://godoc.murphyyi.com/</a></p>
<p> 7.     必看网站<br> <a target="_blank" rel="noopener" href="https://github.com/yanglbme/redis-multi-programming-language-practice">https://github.com/yanglbme/redis-multi-programming-language-practice</a></p>
</li>
<li><p> 面试</p>
</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://www.yuque.com/fz420/smym5g/gy5h6b">https://www.yuque.com/fz420/smym5g/gy5h6b</a></p>
<ol start="9">
<li>git</li>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/6918358493867016199?utm_source=gold_browser_extension">https://juejin.cn/post/6918358493867016199?utm_source=gold_browser_extension</a></li>
<li>创业 <a target="_blank" rel="noopener" href="http://r.ftqq.com/howto-make-more-money/ch16.html">http://r.ftqq.com/howto-make-more-money/ch16.html</a></li>
<li><a target="_blank" rel="noopener" href="https://ftqq.com/docker2saas/">https://ftqq.com/docker2saas/</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/golang-standards/project-layout">https://github.com/golang-standards/project-layout</a></li>
<li><a target="_blank" rel="noopener" href="https://www.yuque.com/fz420/golang/sf3c6m">https://www.yuque.com/fz420/golang/sf3c6m</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/aikuyun/bigdata-doc">https://github.com/aikuyun/bigdata-doc</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/aikuyun/linux-quick-start">https://github.com/aikuyun/linux-quick-start</a></li>
<li><a target="_blank" rel="noopener" href="https://www.yuque.com/evawu/gllvyk">https://www.yuque.com/evawu/gllvyk</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/zhaofeng092/python_auto_office">https://github.com/zhaofeng092/python_auto_office</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Virtomize/confluence-go-api">https://github.com/Virtomize/confluence-go-api</a></li>
</ol>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2021/02/17/yuque/%E7%9B%B8%E5%85%B3%E4%B9%A6%E7%B1%8D/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-yuque/系统设计入门" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/02/15/yuque/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E5%85%A5%E9%97%A8/">系统设计入门</a>
    </h1>
  

        
        <a href="/2021/02/15/yuque/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E5%85%A5%E9%97%A8/" class="archive-article-date">
  	<time datetime="2021-02-15T20:33:36.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2021-02-15</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="系统设计入门"><a href="#系统设计入门" class="headerlink" title="系统设计入门"></a>系统设计入门</h1><p><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/images/jj3A5N8.png"><img src="https://github.com/donnemartin/system-design-primer/raw/master/images/jj3A5N8.png#align=left&display=inline&height=1666&margin=%5Bobject%20Object%5D&originHeight=1666&originWidth=1234&status=done&style=none&width=1234"></a></p>
<h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><blockquote>
<p>学习如何设计大型系统。<br>为系统设计的面试做准备。</p>
</blockquote>
<h3 id="学习如何设计大型系统"><a href="#学习如何设计大型系统" class="headerlink" title="学习如何设计大型系统"></a>学习如何设计大型系统</h3><p>学习如何设计可扩展的系统将会有助于你成为一个更好的工程师。<br>系统设计是一个很宽泛的话题。在互联网上，<strong>关于系统设计原则的资源也是多如牛毛。</strong><br>这个仓库就是这些资源的<strong>组织收集</strong>，它可以帮助你学习如何构建可扩展的系统。</p>
<h3 id="从开源社区学习"><a href="#从开源社区学习" class="headerlink" title="从开源社区学习"></a>从开源社区学习</h3><p>这是一个不断更新的开源项目的初期的版本。<br>欢迎<a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%B4%A1%E7%8C%AE">贡献</a>！</p>
<h3 id="为系统设计的面试做准备"><a href="#为系统设计的面试做准备" class="headerlink" title="为系统设计的面试做准备"></a>为系统设计的面试做准备</h3><p>在很多科技公司中，除了代码面试，系统设计也是<strong>技术面试过程</strong>中的一个<strong>必要环节</strong>。<br><strong>实践常见的系统设计面试题</strong>并且把你的答案和<strong>例子的解答</strong>进行<strong>对照</strong>：讨论，代码和图表。<br>面试准备的其他主题：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%AD%A6%E4%B9%A0%E6%8C%87%E5%BC%95">学习指引</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E4%B8%80%E4%B8%AA%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E7%9A%84%E9%9D%A2%E8%AF%95%E9%A2%98">如何处理一个系统设计的面试题</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E7%9A%84%E9%9D%A2%E8%AF%95%E9%A2%98%E5%92%8C%E8%A7%A3%E7%AD%94">系统设计的面试题，<strong>含解答</strong></a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%AE%BE%E8%AE%A1%E7%9A%84%E9%9D%A2%E8%AF%95%E9%97%AE%E9%A2%98%E5%8F%8A%E8%A7%A3%E7%AD%94">面向对象设计的面试题，<strong>含解答</strong></a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%85%B6%E5%AE%83%E7%9A%84%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E9%9D%A2%E8%AF%95%E9%A2%98">其它的系统设计面试题</a></li>
</ul>
<h2 id="抽认卡"><a href="#抽认卡" class="headerlink" title="抽认卡"></a>抽认卡</h2><p><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/images/zdCAkB3.png"><img src="https://github.com/donnemartin/system-design-primer/raw/master/images/zdCAkB3.png#align=left&display=inline&height=2560&margin=%5Bobject%20Object%5D&originHeight=2560&originWidth=2880&status=done&style=none&width=2880"></a><br>这里提供的<a target="_blank" rel="noopener" href="https://apps.ankiweb.net/">抽认卡堆</a>使用间隔重复的方法，帮助你记忆关键的系统设计概念。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/resources/flash_cards/System%20Design.apkg">系统设计的卡堆</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/resources/flash_cards/System%20Design%20Exercises.apkg">系统设计的练习卡堆</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/resources/flash_cards/OO%20Design.apkg">面向对象设计的练习卡堆</a></li>
</ul>
<p>随时随地都可使用。</p>
<h3 id="代码资源：互动式编程挑战"><a href="#代码资源：互动式编程挑战" class="headerlink" title="代码资源：互动式编程挑战"></a>代码资源：互动式编程挑战</h3><p>你正在寻找资源以准备<a target="_blank" rel="noopener" href="https://github.com/donnemartin/interactive-coding-challenges"><strong>编程面试</strong></a>吗？<br><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/images/b4YtAEN.png"><img src="https://github.com/donnemartin/system-design-primer/raw/master/images/b4YtAEN.png#align=left&display=inline&height=2560&margin=%5Bobject%20Object%5D&originHeight=2560&originWidth=2926&status=done&style=none&width=2926"></a><br>请查看我们的姐妹仓库<a target="_blank" rel="noopener" href="https://github.com/donnemartin/interactive-coding-challenges"><strong>互动式编程挑战</strong></a>，其中包含了一个额外的抽认卡堆：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/interactive-coding-challenges/tree/master/anki_cards/Coding.apkg">代码卡堆</a></li>
</ul>
<h2 id="贡献"><a href="#贡献" class="headerlink" title="贡献"></a>贡献</h2><blockquote>
<p>从社区中学习。</p>
</blockquote>
<p>欢迎提交 PR 提供帮助：</p>
<ul>
<li>修复错误</li>
<li>完善章节</li>
<li>添加章节</li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/issues/28">帮助翻译</a></li>
</ul>
<p>一些还需要完善的内容放在了<a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%AD%A3%E5%9C%A8%E5%AE%8C%E5%96%84%E4%B8%AD">正在完善中</a>。<br>请查看<a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/CONTRIBUTING.md">贡献指南</a>。</p>
<h2 id="系统设计主题的索引"><a href="#系统设计主题的索引" class="headerlink" title="系统设计主题的索引"></a>系统设计主题的索引</h2><blockquote>
<p>各种系统设计主题的摘要，包括优点和缺点。<strong>每一个主题都面临着取舍和权衡</strong>。<br>每个章节都包含着更多的资源的链接。</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/images/jrUBAF7.png"><img src="https://github.com/donnemartin/system-design-primer/raw/master/images/jrUBAF7.png#align=left&display=inline&height=1390&margin=%5Bobject%20Object%5D&originHeight=1390&originWidth=1348&status=done&style=none&width=1348"></a></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E4%B8%BB%E9%A2%98%E4%BB%8E%E8%BF%99%E9%87%8C%E5%BC%80%E5%A7%8B">系统设计主题：从这里开始</a><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E7%AC%AC%E4%B8%80%E6%AD%A5%E5%9B%9E%E9%A1%BE%E5%8F%AF%E6%89%A9%E5%B1%95%E6%80%A7scalability%E7%9A%84%E8%A7%86%E9%A2%91%E8%AE%B2%E5%BA%A7">第一步：回顾可扩展性的视频讲座</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E7%AC%AC%E4%BA%8C%E6%AD%A5%E5%9B%9E%E9%A1%BE%E5%8F%AF%E6%89%A9%E5%B1%95%E6%80%A7%E6%96%87%E7%AB%A0">第二步：回顾可扩展性的文章</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%8E%A5%E4%B8%8B%E6%9D%A5%E7%9A%84%E6%AD%A5%E9%AA%A4">接下来的步骤</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%80%A7%E8%83%BD%E4%B8%8E%E5%8F%AF%E6%89%A9%E5%B1%95%E6%80%A7">性能与拓展性</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%BB%B6%E8%BF%9F%E4%B8%8E%E5%90%9E%E5%90%90%E9%87%8F">延迟与吞吐量</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%8F%AF%E7%94%A8%E6%80%A7%E4%B8%8E%E4%B8%80%E8%87%B4%E6%80%A7">可用性与一致性</a><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#cap-%E7%90%86%E8%AE%BA">CAP 理论</a><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#cp--%E4%B8%80%E8%87%B4%E6%80%A7%E5%92%8C%E5%88%86%E5%8C%BA%E5%AE%B9%E9%94%99%E6%80%A7">CP - 一致性和分区容错性</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#ap--%E5%8F%AF%E7%94%A8%E6%80%A7%E4%B8%8E%E5%88%86%E5%8C%BA%E5%AE%B9%E9%94%99%E6%80%A7">AP - 可用性和分区容错性</a></li>
</ul>
</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E4%B8%80%E8%87%B4%E6%80%A7%E6%A8%A1%E5%BC%8F">一致模式</a><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%BC%B1%E4%B8%80%E8%87%B4%E6%80%A7">弱一致性</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7">最终一致性</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7">强一致性</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%8F%AF%E7%94%A8%E6%80%A7%E6%A8%A1%E5%BC%8F">可用模式</a><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%95%85%E9%9A%9C%E5%88%87%E6%8D%A2">故障切换</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%A4%8D%E5%88%B6">复制</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%9F%9F%E5%90%8D%E7%B3%BB%E7%BB%9F">域名系统</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%86%85%E5%AE%B9%E5%88%86%E5%8F%91%E7%BD%91%E7%BB%9Ccdn">CDN</a><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#cdn-%E6%8E%A8%E9%80%81push">CDN 推送</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#cdn-%E6%8B%89%E5%8F%96pull">CDN 拉取</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%99%A8">负载均衡器</a><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%B7%A5%E4%BD%9C%E5%88%B0%E5%A4%87%E7%94%A8%E5%88%87%E6%8D%A2active-passive">工作到备用切换（Active-passive）</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%8F%8C%E5%B7%A5%E4%BD%9C%E5%88%87%E6%8D%A2active-active">双工作切换（Active-active）</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%9B%9B%E5%B1%82%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1">四层负载均衡</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E4%B8%83%E5%B1%82%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%99%A8">七层负载均衡</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%B0%B4%E5%B9%B3%E6%89%A9%E5%B1%95">水平扩展</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86web-%E6%9C%8D%E5%8A%A1%E5%99%A8">反向代理（web 服务器）</a><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%99%A8%E4%B8%8E%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86">负载均衡与反向代理</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%BA%94%E7%94%A8%E5%B1%82">应用层</a><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%BE%AE%E6%9C%8D%E5%8A%A1">微服务</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0">服务发现</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%95%B0%E6%8D%AE%E5%BA%93">数据库</a><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9Frdbms">关系型数据库管理系统（RDBMS）</a><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6">Master-slave 复制集</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E4%B8%BB%E4%B8%BB%E5%A4%8D%E5%88%B6">Master-master 复制集</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%81%94%E5%90%88">联合</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%88%86%E7%89%87">分片</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E9%9D%9E%E8%A7%84%E8%8C%83%E5%8C%96">非规范化</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#sql-%E8%B0%83%E4%BC%98">SQL 调优</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#nosql">NoSQL</a><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E9%94%AE-%E5%80%BC%E5%AD%98%E5%82%A8">Key-value 存储</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%96%87%E6%A1%A3%E7%B1%BB%E5%9E%8B%E5%AD%98%E5%82%A8">文档存储</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%88%97%E5%9E%8B%E5%AD%98%E5%82%A8">宽列存储</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%9B%BE%E6%95%B0%E6%8D%AE%E5%BA%93">图数据库</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#sql-%E8%BF%98%E6%98%AF-nosql">SQL 还是 NoSQL</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E7%BC%93%E5%AD%98">缓存</a><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%BC%93%E5%AD%98">客户端缓存</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#cdn-%E7%BC%93%E5%AD%98">CDN 缓存</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#web-%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BC%93%E5%AD%98">Web 服务器缓存</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%95%B0%E6%8D%AE%E5%BA%93%E7%BC%93%E5%AD%98">数据库缓存</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%BA%94%E7%94%A8%E7%BC%93%E5%AD%98">应用缓存</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9F%A5%E8%AF%A2%E7%BA%A7%E5%88%AB%E7%9A%84%E7%BC%93%E5%AD%98">数据库查询级别的缓存</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%AF%B9%E8%B1%A1%E7%BA%A7%E5%88%AB%E7%9A%84%E7%BC%93%E5%AD%98">对象级别的缓存</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E4%BD%95%E6%97%B6%E6%9B%B4%E6%96%B0%E7%BC%93%E5%AD%98">何时更新缓存</a><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E7%BC%93%E5%AD%98%E6%A8%A1%E5%BC%8F">缓存模式</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E7%9B%B4%E5%86%99%E6%A8%A1%E5%BC%8F">直写模式</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%9B%9E%E5%86%99%E6%A8%A1%E5%BC%8F">回写模式</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%88%B7%E6%96%B0">刷新</a></li>
</ul>
</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%BC%82%E6%AD%A5">异步</a><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97">消息队列</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97">任务队列</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%83%8C%E5%8E%8B">背压机制</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E9%80%9A%E8%AE%AF">通讯</a><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E4%BC%A0%E8%BE%93%E6%8E%A7%E5%88%B6%E5%8D%8F%E8%AE%AEtcp">传输控制协议（TCP）</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E7%94%A8%E6%88%B7%E6%95%B0%E6%8D%AE%E6%8A%A5%E5%8D%8F%E8%AE%AEudp">用户数据报协议（UDP）</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%BF%9C%E7%A8%8B%E8%BF%87%E7%A8%8B%E8%B0%83%E7%94%A8%E5%8D%8F%E8%AE%AErpc">远程控制调用协议（RPC）</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%A1%A8%E8%BF%B0%E6%80%A7%E7%8A%B6%E6%80%81%E8%BD%AC%E7%A7%BBrest">表述性状态转移（REST）</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%AE%89%E5%85%A8">安全</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E9%99%84%E5%BD%95">附录</a><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#2-%E7%9A%84%E6%AC%A1%E6%96%B9%E8%A1%A8">2 的次方表</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%AF%8F%E4%B8%AA%E7%A8%8B%E5%BA%8F%E5%91%98%E9%83%BD%E5%BA%94%E8%AF%A5%E7%9F%A5%E9%81%93%E7%9A%84%E5%BB%B6%E8%BF%9F%E6%95%B0">每个程序员都应该知道的延迟数</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%85%B6%E5%AE%83%E7%9A%84%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E9%9D%A2%E8%AF%95%E9%A2%98">其它的系统设计面试题</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E7%9C%9F%E5%AE%9E%E6%9E%B6%E6%9E%84">真实架构</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%85%AC%E5%8F%B8%E7%9A%84%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84">公司的系统架构</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%85%AC%E5%8F%B8%E5%B7%A5%E7%A8%8B%E5%8D%9A%E5%AE%A2">公司工程博客</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%AD%A3%E5%9C%A8%E5%AE%8C%E5%96%84%E4%B8%AD">正在完善中</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%87%B4%E8%B0%A2">致谢</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%81%94%E7%B3%BB%E6%96%B9%E5%BC%8F">联系方式</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%AE%B8%E5%8F%AF">许可</a></li>
</ul>
<h2 id="学习指引"><a href="#学习指引" class="headerlink" title="学习指引"></a>学习指引</h2><blockquote>
<p>基于你面试的时间线（短、中、长）去复习那些推荐的主题。</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/images/OfVllex.png"><img src="https://github.com/donnemartin/system-design-primer/raw/master/images/OfVllex.png#align=left&display=inline&height=906&margin=%5Bobject%20Object%5D&originHeight=906&originWidth=1128&status=done&style=none&width=1128"></a><br><strong>问：对于面试来说，我需要知道这里的所有知识点吗？</strong><br><strong>答：不，如果只是为了准备面试的话，你并不需要知道所有的知识点。</strong><br>在一场面试中你会被问到什么取决于下面这些因素：</p>
<ul>
<li>你的经验</li>
<li>你的技术背景</li>
<li>你面试的职位</li>
<li>你面试的公司</li>
<li>运气</li>
</ul>
<p>那些有经验的候选人通常会被期望了解更多的系统设计的知识。架构师或者团队负责人则会被期望了解更多除了个人贡献之外的知识。顶级的科技公司通常也会有一次或者更多的系统设计面试。<br>面试会很宽泛的展开并在几个领域深入。这会帮助你了解一些关于系统设计的不同的主题。基于你的时间线，经验，面试的职位和面试的公司对下面的指导做出适当的调整。</p>
<ul>
<li><strong>短期</strong> - 以系统设计主题的<strong>广度</strong>为目标。通过解决<strong>一些</strong>面试题来练习。</li>
<li><strong>中期</strong> - 以系统设计主题的<strong>广度</strong>和<strong>初级深度</strong>为目标。通过解决<strong>很多</strong>面试题来练习。</li>
<li><strong>长期</strong> - 以系统设计主题的<strong>广度</strong>和<strong>高级深度</strong>为目标。通过解决<strong>大部分</strong>面试题来练习。<table>
<thead>
<tr>
<th></th>
<th>短期</th>
<th>中期</th>
<th>长期</th>
</tr>
</thead>
<tbody><tr>
<td>阅读 <a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E4%B8%BB%E9%A2%98%E7%9A%84%E7%B4%A2%E5%BC%95">系统设计主题</a> 以获得一个关于系统如何工作的宽泛的认识</td>
<td>👍</td>
<td>👍</td>
<td>👍</td>
</tr>
<tr>
<td>阅读一些你要面试的<a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%85%AC%E5%8F%B8%E5%B7%A5%E7%A8%8B%E5%8D%9A%E5%AE%A2">公司工程博客</a>的文章</td>
<td>👍</td>
<td>👍</td>
<td>👍</td>
</tr>
<tr>
<td>阅读 <a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E7%9C%9F%E5%AE%9E%E6%9E%B6%E6%9E%84">真实架构</a></td>
<td>👍</td>
<td>👍</td>
<td>👍</td>
</tr>
<tr>
<td>复习 <a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E4%B8%80%E4%B8%AA%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E9%9D%A2%E8%AF%95%E9%A2%98">如何处理一个系统设计面试题</a></td>
<td>👍</td>
<td>👍</td>
<td>👍</td>
</tr>
<tr>
<td>完成 <a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E7%9A%84%E9%9D%A2%E8%AF%95%E9%A2%98%E5%92%8C%E8%A7%A3%E7%AD%94">系统设计的面试题和解答</a></td>
<td>一些</td>
<td>很多</td>
<td>大部分</td>
</tr>
<tr>
<td>完成 <a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%AE%BE%E8%AE%A1%E7%9A%84%E9%9D%A2%E8%AF%95%E9%97%AE%E9%A2%98%E5%8F%8A%E8%A7%A3%E7%AD%94">面向对象设计的面试题和解答</a></td>
<td>一些</td>
<td>很多</td>
<td>大部分</td>
</tr>
<tr>
<td>复习 <a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%85%B6%E5%AE%83%E7%9A%84%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E9%9D%A2%E8%AF%95%E9%A2%98">其它的系统设计面试题</a></td>
<td>一些</td>
<td>很多</td>
<td>大部分</td>
</tr>
</tbody></table>
</li>
</ul>
<h2 id="如何处理一个系统设计的面试题"><a href="#如何处理一个系统设计的面试题" class="headerlink" title="如何处理一个系统设计的面试题"></a>如何处理一个系统设计的面试题</h2><p>系统设计面试是一个<strong>开放式的对话</strong>。他们期望你去主导这个对话。<br>你可以使用下面的步骤来指引讨论。为了巩固这个过程，请使用下面的步骤完成<a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E7%9A%84%E9%9D%A2%E8%AF%95%E9%A2%98%E5%92%8C%E8%A7%A3%E7%AD%94">系统设计的面试题和解答</a>这个章节。</p>
<h3 id="第一步：描述使用场景，约束和假设"><a href="#第一步：描述使用场景，约束和假设" class="headerlink" title="第一步：描述使用场景，约束和假设"></a>第一步：描述使用场景，约束和假设</h3><p>把所有需要的东西聚集在一起，审视问题。不停的提问，以至于我们可以明确使用场景和约束。讨论假设。</p>
<ul>
<li>谁会使用它？</li>
<li>他们会怎样使用它？</li>
<li>有多少用户？</li>
<li>系统的作用是什么？</li>
<li>系统的输入输出分别是什么？</li>
<li>我们希望处理多少数据？</li>
<li>我们希望每秒钟处理多少请求？</li>
<li>我们希望的读写比率？</li>
</ul>
<h3 id="第二步：创造一个高层级的设计"><a href="#第二步：创造一个高层级的设计" class="headerlink" title="第二步：创造一个高层级的设计"></a>第二步：创造一个高层级的设计</h3><p>使用所有重要的组件来描绘出一个高层级的设计。</p>
<ul>
<li>画出主要的组件和连接</li>
<li>证明你的想法</li>
</ul>
<h3 id="第三步：设计核心组件"><a href="#第三步：设计核心组件" class="headerlink" title="第三步：设计核心组件"></a>第三步：设计核心组件</h3><p>对每一个核心组件进行详细深入的分析。举例来说，如果你被问到<a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/solutions/system_design/pastebin/README.md">设计一个 url 缩写服务</a>，开始讨论：</p>
<ul>
<li>生成并储存一个完整 url 的 hash<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/solutions/system_design/pastebin/README.md">MD5</a> 和 <a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/solutions/system_design/pastebin/README.md">Base62</a></li>
<li>Hash 碰撞</li>
<li>SQL 还是 NoSQL</li>
<li>数据库模型</li>
</ul>
</li>
<li>将一个 hashed url 翻译成完整的 url<ul>
<li>数据库查找</li>
</ul>
</li>
<li>API 和面向对象设计</li>
</ul>
<h3 id="第四步：扩展设计"><a href="#第四步：扩展设计" class="headerlink" title="第四步：扩展设计"></a>第四步：扩展设计</h3><p>确认和处理瓶颈以及一些限制。举例来说就是你需要下面的这些来完成扩展性的议题吗？</p>
<ul>
<li>负载均衡</li>
<li>水平扩展</li>
<li>缓存</li>
<li>数据库分片</li>
</ul>
<p>论述可能的解决办法和代价。每件事情需要取舍。可以使用<a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E4%B8%BB%E9%A2%98%E7%9A%84%E7%B4%A2%E5%BC%95">可扩展系统的设计原则</a>来处理瓶颈。</p>
<h3 id="预估计算量"><a href="#预估计算量" class="headerlink" title="预估计算量"></a>预估计算量</h3><p>你或许会被要求通过手算进行一些估算。<a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E9%99%84%E5%BD%95">附录</a>涉及到的是下面的这些资源：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://highscalability.com/blog/2011/1/26/google-pro-tip-use-back-of-the-envelope-calculations-to-choo.html">使用预估计算量</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#2-%E7%9A%84%E6%AC%A1%E6%96%B9%E8%A1%A8">2 的次方表</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%AF%8F%E4%B8%AA%E7%A8%8B%E5%BA%8F%E5%91%98%E9%83%BD%E5%BA%94%E8%AF%A5%E7%9F%A5%E9%81%93%E7%9A%84%E5%BB%B6%E8%BF%9F%E6%95%B0">每个程序员都应该知道的延迟数</a></li>
</ul>
<h3 id="相关资源和延伸阅读"><a href="#相关资源和延伸阅读" class="headerlink" title="相关资源和延伸阅读"></a>相关资源和延伸阅读</h3><p>查看下面的链接以获得我们期望的更好的想法：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.palantir.com/2011/10/how-to-rock-a-systems-design-interview/">怎样通过一个系统设计的面试</a></li>
<li><a target="_blank" rel="noopener" href="http://www.hiredintech.com/system-design">系统设计的面试</a></li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=ZgdS0EUmn70">系统架构与设计的面试简介</a></li>
</ul>
<h2 id="系统设计的面试题和解答"><a href="#系统设计的面试题和解答" class="headerlink" title="系统设计的面试题和解答"></a>系统设计的面试题和解答</h2><blockquote>
<p>普通的系统设计面试题和相关事例的论述，代码和图表。<br>与内容有关的解答在 <code>solutions/</code> 文件夹中。</p>
</blockquote>
<table>
<thead>
<tr>
<th>问题</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>设计 Pastebin.com (或者 Bit.ly)</td>
<td><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/solutions/system_design/pastebin/README-zh-Hans.md">解答</a></td>
</tr>
<tr>
<td>设计 Twitter 时间线和搜索 (或者 Facebook feed 和搜索)</td>
<td><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/solutions/system_design/twitter/README.md">解答</a></td>
</tr>
<tr>
<td>设计一个网页爬虫</td>
<td><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/solutions/system_design/web_crawler/README.md">解答</a></td>
</tr>
<tr>
<td>设计 Mint.com</td>
<td><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/solutions/system_design/mint/README.md">解答</a></td>
</tr>
<tr>
<td>为一个社交网络设计数据结构</td>
<td><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/solutions/system_design/social_graph/README.md">解答</a></td>
</tr>
<tr>
<td>为搜索引擎设计一个 key-value 储存</td>
<td><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/solutions/system_design/query_cache/README.md">解答</a></td>
</tr>
<tr>
<td>通过分类特性设计 Amazon 的销售排名</td>
<td><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/solutions/system_design/sales_rank/README.md">解答</a></td>
</tr>
<tr>
<td>在 AWS 上设计一个百万用户级别的系统</td>
<td><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/solutions/system_design/scaling_aws/README.md">解答</a></td>
</tr>
<tr>
<td>添加一个系统设计问题</td>
<td><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%B4%A1%E7%8C%AE">贡献</a></td>
</tr>
</tbody></table>
<h3 id="设计-Pastebin-com-或者-Bit-ly"><a href="#设计-Pastebin-com-或者-Bit-ly" class="headerlink" title="设计 Pastebin.com (或者 Bit.ly)"></a>设计 Pastebin.com (或者 Bit.ly)</h3><p><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/solutions/system_design/pastebin/README.md">查看实践与解答</a><br><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/images/4edXG0T.png"><img src="https://github.com/donnemartin/system-design-primer/raw/master/images/4edXG0T.png#align=left&display=inline&height=1360&margin=%5Bobject%20Object%5D&originHeight=1360&originWidth=936&status=done&style=none&width=936"></a></p>
<h3 id="设计-Twitter-时间线和搜索-或者-Facebook-feed-和搜索"><a href="#设计-Twitter-时间线和搜索-或者-Facebook-feed-和搜索" class="headerlink" title="设计 Twitter 时间线和搜索 (或者 Facebook feed 和搜索)"></a>设计 Twitter 时间线和搜索 (或者 Facebook feed 和搜索)</h3><p><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/solutions/system_design/twitter/README.md">查看实践与解答</a><br><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/images/jrUBAF7.png"><img src="https://github.com/donnemartin/system-design-primer/raw/master/images/jrUBAF7.png#align=left&display=inline&height=1390&margin=%5Bobject%20Object%5D&originHeight=1390&originWidth=1348&status=done&style=none&width=1348"></a></p>
<h3 id="设计一个网页爬虫"><a href="#设计一个网页爬虫" class="headerlink" title="设计一个网页爬虫"></a>设计一个网页爬虫</h3><p><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/solutions/system_design/web_crawler/README.md">查看实践与解答</a><br><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/images/bWxPtQA.png"><img src="https://github.com/donnemartin/system-design-primer/raw/master/images/bWxPtQA.png#align=left&display=inline&height=1304&margin=%5Bobject%20Object%5D&originHeight=1304&originWidth=1078&status=done&style=none&width=1078"></a></p>
<h3 id="设计-Mint-com"><a href="#设计-Mint-com" class="headerlink" title="设计 Mint.com"></a>设计 Mint.com</h3><p><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/solutions/system_design/mint/README.md">查看实践与解答</a><br><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/images/V5q57vU.png"><img src="https://github.com/donnemartin/system-design-primer/raw/master/images/V5q57vU.png#align=left&display=inline&height=1332&margin=%5Bobject%20Object%5D&originHeight=1332&originWidth=1308&status=done&style=none&width=1308"></a></p>
<h3 id="为一个社交网络设计数据结构"><a href="#为一个社交网络设计数据结构" class="headerlink" title="为一个社交网络设计数据结构"></a>为一个社交网络设计数据结构</h3><p><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/solutions/system_design/social_graph/README.md">查看实践与解答</a><br><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/images/cdCv5g7.png"><img src="https://github.com/donnemartin/system-design-primer/raw/master/images/cdCv5g7.png#align=left&display=inline&height=1042&margin=%5Bobject%20Object%5D&originHeight=1042&originWidth=774&status=done&style=none&width=774"></a></p>
<h3 id="为搜索引擎设计一个-key-value-储存"><a href="#为搜索引擎设计一个-key-value-储存" class="headerlink" title="为搜索引擎设计一个 key-value 储存"></a>为搜索引擎设计一个 key-value 储存</h3><p><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/solutions/system_design/query_cache/README.md">查看实践与解答</a><br><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/images/4j99mhe.png"><img src="https://github.com/donnemartin/system-design-primer/raw/master/images/4j99mhe.png#align=left&display=inline&height=1096&margin=%5Bobject%20Object%5D&originHeight=1096&originWidth=542&status=done&style=none&width=542"></a></p>
<h3 id="设计按类别分类的-Amazon-销售排名"><a href="#设计按类别分类的-Amazon-销售排名" class="headerlink" title="设计按类别分类的 Amazon 销售排名"></a>设计按类别分类的 Amazon 销售排名</h3><p><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/solutions/system_design/sales_rank/README.md">查看实践与解答</a><br><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/images/MzExP06.png"><img src="https://github.com/donnemartin/system-design-primer/raw/master/images/MzExP06.png#align=left&display=inline&height=1376&margin=%5Bobject%20Object%5D&originHeight=1376&originWidth=924&status=done&style=none&width=924"></a></p>
<h3 id="在-AWS-上设计一个百万用户级别的系统"><a href="#在-AWS-上设计一个百万用户级别的系统" class="headerlink" title="在 AWS 上设计一个百万用户级别的系统"></a>在 AWS 上设计一个百万用户级别的系统</h3><p><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/solutions/system_design/scaling_aws/README.md">查看实践与解答</a><br><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/images/jj3A5N8.png"><img src="https://github.com/donnemartin/system-design-primer/raw/master/images/jj3A5N8.png#align=left&display=inline&height=1666&margin=%5Bobject%20Object%5D&originHeight=1666&originWidth=1234&status=done&style=none&width=1234"></a></p>
<h2 id="面向对象设计的面试问题及解答"><a href="#面向对象设计的面试问题及解答" class="headerlink" title="面向对象设计的面试问题及解答"></a>面向对象设计的面试问题及解答</h2><blockquote>
<p>常见面向对象设计面试问题及实例讨论，代码和图表演示。<br>与内容相关的解决方案在 <code>solutions/</code> 文件夹中。<br><strong>注：此节还在完善中</strong></p>
</blockquote>
<table>
<thead>
<tr>
<th>问题</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>设计 hash map</td>
<td><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/solutions/object_oriented_design/hash_table/hash_map.ipynb">解决方案</a></td>
</tr>
<tr>
<td>设计 LRU 缓存</td>
<td><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/solutions/object_oriented_design/lru_cache/lru_cache.ipynb">解决方案</a></td>
</tr>
<tr>
<td>设计一个呼叫中心</td>
<td><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/solutions/object_oriented_design/call_center/call_center.ipynb">解决方案</a></td>
</tr>
<tr>
<td>设计一副牌</td>
<td><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/solutions/object_oriented_design/deck_of_cards/deck_of_cards.ipynb">解决方案</a></td>
</tr>
<tr>
<td>设计一个停车场</td>
<td><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/solutions/object_oriented_design/parking_lot/parking_lot.ipynb">解决方案</a></td>
</tr>
<tr>
<td>设计一个聊天服务</td>
<td><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/solutions/object_oriented_design/online_chat/online_chat.ipynb">解决方案</a></td>
</tr>
<tr>
<td>设计一个环形数组</td>
<td><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%B4%A1%E7%8C%AE">待解决</a></td>
</tr>
<tr>
<td>添加一个面向对象设计问题</td>
<td><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%B4%A1%E7%8C%AE">待解决</a></td>
</tr>
</tbody></table>
<h2 id="系统设计主题：从这里开始"><a href="#系统设计主题：从这里开始" class="headerlink" title="系统设计主题：从这里开始"></a>系统设计主题：从这里开始</h2><p>不熟悉系统设计？<br>首先，你需要对一般性原则有一个基本的认识，知道它们是什么，怎样使用以及利弊。</p>
<h3 id="第一步：回顾可扩展性（scalability）的视频讲座"><a href="#第一步：回顾可扩展性（scalability）的视频讲座" class="headerlink" title="第一步：回顾可扩展性（scalability）的视频讲座"></a>第一步：回顾可扩展性（scalability）的视频讲座</h3><p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=-W9F__D3oY4">哈佛大学可扩展性讲座</a></p>
<ul>
<li>主题涵盖<ul>
<li>垂直扩展（Vertical scaling）</li>
<li>水平扩展（Horizontal scaling）</li>
<li>缓存</li>
<li>负载均衡</li>
<li>数据库复制</li>
<li>数据库分区</li>
</ul>
</li>
</ul>
<h3 id="第二步：回顾可扩展性文章"><a href="#第二步：回顾可扩展性文章" class="headerlink" title="第二步：回顾可扩展性文章"></a>第二步：回顾可扩展性文章</h3><p><a target="_blank" rel="noopener" href="http://www.lecloud.net/tagged/scalability/chrono">可扩展性</a></p>
<ul>
<li>主题涵盖：<ul>
<li><a target="_blank" rel="noopener" href="http://www.lecloud.net/post/7295452622/scalability-for-dummies-part-1-clones">Clones</a></li>
<li><a target="_blank" rel="noopener" href="http://www.lecloud.net/post/7994751381/scalability-for-dummies-part-2-database">数据库</a></li>
<li><a target="_blank" rel="noopener" href="http://www.lecloud.net/post/9246290032/scalability-for-dummies-part-3-cache">缓存</a></li>
<li><a target="_blank" rel="noopener" href="http://www.lecloud.net/post/9699762917/scalability-for-dummies-part-4-asynchronism">异步</a></li>
</ul>
</li>
</ul>
<h3 id="接下来的步骤"><a href="#接下来的步骤" class="headerlink" title="接下来的步骤"></a>接下来的步骤</h3><p>接下来，我们将看看高阶的权衡和取舍:</p>
<ul>
<li><strong>性能</strong>与<strong>可扩展性</strong></li>
<li><strong>延迟</strong>与<strong>吞吐量</strong></li>
<li><strong>可用性</strong>与<strong>一致性</strong></li>
</ul>
<p>记住<strong>每个方面都面临取舍和权衡</strong>。<br>然后，我们将深入更具体的主题，如 DNS、CDN 和负载均衡器。</p>
<h2 id="性能与可扩展性"><a href="#性能与可扩展性" class="headerlink" title="性能与可扩展性"></a>性能与可扩展性</h2><p>如果服务<strong>性能</strong>的增长与资源的增加是成比例的，服务就是可扩展的。通常，提高性能意味着服务于更多的工作单元，另一方面，当数据集增长时，同样也可以处理更大的工作单位。<a target="_blank" rel="noopener" href="http://www.allthingsdistributed.com/2006/03/a_word_on_scalability.html">1</a><br>另一个角度来看待性能与可扩展性:</p>
<ul>
<li>如果你的系统有<strong>性能</strong>问题，对于单个用户来说是缓慢的。</li>
<li>如果你的系统有<strong>可扩展性</strong>问题，单个用户较快但在高负载下会变慢。</li>
</ul>
<h3 id="来源及延伸阅读"><a href="#来源及延伸阅读" class="headerlink" title="来源及延伸阅读"></a>来源及延伸阅读</h3><ul>
<li><a target="_blank" rel="noopener" href="http://www.allthingsdistributed.com/2006/03/a_word_on_scalability.html">简单谈谈可扩展性</a></li>
<li><a target="_blank" rel="noopener" href="http://www.slideshare.net/jboner/scalability-availability-stability-patterns/">可扩展性，可用性，稳定性和模式</a></li>
</ul>
<h2 id="延迟与吞吐量"><a href="#延迟与吞吐量" class="headerlink" title="延迟与吞吐量"></a>延迟与吞吐量</h2><p><strong>延迟</strong>是执行操作或运算结果所花费的时间。<br><strong>吞吐量</strong>是单位时间内（执行）此类操作或运算的数量。<br>通常，你应该以<strong>可接受级延迟</strong>下<strong>最大化吞吐量</strong>为目标。</p>
<h3 id="来源及延伸阅读-1"><a href="#来源及延伸阅读-1" class="headerlink" title="来源及延伸阅读"></a>来源及延伸阅读</h3><ul>
<li><a target="_blank" rel="noopener" href="https://community.cadence.com/cadence_blogs_8/b/sd/archive/2010/09/13/understanding-latency-vs-throughput">理解延迟与吞吐量</a></li>
</ul>
<h2 id="可用性与一致性"><a href="#可用性与一致性" class="headerlink" title="可用性与一致性"></a>可用性与一致性</h2><h3 id="CAP-理论"><a href="#CAP-理论" class="headerlink" title="CAP 理论"></a>CAP 理论</h3><p><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/images/bgLMI2u.png"><img src="https://github.com/donnemartin/system-design-primer/raw/master/images/bgLMI2u.png#align=left&display=inline&height=303&margin=%5Bobject%20Object%5D&originHeight=303&originWidth=500&status=done&style=none&width=500"></a><br><strong><a target="_blank" rel="noopener" href="http://robertgreiner.com/2014/08/cap-theorem-revisited">来源：再看 CAP 理论</a></strong><br>在一个分布式计算系统中，只能同时满足下列的两点:</p>
<ul>
<li><strong>一致性</strong> ─ 每次访问都能获得最新数据但可能会收到错误响应</li>
<li><strong>可用性</strong> ─ 每次访问都能收到非错响应，但不保证获取到最新数据</li>
<li><strong>分区容错性</strong> ─ 在任意分区网络故障的情况下系统仍能继续运行</li>
</ul>
<p><strong>网络并不可靠，所以你应要支持分区容错性，并需要在软件可用性和一致性间做出取舍。</strong></p>
<h4 id="CP-─-一致性和分区容错性"><a href="#CP-─-一致性和分区容错性" class="headerlink" title="CP ─ 一致性和分区容错性"></a>CP ─ 一致性和分区容错性</h4><p>等待分区节点的响应可能会导致延时错误。如果你的业务需求需要原子读写，CP 是一个不错的选择。</p>
<h4 id="AP-─-可用性与分区容错性"><a href="#AP-─-可用性与分区容错性" class="headerlink" title="AP ─ 可用性与分区容错性"></a>AP ─ 可用性与分区容错性</h4><p>响应节点上可用数据的最近版本可能并不是最新的。当分区解析完后，写入（操作）可能需要一些时间来传播。<br>如果业务需求允许<a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7">最终一致性</a>，或当有外部故障时要求系统继续运行，AP 是一个不错的选择。</p>
<h3 id="来源及延伸阅读-2"><a href="#来源及延伸阅读-2" class="headerlink" title="来源及延伸阅读"></a>来源及延伸阅读</h3><ul>
<li><a target="_blank" rel="noopener" href="http://robertgreiner.com/2014/08/cap-theorem-revisited/">再看 CAP 理论</a></li>
<li><a target="_blank" rel="noopener" href="http://ksat.me/a-plain-english-introduction-to-cap-theorem/">通俗易懂地介绍 CAP 理论</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/henryr/cap-faq">CAP FAQ</a></li>
</ul>
<h2 id="一致性模式"><a href="#一致性模式" class="headerlink" title="一致性模式"></a>一致性模式</h2><p>有同一份数据的多份副本，我们面临着怎样同步它们的选择，以便让客户端有一致的显示数据。回想 <a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#cap-%E7%90%86%E8%AE%BA">CAP 理论</a>中的一致性定义 ─ 每次访问都能获得最新数据但可能会收到错误响应</p>
<h3 id="弱一致性"><a href="#弱一致性" class="headerlink" title="弱一致性"></a>弱一致性</h3><p>在写入之后，访问可能看到，也可能看不到（写入数据）。尽力优化之让其能访问最新数据。<br>这种方式可以 memcached 等系统中看到。弱一致性在 VoIP，视频聊天和实时多人游戏等真实用例中表现不错。打个比方，如果你在通话中丢失信号几秒钟时间，当重新连接时你是听不到这几秒钟所说的话的。</p>
<h3 id="最终一致性"><a href="#最终一致性" class="headerlink" title="最终一致性"></a>最终一致性</h3><p>在写入后，访问最终能看到写入数据（通常在数毫秒内）。数据被异步复制。<br>DNS 和 email 等系统使用的是此种方式。最终一致性在高可用性系统中效果不错。</p>
<h3 id="强一致性"><a href="#强一致性" class="headerlink" title="强一致性"></a>强一致性</h3><p>在写入后，访问立即可见。数据被同步复制。<br>文件系统和关系型数据库（RDBMS）中使用的是此种方式。强一致性在需要记录的系统中运作良好。</p>
<h3 id="来源及延伸阅读-3"><a href="#来源及延伸阅读-3" class="headerlink" title="来源及延伸阅读"></a>来源及延伸阅读</h3><ul>
<li><a target="_blank" rel="noopener" href="http://snarfed.org/transactions_across_datacenters_io.html">Transactions across data centers</a></li>
</ul>
<h2 id="可用性模式"><a href="#可用性模式" class="headerlink" title="可用性模式"></a>可用性模式</h2><p>有两种支持高可用性的模式: <strong>故障切换（fail-over）和复制（replication）</strong>。</p>
<h3 id="故障切换"><a href="#故障切换" class="headerlink" title="故障切换"></a>故障切换</h3><h4 id="工作到备用切换（Active-passive）"><a href="#工作到备用切换（Active-passive）" class="headerlink" title="工作到备用切换（Active-passive）"></a>工作到备用切换（Active-passive）</h4><p>关于工作到备用的故障切换流程是，工作服务器发送周期信号给待机中的备用服务器。如果周期信号中断，备用服务器切换成工作服务器的 IP 地址并恢复服务。<br>宕机时间取决于备用服务器处于“热”待机状态还是需要从“冷”待机状态进行启动。只有工作服务器处理流量。<br>工作到备用的故障切换也被称为主从切换。</p>
<h4 id="双工作切换（Active-active）"><a href="#双工作切换（Active-active）" class="headerlink" title="双工作切换（Active-active）"></a>双工作切换（Active-active）</h4><p>在双工作切换中，双方都在管控流量，在它们之间分散负载。<br>如果是外网服务器，DNS 将需要对两方都了解。如果是内网服务器，应用程序逻辑将需要对两方都了解。<br>双工作切换也可以称为主主切换。</p>
<h3 id="缺陷：故障切换"><a href="#缺陷：故障切换" class="headerlink" title="缺陷：故障切换"></a>缺陷：故障切换</h3><ul>
<li>故障切换需要添加额外硬件并增加复杂性。</li>
<li>如果新写入数据在能被复制到备用系统之前，工作系统出现了故障，则有可能会丢失数据。</li>
</ul>
<h3 id="复制"><a href="#复制" class="headerlink" title="复制"></a>复制</h3><h4 id="主-─-从复制和主-─-主复制"><a href="#主-─-从复制和主-─-主复制" class="headerlink" title="主 ─ 从复制和主 ─ 主复制"></a>主 ─ 从复制和主 ─ 主复制</h4><p>这个主题进一步探讨了<a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%95%B0%E6%8D%AE%E5%BA%93">数据库</a>部分:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6">主 ─ 从复制</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E4%B8%BB%E4%B8%BB%E5%A4%8D%E5%88%B6">主 ─ 主复制</a></li>
</ul>
<h2 id="域名系统"><a href="#域名系统" class="headerlink" title="域名系统"></a>域名系统</h2><p><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/images/IOyLj4i.jpg"><img src="https://github.com/donnemartin/system-design-primer/raw/master/images/IOyLj4i.jpg#align=left&display=inline&height=449&margin=%5Bobject%20Object%5D&originHeight=449&originWidth=638&status=done&style=none&width=638"></a><br><strong><a target="_blank" rel="noopener" href="http://www.slideshare.net/srikrupa5/dns-security-presentation-issa">来源：DNS 安全介绍</a></strong><br>域名系统是把 <a target="_blank" rel="noopener" href="http://www.example.com/">www.example.com</a> 等域名转换成 IP 地址。<br>域名系统是分层次的，一些 DNS 服务器位于顶层。当查询（域名） IP 时，路由或 ISP 提供连接 DNS 服务器的信息。较底层的 DNS 服务器缓存映射，它可能会因为 DNS 传播延时而失效。DNS 结果可以缓存在浏览器或操作系统中一段时间，时间长短取决于<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Time_to_live">存活时间 TTL</a>。</p>
<ul>
<li><strong>NS 记录（域名服务）</strong> ─ 指定解析域名或子域名的 DNS 服务器。</li>
<li><strong>MX 记录（邮件交换）</strong> ─ 指定接收信息的邮件服务器。</li>
<li><strong>A 记录（地址）</strong> ─ 指定域名对应的 IP 地址记录。</li>
<li><strong>CNAME（规范）</strong> ─ 一个域名映射到另一个域名或 <code>CNAME</code> 记录（ example.com 指向 <a target="_blank" rel="noopener" href="http://www.example.com/">www.example.com</a> ）或映射到一个 <code>A</code> 记录。</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.cloudflare.com/dns/">CloudFlare</a> 和 <a target="_blank" rel="noopener" href="https://aws.amazon.com/route53/">Route 53</a> 等平台提供管理 DNS 的功能。某些 DNS 服务通过集中方式来路由流量:</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://g33kinfo.com/info/archives/2657">加权轮询调度</a><ul>
<li>防止流量进入维护中的服务器</li>
<li>在不同大小集群间负载均衡</li>
<li>A/B 测试</li>
</ul>
</li>
<li>基于延迟路由</li>
<li>基于地理位置路由</li>
</ul>
<h3 id="缺陷-DNS"><a href="#缺陷-DNS" class="headerlink" title="缺陷:DNS"></a>缺陷:DNS</h3><ul>
<li>虽说缓存可以减轻 DNS 延迟，但连接 DNS 服务器还是带来了轻微的延迟。</li>
<li>虽然它们通常由<a target="_blank" rel="noopener" href="http://superuser.com/questions/472695/who-controls-the-dns-servers/472729">政府，网络服务提供商和大公司</a>管理，但 DNS 服务管理仍可能是复杂的。</li>
<li>DNS 服务最近遭受 <a target="_blank" rel="noopener" href="http://dyn.com/blog/dyn-analysis-summary-of-friday-october-21-attack/">DDoS 攻击</a>，阻止不知道 Twitter IP 地址的用户访问 Twitter。</li>
</ul>
<h3 id="来源及延伸阅读-4"><a href="#来源及延伸阅读-4" class="headerlink" title="来源及延伸阅读"></a>来源及延伸阅读</h3><ul>
<li><a target="_blank" rel="noopener" href="https://technet.microsoft.com/en-us/library/dd197427(v=ws.10).aspx">DNS 架构</a></li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Domain_Name_System">Wikipedia</a></li>
<li><a target="_blank" rel="noopener" href="https://support.dnsimple.com/categories/dns/">关于 DNS 的文章</a></li>
</ul>
<h2 id="内容分发网络（CDN）"><a href="#内容分发网络（CDN）" class="headerlink" title="内容分发网络（CDN）"></a>内容分发网络（CDN）</h2><p><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/images/h9TAuGI.jpg"><img src="https://github.com/donnemartin/system-design-primer/raw/master/images/h9TAuGI.jpg#align=left&display=inline&height=555&margin=%5Bobject%20Object%5D&originHeight=555&originWidth=1000&status=done&style=none&width=1000"></a><br><strong><a target="_blank" rel="noopener" href="https://www.creative-artworks.eu/why-use-a-content-delivery-network-cdn/">来源：为什么使用 CDN</a></strong><br>内容分发网络（CDN）是一个全球性的代理服务器分布式网络，它从靠近用户的位置提供内容。通常，HTML/CSS/JS，图片和视频等静态内容由 CDN 提供，虽然亚马逊 CloudFront 等也支持动态内容。CDN 的 DNS 解析会告知客户端连接哪台服务器。<br>将内容存储在 CDN 上可以从两个方面来提供性能:</p>
<ul>
<li>从靠近用户的数据中心提供资源</li>
<li>通过 CDN 你的服务器不必真的处理请求</li>
</ul>
<h3 id="CDN-推送（push）"><a href="#CDN-推送（push）" class="headerlink" title="CDN 推送（push）"></a>CDN 推送（push）</h3><p>当你服务器上内容发生变动时，推送 CDN 接受新内容。直接推送给 CDN 并重写 URL 地址以指向你的内容的 CDN 地址。你可以配置内容到期时间及何时更新。内容只有在更改或新增是才推送，流量最小化，但储存最大化。</p>
<h3 id="CDN-拉取（pull）"><a href="#CDN-拉取（pull）" class="headerlink" title="CDN 拉取（pull）"></a>CDN 拉取（pull）</h3><p>CDN 拉取是当第一个用户请求该资源时，从服务器上拉取资源。你将内容留在自己的服务器上并重写 URL 指向 CDN 地址。直到内容被缓存在 CDN 上为止，这样请求只会更慢，<br><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Time_to_live">存活时间（TTL）</a>决定缓存多久时间。CDN 拉取方式最小化 CDN 上的储存空间，但如果过期文件并在实际更改之前被拉取，则会导致冗余的流量。<br>高流量站点使用 CDN 拉取效果不错，因为只有最近请求的内容保存在 CDN 中，流量才能更平衡地分散。</p>
<h3 id="缺陷：CDN"><a href="#缺陷：CDN" class="headerlink" title="缺陷：CDN"></a>缺陷：CDN</h3><ul>
<li>CDN 成本可能因流量而异，可能在权衡之后你将不会使用 CDN。</li>
<li>如果在 TTL 过期之前更新内容，CDN 缓存内容可能会过时。</li>
<li>CDN 需要更改静态内容的 URL 地址以指向 CDN。</li>
</ul>
<h3 id="来源及延伸阅读-5"><a href="#来源及延伸阅读-5" class="headerlink" title="来源及延伸阅读"></a>来源及延伸阅读</h3><ul>
<li><a target="_blank" rel="noopener" href="http://repository.cmu.edu/cgi/viewcontent.cgi?article=2112&context=compsci">全球性内容分发网络</a></li>
<li><a target="_blank" rel="noopener" href="http://www.travelblogadvice.com/technical/the-differences-between-push-and-pull-cdns/">CDN 拉取和 CDN 推送的区别</a></li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Content_delivery_network">Wikipedia</a></li>
</ul>
<h2 id="负载均衡器"><a href="#负载均衡器" class="headerlink" title="负载均衡器"></a>负载均衡器</h2><p><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/images/h81n9iK.png"><img src="https://github.com/donnemartin/system-design-primer/raw/master/images/h81n9iK.png#align=left&display=inline&height=681&margin=%5Bobject%20Object%5D&originHeight=681&originWidth=1019&status=done&style=none&width=1019"></a><br><strong><a target="_blank" rel="noopener" href="http://horicky.blogspot.com/2010/10/scalable-system-design-patterns.html">来源：可扩展的系统设计模式</a></strong><br>负载均衡器将传入的请求分发到应用服务器和数据库等计算资源。无论哪种情况，负载均衡器将从计算资源来的响应返回给恰当的客户端。负载均衡器的效用在于:</p>
<ul>
<li>防止请求进入不好的服务器</li>
<li>防止资源过载</li>
<li>帮助消除单一的故障点</li>
</ul>
<p>负载均衡器可以通过硬件（昂贵）或 HAProxy 等软件来实现。 增加的好处包括:</p>
<ul>
<li><strong>SSL 终结</strong>─ 解密传入的请求并加密服务器响应，这样的话后端服务器就不必再执行这些潜在高消耗运算了。<ul>
<li>不需要再每台服务器上安装 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/X.509">X.509 证书</a>。</li>
</ul>
</li>
<li><strong>Session 留存</strong> ─ 如果 Web 应用程序不追踪会话，发出 cookie 并将特定客户端的请求路由到同一实例。</li>
</ul>
<p>通常会设置采用<a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%B7%A5%E4%BD%9C%E5%88%B0%E5%A4%87%E7%94%A8%E5%88%87%E6%8D%A2active-passive">工作 ─ 备用</a> 或 <a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%8F%8C%E5%B7%A5%E4%BD%9C%E5%88%87%E6%8D%A2active-active">双工作</a> 模式的多个负载均衡器，以免发生故障。<br>负载均衡器能基于多种方式来路由流量:</p>
<ul>
<li>随机</li>
<li>最少负载</li>
<li>Session/cookie</li>
<li><a target="_blank" rel="noopener" href="http://g33kinfo.com/info/archives/2657">轮询调度或加权轮询调度算法</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%9B%9B%E5%B1%82%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1">四层负载均衡</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E4%B8%83%E5%B1%82%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1">七层负载均衡</a></li>
</ul>
<h3 id="四层负载均衡"><a href="#四层负载均衡" class="headerlink" title="四层负载均衡"></a>四层负载均衡</h3><p>四层负载均衡根据监看<a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E9%80%9A%E8%AE%AF">传输层</a>的信息来决定如何分发请求。通常，这会涉及来源，目标 IP 地址和请求头中的端口，但不包括数据包（报文）内容。四层负载均衡执行<a target="_blank" rel="noopener" href="https://www.nginx.com/resources/glossary/layer-4-load-balancing/">网络地址转换（NAT）</a>来向上游服务器转发网络数据包。</p>
<h3 id="七层负载均衡器"><a href="#七层负载均衡器" class="headerlink" title="七层负载均衡器"></a>七层负载均衡器</h3><p>七层负载均衡器根据监控<a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E9%80%9A%E8%AE%AF">应用层</a>来决定怎样分发请求。这会涉及请求头的内容，消息和 cookie。七层负载均衡器终结网络流量，读取消息，做出负载均衡判定，然后传送给特定服务器。比如，一个七层负载均衡器能直接将视频流量连接到托管视频的服务器，同时将更敏感的用户账单流量引导到安全性更强的服务器。<br>以损失灵活性为代价，四层负载均衡比七层负载均衡花费更少时间和计算资源，虽然这对现代商用硬件的性能影响甚微。</p>
<h3 id="水平扩展"><a href="#水平扩展" class="headerlink" title="水平扩展"></a>水平扩展</h3><p>负载均衡器还能帮助水平扩展，提高性能和可用性。使用商业硬件的性价比更高，并且比在单台硬件上<strong>垂直扩展</strong>更贵的硬件具有更高的可用性。相比招聘特定企业系统人才，招聘商业硬件方面的人才更加容易。</p>
<h4 id="缺陷：水平扩展"><a href="#缺陷：水平扩展" class="headerlink" title="缺陷：水平扩展"></a>缺陷：水平扩展</h4><ul>
<li>水平扩展引入了复杂度并涉及服务器复制<ul>
<li>服务器应该是无状态的:它们也不该包含像 session 或资料图片等与用户关联的数据。</li>
<li>session 可以集中存储在数据库或持久化<a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E7%BC%93%E5%AD%98">缓存</a>（Redis、Memcached）的数据存储区中。</li>
</ul>
</li>
<li>缓存和数据库等下游服务器需要随着上游服务器进行扩展，以处理更多的并发连接。</li>
</ul>
<h3 id="缺陷：负载均衡器"><a href="#缺陷：负载均衡器" class="headerlink" title="缺陷：负载均衡器"></a>缺陷：负载均衡器</h3><ul>
<li>如果没有足够的资源配置或配置错误，负载均衡器会变成一个性能瓶颈。</li>
<li>引入负载均衡器以帮助消除单点故障但导致了额外的复杂性。</li>
<li>单个负载均衡器会导致单点故障，但配置多个负载均衡器会进一步增加复杂性。</li>
</ul>
<h3 id="来源及延伸阅读-6"><a href="#来源及延伸阅读-6" class="headerlink" title="来源及延伸阅读"></a>来源及延伸阅读</h3><ul>
<li><a target="_blank" rel="noopener" href="https://www.nginx.com/blog/inside-nginx-how-we-designed-for-performance-scale/">NGINX 架构</a></li>
<li><a target="_blank" rel="noopener" href="http://www.haproxy.org/download/1.2/doc/architecture.txt">HAProxy 架构指南</a></li>
<li><a target="_blank" rel="noopener" href="http://www.lecloud.net/post/7295452622/scalability-for-dummies-part-1-clones">可扩展性</a></li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Load_balancing_(computing)">Wikipedia</a></li>
<li><a target="_blank" rel="noopener" href="https://www.nginx.com/resources/glossary/layer-4-load-balancing/">四层负载平衡</a></li>
<li><a target="_blank" rel="noopener" href="https://www.nginx.com/resources/glossary/layer-7-load-balancing/">七层负载平衡</a></li>
<li><a target="_blank" rel="noopener" href="http://docs.aws.amazon.com/elasticloadbalancing/latest/classic/elb-listener-config.html">ELB 监听器配置</a></li>
</ul>
<h2 id="反向代理（web-服务器）"><a href="#反向代理（web-服务器）" class="headerlink" title="反向代理（web 服务器）"></a>反向代理（web 服务器）</h2><p><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/images/n41Azff.png"><img src="https://github.com/donnemartin/system-design-primer/raw/master/images/n41Azff.png#align=left&display=inline&height=161&margin=%5Bobject%20Object%5D&originHeight=161&originWidth=421&status=done&style=none&width=421"></a><br><strong><a target="_blank" rel="noopener" href="https://upload.wikimedia.org/wikipedia/commons/6/67/Reverse_proxy_h2g2bob.svg">资料来源：维基百科</a></strong><br>反向代理是一种可以集中地调用内部服务，并提供统一接口给公共客户的 web 服务器。来自客户端的请求先被反向代理服务器转发到可响应请求的服务器，然后代理再把服务器的响应结果返回给客户端。<br>带来的好处包括：</p>
<ul>
<li><strong>增加安全性</strong> - 隐藏后端服务器的信息，屏蔽黑名单中的 IP，限制每个客户端的连接数。</li>
<li><strong>提高可扩展性和灵活性</strong> - 客户端只能看到反向代理服务器的 IP，这使你可以增减服务器或者修改它们的配置。</li>
<li><strong>本地终结 SSL 会话</strong>- 解密传入请求，加密服务器响应，这样后端服务器就不必完成这些潜在的高成本的操作。<ul>
<li>免除了在每个服务器上安装 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/X.509">X.509</a> 证书的需要</li>
</ul>
</li>
<li><strong>压缩</strong> - 压缩服务器响应</li>
<li><strong>缓存</strong> - 直接返回命中的缓存结果</li>
<li><strong>静态内容</strong>- 直接提供静态内容<ul>
<li>HTML/CSS/JS</li>
<li>图片</li>
<li>视频</li>
<li>等等</li>
</ul>
</li>
</ul>
<h3 id="负载均衡器与反向代理"><a href="#负载均衡器与反向代理" class="headerlink" title="负载均衡器与反向代理"></a>负载均衡器与反向代理</h3><ul>
<li>当你有多个服务器时，部署负载均衡器非常有用。通常，负载均衡器将流量路由给一组功能相同的服务器上。</li>
<li>即使只有一台 web 服务器或者应用服务器时，反向代理也有用，可以参考上一节介绍的好处。</li>
<li>NGINX 和 HAProxy 等解决方案可以同时支持第七层反向代理和负载均衡。</li>
</ul>
<h3 id="不利之处：反向代理"><a href="#不利之处：反向代理" class="headerlink" title="不利之处：反向代理"></a>不利之处：反向代理</h3><ul>
<li>引入反向代理会增加系统的复杂度。</li>
<li>单独一个反向代理服务器仍可能发生单点故障，配置多台反向代理服务器（如<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Failover">故障转移</a>）会进一步增加复杂度。</li>
</ul>
<h3 id="来源及延伸阅读-7"><a href="#来源及延伸阅读-7" class="headerlink" title="来源及延伸阅读"></a>来源及延伸阅读</h3><ul>
<li><a target="_blank" rel="noopener" href="https://www.nginx.com/resources/glossary/reverse-proxy-vs-load-balancer/">反向代理与负载均衡</a></li>
<li><a target="_blank" rel="noopener" href="https://www.nginx.com/blog/inside-nginx-how-we-designed-for-performance-scale/">NGINX 架构</a></li>
<li><a target="_blank" rel="noopener" href="http://www.haproxy.org/download/1.2/doc/architecture.txt">HAProxy 架构指南</a></li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Reverse_proxy">Wikipedia</a></li>
</ul>
<h2 id="应用层"><a href="#应用层" class="headerlink" title="应用层"></a>应用层</h2><p><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/images/yB5SYwm.png"><img src="https://github.com/donnemartin/system-design-primer/raw/master/images/yB5SYwm.png#align=left&display=inline&height=300&margin=%5Bobject%20Object%5D&originHeight=300&originWidth=1000&status=done&style=none&width=1000"></a><br><strong><a target="_blank" rel="noopener" href="http://lethain.com/introduction-to-architecting-systems-for-scale/#platform_layer">资料来源：可缩放系统构架介绍</a></strong><br>将 Web 服务层与应用层（也被称作平台层）分离，可以独立缩放和配置这两层。添加新的 API 只需要添加应用服务器，而不必添加额外的 web 服务器。<br><strong>单一职责原则</strong>提倡小型的，自治的服务共同合作。小团队通过提供小型的服务，可以更激进地计划增长。<br>应用层中的工作进程也有可以实现<a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%BC%82%E6%AD%A5">异步化</a>。</p>
<h3 id="微服务"><a href="#微服务" class="headerlink" title="微服务"></a>微服务</h3><p>与此讨论相关的话题是 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Microservices">微服务</a>，可以被描述为一系列可以独立部署的小型的，模块化服务。每个服务运行在一个独立的线程中，通过明确定义的轻量级机制通讯，共同实现业务目标。<a target="_blank" rel="noopener" href="https://smartbear.com/learn/api-design/what-are-microservices">1</a><br>例如，Pinterest 可能有这些微服务： 用户资料、关注者、Feed 流、搜索、照片上传等。</p>
<h3 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h3><p>像 <a target="_blank" rel="noopener" href="https://www.consul.io/docs/index.html">Consul</a>，<a target="_blank" rel="noopener" href="https://coreos.com/etcd/docs/latest">Etcd</a> 和 <a target="_blank" rel="noopener" href="http://www.slideshare.net/sauravhaloi/introduction-to-apache-zookeeper">Zookeeper</a> 这样的系统可以通过追踪注册名、地址、端口等信息来帮助服务互相发现对方。<a target="_blank" rel="noopener" href="https://www.consul.io/intro/getting-started/checks.html">Health checks</a> 可以帮助确认服务的完整性和是否经常使用一个 <a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%B6%85%E6%96%87%E6%9C%AC%E4%BC%A0%E8%BE%93%E5%8D%8F%E8%AE%AEhttp">HTTP</a> 路径。Consul 和 Etcd 都有一个内建的 <a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E9%94%AE-%E5%80%BC%E5%AD%98%E5%82%A8">key-value 存储</a> 用来存储配置信息和其他的共享信息。</p>
<h3 id="不利之处：应用层"><a href="#不利之处：应用层" class="headerlink" title="不利之处：应用层"></a>不利之处：应用层</h3><ul>
<li>添加由多个松耦合服务组成的应用层，从架构、运营、流程等层面来讲将非常不同（相对于单体系统）。</li>
<li>微服务会增加部署和运营的复杂度。</li>
</ul>
<h3 id="来源及延伸阅读-8"><a href="#来源及延伸阅读-8" class="headerlink" title="来源及延伸阅读"></a>来源及延伸阅读</h3><ul>
<li><a target="_blank" rel="noopener" href="http://lethain.com/introduction-to-architecting-systems-for-scale">可缩放系统构架介绍</a></li>
<li><a target="_blank" rel="noopener" href="http://www.puncsky.com/blog/2016-02-13-crack-the-system-design-interview">破解系统设计面试</a></li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Service-oriented_architecture">面向服务架构</a></li>
<li><a target="_blank" rel="noopener" href="http://www.slideshare.net/sauravhaloi/introduction-to-apache-zookeeper">Zookeeper 介绍</a></li>
<li><a target="_blank" rel="noopener" href="https://cloudncode.wordpress.com/2016/07/22/msa-getting-started/">构建微服务，你所需要知道的一切</a></li>
</ul>
<h2 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h2><p><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/images/Xkm5CXz.png"><img src="https://github.com/donnemartin/system-design-primer/raw/master/images/Xkm5CXz.png#align=left&display=inline&height=1276&margin=%5Bobject%20Object%5D&originHeight=1276&originWidth=2184&status=done&style=none&width=2184"></a><br><strong><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=w95murBkYmU">资料来源：扩展你的用户数到第一个一千万</a></strong></p>
<h3 id="关系型数据库管理系统（RDBMS）"><a href="#关系型数据库管理系统（RDBMS）" class="headerlink" title="关系型数据库管理系统（RDBMS）"></a>关系型数据库管理系统（RDBMS）</h3><p>像 SQL 这样的关系型数据库是一系列以表的形式组织的数据项集合。</p>
<blockquote>
<p>校对注：这里作者 SQL 可能指的是 MySQL</p>
</blockquote>
<p><strong>ACID</strong> 用来描述关系型数据库<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Database_transaction">事务</a>的特性。</p>
<ul>
<li><strong>原子性</strong> - 每个事务内部所有操作要么全部完成，要么全部不完成。</li>
<li><strong>一致性</strong> - 任何事务都使数据库从一个有效的状态转换到另一个有效状态。</li>
<li><strong>隔离性</strong> - 并发执行事务的结果与顺序执行事务的结果相同。</li>
<li><strong>持久性</strong> - 事务提交后，对系统的影响是永久的。</li>
</ul>
<p>关系型数据库扩展包括许多技术：<strong>主从复制</strong>、<strong>主主复制</strong>、<strong>联合</strong>、<strong>分片</strong>、<strong>非规范化</strong>和 <strong>SQL 调优</strong>。<br><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/images/C9ioGtn.png"><img src="https://github.com/donnemartin/system-design-primer/raw/master/images/C9ioGtn.png#align=left&display=inline&height=839&margin=%5Bobject%20Object%5D&originHeight=839&originWidth=1246&status=done&style=none&width=1246"></a><br><strong><a target="_blank" rel="noopener" href="http://www.slideshare.net/jboner/scalability-availability-stability-patterns/">资料来源：可扩展性、可用性、稳定性、模式</a></strong></p>
<h4 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a>主从复制</h4><p>主库同时负责读取和写入操作，并复制写入到一个或多个从库中，从库只负责读操作。树状形式的从库再将写入复制到更多的从库中去。如果主库离线，系统可以以只读模式运行，直到某个从库被提升为主库或有新的主库出现。</p>
<h5 id="不利之处：主从复制"><a href="#不利之处：主从复制" class="headerlink" title="不利之处：主从复制"></a>不利之处：主从复制</h5><ul>
<li>将从库提升为主库需要额外的逻辑。</li>
<li>参考<a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E4%B8%8D%E5%88%A9%E4%B9%8B%E5%A4%84%E5%A4%8D%E5%88%B6">不利之处：复制</a>中，主从复制和主主复制<strong>共同</strong>的问题。</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/images/krAHLGg.png"><img src="https://github.com/donnemartin/system-design-primer/raw/master/images/krAHLGg.png#align=left&display=inline&height=610&margin=%5Bobject%20Object%5D&originHeight=610&originWidth=1028&status=done&style=none&width=1028"></a><br><strong><a target="_blank" rel="noopener" href="http://www.slideshare.net/jboner/scalability-availability-stability-patterns/">资料来源：可扩展性、可用性、稳定性、模式</a></strong></p>
<h4 id="主主复制"><a href="#主主复制" class="headerlink" title="主主复制"></a>主主复制</h4><p>两个主库都负责读操作和写操作，写入操作时互相协调。如果其中一个主库挂机，系统可以继续读取和写入。</p>
<h5 id="不利之处：-主主复制"><a href="#不利之处：-主主复制" class="headerlink" title="不利之处： 主主复制"></a>不利之处： 主主复制</h5><ul>
<li>你需要添加负载均衡器或者在应用逻辑中做改动，来确定写入哪一个数据库。</li>
<li>多数主-主系统要么不能保证一致性（违反 ACID），要么因为同步产生了写入延迟。</li>
<li>随着更多写入节点的加入和延迟的提高，如何解决冲突显得越发重要。</li>
<li>参考<a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E4%B8%8D%E5%88%A9%E4%B9%8B%E5%A4%84%E5%A4%8D%E5%88%B6">不利之处：复制</a>中，主从复制和主主复制<strong>共同</strong>的问题。</li>
</ul>
<h5 id="不利之处：复制"><a href="#不利之处：复制" class="headerlink" title="不利之处：复制"></a>不利之处：复制</h5><ul>
<li>如果主库在将新写入的数据复制到其他节点前挂掉，则有数据丢失的可能。</li>
<li>写入会被重放到负责读取操作的副本。副本可能因为过多写操作阻塞住，导致读取功能异常。</li>
<li>读取从库越多，需要复制的写入数据就越多，导致更严重的复制延迟。</li>
<li>在某些数据库系统中，写入主库的操作可以用多个线程并行写入，但读取副本只支持单线程顺序地写入。</li>
<li>复制意味着更多的硬件和额外的复杂度。</li>
</ul>
<h5 id="来源及延伸阅读-9"><a href="#来源及延伸阅读-9" class="headerlink" title="来源及延伸阅读"></a>来源及延伸阅读</h5><ul>
<li><a target="_blank" rel="noopener" href="http://www.slideshare.net/jboner/scalability-availability-stability-patterns/">扩展性，可用性，稳定性模式</a></li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Multi-master_replication">多主复制</a></li>
</ul>
<h4 id="联合"><a href="#联合" class="headerlink" title="联合"></a>联合</h4><p><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/images/U3qV33e.png"><img src="https://github.com/donnemartin/system-design-primer/raw/master/images/U3qV33e.png#align=left&display=inline&height=768&margin=%5Bobject%20Object%5D&originHeight=768&originWidth=594&status=done&style=none&width=594"></a><br><strong><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=w95murBkYmU">资料来源：扩展你的用户数到第一个一千万</a></strong><br>联合（或按功能划分）将数据库按对应功能分割。例如，你可以有三个数据库：<strong>论坛</strong>、<strong>用户</strong>和<strong>产品</strong>，而不仅是一个单体数据库，从而减少每个数据库的读取和写入流量，减少复制延迟。较小的数据库意味着更多适合放入内存的数据，进而意味着更高的缓存命中几率。没有只能串行写入的中心化主库，你可以并行写入，提高负载能力。</p>
<h5 id="不利之处：联合"><a href="#不利之处：联合" class="headerlink" title="不利之处：联合"></a>不利之处：联合</h5><ul>
<li>如果你的数据库模式需要大量的功能和数据表，联合的效率并不好。</li>
<li>你需要更新应用程序的逻辑来确定要读取和写入哪个数据库。</li>
<li>用 <a target="_blank" rel="noopener" href="http://stackoverflow.com/questions/5145637/querying-data-by-joining-two-tables-in-two-database-on-different-servers">server link</a> 从两个库联结数据更复杂。</li>
<li>联合需要更多的硬件和额外的复杂度。</li>
</ul>
<h5 id="来源及延伸阅读：联合"><a href="#来源及延伸阅读：联合" class="headerlink" title="来源及延伸阅读：联合"></a>来源及延伸阅读：联合</h5><ul>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=w95murBkYmU">扩展你的用户数到第一个一千万</a></li>
</ul>
<h4 id="分片"><a href="#分片" class="headerlink" title="分片"></a>分片</h4><p><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/images/wU8x5Id.png"><img src="https://github.com/donnemartin/system-design-primer/raw/master/images/wU8x5Id.png#align=left&display=inline&height=728&margin=%5Bobject%20Object%5D&originHeight=728&originWidth=642&status=done&style=none&width=642"></a><br><strong><a target="_blank" rel="noopener" href="http://www.slideshare.net/jboner/scalability-availability-stability-patterns/">资料来源：可扩展性、可用性、稳定性、模式</a></strong><br>分片将数据分配在不同的数据库上，使得每个数据库仅管理整个数据集的一个子集。以用户数据库为例，随着用户数量的增加，越来越多的分片会被添加到集群中。<br>类似<a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%81%94%E5%90%88">联合</a>的优点，分片可以减少读取和写入流量，减少复制并提高缓存命中率。也减少了索引，通常意味着查询更快，性能更好。如果一个分片出问题，其他的仍能运行，你可以使用某种形式的冗余来防止数据丢失。类似联合，没有只能串行写入的中心化主库，你可以并行写入，提高负载能力。<br>常见的做法是用户姓氏的首字母或者用户的地理位置来分隔用户表。</p>
<h5 id="不利之处：分片"><a href="#不利之处：分片" class="headerlink" title="不利之处：分片"></a>不利之处：分片</h5><ul>
<li>你需要修改应用程序的逻辑来实现分片，这会带来复杂的 SQL 查询。</li>
<li>分片不合理可能导致数据负载不均衡。例如，被频繁访问的用户数据会导致其所在分片的负载相对其他分片高。<ul>
<li>再平衡会引入额外的复杂度。基于<a target="_blank" rel="noopener" href="http://www.paperplanes.de/2011/12/9/the-magic-of-consistent-hashing.html">一致性哈希</a>的分片算法可以减少这种情况。</li>
</ul>
</li>
<li>联结多个分片的数据操作更复杂。</li>
<li>分片需要更多的硬件和额外的复杂度。</li>
</ul>
<h4 id="来源及延伸阅读：分片"><a href="#来源及延伸阅读：分片" class="headerlink" title="来源及延伸阅读：分片"></a>来源及延伸阅读：分片</h4><ul>
<li><a target="_blank" rel="noopener" href="http://highscalability.com/blog/2009/8/6/an-unorthodox-approach-to-database-design-the-coming-of-the.html">分片时代来临</a></li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Shard_(database_architecture)">数据库分片架构</a></li>
<li><a target="_blank" rel="noopener" href="http://www.paperplanes.de/2011/12/9/the-magic-of-consistent-hashing.html">一致性哈希</a></li>
</ul>
<h4 id="非规范化"><a href="#非规范化" class="headerlink" title="非规范化"></a>非规范化</h4><p>非规范化试图以写入性能为代价来换取读取性能。在多个表中冗余数据副本，以避免高成本的联结操作。一些关系型数据库，比如 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/PostgreSQL">PostgreSQL</a> 和 Oracle 支持<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Materialized_view">物化视图</a>，可以处理冗余信息存储和保证冗余副本一致。<br>当数据使用诸如<a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%81%94%E5%90%88">联合</a>和<a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%88%86%E7%89%87">分片</a>等技术被分割，进一步提高了处理跨数据中心的联结操作复杂度。非规范化可以规避这种复杂的联结操作。<br>在多数系统中，读取操作的频率远高于写入操作，比例可达到 100:1，甚至 1000:1。需要复杂的数据库联结的读取操作成本非常高，在磁盘操作上消耗了大量时间。</p>
<h5 id="不利之处：非规范化"><a href="#不利之处：非规范化" class="headerlink" title="不利之处：非规范化"></a>不利之处：非规范化</h5><ul>
<li>数据会冗余。</li>
<li>约束可以帮助冗余的信息副本保持同步，但这样会增加数据库设计的复杂度。</li>
<li>非规范化的数据库在高写入负载下性能可能比规范化的数据库差。</li>
</ul>
<h5 id="来源及延伸阅读：非规范化"><a href="#来源及延伸阅读：非规范化" class="headerlink" title="来源及延伸阅读：非规范化"></a>来源及延伸阅读：非规范化</h5><ul>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Denormalization">非规范化</a></li>
</ul>
<h4 id="SQL-调优"><a href="#SQL-调优" class="headerlink" title="SQL 调优"></a>SQL 调优</h4><p>SQL 调优是一个范围很广的话题，有很多相关的<a target="_blank" rel="noopener" href="https://www.amazon.com/s/ref=nb_sb_noss_2?url=search-alias=aps&field-keywords=sql+tuning">书</a>可以作为参考。<br>利用<strong>基准测试</strong>和<strong>性能分析</strong>来模拟和发现系统瓶颈很重要。</p>
<ul>
<li><strong>基准测试</strong> - 用 <a target="_blank" rel="noopener" href="http://httpd.apache.org/docs/2.2/programs/ab.html">ab</a> 等工具模拟高负载情况。</li>
<li><strong>性能分析</strong> - 通过启用如<a target="_blank" rel="noopener" href="http://dev.mysql.com/doc/refman/5.7/en/slow-query-log.html">慢查询日志</a>等工具来辅助追踪性能问题。</li>
</ul>
<p>基准测试和性能分析可能会指引你到以下优化方案。</p>
<h5 id="改进模式"><a href="#改进模式" class="headerlink" title="改进模式"></a>改进模式</h5><ul>
<li>为了实现快速访问，MySQL 在磁盘上用连续的块存储数据。</li>
<li>使用<code>CHAR</code>类型存储固定长度的字段，不要用<code>VARCHAR</code>。<ul>
<li><code>CHAR</code> 在快速、随机访问时效率很高。如果使用 <code>VARCHAR</code>，如果你想读取下一个字符串，不得不先读取到当前字符串的末尾。</li>
</ul>
</li>
<li>使用 <code>TEXT</code> 类型存储大块的文本，例如博客正文。<code>TEXT</code> 还允许布尔搜索。使用 <code>TEXT</code> 字段需要在磁盘上存储一个用于定位文本块的指针。</li>
<li>使用 <code>INT</code> 类型存储高达 2^32 或 40 亿的较大数字。</li>
<li>使用 <code>DECIMAL</code> 类型存储货币可以避免浮点数表示错误。</li>
<li>避免使用 <code>BLOBS</code> 存储实际对象，而是用来存储存放对象的位置。</li>
<li><code>VARCHAR(255)</code> 是以 8 位数字存储的最大字符数，在某些关系型数据库中，最大限度地利用字节。</li>
<li>在适用场景中设置 <code>NOT NULL</code> 约束来<a target="_blank" rel="noopener" href="http://stackoverflow.com/questions/1017239/how-do-null-values-affect-performance-in-a-database-search">提高搜索性能</a>。</li>
</ul>
<h5 id="使用正确的索引"><a href="#使用正确的索引" class="headerlink" title="使用正确的索引"></a>使用正确的索引</h5><ul>
<li>你正查询（<code>SELECT</code>、<code>GROUP BY</code>、<code>ORDER BY</code>、<code>JOIN</code>）的列如果用了索引会更快。</li>
<li>索引通常表示为自平衡的 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/B-tree">B 树</a>，可以保持数据有序，并允许在对数时间内进行搜索，顺序访问，插入，删除操作。</li>
<li>设置索引，会将数据存在内存中，占用了更多内存空间。</li>
<li>写入操作会变慢，因为索引需要被更新。</li>
<li>加载大量数据时，禁用索引再加载数据，然后重建索引，这样也许会更快。</li>
</ul>
<h5 id="避免高成本的联结操作"><a href="#避免高成本的联结操作" class="headerlink" title="避免高成本的联结操作"></a>避免高成本的联结操作</h5><ul>
<li>有性能需要，可以进行非规范化。</li>
</ul>
<h5 id="分割数据表"><a href="#分割数据表" class="headerlink" title="分割数据表"></a>分割数据表</h5><ul>
<li>将热点数据拆分到单独的数据表中，可以有助于缓存。</li>
</ul>
<h5 id="调优查询缓存"><a href="#调优查询缓存" class="headerlink" title="调优查询缓存"></a>调优查询缓存</h5><ul>
<li>在某些情况下，<a target="_blank" rel="noopener" href="http://dev.mysql.com/doc/refman/5.7/en/query-cache">查询缓存</a>可能会导致<a target="_blank" rel="noopener" href="https://www.percona.com/blog/2014/01/28/10-mysql-performance-tuning-settings-after-installation/">性能问题</a>。</li>
</ul>
<h5 id="来源及延伸阅读-10"><a href="#来源及延伸阅读-10" class="headerlink" title="来源及延伸阅读"></a>来源及延伸阅读</h5><ul>
<li><a target="_blank" rel="noopener" href="http://20bits.com/article/10-tips-for-optimizing-mysql-queries-that-dont-suck">MySQL 查询优化小贴士</a></li>
<li><a target="_blank" rel="noopener" href="http://stackoverflow.com/questions/1217466/is-there-a-good-reason-i-see-varchar255-used-so-often-as-opposed-to-another-l">为什么 VARCHAR(255) 很常见？</a></li>
<li><a target="_blank" rel="noopener" href="http://stackoverflow.com/questions/1017239/how-do-null-values-affect-performance-in-a-database-search">Null 值是如何影响数据库性能的？</a></li>
<li><a target="_blank" rel="noopener" href="http://dev.mysql.com/doc/refman/5.7/en/slow-query-log.html">慢查询日志</a></li>
</ul>
<h3 id="NoSQL"><a href="#NoSQL" class="headerlink" title="NoSQL"></a>NoSQL</h3><p>NoSQL 是<strong>键-值数据库</strong>、<strong>文档型数据库</strong>、<strong>列型数据库</strong>或<strong>图数据库</strong>的统称。数据库是非规范化的，表联结大多在应用程序代码中完成。大多数 NoSQL 无法实现真正符合 ACID 的事务，支持<a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7">最终一致</a>。<br><strong>BASE</strong> 通常被用于描述 NoSQL 数据库的特性。相比 <a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#cap-%E7%90%86%E8%AE%BA">CAP 理论</a>，BASE 强调可用性超过一致性。</p>
<ul>
<li><strong>基本可用</strong> - 系统保证可用性。</li>
<li><strong>软状态</strong> - 即使没有输入，系统状态也可能随着时间变化。</li>
<li><strong>最终一致性</strong> - 经过一段时间之后，系统最终会变一致，因为系统在此期间没有收到任何输入。</li>
</ul>
<p>除了在 <a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#sql-%E8%BF%98%E6%98%AF-nosql">SQL 还是 NoSQL</a> 之间做选择，了解哪种类型的 NoSQL 数据库最适合你的用例也是非常有帮助的。我们将在下一节中快速了解下 <strong>键-值存储</strong>、<strong>文档型存储</strong>、<strong>列型存储</strong>和<strong>图存储</strong>数据库。</p>
<h4 id="键-值存储"><a href="#键-值存储" class="headerlink" title="键-值存储"></a>键-值存储</h4><blockquote>
<p>抽象模型：哈希表</p>
</blockquote>
<p>键-值存储通常可以实现 O(1) 时间读写，用内存或 SSD 存储数据。数据存储可以按<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Lexicographical_order">字典顺序</a>维护键，从而实现键的高效检索。键-值存储可以用于存储元数据。<br>键-值存储性能很高，通常用于存储简单数据模型或频繁修改的数据，如存放在内存中的缓存。键-值存储提供的操作有限，如果需要更多操作，复杂度将转嫁到应用程序层面。<br>键-值存储是如文档存储，在某些情况下，甚至是图存储等更复杂的存储系统的基础。</p>
<h4 id="来源及延伸阅读-11"><a href="#来源及延伸阅读-11" class="headerlink" title="来源及延伸阅读"></a>来源及延伸阅读</h4><ul>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Key-value_database">键-值数据库</a></li>
<li><a target="_blank" rel="noopener" href="http://stackoverflow.com/questions/4056093/what-are-the-disadvantages-of-using-a-key-value-table-over-nullable-columns-or">键-值存储的劣势</a></li>
<li><a target="_blank" rel="noopener" href="http://qnimate.com/overview-of-redis-architecture/">Redis 架构</a></li>
<li><a target="_blank" rel="noopener" href="https://www.adayinthelifeof.nl/2011/02/06/memcache-internals/">Memcached 架构</a></li>
</ul>
<h4 id="文档类型存储"><a href="#文档类型存储" class="headerlink" title="文档类型存储"></a>文档类型存储</h4><blockquote>
<p>抽象模型：将文档作为值的键-值存储</p>
</blockquote>
<p>文档类型存储以文档（XML、JSON、二进制文件等）为中心，文档存储了指定对象的全部信息。文档存储根据文档自身的内部结构提供 API 或查询语句来实现查询。请注意，许多键-值存储数据库有用值存储元数据的特性，这也模糊了这两种存储类型的界限。<br>基于底层实现，文档可以根据集合、标签、元数据或者文件夹组织。尽管不同文档可以被组织在一起或者分成一组，但相互之间可能具有完全不同的字段。<br>MongoDB 和 CouchDB 等一些文档类型存储还提供了类似 SQL 语言的查询语句来实现复杂查询。DynamoDB 同时支持键-值存储和文档类型存储。<br>文档类型存储具备高度的灵活性，常用于处理偶尔变化的数据。</p>
<h4 id="来源及延伸阅读：文档类型存储"><a href="#来源及延伸阅读：文档类型存储" class="headerlink" title="来源及延伸阅读：文档类型存储"></a>来源及延伸阅读：文档类型存储</h4><ul>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Document-oriented_database">面向文档的数据库</a></li>
<li><a target="_blank" rel="noopener" href="https://www.mongodb.com/mongodb-architecture">MongoDB 架构</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.couchdb.org/2016/08/01/couchdb-2-0-architecture/">CouchDB 架构</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/blog/found-elasticsearch-from-the-bottom-up">Elasticsearch 架构</a></li>
</ul>
<h4 id="列型存储"><a href="#列型存储" class="headerlink" title="列型存储"></a>列型存储</h4><p><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/images/n16iOGk.png"><img src="https://github.com/donnemartin/system-design-primer/raw/master/images/n16iOGk.png#align=left&display=inline&height=231&margin=%5Bobject%20Object%5D&originHeight=231&originWidth=581&status=done&style=none&width=581"></a><br><strong><a target="_blank" rel="noopener" href="http://blog.grio.com/2015/11/sql-nosql-a-brief-history.html">资料来源: SQL 和 NoSQL，一个简短的历史</a></strong></p>
<blockquote>
<p>抽象模型：嵌套的 <code>ColumnFamily&lt;RowKey, Columns&lt;ColKey, Value, Timestamp&gt;&gt;</code> 映射</p>
</blockquote>
<p>类型存储的基本数据单元是列（名／值对）。列可以在列族（类似于 SQL 的数据表）中被分组。超级列族再分组普通列族。你可以使用行键独立访问每一列，具有相同行键值的列组成一行。每个值都包含版本的时间戳用于解决版本冲突。<br>Google 发布了第一个列型存储数据库 <a target="_blank" rel="noopener" href="http://www.read.seas.harvard.edu/~kohler/class/cs239-w08/chang06bigtable.pdf">Bigtable</a>，它影响了 Hadoop 生态系统中活跃的开源数据库 <a target="_blank" rel="noopener" href="https://www.mapr.com/blog/in-depth-look-hbase-architecture">HBase</a> 和 Facebook 的 <a target="_blank" rel="noopener" href="http://docs.datastax.com/en/archived/cassandra/2.0/cassandra/architecture/architectureIntro_c.html">Cassandra</a>。像 BigTable，HBase 和 Cassandra 这样的存储系统将键以字母顺序存储，可以高效地读取键列。<br>列型存储具备高可用性和高可扩展性。通常被用于大数据相关存储。</p>
<h5 id="来源及延伸阅读：列型存储"><a href="#来源及延伸阅读：列型存储" class="headerlink" title="来源及延伸阅读：列型存储"></a>来源及延伸阅读：列型存储</h5><ul>
<li><a target="_blank" rel="noopener" href="http://blog.grio.com/2015/11/sql-nosql-a-brief-history.html">SQL 与 NoSQL 简史</a></li>
<li><a target="_blank" rel="noopener" href="http://www.read.seas.harvard.edu/~kohler/class/cs239-w08/chang06bigtable.pdf">BigTable 架构</a></li>
<li><a target="_blank" rel="noopener" href="https://www.mapr.com/blog/in-depth-look-hbase-architecture">Hbase 架构</a></li>
<li><a target="_blank" rel="noopener" href="http://docs.datastax.com/en/archived/cassandra/2.0/cassandra/architecture/architectureIntro_c.html">Cassandra 架构</a></li>
</ul>
<h4 id="图数据库"><a href="#图数据库" class="headerlink" title="图数据库"></a>图数据库</h4><p><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/images/fNcl65g.png"><img src="https://github.com/donnemartin/system-design-primer/raw/master/images/fNcl65g.png#align=left&display=inline&height=436&margin=%5Bobject%20Object%5D&originHeight=436&originWidth=616&status=done&style=none&width=616"></a><br><strong><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/File:GraphDatabase_PropertyGraph.png">资料来源：图数据库</a></strong></p>
<blockquote>
<p>抽象模型： 图</p>
</blockquote>
<p>在图数据库中，一个节点对应一条记录，一个弧对应两个节点之间的关系。图数据库被优化用于表示外键繁多的复杂关系或多对多关系。<br>图数据库为存储复杂关系的数据模型，如社交网络，提供了很高的性能。它们相对较新，尚未广泛应用，查找开发工具或者资源相对较难。许多图只能通过 <a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%A1%A8%E8%BF%B0%E6%80%A7%E7%8A%B6%E6%80%81%E8%BD%AC%E7%A7%BBrest">REST API</a> 访问。</p>
<h5 id="相关资源和延伸阅读：图"><a href="#相关资源和延伸阅读：图" class="headerlink" title="相关资源和延伸阅读：图"></a>相关资源和延伸阅读：图</h5><ul>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Graph_database">图数据库</a></li>
<li><a target="_blank" rel="noopener" href="https://neo4j.com/">Neo4j</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.twitter.com/2010/introducing-flockdb">FlockDB</a></li>
</ul>
<h4 id="来源及延伸阅读：NoSQL"><a href="#来源及延伸阅读：NoSQL" class="headerlink" title="来源及延伸阅读：NoSQL"></a>来源及延伸阅读：NoSQL</h4><ul>
<li><a target="_blank" rel="noopener" href="http://stackoverflow.com/questions/3342497/explanation-of-base-terminology">数据库术语解释</a></li>
<li><a target="_blank" rel="noopener" href="https://medium.com/baqend-blog/nosql-databases-a-survey-and-decision-guidance-ea7823a822d#.wskogqenq">NoSQL 数据库 - 调查及决策指南</a></li>
<li><a target="_blank" rel="noopener" href="http://www.lecloud.net/post/7994751381/scalability-for-dummies-part-2-database">可扩展性</a></li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=qI_g07C_Q5I">NoSQL 介绍</a></li>
<li><a target="_blank" rel="noopener" href="http://horicky.blogspot.com/2009/11/nosql-patterns.html">NoSQL 模式</a></li>
</ul>
<h3 id="SQL-还是-NoSQL"><a href="#SQL-还是-NoSQL" class="headerlink" title="SQL 还是 NoSQL"></a>SQL 还是 NoSQL</h3><p><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/images/wXGqG5f.png"><img src="https://github.com/donnemartin/system-design-primer/raw/master/images/wXGqG5f.png#align=left&display=inline&height=316&margin=%5Bobject%20Object%5D&originHeight=316&originWidth=553&status=done&style=none&width=553"></a><br><strong><a target="_blank" rel="noopener" href="https://www.infoq.com/articles/Transition-RDBMS-NoSQL/">资料来源：从 RDBMS 转换到 NoSQL</a></strong><br>选取 <strong>SQL</strong> 的原因:</p>
<ul>
<li>结构化数据</li>
<li>严格的模式</li>
<li>关系型数据</li>
<li>需要复杂的联结操作</li>
<li>事务</li>
<li>清晰的扩展模式</li>
<li>既有资源更丰富：开发者、社区、代码库、工具等</li>
<li>通过索引进行查询非常快</li>
</ul>
<p>选取 <strong>NoSQL</strong> 的原因：</p>
<ul>
<li>半结构化数据</li>
<li>动态或灵活的模式</li>
<li>非关系型数据</li>
<li>不需要复杂的联结操作</li>
<li>存储 TB （甚至 PB）级别的数据</li>
<li>高数据密集的工作负载</li>
<li>IOPS 高吞吐量</li>
</ul>
<p>适合 NoSQL 的示例数据：</p>
<ul>
<li>埋点数据和日志数据</li>
<li>排行榜或者得分数据</li>
<li>临时数据，如购物车</li>
<li>频繁访问的（“热”）表</li>
<li>元数据／查找表</li>
</ul>
<h5 id="来源及延伸阅读：SQL-或-NoSQL"><a href="#来源及延伸阅读：SQL-或-NoSQL" class="headerlink" title="来源及延伸阅读：SQL 或 NoSQL"></a>来源及延伸阅读：SQL 或 NoSQL</h5><ul>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=w95murBkYmU">扩展你的用户数到第一个千万</a></li>
<li><a target="_blank" rel="noopener" href="https://www.sitepoint.com/sql-vs-nosql-differences/">SQL 和 NoSQL 的不同</a></li>
</ul>
<h2 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h2><p><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/images/Q6z24La.png"><img src="https://github.com/donnemartin/system-design-primer/raw/master/images/Q6z24La.png#align=left&display=inline&height=596&margin=%5Bobject%20Object%5D&originHeight=596&originWidth=1032&status=done&style=none&width=1032"></a><br><strong><a target="_blank" rel="noopener" href="http://horicky.blogspot.com/2010/10/scalable-system-design-patterns.html">资料来源：可扩展的系统设计模式</a></strong><br>缓存可以提高页面加载速度，并可以减少服务器和数据库的负载。在这个模型中，分发器先查看请求之前是否被响应过，如果有则将之前的结果直接返回，来省掉真正的处理。<br>数据库分片均匀分布的读取是最好的。但是热门数据会让读取分布不均匀，这样就会造成瓶颈，如果在数据库前加个缓存，就会抹平不均匀的负载和突发流量对数据库的影响。</p>
<h3 id="客户端缓存"><a href="#客户端缓存" class="headerlink" title="客户端缓存"></a>客户端缓存</h3><p>缓存可以位于客户端（操作系统或者浏览器），<a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86web-%E6%9C%8D%E5%8A%A1%E5%99%A8">服务端</a>或者不同的缓存层。</p>
<h3 id="CDN-缓存"><a href="#CDN-缓存" class="headerlink" title="CDN 缓存"></a>CDN 缓存</h3><p><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%86%85%E5%AE%B9%E5%88%86%E5%8F%91%E7%BD%91%E7%BB%9Ccdn">CDN</a> 也被视为一种缓存。</p>
<h3 id="Web-服务器缓存"><a href="#Web-服务器缓存" class="headerlink" title="Web 服务器缓存"></a>Web 服务器缓存</h3><p><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86web-%E6%9C%8D%E5%8A%A1%E5%99%A8">反向代理</a>和缓存（比如 <a target="_blank" rel="noopener" href="https://www.varnish-cache.org/">Varnish</a>）可以直接提供静态和动态内容。Web 服务器同样也可以缓存请求，返回相应结果而不必连接应用服务器。</p>
<h3 id="数据库缓存"><a href="#数据库缓存" class="headerlink" title="数据库缓存"></a>数据库缓存</h3><p>数据库的默认配置中通常包含缓存级别，针对一般用例进行了优化。调整配置，在不同情况下使用不同的模式可以进一步提高性能。</p>
<h3 id="应用缓存"><a href="#应用缓存" class="headerlink" title="应用缓存"></a>应用缓存</h3><p>基于内存的缓存比如 Memcached 和 Redis 是应用程序和数据存储之间的一种键值存储。由于数据保存在 RAM 中，它比存储在磁盘上的典型数据库要快多了。RAM 比磁盘限制更多，所以例如 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Cache_algorithms#Least_Recently_Used">least recently used (LRU)</a> 的<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Cache_algorithms">缓存无效算法</a>可以将「热门数据」放在 RAM 中，而对一些比较「冷门」的数据不做处理。<br>Redis 有下列附加功能：</p>
<ul>
<li>持久性选项</li>
<li>内置数据结构比如有序集合和列表</li>
</ul>
<p>有多个缓存级别，分为两大类：<strong>数据库查询</strong>和<strong>对象</strong>：</p>
<ul>
<li>行级别</li>
<li>查询级别</li>
<li>完整的可序列化对象</li>
<li>完全渲染的 HTML</li>
</ul>
<p>一般来说，你应该尽量避免基于文件的缓存，因为这使得复制和自动缩放很困难。</p>
<h3 id="数据库查询级别的缓存"><a href="#数据库查询级别的缓存" class="headerlink" title="数据库查询级别的缓存"></a>数据库查询级别的缓存</h3><p>当你查询数据库的时候，将查询语句的哈希值与查询结果存储到缓存中。这种方法会遇到以下问题：</p>
<ul>
<li>很难用复杂的查询删除已缓存结果。</li>
<li>如果一条数据比如表中某条数据的一项被改变，则需要删除所有可能包含已更改项的缓存结果。</li>
</ul>
<h3 id="对象级别的缓存"><a href="#对象级别的缓存" class="headerlink" title="对象级别的缓存"></a>对象级别的缓存</h3><p>将您的数据视为对象，就像对待你的应用代码一样。让应用程序将数据从数据库中组合到类实例或数据结构中：</p>
<ul>
<li>如果对象的基础数据已经更改了，那么从缓存中删掉这个对象。</li>
<li>允许异步处理：workers 通过使用最新的缓存对象来组装对象。</li>
</ul>
<p>建议缓存的内容：</p>
<ul>
<li>用户会话</li>
<li>完全渲染的 Web 页面</li>
<li>活动流</li>
<li>用户图数据</li>
</ul>
<h3 id="何时更新缓存"><a href="#何时更新缓存" class="headerlink" title="何时更新缓存"></a>何时更新缓存</h3><p>由于你只能在缓存中存储有限的数据，所以你需要选择一个适用于你用例的缓存更新策略。</p>
<h4 id="缓存模式"><a href="#缓存模式" class="headerlink" title="缓存模式"></a>缓存模式</h4><p><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/images/ONjORqk.png"><img src="https://github.com/donnemartin/system-design-primer/raw/master/images/ONjORqk.png#align=left&display=inline&height=494&margin=%5Bobject%20Object%5D&originHeight=494&originWidth=1290&status=done&style=none&width=1290"></a><br><strong><a target="_blank" rel="noopener" href="http://www.slideshare.net/tmatyashovsky/from-cache-to-in-memory-data-grid-introduction-to-hazelcast">资料来源：从缓存到内存数据网格</a></strong><br>应用从存储器读写。缓存不和存储器直接交互，应用执行以下操作：</p>
<ul>
<li>在缓存中查找记录，如果所需数据不在缓存中</li>
<li>从数据库中加载所需内容</li>
<li>将查找到的结果存储到缓存中</li>
<li>返回所需内容</li>
</ul>
<p>def get_user(self, user_id):<br>    user = cache.get(“user.{0}”, user_id)<br>    if user is None:<br>        user = db.query(“SELECT * FROM users WHERE user_id = {0}”, user_id)<br>        if user is not None:<br>            key = “user.{0}”.format(user_id)<br>            cache.set(key, json.dumps(user))<br>    return user<br><a target="_blank" rel="noopener" href="https://memcached.org/">Memcached</a> 通常用这种方式使用。<br>添加到缓存中的数据读取速度很快。缓存模式也称为延迟加载。只缓存所请求的数据，这避免了没有被请求的数据占满了缓存空间。</p>
<h5 id="缓存的缺点："><a href="#缓存的缺点：" class="headerlink" title="缓存的缺点："></a>缓存的缺点：</h5><ul>
<li>请求的数据如果不在缓存中就需要经过三个步骤来获取数据，这会导致明显的延迟。</li>
<li>如果数据库中的数据更新了会导致缓存中的数据过时。这个问题需要通过设置 � TTL 强制更新缓存或者直写模式来缓解这种情况。</li>
<li>当一个节点出现故障的时候，它将会被一个新的节点替代，这增加了延迟的时间。</li>
</ul>
<h4 id="直写模式"><a href="#直写模式" class="headerlink" title="直写模式"></a>直写模式</h4><p><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/images/0vBc0hN.png"><img src="https://github.com/donnemartin/system-design-primer/raw/master/images/0vBc0hN.png#align=left&display=inline&height=728&margin=%5Bobject%20Object%5D&originHeight=728&originWidth=514&status=done&style=none&width=514"></a><br><strong><a target="_blank" rel="noopener" href="http://www.slideshare.net/jboner/scalability-availability-stability-patterns/">资料来源：可扩展性、可用性、稳定性、模式</a></strong><br>应用使用缓存作为主要的数据存储，将数据读写到缓存中，而缓存负责从数据库中读写数据。</p>
<ul>
<li>应用向缓存中添加/更新数据</li>
<li>缓存同步地写入数据存储</li>
<li>返回所需内容</li>
</ul>
<p>应用代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set_user(12345, &#123;&quot;foo&quot;:&quot;bar&quot;&#125;)</span><br></pre></td></tr></table></figure>

<p>缓存代码：<br>def set_user(user_id, values):<br>    user = db.query(“UPDATE Users WHERE id = {0}”, user_id, values)<br>    cache.set(user_id, user)<br>由于存写操作所以直写模式整体是一种很慢的操作，但是读取刚写入的数据很快。相比读取数据，用户通常比较能接受更新数据时速度较慢。缓存中的数据不会过时。</p>
<h5 id="直写模式的缺点："><a href="#直写模式的缺点：" class="headerlink" title="直写模式的缺点："></a>直写模式的缺点：</h5><ul>
<li>由于故障或者缩放而创建的新的节点，新的节点不会缓存，直到数据库更新为止。缓存应用直写模式可以缓解这个问题。</li>
<li>写入的大多数数据可能永远都不会被读取，用 TTL 可以最小化这种情况的出现。</li>
</ul>
<h4 id="回写模式"><a href="#回写模式" class="headerlink" title="回写模式"></a>回写模式</h4><p><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/images/rgSrvjG.png"><img src="https://github.com/donnemartin/system-design-primer/raw/master/images/rgSrvjG.png#align=left&display=inline&height=728&margin=%5Bobject%20Object%5D&originHeight=728&originWidth=786&status=done&style=none&width=786"></a><br><strong><a target="_blank" rel="noopener" href="http://www.slideshare.net/jboner/scalability-availability-stability-patterns/">资料来源：可扩展性、可用性、稳定性、模式</a></strong><br>在回写模式中，应用执行以下操作：</p>
<ul>
<li>在缓存中增加或者更新条目</li>
<li>异步写入数据，提高写入性能。</li>
</ul>
<h5 id="回写模式的缺点："><a href="#回写模式的缺点：" class="headerlink" title="回写模式的缺点："></a>回写模式的缺点：</h5><ul>
<li>缓存可能在其内容成功存储之前丢失数据。</li>
<li>执行直写模式比缓存或者回写模式更复杂。</li>
</ul>
<h4 id="刷新"><a href="#刷新" class="headerlink" title="刷新"></a>刷新</h4><p><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/images/kxtjqgE.png"><img src="https://github.com/donnemartin/system-design-primer/raw/master/images/kxtjqgE.png#align=left&display=inline&height=296&margin=%5Bobject%20Object%5D&originHeight=296&originWidth=1290&status=done&style=none&width=1290"></a><br><strong><a target="_blank" rel="noopener" href="http://www.slideshare.net/tmatyashovsky/from-cache-to-in-memory-data-grid-introduction-to-hazelcast">资料来源：从缓存到内存数据网格</a></strong><br>你可以将缓存配置成在到期之前自动刷新最近访问过的内容。<br>如果缓存可以准确预测将来可能请求哪些数据，那么刷新可能会导致延迟与读取时间的降低。</p>
<h5 id="刷新的缺点："><a href="#刷新的缺点：" class="headerlink" title="刷新的缺点："></a>刷新的缺点：</h5><ul>
<li>不能准确预测到未来需要用到的数据可能会导致性能不如不使用刷新。</li>
</ul>
<h3 id="缓存的缺点：-1"><a href="#缓存的缺点：-1" class="headerlink" title="缓存的缺点："></a>缓存的缺点：</h3><ul>
<li>需要保持缓存和真实数据源之间的一致性，比如数据库根据<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Cache_algorithms">缓存无效</a>。</li>
<li>需要改变应用程序比如增加 Redis 或者 memcached。</li>
<li>无效缓存是个难题，什么时候更新缓存是与之相关的复杂问题。</li>
</ul>
<h3 id="相关资源和延伸阅读-1"><a href="#相关资源和延伸阅读-1" class="headerlink" title="相关资源和延伸阅读"></a>相关资源和延伸阅读</h3><ul>
<li><a target="_blank" rel="noopener" href="http://www.slideshare.net/tmatyashovsky/from-cache-to-in-memory-data-grid-introduction-to-hazelcast">从缓存到内存数据</a></li>
<li><a target="_blank" rel="noopener" href="http://horicky.blogspot.com/2010/10/scalable-system-design-patterns.html">可扩展系统设计模式</a></li>
<li><a target="_blank" rel="noopener" href="http://lethain.com/introduction-to-architecting-systems-for-scale/">可缩放系统构架介绍</a></li>
<li><a target="_blank" rel="noopener" href="http://www.slideshare.net/jboner/scalability-availability-stability-patterns/">可扩展性，可用性，稳定性和模式</a></li>
<li><a target="_blank" rel="noopener" href="http://www.lecloud.net/post/9246290032/scalability-for-dummies-part-3-cache">可扩展性</a></li>
<li><a target="_blank" rel="noopener" href="http://docs.aws.amazon.com/AmazonElastiCache/latest/UserGuide/Strategies.html">AWS ElastiCache 策略</a></li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Cache_(computing)">维基百科</a></li>
</ul>
<h2 id="异步"><a href="#异步" class="headerlink" title="异步"></a>异步</h2><p><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/images/54GYsSx.png"><img src="https://github.com/donnemartin/system-design-primer/raw/master/images/54GYsSx.png#align=left&display=inline&height=228&margin=%5Bobject%20Object%5D&originHeight=228&originWidth=1000&status=done&style=none&width=1000"></a><br><strong><a target="_blank" rel="noopener" href="http://lethain.com/introduction-to-architecting-systems-for-scale/#platform_layer">资料来源：可缩放系统构架介绍</a></strong><br>异步工作流有助于减少那些原本顺序执行的请求时间。它们可以通过提前进行一些耗时的工作来帮助减少请求时间，比如定期汇总数据。</p>
<h3 id="消息队列"><a href="#消息队列" class="headerlink" title="消息队列"></a>消息队列</h3><p>消息队列接收，保留和传递消息。如果按顺序执行操作太慢的话，你可以使用有以下工作流的消息队列：</p>
<ul>
<li>应用程序将作业发布到队列，然后通知用户作业状态</li>
<li>一个 worker 从队列中取出该作业，对其进行处理，然后显示该作业完成</li>
</ul>
<p>不去阻塞用户操作，作业在后台处理。在此期间，客户端可能会进行一些处理使得看上去像是任务已经完成了。例如，如果要发送一条推文，推文可能会马上出现在你的时间线上，但是可能需要一些时间才能将你的推文推送到你的所有关注者那里去。<br><strong>Redis</strong> 是一个令人满意的简单的消息代理，但是消息有可能会丢失。<br><strong>RabbitMQ</strong> 很受欢迎但是要求你适应「AMQP」协议并且管理你自己的节点。<br><strong>Amazon SQS</strong> 是被托管的，但可能具有高延迟，并且消息可能会被传送两次。</p>
<h3 id="任务队列"><a href="#任务队列" class="headerlink" title="任务队列"></a>任务队列</h3><p>任务队列接收任务及其相关数据，运行它们，然后传递其结果。 它们可以支持调度，并可用于在后台运行计算密集型作业。<br><strong>Celery</strong> 支持调度，主要是用 Python 开发的。</p>
<h3 id="背压"><a href="#背压" class="headerlink" title="背压"></a>背压</h3><p>如果队列开始明显增长，那么队列大小可能会超过内存大小，导致高速缓存未命中，磁盘读取，甚至性能更慢。<a target="_blank" rel="noopener" href="http://mechanical-sympathy.blogspot.com/2012/05/apply-back-pressure-when-overloaded.html">背压</a>可以通过限制队列大小来帮助我们，从而为队列中的作业保持高吞吐率和良好的响应时间。一旦队列填满，客户端将得到服务器忙或者 HTTP 503 状态码，以便稍后重试。客户端可以在稍后时间重试该请求，也许是<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Exponential_backoff">指数退避</a>。</p>
<h3 id="异步的缺点："><a href="#异步的缺点：" class="headerlink" title="异步的缺点："></a>异步的缺点：</h3><ul>
<li>简单的计算和实时工作流等用例可能更适用于同步操作，因为引入队列可能会增加延迟和复杂性。</li>
</ul>
<h3 id="相关资源和延伸阅读-2"><a href="#相关资源和延伸阅读-2" class="headerlink" title="相关资源和延伸阅读"></a>相关资源和延伸阅读</h3><ul>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=1KRYH75wgy4">这是一个数字游戏</a></li>
<li><a target="_blank" rel="noopener" href="http://mechanical-sympathy.blogspot.com/2012/05/apply-back-pressure-when-overloaded.html">超载时应用背压</a></li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Little%27s_law">利特尔法则</a></li>
<li><a target="_blank" rel="noopener" href="https://www.quora.com/What-is-the-difference-between-a-message-queue-and-a-task-queue-Why-would-a-task-queue-require-a-message-broker-like-RabbitMQ-Redis-Celery-or-IronMQ-to-function">消息队列与任务队列有什么区别？</a></li>
</ul>
<h2 id="通讯"><a href="#通讯" class="headerlink" title="通讯"></a>通讯</h2><p><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/images/5KeocQs.jpg"><img src="https://github.com/donnemartin/system-design-primer/raw/master/images/5KeocQs.jpg#align=left&display=inline&height=619&margin=%5Bobject%20Object%5D&originHeight=619&originWidth=710&status=done&style=none&width=710"></a><br><strong><a target="_blank" rel="noopener" href="http://www.escotal.com/osilayer.html">资料来源：OSI 7 层模型</a></strong></p>
<h3 id="超文本传输协议（HTTP）"><a href="#超文本传输协议（HTTP）" class="headerlink" title="超文本传输协议（HTTP）"></a>超文本传输协议（HTTP）</h3><p>HTTP 是一种在客户端和服务器之间编码和传输数据的方法。它是一个请求/响应协议：客户端和服务端针对相关内容和完成状态信息的请求和响应。HTTP 是独立的，允许请求和响应流经许多执行负载均衡，缓存，加密和压缩的中间路由器和服务器。<br>一个基本的 HTTP 请求由一个动词（方法）和一个资源（端点）组成。 以下是常见的 HTTP 动词：</p>
<table>
<thead>
<tr>
<th>动词</th>
<th>描述</th>
<th>*幂等</th>
<th>安全性</th>
<th>可缓存</th>
</tr>
</thead>
<tbody><tr>
<td>GET</td>
<td>读取资源</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td>POST</td>
<td>创建资源或触发处理数据的进程</td>
<td>No</td>
<td>No</td>
<td>Yes，如果回应包含刷新信息</td>
</tr>
<tr>
<td>PUT</td>
<td>创建或替换资源</td>
<td>Yes</td>
<td>No</td>
<td>No</td>
</tr>
<tr>
<td>PATCH</td>
<td>部分更新资源</td>
<td>No</td>
<td>No</td>
<td>Yes，如果回应包含刷新信息</td>
</tr>
<tr>
<td>DELETE</td>
<td>删除资源</td>
<td>Yes</td>
<td>No</td>
<td>No</td>
</tr>
</tbody></table>
<p><strong>多次执行不会产生不同的结果</strong>。<br>HTTP 是依赖于较低级协议（如 <strong>TCP</strong> 和 <strong>UDP</strong>）的应用层协议。</p>
<h4 id="来源及延伸阅读：HTTP"><a href="#来源及延伸阅读：HTTP" class="headerlink" title="来源及延伸阅读：HTTP"></a>来源及延伸阅读：HTTP</h4><ul>
<li><a target="_blank" rel="noopener" href="https://www.quora.com/What-is-the-difference-between-HTTP-protocol-and-TCP-protocol">README</a> +</li>
<li><a target="_blank" rel="noopener" href="https://www.nginx.com/resources/glossary/http/">HTTP 是什么？</a></li>
<li><a target="_blank" rel="noopener" href="https://www.quora.com/What-is-the-difference-between-HTTP-protocol-and-TCP-protocol">HTTP 和 TCP 的区别</a></li>
<li><a target="_blank" rel="noopener" href="https://laracasts.com/discuss/channels/general-discussion/whats-the-differences-between-put-and-patch?page=1">PUT 和 PATCH 的区别</a></li>
</ul>
<h3 id="传输控制协议（TCP）"><a href="#传输控制协议（TCP）" class="headerlink" title="传输控制协议（TCP）"></a>传输控制协议（TCP）</h3><p><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/images/JdAsdvG.jpg"><img src="https://github.com/donnemartin/system-design-primer/raw/master/images/JdAsdvG.jpg#align=left&display=inline&height=188&margin=%5Bobject%20Object%5D&originHeight=188&originWidth=495&status=done&style=none&width=495"></a><br><strong><a target="_blank" rel="noopener" href="http://www.wildbunny.co.uk/blog/2012/10/09/how-to-make-a-multi-player-game-part-1/">资料来源：如何制作多人游戏</a></strong><br>TCP 是通过 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Internet_Protocol">IP 网络</a>的面向连接的协议。 使用<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Handshaking">握手</a>建立和断开连接。 发送的所有数据包保证以原始顺序到达目的地，用以下措施保证数据包不被损坏：</p>
<ul>
<li>每个数据包的序列号和<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol#Checksum_computation">校验码</a>。</li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Acknowledgement_(data_networks)">确认包</a>和自动重传</li>
</ul>
<p>如果发送者没有收到正确的响应，它将重新发送数据包。如果多次超时，连接就会断开。TCP 实行<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Flow_control_(data)">流量控制</a>和<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Network_congestion#Congestion_control">拥塞控制</a>。这些确保措施会导致延迟，而且通常导致传输效率比 UDP 低。<br>为了确保高吞吐量，Web 服务器可以保持大量的 TCP 连接，从而导致高内存使用。在 Web 服务器线程间拥有大量开放连接可能开销巨大，消耗资源过多，也就是说，一个 <a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#memcached">memcached</a> 服务器。<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Connection_pool">连接池</a> 可以帮助除了在适用的情况下切换到 UDP。<br>TCP 对于需要高可靠性但时间紧迫的应用程序很有用。比如包括 Web 服务器，数据库信息，SMTP，FTP 和 SSH。<br>以下情况使用 TCP 代替 UDP：</p>
<ul>
<li>你需要数据完好无损。</li>
<li>你想对网络吞吐量自动进行最佳评估。</li>
</ul>
<h3 id="用户数据报协议（UDP）"><a href="#用户数据报协议（UDP）" class="headerlink" title="用户数据报协议（UDP）"></a>用户数据报协议（UDP）</h3><p><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/images/yzDrJtA.jpg"><img src="https://github.com/donnemartin/system-design-primer/raw/master/images/yzDrJtA.jpg#align=left&display=inline&height=173&margin=%5Bobject%20Object%5D&originHeight=173&originWidth=495&status=done&style=none&width=495"></a><br><strong><a target="_blank" rel="noopener" href="http://www.wildbunny.co.uk/blog/2012/10/09/how-to-make-a-multi-player-game-part-1">资料来源：如何制作多人游戏</a></strong><br>UDP 是无连接的。数据报（类似于数据包）只在数据报级别有保证。数据报可能会无序的到达目的地，也有可能会遗失。UDP 不支持拥塞控制。虽然不如 TCP 那样有保证，但 UDP 通常效率更高。<br>UDP 可以通过广播将数据报发送至子网内的所有设备。这对 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Dynamic_Host_Configuration_Protocol">DHCP</a> 很有用，因为子网内的设备还没有分配 IP 地址，而 IP 对于 TCP 是必须的。<br>UDP 可靠性更低但适合用在网络电话、视频聊天，流媒体和实时多人游戏上。<br>以下情况使用 UDP 代替 TCP：</p>
<ul>
<li>你需要低延迟</li>
<li>相对于数据丢失更糟的是数据延迟</li>
<li>你想实现自己的错误校正方法</li>
</ul>
<h4 id="来源及延伸阅读：TCP-与-UDP"><a href="#来源及延伸阅读：TCP-与-UDP" class="headerlink" title="来源及延伸阅读：TCP 与 UDP"></a>来源及延伸阅读：TCP 与 UDP</h4><ul>
<li><a target="_blank" rel="noopener" href="http://gafferongames.com/networking-for-game-programmers/udp-vs-tcp/">游戏编程的网络</a></li>
<li><a target="_blank" rel="noopener" href="http://www.cyberciti.biz/faq/key-differences-between-tcp-and-udp-protocols/">TCP 与 UDP 的关键区别</a></li>
<li><a target="_blank" rel="noopener" href="http://stackoverflow.com/questions/5970383/difference-between-tcp-and-udp">TCP 与 UDP 的不同</a></li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol">传输控制协议</a></li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/User_Datagram_Protocol">用户数据报协议</a></li>
<li><a target="_blank" rel="noopener" href="http://www.cs.bu.edu/~jappavoo/jappavoo.github.com/451/papers/memcache-fb.pdf">Memcache 在 Facebook 的扩展</a></li>
</ul>
<h3 id="远程过程调用协议（RPC）"><a href="#远程过程调用协议（RPC）" class="headerlink" title="远程过程调用协议（RPC）"></a>远程过程调用协议（RPC）</h3><p><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/images/iF4Mkb5.png"><img src="https://github.com/donnemartin/system-design-primer/raw/master/images/iF4Mkb5.png#align=left&display=inline&height=294&margin=%5Bobject%20Object%5D&originHeight=294&originWidth=762&status=done&style=none&width=762"></a><br><strong><a target="_blank" rel="noopener" href="http://www.puncsky.com/blog/2016/02/14/crack-the-system-design-interview">Source: Crack the system design interview</a></strong><br>在 RPC 中，客户端会去调用另一个地址空间（通常是一个远程服务器）里的方法。调用代码看起来就像是调用的是一个本地方法，客户端和服务器交互的具体过程被抽象。远程调用相对于本地调用一般较慢而且可靠性更差，因此区分两者是有帮助的。热门的 RPC 框架包括 <a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/">Protobuf</a>、<a target="_blank" rel="noopener" href="https://thrift.apache.org/">Thrift</a> 和 <a target="_blank" rel="noopener" href="https://avro.apache.org/docs/current/">Avro</a>。<br>RPC 是一个“请求-响应”协议：</p>
<ul>
<li><strong>客户端程序</strong> ── 调用客户端存根程序。就像调用本地方法一样，参数会被压入栈中。</li>
<li><strong>客户端 stub 程序</strong> ── 将请求过程的 id 和参数打包进请求信息中。</li>
<li><strong>客户端通信模块</strong> ── 将信息从客户端发送至服务端。</li>
<li><strong>服务端通信模块</strong> ── 将接受的包传给服务端存根程序。</li>
<li><strong>服务端 stub 程序</strong> ── 将结果解包，依据过程 id 调用服务端方法并将参数传递过去。</li>
</ul>
<p>RPC 调用示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;someoperation?data&#x3D;anId</span><br><span class="line">POST &#x2F;anotheroperation</span><br><span class="line">&#123;</span><br><span class="line">  &quot;data&quot;:&quot;anId&quot;;</span><br><span class="line">  &quot;anotherdata&quot;: &quot;another value&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>RPC 专注于暴露方法。RPC 通常用于处理内部通讯的性能问题，这样你可以手动处理本地调用以更好的适应你的情况。<br>当以下情况时选择本地库（也就是 SDK）：</p>
<ul>
<li>你知道你的目标平台。</li>
<li>你想控制如何访问你的“逻辑”。</li>
<li>你想对发生在你的库中的错误进行控制。</li>
<li>性能和终端用户体验是你最关心的事。</li>
</ul>
<p>遵循 <strong>REST</strong> 的 HTTP API 往往更适用于公共 API。</p>
<h4 id="缺点：RPC"><a href="#缺点：RPC" class="headerlink" title="缺点：RPC"></a>缺点：RPC</h4><ul>
<li>RPC 客户端与服务实现捆绑地很紧密。</li>
<li>一个新的 API 必须在每一个操作或者用例中定义。</li>
<li>RPC 很难调试。</li>
<li>你可能没办法很方便的去修改现有的技术。举个例子，如果你希望在 <a target="_blank" rel="noopener" href="http://www.squid-cache.org/">Squid</a> 这样的缓存服务器上确保 <a target="_blank" rel="noopener" href="http://etherealbits.com/2012/12/debunking-the-myths-of-rpc-rest/">RPC 被正确缓存</a>的话可能需要一些额外的努力了。</li>
</ul>
<h3 id="表述性状态转移（REST）"><a href="#表述性状态转移（REST）" class="headerlink" title="表述性状态转移（REST）"></a>表述性状态转移（REST）</h3><p>REST 是一种强制的客户端/服务端架构设计模型，客户端基于服务端管理的一系列资源操作。服务端提供修改或获取资源的接口。所有的通信必须是无状态和可缓存的。<br>RESTful 接口有四条规则：</p>
<ul>
<li><strong>标志资源（HTTP 里的 URI）</strong> ── 无论什么操作都使用同一个 URI。</li>
<li><strong>表示的改变（HTTP 的动作）</strong> ── 使用动作, headers 和 body。</li>
<li><strong>可自我描述的错误信息（HTTP 中的 status code）</strong> ── 使用状态码，不要重新造轮子。</li>
<li><strong><a target="_blank" rel="noopener" href="http://restcookbook.com/Basics/hateoas/">HATEOAS</a>（HTTP 中的 HTML 接口）</strong> ── 你的 web 服务器应该能够通过浏览器访问。</li>
</ul>
<p>REST 请求的例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;someresources&#x2F;anId</span><br><span class="line">PUT &#x2F;someresources&#x2F;anId</span><br><span class="line">&#123;&quot;anotherdata&quot;: &quot;another value&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>REST 关注于暴露数据。它减少了客户端／服务端的耦合程度，经常用于公共 HTTP API 接口设计。REST 使用更通常与规范化的方法来通过 URI 暴露资源，<a target="_blank" rel="noopener" href="https://github.com/for-GET/know-your-http-well/blob/master/headers.md">通过 header 来表述</a>并通过 GET、POST、PUT、DELETE 和 PATCH 这些动作来进行操作。因为无状态的特性，REST 易于横向扩展和隔离。</p>
<h4 id="缺点：REST"><a href="#缺点：REST" class="headerlink" title="缺点：REST"></a>缺点：REST</h4><ul>
<li>由于 REST 将重点放在暴露数据，所以当资源不是自然组织的或者结构复杂的时候它可能无法很好的适应。举个例子，返回过去一小时中与特定事件集匹配的更新记录这种操作就很难表示为路径。使用 REST，可能会使用 URI 路径，查询参数和可能的请求体来实现。</li>
<li>REST 一般依赖几个动作（GET、POST、PUT、DELETE 和 PATCH），但有时候仅仅这些没法满足你的需要。举个例子，将过期的文档移动到归档文件夹里去，这样的操作可能没法简单的用上面这几个 verbs 表达。</li>
<li>为了渲染单个页面，获取被嵌套在层级结构中的复杂资源需要客户端，服务器之间多次往返通信。例如，获取博客内容及其关联评论。对于使用不确定网络环境的移动应用来说，这些多次往返通信是非常麻烦的。</li>
<li>随着时间的推移，更多的字段可能会被添加到 API 响应中，较旧的客户端将会接收到所有新的数据字段，即使是那些它们不需要的字段，结果它会增加负载大小并引起更大的延迟。</li>
</ul>
<h3 id="RPC-与-REST-比较"><a href="#RPC-与-REST-比较" class="headerlink" title="RPC 与 REST 比较"></a>RPC 与 REST 比较</h3><table>
<thead>
<tr>
<th>操作</th>
<th>RPC</th>
<th>REST</th>
</tr>
</thead>
<tbody><tr>
<td>注册</td>
<td><strong>POST</strong> /signup</td>
<td><strong>POST</strong> /persons</td>
</tr>
<tr>
<td>注销</td>
<td><strong>POST</strong> /resign</td>
<td></td>
</tr>
</tbody></table>
<p>{<br>“personid”: “1234”<br>} | <strong>DELETE</strong> /persons/1234 |<br>| 读取用户信息 | <strong>GET</strong> /readPerson?personid=1234 | <strong>GET</strong> /persons/1234 |<br>| 读取用户物品列表 | <strong>GET</strong> /readUsersItemsList?personid=1234 | <strong>GET</strong> /persons/1234/items |<br>| 向用户物品列表添加一项 | <strong>POST</strong> /addItemToUsersItemsList<br>{<br>“personid”: “1234”;<br>“itemid”: “456”<br>} | <strong>POST</strong> /persons/1234/items<br>{<br>“itemid”: “456”<br>} |<br>| 更新一个物品 | <strong>POST</strong> /modifyItem<br>{<br>“itemid”: “456”;<br>“key”: “value”<br>} | <strong>PUT</strong> /items/456<br>{<br>“key”: “value”<br>} |<br>| 删除一个物品 | <strong>POST</strong> /removeItem<br>{<br>“itemid”: “456”<br>} | <strong>DELETE</strong> /items/456 |</p>
<p><strong><a target="_blank" rel="noopener" href="https://apihandyman.io/do-you-really-know-why-you-prefer-rest-over-rpc">资料来源：你真的知道你为什么更喜欢 REST 而不是 RPC 吗</a></strong></p>
<h4 id="来源及延伸阅读：REST-与-RPC"><a href="#来源及延伸阅读：REST-与-RPC" class="headerlink" title="来源及延伸阅读：REST 与 RPC"></a>来源及延伸阅读：REST 与 RPC</h4><ul>
<li><a target="_blank" rel="noopener" href="https://apihandyman.io/do-you-really-know-why-you-prefer-rest-over-rpc/">你真的知道你为什么更喜欢 REST 而不是 RPC 吗</a></li>
<li><a target="_blank" rel="noopener" href="http://programmers.stackexchange.com/a/181186">什么时候 RPC 比 REST 更合适？</a></li>
<li><a target="_blank" rel="noopener" href="http://stackoverflow.com/questions/15056878/rest-vs-json-rpc">REST vs JSON-RPC</a></li>
<li><a target="_blank" rel="noopener" href="http://etherealbits.com/2012/12/debunking-the-myths-of-rpc-rest/">揭开 RPC 和 REST 的神秘面纱</a></li>
<li><a target="_blank" rel="noopener" href="https://www.quora.com/What-are-the-drawbacks-of-using-RESTful-APIs">使用 REST 的缺点是什么</a></li>
<li><a target="_blank" rel="noopener" href="http://www.puncsky.com/blog/2016-02-13-crack-the-system-design-interview">破解系统设计面试</a></li>
<li><a target="_blank" rel="noopener" href="https://code.facebook.com/posts/1468950976659943/">Thrift</a></li>
<li><a target="_blank" rel="noopener" href="http://arstechnica.com/civis/viewtopic.php?t=1190508">为什么在内部使用 REST 而不是 RPC</a></li>
</ul>
<h2 id="安全"><a href="#安全" class="headerlink" title="安全"></a>安全</h2><p>这一部分需要更多内容。<a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%B4%A1%E7%8C%AE">一起来吧</a>！<br>安全是一个宽泛的话题。除非你有相当的经验、安全方面背景或者正在申请的职位要求安全知识，你不需要了解安全基础知识以外的内容：</p>
<ul>
<li>在运输和等待过程中加密</li>
<li>对所有的用户输入和从用户那里发来的参数进行处理以防止 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Cross-site_scripting">XSS</a> 和 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/SQL_injection">SQL 注入</a>。</li>
<li>使用参数化的查询来防止 SQL 注入。</li>
<li>使用<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Principle_of_least_privilege">最小权限原则</a>。</li>
</ul>
<h3 id="来源及延伸阅读-12"><a href="#来源及延伸阅读-12" class="headerlink" title="来源及延伸阅读"></a>来源及延伸阅读</h3><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/FallibleInc/security-guide-for-developers">为开发者准备的安全引导</a></li>
<li><a target="_blank" rel="noopener" href="https://www.owasp.org/index.php/OWASP_Top_Ten_Cheat_Sheet">OWASP top ten</a></li>
</ul>
<h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><p>一些时候你会被要求做出保守估计。比如，你可能需要估计从磁盘中生成 100 张图片的缩略图需要的时间或者一个数据结构需要多少的内存。<strong>2 的次方表</strong>和<strong>每个开发者都需要知道的一些时间数据</strong>（译注：OSChina 上有这篇文章的<a target="_blank" rel="noopener" href="https://www.oschina.net/news/30009/every-programmer-should-know">译文</a>）都是一些很方便的参考资料。</p>
<h3 id="2-的次方表"><a href="#2-的次方表" class="headerlink" title="2 的次方表"></a>2 的次方表</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Power           Exact Value         Approx Value        Bytes</span><br><span class="line">---------------------------------------------------------------</span><br><span class="line">7                             128</span><br><span class="line">8                             256</span><br><span class="line">10                           1024   1 thousand           1 KB</span><br><span class="line">16                         65,536                       64 KB</span><br><span class="line">20                      1,048,576   1 million            1 MB</span><br><span class="line">30                  1,073,741,824   1 billion            1 GB</span><br><span class="line">32                  4,294,967,296                        4 GB</span><br><span class="line">40              1,099,511,627,776   1 trillion           1 TB</span><br></pre></td></tr></table></figure>

<h4 id="来源及延伸阅读-13"><a href="#来源及延伸阅读-13" class="headerlink" title="来源及延伸阅读"></a>来源及延伸阅读</h4><ul>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Power_of_two">2 的次方</a></li>
</ul>
<h3 id="每个程序员都应该知道的延迟数"><a href="#每个程序员都应该知道的延迟数" class="headerlink" title="每个程序员都应该知道的延迟数"></a>每个程序员都应该知道的延迟数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Latency Comparison Numbers</span><br><span class="line">--------------------------</span><br><span class="line">L1 cache reference                           0.5 ns</span><br><span class="line">Branch mispredict                            5   ns</span><br><span class="line">L2 cache reference                           7   ns                      14x L1 cache</span><br><span class="line">Mutex lock&#x2F;unlock                           25   ns</span><br><span class="line">Main memory reference                      100   ns                      20x L2 cache, 200x L1 cache</span><br><span class="line">Compress 1K bytes with Zippy            10,000   ns       10 us</span><br><span class="line">Send 1 KB bytes over 1 Gbps network     10,000   ns       10 us</span><br><span class="line">Read 4 KB randomly from SSD*           150,000   ns      150 us          ~1GB&#x2F;sec SSD</span><br><span class="line">Read 1 MB sequentially from memory     250,000   ns      250 us</span><br><span class="line">Round trip within same datacenter      500,000   ns      500 us</span><br><span class="line">Read 1 MB sequentially from SSD*     1,000,000   ns    1,000 us    1 ms  ~1GB&#x2F;sec SSD, 4X memory</span><br><span class="line">Disk seek                           10,000,000   ns   10,000 us   10 ms  20x datacenter roundtrip</span><br><span class="line">Read 1 MB sequentially from 1 Gbps  10,000,000   ns   10,000 us   10 ms  40x memory, 10X SSD</span><br><span class="line">Read 1 MB sequentially from disk    30,000,000   ns   30,000 us   30 ms 120x memory, 30X SSD</span><br><span class="line">Send packet CA-&gt;Netherlands-&gt;CA    150,000,000   ns  150,000 us  150 ms</span><br><span class="line">Notes</span><br><span class="line">-----</span><br><span class="line">1 ns &#x3D; 10^-9 seconds</span><br><span class="line">1 us &#x3D; 10^-6 seconds &#x3D; 1,000 ns</span><br><span class="line">1 ms &#x3D; 10^-3 seconds &#x3D; 1,000 us &#x3D; 1,000,000 ns</span><br></pre></td></tr></table></figure>

<p>基于上述数字的指标：</p>
<ul>
<li>从磁盘以 30 MB/s 的速度顺序读取</li>
<li>以 100 MB/s 从 1 Gbps 的以太网顺序读取</li>
<li>从 SSD 以 1 GB/s 的速度读取</li>
<li>以 4 GB/s 的速度从主存读取</li>
<li>每秒能绕地球 6-7 圈</li>
<li>数据中心内每秒有 2,000 次往返</li>
</ul>
<h4 id="延迟数可视化"><a href="#延迟数可视化" class="headerlink" title="延迟数可视化"></a>延迟数可视化</h4><p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/77f72259e1eb58596b564d1ad823af1853bc60a3/687474703a2f2f692e696d6775722e636f6d2f6b307431652e706e67"><img src="https://camo.githubusercontent.com/77f72259e1eb58596b564d1ad823af1853bc60a3/687474703a2f2f692e696d6775722e636f6d2f6b307431652e706e67#align=left&display=inline&height=512&margin=%5Bobject%20Object%5D&originHeight=512&originWidth=1024&status=done&style=none&width=1024"></a></p>
<h4 id="来源及延伸阅读-14"><a href="#来源及延伸阅读-14" class="headerlink" title="来源及延伸阅读"></a>来源及延伸阅读</h4><ul>
<li><a target="_blank" rel="noopener" href="https://gist.github.com/jboner/2841832">每个程序员都应该知道的延迟数 — 1</a></li>
<li><a target="_blank" rel="noopener" href="https://gist.github.com/hellerbarde/2843375">每个程序员都应该知道的延迟数 — 2</a></li>
<li><a target="_blank" rel="noopener" href="http://www.cs.cornell.edu/projects/ladis2009/talks/dean-keynote-ladis2009.pdf">关于建设大型分布式系统的的设计方案、课程和建议</a></li>
<li><a target="_blank" rel="noopener" href="https://static.googleusercontent.com/media/research.google.com/en//people/jeff/stanford-295-talk.pdf">关于建设大型可拓展分布式系统的软件工程咨询</a></li>
</ul>
<h3 id="其它的系统设计面试题"><a href="#其它的系统设计面试题" class="headerlink" title="其它的系统设计面试题"></a>其它的系统设计面试题</h3><blockquote>
<p>常见的系统设计面试问题，给出了如何解决的方案链接</p>
</blockquote>
<table>
<thead>
<tr>
<th>问题</th>
<th>引用</th>
</tr>
</thead>
<tbody><tr>
<td>设计类似于 Dropbox 的文件同步服务</td>
<td><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=PE4gwstWhmc">youtube.com</a></td>
</tr>
<tr>
<td>设计类似于 Google 的搜索引擎</td>
<td><a target="_blank" rel="noopener" href="http://queue.acm.org/detail.cfm?id=988407">queue.acm.org</a></td>
</tr>
</tbody></table>
<p><a target="_blank" rel="noopener" href="http://programmers.stackexchange.com/questions/38324/interview-question-how-would-you-implement-google-search">stackexchange.com</a><br><a target="_blank" rel="noopener" href="http://www.ardendertat.com/2012/01/11/implementing-search-engines/">ardendertat.com</a><br><a target="_blank" rel="noopener" href="http://infolab.stanford.edu/~backrub/google.html">stanford.edu</a> |<br>| 设计类似于 Google 的可扩展网络爬虫 | <a target="_blank" rel="noopener" href="https://www.quora.com/How-can-I-build-a-web-crawler-from-scratch">quora.com</a> |<br>| 设计 Google 文档 | <a target="_blank" rel="noopener" href="https://code.google.com/p/google-mobwrite/">code.google.com</a><br><a target="_blank" rel="noopener" href="https://neil.fraser.name/writing/sync/">neil.fraser.name</a> |<br>| 设计类似 Redis 的键值存储 | <a target="_blank" rel="noopener" href="http://www.slideshare.net/dvirsky/introduction-to-redis">slideshare.net</a> |<br>| 设计类似 Memcached 的缓存系统 | <a target="_blank" rel="noopener" href="http://www.slideshare.net/oemebamo/introduction-to-memcached">slideshare.net</a> |<br>| 设计类似亚马逊的推荐系统 | <a target="_blank" rel="noopener" href="http://tech.hulu.com/blog/2011/09/19/recommendation-system.html">hulu.com</a><br><a target="_blank" rel="noopener" href="http://ijcai13.org/files/tutorial_slides/td3.pdf">ijcai13.org</a> |<br>| 设计类似 Bitly 的短链接系统 | <a target="_blank" rel="noopener" href="http://n00tc0d3r.blogspot.com/">n00tc0d3r.blogspot.com</a> |<br>| 设计类似 WhatsApp 的聊天应用 | <a target="_blank" rel="noopener" href="http://highscalability.com/blog/2014/2/26/the-whatsapp-architecture-facebook-bought-for-19-billion.html">highscalability.com</a> |<br>| 设计类似 Instagram 的图片分享系统 | <a target="_blank" rel="noopener" href="http://highscalability.com/flickr-architecture">highscalability.com</a><br><a target="_blank" rel="noopener" href="http://highscalability.com/blog/2011/12/6/instagram-architecture-14-million-users-terabytes-of-photos.html">highscalability.com</a> |<br>| 设计 Facebook 的新闻推荐方法 | <a target="_blank" rel="noopener" href="http://www.quora.com/What-are-best-practices-for-building-something-like-a-News-Feed">quora.com</a><br><a target="_blank" rel="noopener" href="http://www.quora.com/Activity-Streams/What-are-the-scaling-issues-to-keep-in-mind-while-developing-a-social-network-feed">quora.com</a><br><a target="_blank" rel="noopener" href="http://www.slideshare.net/danmckinley/etsy-activity-feeds-architecture">slideshare.net</a> |<br>| 设计 Facebook 的时间线系统 | <a target="_blank" rel="noopener" href="https://www.facebook.com/note.php?note_id=10150468255628920">facebook.com</a><br><a target="_blank" rel="noopener" href="http://highscalability.com/blog/2012/1/23/facebook-timeline-brought-to-you-by-the-power-of-denormaliza.html">highscalability.com</a> |<br>| 设计 Facebook 的聊天系统 | <a target="_blank" rel="noopener" href="http://www.erlang-factory.com/upload/presentations/31/EugeneLetuchy-ErlangatFacebook.pdf">erlang-factory.com</a><br><a target="_blank" rel="noopener" href="https://www.facebook.com/note.php?note_id=14218138919&id=9445547199&index=0">facebook.com</a> |<br>| 设计类似 Facebook 的图表搜索系统 | <a target="_blank" rel="noopener" href="https://www.facebook.com/notes/facebook-engineering/under-the-hood-building-out-the-infrastructure-for-graph-search/10151347573598920">facebook.com</a><br><a target="_blank" rel="noopener" href="https://www.facebook.com/notes/facebook-engineering/under-the-hood-indexing-and-ranking-in-graph-search/10151361720763920">facebook.com</a><br><a target="_blank" rel="noopener" href="https://www.facebook.com/notes/facebook-engineering/under-the-hood-the-natural-language-interface-of-graph-search/10151432733048920">facebook.com</a> |<br>| 设计类似 CloudFlare 的内容传递网络 | <a target="_blank" rel="noopener" href="http://repository.cmu.edu/cgi/viewcontent.cgi?article=2112&context=compsci">cmu.edu</a> |<br>| 设计类似 Twitter 的热门话题系统 | <a target="_blank" rel="noopener" href="http://www.michael-noll.com/blog/2013/01/18/implementing-real-time-trending-topics-in-storm/">michael-noll.com</a><br><a target="_blank" rel="noopener" href="http://snikolov.wordpress.com/2012/11/14/early-detection-of-twitter-trends/">snikolov .wordpress.com</a> |<br>| 设计一个随机 ID 生成系统 | <a target="_blank" rel="noopener" href="https://blog.twitter.com/2010/announcing-snowflake">blog.twitter.com</a><br><a target="_blank" rel="noopener" href="https://github.com/twitter/snowflake/">github.com</a> |<br>| 返回一定时间段内次数前 k 高的请求 | <a target="_blank" rel="noopener" href="https://icmi.cs.ucsb.edu/research/tech_reports/reports/2005-23.pdf">ucsb.edu</a><br><a target="_blank" rel="noopener" href="http://davis.wpi.edu/xmdv/docs/EDBT11-diyang.pdf">wpi.edu</a> |<br>| 设计一个数据源于多个数据中心的服务系统 | <a target="_blank" rel="noopener" href="http://highscalability.com/blog/2009/8/24/how-google-serves-data-from-multiple-datacenters.html">highscalability.com</a> |<br>| 设计一个多人网络卡牌游戏 | <a target="_blank" rel="noopener" href="http://www.indieflashblog.com/how-to-create-an-asynchronous-multiplayer-game.html">indieflashblog.com</a><br><a target="_blank" rel="noopener" href="http://buildnewgames.com/real-time-multiplayer/">buildnewgames.com</a> |<br>| 设计一个垃圾回收系统 | <a target="_blank" rel="noopener" href="http://journal.stuffwithstuff.com/2013/12/08/babys-first-garbage-collector/">stuffwithstuff.com</a><br><a target="_blank" rel="noopener" href="http://courses.cs.washington.edu/courses/csep521/07wi/prj/rick.pdf">washington.edu</a> |<br>| 添加更多的系统设计问题 | <a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%B4%A1%E7%8C%AE">贡献</a> |</p>
<h3 id="真实架构"><a href="#真实架构" class="headerlink" title="真实架构"></a>真实架构</h3><blockquote>
<p>关于现实中真实的系统是怎么设计的文章。</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/images/TcUo2fw.png"><img src="https://github.com/donnemartin/system-design-primer/raw/master/images/TcUo2fw.png#align=left&display=inline&height=1101&margin=%5Bobject%20Object%5D&originHeight=1101&originWidth=1475&status=done&style=none&width=1475"></a><br><strong><a target="_blank" rel="noopener" href="https://www.infoq.com/presentations/Twitter-Timeline-Scalability">Source: Twitter timelines at scale</a></strong><br><strong>不要专注于以下文章的细节，专注于以下方面：</strong></p>
<ul>
<li>发现这些文章中的共同的原则、技术和模式。</li>
<li>学习每个组件解决哪些问题，什么情况下使用，什么情况下不适用</li>
<li>复习学过的文章<table>
<thead>
<tr>
<th>类型</th>
<th>系统</th>
<th>引用</th>
</tr>
</thead>
<tbody><tr>
<td>Data processing</td>
<td><strong>MapReduce</strong> - Google 的分布式数据处理</td>
<td><a target="_blank" rel="noopener" href="http://static.googleusercontent.com/media/research.google.com/zh-CN/us/archive/mapreduce-osdi04.pdf">research.google.com</a></td>
</tr>
<tr>
<td>Data processing</td>
<td><strong>Spark</strong> - Databricks 的分布式数据处理</td>
<td><a target="_blank" rel="noopener" href="http://www.slideshare.net/AGrishchenko/apache-spark-architecture">slideshare.net</a></td>
</tr>
<tr>
<td>Data processing</td>
<td><strong>Storm</strong> - Twitter 的分布式数据处理</td>
<td><a target="_blank" rel="noopener" href="http://www.slideshare.net/previa/storm-16094009">slideshare.net</a></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Data store</td>
<td><strong>Bigtable</strong> - Google 的列式数据库</td>
<td><a target="_blank" rel="noopener" href="http://www.read.seas.harvard.edu/~kohler/class/cs239-w08/chang06bigtable.pdf">harvard.edu</a></td>
</tr>
<tr>
<td>Data store</td>
<td><strong>HBase</strong> - Bigtable 的开源实现</td>
<td><a target="_blank" rel="noopener" href="http://www.slideshare.net/alexbaranau/intro-to-hbase">slideshare.net</a></td>
</tr>
<tr>
<td>Data store</td>
<td><strong>Cassandra</strong> - Facebook 的列式数据库</td>
<td><a target="_blank" rel="noopener" href="http://www.slideshare.net/planetcassandra/cassandra-introduction-features-30103666">slideshare.net</a></td>
</tr>
<tr>
<td>Data store</td>
<td><strong>DynamoDB</strong> - Amazon 的文档数据库</td>
<td><a target="_blank" rel="noopener" href="http://www.read.seas.harvard.edu/~kohler/class/cs239-w08/decandia07dynamo.pdf">harvard.edu</a></td>
</tr>
<tr>
<td>Data store</td>
<td><strong>MongoDB</strong> - 文档数据库</td>
<td><a target="_blank" rel="noopener" href="http://www.slideshare.net/mdirolf/introduction-to-mongodb">slideshare.net</a></td>
</tr>
<tr>
<td>Data store</td>
<td><strong>Spanner</strong> - Google 的全球分布数据库</td>
<td><a target="_blank" rel="noopener" href="http://research.google.com/archive/spanner-osdi2012.pdf">research.google.com</a></td>
</tr>
<tr>
<td>Data store</td>
<td><strong>Memcached</strong> - 分布式内存缓存系统</td>
<td><a target="_blank" rel="noopener" href="http://www.slideshare.net/oemebamo/introduction-to-memcached">slideshare.net</a></td>
</tr>
<tr>
<td>Data store</td>
<td><strong>Redis</strong> - 能够持久化及具有值类型的分布式内存缓存系统</td>
<td><a target="_blank" rel="noopener" href="http://www.slideshare.net/dvirsky/introduction-to-redis">slideshare.net</a></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>File system</td>
<td><strong>Google File System (GFS)</strong> - 分布式文件系统</td>
<td><a target="_blank" rel="noopener" href="http://static.googleusercontent.com/media/research.google.com/zh-CN/us/archive/gfs-sosp2003.pdf">research.google.com</a></td>
</tr>
<tr>
<td>File system</td>
<td><strong>Hadoop File System (HDFS)</strong> - GFS 的开源实现</td>
<td><a target="_blank" rel="noopener" href="https://hadoop.apache.org/docs/r1.2.1/hdfs_design.html">apache.org</a></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Misc</td>
<td><strong>Chubby</strong> - Google 的分布式系统的低耦合锁服务</td>
<td><a target="_blank" rel="noopener" href="http://static.googleusercontent.com/external_content/untrusted_dlcp/research.google.com/en/us/archive/chubby-osdi06.pdf">research.google.com</a></td>
</tr>
<tr>
<td>Misc</td>
<td><strong>Dapper</strong> - 分布式系统跟踪基础设施</td>
<td><a target="_blank" rel="noopener" href="http://static.googleusercontent.com/media/research.google.com/en//pubs/archive/36356.pdf">research.google.com</a></td>
</tr>
<tr>
<td>Misc</td>
<td><strong>Kafka</strong> - LinkedIn 的发布订阅消息系统</td>
<td><a target="_blank" rel="noopener" href="http://www.slideshare.net/mumrah/kafka-talk-tri-hug">slideshare.net</a></td>
</tr>
<tr>
<td>Misc</td>
<td><strong>Zookeeper</strong> - 集中的基础架构和协调服务</td>
<td><a target="_blank" rel="noopener" href="http://www.slideshare.net/sauravhaloi/introduction-to-apache-zookeeper">slideshare.net</a></td>
</tr>
<tr>
<td></td>
<td>添加更多</td>
<td><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%B4%A1%E7%8C%AE">贡献</a></td>
</tr>
</tbody></table>
</li>
</ul>
<h3 id="公司的系统架构"><a href="#公司的系统架构" class="headerlink" title="公司的系统架构"></a>公司的系统架构</h3><table>
<thead>
<tr>
<th>Company</th>
<th>Reference(s)</th>
</tr>
</thead>
<tbody><tr>
<td>Amazon</td>
<td><a target="_blank" rel="noopener" href="http://highscalability.com/amazon-architecture">Amazon 的架构</a></td>
</tr>
<tr>
<td>Cinchcast</td>
<td><a target="_blank" rel="noopener" href="http://highscalability.com/blog/2012/7/16/cinchcast-architecture-producing-1500-hours-of-audio-every-d.html">每天产生 1500 小时的音频</a></td>
</tr>
<tr>
<td>DataSift</td>
<td><a target="_blank" rel="noopener" href="http://highscalability.com/blog/2011/11/29/datasift-architecture-realtime-datamining-at-120000-tweets-p.html">每秒实时挖掘 120000 条 tweet</a></td>
</tr>
<tr>
<td>DropBox</td>
<td><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=PE4gwstWhmc">我们如何缩放 Dropbox</a></td>
</tr>
<tr>
<td>ESPN</td>
<td><a target="_blank" rel="noopener" href="http://highscalability.com/blog/2013/11/4/espns-architecture-at-scale-operating-at-100000-duh-nuh-nuhs.html">每秒操作 100000 次</a></td>
</tr>
<tr>
<td>Google</td>
<td><a target="_blank" rel="noopener" href="http://highscalability.com/google-architecture">Google 的架构</a></td>
</tr>
<tr>
<td>Instagram</td>
<td><a target="_blank" rel="noopener" href="http://highscalability.com/blog/2011/12/6/instagram-architecture-14-million-users-terabytes-of-photos.html">1400 万用户，达到兆级别的照片存储</a></td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="http://instagram-engineering.tumblr.com/post/13649370142/what-powers-instagram-hundreds-of-instances">是什么在驱动 Instagram</a></td>
<td></td>
</tr>
<tr>
<td>Justin.tv</td>
<td><a target="_blank" rel="noopener" href="http://highscalability.com/blog/2010/3/16/justintvs-live-video-broadcasting-architecture.html">Justin.Tv 的直播广播架构</a></td>
</tr>
<tr>
<td>Facebook</td>
<td><a target="_blank" rel="noopener" href="https://cs.uwaterloo.ca/~brecht/courses/854-Emerging-2014/readings/key-value/fb-memcached-nsdi-2013.pdf">Facebook 的可扩展 memcached</a></td>
</tr>
</tbody></table>
<p><a target="_blank" rel="noopener" href="https://cs.uwaterloo.ca/~brecht/courses/854-Emerging-2014/readings/data-store/tao-facebook-distributed-datastore-atc-2013.pdf">TAO: Facebook 社交图的分布式数据存储</a><br><a target="_blank" rel="noopener" href="https://www.usenix.org/legacy/event/osdi10/tech/full_papers/Beaver.pdf">Facebook 的图片存储</a> |<br>| Flickr | <a target="_blank" rel="noopener" href="http://highscalability.com/flickr-architecture">Flickr 的架构</a> |<br>| Mailbox | <a target="_blank" rel="noopener" href="http://highscalability.com/blog/2013/6/18/scaling-mailbox-from-0-to-one-million-users-in-6-weeks-and-1.html">在 6 周内从 0 到 100 万用户</a> |<br>| Pinterest | <a target="_blank" rel="noopener" href="http://highscalability.com/blog/2013/4/15/scaling-pinterest-from-0-to-10s-of-billions-of-page-views-a.html">从零到每月数十亿的浏览量</a><br><a target="_blank" rel="noopener" href="http://highscalability.com/blog/2012/5/21/pinterest-architecture-update-18-million-visitors-10x-growth.html">1800 万访问用户，10 倍增长，12 名员工</a> |<br>| Playfish | <a target="_blank" rel="noopener" href="http://highscalability.com/blog/2010/9/21/playfishs-social-gaming-architecture-50-million-monthly-user.html">月用户量 5000 万并在不断增长</a> |<br>| PlentyOfFish | <a target="_blank" rel="noopener" href="http://highscalability.com/plentyoffish-architecture">PlentyOfFish 的架构</a> |<br>| Salesforce | <a target="_blank" rel="noopener" href="http://highscalability.com/blog/2013/9/23/salesforce-architecture-how-they-handle-13-billion-transacti.html">他们每天如何处理 13 亿笔交易</a> |<br>| Stack Overflow | <a target="_blank" rel="noopener" href="http://highscalability.com/blog/2009/8/5/stack-overflow-architecture.html">Stack Overflow 的架构</a> |<br>| TripAdvisor | <a target="_blank" rel="noopener" href="http://highscalability.com/blog/2011/6/27/tripadvisor-architecture-40m-visitors-200m-dynamic-page-view.html">40M 访问者，200M 页面浏览量，30TB 数据</a> |<br>| Tumblr | <a target="_blank" rel="noopener" href="http://highscalability.com/blog/2012/2/13/tumblr-architecture-15-billion-page-views-a-month-and-harder.html">每月 150 亿的浏览量</a> |<br>| Twitter | <a target="_blank" rel="noopener" href="http://highscalability.com/scaling-twitter-making-twitter-10000-percent-faster">Making Twitter 10000 percent faster</a><br><a target="_blank" rel="noopener" href="http://highscalability.com/blog/2011/12/19/how-twitter-stores-250-million-tweets-a-day-using-mysql.html">每天使用 MySQL 存储 2.5 亿条 tweet</a><br><a target="_blank" rel="noopener" href="http://highscalability.com/blog/2013/7/8/the-architecture-twitter-uses-to-deal-with-150m-active-users.html">150M 活跃用户，300K QPS，22 MB/S 的防火墙</a><br><a target="_blank" rel="noopener" href="https://www.infoq.com/presentations/Twitter-Timeline-Scalability">可扩展时间表</a><br><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=5cKTP36HVgI">Twitter 的大小数据</a><br><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=z8LU0Cj6BOU">Twitter 的行为：规模超过 1 亿用户</a> |<br>| Uber | <a target="_blank" rel="noopener" href="http://highscalability.com/blog/2015/9/14/how-uber-scales-their-real-time-market-platform.html">Uber 如何扩展自己的实时化市场</a> |<br>| WhatsApp | <a target="_blank" rel="noopener" href="http://highscalability.com/blog/2014/2/26/the-whatsapp-architecture-facebook-bought-for-19-billion.html">Facebook 用 190 亿美元购买 WhatsApp 的架构</a> |<br>| YouTube | <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=w5WVu624fY8">YouTube 的可扩展性</a><br><a target="_blank" rel="noopener" href="http://highscalability.com/youtube-architecture">YouTube 的架构</a> |</p>
<h3 id="公司工程博客"><a href="#公司工程博客" class="headerlink" title="公司工程博客"></a>公司工程博客</h3><blockquote>
<p>你即将面试的公司的架构<br>你面对的问题可能就来自于同样领域</p>
</blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="http://nerds.airbnb.com/">Airbnb Engineering</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.atlassian.com/blog/">Atlassian Developers</a></li>
<li><a target="_blank" rel="noopener" href="http://cloudengineering.autodesk.com/blog/">Autodesk Engineering</a></li>
<li><a target="_blank" rel="noopener" href="https://aws.amazon.com/blogs/aws/">AWS Blog</a></li>
<li><a target="_blank" rel="noopener" href="http://word.bitly.com/">Bitly Engineering Blog</a></li>
<li><a target="_blank" rel="noopener" href="https://www.box.com/blog/engineering/">Box Blogs</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.cloudera.com/blog/">Cloudera Developer Blog</a></li>
<li><a target="_blank" rel="noopener" href="https://tech.dropbox.com/">Dropbox Tech Blog</a></li>
<li><a target="_blank" rel="noopener" href="http://engineering.quora.com/">Engineering at Quora</a></li>
<li><a target="_blank" rel="noopener" href="http://www.ebaytechblog.com/">Ebay Tech Blog</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.evernote.com/tech/">Evernote Tech Blog</a></li>
<li><a target="_blank" rel="noopener" href="http://codeascraft.com/">Etsy Code as Craft</a></li>
<li><a target="_blank" rel="noopener" href="https://www.facebook.com/Engineering">Facebook Engineering</a></li>
<li><a target="_blank" rel="noopener" href="http://code.flickr.net/">Flickr Code</a></li>
<li><a target="_blank" rel="noopener" href="http://engineering.foursquare.com/">Foursquare Engineering Blog</a></li>
<li><a target="_blank" rel="noopener" href="http://githubengineering.com/">GitHub Engineering Blog</a></li>
<li><a target="_blank" rel="noopener" href="http://googleresearch.blogspot.com/">Google Research Blog</a></li>
<li><a target="_blank" rel="noopener" href="https://engineering.groupon.com/">Groupon Engineering Blog</a></li>
<li><a target="_blank" rel="noopener" href="https://engineering.heroku.com/">Heroku Engineering Blog</a></li>
<li><a target="_blank" rel="noopener" href="http://product.hubspot.com/blog/topic/engineering">Hubspot Engineering Blog</a></li>
<li><a target="_blank" rel="noopener" href="http://highscalability.com/">High Scalability</a></li>
<li><a target="_blank" rel="noopener" href="http://instagram-engineering.tumblr.com/">Instagram Engineering</a></li>
<li><a target="_blank" rel="noopener" href="https://software.intel.com/en-us/blogs/">Intel Software Blog</a></li>
<li><a target="_blank" rel="noopener" href="https://blogs.janestreet.com/category/ocaml/">Jane Street Tech Blog</a></li>
<li><a target="_blank" rel="noopener" href="http://engineering.linkedin.com/blog">LinkedIn Engineering</a></li>
<li><a target="_blank" rel="noopener" href="https://engineering.microsoft.com/">Microsoft Engineering</a></li>
<li><a target="_blank" rel="noopener" href="https://blogs.msdn.microsoft.com/pythonengineering/">Microsoft Python Engineering</a></li>
<li><a target="_blank" rel="noopener" href="http://techblog.netflix.com/">Netflix Tech Blog</a></li>
<li><a target="_blank" rel="noopener" href="https://devblog.paypal.com/category/engineering/">Paypal Developer Blog</a></li>
<li><a target="_blank" rel="noopener" href="http://engineering.pinterest.com/">Pinterest Engineering Blog</a></li>
<li><a target="_blank" rel="noopener" href="https://engineering.quora.com/">Quora Engineering</a></li>
<li><a target="_blank" rel="noopener" href="http://www.redditblog.com/">Reddit Blog</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.salesforce.com/blogs/engineering/">Salesforce Engineering Blog</a></li>
<li><a target="_blank" rel="noopener" href="https://slack.engineering/">Slack Engineering Blog</a></li>
<li><a target="_blank" rel="noopener" href="https://labs.spotify.com/">Spotify Labs</a></li>
<li><a target="_blank" rel="noopener" href="http://www.twilio.com/engineering">Twilio Engineering Blog</a></li>
<li><a target="_blank" rel="noopener" href="https://engineering.twitter.com/">Twitter Engineering</a></li>
<li><a target="_blank" rel="noopener" href="http://eng.uber.com/">Uber Engineering Blog</a></li>
<li><a target="_blank" rel="noopener" href="http://yahooeng.tumblr.com/">Yahoo Engineering Blog</a></li>
<li><a target="_blank" rel="noopener" href="http://engineeringblog.yelp.com/">Yelp Engineering Blog</a></li>
<li><a target="_blank" rel="noopener" href="https://www.zynga.com/blogs/engineering">Zynga Engineering Blog</a></li>
</ul>
<h4 id="来源及延伸阅读-15"><a href="#来源及延伸阅读-15" class="headerlink" title="来源及延伸阅读"></a>来源及延伸阅读</h4><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/kilimchoi/engineering-blogs">kilimchoi/engineering-blogs</a></li>
</ul>
<h2 id="正在完善中"><a href="#正在完善中" class="headerlink" title="正在完善中"></a>正在完善中</h2><p>有兴趣加入添加一些部分或者帮助完善某些部分吗？<a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%B4%A1%E7%8C%AE">加入进来吧</a>！</p>
<ul>
<li>使用 MapReduce 进行分布式计算</li>
<li>一致性哈希</li>
<li>直接存储器访问（DMA）控制器</li>
<li><a target="_blank" rel="noopener" href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%B4%A1%E7%8C%AE">贡献</a></li>
</ul>
<h2 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h2><p>整个仓库都提供了证书和源<br>特别鸣谢：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://www.hiredintech.com/system-design/the-system-design-process/">Hired in tech</a></li>
<li><a target="_blank" rel="noopener" href="https://www.amazon.com/dp/0984782850/">Cracking the coding interview</a></li>
<li><a target="_blank" rel="noopener" href="http://highscalability.com/">High scalability</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/checkcheckzz/system-design-interview">checkcheckzz/system-design-interview</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/shashank88/system_design">shashank88/system_design</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mmcgrana/services-engineering">mmcgrana/services-engineering</a></li>
<li><a target="_blank" rel="noopener" href="https://gist.github.com/vasanthk/485d1c25737e8e72759f">System design cheat sheet</a></li>
<li><a target="_blank" rel="noopener" href="http://dancres.github.io/Pages/">A distributed systems reading list</a></li>
<li><a target="_blank" rel="noopener" href="http://www.puncsky.com/blog/2016-02-13-crack-the-system-design-interview">Cracking the system design interview</a></li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2021/02/15/yuque/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E5%85%A5%E9%97%A8/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-yuque/正向代理 golang实现" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/02/15/yuque/%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86%20golang%E5%AE%9E%E7%8E%B0/">正向代理 golang实现</a>
    </h1>
  

        
        <a href="/2021/02/15/yuque/%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86%20golang%E5%AE%9E%E7%8E%B0/" class="archive-article-date">
  	<time datetime="2021-02-15T15:31:10.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2021-02-15</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;flag&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/rs/zerolog&quot;</span></span><br><span class="line">    <span class="string">&quot;net&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> logger = zerolog.New(os.Stdout).With().Timestamp().Logger()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    help := flag.Bool(<span class="string">&quot;help&quot;</span>, <span class="literal">false</span>, <span class="string">&quot;print usage&quot;</span>)</span><br><span class="line">    bind := flag.String(<span class="string">&quot;bind&quot;</span>, <span class="string">&quot;127.0.0.1:6000&quot;</span>, <span class="string">&quot;The address to bind to&quot;</span>)</span><br><span class="line">    backend := flag.String(<span class="string">&quot;backend&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;The backend server address&quot;</span>)</span><br><span class="line">    flag.Parse()</span><br><span class="line"></span><br><span class="line">    logger.Level(zerolog.DebugLevel)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> *help &#123;</span><br><span class="line">        flag.Usage()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> *backend == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">        flag.Usage()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> *bind == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">        <span class="comment">//use default bind</span></span><br><span class="line">        logger.Info().Str(<span class="string">&quot;bind&quot;</span>, *bind).Msg(<span class="string">&quot;use default bind&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    success, err := RunProxy(*bind, *backend)</span><br><span class="line">    <span class="keyword">if</span> !success &#123;</span><br><span class="line">        logger.Error().Err(err).Send()</span><br><span class="line">        os.Exit(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RunProxy</span><span class="params">(bind, backend <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">bool</span>, error)</span></span> &#123;</span><br><span class="line">    listener, err := net.Listen(<span class="string">&quot;tcp&quot;</span>, bind)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> listener.Close()</span><br><span class="line">    logger.Info().Str(<span class="string">&quot;bind&quot;</span>, bind).Str(<span class="string">&quot;backend&quot;</span>, backend).Msg(<span class="string">&quot;tcp-proxy started.&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        conn, err := listener.Accept()</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            logger.Error().Err(err).Send()</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">go</span> ConnectionHandler(conn, backend)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ConnectionHandler</span><span class="params">(conn net.Conn, backend <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">    logger.Info().Str(<span class="string">&quot;conn&quot;</span>, conn.RemoteAddr().String()).Msg(<span class="string">&quot;client connected.&quot;</span>)</span><br><span class="line">    target, err := net.Dial(<span class="string">&quot;tcp&quot;</span>, backend)</span><br><span class="line">    <span class="keyword">defer</span> conn.Close()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        logger.Error().Err(err).Send()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">defer</span> target.Close()</span><br><span class="line">        logger.Info().Str(<span class="string">&quot;conn&quot;</span>, conn.RemoteAddr().String()).Str(<span class="string">&quot;backend&quot;</span>, target.LocalAddr().String()).Msg(<span class="string">&quot;backend connected.&quot;</span>)</span><br><span class="line">        closed := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>, <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">go</span> Proxy(conn, target, closed)</span><br><span class="line">        <span class="keyword">go</span> Proxy(target, conn, closed)</span><br><span class="line">        &lt;-closed</span><br><span class="line">        logger.Info().Str(<span class="string">&quot;conn&quot;</span>, conn.RemoteAddr().String()).Msg(<span class="string">&quot;Connection closed.&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Proxy</span><span class="params">(from net.Conn, to net.Conn, closed <span class="keyword">chan</span> <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">    buffer := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">4096</span>)</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        n1, err := from.Read(buffer)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            closed &lt;- <span class="literal">true</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        n2, err := to.Write(buffer[:n1])</span><br><span class="line">        logger.Debug().Str(<span class="string">&quot;from&quot;</span>, from.RemoteAddr().String()).Int(<span class="string">&quot;recv&quot;</span>, n1).Str(<span class="string">&quot;to&quot;</span>, to.RemoteAddr().String()).Int(<span class="string">&quot;send&quot;</span>, n2).Send()</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            closed &lt;- <span class="literal">true</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用方法 ./proxy –bind 0.0.0.0:6379 –backend 10.0.1.15:6379</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2021/02/15/yuque/%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86%20golang%E5%AE%9E%E7%8E%B0/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/">&amp;laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/17/">17</a><a class="extend next" rel="next" href="/page/3/">Next &amp;raquo;</a>
    </nav>
  


          </div>
        </div>
      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2021 Murphy Yi
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		mathjax: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		toc_hide_index: true,
		root: "/",
		innerArchive: true,
		showTags: false
	}
</script>

<script>!function(t){function n(e){if(r[e])return r[e].exports;var i=r[e]={exports:{},id:e,loaded:!1};return t[e].call(i.exports,i,i.exports,n),i.loaded=!0,i.exports}var r={};n.m=t,n.c=r,n.p="./",n(0)}([function(t,n,r){r(195),t.exports=r(191)},function(t,n,r){var e=r(3),i=r(52),o=r(27),u=r(28),c=r(53),f="prototype",a=function(t,n,r){var s,l,h,v,p=t&a.F,d=t&a.G,y=t&a.S,g=t&a.P,b=t&a.B,m=d?e:y?e[n]||(e[n]={}):(e[n]||{})[f],x=d?i:i[n]||(i[n]={}),w=x[f]||(x[f]={});d&&(r=n);for(s in r)l=!p&&m&&void 0!==m[s],h=(l?m:r)[s],v=b&&l?c(h,e):g&&"function"==typeof h?c(Function.call,h):h,m&&u(m,s,h,t&a.U),x[s]!=h&&o(x,s,v),g&&w[s]!=h&&(w[s]=h)};e.core=i,a.F=1,a.G=2,a.S=4,a.P=8,a.B=16,a.W=32,a.U=64,a.R=128,t.exports=a},function(t,n,r){var e=r(6);t.exports=function(t){if(!e(t))throw TypeError(t+" is not an object!");return t}},function(t,n){var r=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=r)},function(t,n){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,n){var r=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=r)},function(t,n){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,n,r){var e=r(126)("wks"),i=r(76),o=r(3).Symbol,u="function"==typeof o;(t.exports=function(t){return e[t]||(e[t]=u&&o[t]||(u?o:i)("Symbol."+t))}).store=e},function(t,n){var r={}.hasOwnProperty;t.exports=function(t,n){return r.call(t,n)}},function(t,n,r){var e=r(94),i=r(33);t.exports=function(t){return e(i(t))}},function(t,n,r){t.exports=!r(4)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,n,r){var e=r(2),i=r(167),o=r(50),u=Object.defineProperty;n.f=r(10)?Object.defineProperty:function(t,n,r){if(e(t),n=o(n,!0),e(r),i)try{return u(t,n,r)}catch(t){}if("get"in r||"set"in r)throw TypeError("Accessors not supported!");return"value"in r&&(t[n]=r.value),t}},function(t,n,r){t.exports=!r(18)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,n,r){var e=r(14),i=r(22);t.exports=r(12)?function(t,n,r){return e.f(t,n,i(1,r))}:function(t,n,r){return t[n]=r,t}},function(t,n,r){var e=r(20),i=r(58),o=r(42),u=Object.defineProperty;n.f=r(12)?Object.defineProperty:function(t,n,r){if(e(t),n=o(n,!0),e(r),i)try{return u(t,n,r)}catch(t){}if("get"in r||"set"in r)throw TypeError("Accessors not supported!");return"value"in r&&(t[n]=r.value),t}},function(t,n,r){var e=r(40)("wks"),i=r(23),o=r(5).Symbol,u="function"==typeof o;(t.exports=function(t){return e[t]||(e[t]=u&&o[t]||(u?o:i)("Symbol."+t))}).store=e},function(t,n,r){var e=r(67),i=Math.min;t.exports=function(t){return t>0?i(e(t),9007199254740991):0}},function(t,n,r){var e=r(46);t.exports=function(t){return Object(e(t))}},function(t,n){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,n,r){var e=r(63),i=r(34);t.exports=Object.keys||function(t){return e(t,i)}},function(t,n,r){var e=r(21);t.exports=function(t){if(!e(t))throw TypeError(t+" is not an object!");return t}},function(t,n){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,n){t.exports=function(t,n){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:n}}},function(t,n){var r=0,e=Math.random();t.exports=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++r+e).toString(36))}},function(t,n){var r={}.hasOwnProperty;t.exports=function(t,n){return r.call(t,n)}},function(t,n){var r=t.exports={version:"2.4.0"};"number"==typeof __e&&(__e=r)},function(t,n){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,n,r){var e=r(11),i=r(66);t.exports=r(10)?function(t,n,r){return e.f(t,n,i(1,r))}:function(t,n,r){return t[n]=r,t}},function(t,n,r){var e=r(3),i=r(27),o=r(24),u=r(76)("src"),c="toString",f=Function[c],a=(""+f).split(c);r(52).inspectSource=function(t){return f.call(t)},(t.exports=function(t,n,r,c){var f="function"==typeof r;f&&(o(r,"name")||i(r,"name",n)),t[n]!==r&&(f&&(o(r,u)||i(r,u,t[n]?""+t[n]:a.join(String(n)))),t===e?t[n]=r:c?t[n]?t[n]=r:i(t,n,r):(delete t[n],i(t,n,r)))})(Function.prototype,c,function(){return"function"==typeof this&&this[u]||f.call(this)})},function(t,n,r){var e=r(1),i=r(4),o=r(46),u=function(t,n,r,e){var i=String(o(t)),u="<"+n;return""!==r&&(u+=" "+r+'="'+String(e).replace(/"/g,"&quot;")+'"'),u+">"+i+"</"+n+">"};t.exports=function(t,n){var r={};r[t]=n(u),e(e.P+e.F*i(function(){var n=""[t]('"');return n!==n.toLowerCase()||n.split('"').length>3}),"String",r)}},function(t,n,r){var e=r(115),i=r(46);t.exports=function(t){return e(i(t))}},function(t,n,r){var e=r(116),i=r(66),o=r(30),u=r(50),c=r(24),f=r(167),a=Object.getOwnPropertyDescriptor;n.f=r(10)?a:function(t,n){if(t=o(t),n=u(n,!0),f)try{return a(t,n)}catch(t){}if(c(t,n))return i(!e.f.call(t,n),t[n])}},function(t,n,r){var e=r(24),i=r(17),o=r(145)("IE_PROTO"),u=Object.prototype;t.exports=Object.getPrototypeOf||function(t){return t=i(t),e(t,o)?t[o]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?u:null}},function(t,n){t.exports=function(t){if(void 0==t)throw TypeError("Can't call method on  "+t);return t}},function(t,n){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,n){t.exports={}},function(t,n){t.exports=!0},function(t,n){n.f={}.propertyIsEnumerable},function(t,n,r){var e=r(14).f,i=r(8),o=r(15)("toStringTag");t.exports=function(t,n,r){t&&!i(t=r?t:t.prototype,o)&&e(t,o,{configurable:!0,value:n})}},function(t,n,r){var e=r(40)("keys"),i=r(23);t.exports=function(t){return e[t]||(e[t]=i(t))}},function(t,n,r){var e=r(5),i="__core-js_shared__",o=e[i]||(e[i]={});t.exports=function(t){return o[t]||(o[t]={})}},function(t,n){var r=Math.ceil,e=Math.floor;t.exports=function(t){return isNaN(t=+t)?0:(t>0?e:r)(t)}},function(t,n,r){var e=r(21);t.exports=function(t,n){if(!e(t))return t;var r,i;if(n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;if("function"==typeof(r=t.valueOf)&&!e(i=r.call(t)))return i;if(!n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;throw TypeError("Can't convert object to primitive value")}},function(t,n,r){var e=r(5),i=r(25),o=r(36),u=r(44),c=r(14).f;t.exports=function(t){var n=i.Symbol||(i.Symbol=o?{}:e.Symbol||{});"_"==t.charAt(0)||t in n||c(n,t,{value:u.f(t)})}},function(t,n,r){n.f=r(15)},function(t,n){var r={}.toString;t.exports=function(t){return r.call(t).slice(8,-1)}},function(t,n){t.exports=function(t){if(void 0==t)throw TypeError("Can't call method on  "+t);return t}},function(t,n,r){var e=r(4);t.exports=function(t,n){return!!t&&e(function(){n?t.call(null,function(){},1):t.call(null)})}},function(t,n,r){var e=r(53),i=r(115),o=r(17),u=r(16),c=r(203);t.exports=function(t,n){var r=1==t,f=2==t,a=3==t,s=4==t,l=6==t,h=5==t||l,v=n||c;return function(n,c,p){for(var d,y,g=o(n),b=i(g),m=e(c,p,3),x=u(b.length),w=0,S=r?v(n,x):f?v(n,0):void 0;x>w;w++)if((h||w in b)&&(d=b[w],y=m(d,w,g),t))if(r)S[w]=y;else if(y)switch(t){case 3:return!0;case 5:return d;case 6:return w;case 2:S.push(d)}else if(s)return!1;return l?-1:a||s?s:S}}},function(t,n,r){var e=r(1),i=r(52),o=r(4);t.exports=function(t,n){var r=(i.Object||{})[t]||Object[t],u={};u[t]=n(r),e(e.S+e.F*o(function(){r(1)}),"Object",u)}},function(t,n,r){var e=r(6);t.exports=function(t,n){if(!e(t))return t;var r,i;if(n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;if("function"==typeof(r=t.valueOf)&&!e(i=r.call(t)))return i;if(!n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;throw TypeError("Can't convert object to primitive value")}},function(t,n,r){var e=r(5),i=r(25),o=r(91),u=r(13),c="prototype",f=function(t,n,r){var a,s,l,h=t&f.F,v=t&f.G,p=t&f.S,d=t&f.P,y=t&f.B,g=t&f.W,b=v?i:i[n]||(i[n]={}),m=b[c],x=v?e:p?e[n]:(e[n]||{})[c];v&&(r=n);for(a in r)(s=!h&&x&&void 0!==x[a])&&a in b||(l=s?x[a]:r[a],b[a]=v&&"function"!=typeof x[a]?r[a]:y&&s?o(l,e):g&&x[a]==l?function(t){var n=function(n,r,e){if(this instanceof t){switch(arguments.length){case 0:return new t;case 1:return new t(n);case 2:return new t(n,r)}return new t(n,r,e)}return t.apply(this,arguments)};return n[c]=t[c],n}(l):d&&"function"==typeof l?o(Function.call,l):l,d&&((b.virtual||(b.virtual={}))[a]=l,t&f.R&&m&&!m[a]&&u(m,a,l)))};f.F=1,f.G=2,f.S=4,f.P=8,f.B=16,f.W=32,f.U=64,f.R=128,t.exports=f},function(t,n){var r=t.exports={version:"2.4.0"};"number"==typeof __e&&(__e=r)},function(t,n,r){var e=r(26);t.exports=function(t,n,r){if(e(t),void 0===n)return t;switch(r){case 1:return function(r){return t.call(n,r)};case 2:return function(r,e){return t.call(n,r,e)};case 3:return function(r,e,i){return t.call(n,r,e,i)}}return function(){return t.apply(n,arguments)}}},function(t,n,r){var e=r(183),i=r(1),o=r(126)("metadata"),u=o.store||(o.store=new(r(186))),c=function(t,n,r){var i=u.get(t);if(!i){if(!r)return;u.set(t,i=new e)}var o=i.get(n);if(!o){if(!r)return;i.set(n,o=new e)}return o},f=function(t,n,r){var e=c(n,r,!1);return void 0!==e&&e.has(t)},a=function(t,n,r){var e=c(n,r,!1);return void 0===e?void 0:e.get(t)},s=function(t,n,r,e){c(r,e,!0).set(t,n)},l=function(t,n){var r=c(t,n,!1),e=[];return r&&r.forEach(function(t,n){e.push(n)}),e},h=function(t){return void 0===t||"symbol"==typeof t?t:String(t)},v=function(t){i(i.S,"Reflect",t)};t.exports={store:u,map:c,has:f,get:a,set:s,keys:l,key:h,exp:v}},function(t,n,r){"use strict";if(r(10)){var e=r(69),i=r(3),o=r(4),u=r(1),c=r(127),f=r(152),a=r(53),s=r(68),l=r(66),h=r(27),v=r(73),p=r(67),d=r(16),y=r(75),g=r(50),b=r(24),m=r(180),x=r(114),w=r(6),S=r(17),_=r(137),O=r(70),E=r(32),P=r(71).f,j=r(154),F=r(76),M=r(7),A=r(48),N=r(117),T=r(146),I=r(155),k=r(80),L=r(123),R=r(74),C=r(130),D=r(160),U=r(11),W=r(31),G=U.f,B=W.f,V=i.RangeError,z=i.TypeError,q=i.Uint8Array,K="ArrayBuffer",J="Shared"+K,Y="BYTES_PER_ELEMENT",H="prototype",$=Array[H],X=f.ArrayBuffer,Q=f.DataView,Z=A(0),tt=A(2),nt=A(3),rt=A(4),et=A(5),it=A(6),ot=N(!0),ut=N(!1),ct=I.values,ft=I.keys,at=I.entries,st=$.lastIndexOf,lt=$.reduce,ht=$.reduceRight,vt=$.join,pt=$.sort,dt=$.slice,yt=$.toString,gt=$.toLocaleString,bt=M("iterator"),mt=M("toStringTag"),xt=F("typed_constructor"),wt=F("def_constructor"),St=c.CONSTR,_t=c.TYPED,Ot=c.VIEW,Et="Wrong length!",Pt=A(1,function(t,n){return Tt(T(t,t[wt]),n)}),jt=o(function(){return 1===new q(new Uint16Array([1]).buffer)[0]}),Ft=!!q&&!!q[H].set&&o(function(){new q(1).set({})}),Mt=function(t,n){if(void 0===t)throw z(Et);var r=+t,e=d(t);if(n&&!m(r,e))throw V(Et);return e},At=function(t,n){var r=p(t);if(r<0||r%n)throw V("Wrong offset!");return r},Nt=function(t){if(w(t)&&_t in t)return t;throw z(t+" is not a typed array!")},Tt=function(t,n){if(!(w(t)&&xt in t))throw z("It is not a typed array constructor!");return new t(n)},It=function(t,n){return kt(T(t,t[wt]),n)},kt=function(t,n){for(var r=0,e=n.length,i=Tt(t,e);e>r;)i[r]=n[r++];return i},Lt=function(t,n,r){G(t,n,{get:function(){return this._d[r]}})},Rt=function(t){var n,r,e,i,o,u,c=S(t),f=arguments.length,s=f>1?arguments[1]:void 0,l=void 0!==s,h=j(c);if(void 0!=h&&!_(h)){for(u=h.call(c),e=[],n=0;!(o=u.next()).done;n++)e.push(o.value);c=e}for(l&&f>2&&(s=a(s,arguments[2],2)),n=0,r=d(c.length),i=Tt(this,r);r>n;n++)i[n]=l?s(c[n],n):c[n];return i},Ct=function(){for(var t=0,n=arguments.length,r=Tt(this,n);n>t;)r[t]=arguments[t++];return r},Dt=!!q&&o(function(){gt.call(new q(1))}),Ut=function(){return gt.apply(Dt?dt.call(Nt(this)):Nt(this),arguments)},Wt={copyWithin:function(t,n){return D.call(Nt(this),t,n,arguments.length>2?arguments[2]:void 0)},every:function(t){return rt(Nt(this),t,arguments.length>1?arguments[1]:void 0)},fill:function(t){return C.apply(Nt(this),arguments)},filter:function(t){return It(this,tt(Nt(this),t,arguments.length>1?arguments[1]:void 0))},find:function(t){return et(Nt(this),t,arguments.length>1?arguments[1]:void 0)},findIndex:function(t){return it(Nt(this),t,arguments.length>1?arguments[1]:void 0)},forEach:function(t){Z(Nt(this),t,arguments.length>1?arguments[1]:void 0)},indexOf:function(t){return ut(Nt(this),t,arguments.length>1?arguments[1]:void 0)},includes:function(t){return ot(Nt(this),t,arguments.length>1?arguments[1]:void 0)},join:function(t){return vt.apply(Nt(this),arguments)},lastIndexOf:function(t){return st.apply(Nt(this),arguments)},map:function(t){return Pt(Nt(this),t,arguments.length>1?arguments[1]:void 0)},reduce:function(t){return lt.apply(Nt(this),arguments)},reduceRight:function(t){return ht.apply(Nt(this),arguments)},reverse:function(){for(var t,n=this,r=Nt(n).length,e=Math.floor(r/2),i=0;i<e;)t=n[i],n[i++]=n[--r],n[r]=t;return n},some:function(t){return nt(Nt(this),t,arguments.length>1?arguments[1]:void 0)},sort:function(t){return pt.call(Nt(this),t)},subarray:function(t,n){var r=Nt(this),e=r.length,i=y(t,e);return new(T(r,r[wt]))(r.buffer,r.byteOffset+i*r.BYTES_PER_ELEMENT,d((void 0===n?e:y(n,e))-i))}},Gt=function(t,n){return It(this,dt.call(Nt(this),t,n))},Bt=function(t){Nt(this);var n=At(arguments[1],1),r=this.length,e=S(t),i=d(e.length),o=0;if(i+n>r)throw V(Et);for(;o<i;)this[n+o]=e[o++]},Vt={entries:function(){return at.call(Nt(this))},keys:function(){return ft.call(Nt(this))},values:function(){return ct.call(Nt(this))}},zt=function(t,n){return w(t)&&t[_t]&&"symbol"!=typeof n&&n in t&&String(+n)==String(n)},qt=function(t,n){return zt(t,n=g(n,!0))?l(2,t[n]):B(t,n)},Kt=function(t,n,r){return!(zt(t,n=g(n,!0))&&w(r)&&b(r,"value"))||b(r,"get")||b(r,"set")||r.configurable||b(r,"writable")&&!r.writable||b(r,"enumerable")&&!r.enumerable?G(t,n,r):(t[n]=r.value,t)};St||(W.f=qt,U.f=Kt),u(u.S+u.F*!St,"Object",{getOwnPropertyDescriptor:qt,defineProperty:Kt}),o(function(){yt.call({})})&&(yt=gt=function(){return vt.call(this)});var Jt=v({},Wt);v(Jt,Vt),h(Jt,bt,Vt.values),v(Jt,{slice:Gt,set:Bt,constructor:function(){},toString:yt,toLocaleString:Ut}),Lt(Jt,"buffer","b"),Lt(Jt,"byteOffset","o"),Lt(Jt,"byteLength","l"),Lt(Jt,"length","e"),G(Jt,mt,{get:function(){return this[_t]}}),t.exports=function(t,n,r,f){f=!!f;var a=t+(f?"Clamped":"")+"Array",l="Uint8Array"!=a,v="get"+t,p="set"+t,y=i[a],g=y||{},b=y&&E(y),m=!y||!c.ABV,S={},_=y&&y[H],j=function(t,r){var e=t._d;return e.v[v](r*n+e.o,jt)},F=function(t,r,e){var i=t._d;f&&(e=(e=Math.round(e))<0?0:e>255?255:255&e),i.v[p](r*n+i.o,e,jt)},M=function(t,n){G(t,n,{get:function(){return j(this,n)},set:function(t){return F(this,n,t)},enumerable:!0})};m?(y=r(function(t,r,e,i){s(t,y,a,"_d");var o,u,c,f,l=0,v=0;if(w(r)){if(!(r instanceof X||(f=x(r))==K||f==J))return _t in r?kt(y,r):Rt.call(y,r);o=r,v=At(e,n);var p=r.byteLength;if(void 0===i){if(p%n)throw V(Et);if((u=p-v)<0)throw V(Et)}else if((u=d(i)*n)+v>p)throw V(Et);c=u/n}else c=Mt(r,!0),u=c*n,o=new X(u);for(h(t,"_d",{b:o,o:v,l:u,e:c,v:new Q(o)});l<c;)M(t,l++)}),_=y[H]=O(Jt),h(_,"constructor",y)):L(function(t){new y(null),new y(t)},!0)||(y=r(function(t,r,e,i){s(t,y,a);var o;return w(r)?r instanceof X||(o=x(r))==K||o==J?void 0!==i?new g(r,At(e,n),i):void 0!==e?new g(r,At(e,n)):new g(r):_t in r?kt(y,r):Rt.call(y,r):new g(Mt(r,l))}),Z(b!==Function.prototype?P(g).concat(P(b)):P(g),function(t){t in y||h(y,t,g[t])}),y[H]=_,e||(_.constructor=y));var A=_[bt],N=!!A&&("values"==A.name||void 0==A.name),T=Vt.values;h(y,xt,!0),h(_,_t,a),h(_,Ot,!0),h(_,wt,y),(f?new y(1)[mt]==a:mt in _)||G(_,mt,{get:function(){return a}}),S[a]=y,u(u.G+u.W+u.F*(y!=g),S),u(u.S,a,{BYTES_PER_ELEMENT:n,from:Rt,of:Ct}),Y in _||h(_,Y,n),u(u.P,a,Wt),R(a),u(u.P+u.F*Ft,a,{set:Bt}),u(u.P+u.F*!N,a,Vt),u(u.P+u.F*(_.toString!=yt),a,{toString:yt}),u(u.P+u.F*o(function(){new y(1).slice()}),a,{slice:Gt}),u(u.P+u.F*(o(function(){return[1,2].toLocaleString()!=new y([1,2]).toLocaleString()})||!o(function(){_.toLocaleString.call([1,2])})),a,{toLocaleString:Ut}),k[a]=N?A:T,e||N||h(_,bt,T)}}else t.exports=function(){}},function(t,n){var r={}.toString;t.exports=function(t){return r.call(t).slice(8,-1)}},function(t,n,r){var e=r(21),i=r(5).document,o=e(i)&&e(i.createElement);t.exports=function(t){return o?i.createElement(t):{}}},function(t,n,r){t.exports=!r(12)&&!r(18)(function(){return 7!=Object.defineProperty(r(57)("div"),"a",{get:function(){return 7}}).a})},function(t,n,r){"use strict";var e=r(36),i=r(51),o=r(64),u=r(13),c=r(8),f=r(35),a=r(96),s=r(38),l=r(103),h=r(15)("iterator"),v=!([].keys&&"next"in[].keys()),p="keys",d="values",y=function(){return this};t.exports=function(t,n,r,g,b,m,x){a(r,n,g);var w,S,_,O=function(t){if(!v&&t in F)return F[t];switch(t){case p:case d:return function(){return new r(this,t)}}return function(){return new r(this,t)}},E=n+" Iterator",P=b==d,j=!1,F=t.prototype,M=F[h]||F["@@iterator"]||b&&F[b],A=M||O(b),N=b?P?O("entries"):A:void 0,T="Array"==n?F.entries||M:M;if(T&&(_=l(T.call(new t)))!==Object.prototype&&(s(_,E,!0),e||c(_,h)||u(_,h,y)),P&&M&&M.name!==d&&(j=!0,A=function(){return M.call(this)}),e&&!x||!v&&!j&&F[h]||u(F,h,A),f[n]=A,f[E]=y,b)if(w={values:P?A:O(d),keys:m?A:O(p),entries:N},x)for(S in w)S in F||o(F,S,w[S]);else i(i.P+i.F*(v||j),n,w);return w}},function(t,n,r){var e=r(20),i=r(100),o=r(34),u=r(39)("IE_PROTO"),c=function(){},f="prototype",a=function(){var t,n=r(57)("iframe"),e=o.length;for(n.style.display="none",r(93).appendChild(n),n.src="javascript:",t=n.contentWindow.document,t.open(),t.write("<script>document.F=Object<\/script>"),t.close(),a=t.F;e--;)delete a[f][o[e]];return a()};t.exports=Object.create||function(t,n){var r;return null!==t?(c[f]=e(t),r=new c,c[f]=null,r[u]=t):r=a(),void 0===n?r:i(r,n)}},function(t,n,r){var e=r(63),i=r(34).concat("length","prototype");n.f=Object.getOwnPropertyNames||function(t){return e(t,i)}},function(t,n){n.f=Object.getOwnPropertySymbols},function(t,n,r){var e=r(8),i=r(9),o=r(90)(!1),u=r(39)("IE_PROTO");t.exports=function(t,n){var r,c=i(t),f=0,a=[];for(r in c)r!=u&&e(c,r)&&a.push(r);for(;n.length>f;)e(c,r=n[f++])&&(~o(a,r)||a.push(r));return a}},function(t,n,r){t.exports=r(13)},function(t,n,r){var e=r(76)("meta"),i=r(6),o=r(24),u=r(11).f,c=0,f=Object.isExtensible||function(){return!0},a=!r(4)(function(){return f(Object.preventExtensions({}))}),s=function(t){u(t,e,{value:{i:"O"+ ++c,w:{}}})},l=function(t,n){if(!i(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!o(t,e)){if(!f(t))return"F";if(!n)return"E";s(t)}return t[e].i},h=function(t,n){if(!o(t,e)){if(!f(t))return!0;if(!n)return!1;s(t)}return t[e].w},v=function(t){return a&&p.NEED&&f(t)&&!o(t,e)&&s(t),t},p=t.exports={KEY:e,NEED:!1,fastKey:l,getWeak:h,onFreeze:v}},function(t,n){t.exports=function(t,n){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:n}}},function(t,n){var r=Math.ceil,e=Math.floor;t.exports=function(t){return isNaN(t=+t)?0:(t>0?e:r)(t)}},function(t,n){t.exports=function(t,n,r,e){if(!(t instanceof n)||void 0!==e&&e in t)throw TypeError(r+": incorrect invocation!");return t}},function(t,n){t.exports=!1},function(t,n,r){var e=r(2),i=r(173),o=r(133),u=r(145)("IE_PROTO"),c=function(){},f="prototype",a=function(){var t,n=r(132)("iframe"),e=o.length;for(n.style.display="none",r(135).appendChild(n),n.src="javascript:",t=n.contentWindow.document,t.open(),t.write("<script>document.F=Object<\/script>"),t.close(),a=t.F;e--;)delete a[f][o[e]];return a()};t.exports=Object.create||function(t,n){var r;return null!==t?(c[f]=e(t),r=new c,c[f]=null,r[u]=t):r=a(),void 0===n?r:i(r,n)}},function(t,n,r){var e=r(175),i=r(133).concat("length","prototype");n.f=Object.getOwnPropertyNames||function(t){return e(t,i)}},function(t,n,r){var e=r(175),i=r(133);t.exports=Object.keys||function(t){return e(t,i)}},function(t,n,r){var e=r(28);t.exports=function(t,n,r){for(var i in n)e(t,i,n[i],r);return t}},function(t,n,r){"use strict";var e=r(3),i=r(11),o=r(10),u=r(7)("species");t.exports=function(t){var n=e[t];o&&n&&!n[u]&&i.f(n,u,{configurable:!0,get:function(){return this}})}},function(t,n,r){var e=r(67),i=Math.max,o=Math.min;t.exports=function(t,n){return t=e(t),t<0?i(t+n,0):o(t,n)}},function(t,n){var r=0,e=Math.random();t.exports=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++r+e).toString(36))}},function(t,n,r){var e=r(33);t.exports=function(t){return Object(e(t))}},function(t,n,r){var e=r(7)("unscopables"),i=Array.prototype;void 0==i[e]&&r(27)(i,e,{}),t.exports=function(t){i[e][t]=!0}},function(t,n,r){var e=r(53),i=r(169),o=r(137),u=r(2),c=r(16),f=r(154),a={},s={},n=t.exports=function(t,n,r,l,h){var v,p,d,y,g=h?function(){return t}:f(t),b=e(r,l,n?2:1),m=0;if("function"!=typeof g)throw TypeError(t+" is not iterable!");if(o(g)){for(v=c(t.length);v>m;m++)if((y=n?b(u(p=t[m])[0],p[1]):b(t[m]))===a||y===s)return y}else for(d=g.call(t);!(p=d.next()).done;)if((y=i(d,b,p.value,n))===a||y===s)return y};n.BREAK=a,n.RETURN=s},function(t,n){t.exports={}},function(t,n,r){var e=r(11).f,i=r(24),o=r(7)("toStringTag");t.exports=function(t,n,r){t&&!i(t=r?t:t.prototype,o)&&e(t,o,{configurable:!0,value:n})}},function(t,n,r){var e=r(1),i=r(46),o=r(4),u=r(150),c="["+u+"]",f="​",a=RegExp("^"+c+c+"*"),s=RegExp(c+c+"*$"),l=function(t,n,r){var i={},c=o(function(){return!!u[t]()||f[t]()!=f}),a=i[t]=c?n(h):u[t];r&&(i[r]=a),e(e.P+e.F*c,"String",i)},h=l.trim=function(t,n){return t=String(i(t)),1&n&&(t=t.replace(a,"")),2&n&&(t=t.replace(s,"")),t};t.exports=l},function(t,n,r){t.exports={default:r(86),__esModule:!0}},function(t,n,r){t.exports={default:r(87),__esModule:!0}},function(t,n,r){"use strict";function e(t){return t&&t.__esModule?t:{default:t}}n.__esModule=!0;var i=r(84),o=e(i),u=r(83),c=e(u),f="function"==typeof c.default&&"symbol"==typeof o.default?function(t){return typeof t}:function(t){return t&&"function"==typeof c.default&&t.constructor===c.default&&t!==c.default.prototype?"symbol":typeof t};n.default="function"==typeof c.default&&"symbol"===f(o.default)?function(t){return void 0===t?"undefined":f(t)}:function(t){return t&&"function"==typeof c.default&&t.constructor===c.default&&t!==c.default.prototype?"symbol":void 0===t?"undefined":f(t)}},function(t,n,r){r(110),r(108),r(111),r(112),t.exports=r(25).Symbol},function(t,n,r){r(109),r(113),t.exports=r(44).f("iterator")},function(t,n){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,n){t.exports=function(){}},function(t,n,r){var e=r(9),i=r(106),o=r(105);t.exports=function(t){return function(n,r,u){var c,f=e(n),a=i(f.length),s=o(u,a);if(t&&r!=r){for(;a>s;)if((c=f[s++])!=c)return!0}else for(;a>s;s++)if((t||s in f)&&f[s]===r)return t||s||0;return!t&&-1}}},function(t,n,r){var e=r(88);t.exports=function(t,n,r){if(e(t),void 0===n)return t;switch(r){case 1:return function(r){return t.call(n,r)};case 2:return function(r,e){return t.call(n,r,e)};case 3:return function(r,e,i){return t.call(n,r,e,i)}}return function(){return t.apply(n,arguments)}}},function(t,n,r){var e=r(19),i=r(62),o=r(37);t.exports=function(t){var n=e(t),r=i.f;if(r)for(var u,c=r(t),f=o.f,a=0;c.length>a;)f.call(t,u=c[a++])&&n.push(u);return n}},function(t,n,r){t.exports=r(5).document&&document.documentElement},function(t,n,r){var e=r(56);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==e(t)?t.split(""):Object(t)}},function(t,n,r){var e=r(56);t.exports=Array.isArray||function(t){return"Array"==e(t)}},function(t,n,r){"use strict";var e=r(60),i=r(22),o=r(38),u={};r(13)(u,r(15)("iterator"),function(){return this}),t.exports=function(t,n,r){t.prototype=e(u,{next:i(1,r)}),o(t,n+" Iterator")}},function(t,n){t.exports=function(t,n){return{value:n,done:!!t}}},function(t,n,r){var e=r(19),i=r(9);t.exports=function(t,n){for(var r,o=i(t),u=e(o),c=u.length,f=0;c>f;)if(o[r=u[f++]]===n)return r}},function(t,n,r){var e=r(23)("meta"),i=r(21),o=r(8),u=r(14).f,c=0,f=Object.isExtensible||function(){return!0},a=!r(18)(function(){return f(Object.preventExtensions({}))}),s=function(t){u(t,e,{value:{i:"O"+ ++c,w:{}}})},l=function(t,n){if(!i(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!o(t,e)){if(!f(t))return"F";if(!n)return"E";s(t)}return t[e].i},h=function(t,n){if(!o(t,e)){if(!f(t))return!0;if(!n)return!1;s(t)}return t[e].w},v=function(t){return a&&p.NEED&&f(t)&&!o(t,e)&&s(t),t},p=t.exports={KEY:e,NEED:!1,fastKey:l,getWeak:h,onFreeze:v}},function(t,n,r){var e=r(14),i=r(20),o=r(19);t.exports=r(12)?Object.defineProperties:function(t,n){i(t);for(var r,u=o(n),c=u.length,f=0;c>f;)e.f(t,r=u[f++],n[r]);return t}},function(t,n,r){var e=r(37),i=r(22),o=r(9),u=r(42),c=r(8),f=r(58),a=Object.getOwnPropertyDescriptor;n.f=r(12)?a:function(t,n){if(t=o(t),n=u(n,!0),f)try{return a(t,n)}catch(t){}if(c(t,n))return i(!e.f.call(t,n),t[n])}},function(t,n,r){var e=r(9),i=r(61).f,o={}.toString,u="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],c=function(t){try{return i(t)}catch(t){return u.slice()}};t.exports.f=function(t){return u&&"[object Window]"==o.call(t)?c(t):i(e(t))}},function(t,n,r){var e=r(8),i=r(77),o=r(39)("IE_PROTO"),u=Object.prototype;t.exports=Object.getPrototypeOf||function(t){return t=i(t),e(t,o)?t[o]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?u:null}},function(t,n,r){var e=r(41),i=r(33);t.exports=function(t){return function(n,r){var o,u,c=String(i(n)),f=e(r),a=c.length;return f<0||f>=a?t?"":void 0:(o=c.charCodeAt(f),o<55296||o>56319||f+1===a||(u=c.charCodeAt(f+1))<56320||u>57343?t?c.charAt(f):o:t?c.slice(f,f+2):u-56320+(o-55296<<10)+65536)}}},function(t,n,r){var e=r(41),i=Math.max,o=Math.min;t.exports=function(t,n){return t=e(t),t<0?i(t+n,0):o(t,n)}},function(t,n,r){var e=r(41),i=Math.min;t.exports=function(t){return t>0?i(e(t),9007199254740991):0}},function(t,n,r){"use strict";var e=r(89),i=r(97),o=r(35),u=r(9);t.exports=r(59)(Array,"Array",function(t,n){this._t=u(t),this._i=0,this._k=n},function(){var t=this._t,n=this._k,r=this._i++;return!t||r>=t.length?(this._t=void 0,i(1)):"keys"==n?i(0,r):"values"==n?i(0,t[r]):i(0,[r,t[r]])},"values"),o.Arguments=o.Array,e("keys"),e("values"),e("entries")},function(t,n){},function(t,n,r){"use strict";var e=r(104)(!0);r(59)(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,n=this._t,r=this._i;return r>=n.length?{value:void 0,done:!0}:(t=e(n,r),this._i+=t.length,{value:t,done:!1})})},function(t,n,r){"use strict";var e=r(5),i=r(8),o=r(12),u=r(51),c=r(64),f=r(99).KEY,a=r(18),s=r(40),l=r(38),h=r(23),v=r(15),p=r(44),d=r(43),y=r(98),g=r(92),b=r(95),m=r(20),x=r(9),w=r(42),S=r(22),_=r(60),O=r(102),E=r(101),P=r(14),j=r(19),F=E.f,M=P.f,A=O.f,N=e.Symbol,T=e.JSON,I=T&&T.stringify,k="prototype",L=v("_hidden"),R=v("toPrimitive"),C={}.propertyIsEnumerable,D=s("symbol-registry"),U=s("symbols"),W=s("op-symbols"),G=Object[k],B="function"==typeof N,V=e.QObject,z=!V||!V[k]||!V[k].findChild,q=o&&a(function(){return 7!=_(M({},"a",{get:function(){return M(this,"a",{value:7}).a}})).a})?function(t,n,r){var e=F(G,n);e&&delete G[n],M(t,n,r),e&&t!==G&&M(G,n,e)}:M,K=function(t){var n=U[t]=_(N[k]);return n._k=t,n},J=B&&"symbol"==typeof N.iterator?function(t){return"symbol"==typeof t}:function(t){return t instanceof N},Y=function(t,n,r){return t===G&&Y(W,n,r),m(t),n=w(n,!0),m(r),i(U,n)?(r.enumerable?(i(t,L)&&t[L][n]&&(t[L][n]=!1),r=_(r,{enumerable:S(0,!1)})):(i(t,L)||M(t,L,S(1,{})),t[L][n]=!0),q(t,n,r)):M(t,n,r)},H=function(t,n){m(t);for(var r,e=g(n=x(n)),i=0,o=e.length;o>i;)Y(t,r=e[i++],n[r]);return t},$=function(t,n){return void 0===n?_(t):H(_(t),n)},X=function(t){var n=C.call(this,t=w(t,!0));return!(this===G&&i(U,t)&&!i(W,t))&&(!(n||!i(this,t)||!i(U,t)||i(this,L)&&this[L][t])||n)},Q=function(t,n){if(t=x(t),n=w(n,!0),t!==G||!i(U,n)||i(W,n)){var r=F(t,n);return!r||!i(U,n)||i(t,L)&&t[L][n]||(r.enumerable=!0),r}},Z=function(t){for(var n,r=A(x(t)),e=[],o=0;r.length>o;)i(U,n=r[o++])||n==L||n==f||e.push(n);return e},tt=function(t){for(var n,r=t===G,e=A(r?W:x(t)),o=[],u=0;e.length>u;)!i(U,n=e[u++])||r&&!i(G,n)||o.push(U[n]);return o};B||(N=function(){if(this instanceof N)throw TypeError("Symbol is not a constructor!");var t=h(arguments.length>0?arguments[0]:void 0),n=function(r){this===G&&n.call(W,r),i(this,L)&&i(this[L],t)&&(this[L][t]=!1),q(this,t,S(1,r))};return o&&z&&q(G,t,{configurable:!0,set:n}),K(t)},c(N[k],"toString",function(){return this._k}),E.f=Q,P.f=Y,r(61).f=O.f=Z,r(37).f=X,r(62).f=tt,o&&!r(36)&&c(G,"propertyIsEnumerable",X,!0),p.f=function(t){return K(v(t))}),u(u.G+u.W+u.F*!B,{Symbol:N});for(var nt="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),rt=0;nt.length>rt;)v(nt[rt++]);for(var nt=j(v.store),rt=0;nt.length>rt;)d(nt[rt++]);u(u.S+u.F*!B,"Symbol",{for:function(t){return i(D,t+="")?D[t]:D[t]=N(t)},keyFor:function(t){if(J(t))return y(D,t);throw TypeError(t+" is not a symbol!")},useSetter:function(){z=!0},useSimple:function(){z=!1}}),u(u.S+u.F*!B,"Object",{create:$,defineProperty:Y,defineProperties:H,getOwnPropertyDescriptor:Q,getOwnPropertyNames:Z,getOwnPropertySymbols:tt}),T&&u(u.S+u.F*(!B||a(function(){var t=N();return"[null]"!=I([t])||"{}"!=I({a:t})||"{}"!=I(Object(t))})),"JSON",{stringify:function(t){if(void 0!==t&&!J(t)){for(var n,r,e=[t],i=1;arguments.length>i;)e.push(arguments[i++]);return n=e[1],"function"==typeof n&&(r=n),!r&&b(n)||(n=function(t,n){if(r&&(n=r.call(this,t,n)),!J(n))return n}),e[1]=n,I.apply(T,e)}}}),N[k][R]||r(13)(N[k],R,N[k].valueOf),l(N,"Symbol"),l(Math,"Math",!0),l(e.JSON,"JSON",!0)},function(t,n,r){r(43)("asyncIterator")},function(t,n,r){r(43)("observable")},function(t,n,r){r(107);for(var e=r(5),i=r(13),o=r(35),u=r(15)("toStringTag"),c=["NodeList","DOMTokenList","MediaList","StyleSheetList","CSSRuleList"],f=0;f<5;f++){var a=c[f],s=e[a],l=s&&s.prototype;l&&!l[u]&&i(l,u,a),o[a]=o.Array}},function(t,n,r){var e=r(45),i=r(7)("toStringTag"),o="Arguments"==e(function(){return arguments}()),u=function(t,n){try{return t[n]}catch(t){}};t.exports=function(t){var n,r,c;return void 0===t?"Undefined":null===t?"Null":"string"==typeof(r=u(n=Object(t),i))?r:o?e(n):"Object"==(c=e(n))&&"function"==typeof n.callee?"Arguments":c}},function(t,n,r){var e=r(45);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==e(t)?t.split(""):Object(t)}},function(t,n){n.f={}.propertyIsEnumerable},function(t,n,r){var e=r(30),i=r(16),o=r(75);t.exports=function(t){return function(n,r,u){var c,f=e(n),a=i(f.length),s=o(u,a);if(t&&r!=r){for(;a>s;)if((c=f[s++])!=c)return!0}else for(;a>s;s++)if((t||s in f)&&f[s]===r)return t||s||0;return!t&&-1}}},function(t,n,r){"use strict";var e=r(3),i=r(1),o=r(28),u=r(73),c=r(65),f=r(79),a=r(68),s=r(6),l=r(4),h=r(123),v=r(81),p=r(136);t.exports=function(t,n,r,d,y,g){var b=e[t],m=b,x=y?"set":"add",w=m&&m.prototype,S={},_=function(t){var n=w[t];o(w,t,"delete"==t?function(t){return!(g&&!s(t))&&n.call(this,0===t?0:t)}:"has"==t?function(t){return!(g&&!s(t))&&n.call(this,0===t?0:t)}:"get"==t?function(t){return g&&!s(t)?void 0:n.call(this,0===t?0:t)}:"add"==t?function(t){return n.call(this,0===t?0:t),this}:function(t,r){return n.call(this,0===t?0:t,r),this})};if("function"==typeof m&&(g||w.forEach&&!l(function(){(new m).entries().next()}))){var O=new m,E=O[x](g?{}:-0,1)!=O,P=l(function(){O.has(1)}),j=h(function(t){new m(t)}),F=!g&&l(function(){for(var t=new m,n=5;n--;)t[x](n,n);return!t.has(-0)});j||(m=n(function(n,r){a(n,m,t);var e=p(new b,n,m);return void 0!=r&&f(r,y,e[x],e),e}),m.prototype=w,w.constructor=m),(P||F)&&(_("delete"),_("has"),y&&_("get")),(F||E)&&_(x),g&&w.clear&&delete w.clear}else m=d.getConstructor(n,t,y,x),u(m.prototype,r),c.NEED=!0;return v(m,t),S[t]=m,i(i.G+i.W+i.F*(m!=b),S),g||d.setStrong(m,t,y),m}},function(t,n,r){"use strict";var e=r(27),i=r(28),o=r(4),u=r(46),c=r(7);t.exports=function(t,n,r){var f=c(t),a=r(u,f,""[t]),s=a[0],l=a[1];o(function(){var n={};return n[f]=function(){return 7},7!=""[t](n)})&&(i(String.prototype,t,s),e(RegExp.prototype,f,2==n?function(t,n){return l.call(t,this,n)}:function(t){return l.call(t,this)}))}
},function(t,n,r){"use strict";var e=r(2);t.exports=function(){var t=e(this),n="";return t.global&&(n+="g"),t.ignoreCase&&(n+="i"),t.multiline&&(n+="m"),t.unicode&&(n+="u"),t.sticky&&(n+="y"),n}},function(t,n){t.exports=function(t,n,r){var e=void 0===r;switch(n.length){case 0:return e?t():t.call(r);case 1:return e?t(n[0]):t.call(r,n[0]);case 2:return e?t(n[0],n[1]):t.call(r,n[0],n[1]);case 3:return e?t(n[0],n[1],n[2]):t.call(r,n[0],n[1],n[2]);case 4:return e?t(n[0],n[1],n[2],n[3]):t.call(r,n[0],n[1],n[2],n[3])}return t.apply(r,n)}},function(t,n,r){var e=r(6),i=r(45),o=r(7)("match");t.exports=function(t){var n;return e(t)&&(void 0!==(n=t[o])?!!n:"RegExp"==i(t))}},function(t,n,r){var e=r(7)("iterator"),i=!1;try{var o=[7][e]();o.return=function(){i=!0},Array.from(o,function(){throw 2})}catch(t){}t.exports=function(t,n){if(!n&&!i)return!1;var r=!1;try{var o=[7],u=o[e]();u.next=function(){return{done:r=!0}},o[e]=function(){return u},t(o)}catch(t){}return r}},function(t,n,r){t.exports=r(69)||!r(4)(function(){var t=Math.random();__defineSetter__.call(null,t,function(){}),delete r(3)[t]})},function(t,n){n.f=Object.getOwnPropertySymbols},function(t,n,r){var e=r(3),i="__core-js_shared__",o=e[i]||(e[i]={});t.exports=function(t){return o[t]||(o[t]={})}},function(t,n,r){for(var e,i=r(3),o=r(27),u=r(76),c=u("typed_array"),f=u("view"),a=!(!i.ArrayBuffer||!i.DataView),s=a,l=0,h="Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array".split(",");l<9;)(e=i[h[l++]])?(o(e.prototype,c,!0),o(e.prototype,f,!0)):s=!1;t.exports={ABV:a,CONSTR:s,TYPED:c,VIEW:f}},function(t,n){"use strict";var r={versions:function(){var t=window.navigator.userAgent;return{trident:t.indexOf("Trident")>-1,presto:t.indexOf("Presto")>-1,webKit:t.indexOf("AppleWebKit")>-1,gecko:t.indexOf("Gecko")>-1&&-1==t.indexOf("KHTML"),mobile:!!t.match(/AppleWebKit.*Mobile.*/),ios:!!t.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),android:t.indexOf("Android")>-1||t.indexOf("Linux")>-1,iPhone:t.indexOf("iPhone")>-1||t.indexOf("Mac")>-1,iPad:t.indexOf("iPad")>-1,webApp:-1==t.indexOf("Safari"),weixin:-1==t.indexOf("MicroMessenger")}}()};t.exports=r},function(t,n,r){"use strict";var e=r(85),i=function(t){return t&&t.__esModule?t:{default:t}}(e),o=function(){function t(t,n,e){return n||e?String.fromCharCode(n||e):r[t]||t}function n(t){return e[t]}var r={"&quot;":'"',"&lt;":"<","&gt;":">","&amp;":"&","&nbsp;":" "},e={};for(var u in r)e[r[u]]=u;return r["&apos;"]="'",e["'"]="&#39;",{encode:function(t){return t?(""+t).replace(/['<> "&]/g,n).replace(/\r?\n/g,"<br/>").replace(/\s/g,"&nbsp;"):""},decode:function(n){return n?(""+n).replace(/<br\s*\/?>/gi,"\n").replace(/&quot;|&lt;|&gt;|&amp;|&nbsp;|&apos;|&#(\d+);|&#(\d+)/g,t).replace(/\u00a0/g," "):""},encodeBase16:function(t){if(!t)return t;t+="";for(var n=[],r=0,e=t.length;e>r;r++)n.push(t.charCodeAt(r).toString(16).toUpperCase());return n.join("")},encodeBase16forJSON:function(t){if(!t)return t;t=t.replace(/[\u4E00-\u9FBF]/gi,function(t){return escape(t).replace("%u","\\u")});for(var n=[],r=0,e=t.length;e>r;r++)n.push(t.charCodeAt(r).toString(16).toUpperCase());return n.join("")},decodeBase16:function(t){if(!t)return t;t+="";for(var n=[],r=0,e=t.length;e>r;r+=2)n.push(String.fromCharCode("0x"+t.slice(r,r+2)));return n.join("")},encodeObject:function(t){if(t instanceof Array)for(var n=0,r=t.length;r>n;n++)t[n]=o.encodeObject(t[n]);else if("object"==(void 0===t?"undefined":(0,i.default)(t)))for(var e in t)t[e]=o.encodeObject(t[e]);else if("string"==typeof t)return o.encode(t);return t},loadScript:function(t){var n=document.createElement("script");document.getElementsByTagName("body")[0].appendChild(n),n.setAttribute("src",t)},addLoadEvent:function(t){var n=window.onload;"function"!=typeof window.onload?window.onload=t:window.onload=function(){n(),t()}}}}();t.exports=o},function(t,n,r){"use strict";var e=r(17),i=r(75),o=r(16);t.exports=function(t){for(var n=e(this),r=o(n.length),u=arguments.length,c=i(u>1?arguments[1]:void 0,r),f=u>2?arguments[2]:void 0,a=void 0===f?r:i(f,r);a>c;)n[c++]=t;return n}},function(t,n,r){"use strict";var e=r(11),i=r(66);t.exports=function(t,n,r){n in t?e.f(t,n,i(0,r)):t[n]=r}},function(t,n,r){var e=r(6),i=r(3).document,o=e(i)&&e(i.createElement);t.exports=function(t){return o?i.createElement(t):{}}},function(t,n){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,n,r){var e=r(7)("match");t.exports=function(t){var n=/./;try{"/./"[t](n)}catch(r){try{return n[e]=!1,!"/./"[t](n)}catch(t){}}return!0}},function(t,n,r){t.exports=r(3).document&&document.documentElement},function(t,n,r){var e=r(6),i=r(144).set;t.exports=function(t,n,r){var o,u=n.constructor;return u!==r&&"function"==typeof u&&(o=u.prototype)!==r.prototype&&e(o)&&i&&i(t,o),t}},function(t,n,r){var e=r(80),i=r(7)("iterator"),o=Array.prototype;t.exports=function(t){return void 0!==t&&(e.Array===t||o[i]===t)}},function(t,n,r){var e=r(45);t.exports=Array.isArray||function(t){return"Array"==e(t)}},function(t,n,r){"use strict";var e=r(70),i=r(66),o=r(81),u={};r(27)(u,r(7)("iterator"),function(){return this}),t.exports=function(t,n,r){t.prototype=e(u,{next:i(1,r)}),o(t,n+" Iterator")}},function(t,n,r){"use strict";var e=r(69),i=r(1),o=r(28),u=r(27),c=r(24),f=r(80),a=r(139),s=r(81),l=r(32),h=r(7)("iterator"),v=!([].keys&&"next"in[].keys()),p="keys",d="values",y=function(){return this};t.exports=function(t,n,r,g,b,m,x){a(r,n,g);var w,S,_,O=function(t){if(!v&&t in F)return F[t];switch(t){case p:case d:return function(){return new r(this,t)}}return function(){return new r(this,t)}},E=n+" Iterator",P=b==d,j=!1,F=t.prototype,M=F[h]||F["@@iterator"]||b&&F[b],A=M||O(b),N=b?P?O("entries"):A:void 0,T="Array"==n?F.entries||M:M;if(T&&(_=l(T.call(new t)))!==Object.prototype&&(s(_,E,!0),e||c(_,h)||u(_,h,y)),P&&M&&M.name!==d&&(j=!0,A=function(){return M.call(this)}),e&&!x||!v&&!j&&F[h]||u(F,h,A),f[n]=A,f[E]=y,b)if(w={values:P?A:O(d),keys:m?A:O(p),entries:N},x)for(S in w)S in F||o(F,S,w[S]);else i(i.P+i.F*(v||j),n,w);return w}},function(t,n){var r=Math.expm1;t.exports=!r||r(10)>22025.465794806718||r(10)<22025.465794806718||-2e-17!=r(-2e-17)?function(t){return 0==(t=+t)?t:t>-1e-6&&t<1e-6?t+t*t/2:Math.exp(t)-1}:r},function(t,n){t.exports=Math.sign||function(t){return 0==(t=+t)||t!=t?t:t<0?-1:1}},function(t,n,r){var e=r(3),i=r(151).set,o=e.MutationObserver||e.WebKitMutationObserver,u=e.process,c=e.Promise,f="process"==r(45)(u);t.exports=function(){var t,n,r,a=function(){var e,i;for(f&&(e=u.domain)&&e.exit();t;){i=t.fn,t=t.next;try{i()}catch(e){throw t?r():n=void 0,e}}n=void 0,e&&e.enter()};if(f)r=function(){u.nextTick(a)};else if(o){var s=!0,l=document.createTextNode("");new o(a).observe(l,{characterData:!0}),r=function(){l.data=s=!s}}else if(c&&c.resolve){var h=c.resolve();r=function(){h.then(a)}}else r=function(){i.call(e,a)};return function(e){var i={fn:e,next:void 0};n&&(n.next=i),t||(t=i,r()),n=i}}},function(t,n,r){var e=r(6),i=r(2),o=function(t,n){if(i(t),!e(n)&&null!==n)throw TypeError(n+": can't set as prototype!")};t.exports={set:Object.setPrototypeOf||("__proto__"in{}?function(t,n,e){try{e=r(53)(Function.call,r(31).f(Object.prototype,"__proto__").set,2),e(t,[]),n=!(t instanceof Array)}catch(t){n=!0}return function(t,r){return o(t,r),n?t.__proto__=r:e(t,r),t}}({},!1):void 0),check:o}},function(t,n,r){var e=r(126)("keys"),i=r(76);t.exports=function(t){return e[t]||(e[t]=i(t))}},function(t,n,r){var e=r(2),i=r(26),o=r(7)("species");t.exports=function(t,n){var r,u=e(t).constructor;return void 0===u||void 0==(r=e(u)[o])?n:i(r)}},function(t,n,r){var e=r(67),i=r(46);t.exports=function(t){return function(n,r){var o,u,c=String(i(n)),f=e(r),a=c.length;return f<0||f>=a?t?"":void 0:(o=c.charCodeAt(f),o<55296||o>56319||f+1===a||(u=c.charCodeAt(f+1))<56320||u>57343?t?c.charAt(f):o:t?c.slice(f,f+2):u-56320+(o-55296<<10)+65536)}}},function(t,n,r){var e=r(122),i=r(46);t.exports=function(t,n,r){if(e(n))throw TypeError("String#"+r+" doesn't accept regex!");return String(i(t))}},function(t,n,r){"use strict";var e=r(67),i=r(46);t.exports=function(t){var n=String(i(this)),r="",o=e(t);if(o<0||o==1/0)throw RangeError("Count can't be negative");for(;o>0;(o>>>=1)&&(n+=n))1&o&&(r+=n);return r}},function(t,n){t.exports="\t\n\v\f\r   ᠎             　\u2028\u2029\ufeff"},function(t,n,r){var e,i,o,u=r(53),c=r(121),f=r(135),a=r(132),s=r(3),l=s.process,h=s.setImmediate,v=s.clearImmediate,p=s.MessageChannel,d=0,y={},g="onreadystatechange",b=function(){var t=+this;if(y.hasOwnProperty(t)){var n=y[t];delete y[t],n()}},m=function(t){b.call(t.data)};h&&v||(h=function(t){for(var n=[],r=1;arguments.length>r;)n.push(arguments[r++]);return y[++d]=function(){c("function"==typeof t?t:Function(t),n)},e(d),d},v=function(t){delete y[t]},"process"==r(45)(l)?e=function(t){l.nextTick(u(b,t,1))}:p?(i=new p,o=i.port2,i.port1.onmessage=m,e=u(o.postMessage,o,1)):s.addEventListener&&"function"==typeof postMessage&&!s.importScripts?(e=function(t){s.postMessage(t+"","*")},s.addEventListener("message",m,!1)):e=g in a("script")?function(t){f.appendChild(a("script"))[g]=function(){f.removeChild(this),b.call(t)}}:function(t){setTimeout(u(b,t,1),0)}),t.exports={set:h,clear:v}},function(t,n,r){"use strict";var e=r(3),i=r(10),o=r(69),u=r(127),c=r(27),f=r(73),a=r(4),s=r(68),l=r(67),h=r(16),v=r(71).f,p=r(11).f,d=r(130),y=r(81),g="ArrayBuffer",b="DataView",m="prototype",x="Wrong length!",w="Wrong index!",S=e[g],_=e[b],O=e.Math,E=e.RangeError,P=e.Infinity,j=S,F=O.abs,M=O.pow,A=O.floor,N=O.log,T=O.LN2,I="buffer",k="byteLength",L="byteOffset",R=i?"_b":I,C=i?"_l":k,D=i?"_o":L,U=function(t,n,r){var e,i,o,u=Array(r),c=8*r-n-1,f=(1<<c)-1,a=f>>1,s=23===n?M(2,-24)-M(2,-77):0,l=0,h=t<0||0===t&&1/t<0?1:0;for(t=F(t),t!=t||t===P?(i=t!=t?1:0,e=f):(e=A(N(t)/T),t*(o=M(2,-e))<1&&(e--,o*=2),t+=e+a>=1?s/o:s*M(2,1-a),t*o>=2&&(e++,o/=2),e+a>=f?(i=0,e=f):e+a>=1?(i=(t*o-1)*M(2,n),e+=a):(i=t*M(2,a-1)*M(2,n),e=0));n>=8;u[l++]=255&i,i/=256,n-=8);for(e=e<<n|i,c+=n;c>0;u[l++]=255&e,e/=256,c-=8);return u[--l]|=128*h,u},W=function(t,n,r){var e,i=8*r-n-1,o=(1<<i)-1,u=o>>1,c=i-7,f=r-1,a=t[f--],s=127&a;for(a>>=7;c>0;s=256*s+t[f],f--,c-=8);for(e=s&(1<<-c)-1,s>>=-c,c+=n;c>0;e=256*e+t[f],f--,c-=8);if(0===s)s=1-u;else{if(s===o)return e?NaN:a?-P:P;e+=M(2,n),s-=u}return(a?-1:1)*e*M(2,s-n)},G=function(t){return t[3]<<24|t[2]<<16|t[1]<<8|t[0]},B=function(t){return[255&t]},V=function(t){return[255&t,t>>8&255]},z=function(t){return[255&t,t>>8&255,t>>16&255,t>>24&255]},q=function(t){return U(t,52,8)},K=function(t){return U(t,23,4)},J=function(t,n,r){p(t[m],n,{get:function(){return this[r]}})},Y=function(t,n,r,e){var i=+r,o=l(i);if(i!=o||o<0||o+n>t[C])throw E(w);var u=t[R]._b,c=o+t[D],f=u.slice(c,c+n);return e?f:f.reverse()},H=function(t,n,r,e,i,o){var u=+r,c=l(u);if(u!=c||c<0||c+n>t[C])throw E(w);for(var f=t[R]._b,a=c+t[D],s=e(+i),h=0;h<n;h++)f[a+h]=s[o?h:n-h-1]},$=function(t,n){s(t,S,g);var r=+n,e=h(r);if(r!=e)throw E(x);return e};if(u.ABV){if(!a(function(){new S})||!a(function(){new S(.5)})){S=function(t){return new j($(this,t))};for(var X,Q=S[m]=j[m],Z=v(j),tt=0;Z.length>tt;)(X=Z[tt++])in S||c(S,X,j[X]);o||(Q.constructor=S)}var nt=new _(new S(2)),rt=_[m].setInt8;nt.setInt8(0,2147483648),nt.setInt8(1,2147483649),!nt.getInt8(0)&&nt.getInt8(1)||f(_[m],{setInt8:function(t,n){rt.call(this,t,n<<24>>24)},setUint8:function(t,n){rt.call(this,t,n<<24>>24)}},!0)}else S=function(t){var n=$(this,t);this._b=d.call(Array(n),0),this[C]=n},_=function(t,n,r){s(this,_,b),s(t,S,b);var e=t[C],i=l(n);if(i<0||i>e)throw E("Wrong offset!");if(r=void 0===r?e-i:h(r),i+r>e)throw E(x);this[R]=t,this[D]=i,this[C]=r},i&&(J(S,k,"_l"),J(_,I,"_b"),J(_,k,"_l"),J(_,L,"_o")),f(_[m],{getInt8:function(t){return Y(this,1,t)[0]<<24>>24},getUint8:function(t){return Y(this,1,t)[0]},getInt16:function(t){var n=Y(this,2,t,arguments[1]);return(n[1]<<8|n[0])<<16>>16},getUint16:function(t){var n=Y(this,2,t,arguments[1]);return n[1]<<8|n[0]},getInt32:function(t){return G(Y(this,4,t,arguments[1]))},getUint32:function(t){return G(Y(this,4,t,arguments[1]))>>>0},getFloat32:function(t){return W(Y(this,4,t,arguments[1]),23,4)},getFloat64:function(t){return W(Y(this,8,t,arguments[1]),52,8)},setInt8:function(t,n){H(this,1,t,B,n)},setUint8:function(t,n){H(this,1,t,B,n)},setInt16:function(t,n){H(this,2,t,V,n,arguments[2])},setUint16:function(t,n){H(this,2,t,V,n,arguments[2])},setInt32:function(t,n){H(this,4,t,z,n,arguments[2])},setUint32:function(t,n){H(this,4,t,z,n,arguments[2])},setFloat32:function(t,n){H(this,4,t,K,n,arguments[2])},setFloat64:function(t,n){H(this,8,t,q,n,arguments[2])}});y(S,g),y(_,b),c(_[m],u.VIEW,!0),n[g]=S,n[b]=_},function(t,n,r){var e=r(3),i=r(52),o=r(69),u=r(182),c=r(11).f;t.exports=function(t){var n=i.Symbol||(i.Symbol=o?{}:e.Symbol||{});"_"==t.charAt(0)||t in n||c(n,t,{value:u.f(t)})}},function(t,n,r){var e=r(114),i=r(7)("iterator"),o=r(80);t.exports=r(52).getIteratorMethod=function(t){if(void 0!=t)return t[i]||t["@@iterator"]||o[e(t)]}},function(t,n,r){"use strict";var e=r(78),i=r(170),o=r(80),u=r(30);t.exports=r(140)(Array,"Array",function(t,n){this._t=u(t),this._i=0,this._k=n},function(){var t=this._t,n=this._k,r=this._i++;return!t||r>=t.length?(this._t=void 0,i(1)):"keys"==n?i(0,r):"values"==n?i(0,t[r]):i(0,[r,t[r]])},"values"),o.Arguments=o.Array,e("keys"),e("values"),e("entries")},function(t,n){function r(t,n){t.classList?t.classList.add(n):t.className+=" "+n}t.exports=r},function(t,n){function r(t,n){if(t.classList)t.classList.remove(n);else{var r=new RegExp("(^|\\b)"+n.split(" ").join("|")+"(\\b|$)","gi");t.className=t.className.replace(r," ")}}t.exports=r},function(t,n){function r(){throw new Error("setTimeout has not been defined")}function e(){throw new Error("clearTimeout has not been defined")}function i(t){if(s===setTimeout)return setTimeout(t,0);if((s===r||!s)&&setTimeout)return s=setTimeout,setTimeout(t,0);try{return s(t,0)}catch(n){try{return s.call(null,t,0)}catch(n){return s.call(this,t,0)}}}function o(t){if(l===clearTimeout)return clearTimeout(t);if((l===e||!l)&&clearTimeout)return l=clearTimeout,clearTimeout(t);try{return l(t)}catch(n){try{return l.call(null,t)}catch(n){return l.call(this,t)}}}function u(){d&&v&&(d=!1,v.length?p=v.concat(p):y=-1,p.length&&c())}function c(){if(!d){var t=i(u);d=!0;for(var n=p.length;n;){for(v=p,p=[];++y<n;)v&&v[y].run();y=-1,n=p.length}v=null,d=!1,o(t)}}function f(t,n){this.fun=t,this.array=n}function a(){}var s,l,h=t.exports={};!function(){try{s="function"==typeof setTimeout?setTimeout:r}catch(t){s=r}try{l="function"==typeof clearTimeout?clearTimeout:e}catch(t){l=e}}();var v,p=[],d=!1,y=-1;h.nextTick=function(t){var n=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)n[r-1]=arguments[r];p.push(new f(t,n)),1!==p.length||d||i(c)},f.prototype.run=function(){this.fun.apply(null,this.array)},h.title="browser",h.browser=!0,h.env={},h.argv=[],h.version="",h.versions={},h.on=a,h.addListener=a,h.once=a,h.off=a,h.removeListener=a,h.removeAllListeners=a,h.emit=a,h.prependListener=a,h.prependOnceListener=a,h.listeners=function(t){return[]},h.binding=function(t){throw new Error("process.binding is not supported")},h.cwd=function(){return"/"},h.chdir=function(t){throw new Error("process.chdir is not supported")},h.umask=function(){return 0}},function(t,n,r){var e=r(45);t.exports=function(t,n){if("number"!=typeof t&&"Number"!=e(t))throw TypeError(n);return+t}},function(t,n,r){"use strict";var e=r(17),i=r(75),o=r(16);t.exports=[].copyWithin||function(t,n){var r=e(this),u=o(r.length),c=i(t,u),f=i(n,u),a=arguments.length>2?arguments[2]:void 0,s=Math.min((void 0===a?u:i(a,u))-f,u-c),l=1;for(f<c&&c<f+s&&(l=-1,f+=s-1,c+=s-1);s-- >0;)f in r?r[c]=r[f]:delete r[c],c+=l,f+=l;return r}},function(t,n,r){var e=r(79);t.exports=function(t,n){var r=[];return e(t,!1,r.push,r,n),r}},function(t,n,r){var e=r(26),i=r(17),o=r(115),u=r(16);t.exports=function(t,n,r,c,f){e(n);var a=i(t),s=o(a),l=u(a.length),h=f?l-1:0,v=f?-1:1;if(r<2)for(;;){if(h in s){c=s[h],h+=v;break}if(h+=v,f?h<0:l<=h)throw TypeError("Reduce of empty array with no initial value")}for(;f?h>=0:l>h;h+=v)h in s&&(c=n(c,s[h],h,a));return c}},function(t,n,r){"use strict";var e=r(26),i=r(6),o=r(121),u=[].slice,c={},f=function(t,n,r){if(!(n in c)){for(var e=[],i=0;i<n;i++)e[i]="a["+i+"]";c[n]=Function("F,a","return new F("+e.join(",")+")")}return c[n](t,r)};t.exports=Function.bind||function(t){var n=e(this),r=u.call(arguments,1),c=function(){var e=r.concat(u.call(arguments));return this instanceof c?f(n,e.length,e):o(n,e,t)};return i(n.prototype)&&(c.prototype=n.prototype),c}},function(t,n,r){"use strict";var e=r(11).f,i=r(70),o=r(73),u=r(53),c=r(68),f=r(46),a=r(79),s=r(140),l=r(170),h=r(74),v=r(10),p=r(65).fastKey,d=v?"_s":"size",y=function(t,n){var r,e=p(n);if("F"!==e)return t._i[e];for(r=t._f;r;r=r.n)if(r.k==n)return r};t.exports={getConstructor:function(t,n,r,s){var l=t(function(t,e){c(t,l,n,"_i"),t._i=i(null),t._f=void 0,t._l=void 0,t[d]=0,void 0!=e&&a(e,r,t[s],t)});return o(l.prototype,{clear:function(){for(var t=this,n=t._i,r=t._f;r;r=r.n)r.r=!0,r.p&&(r.p=r.p.n=void 0),delete n[r.i];t._f=t._l=void 0,t[d]=0},delete:function(t){var n=this,r=y(n,t);if(r){var e=r.n,i=r.p;delete n._i[r.i],r.r=!0,i&&(i.n=e),e&&(e.p=i),n._f==r&&(n._f=e),n._l==r&&(n._l=i),n[d]--}return!!r},forEach:function(t){c(this,l,"forEach");for(var n,r=u(t,arguments.length>1?arguments[1]:void 0,3);n=n?n.n:this._f;)for(r(n.v,n.k,this);n&&n.r;)n=n.p},has:function(t){return!!y(this,t)}}),v&&e(l.prototype,"size",{get:function(){return f(this[d])}}),l},def:function(t,n,r){var e,i,o=y(t,n);return o?o.v=r:(t._l=o={i:i=p(n,!0),k:n,v:r,p:e=t._l,n:void 0,r:!1},t._f||(t._f=o),e&&(e.n=o),t[d]++,"F"!==i&&(t._i[i]=o)),t},getEntry:y,setStrong:function(t,n,r){s(t,n,function(t,n){this._t=t,this._k=n,this._l=void 0},function(){for(var t=this,n=t._k,r=t._l;r&&r.r;)r=r.p;return t._t&&(t._l=r=r?r.n:t._t._f)?"keys"==n?l(0,r.k):"values"==n?l(0,r.v):l(0,[r.k,r.v]):(t._t=void 0,l(1))},r?"entries":"values",!r,!0),h(n)}}},function(t,n,r){var e=r(114),i=r(161);t.exports=function(t){return function(){if(e(this)!=t)throw TypeError(t+"#toJSON isn't generic");return i(this)}}},function(t,n,r){"use strict";var e=r(73),i=r(65).getWeak,o=r(2),u=r(6),c=r(68),f=r(79),a=r(48),s=r(24),l=a(5),h=a(6),v=0,p=function(t){return t._l||(t._l=new d)},d=function(){this.a=[]},y=function(t,n){return l(t.a,function(t){return t[0]===n})};d.prototype={get:function(t){var n=y(this,t);if(n)return n[1]},has:function(t){return!!y(this,t)},set:function(t,n){var r=y(this,t);r?r[1]=n:this.a.push([t,n])},delete:function(t){var n=h(this.a,function(n){return n[0]===t});return~n&&this.a.splice(n,1),!!~n}},t.exports={getConstructor:function(t,n,r,o){var a=t(function(t,e){c(t,a,n,"_i"),t._i=v++,t._l=void 0,void 0!=e&&f(e,r,t[o],t)});return e(a.prototype,{delete:function(t){if(!u(t))return!1;var n=i(t);return!0===n?p(this).delete(t):n&&s(n,this._i)&&delete n[this._i]},has:function(t){if(!u(t))return!1;var n=i(t);return!0===n?p(this).has(t):n&&s(n,this._i)}}),a},def:function(t,n,r){var e=i(o(n),!0);return!0===e?p(t).set(n,r):e[t._i]=r,t},ufstore:p}},function(t,n,r){t.exports=!r(10)&&!r(4)(function(){return 7!=Object.defineProperty(r(132)("div"),"a",{get:function(){return 7}}).a})},function(t,n,r){var e=r(6),i=Math.floor;t.exports=function(t){return!e(t)&&isFinite(t)&&i(t)===t}},function(t,n,r){var e=r(2);t.exports=function(t,n,r,i){try{return i?n(e(r)[0],r[1]):n(r)}catch(n){var o=t.return;throw void 0!==o&&e(o.call(t)),n}}},function(t,n){t.exports=function(t,n){return{value:n,done:!!t}}},function(t,n){t.exports=Math.log1p||function(t){return(t=+t)>-1e-8&&t<1e-8?t-t*t/2:Math.log(1+t)}},function(t,n,r){"use strict";var e=r(72),i=r(125),o=r(116),u=r(17),c=r(115),f=Object.assign;t.exports=!f||r(4)(function(){var t={},n={},r=Symbol(),e="abcdefghijklmnopqrst";return t[r]=7,e.split("").forEach(function(t){n[t]=t}),7!=f({},t)[r]||Object.keys(f({},n)).join("")!=e})?function(t,n){for(var r=u(t),f=arguments.length,a=1,s=i.f,l=o.f;f>a;)for(var h,v=c(arguments[a++]),p=s?e(v).concat(s(v)):e(v),d=p.length,y=0;d>y;)l.call(v,h=p[y++])&&(r[h]=v[h]);return r}:f},function(t,n,r){var e=r(11),i=r(2),o=r(72);t.exports=r(10)?Object.defineProperties:function(t,n){i(t);for(var r,u=o(n),c=u.length,f=0;c>f;)e.f(t,r=u[f++],n[r]);return t}},function(t,n,r){var e=r(30),i=r(71).f,o={}.toString,u="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],c=function(t){try{return i(t)}catch(t){return u.slice()}};t.exports.f=function(t){return u&&"[object Window]"==o.call(t)?c(t):i(e(t))}},function(t,n,r){var e=r(24),i=r(30),o=r(117)(!1),u=r(145)("IE_PROTO");t.exports=function(t,n){var r,c=i(t),f=0,a=[];for(r in c)r!=u&&e(c,r)&&a.push(r);for(;n.length>f;)e(c,r=n[f++])&&(~o(a,r)||a.push(r));return a}},function(t,n,r){var e=r(72),i=r(30),o=r(116).f;t.exports=function(t){return function(n){for(var r,u=i(n),c=e(u),f=c.length,a=0,s=[];f>a;)o.call(u,r=c[a++])&&s.push(t?[r,u[r]]:u[r]);return s}}},function(t,n,r){var e=r(71),i=r(125),o=r(2),u=r(3).Reflect;t.exports=u&&u.ownKeys||function(t){var n=e.f(o(t)),r=i.f;return r?n.concat(r(t)):n}},function(t,n,r){var e=r(3).parseFloat,i=r(82).trim;t.exports=1/e(r(150)+"-0")!=-1/0?function(t){var n=i(String(t),3),r=e(n);return 0===r&&"-"==n.charAt(0)?-0:r}:e},function(t,n,r){var e=r(3).parseInt,i=r(82).trim,o=r(150),u=/^[\-+]?0[xX]/;t.exports=8!==e(o+"08")||22!==e(o+"0x16")?function(t,n){var r=i(String(t),3);return e(r,n>>>0||(u.test(r)?16:10))}:e},function(t,n){t.exports=Object.is||function(t,n){return t===n?0!==t||1/t==1/n:t!=t&&n!=n}},function(t,n,r){var e=r(16),i=r(149),o=r(46);t.exports=function(t,n,r,u){var c=String(o(t)),f=c.length,a=void 0===r?" ":String(r),s=e(n);if(s<=f||""==a)return c;var l=s-f,h=i.call(a,Math.ceil(l/a.length));return h.length>l&&(h=h.slice(0,l)),u?h+c:c+h}},function(t,n,r){n.f=r(7)},function(t,n,r){"use strict";var e=r(164);t.exports=r(118)("Map",function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},{get:function(t){var n=e.getEntry(this,t);return n&&n.v},set:function(t,n){return e.def(this,0===t?0:t,n)}},e,!0)},function(t,n,r){r(10)&&"g"!=/./g.flags&&r(11).f(RegExp.prototype,"flags",{configurable:!0,get:r(120)})},function(t,n,r){"use strict";var e=r(164);t.exports=r(118)("Set",function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},{add:function(t){return e.def(this,t=0===t?0:t,t)}},e)},function(t,n,r){"use strict";var e,i=r(48)(0),o=r(28),u=r(65),c=r(172),f=r(166),a=r(6),s=u.getWeak,l=Object.isExtensible,h=f.ufstore,v={},p=function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},d={get:function(t){if(a(t)){var n=s(t);return!0===n?h(this).get(t):n?n[this._i]:void 0}},set:function(t,n){return f.def(this,t,n)}},y=t.exports=r(118)("WeakMap",p,d,f,!0,!0);7!=(new y).set((Object.freeze||Object)(v),7).get(v)&&(e=f.getConstructor(p),c(e.prototype,d),u.NEED=!0,i(["delete","has","get","set"],function(t){var n=y.prototype,r=n[t];o(n,t,function(n,i){if(a(n)&&!l(n)){this._f||(this._f=new e);var o=this._f[t](n,i);return"set"==t?this:o}return r.call(this,n,i)})}))},,,,function(t,n){"use strict";function r(){var t=document.querySelector("#page-nav");if(t&&!document.querySelector("#page-nav .extend.prev")&&(t.innerHTML='<a class="extend prev disabled" rel="prev">&laquo; Prev</a>'+t.innerHTML),t&&!document.querySelector("#page-nav .extend.next")&&(t.innerHTML=t.innerHTML+'<a class="extend next disabled" rel="next">Next &raquo;</a>'),yiliaConfig&&yiliaConfig.open_in_new){document.querySelectorAll(".article-entry a:not(.article-more-a)").forEach(function(t){var n=t.getAttribute("target");n&&""!==n||t.setAttribute("target","_blank")})}if(yiliaConfig&&yiliaConfig.toc_hide_index){document.querySelectorAll(".toc-number").forEach(function(t){t.style.display="none"})}var n=document.querySelector("#js-aboutme");n&&0!==n.length&&(n.innerHTML=n.innerText)}t.exports={init:r}},function(t,n,r){"use strict";function e(t){return t&&t.__esModule?t:{default:t}}function i(t,n){var r=/\/|index.html/g;return t.replace(r,"")===n.replace(r,"")}function o(){for(var t=document.querySelectorAll(".js-header-menu li a"),n=window.location.pathname,r=0,e=t.length;r<e;r++){var o=t[r];i(n,o.getAttribute("href"))&&(0,h.default)(o,"active")}}function u(t){for(var n=t.offsetLeft,r=t.offsetParent;null!==r;)n+=r.offsetLeft,r=r.offsetParent;return n}function c(t){for(var n=t.offsetTop,r=t.offsetParent;null!==r;)n+=r.offsetTop,r=r.offsetParent;return n}function f(t,n,r,e,i){var o=u(t),f=c(t)-n;if(f-r<=i){var a=t.$newDom;a||(a=t.cloneNode(!0),(0,d.default)(t,a),t.$newDom=a,a.style.position="fixed",a.style.top=(r||f)+"px",a.style.left=o+"px",a.style.zIndex=e||2,a.style.width="100%",a.style.color="#fff"),a.style.visibility="visible",t.style.visibility="hidden"}else{t.style.visibility="visible";var s=t.$newDom;s&&(s.style.visibility="hidden")}}function a(){var t=document.querySelector(".js-overlay"),n=document.querySelector(".js-header-menu");f(t,document.body.scrollTop,-63,2,0),f(n,document.body.scrollTop,1,3,0)}function s(){document.querySelector("#container").addEventListener("scroll",function(t){a()}),window.addEventListener("scroll",function(t){a()}),a()}var l=r(156),h=e(l),v=r(157),p=(e(v),r(382)),d=e(p),y=r(128),g=e(y),b=r(190),m=e(b),x=r(129);(function(){g.default.versions.mobile&&window.screen.width<800&&(o(),s())})(),(0,x.addLoadEvent)(function(){m.default.init()}),t.exports={}},,,,function(t,n,r){(function(t){"use strict";function n(t,n,r){t[n]||Object[e](t,n,{writable:!0,configurable:!0,value:r})}if(r(381),r(391),r(198),t._babelPolyfill)throw new Error("only one instance of babel-polyfill is allowed");t._babelPolyfill=!0;var e="defineProperty";n(String.prototype,"padLeft","".padStart),n(String.prototype,"padRight","".padEnd),"pop,reverse,shift,keys,values,entries,indexOf,every,some,forEach,map,filter,find,findIndex,includes,join,slice,concat,push,splice,unshift,sort,lastIndexOf,reduce,reduceRight,copyWithin,fill".split(",").forEach(function(t){[][t]&&n(Array,t,Function.call.bind([][t]))})}).call(n,function(){return this}())},,,function(t,n,r){r(210),t.exports=r(52).RegExp.escape},,,,function(t,n,r){var e=r(6),i=r(138),o=r(7)("species");t.exports=function(t){var n;return i(t)&&(n=t.constructor,"function"!=typeof n||n!==Array&&!i(n.prototype)||(n=void 0),e(n)&&null===(n=n[o])&&(n=void 0)),void 0===n?Array:n}},function(t,n,r){var e=r(202);t.exports=function(t,n){return new(e(t))(n)}},function(t,n,r){"use strict";var e=r(2),i=r(50),o="number";t.exports=function(t){if("string"!==t&&t!==o&&"default"!==t)throw TypeError("Incorrect hint");return i(e(this),t!=o)}},function(t,n,r){var e=r(72),i=r(125),o=r(116);t.exports=function(t){var n=e(t),r=i.f;if(r)for(var u,c=r(t),f=o.f,a=0;c.length>a;)f.call(t,u=c[a++])&&n.push(u);return n}},function(t,n,r){var e=r(72),i=r(30);t.exports=function(t,n){for(var r,o=i(t),u=e(o),c=u.length,f=0;c>f;)if(o[r=u[f++]]===n)return r}},function(t,n,r){"use strict";var e=r(208),i=r(121),o=r(26);t.exports=function(){for(var t=o(this),n=arguments.length,r=Array(n),u=0,c=e._,f=!1;n>u;)(r[u]=arguments[u++])===c&&(f=!0);return function(){var e,o=this,u=arguments.length,a=0,s=0;if(!f&&!u)return i(t,r,o);if(e=r.slice(),f)for(;n>a;a++)e[a]===c&&(e[a]=arguments[s++]);for(;u>s;)e.push(arguments[s++]);return i(t,e,o)}}},function(t,n,r){t.exports=r(3)},function(t,n){t.exports=function(t,n){var r=n===Object(n)?function(t){return n[t]}:n;return function(n){return String(n).replace(t,r)}}},function(t,n,r){var e=r(1),i=r(209)(/[\\^$*+?.()|[\]{}]/g,"\\$&");e(e.S,"RegExp",{escape:function(t){return i(t)}})},function(t,n,r){var e=r(1);e(e.P,"Array",{copyWithin:r(160)}),r(78)("copyWithin")},function(t,n,r){"use strict";var e=r(1),i=r(48)(4);e(e.P+e.F*!r(47)([].every,!0),"Array",{every:function(t){return i(this,t,arguments[1])}})},function(t,n,r){var e=r(1);e(e.P,"Array",{fill:r(130)}),r(78)("fill")},function(t,n,r){"use strict";var e=r(1),i=r(48)(2);e(e.P+e.F*!r(47)([].filter,!0),"Array",{filter:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(1),i=r(48)(6),o="findIndex",u=!0;o in[]&&Array(1)[o](function(){u=!1}),e(e.P+e.F*u,"Array",{findIndex:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0)}}),r(78)(o)},function(t,n,r){"use strict";var e=r(1),i=r(48)(5),o="find",u=!0;o in[]&&Array(1)[o](function(){u=!1}),e(e.P+e.F*u,"Array",{find:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0)}}),r(78)(o)},function(t,n,r){"use strict";var e=r(1),i=r(48)(0),o=r(47)([].forEach,!0);e(e.P+e.F*!o,"Array",{forEach:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(53),i=r(1),o=r(17),u=r(169),c=r(137),f=r(16),a=r(131),s=r(154);i(i.S+i.F*!r(123)(function(t){Array.from(t)}),"Array",{from:function(t){var n,r,i,l,h=o(t),v="function"==typeof this?this:Array,p=arguments.length,d=p>1?arguments[1]:void 0,y=void 0!==d,g=0,b=s(h);if(y&&(d=e(d,p>2?arguments[2]:void 0,2)),void 0==b||v==Array&&c(b))for(n=f(h.length),r=new v(n);n>g;g++)a(r,g,y?d(h[g],g):h[g]);else for(l=b.call(h),r=new v;!(i=l.next()).done;g++)a(r,g,y?u(l,d,[i.value,g],!0):i.value);return r.length=g,r}})},function(t,n,r){"use strict";var e=r(1),i=r(117)(!1),o=[].indexOf,u=!!o&&1/[1].indexOf(1,-0)<0;e(e.P+e.F*(u||!r(47)(o)),"Array",{indexOf:function(t){return u?o.apply(this,arguments)||0:i(this,t,arguments[1])}})},function(t,n,r){var e=r(1);e(e.S,"Array",{isArray:r(138)})},function(t,n,r){"use strict";var e=r(1),i=r(30),o=[].join;e(e.P+e.F*(r(115)!=Object||!r(47)(o)),"Array",{join:function(t){return o.call(i(this),void 0===t?",":t)}})},function(t,n,r){"use strict";var e=r(1),i=r(30),o=r(67),u=r(16),c=[].lastIndexOf,f=!!c&&1/[1].lastIndexOf(1,-0)<0;e(e.P+e.F*(f||!r(47)(c)),"Array",{lastIndexOf:function(t){if(f)return c.apply(this,arguments)||0;var n=i(this),r=u(n.length),e=r-1;for(arguments.length>1&&(e=Math.min(e,o(arguments[1]))),e<0&&(e=r+e);e>=0;e--)if(e in n&&n[e]===t)return e||0;return-1}})},function(t,n,r){"use strict";var e=r(1),i=r(48)(1);e(e.P+e.F*!r(47)([].map,!0),"Array",{map:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(1),i=r(131);e(e.S+e.F*r(4)(function(){function t(){}return!(Array.of.call(t)instanceof t)}),"Array",{of:function(){for(var t=0,n=arguments.length,r=new("function"==typeof this?this:Array)(n);n>t;)i(r,t,arguments[t++]);return r.length=n,r}})},function(t,n,r){"use strict";var e=r(1),i=r(162);e(e.P+e.F*!r(47)([].reduceRight,!0),"Array",{reduceRight:function(t){return i(this,t,arguments.length,arguments[1],!0)}})},function(t,n,r){"use strict";var e=r(1),i=r(162);e(e.P+e.F*!r(47)([].reduce,!0),"Array",{reduce:function(t){return i(this,t,arguments.length,arguments[1],!1)}})},function(t,n,r){"use strict";var e=r(1),i=r(135),o=r(45),u=r(75),c=r(16),f=[].slice;e(e.P+e.F*r(4)(function(){i&&f.call(i)}),"Array",{slice:function(t,n){var r=c(this.length),e=o(this);if(n=void 0===n?r:n,"Array"==e)return f.call(this,t,n);for(var i=u(t,r),a=u(n,r),s=c(a-i),l=Array(s),h=0;h<s;h++)l[h]="String"==e?this.charAt(i+h):this[i+h];return l}})},function(t,n,r){"use strict";var e=r(1),i=r(48)(3);e(e.P+e.F*!r(47)([].some,!0),"Array",{some:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(1),i=r(26),o=r(17),u=r(4),c=[].sort,f=[1,2,3];e(e.P+e.F*(u(function(){f.sort(void 0)})||!u(function(){f.sort(null)})||!r(47)(c)),"Array",{sort:function(t){return void 0===t?c.call(o(this)):c.call(o(this),i(t))}})},function(t,n,r){r(74)("Array")},function(t,n,r){var e=r(1);e(e.S,"Date",{now:function(){return(new Date).getTime()}})},function(t,n,r){"use strict";var e=r(1),i=r(4),o=Date.prototype.getTime,u=function(t){return t>9?t:"0"+t};e(e.P+e.F*(i(function(){return"0385-07-25T07:06:39.999Z"!=new Date(-5e13-1).toISOString()})||!i(function(){new Date(NaN).toISOString()})),"Date",{toISOString:function(){
if(!isFinite(o.call(this)))throw RangeError("Invalid time value");var t=this,n=t.getUTCFullYear(),r=t.getUTCMilliseconds(),e=n<0?"-":n>9999?"+":"";return e+("00000"+Math.abs(n)).slice(e?-6:-4)+"-"+u(t.getUTCMonth()+1)+"-"+u(t.getUTCDate())+"T"+u(t.getUTCHours())+":"+u(t.getUTCMinutes())+":"+u(t.getUTCSeconds())+"."+(r>99?r:"0"+u(r))+"Z"}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(50);e(e.P+e.F*r(4)(function(){return null!==new Date(NaN).toJSON()||1!==Date.prototype.toJSON.call({toISOString:function(){return 1}})}),"Date",{toJSON:function(t){var n=i(this),r=o(n);return"number"!=typeof r||isFinite(r)?n.toISOString():null}})},function(t,n,r){var e=r(7)("toPrimitive"),i=Date.prototype;e in i||r(27)(i,e,r(204))},function(t,n,r){var e=Date.prototype,i="Invalid Date",o="toString",u=e[o],c=e.getTime;new Date(NaN)+""!=i&&r(28)(e,o,function(){var t=c.call(this);return t===t?u.call(this):i})},function(t,n,r){var e=r(1);e(e.P,"Function",{bind:r(163)})},function(t,n,r){"use strict";var e=r(6),i=r(32),o=r(7)("hasInstance"),u=Function.prototype;o in u||r(11).f(u,o,{value:function(t){if("function"!=typeof this||!e(t))return!1;if(!e(this.prototype))return t instanceof this;for(;t=i(t);)if(this.prototype===t)return!0;return!1}})},function(t,n,r){var e=r(11).f,i=r(66),o=r(24),u=Function.prototype,c="name",f=Object.isExtensible||function(){return!0};c in u||r(10)&&e(u,c,{configurable:!0,get:function(){try{var t=this,n=(""+t).match(/^\s*function ([^ (]*)/)[1];return o(t,c)||!f(t)||e(t,c,i(5,n)),n}catch(t){return""}}})},function(t,n,r){var e=r(1),i=r(171),o=Math.sqrt,u=Math.acosh;e(e.S+e.F*!(u&&710==Math.floor(u(Number.MAX_VALUE))&&u(1/0)==1/0),"Math",{acosh:function(t){return(t=+t)<1?NaN:t>94906265.62425156?Math.log(t)+Math.LN2:i(t-1+o(t-1)*o(t+1))}})},function(t,n,r){function e(t){return isFinite(t=+t)&&0!=t?t<0?-e(-t):Math.log(t+Math.sqrt(t*t+1)):t}var i=r(1),o=Math.asinh;i(i.S+i.F*!(o&&1/o(0)>0),"Math",{asinh:e})},function(t,n,r){var e=r(1),i=Math.atanh;e(e.S+e.F*!(i&&1/i(-0)<0),"Math",{atanh:function(t){return 0==(t=+t)?t:Math.log((1+t)/(1-t))/2}})},function(t,n,r){var e=r(1),i=r(142);e(e.S,"Math",{cbrt:function(t){return i(t=+t)*Math.pow(Math.abs(t),1/3)}})},function(t,n,r){var e=r(1);e(e.S,"Math",{clz32:function(t){return(t>>>=0)?31-Math.floor(Math.log(t+.5)*Math.LOG2E):32}})},function(t,n,r){var e=r(1),i=Math.exp;e(e.S,"Math",{cosh:function(t){return(i(t=+t)+i(-t))/2}})},function(t,n,r){var e=r(1),i=r(141);e(e.S+e.F*(i!=Math.expm1),"Math",{expm1:i})},function(t,n,r){var e=r(1),i=r(142),o=Math.pow,u=o(2,-52),c=o(2,-23),f=o(2,127)*(2-c),a=o(2,-126),s=function(t){return t+1/u-1/u};e(e.S,"Math",{fround:function(t){var n,r,e=Math.abs(t),o=i(t);return e<a?o*s(e/a/c)*a*c:(n=(1+c/u)*e,r=n-(n-e),r>f||r!=r?o*(1/0):o*r)}})},function(t,n,r){var e=r(1),i=Math.abs;e(e.S,"Math",{hypot:function(t,n){for(var r,e,o=0,u=0,c=arguments.length,f=0;u<c;)r=i(arguments[u++]),f<r?(e=f/r,o=o*e*e+1,f=r):r>0?(e=r/f,o+=e*e):o+=r;return f===1/0?1/0:f*Math.sqrt(o)}})},function(t,n,r){var e=r(1),i=Math.imul;e(e.S+e.F*r(4)(function(){return-5!=i(4294967295,5)||2!=i.length}),"Math",{imul:function(t,n){var r=65535,e=+t,i=+n,o=r&e,u=r&i;return 0|o*u+((r&e>>>16)*u+o*(r&i>>>16)<<16>>>0)}})},function(t,n,r){var e=r(1);e(e.S,"Math",{log10:function(t){return Math.log(t)/Math.LN10}})},function(t,n,r){var e=r(1);e(e.S,"Math",{log1p:r(171)})},function(t,n,r){var e=r(1);e(e.S,"Math",{log2:function(t){return Math.log(t)/Math.LN2}})},function(t,n,r){var e=r(1);e(e.S,"Math",{sign:r(142)})},function(t,n,r){var e=r(1),i=r(141),o=Math.exp;e(e.S+e.F*r(4)(function(){return-2e-17!=!Math.sinh(-2e-17)}),"Math",{sinh:function(t){return Math.abs(t=+t)<1?(i(t)-i(-t))/2:(o(t-1)-o(-t-1))*(Math.E/2)}})},function(t,n,r){var e=r(1),i=r(141),o=Math.exp;e(e.S,"Math",{tanh:function(t){var n=i(t=+t),r=i(-t);return n==1/0?1:r==1/0?-1:(n-r)/(o(t)+o(-t))}})},function(t,n,r){var e=r(1);e(e.S,"Math",{trunc:function(t){return(t>0?Math.floor:Math.ceil)(t)}})},function(t,n,r){"use strict";var e=r(3),i=r(24),o=r(45),u=r(136),c=r(50),f=r(4),a=r(71).f,s=r(31).f,l=r(11).f,h=r(82).trim,v="Number",p=e[v],d=p,y=p.prototype,g=o(r(70)(y))==v,b="trim"in String.prototype,m=function(t){var n=c(t,!1);if("string"==typeof n&&n.length>2){n=b?n.trim():h(n,3);var r,e,i,o=n.charCodeAt(0);if(43===o||45===o){if(88===(r=n.charCodeAt(2))||120===r)return NaN}else if(48===o){switch(n.charCodeAt(1)){case 66:case 98:e=2,i=49;break;case 79:case 111:e=8,i=55;break;default:return+n}for(var u,f=n.slice(2),a=0,s=f.length;a<s;a++)if((u=f.charCodeAt(a))<48||u>i)return NaN;return parseInt(f,e)}}return+n};if(!p(" 0o1")||!p("0b1")||p("+0x1")){p=function(t){var n=arguments.length<1?0:t,r=this;return r instanceof p&&(g?f(function(){y.valueOf.call(r)}):o(r)!=v)?u(new d(m(n)),r,p):m(n)};for(var x,w=r(10)?a(d):"MAX_VALUE,MIN_VALUE,NaN,NEGATIVE_INFINITY,POSITIVE_INFINITY,EPSILON,isFinite,isInteger,isNaN,isSafeInteger,MAX_SAFE_INTEGER,MIN_SAFE_INTEGER,parseFloat,parseInt,isInteger".split(","),S=0;w.length>S;S++)i(d,x=w[S])&&!i(p,x)&&l(p,x,s(d,x));p.prototype=y,y.constructor=p,r(28)(e,v,p)}},function(t,n,r){var e=r(1);e(e.S,"Number",{EPSILON:Math.pow(2,-52)})},function(t,n,r){var e=r(1),i=r(3).isFinite;e(e.S,"Number",{isFinite:function(t){return"number"==typeof t&&i(t)}})},function(t,n,r){var e=r(1);e(e.S,"Number",{isInteger:r(168)})},function(t,n,r){var e=r(1);e(e.S,"Number",{isNaN:function(t){return t!=t}})},function(t,n,r){var e=r(1),i=r(168),o=Math.abs;e(e.S,"Number",{isSafeInteger:function(t){return i(t)&&o(t)<=9007199254740991}})},function(t,n,r){var e=r(1);e(e.S,"Number",{MAX_SAFE_INTEGER:9007199254740991})},function(t,n,r){var e=r(1);e(e.S,"Number",{MIN_SAFE_INTEGER:-9007199254740991})},function(t,n,r){var e=r(1),i=r(178);e(e.S+e.F*(Number.parseFloat!=i),"Number",{parseFloat:i})},function(t,n,r){var e=r(1),i=r(179);e(e.S+e.F*(Number.parseInt!=i),"Number",{parseInt:i})},function(t,n,r){"use strict";var e=r(1),i=r(67),o=r(159),u=r(149),c=1..toFixed,f=Math.floor,a=[0,0,0,0,0,0],s="Number.toFixed: incorrect invocation!",l="0",h=function(t,n){for(var r=-1,e=n;++r<6;)e+=t*a[r],a[r]=e%1e7,e=f(e/1e7)},v=function(t){for(var n=6,r=0;--n>=0;)r+=a[n],a[n]=f(r/t),r=r%t*1e7},p=function(){for(var t=6,n="";--t>=0;)if(""!==n||0===t||0!==a[t]){var r=String(a[t]);n=""===n?r:n+u.call(l,7-r.length)+r}return n},d=function(t,n,r){return 0===n?r:n%2==1?d(t,n-1,r*t):d(t*t,n/2,r)},y=function(t){for(var n=0,r=t;r>=4096;)n+=12,r/=4096;for(;r>=2;)n+=1,r/=2;return n};e(e.P+e.F*(!!c&&("0.000"!==8e-5.toFixed(3)||"1"!==.9.toFixed(0)||"1.25"!==1.255.toFixed(2)||"1000000000000000128"!==(0xde0b6b3a7640080).toFixed(0))||!r(4)(function(){c.call({})})),"Number",{toFixed:function(t){var n,r,e,c,f=o(this,s),a=i(t),g="",b=l;if(a<0||a>20)throw RangeError(s);if(f!=f)return"NaN";if(f<=-1e21||f>=1e21)return String(f);if(f<0&&(g="-",f=-f),f>1e-21)if(n=y(f*d(2,69,1))-69,r=n<0?f*d(2,-n,1):f/d(2,n,1),r*=4503599627370496,(n=52-n)>0){for(h(0,r),e=a;e>=7;)h(1e7,0),e-=7;for(h(d(10,e,1),0),e=n-1;e>=23;)v(1<<23),e-=23;v(1<<e),h(1,1),v(2),b=p()}else h(0,r),h(1<<-n,0),b=p()+u.call(l,a);return a>0?(c=b.length,b=g+(c<=a?"0."+u.call(l,a-c)+b:b.slice(0,c-a)+"."+b.slice(c-a))):b=g+b,b}})},function(t,n,r){"use strict";var e=r(1),i=r(4),o=r(159),u=1..toPrecision;e(e.P+e.F*(i(function(){return"1"!==u.call(1,void 0)})||!i(function(){u.call({})})),"Number",{toPrecision:function(t){var n=o(this,"Number#toPrecision: incorrect invocation!");return void 0===t?u.call(n):u.call(n,t)}})},function(t,n,r){var e=r(1);e(e.S+e.F,"Object",{assign:r(172)})},function(t,n,r){var e=r(1);e(e.S,"Object",{create:r(70)})},function(t,n,r){var e=r(1);e(e.S+e.F*!r(10),"Object",{defineProperties:r(173)})},function(t,n,r){var e=r(1);e(e.S+e.F*!r(10),"Object",{defineProperty:r(11).f})},function(t,n,r){var e=r(6),i=r(65).onFreeze;r(49)("freeze",function(t){return function(n){return t&&e(n)?t(i(n)):n}})},function(t,n,r){var e=r(30),i=r(31).f;r(49)("getOwnPropertyDescriptor",function(){return function(t,n){return i(e(t),n)}})},function(t,n,r){r(49)("getOwnPropertyNames",function(){return r(174).f})},function(t,n,r){var e=r(17),i=r(32);r(49)("getPrototypeOf",function(){return function(t){return i(e(t))}})},function(t,n,r){var e=r(6);r(49)("isExtensible",function(t){return function(n){return!!e(n)&&(!t||t(n))}})},function(t,n,r){var e=r(6);r(49)("isFrozen",function(t){return function(n){return!e(n)||!!t&&t(n)}})},function(t,n,r){var e=r(6);r(49)("isSealed",function(t){return function(n){return!e(n)||!!t&&t(n)}})},function(t,n,r){var e=r(1);e(e.S,"Object",{is:r(180)})},function(t,n,r){var e=r(17),i=r(72);r(49)("keys",function(){return function(t){return i(e(t))}})},function(t,n,r){var e=r(6),i=r(65).onFreeze;r(49)("preventExtensions",function(t){return function(n){return t&&e(n)?t(i(n)):n}})},function(t,n,r){var e=r(6),i=r(65).onFreeze;r(49)("seal",function(t){return function(n){return t&&e(n)?t(i(n)):n}})},function(t,n,r){var e=r(1);e(e.S,"Object",{setPrototypeOf:r(144).set})},function(t,n,r){"use strict";var e=r(114),i={};i[r(7)("toStringTag")]="z",i+""!="[object z]"&&r(28)(Object.prototype,"toString",function(){return"[object "+e(this)+"]"},!0)},function(t,n,r){var e=r(1),i=r(178);e(e.G+e.F*(parseFloat!=i),{parseFloat:i})},function(t,n,r){var e=r(1),i=r(179);e(e.G+e.F*(parseInt!=i),{parseInt:i})},function(t,n,r){"use strict";var e,i,o,u=r(69),c=r(3),f=r(53),a=r(114),s=r(1),l=r(6),h=r(26),v=r(68),p=r(79),d=r(146),y=r(151).set,g=r(143)(),b="Promise",m=c.TypeError,x=c.process,w=c[b],x=c.process,S="process"==a(x),_=function(){},O=!!function(){try{var t=w.resolve(1),n=(t.constructor={})[r(7)("species")]=function(t){t(_,_)};return(S||"function"==typeof PromiseRejectionEvent)&&t.then(_)instanceof n}catch(t){}}(),E=function(t,n){return t===n||t===w&&n===o},P=function(t){var n;return!(!l(t)||"function"!=typeof(n=t.then))&&n},j=function(t){return E(w,t)?new F(t):new i(t)},F=i=function(t){var n,r;this.promise=new t(function(t,e){if(void 0!==n||void 0!==r)throw m("Bad Promise constructor");n=t,r=e}),this.resolve=h(n),this.reject=h(r)},M=function(t){try{t()}catch(t){return{error:t}}},A=function(t,n){if(!t._n){t._n=!0;var r=t._c;g(function(){for(var e=t._v,i=1==t._s,o=0;r.length>o;)!function(n){var r,o,u=i?n.ok:n.fail,c=n.resolve,f=n.reject,a=n.domain;try{u?(i||(2==t._h&&I(t),t._h=1),!0===u?r=e:(a&&a.enter(),r=u(e),a&&a.exit()),r===n.promise?f(m("Promise-chain cycle")):(o=P(r))?o.call(r,c,f):c(r)):f(e)}catch(t){f(t)}}(r[o++]);t._c=[],t._n=!1,n&&!t._h&&N(t)})}},N=function(t){y.call(c,function(){var n,r,e,i=t._v;if(T(t)&&(n=M(function(){S?x.emit("unhandledRejection",i,t):(r=c.onunhandledrejection)?r({promise:t,reason:i}):(e=c.console)&&e.error&&e.error("Unhandled promise rejection",i)}),t._h=S||T(t)?2:1),t._a=void 0,n)throw n.error})},T=function(t){if(1==t._h)return!1;for(var n,r=t._a||t._c,e=0;r.length>e;)if(n=r[e++],n.fail||!T(n.promise))return!1;return!0},I=function(t){y.call(c,function(){var n;S?x.emit("rejectionHandled",t):(n=c.onrejectionhandled)&&n({promise:t,reason:t._v})})},k=function(t){var n=this;n._d||(n._d=!0,n=n._w||n,n._v=t,n._s=2,n._a||(n._a=n._c.slice()),A(n,!0))},L=function(t){var n,r=this;if(!r._d){r._d=!0,r=r._w||r;try{if(r===t)throw m("Promise can't be resolved itself");(n=P(t))?g(function(){var e={_w:r,_d:!1};try{n.call(t,f(L,e,1),f(k,e,1))}catch(t){k.call(e,t)}}):(r._v=t,r._s=1,A(r,!1))}catch(t){k.call({_w:r,_d:!1},t)}}};O||(w=function(t){v(this,w,b,"_h"),h(t),e.call(this);try{t(f(L,this,1),f(k,this,1))}catch(t){k.call(this,t)}},e=function(t){this._c=[],this._a=void 0,this._s=0,this._d=!1,this._v=void 0,this._h=0,this._n=!1},e.prototype=r(73)(w.prototype,{then:function(t,n){var r=j(d(this,w));return r.ok="function"!=typeof t||t,r.fail="function"==typeof n&&n,r.domain=S?x.domain:void 0,this._c.push(r),this._a&&this._a.push(r),this._s&&A(this,!1),r.promise},catch:function(t){return this.then(void 0,t)}}),F=function(){var t=new e;this.promise=t,this.resolve=f(L,t,1),this.reject=f(k,t,1)}),s(s.G+s.W+s.F*!O,{Promise:w}),r(81)(w,b),r(74)(b),o=r(52)[b],s(s.S+s.F*!O,b,{reject:function(t){var n=j(this);return(0,n.reject)(t),n.promise}}),s(s.S+s.F*(u||!O),b,{resolve:function(t){if(t instanceof w&&E(t.constructor,this))return t;var n=j(this);return(0,n.resolve)(t),n.promise}}),s(s.S+s.F*!(O&&r(123)(function(t){w.all(t).catch(_)})),b,{all:function(t){var n=this,r=j(n),e=r.resolve,i=r.reject,o=M(function(){var r=[],o=0,u=1;p(t,!1,function(t){var c=o++,f=!1;r.push(void 0),u++,n.resolve(t).then(function(t){f||(f=!0,r[c]=t,--u||e(r))},i)}),--u||e(r)});return o&&i(o.error),r.promise},race:function(t){var n=this,r=j(n),e=r.reject,i=M(function(){p(t,!1,function(t){n.resolve(t).then(r.resolve,e)})});return i&&e(i.error),r.promise}})},function(t,n,r){var e=r(1),i=r(26),o=r(2),u=(r(3).Reflect||{}).apply,c=Function.apply;e(e.S+e.F*!r(4)(function(){u(function(){})}),"Reflect",{apply:function(t,n,r){var e=i(t),f=o(r);return u?u(e,n,f):c.call(e,n,f)}})},function(t,n,r){var e=r(1),i=r(70),o=r(26),u=r(2),c=r(6),f=r(4),a=r(163),s=(r(3).Reflect||{}).construct,l=f(function(){function t(){}return!(s(function(){},[],t)instanceof t)}),h=!f(function(){s(function(){})});e(e.S+e.F*(l||h),"Reflect",{construct:function(t,n){o(t),u(n);var r=arguments.length<3?t:o(arguments[2]);if(h&&!l)return s(t,n,r);if(t==r){switch(n.length){case 0:return new t;case 1:return new t(n[0]);case 2:return new t(n[0],n[1]);case 3:return new t(n[0],n[1],n[2]);case 4:return new t(n[0],n[1],n[2],n[3])}var e=[null];return e.push.apply(e,n),new(a.apply(t,e))}var f=r.prototype,v=i(c(f)?f:Object.prototype),p=Function.apply.call(t,v,n);return c(p)?p:v}})},function(t,n,r){var e=r(11),i=r(1),o=r(2),u=r(50);i(i.S+i.F*r(4)(function(){Reflect.defineProperty(e.f({},1,{value:1}),1,{value:2})}),"Reflect",{defineProperty:function(t,n,r){o(t),n=u(n,!0),o(r);try{return e.f(t,n,r),!0}catch(t){return!1}}})},function(t,n,r){var e=r(1),i=r(31).f,o=r(2);e(e.S,"Reflect",{deleteProperty:function(t,n){var r=i(o(t),n);return!(r&&!r.configurable)&&delete t[n]}})},function(t,n,r){"use strict";var e=r(1),i=r(2),o=function(t){this._t=i(t),this._i=0;var n,r=this._k=[];for(n in t)r.push(n)};r(139)(o,"Object",function(){var t,n=this,r=n._k;do{if(n._i>=r.length)return{value:void 0,done:!0}}while(!((t=r[n._i++])in n._t));return{value:t,done:!1}}),e(e.S,"Reflect",{enumerate:function(t){return new o(t)}})},function(t,n,r){var e=r(31),i=r(1),o=r(2);i(i.S,"Reflect",{getOwnPropertyDescriptor:function(t,n){return e.f(o(t),n)}})},function(t,n,r){var e=r(1),i=r(32),o=r(2);e(e.S,"Reflect",{getPrototypeOf:function(t){return i(o(t))}})},function(t,n,r){function e(t,n){var r,c,s=arguments.length<3?t:arguments[2];return a(t)===s?t[n]:(r=i.f(t,n))?u(r,"value")?r.value:void 0!==r.get?r.get.call(s):void 0:f(c=o(t))?e(c,n,s):void 0}var i=r(31),o=r(32),u=r(24),c=r(1),f=r(6),a=r(2);c(c.S,"Reflect",{get:e})},function(t,n,r){var e=r(1);e(e.S,"Reflect",{has:function(t,n){return n in t}})},function(t,n,r){var e=r(1),i=r(2),o=Object.isExtensible;e(e.S,"Reflect",{isExtensible:function(t){return i(t),!o||o(t)}})},function(t,n,r){var e=r(1);e(e.S,"Reflect",{ownKeys:r(177)})},function(t,n,r){var e=r(1),i=r(2),o=Object.preventExtensions;e(e.S,"Reflect",{preventExtensions:function(t){i(t);try{return o&&o(t),!0}catch(t){return!1}}})},function(t,n,r){var e=r(1),i=r(144);i&&e(e.S,"Reflect",{setPrototypeOf:function(t,n){i.check(t,n);try{return i.set(t,n),!0}catch(t){return!1}}})},function(t,n,r){function e(t,n,r){var f,h,v=arguments.length<4?t:arguments[3],p=o.f(s(t),n);if(!p){if(l(h=u(t)))return e(h,n,r,v);p=a(0)}return c(p,"value")?!(!1===p.writable||!l(v)||(f=o.f(v,n)||a(0),f.value=r,i.f(v,n,f),0)):void 0!==p.set&&(p.set.call(v,r),!0)}var i=r(11),o=r(31),u=r(32),c=r(24),f=r(1),a=r(66),s=r(2),l=r(6);f(f.S,"Reflect",{set:e})},function(t,n,r){var e=r(3),i=r(136),o=r(11).f,u=r(71).f,c=r(122),f=r(120),a=e.RegExp,s=a,l=a.prototype,h=/a/g,v=/a/g,p=new a(h)!==h;if(r(10)&&(!p||r(4)(function(){return v[r(7)("match")]=!1,a(h)!=h||a(v)==v||"/a/i"!=a(h,"i")}))){a=function(t,n){var r=this instanceof a,e=c(t),o=void 0===n;return!r&&e&&t.constructor===a&&o?t:i(p?new s(e&&!o?t.source:t,n):s((e=t instanceof a)?t.source:t,e&&o?f.call(t):n),r?this:l,a)};for(var d=u(s),y=0;d.length>y;)!function(t){t in a||o(a,t,{configurable:!0,get:function(){return s[t]},set:function(n){s[t]=n}})}(d[y++]);l.constructor=a,a.prototype=l,r(28)(e,"RegExp",a)}r(74)("RegExp")},function(t,n,r){r(119)("match",1,function(t,n,r){return[function(r){"use strict";var e=t(this),i=void 0==r?void 0:r[n];return void 0!==i?i.call(r,e):new RegExp(r)[n](String(e))},r]})},function(t,n,r){r(119)("replace",2,function(t,n,r){return[function(e,i){"use strict";var o=t(this),u=void 0==e?void 0:e[n];return void 0!==u?u.call(e,o,i):r.call(String(o),e,i)},r]})},function(t,n,r){r(119)("search",1,function(t,n,r){return[function(r){"use strict";var e=t(this),i=void 0==r?void 0:r[n];return void 0!==i?i.call(r,e):new RegExp(r)[n](String(e))},r]})},function(t,n,r){r(119)("split",2,function(t,n,e){"use strict";var i=r(122),o=e,u=[].push,c="split",f="length",a="lastIndex";if("c"=="abbc"[c](/(b)*/)[1]||4!="test"[c](/(?:)/,-1)[f]||2!="ab"[c](/(?:ab)*/)[f]||4!="."[c](/(.?)(.?)/)[f]||"."[c](/()()/)[f]>1||""[c](/.?/)[f]){var s=void 0===/()??/.exec("")[1];e=function(t,n){var r=String(this);if(void 0===t&&0===n)return[];if(!i(t))return o.call(r,t,n);var e,c,l,h,v,p=[],d=(t.ignoreCase?"i":"")+(t.multiline?"m":"")+(t.unicode?"u":"")+(t.sticky?"y":""),y=0,g=void 0===n?4294967295:n>>>0,b=new RegExp(t.source,d+"g");for(s||(e=new RegExp("^"+b.source+"$(?!\\s)",d));(c=b.exec(r))&&!((l=c.index+c[0][f])>y&&(p.push(r.slice(y,c.index)),!s&&c[f]>1&&c[0].replace(e,function(){for(v=1;v<arguments[f]-2;v++)void 0===arguments[v]&&(c[v]=void 0)}),c[f]>1&&c.index<r[f]&&u.apply(p,c.slice(1)),h=c[0][f],y=l,p[f]>=g));)b[a]===c.index&&b[a]++;return y===r[f]?!h&&b.test("")||p.push(""):p.push(r.slice(y)),p[f]>g?p.slice(0,g):p}}else"0"[c](void 0,0)[f]&&(e=function(t,n){return void 0===t&&0===n?[]:o.call(this,t,n)});return[function(r,i){var o=t(this),u=void 0==r?void 0:r[n];return void 0!==u?u.call(r,o,i):e.call(String(o),r,i)},e]})},function(t,n,r){"use strict";r(184);var e=r(2),i=r(120),o=r(10),u="toString",c=/./[u],f=function(t){r(28)(RegExp.prototype,u,t,!0)};r(4)(function(){return"/a/b"!=c.call({source:"a",flags:"b"})})?f(function(){var t=e(this);return"/".concat(t.source,"/","flags"in t?t.flags:!o&&t instanceof RegExp?i.call(t):void 0)}):c.name!=u&&f(function(){return c.call(this)})},function(t,n,r){"use strict";r(29)("anchor",function(t){return function(n){return t(this,"a","name",n)}})},function(t,n,r){"use strict";r(29)("big",function(t){return function(){return t(this,"big","","")}})},function(t,n,r){"use strict";r(29)("blink",function(t){return function(){return t(this,"blink","","")}})},function(t,n,r){"use strict";r(29)("bold",function(t){return function(){return t(this,"b","","")}})},function(t,n,r){"use strict";var e=r(1),i=r(147)(!1);e(e.P,"String",{codePointAt:function(t){return i(this,t)}})},function(t,n,r){"use strict";var e=r(1),i=r(16),o=r(148),u="endsWith",c=""[u];e(e.P+e.F*r(134)(u),"String",{endsWith:function(t){var n=o(this,t,u),r=arguments.length>1?arguments[1]:void 0,e=i(n.length),f=void 0===r?e:Math.min(i(r),e),a=String(t);return c?c.call(n,a,f):n.slice(f-a.length,f)===a}})},function(t,n,r){"use strict";r(29)("fixed",function(t){return function(){return t(this,"tt","","")}})},function(t,n,r){"use strict";r(29)("fontcolor",function(t){return function(n){return t(this,"font","color",n)}})},function(t,n,r){"use strict";r(29)("fontsize",function(t){return function(n){return t(this,"font","size",n)}})},function(t,n,r){var e=r(1),i=r(75),o=String.fromCharCode,u=String.fromCodePoint;e(e.S+e.F*(!!u&&1!=u.length),"String",{fromCodePoint:function(t){for(var n,r=[],e=arguments.length,u=0;e>u;){if(n=+arguments[u++],i(n,1114111)!==n)throw RangeError(n+" is not a valid code point");r.push(n<65536?o(n):o(55296+((n-=65536)>>10),n%1024+56320))}return r.join("")}})},function(t,n,r){"use strict";var e=r(1),i=r(148),o="includes";e(e.P+e.F*r(134)(o),"String",{includes:function(t){return!!~i(this,t,o).indexOf(t,arguments.length>1?arguments[1]:void 0)}})},function(t,n,r){"use strict";r(29)("italics",function(t){return function(){return t(this,"i","","")}})},function(t,n,r){"use strict";var e=r(147)(!0);r(140)(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,n=this._t,r=this._i;return r>=n.length?{value:void 0,done:!0}:(t=e(n,r),this._i+=t.length,{value:t,done:!1})})},function(t,n,r){"use strict";r(29)("link",function(t){return function(n){return t(this,"a","href",n)}})},function(t,n,r){var e=r(1),i=r(30),o=r(16);e(e.S,"String",{raw:function(t){for(var n=i(t.raw),r=o(n.length),e=arguments.length,u=[],c=0;r>c;)u.push(String(n[c++])),c<e&&u.push(String(arguments[c]));return u.join("")}})},function(t,n,r){var e=r(1);e(e.P,"String",{repeat:r(149)})},function(t,n,r){"use strict";r(29)("small",function(t){return function(){return t(this,"small","","")}})},function(t,n,r){"use strict";var e=r(1),i=r(16),o=r(148),u="startsWith",c=""[u];e(e.P+e.F*r(134)(u),"String",{startsWith:function(t){var n=o(this,t,u),r=i(Math.min(arguments.length>1?arguments[1]:void 0,n.length)),e=String(t);return c?c.call(n,e,r):n.slice(r,r+e.length)===e}})},function(t,n,r){"use strict";r(29)("strike",function(t){return function(){return t(this,"strike","","")}})},function(t,n,r){"use strict";r(29)("sub",function(t){return function(){return t(this,"sub","","")}})},function(t,n,r){"use strict";r(29)("sup",function(t){return function(){return t(this,"sup","","")}})},function(t,n,r){"use strict";r(82)("trim",function(t){return function(){return t(this,3)}})},function(t,n,r){"use strict";var e=r(3),i=r(24),o=r(10),u=r(1),c=r(28),f=r(65).KEY,a=r(4),s=r(126),l=r(81),h=r(76),v=r(7),p=r(182),d=r(153),y=r(206),g=r(205),b=r(138),m=r(2),x=r(30),w=r(50),S=r(66),_=r(70),O=r(174),E=r(31),P=r(11),j=r(72),F=E.f,M=P.f,A=O.f,N=e.Symbol,T=e.JSON,I=T&&T.stringify,k="prototype",L=v("_hidden"),R=v("toPrimitive"),C={}.propertyIsEnumerable,D=s("symbol-registry"),U=s("symbols"),W=s("op-symbols"),G=Object[k],B="function"==typeof N,V=e.QObject,z=!V||!V[k]||!V[k].findChild,q=o&&a(function(){return 7!=_(M({},"a",{get:function(){return M(this,"a",{value:7}).a}})).a})?function(t,n,r){var e=F(G,n);e&&delete G[n],M(t,n,r),e&&t!==G&&M(G,n,e)}:M,K=function(t){var n=U[t]=_(N[k]);return n._k=t,n},J=B&&"symbol"==typeof N.iterator?function(t){return"symbol"==typeof t}:function(t){return t instanceof N},Y=function(t,n,r){return t===G&&Y(W,n,r),m(t),n=w(n,!0),m(r),i(U,n)?(r.enumerable?(i(t,L)&&t[L][n]&&(t[L][n]=!1),r=_(r,{enumerable:S(0,!1)})):(i(t,L)||M(t,L,S(1,{})),t[L][n]=!0),q(t,n,r)):M(t,n,r)},H=function(t,n){m(t);for(var r,e=g(n=x(n)),i=0,o=e.length;o>i;)Y(t,r=e[i++],n[r]);return t},$=function(t,n){return void 0===n?_(t):H(_(t),n)},X=function(t){var n=C.call(this,t=w(t,!0));return!(this===G&&i(U,t)&&!i(W,t))&&(!(n||!i(this,t)||!i(U,t)||i(this,L)&&this[L][t])||n)},Q=function(t,n){if(t=x(t),n=w(n,!0),t!==G||!i(U,n)||i(W,n)){var r=F(t,n);return!r||!i(U,n)||i(t,L)&&t[L][n]||(r.enumerable=!0),r}},Z=function(t){for(var n,r=A(x(t)),e=[],o=0;r.length>o;)i(U,n=r[o++])||n==L||n==f||e.push(n);return e},tt=function(t){for(var n,r=t===G,e=A(r?W:x(t)),o=[],u=0;e.length>u;)!i(U,n=e[u++])||r&&!i(G,n)||o.push(U[n]);return o};B||(N=function(){if(this instanceof N)throw TypeError("Symbol is not a constructor!");var t=h(arguments.length>0?arguments[0]:void 0),n=function(r){this===G&&n.call(W,r),i(this,L)&&i(this[L],t)&&(this[L][t]=!1),q(this,t,S(1,r))};return o&&z&&q(G,t,{configurable:!0,set:n}),K(t)},c(N[k],"toString",function(){return this._k}),E.f=Q,P.f=Y,r(71).f=O.f=Z,r(116).f=X,r(125).f=tt,o&&!r(69)&&c(G,"propertyIsEnumerable",X,!0),p.f=function(t){return K(v(t))}),u(u.G+u.W+u.F*!B,{Symbol:N});for(var nt="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),rt=0;nt.length>rt;)v(nt[rt++]);for(var nt=j(v.store),rt=0;nt.length>rt;)d(nt[rt++]);u(u.S+u.F*!B,"Symbol",{for:function(t){return i(D,t+="")?D[t]:D[t]=N(t)},keyFor:function(t){if(J(t))return y(D,t);throw TypeError(t+" is not a symbol!")},useSetter:function(){z=!0},useSimple:function(){z=!1}}),u(u.S+u.F*!B,"Object",{create:$,defineProperty:Y,defineProperties:H,getOwnPropertyDescriptor:Q,getOwnPropertyNames:Z,getOwnPropertySymbols:tt}),T&&u(u.S+u.F*(!B||a(function(){var t=N();return"[null]"!=I([t])||"{}"!=I({a:t})||"{}"!=I(Object(t))})),"JSON",{stringify:function(t){if(void 0!==t&&!J(t)){for(var n,r,e=[t],i=1;arguments.length>i;)e.push(arguments[i++]);return n=e[1],"function"==typeof n&&(r=n),!r&&b(n)||(n=function(t,n){if(r&&(n=r.call(this,t,n)),!J(n))return n}),e[1]=n,I.apply(T,e)}}}),N[k][R]||r(27)(N[k],R,N[k].valueOf),l(N,"Symbol"),l(Math,"Math",!0),l(e.JSON,"JSON",!0)},function(t,n,r){"use strict";var e=r(1),i=r(127),o=r(152),u=r(2),c=r(75),f=r(16),a=r(6),s=r(3).ArrayBuffer,l=r(146),h=o.ArrayBuffer,v=o.DataView,p=i.ABV&&s.isView,d=h.prototype.slice,y=i.VIEW,g="ArrayBuffer";e(e.G+e.W+e.F*(s!==h),{ArrayBuffer:h}),e(e.S+e.F*!i.CONSTR,g,{isView:function(t){return p&&p(t)||a(t)&&y in t}}),e(e.P+e.U+e.F*r(4)(function(){return!new h(2).slice(1,void 0).byteLength}),g,{slice:function(t,n){if(void 0!==d&&void 0===n)return d.call(u(this),t);for(var r=u(this).byteLength,e=c(t,r),i=c(void 0===n?r:n,r),o=new(l(this,h))(f(i-e)),a=new v(this),s=new v(o),p=0;e<i;)s.setUint8(p++,a.getUint8(e++));return o}}),r(74)(g)},function(t,n,r){var e=r(1);e(e.G+e.W+e.F*!r(127).ABV,{DataView:r(152).DataView})},function(t,n,r){r(55)("Float32",4,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Float64",8,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Int16",2,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Int32",4,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Int8",1,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Uint16",2,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Uint32",4,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Uint8",1,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Uint8",1,function(t){return function(n,r,e){return t(this,n,r,e)}},!0)},function(t,n,r){"use strict";var e=r(166);r(118)("WeakSet",function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},{add:function(t){return e.def(this,t,!0)}},e,!1,!0)},function(t,n,r){"use strict";var e=r(1),i=r(117)(!0);e(e.P,"Array",{includes:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0)}}),r(78)("includes")},function(t,n,r){var e=r(1),i=r(143)(),o=r(3).process,u="process"==r(45)(o);e(e.G,{asap:function(t){var n=u&&o.domain;i(n?n.bind(t):t)}})},function(t,n,r){var e=r(1),i=r(45);e(e.S,"Error",{isError:function(t){return"Error"===i(t)}})},function(t,n,r){var e=r(1);e(e.P+e.R,"Map",{toJSON:r(165)("Map")})},function(t,n,r){var e=r(1);e(e.S,"Math",{iaddh:function(t,n,r,e){var i=t>>>0,o=n>>>0,u=r>>>0;return o+(e>>>0)+((i&u|(i|u)&~(i+u>>>0))>>>31)|0}})},function(t,n,r){var e=r(1);e(e.S,"Math",{imulh:function(t,n){var r=65535,e=+t,i=+n,o=e&r,u=i&r,c=e>>16,f=i>>16,a=(c*u>>>0)+(o*u>>>16);return c*f+(a>>16)+((o*f>>>0)+(a&r)>>16)}})},function(t,n,r){var e=r(1);e(e.S,"Math",{isubh:function(t,n,r,e){var i=t>>>0,o=n>>>0,u=r>>>0;return o-(e>>>0)-((~i&u|~(i^u)&i-u>>>0)>>>31)|0}})},function(t,n,r){var e=r(1);e(e.S,"Math",{umulh:function(t,n){var r=65535,e=+t,i=+n,o=e&r,u=i&r,c=e>>>16,f=i>>>16,a=(c*u>>>0)+(o*u>>>16);return c*f+(a>>>16)+((o*f>>>0)+(a&r)>>>16)}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(26),u=r(11);r(10)&&e(e.P+r(124),"Object",{__defineGetter__:function(t,n){u.f(i(this),t,{get:o(n),enumerable:!0,configurable:!0})}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(26),u=r(11);r(10)&&e(e.P+r(124),"Object",{__defineSetter__:function(t,n){u.f(i(this),t,{set:o(n),enumerable:!0,configurable:!0})}})},function(t,n,r){var e=r(1),i=r(176)(!0);e(e.S,"Object",{entries:function(t){return i(t)}})},function(t,n,r){var e=r(1),i=r(177),o=r(30),u=r(31),c=r(131);e(e.S,"Object",{getOwnPropertyDescriptors:function(t){for(var n,r=o(t),e=u.f,f=i(r),a={},s=0;f.length>s;)c(a,n=f[s++],e(r,n));return a}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(50),u=r(32),c=r(31).f;r(10)&&e(e.P+r(124),"Object",{__lookupGetter__:function(t){var n,r=i(this),e=o(t,!0);do{if(n=c(r,e))return n.get}while(r=u(r))}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(50),u=r(32),c=r(31).f;r(10)&&e(e.P+r(124),"Object",{__lookupSetter__:function(t){var n,r=i(this),e=o(t,!0);do{if(n=c(r,e))return n.set}while(r=u(r))}})},function(t,n,r){var e=r(1),i=r(176)(!1);e(e.S,"Object",{values:function(t){return i(t)}})},function(t,n,r){"use strict";var e=r(1),i=r(3),o=r(52),u=r(143)(),c=r(7)("observable"),f=r(26),a=r(2),s=r(68),l=r(73),h=r(27),v=r(79),p=v.RETURN,d=function(t){return null==t?void 0:f(t)},y=function(t){var n=t._c;n&&(t._c=void 0,n())},g=function(t){return void 0===t._o},b=function(t){g(t)||(t._o=void 0,y(t))},m=function(t,n){a(t),this._c=void 0,this._o=t,t=new x(this);try{var r=n(t),e=r;null!=r&&("function"==typeof r.unsubscribe?r=function(){e.unsubscribe()}:f(r),this._c=r)}catch(n){return void t.error(n)}g(this)&&y(this)};m.prototype=l({},{unsubscribe:function(){b(this)}});var x=function(t){this._s=t};x.prototype=l({},{next:function(t){var n=this._s;if(!g(n)){var r=n._o;try{var e=d(r.next);if(e)return e.call(r,t)}catch(t){try{b(n)}finally{throw t}}}},error:function(t){var n=this._s;if(g(n))throw t;var r=n._o;n._o=void 0;try{var e=d(r.error);if(!e)throw t;t=e.call(r,t)}catch(t){try{y(n)}finally{throw t}}return y(n),t},complete:function(t){var n=this._s;if(!g(n)){var r=n._o;n._o=void 0;try{var e=d(r.complete);t=e?e.call(r,t):void 0}catch(t){try{y(n)}finally{throw t}}return y(n),t}}});var w=function(t){s(this,w,"Observable","_f")._f=f(t)};l(w.prototype,{subscribe:function(t){return new m(t,this._f)},forEach:function(t){var n=this;return new(o.Promise||i.Promise)(function(r,e){f(t);var i=n.subscribe({next:function(n){try{return t(n)}catch(t){e(t),i.unsubscribe()}},error:e,complete:r})})}}),l(w,{from:function(t){var n="function"==typeof this?this:w,r=d(a(t)[c]);if(r){var e=a(r.call(t));return e.constructor===n?e:new n(function(t){return e.subscribe(t)})}return new n(function(n){var r=!1;return u(function(){if(!r){try{if(v(t,!1,function(t){if(n.next(t),r)return p})===p)return}catch(t){if(r)throw t;return void n.error(t)}n.complete()}}),function(){r=!0}})},of:function(){for(var t=0,n=arguments.length,r=Array(n);t<n;)r[t]=arguments[t++];return new("function"==typeof this?this:w)(function(t){var n=!1;return u(function(){if(!n){for(var e=0;e<r.length;++e)if(t.next(r[e]),n)return;t.complete()}}),function(){n=!0}})}}),h(w.prototype,c,function(){return this}),e(e.G,{Observable:w}),r(74)("Observable")},function(t,n,r){var e=r(54),i=r(2),o=e.key,u=e.set;e.exp({defineMetadata:function(t,n,r,e){u(t,n,i(r),o(e))}})},function(t,n,r){var e=r(54),i=r(2),o=e.key,u=e.map,c=e.store;e.exp({deleteMetadata:function(t,n){var r=arguments.length<3?void 0:o(arguments[2]),e=u(i(n),r,!1);if(void 0===e||!e.delete(t))return!1;if(e.size)return!0;var f=c.get(n);return f.delete(r),!!f.size||c.delete(n)}})},function(t,n,r){var e=r(185),i=r(161),o=r(54),u=r(2),c=r(32),f=o.keys,a=o.key,s=function(t,n){var r=f(t,n),o=c(t);if(null===o)return r;var u=s(o,n);return u.length?r.length?i(new e(r.concat(u))):u:r};o.exp({getMetadataKeys:function(t){return s(u(t),arguments.length<2?void 0:a(arguments[1]))}})},function(t,n,r){var e=r(54),i=r(2),o=r(32),u=e.has,c=e.get,f=e.key,a=function(t,n,r){if(u(t,n,r))return c(t,n,r);var e=o(n);return null!==e?a(t,e,r):void 0};e.exp({getMetadata:function(t,n){return a(t,i(n),arguments.length<3?void 0:f(arguments[2]))}})},function(t,n,r){var e=r(54),i=r(2),o=e.keys,u=e.key;e.exp({getOwnMetadataKeys:function(t){
return o(i(t),arguments.length<2?void 0:u(arguments[1]))}})},function(t,n,r){var e=r(54),i=r(2),o=e.get,u=e.key;e.exp({getOwnMetadata:function(t,n){return o(t,i(n),arguments.length<3?void 0:u(arguments[2]))}})},function(t,n,r){var e=r(54),i=r(2),o=r(32),u=e.has,c=e.key,f=function(t,n,r){if(u(t,n,r))return!0;var e=o(n);return null!==e&&f(t,e,r)};e.exp({hasMetadata:function(t,n){return f(t,i(n),arguments.length<3?void 0:c(arguments[2]))}})},function(t,n,r){var e=r(54),i=r(2),o=e.has,u=e.key;e.exp({hasOwnMetadata:function(t,n){return o(t,i(n),arguments.length<3?void 0:u(arguments[2]))}})},function(t,n,r){var e=r(54),i=r(2),o=r(26),u=e.key,c=e.set;e.exp({metadata:function(t,n){return function(r,e){c(t,n,(void 0!==e?i:o)(r),u(e))}}})},function(t,n,r){var e=r(1);e(e.P+e.R,"Set",{toJSON:r(165)("Set")})},function(t,n,r){"use strict";var e=r(1),i=r(147)(!0);e(e.P,"String",{at:function(t){return i(this,t)}})},function(t,n,r){"use strict";var e=r(1),i=r(46),o=r(16),u=r(122),c=r(120),f=RegExp.prototype,a=function(t,n){this._r=t,this._s=n};r(139)(a,"RegExp String",function(){var t=this._r.exec(this._s);return{value:t,done:null===t}}),e(e.P,"String",{matchAll:function(t){if(i(this),!u(t))throw TypeError(t+" is not a regexp!");var n=String(this),r="flags"in f?String(t.flags):c.call(t),e=new RegExp(t.source,~r.indexOf("g")?r:"g"+r);return e.lastIndex=o(t.lastIndex),new a(e,n)}})},function(t,n,r){"use strict";var e=r(1),i=r(181);e(e.P,"String",{padEnd:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0,!1)}})},function(t,n,r){"use strict";var e=r(1),i=r(181);e(e.P,"String",{padStart:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0,!0)}})},function(t,n,r){"use strict";r(82)("trimLeft",function(t){return function(){return t(this,1)}},"trimStart")},function(t,n,r){"use strict";r(82)("trimRight",function(t){return function(){return t(this,2)}},"trimEnd")},function(t,n,r){r(153)("asyncIterator")},function(t,n,r){r(153)("observable")},function(t,n,r){var e=r(1);e(e.S,"System",{global:r(3)})},function(t,n,r){for(var e=r(155),i=r(28),o=r(3),u=r(27),c=r(80),f=r(7),a=f("iterator"),s=f("toStringTag"),l=c.Array,h=["NodeList","DOMTokenList","MediaList","StyleSheetList","CSSRuleList"],v=0;v<5;v++){var p,d=h[v],y=o[d],g=y&&y.prototype;if(g){g[a]||u(g,a,l),g[s]||u(g,s,d),c[d]=l;for(p in e)g[p]||i(g,p,e[p],!0)}}},function(t,n,r){var e=r(1),i=r(151);e(e.G+e.B,{setImmediate:i.set,clearImmediate:i.clear})},function(t,n,r){var e=r(3),i=r(1),o=r(121),u=r(207),c=e.navigator,f=!!c&&/MSIE .\./.test(c.userAgent),a=function(t){return f?function(n,r){return t(o(u,[].slice.call(arguments,2),"function"==typeof n?n:Function(n)),r)}:t};i(i.G+i.B+i.F*f,{setTimeout:a(e.setTimeout),setInterval:a(e.setInterval)})},function(t,n,r){r(330),r(269),r(271),r(270),r(273),r(275),r(280),r(274),r(272),r(282),r(281),r(277),r(278),r(276),r(268),r(279),r(283),r(284),r(236),r(238),r(237),r(286),r(285),r(256),r(266),r(267),r(257),r(258),r(259),r(260),r(261),r(262),r(263),r(264),r(265),r(239),r(240),r(241),r(242),r(243),r(244),r(245),r(246),r(247),r(248),r(249),r(250),r(251),r(252),r(253),r(254),r(255),r(317),r(322),r(329),r(320),r(312),r(313),r(318),r(323),r(325),r(308),r(309),r(310),r(311),r(314),r(315),r(316),r(319),r(321),r(324),r(326),r(327),r(328),r(231),r(233),r(232),r(235),r(234),r(220),r(218),r(224),r(221),r(227),r(229),r(217),r(223),r(214),r(228),r(212),r(226),r(225),r(219),r(222),r(211),r(213),r(216),r(215),r(230),r(155),r(302),r(307),r(184),r(303),r(304),r(305),r(306),r(287),r(183),r(185),r(186),r(342),r(331),r(332),r(337),r(340),r(341),r(335),r(338),r(336),r(339),r(333),r(334),r(288),r(289),r(290),r(291),r(292),r(295),r(293),r(294),r(296),r(297),r(298),r(299),r(301),r(300),r(343),r(369),r(372),r(371),r(373),r(374),r(370),r(375),r(376),r(354),r(357),r(353),r(351),r(352),r(355),r(356),r(346),r(368),r(377),r(345),r(347),r(349),r(348),r(350),r(359),r(360),r(362),r(361),r(364),r(363),r(365),r(366),r(367),r(344),r(358),r(380),r(379),r(378),t.exports=r(52)},function(t,n){function r(t,n){if("string"==typeof n)return t.insertAdjacentHTML("afterend",n);var r=t.nextSibling;return r?t.parentNode.insertBefore(n,r):t.parentNode.appendChild(n)}t.exports=r},,,,,,,,,function(t,n,r){(function(n,r){!function(n){"use strict";function e(t,n,r,e){var i=n&&n.prototype instanceof o?n:o,u=Object.create(i.prototype),c=new p(e||[]);return u._invoke=s(t,r,c),u}function i(t,n,r){try{return{type:"normal",arg:t.call(n,r)}}catch(t){return{type:"throw",arg:t}}}function o(){}function u(){}function c(){}function f(t){["next","throw","return"].forEach(function(n){t[n]=function(t){return this._invoke(n,t)}})}function a(t){function n(r,e,o,u){var c=i(t[r],t,e);if("throw"!==c.type){var f=c.arg,a=f.value;return a&&"object"==typeof a&&m.call(a,"__await")?Promise.resolve(a.__await).then(function(t){n("next",t,o,u)},function(t){n("throw",t,o,u)}):Promise.resolve(a).then(function(t){f.value=t,o(f)},u)}u(c.arg)}function e(t,r){function e(){return new Promise(function(e,i){n(t,r,e,i)})}return o=o?o.then(e,e):e()}"object"==typeof r&&r.domain&&(n=r.domain.bind(n));var o;this._invoke=e}function s(t,n,r){var e=P;return function(o,u){if(e===F)throw new Error("Generator is already running");if(e===M){if("throw"===o)throw u;return y()}for(r.method=o,r.arg=u;;){var c=r.delegate;if(c){var f=l(c,r);if(f){if(f===A)continue;return f}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(e===P)throw e=M,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);e=F;var a=i(t,n,r);if("normal"===a.type){if(e=r.done?M:j,a.arg===A)continue;return{value:a.arg,done:r.done}}"throw"===a.type&&(e=M,r.method="throw",r.arg=a.arg)}}}function l(t,n){var r=t.iterator[n.method];if(r===g){if(n.delegate=null,"throw"===n.method){if(t.iterator.return&&(n.method="return",n.arg=g,l(t,n),"throw"===n.method))return A;n.method="throw",n.arg=new TypeError("The iterator does not provide a 'throw' method")}return A}var e=i(r,t.iterator,n.arg);if("throw"===e.type)return n.method="throw",n.arg=e.arg,n.delegate=null,A;var o=e.arg;return o?o.done?(n[t.resultName]=o.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=g),n.delegate=null,A):o:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,A)}function h(t){var n={tryLoc:t[0]};1 in t&&(n.catchLoc=t[1]),2 in t&&(n.finallyLoc=t[2],n.afterLoc=t[3]),this.tryEntries.push(n)}function v(t){var n=t.completion||{};n.type="normal",delete n.arg,t.completion=n}function p(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(h,this),this.reset(!0)}function d(t){if(t){var n=t[w];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var r=-1,e=function n(){for(;++r<t.length;)if(m.call(t,r))return n.value=t[r],n.done=!1,n;return n.value=g,n.done=!0,n};return e.next=e}}return{next:y}}function y(){return{value:g,done:!0}}var g,b=Object.prototype,m=b.hasOwnProperty,x="function"==typeof Symbol?Symbol:{},w=x.iterator||"@@iterator",S=x.asyncIterator||"@@asyncIterator",_=x.toStringTag||"@@toStringTag",O="object"==typeof t,E=n.regeneratorRuntime;if(E)return void(O&&(t.exports=E));E=n.regeneratorRuntime=O?t.exports:{},E.wrap=e;var P="suspendedStart",j="suspendedYield",F="executing",M="completed",A={},N={};N[w]=function(){return this};var T=Object.getPrototypeOf,I=T&&T(T(d([])));I&&I!==b&&m.call(I,w)&&(N=I);var k=c.prototype=o.prototype=Object.create(N);u.prototype=k.constructor=c,c.constructor=u,c[_]=u.displayName="GeneratorFunction",E.isGeneratorFunction=function(t){var n="function"==typeof t&&t.constructor;return!!n&&(n===u||"GeneratorFunction"===(n.displayName||n.name))},E.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,c):(t.__proto__=c,_ in t||(t[_]="GeneratorFunction")),t.prototype=Object.create(k),t},E.awrap=function(t){return{__await:t}},f(a.prototype),a.prototype[S]=function(){return this},E.AsyncIterator=a,E.async=function(t,n,r,i){var o=new a(e(t,n,r,i));return E.isGeneratorFunction(n)?o:o.next().then(function(t){return t.done?t.value:o.next()})},f(k),k[_]="Generator",k.toString=function(){return"[object Generator]"},E.keys=function(t){var n=[];for(var r in t)n.push(r);return n.reverse(),function r(){for(;n.length;){var e=n.pop();if(e in t)return r.value=e,r.done=!1,r}return r.done=!0,r}},E.values=d,p.prototype={constructor:p,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=g,this.done=!1,this.delegate=null,this.method="next",this.arg=g,this.tryEntries.forEach(v),!t)for(var n in this)"t"===n.charAt(0)&&m.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=g)},stop:function(){this.done=!0;var t=this.tryEntries[0],n=t.completion;if("throw"===n.type)throw n.arg;return this.rval},dispatchException:function(t){function n(n,e){return o.type="throw",o.arg=t,r.next=n,e&&(r.method="next",r.arg=g),!!e}if(this.done)throw t;for(var r=this,e=this.tryEntries.length-1;e>=0;--e){var i=this.tryEntries[e],o=i.completion;if("root"===i.tryLoc)return n("end");if(i.tryLoc<=this.prev){var u=m.call(i,"catchLoc"),c=m.call(i,"finallyLoc");if(u&&c){if(this.prev<i.catchLoc)return n(i.catchLoc,!0);if(this.prev<i.finallyLoc)return n(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return n(i.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return n(i.finallyLoc)}}}},abrupt:function(t,n){for(var r=this.tryEntries.length-1;r>=0;--r){var e=this.tryEntries[r];if(e.tryLoc<=this.prev&&m.call(e,"finallyLoc")&&this.prev<e.finallyLoc){var i=e;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=n&&n<=i.finallyLoc&&(i=null);var o=i?i.completion:{};return o.type=t,o.arg=n,i?(this.method="next",this.next=i.finallyLoc,A):this.complete(o)},complete:function(t,n){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&n&&(this.next=n),A},finish:function(t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),v(r),A}},catch:function(t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc===t){var e=r.completion;if("throw"===e.type){var i=e.arg;v(r)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:d(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=g),A}}}("object"==typeof n?n:"object"==typeof window?window:"object"==typeof self?self:this)}).call(n,function(){return this}(),r(158))}])</script><script src="/./main.0cf68a.js"></script><script>!function(){!function(e){var t=document.createElement("script");document.getElementsByTagName("body")[0].appendChild(t),t.setAttribute("src",e)}("/slider.e37972.js")}()</script>


<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


    
<div class="tools-col" q-class="show:isShow,hide:isShow|isFalse" q-on="click:stop(e)">
  <div class="tools-nav header-menu">
    
    
      
      
      
    
      
      
      
    
      
      
      
    
    

    <ul style="width: 70%">
    
    
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'innerArchive')"><a href="javascript:void(0)" q-class="active:innerArchive">所有文章</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'friends')"><a href="javascript:void(0)" q-class="active:friends">友链</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'aboutme')"><a href="javascript:void(0)" q-class="active:aboutme">关于我</a></li>
      
        
    </ul>
  </div>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all" q-show="innerArchive">
        <div class="search-wrap">
          <input class="search-ipt" q-model="search" type="text" placeholder="find something…">
          <i class="icon-search icon" q-show="search|isEmptyStr"></i>
          <i class="icon-close icon" q-show="search|isNotEmptyStr" q-on="click:clearChose(e)"></i>
        </div>
        <div class="widget tagcloud search-tag">
          <p class="search-tag-wording">tag:</p>
          <label class="search-switch">
            <input type="checkbox" q-on="click:toggleTag(e)" q-attr="checked:showTags">
          </label>
          <ul class="article-tag-list" q-show="showTags">
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">http</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">learn</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">java</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">mysql</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">docker</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">Hexo</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">read</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">linux</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">数据库</a>
              </li>
            
            <div class="clearfix"></div>
          </ul>
        </div>
        <ul class="search-ul">
          <p q-show="jsonFail" style="padding: 20px; font-size: 12px;">
            缺失模块。<br/>1、请确保node版本大于6.2<br/>2、在博客根目录（注意不是yilia根目录）执行以下命令：<br/> npm i hexo-generator-json-content --save<br/><br/>
            3、在根目录_config.yml里添加配置：
<pre style="font-size: 12px;" q-show="jsonFail">
  jsonContent:
    meta: false
    pages: false
    posts:
      title: true
      date: true
      path: true
      text: false
      raw: false
      content: false
      slug: false
      updated: false
      comments: false
      link: false
      permalink: false
      excerpt: false
      categories: false
      tags: true
</pre>
          </p>
          <li class="search-li" q-repeat="items" q-show="isShow">
            <a q-attr="href:path|urlformat" class="search-title"><i class="icon-quo-left icon"></i><span q-text="title"></span></a>
            <p class="search-time">
              <i class="icon-calendar icon"></i>
              <span q-text="date|dateformat"></span>
            </p>
            <p class="search-tag">
              <i class="icon-price-tags icon"></i>
              <span q-repeat="tags" q-on="click:choseTag(e, name)" q-text="name|tagformat"></span>
            </p>
          </li>
        </ul>
    	</section>
    

    
    	<section class="tools-section tools-section-friends" q-show="friends">
  		
        <ul class="search-ul">
          
            <li class="search-li">
              <a href="http://wallquick.vip" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>墙快</a>
            </li>
          
            <li class="search-li">
              <a href="https://www.murphyyi.com" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>墨菲主页</a>
            </li>
          
        </ul>
  		
    	</section>
    

    
    	<section class="tools-section tools-section-me" q-show="aboutme">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">很惭愧&lt;br&gt;&lt;br&gt;只做了一点微小的工作&lt;br&gt;谢谢大家</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>