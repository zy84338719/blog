<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <link rel="dns-prefetch" href="http://zy84338719.github.io/blog">
  <title>Murphy Yi site</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="学习总结">
<meta property="og:type" content="website">
<meta property="og:title" content="Murphy Yi site">
<meta property="og:url" content="http://zy84338719.github.io/blog/page/3/index.html">
<meta property="og:site_name" content="Murphy Yi site">
<meta property="og:description" content="学习总结">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Murphy Yi">
<meta name="twitter:card" content="summary">
  
    <link rel="alternative" href="/atom.xml" title="Murphy Yi site" type="application/atom+xml">
  
  
    <link rel="icon" href="img/favicon.png">
  
  <link rel="stylesheet" type="text/css" href="/./main.0cf68a.css">
  <style type="text/css">
  
    #container.show {
      background: linear-gradient(200deg,#a0cfe4,#e8c37e);
    }
  </style>
  

  
<script>
var _hmt = _hmt || [];
(function() {
	var hm = document.createElement("script");
	hm.src = "https://hm.baidu.com/hm.js?910a5dff7e42c4e5203432203dc26436";
	var s = document.getElementsByTagName("script")[0]; 
	s.parentNode.insertBefore(hm, s);
})();
</script>


<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container" q-class="show:isCtnShow">
    <canvas id="anm-canvas" class="anm-canvas"></canvas>
    <div class="left-col" q-class="show:isShow">
      
<div class="overlay" style="background: #4d4d4d"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img src="img/head.png" class="js-avatar">
		</a>
		<hgroup>
		  <h1 class="header-author"><a href="/"></a></h1>
		</hgroup>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
				<li><a href="/archives/">归档</a></li>
	        
				<li><a target="_blank" rel="noopener" href="https://cv.murphyyi.com">个人主页</a></li>
	        
				<li><a target="_blank" rel="noopener" href="https://www.yuque.com/murphyyi/blog/">语雀</a></li>
	        
				<li><a target="_blank" rel="noopener" href="https://ework.murphyyi.com">导航</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
    		
    			
    			<a q-on="click: openSlider(e, 'innerArchive')" href="javascript:void(0)">所有文章</a>
    			
            
    			
    			<a q-on="click: openSlider(e, 'friends')" href="javascript:void(0)">友链</a>
    			
            
    			
    			<a q-on="click: openSlider(e, 'aboutme')" href="javascript:void(0)">关于我</a>
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="https://github.com/zy84338719" title="github"><i class="icon-github"></i></a>
		        
					<a class="jianshu" target="_blank" href="https://www.jianshu.com/u/872f0bfc7a2b" title="jianshu"><i class="icon-jianshu"></i></a>
		        
					<a class="mail" target="_blank" href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=SzEyc394eHN8enILPSI7ZTo6ZSgkJg" title="mail"><i class="icon-mail"></i></a>
		        
					<a class="rss" target="_blank" href="/atom.xml" title="rss"><i class="icon-rss"></i></a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col" q-class="show:isShow,hide:isShow|isFalse">
      
<nav id="mobile-nav">
  	<div class="overlay js-overlay" style="background: #4d4d4d"></div>
	<div class="btnctn js-mobile-btnctn">
  		<div class="slider-trigger list" q-on="click: openSlider(e)"><i class="icon icon-sort"></i></div>
	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img src="img/head.png" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author js-header-author"></h1>
			</hgroup>
			
			
			
				
			
				
			
				
			
				
			
				
			
			
			
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/zy84338719" title="github"><i class="icon-github"></i></a>
			        
						<a class="jianshu" target="_blank" href="https://www.jianshu.com/u/872f0bfc7a2b" title="jianshu"><i class="icon-jianshu"></i></a>
			        
						<a class="mail" target="_blank" href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=SzEyc394eHN8enILPSI7ZTo6ZSgkJg" title="mail"><i class="icon-mail"></i></a>
			        
						<a class="rss" target="_blank" href="/atom.xml" title="rss"><i class="icon-rss"></i></a>
			        
				</div>
			</nav>

			<nav class="header-menu js-header-menu">
				<ul style="width: 70%">
				
				
					<li style="width: 20%"><a href="/">主页</a></li>
		        
					<li style="width: 20%"><a href="/archives/">归档</a></li>
		        
					<li style="width: 20%"><a target="_blank" rel="noopener" href="https://cv.murphyyi.com">个人主页</a></li>
		        
					<li style="width: 20%"><a target="_blank" rel="noopener" href="https://www.yuque.com/murphyyi/blog/">语雀</a></li>
		        
					<li style="width: 20%"><a target="_blank" rel="noopener" href="https://ework.murphyyi.com">导航</a></li>
		        
				</ul>
			</nav>
		</header>				
	</div>
	<div class="mobile-mask" style="display:none" q-show="isShow"></div>
</nav>

      <div id="wrapper" class="body-wrap">
        <div class="menu-l">
          <div class="canvas-wrap">
            <canvas data-colors="#eaeaea" data-sectionHeight="100" data-contentId="js-content" id="myCanvas1" class="anm-canvas"></canvas>
          </div>
          <div id="js-content" class="content-ll">
            
  
    <article id="post-yuque/短服务" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/05/11/yuque/%E7%9F%AD%E6%9C%8D%E5%8A%A1/">短服务</a>
    </h1>
  

        
        <a href="/2021/05/11/yuque/%E7%9F%AD%E6%9C%8D%E5%8A%A1/" class="archive-article-date">
  	<time datetime="2021-05-11T16:37:25.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2021-05-11</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="如何实现一个短链接服务"><a href="#如何实现一个短链接服务" class="headerlink" title="如何实现一个短链接服务"></a>如何实现一个短链接服务</h1><p>短链接，通俗来说，就是将长的 URL 网址，通过程序计算等方式，转换为简短的网址字符串。<br>大家经常会收到一些莫名的营销短信，里面有一个非常短的链接让你跳转。新浪微博因为限制字数，所以也会经常见到这种看着不像网址的网址。短链的兴起应该就是微博限制字数激起了大家的创造力。<br>如果创建一个短链系统，我们应该做什么呢？</p>
<ol>
<li>将长链接变为短链；</li>
<li>用户访问短链接，会跳转到正确的长链接上去。</li>
</ol>
<p>查找到对应的长网址，并跳转到对应的页面。</p>
<h2 id="短链生成方法"><a href="#短链生成方法" class="headerlink" title="短链生成方法"></a>短链生成方法</h2><p>短码一般是由[a - z, A - Z, 0 - 9]这 62 个字母或数字组成，短码的长度也可以自定义，但一般不超过 8 位。比较常用的都是 6 位，6 位的短码已经能有 568 亿种的组合：(26+26+10)^6 = 56800235584，已满足绝大多数的使用场景。<br>目前比较流行的生成短码方法有：自增 id、摘要算法、普通随机数。</p>
<h3 id="自增-id"><a href="#自增-id" class="headerlink" title="自增 id"></a>自增 id</h3><p>该方法是一种无碰撞的方法，原理是，每新增一个短码，就在上次添加的短码 id 基础上加 1，然后将这个 10 进制的 id 值，转化成一个 62 进制的字符串。<br>一般利用数据表中的自增 id 来完成：每次先查询数据表中的自增 id 最大值 max，那么需要插入的长网址对应自增 id 值就是 max+1，将 max+1 转成 62 进制即可得到短码。<br>但是短码 id 是从一位长度开始递增，短码的长度不固定，不过可以用 id 从指定的数字开始递增的方式来处理，确保所有的短码长度都一致。同时，生成的短码是有序的，可能会有安全的问题，可以将生成的短码 id，结合长网址等其他关键字，进行 md5 运算生成最后的短码。</p>
<h3 id="摘要算法"><a href="#摘要算法" class="headerlink" title="摘要算法"></a>摘要算法</h3><p>摘要算法又称哈希算法，它表示输入任意长度的数据，输出固定长度的数据。相同的输入数据始终得到相同的输出，不同的输入数据尽量得到不同的输出。<br>算法过程：</p>
<ol>
<li>将长网址 md5 生成 32 位签名串,分为 4 段, 每段 8 个字节；</li>
<li>对这四段循环处理, 取 8 个字节, 将他看成 16 进制串与 0x3fffffff(30 位 1)与操作, 即超过 30 位的忽略处理；</li>
<li>这 30 位分成 6 段, 每 5 位的数字作为字母表的索引取得特定字符, 依次进行获得 6 位字符串；</li>
<li>总的 md5 串可以获得 4 个 6 位串；取里面的任意一个就可作为这个长 url 的短 url 地址；</li>
</ol>
<p>这种算法,虽然会生成 4 个,但是仍然存在重复几率。<br>虽然几率很小，但是该方法依然存在碰撞的可能性，解决冲突会比较麻烦。不过该方法生成的短码位数是固定的，也不存在连续生成的短码有序的情况。</p>
<h3 id="普通随机数"><a href="#普通随机数" class="headerlink" title="普通随机数"></a>普通随机数</h3><p>该方法是从 62 个字符串中随机取出一个 6 位短码的组合，然后去数据库中查询该短码是否已存在。如果已存在，就继续循环该方法重新获取短码，否则就直接返回。<br>该方法是最简单的一种实现，不过由于 Math.round()方法生成的随机数属于伪随机数，碰撞的可能性也不小。在数据比较多的情况下，可能会循环很多次，才能生成一个不冲突的短码。</p>
<h2 id="算法分析"><a href="#算法分析" class="headerlink" title="算法分析"></a>算法分析</h2><p>以上算法利弊我们一个一个来分析。<br>如果使用自增 id 算法，会有一个问题就是不法分子是可以穷举你的短链地址的。原理就是将 10 进制数字转为 62 进制，那么别人也可以使用相同的方式遍历你的短链获取对应的原始链接。打个比方说：<a target="_blank" rel="noopener" href="http://tinyurl.com/a3300%E5%92%8C">http://tinyurl.com/a3300 和</a><a target="_blank" rel="noopener" href="http://bit.ly/a3300%EF%BC%8C%E8%BF%99%E4%B8%A4%E4%B8%AA%E7%9F%AD%E9%93%BE%E7%BD%91%E7%AB%99%EF%BC%8C%E5%88%86%E5%88%AB%E4%BB%8Ea3300">http://bit.ly/a3300，这两个短链网站，分别从 a3300</a>- a3399，能够试出来多次返回正确的 url。所以这种方式生成的短链对于使用者来说其实是不安全的。<br>摘要算法，其实就是 hash 算法吧，一说 hash 大家可能觉得很 low，但是事实上 hash 可能是最优解。比如：<a target="_blank" rel="noopener" href="http://www.sina.lt/">http://www.sina.lt/</a>和<a target="_blank" rel="noopener" href="http://mrw.so/">http://mrw.so/</a>连续生成的 url 发现并没有规律，很有可能就是使用 hash 算法来实现。<br>普通随机数算法，这种算法生成的东西和摘要算法一样，但是碰撞的概率会大一些。因为摘要算法毕竟是对 url 进行 hash 生成，随机数算法就是简单的随机生成，数量一旦上来必然会导致重复。<br>综合以上，我选择最 low 的算法：摘要算法。<br>​</p>
<p>​</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;crypto/md5&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/spaolacci/murmur3&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Hash</span><span class="params">(data []<span class="keyword">byte</span>)</span> <span class="title">uint64</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> murmur3.Sum64(data)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Hash32</span><span class="params">(data []<span class="keyword">byte</span>)</span> <span class="title">uint32</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> murmur3.Sum32(data)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(Short)</span> <span class="title">getShortUrl</span><span class="params">(key, url <span class="keyword">string</span>,ct <span class="keyword">int</span>/*冲突标记*/)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	<span class="comment">//加密字符传前的混合 KEY</span></span><br><span class="line">	<span class="comment">// 要使用生成 URL 的字符</span></span><br><span class="line">	<span class="comment">// 对传入网址进行 MMH3 加密</span></span><br><span class="line">    hash32 := Hash32([]<span class="keyword">byte</span>(key + url))</span><br><span class="line">    <span class="keyword">if</span> ct !=<span class="number">0</span>&#123;</span><br><span class="line">        hash32 = Hash32([]<span class="keyword">byte</span>(key + url+<span class="keyword">string</span>(i)))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 把加密字符按照 8 位一组 16 进制与 0x3FFFFFFF 进行位与运算</span></span><br><span class="line">	lHexLong := <span class="number">0x3FFFFFFF</span> &amp; hash32</span><br><span class="line">	outChars := <span class="string">&quot;&quot;</span></span><br><span class="line">	<span class="comment">//循环获得每组6位的字符串</span></span><br><span class="line">	<span class="keyword">for</span> j := <span class="number">0</span>; j &lt; <span class="number">6</span>; j++ &#123;</span><br><span class="line">		<span class="comment">// 把得到的值与 0x0000003E 这是62 进行mod运算，取得字符数组 chars 索引(具体需要看chars数组的长度   以防下标溢出，注意起点为0)</span></span><br><span class="line">		index := lHexLong % <span class="number">0x0000003E</span></span><br><span class="line">		<span class="comment">// 把取得的字符相加</span></span><br><span class="line">		outChars += model.Chars[index]</span><br><span class="line">		<span class="comment">// 每次循环按位右移 5 位</span></span><br><span class="line">		lHexLong = lHexLong &gt;&gt; <span class="number">5</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 把字符串存入对应索引的输出数组</span></span><br><span class="line">	<span class="keyword">return</span> outChars + CreateShortExtra()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这块可以做分库分表设计</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CreateShortExtra</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	x := (getDays() / <span class="number">62</span>) % <span class="number">62</span></span><br><span class="line">	y := getDays() % <span class="number">62</span></span><br><span class="line">	<span class="keyword">return</span> Chars[x] + Chars[y]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getDays</span><span class="params">()</span> <span class="title">int64</span></span> &#123;</span><br><span class="line">	yearMonthDay := time.Date(<span class="number">2021</span>, <span class="number">01</span>, <span class="number">01</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, time.Local)</span><br><span class="line">	<span class="keyword">return</span> (time.Now().Unix() - yearMonthDay.Unix()) / <span class="number">3600</span> / <span class="number">24</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> Chars = []<span class="keyword">string</span>&#123;<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;d&quot;</span>, <span class="string">&quot;e&quot;</span>, <span class="string">&quot;f&quot;</span>, <span class="string">&quot;g&quot;</span>, <span class="string">&quot;h&quot;</span>,</span><br><span class="line">	<span class="string">&quot;i&quot;</span>, <span class="string">&quot;j&quot;</span>, <span class="string">&quot;k&quot;</span>, <span class="string">&quot;l&quot;</span>, <span class="string">&quot;m&quot;</span>, <span class="string">&quot;n&quot;</span>, <span class="string">&quot;o&quot;</span>, <span class="string">&quot;p&quot;</span>, <span class="string">&quot;q&quot;</span>, <span class="string">&quot;r&quot;</span>, <span class="string">&quot;s&quot;</span>, <span class="string">&quot;t&quot;</span>,</span><br><span class="line">	<span class="string">&quot;u&quot;</span>, <span class="string">&quot;v&quot;</span>, <span class="string">&quot;w&quot;</span>, <span class="string">&quot;x&quot;</span>, <span class="string">&quot;y&quot;</span>, <span class="string">&quot;z&quot;</span>, <span class="string">&quot;0&quot;</span>, <span class="string">&quot;1&quot;</span>, <span class="string">&quot;2&quot;</span>, <span class="string">&quot;3&quot;</span>, <span class="string">&quot;4&quot;</span>, <span class="string">&quot;5&quot;</span>,</span><br><span class="line">	<span class="string">&quot;6&quot;</span>, <span class="string">&quot;7&quot;</span>, <span class="string">&quot;8&quot;</span>, <span class="string">&quot;9&quot;</span>, <span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;D&quot;</span>, <span class="string">&quot;E&quot;</span>, <span class="string">&quot;F&quot;</span>, <span class="string">&quot;G&quot;</span>, <span class="string">&quot;H&quot;</span>,</span><br><span class="line">	<span class="string">&quot;I&quot;</span>, <span class="string">&quot;J&quot;</span>, <span class="string">&quot;K&quot;</span>, <span class="string">&quot;L&quot;</span>, <span class="string">&quot;M&quot;</span>, <span class="string">&quot;N&quot;</span>, <span class="string">&quot;O&quot;</span>, <span class="string">&quot;P&quot;</span>, <span class="string">&quot;Q&quot;</span>, <span class="string">&quot;R&quot;</span>, <span class="string">&quot;S&quot;</span>, <span class="string">&quot;T&quot;</span>,</span><br><span class="line">	<span class="string">&quot;U&quot;</span>, <span class="string">&quot;V&quot;</span>, <span class="string">&quot;W&quot;</span>, <span class="string">&quot;X&quot;</span>, <span class="string">&quot;Y&quot;</span>, <span class="string">&quot;Z&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<h2 id="是否有分库分表的需要？"><a href="#是否有分库分表的需要？" class="headerlink" title="是否有分库分表的需要？"></a>是否有分库分表的需要？</h2><p>对于单条数据 10b 以内，一亿条数据总容量大约为 953G，单表肯定无法撑住这么大的量，所以有分表的需要，如果你对服务很有信心 2 年内能达到这个规模，那么你可以从一开始设计就考虑分表的方案。<br>那么如何定义分表的规则呢？<br>如果按照单表 500 万条记录来算，总计可以分为 20 张表，那么单表容量就是 47G，还是挺大，所以考虑分表的 key 和单表容量，如果分为 100 张表那么单表容量就是 10G，并且通过数字后缀路由到表中也比较容易。可以对 short_code 做 encoding 编码生成数字类型然后做路由。<br>​</p>
<h2 id="高并发？"><a href="#高并发？" class="headerlink" title="高并发？"></a>高并发？</h2><p>需要考虑 缓存击穿的默认页面问题。</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2021/05/11/yuque/%E7%9F%AD%E6%9C%8D%E5%8A%A1/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-yuque/命令行的艺术(转载)" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/04/28/yuque/%E5%91%BD%E4%BB%A4%E8%A1%8C%E7%9A%84%E8%89%BA%E6%9C%AF(%E8%BD%AC%E8%BD%BD)/">命令行的艺术(转载)</a>
    </h1>
  

        
        <a href="/2021/04/28/yuque/%E5%91%BD%E4%BB%A4%E8%A1%8C%E7%9A%84%E8%89%BA%E6%9C%AF(%E8%BD%AC%E8%BD%BD)/" class="archive-article-date">
  	<time datetime="2021-04-28T18:06:43.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2021-04-28</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="https://badges.gitter.im/Join%20Chat.svg#id=PYcfN&originHeight=20&originWidth=99&originalType=binary&status=done&style=none"></p>
<ul>
<li><a href="#%E5%89%8D%E8%A8%80">前言</a></li>
<li><a href="#%E5%9F%BA%E7%A1%80">基础</a></li>
<li><a href="#%E6%97%A5%E5%B8%B8%E4%BD%BF%E7%94%A8">日常使用</a></li>
<li><a href="#%E6%96%87%E4%BB%B6%E5%8F%8A%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86">文件及数据处理</a></li>
<li><a href="#%E7%B3%BB%E7%BB%9F%E8%B0%83%E8%AF%95">系统调试</a></li>
<li><a href="#%E5%8D%95%E8%A1%8C%E8%84%9A%E6%9C%AC">单行脚本</a></li>
<li><a href="#%E5%86%B7%E9%97%A8%E4%BD%86%E6%9C%89%E7%94%A8">冷门但有用</a></li>
<li><a href="#%E4%BB%85%E9%99%90-os-x-%E7%B3%BB%E7%BB%9F">仅限 OS X 系统</a></li>
<li><a href="#%E4%BB%85%E9%99%90-windows-%E7%B3%BB%E7%BB%9F">仅限 Windows 系统</a></li>
<li><a href="#%E6%9B%B4%E5%A4%9A%E8%B5%84%E6%BA%90">更多资源</a></li>
<li><a href="#%E5%85%8D%E8%B4%A3%E5%A3%B0%E6%98%8E">免责声明</a></li>
</ul>
<p>熟练使用命令行是一种常常被忽视，或被认为难以掌握的技能，但实际上，它会提高你作为工程师的灵活性以及生产力。本文是一份我在 Linux 上工作时，发现的一些命令行使用技巧的摘要。有些技巧非常基础，而另一些则相当复杂，甚至晦涩难懂。这篇文章并不长，但当你能够熟练掌握这里列出的所有技巧时，你就学会了很多关于命令行的东西了。</p>
<p>这篇文章是<a href="AUTHORS.md">许多作者和译者</a>共同的成果。</p>
<p>这里的部分内容</p>
<p><a target="_blank" rel="noopener" href="http://www.quora.com/What-are-some-lesser-known-but-useful-Unix-commands">首次</a></p>
<p><a target="_blank" rel="noopener" href="http://www.quora.com/What-are-the-most-useful-Swiss-army-knife-one-liners-on-Unix">出现</a></p>
<p>于 <a target="_blank" rel="noopener" href="http://www.quora.com/What-are-some-time-saving-tips-that-every-Linux-user-should-know">Quora</a>，</p>
<p>但已经迁移到了 Github，并由众多高手做出了许多改进。</p>
<p>如果你在本文中发现了错误或者存在可以改善的地方，请<a href="/CONTRIBUTING.md"><strong>贡献你的一份力量</strong></a>。</p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>涵盖范围：</p>
<ul>
<li>这篇文章不仅能帮助刚接触命令行的新手，而且对具有经验的人也大有裨益。本文致力于做到<em>覆盖面广</em>（涉及所有重要的内容），_具体_（给出具体的最常用的例子），以及<em>简洁</em>（避免冗余的内容，或是可以在其他地方轻松查到的细枝末节）。在特定应用场景下，本文的内容属于基本功或者能帮助您节约大量的时间。</li>
<li>本文主要为 Linux 所写，但在<a href="#%E4%BB%85%E9%99%90-os-x-%E7%B3%BB%E7%BB%9F">仅限 OS X 系统</a>章节和<a href="#%E4%BB%85%E9%99%90-windows-%E7%B3%BB%E7%BB%9F">仅限 Windows 系统</a>章节中也包含有对应操作系统的内容。除去这两个章节外，其它的内容大部分均可在其他类 Unix 系统或 OS X，甚至 Cygwin 中得到应用。</li>
<li>本文主要关注于交互式 Bash，但也有很多技巧可以应用于其他 shell 和 Bash 脚本当中。</li>
<li>除去“标准的”Unix 命令，本文还包括了一些依赖于特定软件包的命令（前提是它们具有足够的价值）。</li>
</ul>
<p>注意事项：</p>
<ul>
<li>为了能在一页内展示尽量多的东西，一些具体的信息可以在引用的页面中找到。我们相信机智的你知道如何使用 Google 或者其他搜索引擎来查阅到更多的详细信息。文中部分命令需要您使用 <code>apt-get</code>，<code>yum</code>，<code>dnf</code>，<code>pacman</code>，</li>
</ul>
<p><code>pip</code> 或 <code>brew</code>（以及其它合适的包管理器）来安装依赖的程序。</p>
<ul>
<li>遇到问题的话，请尝试使用 <a target="_blank" rel="noopener" href="http://explainshell.com/">Explainshell</a> 去获取相关命令、参数、管道等内容的解释。</li>
</ul>
<h2 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h2><ul>
<li>学习 Bash 的基础知识。具体地，在命令行中输入 <code>man bash</code> 并至少全文浏览一遍; 它理解起来很简单并且不冗长。其他的 shell 可能很好用，但 Bash 的功能已经足够强大并且到几乎总是可用的（ 如果你<em>只</em>学习 zsh，fish 或其他的 shell 的话，在你自己的设备上会显得很方便，但过度依赖这些功能会给您带来不便，例如当你需要在服务器上工作时）。</li>
<li>熟悉至少一个基于文本的编辑器。通常而言 Vim （<code>vi</code>） 会是你最好的选择，毕竟在终端中编辑文本时 Vim 是最好用的工具（甚至大部分情况下 Vim 要比 Emacs、大型 IDE 或是炫酷的编辑器更好用）。</li>
<li>学会如何使用 <code>man</code> 命令去阅读文档。学会使用 <code>apropos</code> 去查找文档。知道有些命令并不对应可执行文件，而是在 Bash 内置好的，此时可以使用 <code>help</code> 和 <code>help -d</code> 命令获取帮助信息。你可以用 <code>type 命令</code> 来判断这个命令到底是可执行文件、shell 内置命令还是别名。</li>
<li>学会使用 <code>&gt;</code> 和 <code>&lt;</code> 来重定向输出和输入，学会使用 <code>|</code> 来重定向管道。明白 <code>&gt;</code> 会覆盖了输出文件而 <code>&gt;&gt;</code> 是在文件末添加。了解标准输出 stdout 和标准错误 stderr。</li>
<li>学会使用通配符 <code>*</code> （或许再算上 <code>?</code> 和 <code>[</code>…<code>]</code>） 和引用以及引用中 <code>&#39;</code> 和 <code>&quot;</code> 的区别（后文中有一些具体的例子）。</li>
<li>熟悉 Bash 中的任务管理工具：<code>&amp;</code>，<strong>ctrl-z</strong>，<strong>ctrl-c</strong>，<code>jobs</code>，<code>fg</code>，<code>bg</code>，<code>kill</code> 等。</li>
<li>学会使用 <code>ssh</code> 进行远程命令行登录，最好知道如何使用 <code>ssh-agent</code>，<code>ssh-add</code> 等命令来实现基础的无密码认证登录。</li>
<li>学会基本的文件管理工具：<code>ls</code> 和 <code>ls -l</code> （了解 <code>ls -l</code> 中每一列代表的意义），<code>less</code>，<code>head</code>，<code>tail</code> 和 <code>tail -f</code> （甚至 <code>less +F</code>），<code>ln</code> 和 <code>ln -s</code> （了解硬链接与软链接的区别），<code>chown</code>，<code>chmod</code>，<code>du</code> （硬盘使用情况概述：<code>du -hs *</code>）。 关于文件系统的管理，学习 <code>df</code>，<code>mount</code>，<code>fdisk</code>，<code>mkfs</code>，<code>lsblk</code>。知道 inode 是什么（与 <code>ls -i</code> 和 <code>df -i</code> 等命令相关）。</li>
<li>学习基本的网络管理工具：<code>ip</code> 或 <code>ifconfig</code>，<code>dig</code>。</li>
<li>学习并使用一种版本控制管理系统，例如 <code>git</code>。</li>
<li>熟悉正则表达式，学会使用 <code>grep</code>／<code>egrep</code>，它们的参数中 <code>-i</code>，<code>-o</code>，<code>-v</code>，<code>-A</code>，<code>-B</code> 和 <code>-C</code> 这些是很常用并值得认真学习的。</li>
<li>学会使用 <code>apt-get</code>，<code>yum</code>，<code>dnf</code> 或 <code>pacman</code> （具体使用哪个取决于你使用的 Linux 发行版）来查找和安装软件包。并确保你的环境中有 <code>pip</code> 来安装基于 Python 的命令行工具 （接下来提到的部分程序使用 <code>pip</code> 来安装会很方便）。</li>
</ul>
<h2 id="日常使用"><a href="#日常使用" class="headerlink" title="日常使用"></a>日常使用</h2><ul>
<li>在 Bash 中，可以通过按 <strong>Tab</strong> 键实现自动补全参数，使用 <strong>ctrl-r</strong> 搜索命令行历史记录（按下按键之后，输入关键字便可以搜索，重复按下 <strong>ctrl-r</strong> 会向后查找匹配项，按下 <strong>Enter</strong> 键会执行当前匹配的命令，而按下右方向键会将匹配项放入当前行中，不会直接执行，以便做出修改）。</li>
<li>在 Bash 中，可以按下 <strong>ctrl-w</strong> 删除你键入的最后一个单词，<strong>ctrl-u</strong> 可以删除行内光标所在位置之前的内容，<strong>alt-b</strong> 和 <strong>alt-f</strong> 可以以单词为单位移动光标，<strong>ctrl-a</strong> 可以将光标移至行首，<strong>ctrl-e</strong> 可以将光标移至行尾，<strong>ctrl-k</strong> 可以删除光标至行尾的所有内容，<strong>ctrl-l</strong> 可以清屏。键入 <code>man readline</code> 可以查看 Bash 中的默认快捷键。内容有很多，例如 <strong>alt-.</strong> 循环地移向前一个参数，而 <strong>alt-*</strong> 可以展开通配符。</li>
<li>你喜欢的话，可以执行 <code>set -o vi</code> 来使用 vi 风格的快捷键，而执行 <code>set -o emacs</code> 可以把它改回来。</li>
<li>为了便于编辑长命令，在设置你的默认编辑器后（例如 <code>export EDITOR=vim</code>），<strong>ctrl-x</strong> <strong>ctrl-e</strong> 会打开一个编辑器来编辑当前输入的命令。在 vi 风格下快捷键则是 <strong>escape-v</strong>。</li>
<li>键入 <code>history</code> 查看命令行历史记录，再用 <code>!n</code>（<code>n</code> 是命令编号）就可以再次执行。其中有许多缩写，最有用的大概就是 <code>!$</code>， 它用于指代上次键入的参数，而 <code>!!</code> 可以指代上次键入的命令了（参考 man 页面中的“HISTORY EXPANSION”）。不过这些功能，你也可以通过快捷键 <strong>ctrl-r</strong> 和 <strong>alt-.</strong> 来实现。</li>
<li><code>cd</code> 命令可以切换工作路径，输入 <code>cd ~</code> 可以进入 home 目录。要访问你的 home 目录中的文件，可以使用前缀 <code>~</code>（例如 <code>~/.bashrc</code>）。在 <code>sh</code> 脚本里则用环境变量 <code>$HOME</code> 指代 home 目录的路径。</li>
<li>回到前一个工作路径：<code>cd -</code>。</li>
<li>如果你输入命令的时候中途改了主意，按下 <strong>alt-#</strong> 在行首添加 <code>#</code> 把它当做注释再按下回车执行（或者依次按下 <strong>ctrl-a</strong>， <strong>#**， **enter</strong>）。这样做的话，之后借助命令行历史记录，你可以很方便恢复你刚才输入到一半的命令。</li>
<li>使用 <code>xargs</code> （ 或 <code>parallel</code>）。他们非常给力。注意到你可以控制每行参数个数（<code>-L</code>）和最大并行数（<code>-P</code>）。如果你不确定它们是否会按你想的那样工作，先使用 <code>xargs echo</code> 查看一下。此外，使用 <code>-I&#123;&#125;</code> 会很方便。例如：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">find . -name <span class="string">&#x27;*.py&#x27;</span> | xargs grep some_function</span><br><span class="line">cat hosts | xargs -I&#123;&#125; ssh root@&#123;&#125; hostname</span><br></pre></td></tr></table></figure>

<ul>
<li><code>pstree -p</code> 以一种优雅的方式展示进程树。</li>
<li>使用 <code>pgrep</code> 和 <code>pkill</code> 根据名字查找进程或发送信号（<code>-f</code> 参数通常有用）。</li>
<li>了解你可以发往进程的信号的种类。比如，使用 <code>kill -STOP [pid]</code> 停止一个进程。使用 <code>man 7 signal</code> 查看详细列表。</li>
<li>使用 <code>nohup</code> 或 <code>disown</code> 使一个后台进程持续运行。</li>
<li>使用 <code>netstat -lntp</code> 或 <code>ss -plat</code> 检查哪些进程在监听端口（默认是检查 TCP 端口; 添加参数 <code>-u</code> 则检查 UDP 端口）或者 <code>lsof -iTCP -sTCP:LISTEN -P -n</code> (这也可以在 OS X 上运行)。</li>
<li><code>lsof</code> 来查看开启的套接字和文件。</li>
<li>使用 <code>uptime</code> 或 <code>w</code> 来查看系统已经运行多长时间。</li>
<li>使用 <code>alias</code> 来创建常用命令的快捷形式。例如：<code>alias ll=&#39;ls -latr&#39;</code> 创建了一个新的命令别名 <code>ll</code>。</li>
<li>可以把别名、shell 选项和常用函数保存在 <code>~/.bashrc</code>，具体看下这篇<a target="_blank" rel="noopener" href="http://superuser.com/a/183980/7106">文章</a>。这样做的话你就可以在所有 shell 会话中使用你的设定。</li>
<li>把环境变量的设定以及登陆时要执行的命令保存在 <code>~/.bash_profile</code>。而对于从图形界面启动的 shell 和 <code>cron</code> 启动的 shell，则需要单独配置文件。</li>
<li>要想在几台电脑中同步你的配置文件（例如 <code>.bashrc</code> 和 <code>.bash_profile</code>），可以借助 Git。</li>
<li>当变量和文件名中包含空格的时候要格外小心。Bash 变量要用引号括起来，比如 <code>&quot;$FOO&quot;</code>。尽量使用 <code>-0</code> 或 <code>-print0</code> 选项以便用 NULL 来分隔文件名，例如 <code>locate -0 pattern | xargs -0 ls -al</code> 或 <code>find / -print0 -type d | xargs -0 ls -al</code>。如果 for 循环中循环访问的文件名含有空字符（空格、tab 等字符），只需用 <code>IFS=$&#39;\n&#39;</code> 把内部字段分隔符设为换行符。</li>
<li>在 Bash 脚本中，使用 <code>set -x</code> 去调试输出（或者使用它的变体 <code>set -v</code>，它会记录原始输入，包括多余的参数和注释）。尽可能地使用严格模式：使用 <code>set -e</code> 令脚本在发生错误时退出而不是继续运行；使用 <code>set -u</code> 来检查是否使用了未赋值的变量；试试 <code>set -o pipefail</code>，它可以监测管道中的错误。当牵扯到很多脚本时，使用 <code>trap</code> 来检测 ERR 和 EXIT。一个好的习惯是在脚本文件开头这样写，这会使它能够检测一些错误，并在错误发生时中断程序并输出信息：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> -euo pipefail</span><br><span class="line"><span class="built_in">trap</span> <span class="string">&quot;echo &#x27;error: Script failed: see failed command above&#x27;&quot;</span> ERR</span><br></pre></td></tr></table></figure>

<ul>
<li>在 Bash 脚本中，子 shell（使用括号 <code>(...)</code>）是一种组织参数的便捷方式。一个常见的例子是临时地移动工作路径，代码如下：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># do something in current dir</span></span><br><span class="line">(<span class="built_in">cd</span> /some/other/dir &amp;&amp; other-command)</span><br><span class="line"><span class="comment"># continue in original dir</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在 Bash 中，变量有许多的扩展方式。<code>$&#123;name:?error message&#125;</code> 用于检查变量是否存在。此外，当 Bash 脚本只需要一个参数时，可以使用这样的代码 <code>input_file=$&#123;1:?usage: $0 input_file&#125;</code>。在变量为空时使用默认值：<code>$&#123;name:-default&#125;</code>。如果你要在之前的例子中再加一个（可选的）参数，可以使用类似这样的代码 <code>output_file=$&#123;2:-logfile&#125;</code>，如果省略了 <img src="https://g.yuque.com/gr/latex?2%EF%BC%8C%E5%AE%83%E7%9A%84%E5%80%BC%E5%B0%B1%E4%B8%BA%E7%A9%BA%EF%BC%8C%E4%BA%8E%E6%98%AF%20%60output_file%60%20%E5%B0%B1%E4%BC%9A%E8%A2%AB%E8%AE%BE%E4%B8%BA%20%60logfile%60%E3%80%82%E6%95%B0%E5%AD%A6%E8%A1%A8%E8%BE%BE%E5%BC%8F%EF%BC%9A%60i=#card=math&code=2%EF%BC%8C%E5%AE%83%E7%9A%84%E5%80%BC%E5%B0%B1%E4%B8%BA%E7%A9%BA%EF%BC%8C%E4%BA%8E%E6%98%AF%20%60output_file%60%20%E5%B0%B1%E4%BC%9A%E8%A2%AB%E8%AE%BE%E4%B8%BA%20%60logfile%60%E3%80%82%E6%95%B0%E5%AD%A6%E8%A1%A8%E8%BE%BE%E5%BC%8F%EF%BC%9A%60i%3D&id=ZI9eN">(( (i + 1) % 5 ))<code>。序列：</code>{1..10}<code>。截断字符串：</code><img src="https://g.yuque.com/gr/latex?%7Bvar%25suffix%7D%60%20%E5%92%8C%20%60#card=math&code=%7Bvar%25suffix%7D%60%20%E5%92%8C%20%60&id=s1AcL">{var#prefix}<code>。例如，假设</code>var=foo.pdf<code>，那么</code>echo ${var%.pdf}.txt<code>将输出</code>foo.txt`。</li>
<li>使用括号扩展（<code>&#123;</code>…<code>&#125;</code>）来减少输入相似文本，并自动化文本组合。这在某些情况下会很有用，例如 <code>mv foo.&#123;txt,pdf&#125; some-dir</code>（同时移动两个文件），<code>cp somefile&#123;,.bak&#125;</code>（会被扩展成 <code>cp somefile somefile.bak</code>）或者 <code>mkdir -p test-&#123;a,b,c&#125;/subtest-&#123;1,2,3&#125;</code>（会被扩展成所有可能的组合，并创建一个目录树）。</li>
<li>通过使用 <code>&lt;(some command)</code> 可以将输出视为文件。例如，对比本地文件 <code>/etc/hosts</code> 和一个远程文件：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">diff /etc/hosts &lt;(ssh somehost cat /etc/hosts)</span><br></pre></td></tr></table></figure>

<ul>
<li>编写脚本时，你可能会想要把代码都放在大括号里。缺少右括号的话，代码就会因为语法错误而无法执行。如果你的脚本是要放在网上分享供他人使用的，这样的写法就体现出它的好处了，因为这样可以防止下载不完全代码被执行。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">      <span class="comment"># 在这里写代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>了解 Bash 中的“here documents”，例如 <code>cat &lt;&lt;EOF ...</code>。</li>
<li>在 Bash 中，同时重定向标准输出和标准错误：<code>some-command &gt;logfile 2&gt;&amp;1</code> 或者 <code>some-command &amp;&gt;logfile</code>。通常，为了保证命令不会在标准输入里残留一个未关闭的文件句柄捆绑在你当前所在的终端上，在命令后添加 <code>&lt;/dev/null</code> 是一个好习惯。</li>
<li>使用 <code>man ascii</code> 查看具有十六进制和十进制值的 ASCII 表。<code>man unicode</code>，<code>man utf-8</code>，以及 <code>man latin1</code> 有助于你去了解通用的编码信息。</li>
<li>使用 <code>screen</code> 或 <code>[tmux](https://tmux.github.io/)</code> 来使用多份屏幕，当你在使用 ssh 时（保存 session 信息）将尤为有用。而 <code>byobu</code> 可以为它们提供更多的信息和易用的管理工具。另一个轻量级的 session 持久化解决方案是 <code>[dtach](https://github.com/bogner/dtach)</code>。</li>
<li>ssh 中，了解如何使用 <code>-L</code> 或 <code>-D</code>（偶尔需要用 <code>-R</code>）开启隧道是非常有用的，比如当你需要从一台远程服务器上访问 web 页面。</li>
<li>对 ssh 设置做一些小优化可能是很有用的，例如这个 <code>~/.ssh/config</code> 文件包含了防止特定网络环境下连接断开、压缩数据、多通道等选项：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">TCPKeepAlive&#x3D;yes</span><br><span class="line">ServerAliveInterval&#x3D;15</span><br><span class="line">ServerAliveCountMax&#x3D;6</span><br><span class="line">Compression&#x3D;yes</span><br><span class="line">ControlMaster auto</span><br><span class="line">ControlPath &#x2F;tmp&#x2F;%r@%h:%p</span><br><span class="line">ControlPersist yes</span><br></pre></td></tr></table></figure>

<ul>
<li>一些其他的关于 ssh 的选项是与安全相关的，应当小心翼翼的使用。例如你应当只能在可信任的网络中启用 <code>StrictHostKeyChecking=no</code>，<code>ForwardAgent=yes</code>。</li>
<li>考虑使用 <code>[mosh](https://mosh.mit.edu/)</code> 作为 ssh 的替代品，它使用 UDP 协议。它可以避免连接被中断并且对带宽需求更小，但它需要在服务端做相应的配置。</li>
<li>获取八进制形式的文件访问权限（修改系统设置时通常需要，但 <code>ls</code> 的功能不那么好用并且通常会搞砸），可以使用类似如下的代码：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">stat</span> -c <span class="string">&#x27;%A %a %n&#x27;</span> /etc/timezone</span><br></pre></td></tr></table></figure>

<ul>
<li>使用 <code>[percol](https://github.com/mooz/percol)</code> 或者 <code>[fzf](https://github.com/junegunn/fzf)</code> 可以交互式地从另一个命令输出中选取值。</li>
<li>使用 <code>fpp</code>（<a target="_blank" rel="noopener" href="https://github.com/facebook/PathPicker">PathPicker</a>）可以与基于另一个命令(例如 <code>git</code>）输出的文件交互。</li>
<li>将 web 服务器上当前目录下所有的文件（以及子目录）暴露给你所处网络的所有用户，使用：</li>
</ul>
<p><code>python -m SimpleHTTPServer 7777</code> （使用端口 7777 和 Python 2）或<code>python -m http.server 7777</code> （使用端口 7777 和 Python 3）。</p>
<ul>
<li>以其他用户的身份执行命令，使用 <code>sudo</code>。默认以 root 用户的身份执行；使用 <code>-u</code> 来指定其他用户。使用 <code>-i</code> 来以该用户登录（需要输入<em>你自己的</em>密码）。</li>
<li>将 shell 切换为其他用户，使用 <code>su username</code> 或者 <code>sudo - username</code>。加入 <code>-</code> 会使得切换后的环境与使用该用户登录后的环境相同。省略用户名则默认为 root。切换到哪个用户，就需要输入<em>哪个用户的</em>密码。</li>
<li>了解命令行的 <a target="_blank" rel="noopener" href="https://wiki.debian.org/CommonErrorMessages/ArgumentListTooLong">128K 限制</a>。使用通配符匹配大量文件名时，常会遇到“Argument list too long”的错误信息。（这种情况下换用 <code>find</code> 或 <code>xargs</code> 通常可以解决。）</li>
<li>当你需要一个基本的计算器时，可以使用 <code>python</code> 解释器（当然你要用 python 的时候也是这样）。例如：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; 2+3</span><br><span class="line">5</span><br></pre></td></tr></table></figure>

<h2 id="文件及数据处理"><a href="#文件及数据处理" class="headerlink" title="文件及数据处理"></a>文件及数据处理</h2><ul>
<li>在当前目录下通过文件名查找一个文件，使用类似于这样的命令：<code>find . -iname &#39;*something*&#39;</code>。在所有路径下通过文件名查找文件，使用 <code>locate something</code> （但注意到 <code>updatedb</code> 可能没有对最近新建的文件建立索引，所以你可能无法定位到这些未被索引的文件）。</li>
<li>使用 <code>[ag](https://github.com/ggreer/the_silver_searcher)</code> 在源代码或数据文件里检索（<code>grep -r</code> 同样可以做到，但相比之下 <code>ag</code> 更加先进）。</li>
<li>将 HTML 转为文本：<code>lynx -dump -stdin</code>。</li>
<li>Markdown，HTML，以及所有文档格式之间的转换，试试 <code>[pandoc](http://pandoc.org/)</code>。</li>
<li>当你要处理棘手的 XML 时候，<code>xmlstarlet</code> 算是上古时代流传下来的神器。</li>
<li>使用 <code>[jq](http://stedolan.github.io/jq/)</code> 处理 JSON。</li>
<li>使用 <code>[shyaml](https://github.com/0k/shyaml)</code> 处理 YAML。</li>
<li>要处理 Excel 或 CSV 文件的话，<a target="_blank" rel="noopener" href="https://github.com/onyxfish/csvkit">csvkit</a> 提供了 <code>in2csv</code>，<code>csvcut</code>，<code>csvjoin</code>，<code>csvgrep</code> 等方便易用的工具。</li>
<li>当你要处理 Amazon S3 相关的工作的时候，<code>[s3cmd](https://github.com/s3tools/s3cmd)</code> 是一个很方便的工具而 <code>[s4cmd](https://github.com/bloomreach/s4cmd)</code> 的效率更高。Amazon 官方提供的 <code>[aws](https://github.com/aws/aws-cli)</code> 以及  <code>[saws](https://github.com/donnemartin/saws)</code> 是其他 AWS 相关工作的基础，值得学习。</li>
<li>了解如何使用 <code>sort</code> 和 <code>uniq</code>，包括 uniq 的 <code>-u</code> 参数和 <code>-d</code> 参数，具体内容在后文单行脚本节中。另外可以了解一下 <code>comm</code>。</li>
<li>了解如何使用 <code>cut</code>，<code>paste</code> 和 <code>join</code> 来更改文件。很多人都会使用 <code>cut</code>，但遗忘了 <code>join</code>。</li>
<li>了解如何运用 <code>wc</code> 去计算新行数（<code>-l</code>），字符数（<code>-m</code>），单词数（<code>-w</code>）以及字节数（<code>-c</code>）。</li>
<li>了解如何使用 <code>tee</code> 将标准输入复制到文件甚至标准输出，例如 <code>ls -al | tee file.txt</code>。</li>
<li>要进行一些复杂的计算，比如分组、逆序和一些其他的统计分析，可以考虑使用 <code>[datamash](https://www.gnu.org/software/datamash/)</code>。</li>
<li>注意到语言设置（中文或英文等）对许多命令行工具有一些微妙的影响，比如排序的顺序和性能。大多数 Linux 的安装过程会将 <code>LANG</code> 或其他有关的变量设置为符合本地的设置。要意识到当你改变语言设置时，排序的结果可能会改变。明白国际化可能会使 sort 或其他命令运行效率下降<em>许多倍</em>。某些情况下（例如集合运算）你可以放心的使用 <code>export LC_ALL=C</code> 来忽略掉国际化并按照字节来判断顺序。</li>
<li>你可以单独指定某一条命令的环境，只需在调用时把环境变量设定放在命令的前面，例如 <code>TZ=Pacific/Fiji date</code> 可以获取斐济的时间。</li>
<li>了解如何使用 <code>awk</code> 和 <code>sed</code> 来进行简单的数据处理。 参阅 <a href="#one-liners">One-liners</a> 获取示例。</li>
<li>替换一个或多个文件中出现的字符串：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perl -pi.bak -e <span class="string">&#x27;s/old-string/new-string/g&#x27;</span> my-files-*.txt</span><br></pre></td></tr></table></figure>

<ul>
<li>使用 <code>[repren](https://github.com/jlevy/repren)</code> 来批量重命名文件，或是在多个文件中搜索替换内容。（有些时候 <code>rename</code> 命令也可以批量重命名，但要注意，它在不同 Linux 发行版中的功能并不完全一样。）</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将文件、目录和内容全部重命名 foo -&gt; bar:</span></span><br><span class="line">repren --full --preserve-case --from foo --to bar .</span><br><span class="line"><span class="comment"># 还原所有备份文件 whatever.bak -&gt; whatever:</span></span><br><span class="line">repren --renames --from <span class="string">&#x27;(.*)\.bak&#x27;</span> --to <span class="string">&#x27;\1&#x27;</span> *.bak</span><br><span class="line"><span class="comment"># 用 rename 实现上述功能（若可用）:</span></span><br><span class="line">rename <span class="string">&#x27;s/\.bak$//&#x27;</span> *.bak</span><br></pre></td></tr></table></figure>

<ul>
<li>根据 man 页面的描述，<code>rsync</code> 是一个快速且非常灵活的文件复制工具。它闻名于设备之间的文件同步，但其实它在本地情况下也同样有用。在安全设置允许下，用 <code>rsync</code> 代替 <code>scp</code> 可以实现文件续传，而不用重新从头开始。它同时也是删除大量文件的<a target="_blank" rel="noopener" href="https://web.archive.org/web/20130929001850/http://linuxnote.net/jianingy/en/linux/a-fast-way-to-remove-huge-number-of-files.html">最快方法</a>之一：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir empty &amp;&amp; rsync -r --delete empty/ some-dir &amp;&amp; rmdir some-dir</span><br></pre></td></tr></table></figure>

<ul>
<li>若要在复制文件时获取当前进度，可使用 <code>pv</code>，<code>[pycp](https://github.com/dmerejkowsky/pycp)</code>，<code>[progress](https://github.com/Xfennec/progress)</code>，<code>rsync --progress</code>。若所执行的复制为 block 块拷贝，可以使用 <code>dd status=progress</code>。</li>
<li>使用 <code>shuf</code> 可以以行为单位来打乱文件的内容或从一个文件中随机选取多行。</li>
<li>了解 <code>sort</code> 的参数。显示数字时，使用 <code>-n</code> 或者 <code>-h</code> 来显示更易读的数（例如 <code>du -h</code> 的输出）。明白排序时关键字的工作原理（<code>-t</code> 和 <code>-k</code>）。例如，注意到你需要 <code>-k1，1</code> 来仅按第一个域来排序，而 <code>-k1</code> 意味着按整行排序。稳定排序（<code>sort -s</code>）在某些情况下很有用。例如，以第二个域为主关键字，第一个域为次关键字进行排序，你可以使用 <code>sort -k1，1 | sort -s -k2，2</code>。</li>
<li>如果你想在 Bash 命令行中写 tab 制表符，按下 <strong>ctrl-v</strong> <strong>[Tab]</strong> 或键入 <code>$&#39;\t&#39;</code> （后者可能更好，因为你可以复制粘贴它）。</li>
<li>标准的源代码对比及合并工具是 <code>diff</code> 和 <code>patch</code>。使用 <code>diffstat</code> 查看变更总览数据。注意到 <code>diff -r</code> 对整个文件夹有效。使用 <code>diff -r tree1 tree2 | diffstat</code> 查看变更的统计数据。<code>vimdiff</code> 用于比对并编辑文件。</li>
<li>对于二进制文件，使用 <code>hd</code>，<code>hexdump</code> 或者 <code>xxd</code> 使其以十六进制显示，使用 <code>bvi</code>，<code>hexedit</code> 或者 <code>biew</code> 来进行二进制编辑。</li>
<li>同样对于二进制文件，<code>strings</code>（包括 <code>grep</code> 等工具）可以帮助在二进制文件中查找特定比特。</li>
<li>制作二进制差分文件（Delta 压缩），使用 <code>xdelta3</code>。</li>
<li>使用 <code>iconv</code> 更改文本编码。需要更高级的功能，可以使用 <code>uconv</code>，它支持一些高级的 Unicode 功能。例如，这条命令移除了所有重音符号：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uconv -f utf-8 -t utf-8 -x <span class="string">&#x27;::Any-Lower; ::Any-NFD; [:Nonspacing Mark:] &gt;; ::Any-NFC; &#x27;</span> &lt; input.txt &gt; output.txt</span><br></pre></td></tr></table></figure>

<ul>
<li>拆分文件可以使用 <code>split</code>（按大小拆分）和 <code>csplit</code>（按模式拆分）。</li>
<li>操作日期和时间表达式，可以用 <code>[dateutils](http://www.fresse.org/dateutils/)</code> 中的 <code>dateadd</code>、<code>datediff</code>、<code>strptime</code> 等工具。</li>
<li>使用 <code>zless</code>、<code>zmore</code>、<code>zcat</code> 和 <code>zgrep</code> 对压缩过的文件进行操作。</li>
<li>文件属性可以通过 <code>chattr</code> 进行设置，它比文件权限更加底层。例如，为了保护文件不被意外删除，可以使用不可修改标记：<code>sudo chattr +i /critical/directory/or/file</code></li>
<li>使用 <code>getfacl</code> 和 <code>setfacl</code> 以保存和恢复文件权限。例如：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">getfacl -R /some/path &gt; permissions.txt</span><br><span class="line">setfacl --restore=permissions.txt</span><br></pre></td></tr></table></figure>

<ul>
<li>为了高效地创建空文件，请使用 <code>truncate</code>（创建<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%A8%80%E7%96%8F%E6%96%87%E4%BB%B6">稀疏文件</a>），<code>fallocate</code>（用于 ext4，xfs，btrf 和 ocfs2 文件系统），<code>xfs_mkfile</code>（适用于几乎所有的文件系统，包含在 xfsprogs 包中），<code>mkfile</code>（用于类 Unix 操作系统，比如 Solaris 和 Mac OS）。</li>
</ul>
<h2 id="系统调试"><a href="#系统调试" class="headerlink" title="系统调试"></a>系统调试</h2><ul>
<li><code>curl</code> 和 <code>curl -I</code> 可以被轻松地应用于 web 调试中，它们的好兄弟 <code>wget</code> 也是如此，或者也可以试试更潮的 <code>[httpie](https://github.com/jkbrzt/httpie)</code>。</li>
<li>获取 CPU 和硬盘的使用状态，通常使用使用 <code>top</code>（<code>htop</code> 更佳），<code>iostat</code> 和 <code>iotop</code>。而 <code>iostat -mxz 15</code> 可以让你获悉 CPU 和每个硬盘分区的基本信息和性能表现。</li>
<li>使用 <code>netstat</code> 和 <code>ss</code> 查看网络连接的细节。</li>
<li><code>dstat</code> 在你想要对系统的现状有一个粗略的认识时是非常有用的。然而若要对系统有一个深度的总体认识，使用 <code>[glances](https://github.com/nicolargo/glances)</code>，它会在一个终端窗口中向你提供一些系统级的数据。</li>
<li>若要了解内存状态，运行并理解 <code>free</code> 和 <code>vmstat</code> 的输出。值得留意的是“cached”的值，它指的是 Linux 内核用来作为文件缓存的内存大小，而与空闲内存无关。</li>
<li>Java 系统调试则是一件截然不同的事，一个可以用于 Oracle 的 JVM 或其他 JVM 上的调试的技巧是你可以运行 <code>kill -3 &lt;pid&gt;</code> 同时一个完整的栈轨迹和堆概述（包括 GC 的细节）会被保存到标准错误或是日志文件。JDK 中的 <code>jps</code>，<code>jstat</code>，<code>jstack</code>，<code>jmap</code> 很有用。<a target="_blank" rel="noopener" href="https://github.com/aragozin/jvm-tools">SJK tools</a> 更高级。</li>
<li>使用 <code>[mtr](http://www.bitwizard.nl/mtr/)</code> 去跟踪路由，用于确定网络问题。</li>
<li>用 <code>[ncdu](https://dev.yorhel.nl/ncdu)</code> 来查看磁盘使用情况，它比寻常的命令，如 <code>du -sh *</code>，更节省时间。</li>
<li>查找正在使用带宽的套接字连接或进程，使用 <code>[iftop](http://www.ex-parrot.com/~pdw/iftop/)</code> 或 <code>[nethogs](https://github.com/raboof/nethogs)</code>。</li>
<li><code>ab</code> 工具（Apache 中自带）可以简单粗暴地检查 web 服务器的性能。对于更复杂的负载测试，使用 <code>siege</code>。</li>
<li><code>[wireshark](https://wireshark.org/)</code>，<code>[tshark](https://www.wireshark.org/docs/wsug_html_chunked/AppToolstshark.html)</code> 和 <code>[ngrep](http://ngrep.sourceforge.net/)</code> 可用于复杂的网络调试。</li>
<li>了解 <code>strace</code> 和 <code>ltrace</code>。这俩工具在你的程序运行失败、挂起甚至崩溃，而你却不知道为什么或你想对性能有个总体的认识的时候是非常有用的。注意 profile 参数（<code>-c</code>）和附加到一个运行的进程参数 （<code>-p</code>）。</li>
<li>了解使用 <code>ldd</code> 来检查共享库。但是<a target="_blank" rel="noopener" href="http://www.catonmat.net/blog/ldd-arbitrary-code-execution/">永远不要在不信任的文件上运行</a>。</li>
<li>了解如何运用 <code>gdb</code> 连接到一个运行着的进程并获取它的堆栈轨迹。</li>
<li>学会使用 <code>/proc</code>。它在调试正在出现的问题的时候有时会效果惊人。比如：<code>/proc/cpuinfo</code>，<code>/proc/meminfo</code>，<code>/proc/cmdline</code>，<code>/proc/xxx/cwd</code>，<code>/proc/xxx/exe</code>，<code>/proc/xxx/fd/</code>，<code>/proc/xxx/smaps</code>（这里的 <code>xxx</code> 表示进程的 id 或 pid）。</li>
<li>当调试一些之前出现的问题的时候，<code>[sar](http://sebastien.godard.pagesperso-orange.fr/)</code> 非常有用。它展示了 cpu、内存以及网络等的历史数据。</li>
<li>关于更深层次的系统分析以及性能分析，看看 <code>stap</code>（<a target="_blank" rel="noopener" href="https://sourceware.org/systemtap/wiki">SystemTap</a>），<code>[perf](https://en.wikipedia.org/wiki/Perf_(Linux))</code>，以及<code>[sysdig](https://github.com/draios/sysdig)</code>。</li>
<li>查看你当前使用的系统，使用 <code>uname</code>，<code>uname -a</code>（Unix／kernel 信息）或者 <code>lsb_release -a</code>（Linux 发行版信息）。</li>
<li>无论什么东西工作得很欢乐（可能是硬件或驱动问题）时可以试试 <code>dmesg</code>。</li>
<li>如果你删除了一个文件，但通过 <code>du</code> 发现没有释放预期的磁盘空间，请检查文件是否被进程占用：</li>
</ul>
<p><code>lsof | grep deleted | grep &quot;filename-of-my-big-file&quot;</code></p>
<h2 id="单行脚本"><a href="#单行脚本" class="headerlink" title="单行脚本"></a>单行脚本</h2><p>一些命令组合的例子：</p>
<ul>
<li>当你需要对文本文件做集合交、并、差运算时，<code>sort</code> 和 <code>uniq</code> 会是你的好帮手。具体例子请参照代码后面的，此处假设 <code>a</code> 与 <code>b</code> 是两内容不同的文件。这种方式效率很高，并且在小文件和上 G 的文件上都能运用（注意尽管在 <code>/tmp</code> 在一个小的根分区上时你可能需要 <code>-T</code> 参数，但是实际上 <code>sort</code> 并不被内存大小约束），参阅前文中关于 <code>LC_ALL</code> 和 <code>sort</code> 的 <code>-u</code> 参数的部分。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sort a b | uniq &gt; c   <span class="comment"># c 是 a 并 b</span></span><br><span class="line">sort a b | uniq -d &gt; c   <span class="comment"># c 是 a 交 b</span></span><br><span class="line">sort a b b | uniq -u &gt; c   <span class="comment"># c 是 a - b</span></span><br></pre></td></tr></table></figure>

<ul>
<li>使用 <code>grep . *</code>（每行都会附上文件名）或者 <code>head -100 *</code>（每个文件有一个标题）来阅读检查目录下所有文件的内容。这在检查一个充满配置文件的目录（如 <code>/sys</code>、<code>/proc</code>、<code>/etc</code>）时特别好用。</li>
<li>计算文本文件第三列中所有数的和（可能比同等作用的 Python 代码快三倍且代码量少三倍）：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">&#x27;&#123; x += $3 &#125; END &#123; print x &#125;&#x27;</span> myfile</span><br></pre></td></tr></table></figure>

<ul>
<li>如果你想在文件树上查看大小/日期，这可能看起来像递归版的 <code>ls -l</code> 但比 <code>ls -lR</code> 更易于理解：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . -<span class="built_in">type</span> f -ls</span><br></pre></td></tr></table></figure>

<ul>
<li>假设你有一个类似于 web 服务器日志文件的文本文件，并且一个确定的值只会出现在某些行上，假设一个 <code>acct_id</code> 参数在 URI 中。如果你想计算出每个 <code>acct_id</code> 值有多少次请求，使用如下代码：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">egrep -o <span class="string">&#x27;acct_id=[0-9]+&#x27;</span> access.log | cut -d= -f2 | sort | uniq -c | sort -rn</span><br></pre></td></tr></table></figure>

<ul>
<li>要持续监测文件改动，可以使用 <code>watch</code>，例如检查某个文件夹中文件的改变，可以用 <code>watch -d -n 2 &#39;ls -rtlh | tail&#39;</code>；或者在排查 WiFi 设置故障时要监测网络设置的更改，可以用 <code>watch -d -n 2 ifconfig</code>。</li>
<li>运行这个函数从这篇文档中随机获取一条技巧（解析 Markdown 文件并抽取项目）：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">taocl</span></span>() &#123;</span><br><span class="line">  curl -s https://raw.githubusercontent.com/jlevy/the-art-of-command-line/master/README-zh.md|</span><br><span class="line">    pandoc -f markdown -t html |</span><br><span class="line">    iconv -f <span class="string">&#x27;utf-8&#x27;</span> -t <span class="string">&#x27;unicode&#x27;</span> |</span><br><span class="line">    xmlstarlet fo --html --dropdtd |</span><br><span class="line">    xmlstarlet sel -t -v <span class="string">&quot;(html/body/ul/li[count(p)&gt;0])[<span class="variable">$RANDOM</span> mod last()+1]&quot;</span> |</span><br><span class="line">    xmlstarlet unesc | fmt -80</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="冷门但有用"><a href="#冷门但有用" class="headerlink" title="冷门但有用"></a>冷门但有用</h2><ul>
<li><code>expr</code>：计算表达式或正则匹配</li>
<li><code>m4</code>：简单的宏处理器</li>
<li><code>yes</code>：多次打印字符串</li>
<li><code>cal</code>：漂亮的日历</li>
<li><code>env</code>：执行一个命令（脚本文件中很有用）</li>
<li><code>printenv</code>：打印环境变量（调试时或在写脚本文件时很有用）</li>
<li><code>look</code>：查找以特定字符串开头的单词或行</li>
<li><code>cut</code>，<code>paste</code> 和 <code>join</code>：数据修改</li>
<li><code>fmt</code>：格式化文本段落</li>
<li><code>pr</code>：将文本格式化成页／列形式</li>
<li><code>fold</code>：包裹文本中的几行</li>
<li><code>column</code>：将文本格式化成多个对齐、定宽的列或表格</li>
<li><code>expand</code> 和 <code>unexpand</code>：制表符与空格之间转换</li>
<li><code>nl</code>：添加行号</li>
<li><code>seq</code>：打印数字</li>
<li><code>bc</code>：计算器</li>
<li><code>factor</code>：分解因数</li>
<li><code>[gpg](https://gnupg.org/)</code>：加密并签名文件</li>
<li><code>toe</code>：terminfo 入口列表</li>
<li><code>nc</code>：网络调试及数据传输</li>
<li><code>socat</code>：套接字代理，与 <code>netcat</code> 类似</li>
<li><code>[slurm](https://github.com/mattthias/slurm)</code>：网络流量可视化</li>
<li><code>dd</code>：文件或设备间传输数据</li>
<li><code>file</code>：确定文件类型</li>
<li><code>tree</code>：以树的形式显示路径和文件，类似于递归的 <code>ls</code></li>
<li><code>stat</code>：文件信息</li>
<li><code>time</code>：执行命令，并计算执行时间</li>
<li><code>timeout</code>：在指定时长范围内执行命令，并在规定时间结束后停止进程</li>
<li><code>lockfile</code>：使文件只能通过 <code>rm -f</code> 移除</li>
<li><code>logrotate</code>： 切换、压缩以及发送日志文件</li>
<li><code>watch</code>：重复运行同一个命令，展示结果并／或高亮有更改的部分</li>
<li><code>[when-changed](https://github.com/joh/when-changed)</code>：当检测到文件更改时执行指定命令。参阅 <code>inotifywait</code> 和 <code>entr</code>。</li>
<li><code>tac</code>：反向输出文件</li>
<li><code>shuf</code>：文件中随机选取几行</li>
<li><code>comm</code>：一行一行的比较排序过的文件</li>
<li><code>strings</code>：从二进制文件中抽取文本</li>
<li><code>tr</code>：转换字母</li>
<li><code>iconv</code> 或 <code>uconv</code>：文本编码转换</li>
<li><code>split</code> 和 <code>csplit</code>：分割文件</li>
<li><code>sponge</code>：在写入前读取所有输入，在读取文件后再向同一文件写入时比较有用，例如 <code>grep -v something some-file | sponge some-file</code></li>
<li><code>units</code>：将一种计量单位转换为另一种等效的计量单位（参阅 <code>/usr/share/units/definitions.units</code>）</li>
<li><code>apg</code>：随机生成密码</li>
<li><code>xz</code>：高比例的文件压缩</li>
<li><code>ldd</code>：动态库信息</li>
<li><code>nm</code>：提取 obj 文件中的符号</li>
<li><code>ab</code> 或 <code>[wrk](https://github.com/wg/wrk)</code>：web 服务器性能分析</li>
<li><code>strace</code>：调试系统调用</li>
<li><code>[mtr](http://www.bitwizard.nl/mtr/)</code>：更好的网络调试跟踪工具</li>
<li><code>cssh</code>：可视化的并发 shell</li>
<li><code>rsync</code>：通过 ssh 或本地文件系统同步文件和文件夹</li>
<li><code>[wireshark](https://wireshark.org/)</code> 和 <code>[tshark](https://www.wireshark.org/docs/wsug_html_chunked/AppToolstshark.html)</code>：抓包和网络调试工具</li>
<li><code>[ngrep](http://ngrep.sourceforge.net/)</code>：网络层的 grep</li>
<li><code>host</code> 和 <code>dig</code>：DNS 查找</li>
<li><code>lsof</code>：列出当前系统打开文件的工具以及查看端口信息</li>
<li><code>dstat</code>：系统状态查看</li>
<li><code>[glances](https://github.com/nicolargo/glances)</code>：高层次的多子系统总览</li>
<li><code>iostat</code>：硬盘使用状态</li>
<li><code>mpstat</code>： CPU 使用状态</li>
<li><code>vmstat</code>： 内存使用状态</li>
<li><code>htop</code>：top 的加强版</li>
<li><code>last</code>：登入记录</li>
<li><code>w</code>：查看处于登录状态的用户</li>
<li><code>id</code>：用户/组 ID 信息</li>
<li><code>[sar](http://sebastien.godard.pagesperso-orange.fr/)</code>：系统历史数据</li>
<li><code>[iftop](http://www.ex-parrot.com/~pdw/iftop/)</code> 或 <code>[nethogs](https://github.com/raboof/nethogs)</code>：套接字及进程的网络利用情况</li>
<li><code>ss</code>：套接字数据</li>
<li><code>dmesg</code>：引导及系统错误信息</li>
<li><code>sysctl</code>： 在内核运行时动态地查看和修改内核的运行参数</li>
<li><code>hdparm</code>：SATA/ATA 磁盘更改及性能分析</li>
<li><code>lsblk</code>：列出块设备信息：以树形展示你的磁盘以及磁盘分区信息</li>
<li><code>lshw</code>，<code>lscpu</code>，<code>lspci</code>，<code>lsusb</code> 和 <code>dmidecode</code>：查看硬件信息，包括 CPU、BIOS、RAID、显卡、USB 设备等</li>
<li><code>lsmod</code> 和 <code>modinfo</code>：列出内核模块，并显示其细节</li>
<li><code>fortune</code>，<code>ddate</code> 和 <code>sl</code>：额，这主要取决于你是否认为蒸汽火车和莫名其妙的名人名言是否“有用”</li>
</ul>
<h2 id="仅限-OS-X-系统"><a href="#仅限-OS-X-系统" class="headerlink" title="仅限 OS X 系统"></a>仅限 OS X 系统</h2><p>以下是<em>仅限于</em> OS X 系统的技巧。</p>
<ul>
<li>用 <code>brew</code> （Homebrew）或者 <code>port</code> （MacPorts）进行包管理。这些可以用来在 OS X 系统上安装以上的大多数命令。</li>
<li>用 <code>pbcopy</code> 复制任何命令的输出到桌面应用，用 <code>pbpaste</code> 粘贴输入。</li>
<li>若要在 OS X 终端中将 Option 键视为 alt 键（例如在上面介绍的 <strong>alt-b</strong>、<strong>alt-f</strong> 等命令中用到），打开 偏好设置 -&gt; 描述文件 -&gt; 键盘 并勾选“使用 Option 键作为 Meta 键”。</li>
<li>用 <code>open</code> 或者 <code>open -a /Applications/Whatever.app</code> 使用桌面应用打开文件。</li>
<li>Spotlight：用 <code>mdfind</code> 搜索文件，用 <code>mdls</code> 列出元数据（例如照片的 EXIF 信息）。</li>
<li>注意 OS X 系统是基于 BSD UNIX 的，许多命令（例如 <code>ps</code>，<code>ls</code>，<code>tail</code>，<code>awk</code>，<code>sed</code>）都和 Linux 中有微妙的不同（ Linux 很大程度上受到了 System V-style Unix 和 GNU 工具影响）。你可以通过标题为 “BSD General Commands Manual” 的 man 页面发现这些不同。在有些情况下 GNU 版本的命令也可能被安装（例如 <code>gawk</code> 和 <code>gsed</code> 对应 GNU 中的 awk 和 sed ）。如果要写跨平台的 Bash 脚本，避免使用这些命令（例如，考虑 Python 或者 <code>perl</code> ）或者经过仔细的测试。</li>
<li>用 <code>sw_vers</code> 获取 OS X 的版本信息。</li>
</ul>
<h2 id="仅限-Windows-系统"><a href="#仅限-Windows-系统" class="headerlink" title="仅限 Windows 系统"></a>仅限 Windows 系统</h2><p>以下是<em>仅限于</em> Windows 系统的技巧。</p>
<h3 id="在-Winodws-下获取-Unix-工具"><a href="#在-Winodws-下获取-Unix-工具" class="headerlink" title="在 Winodws 下获取 Unix 工具"></a>在 Winodws 下获取 Unix 工具</h3><ul>
<li>可以安装 <a target="_blank" rel="noopener" href="https://cygwin.com/">Cygwin</a> 允许你在 Microsoft Windows 中体验 Unix shell 的威力。这样的话，本文中介绍的大多数内容都将适用。</li>
<li>在 Windows 10 上，你可以使用 <a target="_blank" rel="noopener" href="https://msdn.microsoft.com/commandline/wsl/about">Bash on Ubuntu on Windows</a>，它提供了一个熟悉的 Bash 环境，包含了不少 Unix 命令行工具。好处是它允许 Linux 上编写的程序在 Windows 上运行，而另一方面，Windows 上编写的程序却无法在 Bash 命令行中运行。</li>
<li>如果你在 Windows 上主要想用 GNU 开发者工具（例如 GCC），可以考虑 <a target="_blank" rel="noopener" href="http://www.mingw.org/">MinGW</a> 以及它的 <a target="_blank" rel="noopener" href="http://www.mingw.org/wiki/msys">MSYS</a> 包，这个包提供了例如 bash，gawk，make 和 grep 的工具。MSYS 并不包含所有可以与 Cygwin 媲美的特性。当制作 Unix 工具的原生 Windows 端口时 MinGW 将特别地有用。</li>
<li>另一个在 Windows 下实现接近 Unix 环境外观效果的选项是 <a target="_blank" rel="noopener" href="https://github.com/dthree/cash">Cash</a>。注意在此环境下只有很少的 Unix 命令和命令行可用。</li>
</ul>
<h3 id="实用-Windows-命令行工具"><a href="#实用-Windows-命令行工具" class="headerlink" title="实用 Windows 命令行工具"></a>实用 Windows 命令行工具</h3><ul>
<li>可以使用 <code>wmic</code> 在命令行环境下给大部分 Windows 系统管理任务编写脚本以及执行这些任务。</li>
<li>Windows 实用的原生命令行网络工具包括 <code>ping</code>，<code>ipconfig</code>，<code>tracert</code>，和 <code>netstat</code>。</li>
<li>可以使用 <code>Rundll32</code> 命令来实现<a target="_blank" rel="noopener" href="http://www.thewindowsclub.com/rundll32-shortcut-commands-windows">许多有用的 Windows 任务</a> 。</li>
</ul>
<h3 id="Cygwin-技巧"><a href="#Cygwin-技巧" class="headerlink" title="Cygwin 技巧"></a>Cygwin 技巧</h3><ul>
<li>通过 Cygwin 的包管理器来安装额外的 Unix 程序。</li>
<li>使用 <code>mintty</code> 作为你的命令行窗口。</li>
<li>要访问 Windows 剪贴板，可以通过 <code>/dev/clipboard</code>。</li>
<li>运行 <code>cygstart</code> 以通过默认程序打开一个文件。</li>
<li>要访问 Windows 注册表，可以使用 <code>regtool</code>。</li>
<li>注意 Windows 驱动器路径 <code>C:\</code> 在 Cygwin 中用 <code>/cygdrive/c</code> 代表，而 Cygwin 的 <code>/</code> 代表 Windows 中的 <code>C:\cygwin</code>。要转换 Cygwin 和 Windows 风格的路径可以用 <code>cygpath</code>。这在需要调用 Windows 程序的脚本里很有用。</li>
<li>学会使用 <code>wmic</code>，你就可以从命令行执行大多数 Windows 系统管理任务，并编成脚本。</li>
<li>要在 Windows 下获得 Unix 的界面和体验，另一个办法是使用 <a target="_blank" rel="noopener" href="https://github.com/dthree/cash">Cash</a>。需要注意的是，这个环境支持的 Unix 命令和命令行参数非常少。</li>
<li>要在 Windows 上获取 GNU 开发者工具（比如 GCC）的另一个办法是使用 <a target="_blank" rel="noopener" href="http://www.mingw.org/">MinGW</a> 以及它的 <a target="_blank" rel="noopener" href="http://www.mingw.org/wiki/msys">MSYS</a> 软件包，该软件包提供了 bash、gawk、make、grep 等工具。然而 MSYS 提供的功能没有 Cygwin 完善。MinGW 在创建 Unix 工具的 Windows 原生移植方面非常有用。</li>
</ul>
<h2 id="更多资源"><a href="#更多资源" class="headerlink" title="更多资源"></a>更多资源</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/alebcay/awesome-shell">awesome-shell</a>：一份精心组织的命令行工具及资源的列表。</li>
<li><a target="_blank" rel="noopener" href="https://github.com/herrbischoff/awesome-osx-command-line">awesome-osx-command-line</a>：一份针对 OS X 命令行的更深入的指南。</li>
<li><a target="_blank" rel="noopener" href="http://redsymbol.net/articles/unofficial-bash-strict-mode/">Strict mode</a>：为了编写更好的脚本文件。</li>
<li><a target="_blank" rel="noopener" href="https://github.com/koalaman/shellcheck">shellcheck</a>：一个静态 shell 脚本分析工具，本质上是 bash／sh／zsh 的 lint。</li>
<li><a target="_blank" rel="noopener" href="http://www.dwheeler.com/essays/filenames-in-shell.html">Filenames and Pathnames in Shell</a>：有关如何在 shell 脚本里正确处理文件名的细枝末节。</li>
<li><a target="_blank" rel="noopener" href="http://datascienceatthecommandline.com/#tools">Data Science at the Command Line</a>：用于数据科学的一些命令和工具，摘自同名书籍。</li>
</ul>
<h2 id="免责声明"><a href="#免责声明" class="headerlink" title="免责声明"></a>免责声明</h2><p>除去特别小的工作，你编写的代码应当方便他人阅读。能力往往伴随着责任，你 <em>有能力</em> 在 Bash 中玩一些奇技淫巧并不意味着你应该去做！;)</p>
<h2 id="授权条款"><a href="#授权条款" class="headerlink" title="授权条款"></a>授权条款</h2><p><img src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png#id=MXDok&originHeight=31&originWidth=88&originalType=binary&status=done&style=none"></p>
<p>本文使用授权协议 <a target="_blank" rel="noopener" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>。</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2021/04/28/yuque/%E5%91%BD%E4%BB%A4%E8%A1%8C%E7%9A%84%E8%89%BA%E6%9C%AF(%E8%BD%AC%E8%BD%BD)/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-yuque/SSL!TLS协议运行机制的概述" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/04/17/yuque/SSL!TLS%E5%8D%8F%E8%AE%AE%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6%E7%9A%84%E6%A6%82%E8%BF%B0/">SSL/TLS协议运行机制的概述</a>
    </h1>
  

        
        <a href="/2021/04/17/yuque/SSL!TLS%E5%8D%8F%E8%AE%AE%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6%E7%9A%84%E6%A6%82%E8%BF%B0/" class="archive-article-date">
  	<time datetime="2021-04-17T12:30:31.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2021-04-17</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>互联网的通信安全，建立在 SSL/TLS 协议之上。<br>本文简要介绍 SSL/TLS 协议的运行机制。文章的重点是设计思想和运行过程，不涉及具体的实现细节。如果想了解这方面的内容，请参阅<a target="_blank" rel="noopener" href="http://tools.ietf.org/html/rfc5246">RFC 文档</a>。<br><img src="https://cdn.nlark.com/yuque/0/2021/jpeg/190217/1618663679901-a0f8d1ac-efc6-4807-a116-bdcbb4945748.jpeg#clientId=u7a059e36-0a31-4&from=paste&height=405&id=ufba86c45&margin=%5Bobject%20Object%5D&originHeight=405&originWidth=610&originalType=url&status=done&style=none&taskId=u2f4d44fa-1c98-44f5-b890-aa1be3831c2&width=610"></p>
<h2 id="一、作用"><a href="#一、作用" class="headerlink" title="一、作用"></a>一、作用</h2><p>不使用 SSL/TLS 的 HTTP 通信，就是不加密的通信。所有信息明文传播，带来了三大风险。<br>（1）<strong>窃听风险</strong>（eavesdropping）：第三方可以获知通信内容。<br>（2）<strong>篡改风险</strong>（tampering）：第三方可以修改通信内容。<br>（3）<strong>冒充风险</strong>（pretending）：第三方可以冒充他人身份参与通信。<br>SSL/TLS 协议是为了解决这三大风险而设计的，希望达到：<br>（1） 所有信息都是<strong>加密传播</strong>，第三方无法窃听。<br>（2） 具有<strong>校验机制</strong>，一旦被篡改，通信双方会立刻发现。<br>（3） 配备<strong>身份证书</strong>，防止身份被冒充。<br>互联网是开放环境，通信双方都是未知身份，这为协议的设计带来了很大的难度。而且，协议还必须能够经受所有匪夷所思的攻击，这使得 SSL/TLS 协议变得异常复杂。</p>
<h2 id="二、历史"><a href="#二、历史" class="headerlink" title="二、历史"></a>二、历史</h2><p>互联网加密通信协议的历史，几乎与互联网一样长。<br>1994 年，NetScape 公司设计了 SSL 协议（Secure Sockets Layer）的 1.0 版，但是未发布。<br>1995 年，NetScape 公司发布 SSL 2.0 版，很快发现有严重漏洞。<br>1996 年，SSL 3.0 版问世，得到大规模应用。<br>1999 年，互联网标准化组织 ISOC 接替 NetScape 公司，发布了 SSL 的升级版<a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Secure_Sockets_Layer">TLS</a>1.0 版。<br>2006 年和 2008 年，TLS 进行了两次升级，分别为 TLS 1.1 版和 TLS 1.2 版。最新的变动是 2011 年 TLS 1.2 的<a target="_blank" rel="noopener" href="http://tools.ietf.org/html/rfc6176">修订版</a>。<br>目前，应用最广泛的是 TLS 1.0，接下来是 SSL 3.0。但是，主流浏览器都已经实现了 TLS 1.2 的支持。<br>TLS 1.0 通常被标示为 SSL 3.1，TLS 1.1 为 SSL 3.2，TLS 1.2 为 SSL 3.3。</p>
<h2 id="三、基本的运行过程"><a href="#三、基本的运行过程" class="headerlink" title="三、基本的运行过程"></a>三、基本的运行过程</h2><p>SSL/TLS 协议的基本思路是采用<a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Public-key_cryptography">公钥加密法</a>，也就是说，客户端先向服务器端索要公钥，然后用公钥加密信息，服务器收到密文后，用自己的私钥解密。<br>但是，这里有两个问题。</p>
<h3 id="（1）如何保证公钥不被篡改？"><a href="#（1）如何保证公钥不被篡改？" class="headerlink" title="（1）如何保证公钥不被篡改？"></a>（1）如何保证公钥不被篡改？</h3><p>解决方法：将公钥放在<a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Digital_certificate">数字证书</a>中。只要证书是可信的，公钥就是可信的。</p>
<h3 id="（2）公钥加密计算量太大，如何减少耗用的时间？"><a href="#（2）公钥加密计算量太大，如何减少耗用的时间？" class="headerlink" title="（2）公钥加密计算量太大，如何减少耗用的时间？"></a>（2）公钥加密计算量太大，如何减少耗用的时间？</h3><p>解决方法：每一次对话（session），客户端和服务器端都生成一个”对话密钥”（session key），用它来加密信息。由于”对话密钥”是对称加密，所以运算速度非常快，而服务器公钥只用于加密”对话密钥”本身，这样就减少了加密运算的消耗时间。<br>因此，SSL/TLS 协议的基本过程是这样的：<br>（1） 客户端向服务器端索要并验证公钥。<br>（2） 双方协商生成”对话密钥”。<br>（3） 双方采用”对话密钥”进行加密通信。<br>上面过程的前两步，又称为”握手阶段”（handshake）。</p>
<h2 id="四、握手阶段的详细过程"><a href="#四、握手阶段的详细过程" class="headerlink" title="四、握手阶段的详细过程"></a>四、握手阶段的详细过程</h2><p><img src="https://cdn.nlark.com/yuque/0/2021/png/190217/1618663680009-1b684b5e-0716-4bd8-b74a-337b45ff6eb2.png#clientId=u7a059e36-0a31-4&from=paste&height=531&id=u2eea81ef&margin=%5Bobject%20Object%5D&originHeight=531&originWidth=580&originalType=url&status=done&style=none&taskId=u5a8a4e23-f73e-4608-b64d-05cb904c619&width=580"><br>“握手阶段”涉及四次通信，我们一个个来看。需要注意的是，”握手阶段”的所有通信都是明文的。</p>
<h3 id="4-1-客户端发出请求（ClientHello）"><a href="#4-1-客户端发出请求（ClientHello）" class="headerlink" title="4.1 客户端发出请求（ClientHello）"></a>4.1 客户端发出请求（ClientHello）</h3><p>首先，客户端（通常是浏览器）先向服务器发出加密通信的请求，这被叫做 ClientHello 请求。<br>在这一步，客户端主要向服务器提供以下信息。<br>（1） 支持的协议版本，比如 TLS 1.0 版。<br>（2） 一个客户端生成的随机数，稍后用于生成”对话密钥”。<br>（3） 支持的加密方法，比如 RSA 公钥加密。<br>（4） 支持的压缩方法。<br>这里需要注意的是，客户端发送的信息之中不包括服务器的域名。也就是说，理论上服务器只能包含一个网站，否则会分不清应该向客户端提供哪一个网站的数字证书。这就是为什么通常一台服务器只能有一张数字证书的原因。<br>对于虚拟主机的用户来说，这当然很不方便。2006 年，TLS 协议加入了一个<a target="_blank" rel="noopener" href="http://tools.ietf.org/html/rfc4366">Server Name Indication 扩展</a>，允许客户端向服务器提供它所请求的域名。</p>
<h3 id="4-2-服务器回应（SeverHello）"><a href="#4-2-服务器回应（SeverHello）" class="headerlink" title="4.2 服务器回应（SeverHello）"></a>4.2 服务器回应（SeverHello）</h3><p>服务器收到客户端请求后，向客户端发出回应，这叫做 SeverHello。服务器的回应包含以下内容。<br>（1） 确认使用的加密通信协议版本，比如 TLS 1.0 版本。如果浏览器与服务器支持的版本不一致，服务器关闭加密通信。<br>（2） 一个服务器生成的随机数，稍后用于生成”对话密钥”。<br>（3） 确认使用的加密方法，比如 RSA 公钥加密。<br>（4） 服务器证书。<br>除了上面这些信息，如果服务器需要确认客户端的身份，就会再包含一项请求，要求客户端提供”客户端证书”。比如，金融机构往往只允许认证客户连入自己的网络，就会向正式客户提供 USB 密钥，里面就包含了一张客户端证书。</p>
<h3 id="4-3-客户端回应"><a href="#4-3-客户端回应" class="headerlink" title="4.3 客户端回应"></a>4.3 客户端回应</h3><p>客户端收到服务器回应以后，首先验证服务器证书。如果证书不是可信机构颁布、或者证书中的域名与实际域名不一致、或者证书已经过期，就会向访问者显示一个警告，由其选择是否还要继续通信。<br>如果证书没有问题，客户端就会从证书中取出服务器的公钥。然后，向服务器发送下面三项信息。<br>（1） 一个随机数。该随机数用服务器公钥加密，防止被窃听。<br>（2） 编码改变通知，表示随后的信息都将用双方商定的加密方法和密钥发送。<br>（3） 客户端握手结束通知，表示客户端的握手阶段已经结束。这一项同时也是前面发送的所有内容的 hash 值，用来供服务器校验。<br>上面第一项的随机数，是整个握手阶段出现的第三个随机数，又称”pre-master key”。有了它以后，客户端和服务器就同时有了三个随机数，接着双方就用事先商定的加密方法，各自生成本次会话所用的同一把”会话密钥”。<br>至于为什么一定要用三个随机数，来生成”会话密钥”，<a target="_blank" rel="noopener" href="http://blog.csdn.net/dog250/article/details/5717162">dog250</a>解释得很好：<br>“不管是客户端还是服务器，都需要随机数，这样生成的密钥才不会每次都一样。由于 SSL 协议中证书是静态的，因此十分有必要引入一种随机因素来保证协商出来的密钥的随机性。<br>对于 RSA 密钥交换算法来说，pre-master-key 本身就是一个随机数，再加上 hello 消息中的随机，三个随机数通过一个密钥导出器最终导出一个对称密钥。<br>pre master 的存在在于 SSL 协议不信任每个主机都能产生完全随机的随机数，如果随机数不随机，那么 pre master secret 就有可能被猜出来，那么仅适用 pre master secret 作为密钥就不合适了，因此必须引入新的随机因素，那么客户端和服务器加上 pre master secret 三个随机数一同生成的密钥就不容易被猜出了，一个伪随机可能完全不随机，可是是三个伪随机就十分接近随机了，每增加一个自由度，随机性增加的可不是一。”<br>此外，如果前一步，服务器要求客户端证书，客户端会在这一步发送证书及相关信息。</p>
<h3 id="4-4-服务器的最后回应"><a href="#4-4-服务器的最后回应" class="headerlink" title="4.4 服务器的最后回应"></a>4.4 服务器的最后回应</h3><p>服务器收到客户端的第三个随机数 pre-master key 之后，计算生成本次会话所用的”会话密钥”。然后，向客户端最后发送下面信息。<br>（1）编码改变通知，表示随后的信息都将用双方商定的加密方法和密钥发送。<br>（2）服务器握手结束通知，表示服务器的握手阶段已经结束。这一项同时也是前面发送的所有内容的 hash 值，用来供客户端校验。<br>至此，整个握手阶段全部结束。接下来，客户端与服务器进入加密通信，就完全是使用普通的 HTTP 协议，只不过用”会话密钥”加密内容。<br><img src="https://cdn.nlark.com/yuque/0/2021/gif/190217/1618663678842-81cb0e30-d9f2-4af1-a974-065f74017178.gif#clientId=u7a059e36-0a31-4&from=paste&height=302&id=u30395458&margin=%5Bobject%20Object%5D&originHeight=302&originWidth=317&originalType=url&status=done&style=none&taskId=ue3e60ebd-8c26-4475-b2cd-027158f7a36&width=317"></p>
<h2 id="五、参考链接"><a href="#五、参考链接" class="headerlink" title="五、参考链接"></a>五、参考链接</h2><ul>
<li>MicroSoft TechNet,<a target="_blank" rel="noopener" href="http://technet.microsoft.com/en-us/library/cc785811(v=ws.10).aspx">SSL/TLS in Detail</a></li>
<li>Jeff Moser,<a target="_blank" rel="noopener" href="http://www.moserware.com/2009/06/first-few-milliseconds-of-https.html">The First Few Milliseconds of an HTTPS Connection</a></li>
<li>Wikipedia,<a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Transport_Layer_Security">Transport Layer Security</a></li>
<li>StackExchange,<a target="_blank" rel="noopener" href="http://security.stackexchange.com/questions/20803/how-does-ssl-work">How does SSL work?</a></li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2021/04/17/yuque/SSL!TLS%E5%8D%8F%E8%AE%AE%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6%E7%9A%84%E6%A6%82%E8%BF%B0/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-yuque/SSH 使用说明（超级详细）" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/04/17/yuque/SSH%20%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E%EF%BC%88%E8%B6%85%E7%BA%A7%E8%AF%A6%E7%BB%86%EF%BC%89/">SSH 使用说明（超级详细）</a>
    </h1>
  

        
        <a href="/2021/04/17/yuque/SSH%20%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E%EF%BC%88%E8%B6%85%E7%BA%A7%E8%AF%A6%E7%BB%86%EF%BC%89/" class="archive-article-date">
  	<time datetime="2021-04-17T11:17:20.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2021-04-17</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
      

      
    </div>
    <div class="article-info article-info-index">
      
      
      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2021/04/17/yuque/SSH%20%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E%EF%BC%88%E8%B6%85%E7%BA%A7%E8%AF%A6%E7%BB%86%EF%BC%89/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-yuque/HTTP 协议简化理解" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/04/17/yuque/HTTP%20%E5%8D%8F%E8%AE%AE%E7%AE%80%E5%8C%96%E7%90%86%E8%A7%A3/">HTTP 协议简化理解</a>
    </h1>
  

        
        <a href="/2021/04/17/yuque/HTTP%20%E5%8D%8F%E8%AE%AE%E7%AE%80%E5%8C%96%E7%90%86%E8%A7%A3/" class="archive-article-date">
  	<time datetime="2021-04-17T10:59:37.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2021-04-17</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="https://cdn.nlark.com/yuque/0/2021/png/190217/1618657501453-7184b760-0c49-4b04-90a4-1a009352db11.png#clientId=u84879e80-53f2-4&from=paste&height=273&id=y60Te&margin=%5Bobject%20Object%5D&originHeight=273&originWidth=530&originalType=binary&size=112486&status=done&style=none&taskId=u8b222cbc-6d73-4894-80f4-13439917bfd&width=530"></p>
<table>
<thead>
<tr>
<th>属性</th>
<th>HTTP/3</th>
<th>HTTP/2</th>
<th>HTTPS</th>
<th>HTTP1.1/1.0/0.9</th>
</tr>
</thead>
<tbody><tr>
<td>协议属性</td>
<td>应用层 HTTP 需要 HTTP/2</td>
<td>需要 HTTPS</td>
<td>需要 HTTP1</td>
<td>-</td>
</tr>
<tr>
<td>底层协议</td>
<td>UDP QUIC</td>
<td>TCP</td>
<td>TCP</td>
<td>TCP</td>
</tr>
<tr>
<td>二进制传输</td>
<td>是</td>
<td>是</td>
<td>否</td>
<td>否</td>
</tr>
<tr>
<td>流式</td>
<td>管理，简化了流管理。</td>
<td>需要服务端客户端协商</td>
<td></td>
<td></td>
</tr>
<tr>
<td>支持多工</td>
<td>是</td>
<td>是</td>
<td></td>
<td>1.1 支持客户端并行，但不支持服务端 其他否</td>
</tr>
<tr>
<td>如何终止传输</td>
<td>可以单独放弃某些传输</td>
<td>可以单独放弃某些传输</td>
<td>TCP 断开</td>
<td>TCP 断开</td>
</tr>
<tr>
<td>是否有状态</td>
<td>无，但是可以自行管里</td>
<td>无，但是头部一已经压缩了，可以用标号代替 cookie 等</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>详情版本<br><a target="_blank" rel="noopener" href="https://www.yuque.com/murphyyi/blog/hbrtk9">https://www.yuque.com/murphyyi/blog/hbrtk9</a></p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2021/04/17/yuque/HTTP%20%E5%8D%8F%E8%AE%AE%E7%AE%80%E5%8C%96%E7%90%86%E8%A7%A3/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-yuque/HTTP 协议入门（HTTP0.9-HTTP!3）" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/04/17/yuque/HTTP%20%E5%8D%8F%E8%AE%AE%E5%85%A5%E9%97%A8%EF%BC%88HTTP0.9-HTTP!3%EF%BC%89/">HTTP 协议入门（HTTP0.9-HTTP/3）</a>
    </h1>
  

        
        <a href="/2021/04/17/yuque/HTTP%20%E5%8D%8F%E8%AE%AE%E5%85%A5%E9%97%A8%EF%BC%88HTTP0.9-HTTP!3%EF%BC%89/" class="archive-article-date">
  	<time datetime="2021-04-17T08:10:15.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2021-04-17</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>HTTP 协议是互联网的基础协议，也是网页开发的必备知识，最新版本 HTTP/2 更是让它成为技术热点。<br>本文介绍 HTTP 协议的历史演变和设计思路。<br><img src="https://cdn.nlark.com/yuque/0/2021/jpeg/190217/1618647033120-a95f8401-0de1-464f-9f43-2aca7cf0a18a.jpeg#clientId=ub15e04e4-d048-4&from=paste&height=180&id=Yqo9v&margin=%5Bobject%20Object%5D&originHeight=180&originWidth=478&originalType=url&status=done&style=none&taskId=ub34df6f9-f37f-4284-a8cd-8fa8489ee78&width=478"></p>
<h2 id="一、HTTP-0-9"><a href="#一、HTTP-0-9" class="headerlink" title="一、HTTP/0.9"></a>一、HTTP/0.9</h2><p>HTTP 是基于 TCP/IP 协议的<a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2012/05/internet_protocol_suite_part_i.html">应用层协议</a>。它不涉及数据包（packet）传输，主要规定了客户端和服务器之间的通信格式，默认使用 80 端口。<br>最早版本是 1991 年发布的 0.9 版。该版本极其简单，只有一个命令 GET。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /index.html</span><br></pre></td></tr></table></figure>

<p>上面命令表示，TCP 连接（connection）建立后，客户端向服务器请求（request）网页 index.html。<br>协议规定，服务器只能回应 HTML 格式的字符串，不能回应别的格式。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    Hello World</span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>服务器发送完毕，就关闭 TCP 连接。</p>
<h2 id="二、HTTP-1-0"><a href="#二、HTTP-1-0" class="headerlink" title="二、HTTP/1.0"></a>二、HTTP/1.0</h2><h3 id="2-1-简介"><a href="#2-1-简介" class="headerlink" title="2.1 简介"></a>2.1 简介</h3><p>1996 年 5 月，HTTP/1.0 版本发布，内容大大增加。<br>首先，任何格式的内容都可以发送。这使得互联网不仅可以传输文字，还能传输图像、视频、二进制文件。这为互联网的大发展奠定了基础。<br>其次，除了 GET 命令，还引入了 POST 命令和 HEAD 命令，丰富了浏览器与服务器的互动手段。<br>再次，HTTP 请求和回应的格式也变了。除了数据部分，每次通信都必须包括头信息（HTTP header），用来描述一些元数据。<br>其他的新增功能还包括状态码（status code）、多字符集支持、多部分发送（multi-part type）、权限（authorization）、缓存（cache）、内容编码（content encoding）等。</p>
<h3 id="2-2-请求格式"><a href="#2-2-请求格式" class="headerlink" title="2.2 请求格式"></a>2.2 请求格式</h3><p>下面是一个 1.0 版的 HTTP 请求的例子。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET / HTTP/1.0 User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_5)</span><br><span class="line">Accept: */*</span><br></pre></td></tr></table></figure>

<p>可以看到，这个格式与 0.9 版有很大变化。<br>第一行是请求命令，必须在尾部添加协议版本（HTTP/1.0）。后面就是多行头信息，描述客户端的情况。</p>
<h3 id="2-3-回应格式"><a href="#2-3-回应格式" class="headerlink" title="2.3 回应格式"></a>2.3 回应格式</h3><p>服务器的回应如下。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">HTTP/1.0 200 OK</span><br><span class="line">Content-Type: text/plain</span><br><span class="line">Content-Length: 137582</span><br><span class="line">Expires: Thu, 05 Dec 1997 16:00:00 GMT</span><br><span class="line">Last-Modified: Wed, 5 August 1996 15:55:28 GMT</span><br><span class="line">Server: Apache 0.84</span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;body&gt;Hello World&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>回应的格式是”头信息 + 一个空行（\r\n） + 数据”。其中，第一行是”协议版本 + 状态码（status code） + 状态描述”。</p>
<h3 id="2-4-Content-Type-字段"><a href="#2-4-Content-Type-字段" class="headerlink" title="2.4 Content-Type 字段"></a>2.4 Content-Type 字段</h3><p>关于字符的编码，1.0 版规定，头信息必须是 ASCII 码，后面的数据可以是任何格式。因此，服务器回应的时候，必须告诉客户端，数据是什么格式，这就是 Content-Type 字段的作用。<br>下面是一些常见的 Content-Type 字段的值。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">text/plain</span><br><span class="line">text/html</span><br><span class="line">text/css</span><br><span class="line">image/jpeg</span><br><span class="line">image/png</span><br><span class="line">image/svg+xml</span><br><span class="line">audio/mp4</span><br><span class="line">video/mp4</span><br><span class="line">application/javascript</span><br><span class="line">application/pdf</span><br><span class="line">application/zip</span><br><span class="line">application/atom+xml</span><br></pre></td></tr></table></figure>

<p>这些数据类型总称为 MIME type，每个值包括一级类型和二级类型，之间用斜杠分隔。<br>除了预定义的类型，厂商也可以自定义类型。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">application / vnd.debian.binary - package</span><br></pre></td></tr></table></figure>

<p>上面的类型表明，发送的是 Debian 系统的二进制数据包。<br>MIME type 还可以在尾部使用分号，添加参数。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Type: text/html; charset=utf-8</span><br></pre></td></tr></table></figure>

<p>上面的类型表明，发送的是网页，而且编码是 UTF-8。<br>客户端请求的时候，可以使用 Accept 字段声明自己可以接受哪些数据格式。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Accept: */*</span><br></pre></td></tr></table></figure>

<p>上面代码中，客户端声明自己可以接受任何格式的数据。<br>MIME type 不仅用在 HTTP 协议，还可以用在其他地方，比如 HTML 网页。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html; charset=UTF-8&quot;</span> /&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 等同于 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-5-Content-Encoding-字段"><a href="#2-5-Content-Encoding-字段" class="headerlink" title="2.5 Content-Encoding 字段"></a>2.5 Content-Encoding 字段</h3><p>由于发送的数据可以是任何格式，因此可以把数据压缩后再发送。Content-Encoding 字段说明数据的压缩方法。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Content-Encoding: gzip</span><br><span class="line">Content-Encoding: compress</span><br><span class="line">Content-Encoding: deflate</span><br></pre></td></tr></table></figure>

<p>客户端在请求时，用 Accept-Encoding 字段说明自己可以接受哪些压缩方法。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Accept-Encoding: gzip, deflate</span><br></pre></td></tr></table></figure>

<h3 id="2-6-缺点"><a href="#2-6-缺点" class="headerlink" title="2.6 缺点"></a>2.6 缺点</h3><p>HTTP/1.0 版的主要缺点是，每个 TCP 连接只能发送一个请求。发送数据完毕，连接就关闭，如果还要请求其他资源，就必须再新建一个连接。<br>TCP 连接的新建成本很高，因为需要客户端和服务器三次握手，并且开始时发送速率较慢（slow start）。所以，HTTP 1.0 版本的性能比较差。随着网页加载的外部资源越来越多，这个问题就愈发突出了。<br>为了解决这个问题，有些浏览器在请求时，用了一个非标准的 Connection 字段。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Connection: keep-alive</span><br></pre></td></tr></table></figure>

<p>这个字段要求服务器不要关闭 TCP 连接，以便其他请求复用。服务器同样回应这个字段。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Connection: keep-alive</span><br></pre></td></tr></table></figure>

<p>一个可以复用的 TCP 连接就建立了，直到客户端或服务器主动关闭连接。但是，这不是标准字段，不同实现的行为可能不一致，因此不是根本的解决办法。</p>
<h2 id="三、HTTP-1-1"><a href="#三、HTTP-1-1" class="headerlink" title="三、HTTP/1.1"></a>三、HTTP/1.1</h2><p>1997 年 1 月，HTTP/1.1 版本发布，只比 1.0 版本晚了半年。它进一步完善了 HTTP 协议，一直用到了 20 年后的今天，直到现在还是最流行的版本。</p>
<h3 id="3-1-持久连接"><a href="#3-1-持久连接" class="headerlink" title="3.1 持久连接"></a>3.1 持久连接</h3><p>1.1 版的最大变化，就是引入了持久连接（persistent connection），即 TCP 连接默认不关闭，可以被多个请求复用，不用声明 Connection: keep-alive。<br>客户端和服务器发现对方一段时间没有活动，就可以主动关闭连接。不过，规范的做法是，客户端在最后一个请求时，发送 Connection: close，明确要求服务器关闭 TCP 连接。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Connection: close</span><br></pre></td></tr></table></figure>

<p>目前，对于同一个域名，大多数浏览器允许同时建立 6 个持久连接。</p>
<h3 id="3-2-管道机制"><a href="#3-2-管道机制" class="headerlink" title="3.2 管道机制"></a>3.2 管道机制</h3><p>1.1 版还引入了管道机制（pipelining），即在同一个 TCP 连接里面，客户端可以同时发送多个请求。这样就进一步改进了 HTTP 协议的效率。<br>举例来说，客户端需要请求两个资源。以前的做法是，在同一个 TCP 连接里面，先发送 A 请求，然后等待服务器做出回应，收到后再发出 B 请求。管道机制则是允许浏览器同时发出 A 请求和 B 请求，但是服务器还是按照顺序，先回应 A 请求，完成后再回应 B 请求。</p>
<h3 id="3-3-Content-Length-字段"><a href="#3-3-Content-Length-字段" class="headerlink" title="3.3 Content-Length 字段"></a>3.3 Content-Length 字段</h3><p>一个 TCP 连接现在可以传送多个回应，势必就要有一种机制，区分数据包是属于哪一个回应的。这就是 Content-length 字段的作用，声明本次回应的数据长度。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Length: 3495</span><br></pre></td></tr></table></figure>

<p>上面代码告诉浏览器，本次回应的长度是 3495 个字节，后面的字节就属于下一个回应了。<br>在 1.0 版中，Content-Length 字段不是必需的，因为浏览器发现服务器关闭了 TCP 连接，就表明收到的数据包已经全了。</p>
<h3 id="3-4-分块传输编码"><a href="#3-4-分块传输编码" class="headerlink" title="3.4 分块传输编码"></a>3.4 分块传输编码</h3><p>使用 Content-Length 字段的前提条件是，服务器发送回应之前，必须知道回应的数据长度。<br>对于一些很耗时的动态操作来说，这意味着，服务器要等到所有操作完成，才能发送数据，显然这样的效率不高。更好的处理方法是，产生一块数据，就发送一块，采用”流模式”（stream）取代”缓存模式”（buffer）。<br>因此，1.1 版规定可以不使用 Content-Length 字段，而使用<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%88%86%E5%9D%97%E4%BC%A0%E8%BE%93%E7%BC%96%E7%A0%81">“分块传输编码”</a>（chunked transfer encoding）。</p>
<blockquote>
<p><strong>分块传输编码</strong>（<strong>Chunked transfer encoding</strong>）是超文本传输协议（HTTP）中的一种数据传输机制，允许<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/HTTP">HTTP</a>由<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%B6%B2%E9%A0%81%E4%BC%BA%E6%9C%8D%E5%99%A8">网页服务器</a>发送给<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%AE%A2%E6%88%B7%E7%AB%AF">客户端</a><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%BA%94%E7%94%A8%E8%BD%AF%E4%BB%B6">应用</a>（ 通常是<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%BD%91%E9%A1%B5%E6%B5%8F%E8%A7%88%E5%99%A8">网页浏览器</a>）的数据可以分成多个部分。分块传输编码只在 HTTP 协议 1.1 版本（HTTP/1.1）中提供。<br>通常，HTTP 应答消息中发送的数据是整个发送的，Content-Length 消息头字段表示数据的长度。数据的长度很重要，因为客户端需要知道哪里是应答消息的结束，以及后续应答消息的开始。然而，使用分块传输编码，数据分解成一系列数据块，并以一个或多个块发送，这样服务器可以发送数据而不需要预先知道发送内容的总大小。通常数据块的大小是一致的，但也不总是这种情况。</p>
</blockquote>
<p>只要请求或回应的头信息有 Transfer-Encoding 字段，就表明回应将由数量未定的数据块组成。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Transfer-Encoding: chunked</span><br></pre></td></tr></table></figure>

<p>每个非空的数据块之前，会有一个 16 进制的数值，表示这个块的长度。最后是一个大小为 0 的块，就表示本次回应的数据发送完了。下面是一个例子。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK Content-Type: text/plain Transfer-Encoding: chunked 25 This is</span><br><span class="line">the data in the first chunk 1C and this is the second one 3 con 8 sequence 0</span><br></pre></td></tr></table></figure>

<h3 id="3-5-其他功能"><a href="#3-5-其他功能" class="headerlink" title="3.5 其他功能"></a>3.5 其他功能</h3><p>1.1 版还新增了许多动词方法：PUT、PATCH、HEAD、OPTIONS、DELETE。<br>另外，客户端请求的头信息新增了 Host 字段，用来指定服务器的域名。</p>
<p>Host: <a target="_blank" rel="noopener" href="http://www.example.com/">www.example.com</a></p>
<p>有了 Host 字段，就可以将请求发往同一台服务器上的不同网站，为虚拟主机的兴起打下了基础。</p>
<h3 id="3-6-缺点"><a href="#3-6-缺点" class="headerlink" title="3.6 缺点"></a>3.6 缺点</h3><p>虽然 1.1 版允许复用 TCP 连接，但是同一个 TCP 连接里面，所有的数据通信是按次序进行的。服务器只有处理完一个回应，才会进行下一个回应。要是前面的回应特别慢，后面就会有许多请求排队等着。这称为<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E9%98%9F%E5%A4%B4%E9%98%BB%E5%A1%9E">“队头堵塞”</a>（Head-of-line blocking）。</p>
<blockquote>
<p><strong>队头阻塞</strong>（英語：<strong>Head-of-line blocking</strong>，缩写：HOL blocking）在<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C">计算机网络</a>的范畴中是一种性能受限的现象。它的原因是一列的第一个数据包（队头）受阻而导致整列数据包受阻。例如它有可能在缓存式输入的交换机中出现，有可能因为传输顺序错乱而出现，亦有可能在 HTTP 流水线中有多个请求的情况下出现。</p>
</blockquote>
<p>为了避免这个问题，只有两种方法：一是减少请求数，二是同时多开持久连接。这导致了很多的网页优化技巧，比如合并脚本和样式表、将图片嵌入 CSS 代码、域名分片（domain sharding）等等。如果 HTTP 协议设计得更好一些，这些额外的工作是可以避免的。</p>
<h2 id="四、SPDY-协议"><a href="#四、SPDY-协议" class="headerlink" title="四、SPDY 协议"></a>四、SPDY 协议</h2><p>2009 年，谷歌公开了自行研发的 SPDY 协议，主要解决 HTTP/1.1 效率不高的问题。<br>这个协议在 Chrome 浏览器上证明可行以后，就被当作 HTTP/2 的基础，主要特性都在 HTTP/2 之中得到继承。</p>
<h2 id="五、HTTP-2"><a href="#五、HTTP-2" class="headerlink" title="五、HTTP/2"></a>五、HTTP/2</h2><p>2015 年，HTTP/2 发布。它不叫 HTTP/2.0，是因为标准委员会不打算再发布子版本了，下一个新版本将是 HTTP/3。</p>
<h3 id="5-1-二进制协议"><a href="#5-1-二进制协议" class="headerlink" title="5.1 二进制协议"></a>5.1 二进制协议</h3><p>HTTP/1.1 版的头信息肯定是文本（ASCII 编码），数据体可以是文本，也可以是二进制。HTTP/2 则是一个彻底的二进制协议，头信息和数据体都是二进制，并且统称为”帧”（frame）：头信息帧和数据帧。<br>二进制协议的一个好处是，可以定义额外的帧。HTTP/2 定义了近十种帧，为将来的高级应用打好了基础。如果使用文本实现这种功能，解析数据将会变得非常麻烦，二进制解析则方便得多。</p>
<h3 id="5-2-多工"><a href="#5-2-多工" class="headerlink" title="5.2 多工"></a>5.2 多工</h3><p>HTTP/2 复用 TCP 连接，在一个连接里，客户端和浏览器都可以同时发送多个请求或回应，而且不用按照顺序一一对应，这样就避免了”队头堵塞”。<br>举例来说，在一个 TCP 连接里面，服务器同时收到了 A 请求和 B 请求，于是先回应 A 请求，结果发现处理过程非常耗时，于是就发送 A 请求已经处理好的部分， 接着回应 B 请求，完成后，再发送 A 请求剩下的部分。<br>这样双向的、实时的通信，就叫做多工（Multiplexing）。</p>
<h3 id="5-3-数据流"><a href="#5-3-数据流" class="headerlink" title="5.3 数据流"></a>5.3 数据流</h3><p>因为 HTTP/2 的数据包是不按顺序发送的，同一个连接里面连续的数据包，可能属于不同的回应。因此，必须要对数据包做标记，指出它属于哪个回应。<br>HTTP/2 将每个请求或回应的所有数据包，称为一个数据流（stream）。每个数据流都有一个独一无二的编号。数据包发送的时候，都必须标记数据流 ID，用来区分它属于哪个数据流。另外还规定，客户端发出的数据流，ID 一律为奇数，服务器发出的，ID 为偶数。<br>数据流发送到一半的时候，客户端和服务器都可以发送信号（RST_STREAM 帧），取消这个数据流。1.1 版取消数据流的唯一方法，就是关闭 TCP 连接。这就是说，HTTP/2 可以取消某一次请求，同时保证 TCP 连接还打开着，可以被其他请求使用。<br>客户端还可以指定数据流的优先级。优先级越高，服务器就会越早回应。</p>
<h3 id="5-4-头信息压缩"><a href="#5-4-头信息压缩" class="headerlink" title="5.4 头信息压缩"></a>5.4 头信息压缩</h3><p>HTTP 协议不带有状态，每次请求都必须附上所有信息。所以，请求的很多字段都是重复的，比如 Cookie 和 User Agent，一模一样的内容，每次请求都必须附带，这会浪费很多带宽，也影响速度。<br>HTTP/2 对这一点做了优化，引入了头信息压缩机制（header compression）。一方面，头信息使用 gzip 或 compress 压缩后再发送；另一方面，客户端和服务器同时维护一张头信息表，所有字段都会存入这个表，生成一个索引号，以后就不发送同样字段了，只发送索引号，这样就提高速度了。</p>
<h3 id="5-5-服务器推送"><a href="#5-5-服务器推送" class="headerlink" title="5.5 服务器推送"></a>5.5 服务器推送</h3><p>HTTP/2 允许服务器未经请求，主动向客户端发送资源，这叫做服务器推送（server push）。<br>常见场景是客户端请求一个网页，这个网页里面包含很多静态资源。正常情况下，客户端必须收到网页后，解析 HTML 源码，发现有静态资源，再发出静态资源请求。其实，服务器可以预期到客户端请求网页后，很可能会再请求静态资源，所以就主动把这些静态资源随着网页一起发给客户端了。</p>
<h2 id="六、HTTP-3"><a href="#六、HTTP-3" class="headerlink" title="六、HTTP/3"></a>六、HTTP/3</h2><p>上节提到 HTTP3 通过更加底层的传输层的优化来提升效率，究竟如何，让我们一起看一下。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/190217/1618647942864-a92110af-72e7-4444-ab69-eef754081c84.png#clientId=ua837cce1-549d-4&from=paste&height=618&id=ubccf37cc&margin=%5Bobject%20Object%5D&originHeight=618&originWidth=1200&originalType=binary&size=385379&status=done&style=none&taskId=uc82c80a2-2c7f-4eaf-82e6-29a3710c0eb&width=1200"><br>通过这个图片，我们可以很清楚的看到，HTTP2 和 HTTP3 的传输层是完全不同的协议，HTTP3 的传输层是 UDP 协议。我们知道 UDP 协议是个不可靠的协议，而 TCP 协议是可靠协议，怎样保证可靠的呢，重传。</p>
<h3 id="QUIC-协议"><a href="#QUIC-协议" class="headerlink" title="QUIC 协议"></a>QUIC 协议</h3><p>在 UDP 协议之上，新增了 QUIC 协议。我的理解是由于 TCP 协议相对于 UDP 协议控制比较复杂耗时，因此针对 HTTP 应用贴身开发了 QUIC 协议代替 TCP 协议中关于可靠、流量控制的部分。</p>
<ul>
<li><p>QUIC 协议特性</p>
<ul>
<li>QUIC 协议提供类似于 HTTP2 的流功能</li>
<li>QUIC 协议使用流 ID 取代 IP 和端口，这样就能实现连接迁移。例如说从 4G 信号切换到 wifi，下层的 IP 和端口变了，但是由于 QUIC 的流 ID 没有变，这个连接不会变，可以继续使用这个连接。</li>
</ul>
</li>
</ul>
<p>然后我们看一下 HTTP3 在 QUIC 上有什么变化呢？HTTP3 由 HTTP2 进化，HTTP2 最大的变化就是基于二进制流的传输。那么到 HTTP3，由于 QUIC 已经管理了流，HTTP3 本身就减负了，将流管理下移 QUIC，而本身就直接调用 QUIC 的接口就可以了。</p>
<h3 id="HTTP3-如何工作"><a href="#HTTP3-如何工作" class="headerlink" title="HTTP3 如何工作"></a>HTTP3 如何工作</h3><ul>
<li>我们回想一下 HTTPS，HTTPS 是类似于 TCP 握手的工作方式，先工作在 HTTP1 上，通过 HTTP1 传递交换得到秘钥，然后切换到 HTTPS 上工作。</li>
<li>接着我们回想一下 HTTP2，HTTP2 也是基于 TLS 的，所以 HTTP2 的工作方式和 HTTPS 也是同样的过程，需要握手建立 TLS 连接，只是 TLS 连接完成后，发送一个 HTTP2 的连接确认消息，确认后，客户端服务器使用 HTTP2 进行连接通讯。</li>
<li>最后让我们看下 HTTP3 如何工作。首先要建立好 HTTP2 连接，然后发送 HTTP2 扩展帧，这个帧包含 IP 和端口，浏览器收到扩展帧，使用该 IP 和端口，使用 QUIC 建立连接，如果成功，断开 HTTP2，升级为 HTTP3。</li>
</ul>
<p>这三者，都用 TCP 的握手协议去理解，都是握手，不同的是握手方式不一样。</p>
<h1 id="七、参考链接"><a href="#七、参考链接" class="headerlink" title="七、参考链接"></a>七、参考链接</h1><ul>
<li><a target="_blank" rel="noopener" href="http://kamranahmed.info/blog/2016/08/13/http-in-depth/">Journey to HTTP/2</a>, by Kamran Ahmed</li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol">HTTP</a>, by Wikipedia</li>
<li><a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc1945">HTTP/1.0 Specification</a></li>
<li><a target="_blank" rel="noopener" href="https://http2.github.io/http2-spec/">HTTP/2 Specification</a></li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2021/04/17/yuque/HTTP%20%E5%8D%8F%E8%AE%AE%E5%85%A5%E9%97%A8%EF%BC%88HTTP0.9-HTTP!3%EF%BC%89/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-yuque/《代码整洁之道》" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/15/yuque/%E3%80%8A%E4%BB%A3%E7%A0%81%E6%95%B4%E6%B4%81%E4%B9%8B%E9%81%93%E3%80%8B/">《代码整洁之道》</a>
    </h1>
  

        
        <a href="/2021/03/15/yuque/%E3%80%8A%E4%BB%A3%E7%A0%81%E6%95%B4%E6%B4%81%E4%B9%8B%E9%81%93%E3%80%8B/" class="archive-article-date">
  	<time datetime="2021-03-15T18:57:25.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2021-03-15</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id=""><a href="#" class="headerlink" title=""></a></h1><h2 id="代码猴子与童子军军规"><a href="#代码猴子与童子军军规" class="headerlink" title="代码猴子与童子军军规"></a>代码猴子与童子军军规</h2><ol>
<li>我们就像一群代码猴子，上蹿下跳，自以为领略了编程的真谛。可惜，当我们抓着几个酸桃子，得意洋洋坐到树枝上，却对自己造成的混乱熟视无睹。那堆“可以运行”的乱麻程序，就在我们的眼皮底下慢慢腐坏。</li>
</ol>
<h2 id="第一章-整洁代码"><a href="#第一章-整洁代码" class="headerlink" title="第一章 整洁代码"></a>第一章 整洁代码</h2><ol>
<li>勒布朗法则：稍后等于永不（Later equals never）。</li>
<li>制造混乱无助于赶上期限。混乱只会立刻拖慢你，叫你错过期限。赶上期限的唯一方法——做的快的唯一方法——就是始终尽可能保持代码整洁。</li>
<li>Javadoc 中的 <code>@author</code> 字段告诉我们自己是什么人。我们是作者，作者都有读者。实际上，作者有责任与读者做良好沟通。下次你写代码的时候，记得自己是作者，要为评判你工作的读者写代码。</li>
</ol>
<h2 id="第三章-函数"><a href="#第三章-函数" class="headerlink" title="第三章 函数"></a>第三章 函数</h2><ol>
<li>函数的第一规则是要短小。第二条规则是还要更短小…经过漫长的试错，经验告诉我，函数就该小。</li>
<li>函数应该做一件事。做好这件事。只做这一件事。判断函数是否不止做了一件事，有一个方法，就是看是否能再拆出一个函数，该函数不仅只是单纯地重新诠释其实现。</li>
<li>要确保函数只做一件事，函数中的语句都要在同一抽象层级上。函数中混杂不同的抽象层级，往往让人迷惑。读者可能无法判断某个表达式是基础概念还是细节。更恶劣的是，就像破损的窗户，一旦细节与基础概念混杂，更多的细节就会在函数中纠结起来。</li>
<li>写出短小的 <code>switch</code> 语句往往很难。写出只做一件事的 <code>switch</code> 语句也很难。我们总不发避开 <code>switch</code> 语句，不过还是能够确保 <code>switch</code> 都埋藏在较低的抽象层级，而且永远不重复。</li>
<li>最理想的参数数量是零，其次是一，再次是二…从测试的角度看，参数甚至更叫人为难。想想看，要编写能确保参数的各种组合运行正常的测试用例，是多么困难的事。如果没有参数，就是小菜一碟。</li>
<li>函数承诺只做一件事，但还是会做其它被藏起来的事。有时，它会对自己类中的变量做出未能预期的改动，导致古怪的时序性耦合及顺序依赖。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserValidator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Cryptographer cryptographer;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkPassword</span><span class="params">(String userName, String password)</span> </span>&#123;</span><br><span class="line">        User user = UserGateway.findByName(userName);</span><br><span class="line">        <span class="keyword">if</span> (user != <span class="keyword">null</span>) &#123;</span><br><span class="line">            String codePhrase = user.getPhraseEncodeByPassword();</span><br><span class="line">            String phrase = cryptographer.decrypt(codePhrase, password);</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;Valid Password&quot;</span>.equals(phrase)) &#123;</span><br><span class="line">                Session.initialize();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>副作用就在于对 <code>Session.initialize()</code> 的调用。<code>checkPassword</code> 函数是用来检查密码的。该名称未暗示它会初始化该次会话。当某个误信了函数名的调用者想要检查用户有效性时，就得冒着抹除现有会话数据的风险。这一副作用造成了一次时序性耦合。也就是说，<code>checkPassword</code> 只能在特定时刻调用。</p>
<h2 id="第四章-注释"><a href="#第四章-注释" class="headerlink" title="第四章 注释"></a>第四章 注释</h2><ol>
<li>注释的恰当用法是弥补我们在用代码表达意图时遭遇的失败。注释总是一种失败。我们总无法找到不用注释就能表达自我的方法，所以总要有注释，这并不值得庆贺。</li>
<li>如果你发现自己需要写注释，再想想看是否有办法翻盘，用代码来表达。</li>
<li>有时，有理由用 <code>// TODO</code> 形式在源代码中放置要做的工作列表。<code>TODO</code> 是一种程序员认为应该做，但由于某些原因目前还没做的工作。</li>
<li>没有什么比被良好描述的公共 API 更有用和令人满意的了。如果你在编写公共 API，就该为它编写良好的 Javadoc。</li>
<li>删掉无用而多余的 Javadoc 吧，这些注释只是一味将代码搞得含糊不明，完全没有文档上的价值。</li>
<li>所谓每个函数都要有 Javadoc 或每个变量都要有注释的规矩全然是愚蠢可笑的。这类注释徒然让代码变得散乱，满口胡言，令人迷惑不解。</li>
<li>20 世纪 60 年代，曾经有那么一段时间，注释掉的代码可能有用。但我们已经拥有优良的源代码控制系统如此之久，这些系统可以为我们记住不要的代码。我们无需再用注释来标记，删掉即可，它们丢不了，我担保。</li>
</ol>
<h2 id="第五章-格式"><a href="#第五章-格式" class="headerlink" title="第五章 格式"></a>第五章 格式</h2><ol>
<li>代码格式很重要，必须严肃对待。代码格式关乎沟通，而沟通是专业开发者的头等大事。</li>
<li>你今天编写的功能，极有可能在下一版本中被修改，但代码的可读性却会对以后可能发生的修改行为产生深远影响。原始代码修改之后很久，其代码风格和可读性仍会影响到可维护性和扩展性。即便代码不复存在，你的风格和律条仍会存活下来。</li>
<li>若某个函数调用了另外一个，就应该把它们放在一起，而且调用者应该尽可能放在被调用者上面。</li>
</ol>
<h2 id="第六章-对象和数据结构"><a href="#第六章-对象和数据结构" class="headerlink" title="第六章 对象和数据结构"></a>第六章 对象和数据结构</h2><ol>
<li>最为精炼的数据结构，是一个只有公共变量、没有函数的类。这种数据结构有时被称为数据传送对象，或 <code>DTO</code>（Data Transfer Objects）。DTO 是非常有用的结构，尤其是在于数据库通信、或解析套接字传输的消息之类的场景中。</li>
</ol>
<h2 id="第七章-使用异常而非返回码"><a href="#第七章-使用异常而非返回码" class="headerlink" title="第七章 使用异常而非返回码"></a>第七章 使用异常而非返回码</h2><ol>
<li>在很久以前，许多语言都不支持异常。这些语言处理和汇报错误的手段都有限。你要么设置一个错误标识，要么返回给调用者检查的错误码。这类手段的问题在于，它们搞乱了调用者代码。调用者必须在调用之后即可检查错误。不幸的是，这个步骤很容易被遗忘。最好是抛出一个异常，这样其逻辑不会被错误处理搞乱。</li>
<li>使用不可控异常。可控异常 <code>checked exception</code> 的代价是违反开闭原则。如果你在方法中抛出可控异常，而 catch 语句在三个层级之上，你就得在 catch 语句和抛出异常处之间的每个方法签名中声明该异常。这意味着对软件中低层级的修改，都将涉及较高层级的签名。最终得到的就是一个从软件最底端贯穿到最高端的修改链。</li>
<li>别返回 null 值。我不想去计算曾经见过多少每行代码都在检查 null 值的应用程序。Java 中有 <code>Colletions.emptyList()</code> 方法，该方法返回一个预定义不可变列表，这样编码，就能尽量避免 <code>NullPointerException</code> 的出现，代码也就更整洁了。</li>
<li>别传递 null 值。在大多数编程语言中，没有良好的方法能对付由调用者意外传入 null 值。事已如此，恰当的做法就是禁止传入 null 值。</li>
</ol>
<h2 id="第八章-边界"><a href="#第八章-边界" class="headerlink" title="第八章 边界"></a>第八章 边界</h2><ol>
<li>第三方代码帮助我们在更少时间内发布更丰富的功能。在利用第三方程序包时，该从何处入手呢？我们没有测试第三方代码的职责，但为要使用的第三方代码编写测试，可能最符合我们的利益。</li>
<li>学习第三方代码很难，整合第三方代码也很难，同时做这两件事难上加难。不要在生产代码中试验新东西，而是编写测试来遍览和理解第三方代码，这叫“学习性测试”。</li>
</ol>
<h2 id="第九章-单元测试"><a href="#第九章-单元测试" class="headerlink" title="第九章 单元测试"></a>第九章 单元测试</h2><ol>
<li>TDD 三定律：<ul>
<li><strong>定律一</strong> 在编写不能通过的单元测试前，不可编写生产代码。</li>
<li><strong>定律二</strong> 只可编写刚好无法通过的单元测试，不能编译也算不通过。</li>
<li><strong>定律三</strong> 只可编写刚好足以通过当前失败测试的生产代码。</li>
</ul>
</li>
<li>TDD 三定律其实说的是，先写失败的 Case，写完之后才开始写功能 Code，只要 Code 通过了 Case，就不要再写功能代码了。也就是说，写完一个测试，就要写对应的生产代码。</li>
<li>测试代码和生产代码一样重要。它可不是二等公民。它需要被思考、被设计和被照料。它该像生产代码一般保持整洁。</li>
<li>如果测试不能保持整洁，你就会失去它们。没有了测试，你就会失去保证生产代码可扩展的一切要素。有了测试，你就不担心对代码的修改！没有测试，每次修改都可能带来缺陷。</li>
<li>覆盖了生产代码的自动化单元测试程序组能尽可能地保持设计和架构的整洁。测试带来了一切好处，因为测试使改动变得可能。</li>
<li>整洁的测试有三个要素：可读性、可读性、可读性。测试应该明确、简洁，还有足够的表达力。在测试中，要以尽量少的文字表达大量的内容。</li>
<li>F.I.R.S.T 规则：<ul>
<li><strong>Fast</strong>（快速） 测试应该能快速运行。测试运行缓慢，你就不会想要频繁地运行它。如果你不频繁运行测试，就不能尽早发现问题，也无法轻易修正。</li>
<li><strong>Independent</strong>（独立） 测试应该相互独立。某个测试不应为下一个测试设定条件。你应该可以单独运行每个测试，及以任何顺序运行测试。</li>
<li><strong>Repeatable</strong>（可重复） 测试应当可在任何环境中重复通过。</li>
<li><strong>Self-Validating</strong> （自足验证） 测试应该有布尔值输出。</li>
<li><strong>Timely</strong>（及时） 测试应及时编写。单元测试应该恰好在使其通过的生产代码之前编写。</li>
</ul>
</li>
</ol>
<h2 id="第十章-类"><a href="#第十章-类" class="headerlink" title="第十章 类"></a>第十章 类</h2><ol>
<li>面向对象的其中一个设计原则是“开放——闭合原则”，即类应当对扩展开放，对修改封闭。我们希望将系统打造成在添加或修改特性时尽可能少惹麻烦的架子。在理想系统中，我们通过扩展系统而不是修改现有代码来添加新特性。</li>
<li>类的另一条设计原则是“依赖倒置原则”（Dependency Inversion Principle, DIP），DIP 认为类应该依赖于抽象而不是依赖于具体细节。</li>
</ol>
<h2 id="第十一章-系统"><a href="#第十一章-系统" class="headerlink" title="第十一章 系统"></a>第十一章 系统</h2><ol>
<li>有一种强大的机制可以实现分离构造与使用，那就是依赖注入（Dependency Injection, DI），它是控制反转（Inversion of Control, IoC）在依赖管理中的一种应用手段。控制反转将第二权责从对象中拿出来，转移到另一个专注于此的对象中，从而遵循了<strong>单一权责原则</strong>。在依赖管理情境中，对象不应负责实体化对自身的依赖，而应当将这份权责移交给其它“有权力”的机制，从而实现控制的反转。</li>
<li>“一开始就做对系统”纯属神话。反之，我们应该只去实现今天的用户故事，然后重构，明天再扩展系统、实现新的用户故事。这就是迭代和增量敏捷的精髓所在。</li>
</ol>
<h2 id="第十二章-迭进"><a href="#第十二章-迭进" class="headerlink" title="第十二章 迭进"></a>第十二章 迭进</h2><ol>
<li>简单设计的四条规则，按重要程度排序：<ul>
<li>运行所有测试；</li>
<li>不可重复；</li>
<li>表达了程序员的意图；</li>
<li>尽可能减少类和方法的数量。</li>
</ul>
</li>
<li>全面测试并持续通过所有测试的系统，就是可测试的系统。看似浅显，但却重要。不可测试的系统同样不可验证。不可验证的系统，绝不应该部署。</li>
<li>重复是拥有良好设计系统的大敌，它代表着额外的工作、额外的风险和额外且不必要的复杂度。要想创建整洁的系统，需要有消除重复的意愿。</li>
<li>软件项目的主要成本在于长期维护。代码应当清晰地表达其作者的意图。作者把代码写得越清晰，其他人花在理解代码上的时间也就越少，从而减少缺陷，缩减维护成本。</li>
<li>为了保持类和函数短小，我们可能会造出太多的细小类和方法。所以这条规则也主张函数和类的数量要少。我们的目标是在保持函数和类短小的同时，保持整个系统短小精悍。不过更重要的是测试、消除重复和表达力。</li>
</ol>
<h2 id="第十三章-并发编程"><a href="#第十三章-并发编程" class="headerlink" title="第十三章 并发编程"></a>第十三章 并发编程</h2><ol>
<li>并发是一种解耦策略。它帮助我们把<strong>做什么</strong>（目的）和<strong>何时做</strong>（时机）分解开。解耦目的与时机能明显地改进应用程序的吞吐量和结构。</li>
<li>并发有时能改进性能，但只在多个线程或处理器之间能分享大量等待时间的时候管用，事情没那么简单。</li>
<li>并发算法的设计有可能与单线程系统的设计极不相同。目的与时机的解耦往往对系统结构产生巨大影响。</li>
<li>并发编程中的一些基础定义：<ul>
<li><strong>限定资源</strong>：并发环境中有着固定尺寸或数量的资源。</li>
<li><strong>互斥</strong>：每一时刻仅有一个线程能访问共享数据或共享资源。</li>
<li><strong>线程饥饿</strong>：一个或一组线程在很长时间内或永久被禁止。例如，总是让执行得快的线程先运行，加入执行得快得线程没完没了，则执行时间长的线程就会“饥饿”。</li>
<li><strong>死锁</strong>：两个或多个线程互相等待执行结束。每个线程都拥有其它线程需要的资源，得不到其它线程拥有的资源，就无法终止。</li>
<li><strong>活锁</strong>：执行次序一致的线程，每个都想要起步，但发现其它线程已经“在路上”。由于竞步的原因，线程会持续尝试起步，但在很长时间内却无法如愿，甚至永远无法启动。</li>
</ul>
</li>
</ol>
<h2 id="第十四章-逐步改进"><a href="#第十四章-逐步改进" class="headerlink" title="第十四章 逐步改进"></a>第十四章 逐步改进</h2><ol>
<li>代码能工作还不够，能工作的代码经常会严重崩溃。满足于仅仅让代码工作的程序员不够专业。他们会害怕没时间改进代码的结构和设计，我不敢苟同。没什么比糟糕的代码给开发项目带来更深远和长期的损害了。</li>
<li>进度可以重订，需求可以重新定义，团队动态可以修正。糟糕的代码只会一直腐败发酵，无情地拖着团队的后腿。</li>
<li>保持代码持续整洁和简单，永不让腐坏有机会开始。</li>
</ol>
<h2 id="第十五章-JUnit-框架"><a href="#第十五章-JUnit-框架" class="headerlink" title="第十五章 JUnit 框架"></a>第十五章 JUnit 框架</h2><ol>
<li>成员变量的前缀可以删除。在现今的运行环境中，这类范围性编码纯属多余。</li>
<li>条件判断应当封装起来，从而更清晰地表达代码的意图。可以拆解处一个方法，解释这个条件判断。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">compact</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (expected == <span class="keyword">null</span> || actual == <span class="keyword">null</span> || areStringsEqual()) &#123;</span><br><span class="line">        <span class="keyword">return</span> Assert.format(message, expected, actual);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 拆解后...</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">compact</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (shouldNotCompact()) &#123;</span><br><span class="line">        <span class="keyword">return</span> Assert.format(message, expected, actual);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">shouldNotCompact</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> expected == <span class="keyword">null</span> || actual == <span class="keyword">null</span> || areStringsEqual();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="第十七章-味道与启发"><a href="#第十七章-味道与启发" class="headerlink" title="第十七章 味道与启发"></a>第十七章 味道与启发</h2><ol>
<li>让注释传达本该更好地在源代码控制系统、问题追踪系统或任何其它记录系统中保存的信息，是不恰当的。</li>
<li>除函数签名之外什么也没说的 Javadoc，也是多余的。</li>
<li>看到注释掉的代码，就删除它！别担心，源代码控制系统还会记得它。</li>
<li>每次看到重复代码，都代表遗漏了抽象。将重复代码叠放进类似的抽象，增加了你的设计语言的词汇量。其它程序员可以用到你创建的抽象设施。编码变得越来越快，错误越来越少，因为你提升了抽象层级。</li>
<li>死代码就是不执行的代码，可以在检查不会发生的条件的 if 语句中找到，可以在从不抛出异常的 try/catch 块中找到，可以在从不调用的小工具方法中找到，也可以在不会发生 switch/case 条件中找到。如果你找到死代码，就体面地埋葬它，将它从系统中删除掉。</li>
<li>特性依恋是 Martin Fowler 提出的代码味道之一。类的方法只应对其所属类中的变量和函数感兴趣，不该垂青其它类中的变量和函数。我们要消除特性依恋。</li>
<li>用多态替代 if/else 或 switch/case。对于给定的选择类型，不应有多于一个 switch 语句。在那个 switch 语句中的多个 case，必须创建多态对象，取代系统中其它类似 switch 语句。</li>
<li>用命名常量替代魔术数。</li>
<li>现在 enum 已经加入 java 语言了，放心用吧！别再用那个 <code>public static final int</code> 老花招。那样做 int 的意义就丧失了，而用 enum 则不然，因为它们隶属于有名称的枚举。</li>
</ol>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2021/03/15/yuque/%E3%80%8A%E4%BB%A3%E7%A0%81%E6%95%B4%E6%B4%81%E4%B9%8B%E9%81%93%E3%80%8B/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-yuque/深挖 Redis 6.0 源码——SDS" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/15/yuque/%E6%B7%B1%E6%8C%96%20Redis%206.0%20%E6%BA%90%E7%A0%81%E2%80%94%E2%80%94SDS/">深挖 Redis 6.0 源码——SDS</a>
    </h1>
  

        
        <a href="/2021/03/15/yuque/%E6%B7%B1%E6%8C%96%20Redis%206.0%20%E6%BA%90%E7%A0%81%E2%80%94%E2%80%94SDS/" class="archive-article-date">
  	<time datetime="2021-03-15T18:53:59.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2021-03-15</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>SDS（Simple Dynamic Strings, 简单动态字符串）是 Redis 的一种基本数据结构，主要是用于存储字符串和整数。</strong> 这篇文章里，我们就来探讨一下 Redis SDS 这种数据结构的底层实现原理。</p>
<p>学习之前，首先我们要明确，Redis 是一个<strong>使用 C 语言编写的键值对存储系统</strong>。</p>
<h2 id="前置思考"><a href="#前置思考" class="headerlink" title="前置思考"></a>前置思考</h2><p>我们首先考虑一个问题，如何实现一个二进制安全的字符串？</p>
<p>在 C 语言中，<code>\0</code> 表示字符串结束，如果字符串中本身就包含 <code>\0</code> 字符，那么字符串就会在 <code>\0</code> 处被截断，即非二进制安全；若通过使用一个 len 属性，来判断字符串是否结束，就可以保证读写字符串时不受到 <code>\0</code> 的影响，则是二进制安全。同时 len 属性也能保证在 O(1) 时间内获取字符串的长度。</p>
<h2 id="Redis-3-2-以前的-SDS-实现"><a href="#Redis-3-2-以前的-SDS-实现" class="headerlink" title="Redis 3.2 以前的 SDS 实现"></a>Redis 3.2 以前的 SDS 实现</h2><p>在 Redis 3.2 版本以前，SDS 的结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sdshdr</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> len;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="built_in">free</span>;</span><br><span class="line">    <span class="keyword">char</span> buf[];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>其中，<strong>buf 表示数据空间，用于存储字符串；len 表示 buf 中已占用的字节数，也即字符串长度；free 表示 buf 中剩余可用字节数。</strong></p>
<p>字段 len 和 free 各占 4 字节，紧接着存放字符串。</p>
<p>这样做有以下几个好处：</p>
<ul>
<li>用单独的变量 len 和 free，可以<strong>方便地获取字符串长度和剩余空间</strong>；</li>
<li>内容存储在动态数组 buf 中，<strong>SDS 对上层暴露的指针指向 buf，而不是指向结构体 SDS</strong>。因此，上层可以像读取 C 字符串一样读取 SDS 的内容，兼容 C 语言处理字符串的各种函数，同时也能通过 buf 地址的偏移，方便地获取其他变量；</li>
<li>读写字符串不依赖于 <code>\0</code>，保证<strong>二进制安全</strong>。</li>
</ul>
<p>但其实以上的设计是存在一些问题的，对于不同长度的字符串，是否有必要使用 len 和 free 这 2 个 4 字节的变量？4 字节的 len，可表示的字符串长度为 <code>2^32</code>，而在实际应用中，存放于 Redis 中的字符串往往没有这么长，因此，空间的使用上能否进一步压缩？</p>
<p>那么接下来，我们就来看看最新的 Redis 是<strong>如何根据字符串的长度，使用不同的数据结构进行存储的</strong>。</p>
<h2 id="Redis-SDS-最新实现"><a href="#Redis-SDS-最新实现" class="headerlink" title="Redis SDS 最新实现"></a>Redis SDS 最新实现</h2><p>在 Redis 3.2 版本之后（v3.2 - v6.0），Redis 将 SDS 划分为 5 种类型：</p>
<ul>
<li>sdshdr5：长度小于 1 字节</li>
<li>sdshdr8：长度 1 字节</li>
<li>sdshdr16：长度 2 字节</li>
<li>sdshdr32：长度 4 字节</li>
<li>sdshdr64：长度 8 字节</li>
</ul>
<p>Redis 增加了一个 flags 字段来标识类型，用一个字节(8 位)来存储。</p>
<p>其中：前 3 位表示字符串的类型；剩余 5 位，可以用来存储长度小于 32 的短字符串。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">sdshdr5</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> flags; <span class="comment">/* 前3位存储类型，后5位存储长度 */</span></span><br><span class="line">    <span class="keyword">char</span> buf[]; <span class="comment">/* 动态数组，存放字符串 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>而对于长度大于 31 的字符串，仅仅靠 flags 的后 5 位来存储长度明显是不够的，需要用另外的变量来存储。sdshdr8、sdshdr16、sdshdr32、sdshdr64 的数据结构定义如下，其中 len 表示已使用的长度，alloc 表示总长度，buf 存储实际内容，而 flags 的前 3 位依然存储类型，后 5 位则预留。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">sdshdr8</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint8_t</span> len; <span class="comment">/* 已使用长度，1字节 */</span></span><br><span class="line">    <span class="keyword">uint8_t</span> alloc; <span class="comment">/* 总长度，1字节 */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> flags; <span class="comment">/* 前3位存储类型，后5位预留 */</span></span><br><span class="line">    <span class="keyword">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">sdshdr16</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint16_t</span> len; <span class="comment">/* 已使用长度，2字节 */</span></span><br><span class="line">    <span class="keyword">uint16_t</span> alloc; <span class="comment">/* 总长度，2字节 */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> flags; <span class="comment">/* 前3位存储类型，后5位预留 */</span></span><br><span class="line">    <span class="keyword">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">sdshdr32</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> len; <span class="comment">/* 已使用长度，4字节 */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> alloc; <span class="comment">/* 总长度，4字节 */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> flags; <span class="comment">/* 前3位存储类型，后5位预留 */</span></span><br><span class="line">    <span class="keyword">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">sdshdr64</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> len; <span class="comment">/* 已使用长度，8字节 */</span></span><br><span class="line">    <span class="keyword">uint64_t</span> alloc; <span class="comment">/* 总长度，8字节 */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> flags; <span class="comment">/* 前3位存储类型，后5位预留 */</span></span><br><span class="line">    <span class="keyword">char</span> buf[];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>注意，一般情况下，结构体会按照所有变量大小的最小公倍数做字节对齐，而用 <code>packed</code> 修饰后，结构体则变为 1 字节对齐。这样做的好处有二：一是<strong>节省内存</strong>，比如 sdshdr32 可节约 3 个字节；二是 <strong>SDS 返回给上层的是指向 buf 的指针，此时按 1 字节对齐，所以可在创建 SDS 后，通过 <code>(char*)sh+hdrlen</code> 得到 buf 指针地址，也可以通过 <code>buf[-1]</code> 找到 flags</strong>。</p>
<p>以上，Redis 根据字符串长度的不同，选择对应的数据结构进行存储。接下来，我们就来看看 Redis 字符串的相关 API 实现。</p>
<h2 id="SDS-API-实现"><a href="#SDS-API-实现" class="headerlink" title="SDS API 实现"></a>SDS API 实现</h2><h3 id="1-创建字符串"><a href="#1-创建字符串" class="headerlink" title="1. 创建字符串"></a>1. 创建字符串</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">sds <span class="title">sdsnewlen</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *init, <span class="keyword">size_t</span> initlen)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">void</span> *sh;</span><br><span class="line">    sds s;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据字符串长度计算相应类型</span></span><br><span class="line">    <span class="keyword">char</span> type = sdsReqType(initlen);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果创建的是&quot;&quot;字符串，强转为SDS_TYPE_8</span></span><br><span class="line">    <span class="keyword">if</span> (type == SDS_TYPE_5 &amp;&amp; initlen == <span class="number">0</span>) type = SDS_TYPE_8;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据类型计算头部所需长度（头部包含 len、alloc、flags）</span></span><br><span class="line">    <span class="keyword">int</span> hdrlen = sdsHdrSize(type);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 指向flags的指针</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *fp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建字符串，+1是因为 `\0` 结束符</span></span><br><span class="line">    sh = s_malloc(hdrlen+initlen+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (sh == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (init==SDS_NOINIT)</span><br><span class="line">        init = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!init)</span><br><span class="line">        <span class="built_in">memset</span>(sh, <span class="number">0</span>, hdrlen+initlen+<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// s指向buf</span></span><br><span class="line">    s = (<span class="keyword">char</span>*)sh+hdrlen;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// s减1得到flags</span></span><br><span class="line">    fp = ((<span class="keyword">unsigned</span> <span class="keyword">char</span>*)s)<span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在s末尾添加\0结束符</span></span><br><span class="line">    s[initlen] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回指向buf的指针s</span></span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建 SDS 的大致流程是这样的：首先根据字符串长度计算得到 type，根据 type 计算头部所需长度，然后动态分配内存空间。</p>
<p>注意：</p>
<ol>
<li>创建空字符串时，<code>SDS_TYPE_5</code> 被强制转换为 <code>SDS_TYPE_8</code>（原因是创建空字符串后，内容可能会频繁更新而引发扩容操作，故直接创建为 sdshdr8）</li>
<li>长度计算有 <code>+1</code> 操作，因为结束符 <code>\0</code> 会占用一个长度的空间。</li>
<li>返回的是指向 buf 的指针 s。</li>
</ol>
<h3 id="2-清空字符串"><a href="#2-清空字符串" class="headerlink" title="2. 清空字符串"></a>2. 清空字符串</h3><p>SDS 提供了两种清空字符串的方法。</p>
<p>一种是通过 s 偏移得到结构体的地址，然后调用 <code>s_free</code> 直接释放内存。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sdsfree</span><span class="params">(sds s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (s == <span class="literal">NULL</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// s减去头部的大小得到结构体的地址</span></span><br><span class="line">    s_free((<span class="keyword">char</span>*)s-sdsHdrSize(s[<span class="number">-1</span>]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另一种是通过重置 len 属性值而达到清空字符串的目的，本质上 buf 并没有被真正清除，新的数据会直接覆盖 buf 中原有的数据，无需申请新的内存空间。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sdsclear</span><span class="params">(sds s)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将len属性置为0</span></span><br><span class="line">    sdssetlen(s, <span class="number">0</span>);</span><br><span class="line">    s[<span class="number">0</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-拼接字符串"><a href="#3-拼接字符串" class="headerlink" title="3. 拼接字符串"></a>3. 拼接字符串</h3><p>SDS 拼接字符串的实现如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">sds <span class="title">sdscatsds</span><span class="params">(sds s, <span class="keyword">const</span> sds t)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sdscatlen(s, t, sdslen(t));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到 <code>sdscatsds</code> 内部调用的是 <code>sdscatlen</code>。</p>
<p>而 <code>sdscatlen</code> 内部的实现相对复杂一些，由于拼接字符串可能涉及 SDS 的扩容，因此 <code>sdscatlen</code> 内部调用 <code>sdsMakeRoomFor</code> 对拼接的字符串做检查：若无需扩容，直接返回 s；若需要扩容，则返回扩容好的新字符串 s。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">sds <span class="title">sdscatlen</span><span class="params">(sds s, <span class="keyword">const</span> <span class="keyword">void</span> *t, <span class="keyword">size_t</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 计算当前字符串长度</span></span><br><span class="line">    <span class="keyword">size_t</span> curlen = sdslen(s);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 确保s的剩余空间足以拼接上t</span></span><br><span class="line">    s = sdsMakeRoomFor(s,len);</span><br><span class="line">    <span class="keyword">if</span> (s == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拼接s、t</span></span><br><span class="line">    <span class="built_in">memcpy</span>(s+curlen, t, len);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新s的len属性</span></span><br><span class="line">    sdssetlen(s, curlen+len);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// s末尾添加\0结束符</span></span><br><span class="line">    s[curlen+len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SDS 的扩容策略是这样的：</p>
<ol>
<li>若 SDS 中剩余空闲长度 avail 大于或等于新增内容的长度 addlen，无需扩容。</li>
<li>若 SDS 中剩余空闲长度 avail 小于或等于 addlen，则分情况讨论：新增后总长度 <code>len+addlen &lt; 1MB</code> 的，按新长度的 2 倍扩容；新增后总长度 <code>len+addlen &gt;= 1MB</code> 的，按新长度加上 <code>1MB</code> 扩容。</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">sds <span class="title">sdsMakeRoomFor</span><span class="params">(sds s, <span class="keyword">size_t</span> addlen)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">void</span> *sh, *newsh;</span><br><span class="line">    <span class="comment">// 当前剩余长度</span></span><br><span class="line">    <span class="keyword">size_t</span> avail = sdsavail(s);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> len, newlen;</span><br><span class="line">    <span class="keyword">char</span> type, oldtype = s[<span class="number">-1</span>] &amp; SDS_TYPE_MASK;</span><br><span class="line">    <span class="keyword">int</span> hdrlen;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 剩余长度&gt;=新增字符串长度，直接返回 */</span></span><br><span class="line">    <span class="keyword">if</span> (avail &gt;= addlen) <span class="keyword">return</span> s;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算当前字符串长度len</span></span><br><span class="line">    len = sdslen(s);</span><br><span class="line"></span><br><span class="line">    sh = (<span class="keyword">char</span>*)s-sdsHdrSize(oldtype);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算新长度</span></span><br><span class="line">    newlen = (len+addlen);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 新长度&lt;1MB，按新长度的2倍扩容</span></span><br><span class="line">    <span class="keyword">if</span> (newlen &lt; SDS_MAX_PREALLOC)</span><br><span class="line">        newlen *= <span class="number">2</span>;</span><br><span class="line">    <span class="comment">// 否则按新长度+1MB扩容</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        newlen += SDS_MAX_PREALLOC;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算新长度所属类型</span></span><br><span class="line">    type = sdsReqType(newlen);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* type5不支持扩容，强转为type8 */</span></span><br><span class="line">    <span class="keyword">if</span> (type == SDS_TYPE_5) type = SDS_TYPE_8;</span><br><span class="line"></span><br><span class="line">    hdrlen = sdsHdrSize(type);</span><br><span class="line">    <span class="keyword">if</span> (oldtype==type) &#123;</span><br><span class="line">        <span class="comment">// 类型没变，直接通过realloc扩大动态数组即可。</span></span><br><span class="line">        newsh = s_realloc(sh, hdrlen+newlen+<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (newsh == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        s = (<span class="keyword">char</span>*)newsh+hdrlen;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 类型改变了，则说明头部长度也发生了变化，不进行realloc操作，而是直接重新开辟内存</span></span><br><span class="line">        newsh = s_malloc(hdrlen+newlen+<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (newsh == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 原内存拷贝到新的内存地址上</span></span><br><span class="line">        <span class="built_in">memcpy</span>((<span class="keyword">char</span>*)newsh+hdrlen, s, len+<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 释放原先空间</span></span><br><span class="line">        s_free(sh);</span><br><span class="line">        s = (<span class="keyword">char</span>*)newsh+hdrlen;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 为flags赋值</span></span><br><span class="line">        s[<span class="number">-1</span>] = type;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 为len属性赋值</span></span><br><span class="line">        sdssetlen(s, len);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 为alloc属性赋值</span></span><br><span class="line">    sdssetalloc(s, newlen);</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li>SDS 返回的是指向 buf 的指针，兼容了 C 语言操作字符串的函数，读取内容时，通过 len 属性来限制读取的长度，不受 <code>\0</code> 影响，从而保证二进制安全；</li>
<li>Redis 根据字符串长度的不同，定义了多种数据结构，包括：sdshdr5/sdshdr8/sdshdr16/sdshdr32/sdshdr64。</li>
<li>SDS 在设计字符串修改出会调用 <code>sdsMakeRoomFor</code> 函数进行检查，根据不同情况进行扩容。</li>
</ol>
<p>全文完！</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2021/03/15/yuque/%E6%B7%B1%E6%8C%96%20Redis%206.0%20%E6%BA%90%E7%A0%81%E2%80%94%E2%80%94SDS/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-yuque/曹春晖：谈一谈 Go 和 Syscall" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/15/yuque/%E6%9B%B9%E6%98%A5%E6%99%96%EF%BC%9A%E8%B0%88%E4%B8%80%E8%B0%88%20Go%20%E5%92%8C%20Syscall/">曹春晖：谈一谈 Go 和 Syscall</a>
    </h1>
  

        
        <a href="/2021/03/15/yuque/%E6%9B%B9%E6%98%A5%E6%99%96%EF%BC%9A%E8%B0%88%E4%B8%80%E8%B0%88%20Go%20%E5%92%8C%20Syscall/" class="archive-article-date">
  	<time datetime="2021-03-15T03:13:36.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2021-03-15</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>▎<strong>阅读索引</strong><br>**</p>
<ul>
<li><p>概念</p>
</li>
<li><p>入口</p>
</li>
<li><p>系统调用管理</p>
</li>
<li><p>runtime 中的 SYSCALL</p>
</li>
<li><p>和调度的交互</p>
<ul>
<li><p>entersyscall</p>
</li>
<li><p>exitsyscallfast</p>
</li>
<li><p>exitsyscall</p>
</li>
<li><p>entersyscallblock</p>
</li>
<li><p>entersyscallblock_handoff</p>
</li>
<li><p>entersyscall_sysmon</p>
</li>
<li><p>entersyscall_gcwait</p>
</li>
</ul>
</li>
<li><p>总结</p>
</li>
</ul>
<p>**</p>
<h2 id="▎概念"><a href="#▎概念" class="headerlink" title="▎概念"></a>▎<strong>概念</strong></h2><p><img src="https://cdn.nlark.com/yuque/0/2021/webp/190217/1615778187154-daf8b288-50e6-482b-952b-1a6c95980d91.webp#align=left&display=inline&height=110&margin=%5Bobject%20Object%5D&originHeight=846&originWidth=1080&size=0&status=done&style=none&width=140"></p>
<h2 id="▎入口"><a href="#▎入口" class="headerlink" title="▎入口"></a>▎<strong>入口</strong></h2><p>syscall 有下面几个入口，在 syscall/asm_linux_amd64.s 中。</p>
<p>1func Syscall(trap, a1, a2, a3 uintptr) (r1, r2 uintptr, err syscall.Errno)<br>2<br>3func Syscall6(trap, a1, a2, a3, a4, a5, a6 uintptr) (r1, r2 uintptr, err syscall.Errno)<br>4<br>5func RawSyscall(trap, a1, a2, a3 uintptr) (r1, r2 uintptr, err syscall.Errno)<br>6<br>7func RawSyscall6(trap, a1, a2, a3, a4, a5, a6 uintptr) (r1, r2 uintptr, err syscall.Errno)<br>8</p>
<p>这些函数的实现都是汇编，按照 linux 的 syscall 调用规范，我们只要在汇编中把参数依次传入寄存器，并调用 SYSCALL 指令即可进入内核处理逻辑，系统调用执行完毕之后，返回值放在 RAX 中：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/webp/190217/1615778187077-65fb0753-f95e-4987-a305-da25dd23ad04.webp#align=left&display=inline&height=78&margin=%5Bobject%20Object%5D&originHeight=78&originWidth=505&size=0&status=done&style=none&width=505"></p>
<p>Syscall  和  Syscall6  的区别只有传入参数不一样:</p>
<p>1// func Syscall(trap int64, a1, a2, a3 uintptr) (r1, r2, err uintptr);<br>2TEXT ·Syscall(SB),NOSPLIT,$0-56<br> 3    CALL    runtime·entersyscall(SB)<br> 4    MOVQ    a1+8(FP), DI<br> 5    MOVQ    a2+16(FP), SI<br> 6    MOVQ    a3+24(FP), DX<br> 7    MOVQ    $0, R10<br> 8    MOVQ    $0, R8<br> 9    MOVQ    $0, R9<br>10    MOVQ    trap+0(FP), AX    // syscall entry<br>11    SYSCALL<br>12    // 0xfffffffffffff001 是 linux MAX_ERRNO 取反 转无符号，<a target="_blank" rel="noopener" href="http://lxr.free-electrons.com/source/include/linux/err.h#L17">http://lxr.free-electrons.com/source/include/linux/err.h#L17</a><br>13    CMPQ    AX, $0xfffffffffffff001<br>14    JLS    ok<br>15    MOVQ    $-1, r1+32(FP)<br>16    MOVQ    $0, r2+40(FP)<br>17    NEGQ    AX<br>18    MOVQ    AX, err+48(FP)<br>19    CALL    runtime·exitsyscall(SB)<br>20    RET<br>21ok:<br>22    MOVQ    AX, r1+32(FP)<br>23    MOVQ    DX, r2+40(FP)<br>24    MOVQ    $0, err+48(FP)<br>25    CALL    runtime·exitsyscall(SB)<br>26    RET<br>27<br>28// func Syscall6(trap, a1, a2, a3, a4, a5, a6 uintptr) (r1, r2, err uintptr)<br>29TEXT ·Syscall6(SB),NOSPLIT,$0-80<br>30    CALL    runtime·entersyscall(SB)<br>31    MOVQ    a1+8(FP), DI<br>32    MOVQ    a2+16(FP), SI<br>33    MOVQ    a3+24(FP), DX<br>34    MOVQ    a4+32(FP), R10<br>35    MOVQ    a5+40(FP), R8<br>36    MOVQ    a6+48(FP), R9<br>37    MOVQ    trap+0(FP), AX    // syscall entry<br>38    SYSCALL<br>39    CMPQ    AX, $0xfffffffffffff001<br>40    JLS    ok6<br>41    MOVQ    $-1, r1+56(FP)<br>42    MOVQ    $0, r2+64(FP)<br>43    NEGQ    AX<br>44    MOVQ    AX, err+72(FP)<br>45    CALL    runtime·exitsyscall(SB)<br>46    RET<br>47ok6:<br>48    MOVQ    AX, r1+56(FP)<br>49    MOVQ    DX, r2+64(FP)<br>50    MOVQ    $0, err+72(FP)<br>51    CALL    runtime·exitsyscall(SB)<br>52    RET</p>
<p>两个函数没什么大区别，为啥不用一个呢？个人猜测，Go 的函数参数都是栈上传入，可能是为了节省一点栈空间。。在正常的 Syscall 操作之前会通知 runtime，接下来我要进行 syscall 操作了 <strong>runtime·entersyscall **，退出时会调用</strong> runtime·exitsyscall **。</p>
<p>1// func RawSyscall(trap, a1, a2, a3 uintptr) (r1, r2, err uintptr)<br>2TEXT ·RawSyscall(SB),NOSPLIT,$0-56<br> 3    MOVQ    a1+8(FP), DI<br> 4    MOVQ    a2+16(FP), SI<br> 5    MOVQ    a3+24(FP), DX<br> 6    MOVQ    $0, R10<br> 7    MOVQ    $0, R8<br> 8    MOVQ    $0, R9<br> 9    MOVQ    trap+0(FP), AX    // syscall entry<br>10    SYSCALL<br>11    CMPQ    AX, $0xfffffffffffff001<br>12    JLS    ok1<br>13    MOVQ    $-1, r1+32(FP)<br>14    MOVQ    $0, r2+40(FP)<br>15    NEGQ    AX<br>16    MOVQ    AX, err+48(FP)<br>17    RET<br>18ok1:<br>19    MOVQ    AX, r1+32(FP)<br>20    MOVQ    DX, r2+40(FP)<br>21    MOVQ    $0, err+48(FP)<br>22    RET<br>23<br>24// func RawSyscall6(trap, a1, a2, a3, a4, a5, a6 uintptr) (r1, r2, err uintptr)<br>25TEXT ·RawSyscall6(SB),NOSPLIT,$0-80<br>26    MOVQ    a1+8(FP), DI<br>27    MOVQ    a2+16(FP), SI<br>28    MOVQ    a3+24(FP), DX<br>29    MOVQ    a4+32(FP), R10<br>30    MOVQ    a5+40(FP), R8<br>31    MOVQ    a6+48(FP), R9<br>32    MOVQ    trap+0(FP), AX    // syscall entry<br>33    SYSCALL<br>34    CMPQ    AX, $0xfffffffffffff001<br>35    JLS    ok2<br>36    MOVQ    $-1, r1+56(FP)<br>37    MOVQ    $0, r2+64(FP)<br>38    NEGQ    AX<br>39    MOVQ    AX, err+72(FP)<br>40    RET<br>41ok2:<br>42    MOVQ    AX, r1+56(FP)<br>43    MOVQ    DX, r2+64(FP)<br>44    MOVQ    $0, err+72(FP)<br>45    RET</p>
<p>RawSyscall  和  Syscall  的区别也非常微小，就只是在进入  Syscall  和退出的时候没有通知  runtime，这样  runtime  理论上是没有办法通过调度把这个  g  的  m  的  p  调度走的，所以如果用户代码使用了  RawSyscall  来做一些阻塞的系统调用，是有可能阻塞其它的  g  的，下面是官方开发的原话:</p>
<p><em>Yes, if you call RawSyscall you may block other goroutines from running. The system monitor may start them up after a while, but I think there are cases where it won’t. I would say that Go programs should always call Syscall. RawSyscall exists to make it slightly more efficient to call system calls that never block, such as getpid. But it’s really an internal mechanism.</em></p>
<p>1// func gettimeofday(tv *Timeval) (err uintptr)<br>2TEXT ·gettimeofday(SB),NOSPLIT,$0-16<br>3    MOVQ    tv+0(FP), DI<br>4    MOVQ    $0, SI<br>5    MOVQ    runtime·__vdso_gettimeofday_sym(SB), AX<br>6    CALL    AX<br>7<br>8    CMPQ    AX, $0xfffffffffffff001<br>9    JLS    ok7<br>10    NEGQ    AX<br>11    MOVQ    AX, err+8(FP)<br>12    RET<br>13ok7:<br>14    MOVQ    $0, err+8(FP)<br>15    RET</p>
<h2 id="▎系统调用管理"><a href="#▎系统调用管理" class="headerlink" title="▎系统调用管理"></a>▎<strong>系统调用管理</strong></h2><p>先是系统调用的定义文件:</p>
<p>1/syscall/syscall_linux.go</p>
<p>可以把系统调用分为三类:</p>
<ul>
<li><p>阻塞系统调用</p>
</li>
<li><p>非阻塞系统调用</p>
</li>
<li><p>wrapped 系统调用</p>
</li>
</ul>
<p>阻塞系统调用会定义成下面这样的形式:</p>
<p>1//sys   Madvise(b []byte, advice int) (err error)</p>
<p>非阻塞系统调用:</p>
<p>1//sysnb    EpollCreate(size int) (fd int, err error)</p>
<p>然后，根据这些注释，mksyscall.pl 脚本会生成对应的平台的具体实现。mksyscall.pl 是一段 perl 脚本，感兴趣的同学可以自行查看，这里就不再赘述了。</p>
<p>看看阻塞和非阻塞的系统调用的生成结果:</p>
<p>1func Madvise(b []byte, advice int) (err error) {<br>2    var _p0 unsafe.Pointer<br>3    if len(b) &gt; 0 {<br>4        _p0 = unsafe.Pointer(&amp;b[0])<br>5    } else {<br>6        _p0 = unsafe.Pointer(&amp;_zero)<br>7    }<br>8    _, *, e1 := Syscall(SYS_MADVISE, uintptr(_p0), uintptr(len(b)), uintptr(advice))<br>9    if e1 != 0 {<br>10        err = errnoErr(e1)<br>11    }<br>12    return<br>13}<br>14<br>15func EpollCreate(size int) (fd int, err error) {<br>16    r0, *, e1 := RawSyscall(SYS_EPOLL_CREATE, uintptr(size), 0, 0)<br>17    fd = int(r0)<br>18    if e1 != 0 {<br>19        err = errnoErr(e1)<br>20    }<br>21    return<br>22}</p>
<p>显然，标记为 sys 的系统调用使用的是 Syscall 或者 Syscall6，标记为 sysnb 的系统调用使用的是 RawSyscall 或 RawSyscall6。</p>
<p>wrapped 的系统调用是怎么一回事呢？</p>
<p>1func Rename(oldpath string, newpath string) (err error) {<br>2    return Renameat(_AT_FDCWD, oldpath, _AT_FDCWD, newpath)<br>3}</p>
<p>可能是觉得系统调用的名字不太好，或者参数太多，我们就简单包装一下。没啥特别的。</p>
<h2 id="▎runtime-中的-SYSCALL"><a href="#▎runtime-中的-SYSCALL" class="headerlink" title="▎runtime 中的 SYSCALL"></a>▎<strong>runtime 中的 SYSCALL</strong></h2><p>除了上面提到的阻塞非阻塞和 wrapped syscall，runtime 中还定义了一些 low-level 的 syscall，这些是不暴露给用户的。</p>
<p>提供给用户的 syscall 库，在使用时，会使 goroutine 和 p 分别进入 Gsyscall 和 Psyscall 状态。但 runtime 自己封装的这些 syscall 无论是否阻塞，都不会调用 entersyscall 和 exitsyscall。虽说是 “low-level” 的 syscall。</p>
<p>不过和暴露给用户的 syscall 本质是一样的。这些代码在 runtime/sys_linux_amd64.s 中，举个具体的例子:</p>
<p>1TEXT runtime·write(SB),NOSPLIT,$0-28<br> 2    MOVQ    fd+0(FP), DI<br> 3    MOVQ    p+8(FP), SI<br> 4    MOVL    n+16(FP), DX<br> 5    MOVL    $SYS_write, AX<br>6    SYSCALL<br>7    CMPQ    AX, $0xfffffffffffff001<br> 8    JLS    2(PC)<br> 9    MOVL    $-1, AX<br>10    MOVL    AX, ret+24(FP)<br>11    RET<br>12<br>13TEXT runtime·read(SB),NOSPLIT,$0-28<br>14    MOVL    fd+0(FP), DI<br>15    MOVQ    p+8(FP), SI<br>16    MOVL    n+16(FP), DX<br>17    MOVL    $SYS_read, AX<br>18    SYSCALL<br>19    CMPQ    AX, $0xfffffffffffff001<br>20    JLS    2(PC)<br>21    MOVL    $-1, AX<br>22    MOVL    AX, ret+24(FP)<br>23    RET</p>
<p>下面是所有  runtime  另外定义的  syscall  列表:</p>
<p>1#define SYS_read        0<br>2#define SYS_write        1<br>3#define SYS_open        2<br>4#define SYS_close        3<br>5#define SYS_mmap        9<br>6#define SYS_munmap        11<br>7#define SYS_brk         12<br>8#define SYS_rt_sigaction    13<br>9#define SYS_rt_sigprocmask    14<br>10#define SYS_rt_sigreturn    15<br>11#define SYS_access        21<br>12#define SYS_sched_yield     24<br>13#define SYS_mincore        27<br>14#define SYS_madvise        28<br>15#define SYS_setittimer        38<br>16#define SYS_getpid        39<br>17#define SYS_socket        41<br>18#define SYS_connect        42<br>19#define SYS_clone        56<br>20#define SYS_exit        60<br>21#define SYS_kill        62<br>22#define SYS_fcntl        72<br>23#define SYS_getrlimit        97<br>24#define SYS_sigaltstack     131<br>25#define SYS_arch_prctl        158<br>26#define SYS_gettid        186<br>27#define SYS_tkill        200<br>28#define SYS_futex        202<br>29#define SYS_sched_getaffinity    204<br>30#define SYS_epoll_create    213<br>31#define SYS_exit_group        231<br>32#define SYS_epoll_wait        232<br>33#define SYS_epoll_ctl        233<br>34#define SYS_pselect6        270<br>35#define SYS_epoll_create1    291</p>
<p>这些 syscall 理论上都是不会在执行期间被调度器剥离掉 p 的，所以执行成功之后 goroutine 会继续执行，而不像用户的 goroutine 一样，若被剥离 p 会进入等待队列。</p>
<h2 id="▎和调度的交互"><a href="#▎和调度的交互" class="headerlink" title="▎和调度的交互"></a>▎<strong>和调度的交互</strong></h2><p>既然要和调度交互，那友好地通知我要 syscall 了: entersyscall，我完事了: exitsyscall。</p>
<p>所以这里的交互指的是用户代码使用 syscall 库时和调度器的交互。<strong>runtime 里的 syscall 不走这套流程。</strong></p>
<h2 id="▎entersyscall"><a href="#▎entersyscall" class="headerlink" title="▎entersyscall"></a><strong>▎entersyscall</strong></h2><p>1// syscall  库和  cgo  调用的标准入口<br>2//go:nosplit<br>3func entersyscall() {<br>4    reentersyscall(getcallerpc(), getcallersp())<br>5}<br>6<br>7//go:nosplit<br>8func reentersyscall(pc, sp uintptr) {<br>9    <em>g</em> := getg()<br>10<br>11    //  需要禁止  g  的抢占<br>12    <em>g</em>.m.locks++<br>13<br>14    // entersyscall  中不能调用任何会导致栈增长/分裂的函数<br>15    <em>g</em>.stackguard0 = stackPreempt<br>16    //  设置  throwsplit，在  newstack  中，如果发现  throwsplit  是  true<br>17    //  会直接  crash<br>18    //  下面的代码是  newstack  里的<br>19    // if thisg.m.curg.throwsplit {<br>20    //     throw(“runtime: stack split at bad time”)<br>21    // }<br>22    <em>g</em>.throwsplit = true<br>23<br>24    // Leave SP around for GC and traceback.<br>25    //  保存现场，在  syscall  之后会依据这些数据恢复现场<br>26    save(pc, sp)<br>27    <em>g</em>.syscallsp = sp<br>28    <em>g</em>.syscallpc = pc<br>29    casgstatus(<em>g</em>, <em>Grunning, _Gsyscall)<br>30    if _g</em>.syscallsp &lt; <em>g</em>.stack.lo || <em>g</em>.stack.hi &lt; <em>g</em>.syscallsp {<br>31        systemstack(func() {<br>32            print(“entersyscall inconsistent “, hex(<em>g</em>.syscallsp), “ [“, hex(<em>g</em>.stack.lo), “,”, hex(<em>g</em>.stack.hi), “]\n”)<br>33            throw(“entersyscall”)<br>34        })<br>35    }<br>36<br>37    if atomic.Load(&amp;sched.sysmonwait) != 0 {<br>38        systemstack(entersyscall<em>sysmon)<br>39        save(pc, sp)<br>40    }<br>41<br>42    if _g</em>.m.p.ptr().runSafePointFn != 0 {<br>43        // runSafePointFn may stack split if run on this stack<br>44        systemstack(runSafePointFn)<br>45        save(pc, sp)<br>46    }<br>47<br>48    <em>g</em>.m.syscalltick = <em>g</em>.m.p.ptr().syscalltick<br>49    <em>g</em>.sysblocktraced = true<br>50    <em>g</em>.m.mcache = nil<br>51    <em>g</em>.m.p.ptr().m = 0<br>52    atomic.Store(&amp;<em>g</em>.m.p.ptr().status, <em>Psyscall)<br>53    if sched.gcwaiting != 0 {<br>54        systemstack(entersyscall_gcwait)<br>55        save(pc, sp)<br>56    }<br>57<br>58    _g</em>.m.locks–<br>59}</p>
<p>可以看到，进入 syscall 的 G 是铁定不会被抢占的。</p>
<h2 id="▎exitsyscall"><a href="#▎exitsyscall" class="headerlink" title="▎exitsyscall"></a><strong>▎exitsyscall</strong></h2><p>1// g  已经退出了  syscall<br>2//  需要准备让  g  在  cpu  上重新运行<br>3//  这个函数只会在  syscall  库中被调用，在  runtime  里用的  low-level syscall<br>4//  不会用到<br>5//  不能有  write barrier，因为  P  可能已经被偷走了<br>6//go:nosplit<br>7//go:nowritebarrierrec<br>8func exitsyscall(dummy int32) {<br>9    <em>g</em> := getg()<br>10<br>11    <em>g</em>.m.locks++ // see comment in entersyscall<br>12    if getcallersp(unsafe.Pointer(&amp;dummy)) &gt; <em>g</em>.syscallsp {<br>13        // throw calls print which may try to grow the stack,<br>14        // but throwsplit == true so the stack can not be grown;<br>15        // use systemstack to avoid that possible problem.<br>16        systemstack(func() {<br>17            throw(“exitsyscall: syscall frame is no longer valid”)<br>18        })<br>19    }<br>20<br>21    <em>g</em>.waitsince = 0<br>22    oldp := <em>g</em>.m.p.ptr()<br>23    if exitsyscallfast() {<br>24        if <em>g</em>.m.mcache == nil {<br>25            systemstack(func() {<br>26                throw(“lost mcache”)<br>27            })<br>28        }<br>29        //  目前有  p，可以运行<br>30        <em>g</em>.m.p.ptr().syscalltick++<br>31        //  把  g  的状态修改回  running<br>32        casgstatus(<em>g</em>, <em>Gsyscall, _Grunning)<br>33<br>34        //  垃圾收集未在运行(因为我们这段逻辑在执行)<br>35        //  所以清理掉  syscallsp  是安全的<br>36        _g</em>.syscallsp = 0<br>37        <em>g</em>.m.locks–<br>38        if <em>g</em>.preempt {<br>39            //  防止在  newstack  中清理掉  preemption  标记<br>40            <em>g</em>.stackguard0 = stackPreempt<br>41        } else {<br>42            //  否则恢复在  entersyscall/entersyscallblock  中破坏掉的正常的  <em>StackGuard<br>43            _g</em>.stackguard0 = <em>g</em>.stack.lo + <em>StackGuard<br>44        }<br>45        _g</em>.throwsplit = false<br>46        return<br>47    }<br>48<br>49    <em>g</em>.sysexitticks = 0<br>50    <em>g</em>.m.locks–<br>51<br>52    //  调用  scheduler<br>53    mcall(exitsyscall0)<br>54<br>55    if <em>g</em>.m.mcache == nil {<br>56        systemstack(func() {<br>57            throw(“lost mcache”)<br>58        })<br>59    }<br>60<br>61    //  调度器返回了，所以我们可以清理掉在  syscall  期间为垃圾收集器<br>62    //  准备的  syscallsp  信息了<br>63    //  需要一直等待到  gosched  返回，我们不确定垃圾收集器是不是在运行<br>64    <em>g</em>.syscallsp = 0<br>65    <em>g</em>.m.p.ptr().syscalltick++<br>66    <em>g</em>.throwsplit = false<br>67}</p>
<p>这里还调用了 exitsyscallfast 和 exitsyscall0。</p>
<h2 id="▎exitsyscallfast"><a href="#▎exitsyscallfast" class="headerlink" title="▎exitsyscallfast"></a><strong>▎exitsyscallfast</strong></h2><p>1//go:nosplit<br>2func exitsyscallfast() bool {<br>3    <em>g</em> := getg()<br>4<br>5    // Freezetheworld sets stopwait but does not retake P’s.<br>6    if sched.stopwait == freezeStopWait {<br>7        <em>g</em>.m.mcache = nil<br>8        <em>g</em>.m.p = 0<br>9        return false<br>10    }<br>11<br>12    // Try to re-acquire the last P.<br>13    if <em>g</em>.m.p != 0 &amp;&amp; <em>g</em>.m.p.ptr().status == <em>Psyscall &amp;&amp; atomic.Cas(&amp;_g</em>.m.p.ptr().status, <em>Psyscall, _Prunning) {<br>14        // There’s a cpu for us, so we can run.<br>15        exitsyscallfast_reacquired()<br>16        return true<br>17    }<br>18<br>19    // Try to get any other idle P.<br>20    oldp := _g</em>.m.p.ptr()<br>21    <em>g</em>.m.mcache = nil<br>22    <em>g</em>.m.p = 0<br>23    if sched.pidle != 0 {<br>24        var ok bool<br>25        systemstack(func() {<br>26            ok = exitsyscallfast_pidle()<br>27        })<br>28        if ok {<br>29            return true<br>30        }<br>31    }<br>32    return false<br>33}</p>
<p>总之就是努力获取一个 P 来执行 syscall 之后的逻辑。如果哪都没有 P 可以给我们用，那就进入 exitsyscall0 了。</p>
<p>1mcall(exitsyscall0)</p>
<p>调用 exitsyscall0 时，会切换到 g0 栈。</p>
<h2 id="▎exitsyscall0"><a href="#▎exitsyscall0" class="headerlink" title="▎exitsyscall0"></a><strong>▎exitsyscall0</strong></h2><p>1//  在  exitsyscallfast  中吃瘪了，没办法，慢慢来<br>2//  把  g  的状态设置成  runnable，先进  runq  等着<br>3//go:nowritebarrierrec<br>4func exitsyscall0(gp *g) {<br>5    <em>g</em> := getg()<br>6<br>7    casgstatus(gp, <em>Gsyscall, _Grunnable)<br>8    dropg()<br>9    lock(&amp;sched.lock)<br>10    _p</em> := pidleget()<br>11    if <em>p</em> == nil {<br>12        //  如果  P  被人偷跑了<br>13        globrunqput(gp)<br>14    } else if atomic.Load(&amp;sched.sysmonwait) != 0 {<br>15        atomic.Store(&amp;sched.sysmonwait, 0)<br>16        notewakeup(&amp;sched.sysmonnote)<br>17    }<br>18    unlock(&amp;sched.lock)<br>19    if <em>p</em> != nil {<br>20        //  如果现在还有  p，那就用这个  p  执行<br>21        acquirep(<em>p</em>)<br>22        execute(gp, false) // Never returns.<br>23    }<br>24    if <em>g</em>.m.lockedg != 0 {<br>25        //  设置了  LockOsThread  的  g  的特殊逻辑<br>26        stoplockedm()<br>27        execute(gp, false) // Never returns.<br>28    }<br>29    stopm()<br>30    schedule() // Never returns.<br>31}</p>
<h2 id="▎entersyscallblock"><a href="#▎entersyscallblock" class="headerlink" title="▎entersyscallblock"></a><strong>▎entersyscallblock</strong></h2><p>知道自己会 block，直接就把 p 交出来了。</p>
<p>1//  和  entersyscall  一样，就是会直接把  P  给交出去，因为知道自己是会阻塞的<br>2//go:nosplit<br>3func entersyscallblock(dummy int32) {<br>4    <em>g</em> := getg()<br>5<br>6    <em>g</em>.m.locks++ // see comment in entersyscall<br>7    <em>g</em>.throwsplit = true<br>8    <em>g</em>.stackguard0 = stackPreempt // see comment in entersyscall<br>9    <em>g</em>.m.syscalltick = <em>g</em>.m.p.ptr().syscalltick<br>10    <em>g</em>.sysblocktraced = true<br>11    <em>g</em>.m.p.ptr().syscalltick++<br>12<br>13    // Leave SP around for GC and traceback.<br>14    pc := getcallerpc()<br>15    sp := getcallersp(unsafe.Pointer(&amp;dummy))<br>16    save(pc, sp)<br>17    <em>g</em>.syscallsp = <em>g</em>.sched.sp<br>18    <em>g</em>.syscallpc = <em>g</em>.sched.pc<br>19    if <em>g</em>.syscallsp &lt; <em>g</em>.stack.lo || <em>g</em>.stack.hi &lt; <em>g</em>.syscallsp {<br>20        sp1 := sp<br>21        sp2 := <em>g</em>.sched.sp<br>22        sp3 := <em>g</em>.syscallsp<br>23        systemstack(func() {<br>24            print(“entersyscallblock inconsistent “, hex(sp1), “ “, hex(sp2), “ “, hex(sp3), “ [“, hex(<em>g</em>.stack.lo), “,”, hex(<em>g</em>.stack.hi), “]\n”)<br>25            throw(“entersyscallblock”)<br>26        })<br>27    }<br>28    casgstatus(<em>g</em>, <em>Grunning, _Gsyscall)<br>29    if _g</em>.syscallsp &lt; <em>g</em>.stack.lo || <em>g</em>.stack.hi &lt; <em>g</em>.syscallsp {<br>30        systemstack(func() {<br>31            print(“entersyscallblock inconsistent “, hex(sp), “ “, hex(<em>g</em>.sched.sp), “ “, hex(<em>g</em>.syscallsp), “ [“, hex(<em>g</em>.stack.lo), “,”, hex(<em>g</em>.stack.hi), “]\n”)<br>32            throw(“entersyscallblock”)<br>33        })<br>34    }<br>35<br>36    //  直接调用  entersyscallblock<em>handoff  把  p  交出来了<br>37    systemstack(entersyscallblock_handoff)<br>38<br>39    // Resave for traceback during blocked call.<br>40    save(getcallerpc(), getcallersp(unsafe.Pointer(&amp;dummy)))<br>41<br>42    _g</em>.m.locks–<br>43}</p>
<p>这个函数只有一个调用方 notesleepg，这里就不再赘述了。</p>
<h2 id="▎entersyscallblock-handoff"><a href="#▎entersyscallblock-handoff" class="headerlink" title="▎entersyscallblock_handoff"></a><strong>▎entersyscallblock_handoff</strong></h2><p>1func entersyscallblock_handoff() {<br>2    handoffp(releasep())<br>3}</p>
<p>比较简单。</p>
<h2 id="▎entersyscall-sysmon"><a href="#▎entersyscall-sysmon" class="headerlink" title="▎entersyscall_sysmon"></a><strong>▎entersyscall_sysmon</strong></h2><p>1func entersyscall_sysmon() {<br>2    lock(&amp;sched.lock)<br>3    if atomic.Load(&amp;sched.sysmonwait) != 0 {<br>4        atomic.Store(&amp;sched.sysmonwait, 0)<br>5        notewakeup(&amp;sched.sysmonnote)<br>6    }<br>7    unlock(&amp;sched.lock)<br>8}</p>
<h2 id="▎entersyscall-gcwait"><a href="#▎entersyscall-gcwait" class="headerlink" title="▎entersyscall_gcwait"></a><strong>▎entersyscall_gcwait</strong></h2><p>1func entersyscall<em>gcwait() {<br>2    _g</em> := getg()<br>3    <em>p</em> := <em>g</em>.m.p.ptr()<br>4<br>5    lock(&amp;sched.lock)<br>6    if sched.stopwait &gt; 0 &amp;&amp; atomic.Cas(&amp;<em>p</em>.status, <em>Psyscall, _Pgcstop) {<br>7        _p</em>.syscalltick++<br>8        if sched.stopwait–; sched.stopwait == 0 {<br>9            notewakeup(&amp;sched.stopnote)<br>10        }<br>11    }<br>12    unlock(&amp;sched.lock)<br>13}</p>
<h2 id="▎-总结"><a href="#▎-总结" class="headerlink" title="▎**总结**"></a><strong>▎**</strong>总结**</h2><p>提供给用户使用的系统调用，基本都会通知 runtime，以 entersyscall，exitsyscall 的形式来告诉 runtime，在这个 syscall 阻塞的时候，由 runtime 判断是否把 P 腾出来给其它的 M 用。解绑定指的是把 M 和 P 之间解绑，如果绑定被解除，在 syscall 返回时，这个 g 会被放入执行队列 runq 中。</p>
<p>同时 runtime 又保留了自己的特权，在执行自己的逻辑的时候，我的 P 不会被调走，这样保证了在 Go 自己“底层”使用的这些 syscall 返回之后都能被立刻处理。</p>
<p>所以同样是 epollwait，runtime 用的是不能被别人打断的，你用的 syscall.EpollWait 那显然是没有这种特权的。</p>
<h2 id="▎-END"><a href="#▎-END" class="headerlink" title="▎**END**"></a><strong>▎**</strong>END**</h2><p>参考资料如下<br><a target="_blank" rel="noopener" href="https://z.didi.cn/1HecgP">https://z.didi.cn/1HecgP</a></p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2021/03/15/yuque/%E6%9B%B9%E6%98%A5%E6%99%96%EF%BC%9A%E8%B0%88%E4%B8%80%E8%B0%88%20Go%20%E5%92%8C%20Syscall/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-yuque/Go 与异步 IO - io_uring 的思考" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/15/yuque/Go%20%E4%B8%8E%E5%BC%82%E6%AD%A5%20IO%20-%20io_uring%20%E7%9A%84%E6%80%9D%E8%80%83/">Go 与异步 IO - io_uring 的思考</a>
    </h1>
  

        
        <a href="/2021/03/15/yuque/Go%20%E4%B8%8E%E5%BC%82%E6%AD%A5%20IO%20-%20io_uring%20%E7%9A%84%E6%80%9D%E8%80%83/" class="archive-article-date">
  	<time datetime="2021-03-15T03:11:09.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2021-03-15</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Golang-中并发-IO-的现状"><a href="#Golang-中并发-IO-的现状" class="headerlink" title="Golang 中并发 IO 的现状"></a>Golang 中并发 IO 的现状</h1><p>对于 Go 这种本身便是为并发而生的语言来说，使用 <code>io_uring</code> 这种系统级异步接口也不是那么的迫切<br>比如对于普通文件的读写以及 socket 的操作都会通过 <code>netpoll</code> 来进行优化，当文件/套接字可读可写时 netpoll 便会唤醒相应 goroutine 来对文件进行读写<br>而对于可能会阻塞的系统调用，在 syscall 底层调用 <code>syscall.Syscall/Syscall6</code> 时配合 runtime 判断是否将 P 和 G 绑定的 M 解绑，然后将 P 交给其他 M 来使用，通过这种机制可以减少系统调用从用户态切换到内核态对整个程序带来的损耗<br>Go runtime 实际上已经实现了用户态的并发 IO，现在 Linux 内核提供了新的异步 IO 接口，那又该如何去利用这种新的技术呢<br>我们首先先看一下当前 Go 是如何做到异步 IO 的</p>
<h2 id="IO-与-netpoll"><a href="#IO-与-netpoll" class="headerlink" title="IO 与 netpoll"></a>IO 与 netpoll</h2><h3 id="文件-IO-与-netpoll"><a href="#文件-IO-与-netpoll" class="headerlink" title="文件 IO 与 netpoll"></a>文件 IO 与 netpoll</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; src&#x2F;os&#x2F;file.go</span><br><span class="line">func OpenFile(name string, flag int, perm FileMode) (*File, error) &#123;</span><br><span class="line">    f, err :&#x3D; openFileNolog(name, flag, perm)</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; src&#x2F;os&#x2F;file_unix.go</span><br><span class="line">func openFileNolog(name string, flag int, perm FileMode) (*File, error) &#123;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    r, e &#x3D; syscall.Open(name, flag|syscall.O_CLOEXEC, syscallMode(perm))</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    return newFile(uintptr(r), name, kindOpenFile), nil</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; src&#x2F;os&#x2F;file_unix.go</span><br><span class="line">func newFile(fd uintptr, name string, kind newFileKind) *File &#123;</span><br><span class="line">    fdi :&#x3D; int(fd)</span><br><span class="line">    f :&#x3D; &amp;File&#123;&amp;file&#123;</span><br><span class="line">        pfd: poll.FD&#123;</span><br><span class="line">            Sysfd:     fdi,</span><br><span class="line">            IsStream:      true,</span><br><span class="line">            ZeroReadIsEOF: true,</span><br><span class="line">        &#125;,</span><br><span class="line">        name:    name,</span><br><span class="line">        stdoutOrErr: fdi &#x3D;&#x3D; 1 || fdi &#x3D;&#x3D; 2,</span><br><span class="line">    &#125;&#125;</span><br><span class="line">    pollable :&#x3D; kind &#x3D;&#x3D; kindOpenFile || kind &#x3D;&#x3D; kindPipe || kind &#x3D;&#x3D; kindNonBlock</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    if err :&#x3D; f.pfd.Init(&quot;file&quot;, pollable); err !&#x3D; nil &#123;</span><br><span class="line">        &#x2F;&#x2F; ...</span><br><span class="line">    &#125; else if pollable &#123;</span><br><span class="line">        if err :&#x3D; syscall.SetNonblock(fdi, true); err &#x3D;&#x3D; nil &#123;</span><br><span class="line">            f.nonblock &#x3D; true</span><br><span class="line">        &#125;</span><br><span class="line">        return f</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从 <code>os.Open</code> 到 <code>newFile</code>，可以看到文件的 <code>文件描述符</code> 被放到 <code>poll.FD</code> 进行初始化了, <code>poll.FD.Init</code> 便是将<code>文件描述符</code>注册到 <code>netpoll(epoll)</code> 中</p>
<blockquote>
<p>需要注意当文件被注册到 <code>netpoll(epoll)</code> 后，会将它置为非阻塞模式(<code>SetNonblock</code>)，因为 <code>netpoll(epoll)</code> 采用的是边缘触发模式<br>比如说非阻塞文件描述符中有可读事件时，<code>epoll</code> 只会通知一次(除非有新的数据被写入文件会再次通知)，也就说需要所有数据读出来直到返回 <code>-EAGAIN</code>，对于阻塞模式的 socket 文件，当从 socket 中读取数据时就可能会阻塞等待，这样也就失去了 epoll 的意义</p>
</blockquote>
<p>我们可以再看一下 <code>poll.FD</code> 是如何利用 <code>netpoll</code> 进行读取的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; src&#x2F;internal&#x2F;poll&#x2F;fd_unix.go</span><br><span class="line">func (fd *FD) Read(p []byte) (int, error) &#123;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    for &#123;</span><br><span class="line">        n, err :&#x3D; ignoringEINTR(syscall.Read, fd.Sysfd, p)</span><br><span class="line">        if err !&#x3D; nil &#123;</span><br><span class="line">            n &#x3D; 0</span><br><span class="line">            if err &#x3D;&#x3D; syscall.EAGAIN &amp;&amp; fd.pd.pollable() &#123;</span><br><span class="line">                continue</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        err &#x3D; fd.eofError(n, err)</span><br><span class="line">        return n, err</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到 <code>ignoringEINTR</code> 中调用 <code>syscall.Read</code> 读取文件，如果出现 <code>syscall.EAGAIN</code>，那么就调用 <code>fd.pd.waitRead</code> 来等待数据可读</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; src&#x2F;internal&#x2F;poll&#x2F;fd_unix.go</span><br><span class="line">type FD struct &#123;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    Sysfd int</span><br><span class="line">    pd pollDesc</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>pollDesc</code> Go 对 <code>netpoll</code> 的抽象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; src&#x2F;internal&#x2F;poll&#x2F;fd_poll_runtime.go</span><br><span class="line">func runtime_pollServerInit()</span><br><span class="line">func runtime_pollOpen(fd uintptr)(uintptr, int)</span><br><span class="line">func runtime_pollClose(ctx uintptr)</span><br><span class="line">&#x2F;&#x2F; ...</span><br><span class="line">type pollDesc struct &#123;</span><br><span class="line">    runtimeCtx uintptr</span><br><span class="line">&#125;</span><br><span class="line">func (pd *pollDesc) init(fd *FD) error &#123;</span><br><span class="line">    serverInit.Do(runtime_pollServerInit)</span><br><span class="line">    ctx, errno :&#x3D; runtime_pollOpen(uintptr(fd.Sysfd))</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    pd.runtimeCtx &#x3D; ctx</span><br><span class="line">    return nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>runtime_poll*</code> 这些函数才是真正的 netpoll，而这些函数是在<em>src/runtime/netpoll.go</em> 中实现，并通过 <code>go:linkname</code> 来链接到 <em>internal/poll</em> 中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; src&#x2F;runtime&#x2F;netpoll.go</span><br><span class="line">&#x2F;&#x2F; go:linkname poll_runtime_pollServerInit internal&#x2F;poll.runtime_pollServerInit</span><br><span class="line">func poll_runtime_pollServerInit() &#123;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据具体的平台来实现 poller，对于 Linux，便是使用 <code>epoll</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; src&#x2F;runtime&#x2F;netpoll_epoll.go</span><br><span class="line">&#x2F;&#x2F; 注册文件到 netpoll 中</span><br><span class="line">func netpolllopen(fd uintptr, pd *pollDesc) int32 &#123;</span><br><span class="line">    var ev epollevent</span><br><span class="line">    ev.events &#x3D; _EPOLLIN | _EPOLLOUT | _EPOLLRDHUP | _EPOLLET</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    return -epollctr(epfd, _EPOLL_CTL_ADD, int32(fd), &amp;ev)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加新的文件描述符时，可以发现<code>fd</code>是以 <code>边缘触发</code> 的方式注册到 <code>netpoll(epoll)</code> 中</p>
<h3 id="socket-IO-与-netpoll"><a href="#socket-IO-与-netpoll" class="headerlink" title="socket IO 与 netpoll"></a>socket IO 与 netpoll</h3><p>从 <code>netpoll</code> 这个名字上就可以看出，<code>netpoll</code> 是 Go 为了高性能的异步网络而实现的<br>看一下创建 TCPListener socket 的流程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; src&#x2F;net&#x2F;tcpsock.go</span><br><span class="line">type TCPListener struct &#123;</span><br><span class="line">    fd *netFD</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; src&#x2F;net&#x2F;fd_posix.go</span><br><span class="line">type netFD struct &#123;</span><br><span class="line">    pfd poll.FD</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; 1.</span><br><span class="line">&#x2F;&#x2F; src&#x2F;net&#x2F;tcpsock.go</span><br><span class="line">func ListenTCP(network string, laddr *TCPAddr) (*TCPListener, error) &#123;</span><br><span class="line">    sl :&#x3D; &amp;sysListener&#123;network: network, address: laddr.String()&#125;</span><br><span class="line">    ln, err :&#x3D; sl.listenTCP(context.Background(), laddr)</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; 2.</span><br><span class="line">&#x2F;&#x2F; src&#x2F;net&#x2F;tcpsock_posix.go</span><br><span class="line">func (sl *sysListener) listenTCP(ctx context.Context, laddr *TCPAddr) (*TCPListener, error) &#123;</span><br><span class="line">    fd, err :&#x3D; internetSocket(ctx, sl.network, laddr, nil, syscall.SOCK_STREAM, 0, &quot;listen&quot;, sl.ListenConfig.Control)</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    return &amp;TCPListener&#123;fd: fd, lc, sl.ListenConfig&#125;, nil</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; 3.</span><br><span class="line">&#x2F;&#x2F; src&#x2F;net&#x2F;ipsock_posix.go</span><br><span class="line">func internelSocket(ctx context.Context, ...) (fd *netFD, err error) &#123;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    return socket(ctx, net, family, sotype, proto, ipv6only, laddr, radddr, ctrlFn)</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; 4.</span><br><span class="line">&#x2F;&#x2F; src&#x2F;sock_posix.go</span><br><span class="line">func socket(...) (fd *netFD, err error) &#123;</span><br><span class="line">    s, err :&#x3D; sysSocket(family, sotype, proto)</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    fd, err &#x3D; newFD(s, family, sotype, net)</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; 5.</span><br><span class="line">&#x2F;&#x2F; src&#x2F;fd_unix.go</span><br><span class="line">func newFD(sysfd, family, sotype int, net string) (*netFD, error) &#123;</span><br><span class="line">    ret :&#x3D; &amp;netFD&#123;</span><br><span class="line">        pfd: poll.FD&#123;</span><br><span class="line">            Sysfd:    sysfd,</span><br><span class="line">            IsStream: sotype &#x3D;&#x3D; syscall.SOCK_STREAM,</span><br><span class="line">            &#x2F;&#x2F; ...</span><br><span class="line">        &#125;,</span><br><span class="line">        &#x2F;&#x2F; ...</span><br><span class="line">    &#125;</span><br><span class="line">    return ret, nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建 TCPListener 链路还是挺长的，不过在第四步 <code>socket</code> 函数中可以看到调用 <code>newFD</code> 来返回 <code>netFD</code> 实例，而 <code>netFD.pfd</code> 便是 <code>poll.FD</code>, 而对 <code>netFD</code> 的读写和文件 IO 一样便都会通过 <code>poll.FD</code> 来利用 <code>netpoll</code>。</p>
<h3 id="netpoll-唤醒-goroutine"><a href="#netpoll-唤醒-goroutine" class="headerlink" title="netpoll 唤醒 goroutine"></a>netpoll 唤醒 goroutine</h3><h4 id="挂起-goroutine"><a href="#挂起-goroutine" class="headerlink" title="挂起 goroutine"></a>挂起 goroutine</h4><p>通过 <code>poll.pollDesc</code> 将文件描述符加入到 <code>netpoll</code> 后，当对文件描述符进行读写时，如果 <code>syscall.Read</code> 返回 <code>syscall.EAGAIN</code> 的话就需要调用 <code>pollDesc.waitRead/waitWrite</code> 来等待可读可写</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; src&#x2F;internal&#x2F;poll&#x2F;fd_poll_runtime.go</span><br><span class="line">func (pd *pollDesc) waitRead(isFile bool) error&#123;</span><br><span class="line">    return pd.wait(&#39;r&#39;, isFile)</span><br><span class="line">&#125;</span><br><span class="line">func (pd *pollDesc) waitWrite(isFile bool) error&#123;</span><br><span class="line">    return pd.wait(&#39;w&#39;, isFile)</span><br><span class="line">&#125;</span><br><span class="line">func (pd *pollDesc) wait(mode int, isFile bool) error&#123;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    res :&#x3D; runtime_pollWait(pd.runtimeCtx, mode)</span><br><span class="line">    return convertErr(res, isFile)</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; src&#x2F;runtime&#x2F;netpoll.go</span><br><span class="line">&#x2F;&#x2F;go:linkname poll_runtime_pollWait internal&#x2F;poll.runtime_pollWait</span><br><span class="line">func poll_runtime_pollWait(pd *pollDesc, mode int) int &#123;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    for !netpollblock(pd, int32(mode), false) &#123;</span><br><span class="line">        &#x2F;&#x2F; ...</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br><span class="line">func netpollblock(pd *pollDesc, mode int32, waitio bool) bool &#123;</span><br><span class="line">    gpp :&#x3D; &amp;pd.rg</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    &#x2F;&#x2F; 状态检查</span><br><span class="line">    if waitio || netpollcheckerr(pd, mode) &#x3D;&#x3D; 0 &#123;</span><br><span class="line">        gopark(netpollblockcommit, unsafe.Pointer(gpp), waitReasonIOWait, traceEvGoBlockNet, 5)</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br><span class="line">func netpollblockcommit(gp *g, gpp unsafe.Pointer) bool &#123;</span><br><span class="line">    r :&#x3D; atomic.Casuintptr((*uintptr)(gpp), pdWait, uintptr(unsafe.Pointer(gp)))</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>等待文件可读写，最终会调用 <code>netpollblock</code> 函数，并不会直接调用 epoll wait 的系统调用，而是挂起当前 goroutine, 并等待唤醒</p>
<h4 id="唤醒-goroutine"><a href="#唤醒-goroutine" class="headerlink" title="唤醒 goroutine"></a>唤醒 goroutine</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; src&#x2F;runtime&#x2F;netpoll_epoll.go</span><br><span class="line">func netpoll(delay int64) gList &#123;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    var waitms int32</span><br><span class="line">    &#x2F;&#x2F; 计算 waitms，大概规则：</span><br><span class="line">    &#x2F;&#x2F; delay &lt; 0, waitms &#x3D; -1，阻塞等待</span><br><span class="line">    &#x2F;&#x2F; delay &#x3D;&#x3D; 0, waitms &#x3D; 0, 不阻塞</span><br><span class="line">    &#x2F;&#x2F; delay &gt; 0, delay 以纳秒为单位作为 waitms</span><br><span class="line">    var events [128]epollevent</span><br><span class="line">retry:</span><br><span class="line">    n :&#x3D; epollwait(epfd, &amp;events[0], int32(len(events)), waitms)</span><br><span class="line">    if n &lt; 0 &#123;</span><br><span class="line">        &#x2F;&#x2F; ...</span><br><span class="line">    &#125;</span><br><span class="line">    var toRun gList</span><br><span class="line">    for i :&#x3D; int32(0); i &lt; n; i++ &#123;</span><br><span class="line">        ev :&#x3D; &amp;events[i]</span><br><span class="line">        &#x2F;&#x2F; ...</span><br><span class="line">        var mode int32</span><br><span class="line">        if ev.events&amp;(_EPOLLIN|_EPOLLRDHUP|_EPOLLHUP|_EPOLLERR) !&#x3D; 0 &#123;</span><br><span class="line">            mode +&#x3D; &#39;r&#39;</span><br><span class="line">        &#125;</span><br><span class="line">        if ev.events&amp;(_EPOLLOUT|_EPOLLHUP|_EPOLLERR) !&#x3D; 0 &#123;</span><br><span class="line">            mode +&#x3D; &#39;w&#39;</span><br><span class="line">        &#125;</span><br><span class="line">        if mode !&#x3D; 0 &#123;</span><br><span class="line">            pd :&#x3D; *(**pollDesc)(unsafe.Pointer(&amp;ev.data))</span><br><span class="line">            pd.everr &#x3D; false</span><br><span class="line">            if ev.events &#x3D;&#x3D; _EPOLLERR &#123;</span><br><span class="line">                pd.everr &#x3D; true</span><br><span class="line">            &#125;</span><br><span class="line">            netpollready(&amp;toRun, pd, mode)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return toRun</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>netpoll</code> 会调用 <code>epollWait</code> 来获取 epoll 事件，而在 runtime 中很多地方都会调用 <code>netpoll</code> 函数<br><strong>监控函数 <code>sysmon</code></strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; src&#x2F;runtime&#x2F;proc.go</span><br><span class="line">func sysmon() &#123;</span><br><span class="line">    &#x2F;&#x2F; ....</span><br><span class="line">    for &#123;</span><br><span class="line">        &#x2F;&#x2F; ...</span><br><span class="line">        list :&#x3D; netpoll(0)</span><br><span class="line">        if !list.empty() &#123;</span><br><span class="line">            &#x2F;&#x2F;...</span><br><span class="line">            injectglist(&amp;list) &#x2F;&#x2F; 将 goroutine 放到 runable 队列中</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>查找可运行的 goroutine</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; src&#x2F;runtime&#x2F;proc.go</span><br><span class="line">func findrunable() (gp *g, inheritTIme bool) &#123;</span><br><span class="line">top:</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    if list :&#x3D; netpoll(0); !list.empty() &#123;</span><br><span class="line">        gp :&#x3D; list.pop()</span><br><span class="line">        injectglist(&amp;list)</span><br><span class="line">        &#x2F;&#x2F; ...</span><br><span class="line">        return gp, false</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; ....</span><br><span class="line">stop:</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    list :&#x3D; netpoll(delta) &#x2F;&#x2F; block until new work is available</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>GC 时调用 <code>startTheWorld</code></strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; src&#x2F;runtime&#x2F;proc.go</span><br><span class="line">func startTheWorld() &#123;</span><br><span class="line">    systemstack(func() &#123;startTheWorldWithSema(false)&#125;)</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line"> &#125;</span><br><span class="line">func startTheWorldWithSema(emitTraceEvent bool) int64 &#123;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    list :&#x3D; netpoll(0)</span><br><span class="line">    injectglist(&amp;list)</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通常获取可用的 goroutine 时都可能有机会去调用 <code>netpoll</code>，然后再调用 <code>injectglist(&amp;list)</code> 将可运行 goroutine 加入到<code>runq</code>队列中</p>
<h1 id="系统级异步接口-——-io-uring"><a href="#系统级异步接口-——-io-uring" class="headerlink" title="系统级异步接口 —— io_uring"></a>系统级异步接口 —— io_uring</h1><blockquote>
<p>本节不会详细介绍 io_uring 的具体操作，关于 io_uring 的使用，可以查看 <a target="_blank" rel="noopener" href="https://unixism.net/loti/index.html">Lord of the io_uring</a></p>
</blockquote>
<p>Linux kernel 5.1 新增了异步接口 <code>io_uring</code>，它是 Jens Axboe 以高效，可扩展，易用为目的设计的一种全新异步接口，为什么是全新呢，因为 Linux 已经提供了异步 IO 接口 —— AIO，不过就连 Linus 都对它一阵吐槽<br><a target="_blank" rel="noopener" href="https://lwn.net/Articles/671657/">Re: [PATCH 09/13] aio: add support for async openat()</a></p>
<blockquote>
<p>So I think this is ridiculously ugly.<br>AIO is a horrible ad-hoc design, with the main excuse being “other,<br>less gifted people, made that design, and we are implementing it for<br>compatibility because database people - who seldom have any shred of<br>taste - actually use it”.<br>But AIO was always really really ugly.</p>
</blockquote>
<p>io_uring 提供的异步接口，不仅仅可以使用 文件 IO，套接字 IO，甚至未来可以扩展加入其它系统调用<br>而且 <code>io_uring</code> 采用应用程序和内核共享内存的方式，来提交请求和获取完成事件</p>
<blockquote>
<p>使用共享内存的方式可能是内核对接口优化的一种趋势</p>
</blockquote>
<p><strong>io<em>uring 名称的意思便是 _io use ring</em>，而 ring 便是指和内核内存共享的 <code>提交队列</code>和<code>完成队列</code>两个环形缓冲区</strong></p>
<h2 id="SubmissionQueueEntry"><a href="#SubmissionQueueEntry" class="headerlink" title="SubmissionQueueEntry"></a>SubmissionQueueEntry</h2><p>我们来看一下 io_uring 用来提交请求的结构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">struct io_uring_sqe &#123;</span><br><span class="line">        __u8    opcode;         &#x2F;* 请求的操作类型 *&#x2F;</span><br><span class="line">        __u8    flags;          &#x2F;* IOSQE_ flags *&#x2F;</span><br><span class="line">        __u16   ioprio;         &#x2F;* ioprio for the request *&#x2F;</span><br><span class="line">        __s32   fd;             &#x2F;* 用于 IO 的文件描述符 *&#x2F;</span><br><span class="line">        union &#123;</span><br><span class="line">                __u64   off;    &#x2F;* offset into file *&#x2F;</span><br><span class="line">                __u64   addr2;</span><br><span class="line">        &#125;;</span><br><span class="line">        union &#123;</span><br><span class="line">                __u64   addr;   &#x2F;* pointer to buffer or iovecs *&#x2F;</span><br><span class="line">                __u64   splice_off_in;</span><br><span class="line">        &#125;;</span><br><span class="line">        __u32   len;            &#x2F;* buffer size or number of iovecs *&#x2F;</span><br><span class="line"></span><br><span class="line">        &#x2F;*</span><br><span class="line">         * 用于特定操作的字段</span><br><span class="line">         *&#x2F;</span><br><span class="line">        union &#123;</span><br><span class="line">                __kernel_rwf_t  rw_flags;</span><br><span class="line">                __u32           fsync_flags;</span><br><span class="line">                __u16           poll_events;    &#x2F;* compatibility *&#x2F;</span><br><span class="line">                __u32           poll32_events;  &#x2F;* word-reversed for BE *&#x2F;</span><br><span class="line">                __u32           sync_range_flags;</span><br><span class="line">                __u32           msg_flags;</span><br><span class="line">                __u32           timeout_flags;</span><br><span class="line">                __u32           accept_flags;</span><br><span class="line">                __u32           cancel_flags;</span><br><span class="line">                __u32           open_flags;</span><br><span class="line">                __u32           statx_flags;</span><br><span class="line">                __u32           fadvise_advice;</span><br><span class="line">                __u32           splice_flags;</span><br><span class="line">        &#125;;</span><br><span class="line">        __u64   user_data;      &#x2F;* 用来关联请求的完成事件 *&#x2F;</span><br><span class="line">        union &#123;</span><br><span class="line">                struct &#123;</span><br><span class="line">                        &#x2F;* pack this to avoid bogus arm OABI complaints *&#x2F;</span><br><span class="line">                        union &#123;</span><br><span class="line">                                &#x2F;* index into fixed buffers, if used *&#x2F;</span><br><span class="line">                                __u16   buf_index;</span><br><span class="line">                                &#x2F;* for grouped buffer selection *&#x2F;</span><br><span class="line">                                __u16   buf_group;</span><br><span class="line">                        &#125; __attribute__((packed));</span><br><span class="line">                        &#x2F;* personality to use, if used *&#x2F;</span><br><span class="line">                        __u16   personality;</span><br><span class="line">                        __s32   splice_fd_in;</span><br><span class="line">                &#125;;</span><br><span class="line">                __u64   __pad2[3];</span><br><span class="line">        &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>io_uring_sqe</code> 一个非常复杂的结构，最核心的三个字段 <code>opcode</code>，<code>fd</code>，<code>user_data</code></p>
<ul>
<li><code>opcode</code> 指定具体是什么操作，比如 <code>IORING_OP_READV</code>，<code>IORING_OP_ACCEPT</code>，<code>IORING_OP_OPENAT</code>，现在支持 35 种操作</li>
<li><code>fd</code> 表示用于 IO 操作的文件描述符</li>
<li><code>user_data</code> 当请求操作完成后，io_uring 会生成一个完成事件放到 <code>完成队列(CompletionQueue)</code> 中，而 <code>user_data</code> 便是用来和<code>完成队列</code>中的事件进行绑定的，他会原封不动的复制到<code>完成队列的事件(cqe)</code>中</li>
<li><code>flags</code> 字段用来实现链式请求之类的功能<blockquote>
<p>可以发现 <code>opcode</code> 是 uint8，也就是现在来看最多支持 256 个系统调用，但是整个 <code>io_uring_sqe</code> 还为未来预留了一些空间 <code>__pad2</code></p>
</blockquote>
</li>
</ul>
<p><strong>通过 <code>opcode</code> 结合结合其他 <code>union</code> 的字段，便实现了扩展性极强的 <code>io_uring</code> 接口</strong></p>
<h2 id="CompletionQueueEvent"><a href="#CompletionQueueEvent" class="headerlink" title="CompletionQueueEvent"></a>CompletionQueueEvent</h2><p><code>完成队列事件(CompletionQueueEvent)</code> 的结构就比较简单了，主要是表示提交的异步操作执行的结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">struct io_uring_cqe &#123;</span><br><span class="line">        __u64   user_data;      &#x2F;* 直接复制 sqe-&gt;data *&#x2F;</span><br><span class="line">        __s32   res;            &#x2F;* 异步操作的结果 *&#x2F;</span><br><span class="line">        __u32   flags;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>user_data</code> 便是从 <code>sqe-&gt;data</code> 直接复制过来了，可以通过 <code>user_data</code> 绑定到对应的 <code>sqe</code><br><code>res</code> 便是异步操作执行的结果，如果 res &lt; 0，通常说明操作执行错误<br><code>flags</code> 暂时没有使用</p>
<h2 id="io-uring-setup"><a href="#io-uring-setup" class="headerlink" title="io_uring_setup"></a>io_uring_setup</h2><p><strong>io_uring 使用共享内存的方式，来提交请求和获取执行结果，减少内存拷贝带来的损耗</strong><br><code>io_uring_setup</code> 接口会接受一个指定提交队列大小的 <code>uint32</code> 类型参数和一个 <code>io_uring_params</code> 对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;linux&#x2F;io_uring.h&gt;</span><br><span class="line">int io_uring_setup(u32 entries, struct io_uring_params *p);</span><br></pre></td></tr></table></figure>

<p>调用成功会返回一个<code>文件描述符</code>，用于后续的操作</p>
<h4 id="io-uring-params"><a href="#io-uring-params" class="headerlink" title="io_uring_params"></a>io_uring_params</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">struct io_uring_params &#123;</span><br><span class="line">        __u32 sq_entries;</span><br><span class="line">        __u32 cq_entries;</span><br><span class="line">        __u32 flags;</span><br><span class="line">        __u32 sq_thread_cpu;</span><br><span class="line">        __u32 sq_thread_idle;</span><br><span class="line">        __u32 features;</span><br><span class="line">        __u32 wq_fd;</span><br><span class="line">        __u32 resv[3];</span><br><span class="line">        struct io_sqring_offsets sq_off;</span><br><span class="line">        struct io_cqring_offsets cq_off;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>io_uring_params</code> 不只用来配置 <code>io_uring</code> 实例，内核也会填充 <code>io_uring_params</code> 中关于 <code>io_uring</code> 实例的信息，比如用来映射共享内存的请求队列和完成队列字段的偏移量 - <code>io_sqring_offsets</code> 和 <code>io_cqring_offsets</code></p>
<h5 id="配置-io-uring"><a href="#配置-io-uring" class="headerlink" title="配置 io_uring"></a>配置 io_uring</h5><p><code>flags</code> 以位掩码的方式，结合相应 <code>sq_thread_cpu</code>，<code>sq_thread_idle</code> ，<code>wq_fd</code>，<code>cq_entries</code> 字段来配置 io_uring 实例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * io_uring_setup() flags</span><br><span class="line"> *&#x2F;</span><br><span class="line">#define IORING_SETUP_IOPOLL     (1U &lt;&lt; 0)       &#x2F;* io_context is polled *&#x2F;</span><br><span class="line">#define IORING_SETUP_SQPOLL     (1U &lt;&lt; 1)       &#x2F;* SQ poll thread *&#x2F;</span><br><span class="line">#define IORING_SETUP_SQ_AFF     (1U &lt;&lt; 2)       &#x2F;* sq_thread_cpu is valid *&#x2F;</span><br><span class="line">#define IORING_SETUP_CQSIZE     (1U &lt;&lt; 3)       &#x2F;* app defines CQ size *&#x2F;</span><br><span class="line">#define IORING_SETUP_CLAMP      (1U &lt;&lt; 4)       &#x2F;* clamp SQ&#x2F;CQ ring sizes *&#x2F;</span><br><span class="line">#define IORING_SETUP_ATTACH_WQ  (1U &lt;&lt; 5)       &#x2F;* attach to existing wq *&#x2F;</span><br><span class="line">#define IORING_SETUP_R_DISABLED (1U &lt;&lt; 6)       &#x2F;* start with ring disabled *&#x2F;</span><br></pre></td></tr></table></figure>

<p>通常 cq_entries 为 sq_entries 的两倍，通过 <code>flags</code> 指定 <code>IORING_SETUP_CQSIZE</code> ，然后设置 <code>cq_entries</code> 字段为指定大小</p>
<blockquote>
<p>cq_entries 不能小于 sq_entries</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/iceber/iouring-go">iouring-go</a> 提供了初始化 io_uring 对象时的配置函数，可以看一下这些函数的具体实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">type IOURingOption func(*IOURing)</span><br><span class="line">func New(entries uint, opts ...IOURingOption) (iour *IOURing, err error)</span><br><span class="line">func WithParams(params *iouring_syscall.IOURingParams) IOURingOption</span><br><span class="line">func WithAsync() IOURingOption</span><br><span class="line">func WithDisableRing() IOURingOption</span><br><span class="line">func WithCQSize(size uint32) IOURingOption</span><br><span class="line">func WithSQPoll() IOURingOption</span><br><span class="line">func WithSQPollThreadCPU(cpu uint32) IOURingOption</span><br><span class="line">func WithSQPollThreadIdle(idle time.Duration) IOURingOption</span><br></pre></td></tr></table></figure>

<h5 id="内核填充信息"><a href="#内核填充信息" class="headerlink" title="内核填充信息"></a>内核填充信息</h5><p>内核会向 <code>io_uring_params</code> 填充跟 io_uring 实例相关的信息<br><code>sq_entries</code> 请求队列的大小，<code>io_uring_setup</code> 会传递请求队列的大小 <code>entries</code>，io_uring 会根据 <code>entries</code> 设置 <code>sq_entries</code> 为 2 的次方大小<br><code>cq_entries</code> 完成队列的大小，通常为 <code>sq_entries</code> 的两倍，即使通过 <code>IORING_SETUP_CQSIZE</code> flag 设置了 <code>cq_enries</code> ，内核依然会以 2 的次方重新计算出 <code>cq_entries</code> 的大小<br><code>features</code> 记录了当前内核版本支持的一些功能</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * io_uring_params-&gt;features flags</span><br><span class="line"> *&#x2F;</span><br><span class="line">#define IORING_FEAT_SINGLE_MMAP         (1U &lt;&lt; 0)</span><br><span class="line">#define IORING_FEAT_NODROP              (1U &lt;&lt; 1)</span><br><span class="line">#define IORING_FEAT_SUBMIT_STABLE       (1U &lt;&lt; 2)</span><br><span class="line">#define IORING_FEAT_RW_CUR_POS          (1U &lt;&lt; 3)</span><br><span class="line">#define IORING_FEAT_CUR_PERSONALITY     (1U &lt;&lt; 4)</span><br><span class="line">#define IORING_FEAT_FAST_POLL           (1U &lt;&lt; 5)</span><br><span class="line">#define IORING_FEAT_POLL_32BITS         (1U &lt;&lt; 6)</span><br><span class="line">#define IORING_FEAT_SQPOLL_NONFIXED     (1U &lt;&lt; 7)</span><br></pre></td></tr></table></figure>

<p><code>io_sqring_offsets</code> 和 <code>io_cqring_offsets</code> 便是<code>SQ</code>和<code>CQ</code>在共享内存中的偏移量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">struct io_sqring_offsets &#123;</span><br><span class="line">        __u32 head;</span><br><span class="line">        __u32 tail;</span><br><span class="line">        __u32 ring_mask;</span><br><span class="line">        __u32 ring_entries;</span><br><span class="line">        __u32 flags;</span><br><span class="line">        __u32 dropped;</span><br><span class="line">        __u32 array;</span><br><span class="line">        __u32 resv1;</span><br><span class="line">        __u64 resv2;</span><br><span class="line">&#125;;</span><br><span class="line">struct io_cqring_offsets &#123;</span><br><span class="line">        __u32 head;</span><br><span class="line">        __u32 tail;</span><br><span class="line">        __u32 ring_mask;</span><br><span class="line">        __u32 ring_entries;</span><br><span class="line">        __u32 overflow;</span><br><span class="line">        __u32 cqes;</span><br><span class="line">        __u32 flags;</span><br><span class="line">        __u32 resv1;</span><br><span class="line">        __u64 resv2;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>根据这些偏移量便可以调用 mmap 来映射 SQ 和 CQ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ptr &#x3D; mmap(0, sq_off.array + sq_entries * sizeof(__u32),</span><br><span class="line">           PROT_READ|PROT_WRITE, MAP_SHARED|MAP_POPULATE,</span><br><span class="line">           ring_fd, IORING_OFF_SQ_RING);</span><br></pre></td></tr></table></figure>

<p>可以参考 <a target="_blank" rel="noopener" href="https://github.com/Iceber/iouring-go">iouring-go</a> 对 IOURing 对象的初始化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; iouring-go&#x2F;iouring.go</span><br><span class="line">func New(entries uint, opts ...IOURingOption) (*IOURing, error) &#123;</span><br><span class="line">    iour :&#x3D; &amp;IOURing&#123;</span><br><span class="line">        params:    &amp;iouring_syscall.IOURingParams&#123;&#125;,</span><br><span class="line">        userDatas: make(map[uint64]*UserData),</span><br><span class="line">        cqeSign:   make(chan struct&#123;&#125;, 1),</span><br><span class="line">        closer:    make(chan struct&#123;&#125;),</span><br><span class="line">        closed:    make(chan struct&#123;&#125;),</span><br><span class="line">    &#125;</span><br><span class="line">    for _, opt :&#x3D; range opts &#123;</span><br><span class="line">        opt(iour)</span><br><span class="line">    &#125;</span><br><span class="line">    var err error</span><br><span class="line">    iour.fd, err &#x3D; iouring_syscall.IOURingSetup(entries, iour.params)</span><br><span class="line">    if err !&#x3D; nil &#123;</span><br><span class="line">        return nil, err</span><br><span class="line">    &#125;</span><br><span class="line">    if err :&#x3D; mmapIOURing(iour); err !&#x3D; nil &#123;</span><br><span class="line">        munmapIOURing(iour)</span><br><span class="line">        return nil, err</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>mmapIOURing</code> 中实现了对请求队列以及完成队列的内存映射</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; iouring-go&#x2F;mmap.go</span><br><span class="line">func mmapIOURing(iour *IOURing) (err error) &#123;</span><br><span class="line">    defer func() &#123;</span><br><span class="line">        if err !&#x3D; nil &#123;</span><br><span class="line">            munmapIOURing(iour)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line">    iour.sq &#x3D; new(SubmissionQueue)</span><br><span class="line">    iour.cq &#x3D; new(CompletionQueue)</span><br><span class="line">    if err &#x3D; mmapSQ(iour); err !&#x3D; nil &#123;</span><br><span class="line">        return err</span><br><span class="line">    &#125;</span><br><span class="line">    if (iour.params.Features &amp; iouring_syscall.IORING_FEAT_SINGLE_MMAP) !&#x3D; 0 &#123;</span><br><span class="line">        iour.cq.ptr &#x3D; iour.sq.ptr</span><br><span class="line">    &#125;</span><br><span class="line">    if err &#x3D; mmapCQ(iour); err !&#x3D; nil &#123;</span><br><span class="line">        return err</span><br><span class="line">    &#125;</span><br><span class="line">    if err &#x3D; mmapSQEs(iour); err !&#x3D; nil &#123;</span><br><span class="line">        return err</span><br><span class="line">    &#125;</span><br><span class="line">    return nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里不再详细介绍 <code>io_uring</code> 的使用 ，想要了解更多可以查看文末的<a target="_blank" rel="noopener" href="http://icebergu.com/archives/go-iouring#%E6%8E%A8%E8%8D%90%E9%98%85%E8%AF%BB">推荐阅读</a></p>
<h2 id="io-uring-的功能"><a href="#io-uring-的功能" class="headerlink" title="io_uring 的功能"></a>io_uring 的功能</h2><p>这里简单介绍一下 <code>io_uring</code> 提供的一些功能，以及在 Go 中如何去使用</p>
<h3 id="顺序执行"><a href="#顺序执行" class="headerlink" title="顺序执行"></a>顺序执行</h3><p>设置 <code>sqe-&gt;flags</code> 的 <code>IOSQE_IO_DRAIN</code> 标记，这样只有当该 <code>sqe</code> 之前所有的 <code>sqes</code> 都完成后，才会执行该 <code>sqe</code>，而后续的 <code>sqe</code> 也会在该 <code>sqe</code> 完成后才会执行<br>在 <a target="_blank" rel="noopener" href="https://github.com/iceber/iouring-go">iouring-go</a> 中可以在构建 <code>IOURing</code> 对象时使用 <a target="_blank" rel="noopener" href="https://godoc.org/github.com/Iceber/iouring-go#WithDrain"><code>WithDrain</code></a> 来全局设置请求顺序执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iour :&#x3D; iouring.New(8, WithDrain())</span><br></pre></td></tr></table></figure>

<p>针对单一请求设置 <a target="_blank" rel="noopener" href="https://godoc.org/github.com/Iceber/iouring-go#PrepRequest.WithDrain"><code>WithDrain</code></a>，保证请求会在之前所有的请求都完成才会执行，而后续的请求也都会在该请求完成之后才会开始执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request, err :&#x3D; iour.SubmitRequest(iouring.Read(fd, buf).WithDrain(), nil)</span><br></pre></td></tr></table></figure>

<h3 id="链式请求"><a href="#链式请求" class="headerlink" title="链式请求"></a>链式请求</h3><p><code>io_uring</code> 提供了一组请求的链式/顺序执行的方法，可以让链中的请求会在上一个请求执行完成后才会执行，而且不影响链外其他请求的并发执行<br>设置 <code>sqe-&gt;flags</code> 的 <code>IOSQE_IO_LINK</code> 标记后，下一个 <code>sqe</code> 和当前 <code>sqe</code> 自动组成新链或者当前 <code>sqe</code> 的链中，链中没有设置 <code>IOSQWE_IO_LINK</code> 的 <code>sqe</code> 便是链尾<br>如果链中的有请求执行失败了，那么链中后续的 <code>sqe</code> 都会被取消( <code>cqe.res</code> 为 <code>-ECANCELED</code>)<br><strong><code>io_uring</code> 还提供了以外一种设置链式请求的方式，设置 <code>sqe-&gt;flags</code> 为 <code>IOSQE_IO_HARDLINK</code> flag，这种方式会让链中的请求忽略之前请求的结果，也就是说即使链中之前的请求执行失败了，也不会取消链中后边的请求</strong><br><a target="_blank" rel="noopener" href="https://github.com/iceber/iouring-go">iouring-go</a> 中可以使用 <a target="_blank" rel="noopener" href="https://godoc.org/github.com/Iceber/iouring-go#IOURing.SubmitLinkRequests"><code>SubmitLinkRequests</code></a> 或者 <a target="_blank" rel="noopener" href="https://godoc.org/github.com/Iceber/iouring-go#IOURing.SubmitHardLinkRequests"><code>SubmitHardLinkRequests</code></a> 方法来设置链式请求</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">preps :&#x3D; []iouring.PrepRequest&#123; iouring.Read(fd1, buf), iouring.Write(fd2, buf) &#125;</span><br><span class="line">requests, err :&#x3D; iour.SubmitLinkRequest(preps, nil)</span><br></pre></td></tr></table></figure>

<h3 id="请求取消"><a href="#请求取消" class="headerlink" title="请求取消"></a>请求取消</h3><p>当请求提交后，还可以提交取消请求的请求，这样如果请求还没有执行或者请求的操作可以被中断(比如 socket IO)，那么就可以被异步的取消，而对于已经启动的磁盘 IO 请求则无法取消<br>在 <a target="_blank" rel="noopener" href="https://github.com/iceber/iouring-go">iouring-go</a> 中，提交请求后会返回一个 <a target="_blank" rel="noopener" href="https://godoc.org/github.com/Iceber/iouring-go#Request"><code>iouring.Request</code></a> 对象，通过<code>request.Cancel</code> 方法就可以取消请求</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">request, err :&#x3D; iour.SubmitRequest(iouring.Timeout(1 * time.Second), nil)</span><br><span class="line">cancelRequest, err :&#x3D; request.Cancel()</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://godoc.org/github.com/Iceber/iouring-go#Request"><code>Cancel</code></a> 方法会返回一个 cancelRequest 对象，表示提交的取消请求<br>可以监听 <code>request</code> 的执行是否失败，并且失败原因是否为 <code>iouring.ErrRequestCanceled</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;- request.Done()</span><br><span class="line">if err :&#x3D; request.Err(); if err !&#x3D; nil &#123;</span><br><span class="line">    if err &#x3D;&#x3D; iouring.ErrRequestCanceled &#123;</span><br><span class="line">        fmt.Println(&quot;request is canceled&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也可去监听 cancelRequest 的执行结果，如果<code>cancelRequest.Err</code> 方法返回 <code>nil</code>，便是可能成功取消了，注意是可能取消了，因为一些操作是无法被取消的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;- cancelRequest.Done()</span><br><span class="line">if err :&#x3D; cancelRequest.Err(); if err !&#x3D; nil&#123;</span><br><span class="line">    if err &#x3D;&#x3D; iouring.ErrRequestNotFound()&#123;</span><br><span class="line">        fmt.Println(&quot;canceled request is not found&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; do something</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="定时和请求完成计数"><a href="#定时和请求完成计数" class="headerlink" title="定时和请求完成计数"></a>定时和请求完成计数</h3><p><code>io_uring</code> 提供了 <code>IORING_OP_TIMEOUT</code> 请求，可以用来提交超时请求<br>超时请求可以分为三种:</p>
<ul>
<li>相对时间超时</li>
<li>绝对时间超时</li>
<li>对请求完成计数，到达指定的完成事件数量后，超时请求就会完成</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/iceber/iouring-go">iouring-go</a> 对这三种情况封装了三个函数 <a target="_blank" rel="noopener" href="https://godoc.org/github.com/Iceber/iouring-go#Timeout"><code>iouring.Timeout</code></a>，<a target="_blank" rel="noopener" href="https://godoc.org/github.com/Iceber/iouring-go#TimeoutWithTime"><code>iouring.TimeoutWithTime</code></a>，<a target="_blank" rel="noopener" href="https://godoc.org/github.com/Iceber/iouring-go#CountCompletionEvent"><code>iouring.CountCompletionEvent</code></a> 来分别代表三种超时请求</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">now :&#x3D; time.Now()</span><br><span class="line">request, err :&#x3D; iouring.SubmitRequest(iouring.Timeout(2 * time.Second), nil)</span><br><span class="line">if err !&#x3D; nil &#123;</span><br><span class="line">    panic(err)</span><br><span class="line">&#125;</span><br><span class="line">&lt;- request.Done()</span><br><span class="line">fmt.Println(time.Now().Sub(now))</span><br></pre></td></tr></table></figure>

<p><strong>根据 <code>io_uring</code> 提供的超时请求，可以实现系统级的异步定时器</strong></p>
<h3 id="请求超时"><a href="#请求超时" class="headerlink" title="请求超时"></a>请求超时</h3><p><code>io_uring</code> 通过 <code>IOSQE_IO_LINK</code> 将一个请求和 <code>IORING_OP_LINK_TIMEOUT</code> 请求链接在一起，那么就可以做到请求的超时控制<br><a target="_blank" rel="noopener" href="https://github.com/iceber/iouring-go">iouring-go</a> 同样提供了简便方法 <a target="_blank" rel="noopener" href="https://godoc.org/github.com/Iceber/iouring-go#PrepRequest.WithTimeout"><code>WithTimeout</code></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">preps :&#x3D; iouring.Read(fd, buf).WithTimeout()</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://godoc.org/github.com/Iceber/iouring-go#PrepRequest.WithTimeout"><code>WithTimeout</code></a> 方法会返回两个 <a target="_blank" rel="noopener" href="https://godoc.org/github.com/Iceber/iouring-go#PrepRequest"><code>PrepRequest</code></a> 对象，所以需要使用 <a target="_blank" rel="noopener" href="https://godoc.org/github.com/Iceber/iouring-go#IOURing.SubmitRequests"><code>SubmitRequests</code></a> 来提交</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/iceber/iouring-go">iouring-go</a> 中请求超时的一些操作使用起来感觉还不是特别友好，有待优化</p>
</blockquote>
<h3 id="注册文件"><a href="#注册文件" class="headerlink" title="注册文件"></a>注册文件</h3><p><code>io_uring</code> 的一些 IO 操作需要提供文件描述符，而频繁的将文件和内核之间进行映射也会导致一定的性能损耗，所以可以使用 <code>io_uring</code> 的 <code>io_uring_register</code> 接口来提前注册文件描述符<br>详细的概念可以参考 <a target="_blank" rel="noopener" href="https://unixism.net/loti/ref-iouring/io_uring_register.html#io-uring-register">io_uring_register</a><br><a target="_blank" rel="noopener" href="https://github.com/iceber/iouring-go">iouring-go</a> 也提供了文件描述符的注册功能，而且对于已经注册的文件描述符会自动使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">func (iour *IOURing) RegisterFile(file *os.File) error</span><br><span class="line">func (iour *IOURing) RegisterFiles(files []*os.File) error</span><br><span class="line">func (iour *IOURing) UnregisterFile(file *os.File) error</span><br><span class="line">func (iour *IOURing) UnregisterFiles(files []*os.File) error</span><br></pre></td></tr></table></figure>

<p>当 <code>io_uring</code> 的文件描述符被关闭后，这些注册的文件会自动注销<br><em>需要注意，调用 <code>io_uring_register</code> 来注册文件描述符时，如果有其他的正在进行的请求的话，会等到这些请求都完成才会注册</em><br>注册文件描述符在 Go 中带来的并发问题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">type fileRegister struct &#123;</span><br><span class="line">    lock sync.Mutex</span><br><span class="line">    iouringFd int</span><br><span class="line">    fds          []int32</span><br><span class="line">    sparseindexs map[int]int</span><br><span class="line"></span><br><span class="line">    registered bool</span><br><span class="line">    indexs     sync.Map</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要注意由于存在对索引 <code>fileRegister.indexs</code> 的并发读写，所以使用 <code>sync.Map</code>，也就意味着，使用注册文件描述符，会带来一定的并发问题，经过简单的测试，<code>sync.Map</code> 带来的性能损耗导致注册文件描述符带来的优势并没有那么大的</p>
<blockquote>
<p>在 Go 中使用 <code>io_uring</code> 的最大问题便是对 <code>io_uring</code> 实例的竞争问题，而通过 Go 暴露给外部使用的并发机制，并不能让 <code>io_uring</code> 带来的异步 IO 发挥最大的性能<br>将 <code>io_uring</code> 融入 runtime 中，才是最终的解决方案</p>
</blockquote>
<h3 id="注册缓冲区"><a href="#注册缓冲区" class="headerlink" title="注册缓冲区"></a>注册缓冲区</h3><p>和注册文件描述符类似， <code>io_uring</code> 为了减少 IO 请求中缓冲区的映射，同样可以使用 <code>io_uring_register</code> 来注册缓冲区<br>如果要在请求中使用缓冲区的话，需要使用 <code>IORING_OP_READ_FIXED</code> 或者 <code>IORING_OP_WRITE_FIXED</code> 请求<br>具体可以参考 <a target="_blank" rel="noopener" href="https://unixism.net/loti/ref-iouring/io_uring_register.html#io-uring-register">io_uring_register</a></p>
<h3 id="内核侧请求队列轮询"><a href="#内核侧请求队列轮询" class="headerlink" title="内核侧请求队列轮询"></a>内核侧请求队列轮询</h3><p>将请求放到<code>SQ</code>的环形缓冲区后，需要调用 <code>io_uring_enter</code> 来通知内核有请求需要处理<br>io_uring 为了进一步减少系统调用，可以在 <code>io_uring_setup</code> 是设置 <code>io_uring_params-&gt;flags</code> 的 <code>IORING_SETUP_SQPOLL</code> flags，内核就会创建一个轮询请求队列的线程<br>可以通过 <code>ps</code> 命令查看用来轮询的内核线程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps --ppid 2 | grep io_uring-sq</span><br></pre></td></tr></table></figure>

<p>需要注意在 5.10 之前的版本，需要使用特权用户来执行，而 5.10 以后只需 <code>CAP_SYS_NICE</code> 权限即可<br>并且 5.10 之前，SQPoll 需要配合注册的文件描述符一起使用，而 5.10 以后则不需要，可以通过查看内核填充的 <code>io_uring_params-&gt;features</code> 是否设置了 <code>IORING_FEAT_SQPOLL_NONFIXED</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; iouring-go&#x2F;iouring.go</span><br><span class="line">func (iour *IOURing) doRequest(sqe *iouring_syscall.SubmissionQueueEntry, request PrepRequest, ch chan&lt;- Result) (*UserData, error) &#123;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    if sqe.Fd() &gt;&#x3D; 0 &#123;</span><br><span class="line">        if index, ok :&#x3D; iour.fileRegister.GetFileIndex(int32(sqe.Fd())); ok &#123;</span><br><span class="line">            sqe.SetFdIndex(int32(index))</span><br><span class="line">        &#125; else if iour.Flags&amp;iouring_syscall.IORING_SETUP_SQPOLL !&#x3D; 0 &amp;&amp;</span><br><span class="line">            iour.Features&amp;iouring_syscall.IORING_FEAT_SQPOLL_NONFIXED &#x3D;&#x3D; 0 &#123;</span><br><span class="line">            return nil, ErrUnregisteredFile</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>iouring-go 同样提供了开启 SQPoll 的 <a target="_blank" rel="noopener" href="https://godoc.org/github.com/Iceber/iouring-go#WithSQPoll"><code>WithSQPoll</code></a> 以及设置与 SQPoll 内核线程的相关配置 <a target="_blank" rel="noopener" href="https://godoc.org/github.com/Iceber/iouring-go#WithSQPollThreadCPU"><code>WithSQPollThreadCpu</code></a> 和 <a target="_blank" rel="noopener" href="https://godoc.org/github.com/Iceber/iouring-go#WithSQPollThreadIdle"><code>WithSQPollThreadIdle</code></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iour, err :&#x3D; iouring.New(8, iouring.WithSQPoll())</span><br></pre></td></tr></table></figure>

<p>但是在 Go 简单的设置 <code>io_uring_params</code> 并不能正常的工作，可能是由于 Go 的 GMP 模型导致的一些问题。暂时还在思考解决方案</p>
<h3 id="注册-eventfd，利用-epoll"><a href="#注册-eventfd，利用-epoll" class="headerlink" title="注册 eventfd，利用 epoll"></a>注册 eventfd，利用 epoll</h3><p>通过 <code>io_uring_register</code> 可以将 <code>eventfd</code> 注册到 io_uring 实例中，然后将 <code>eventfd</code> 加入到 <code>epoll</code> 中，如果当 io_uring 中有完成事件时，便会通知 <code>eventfd</code><br>在 <a target="_blank" rel="noopener" href="https://github.com/iceber/iouring-go">iouring-go</a> 中，对于完成事件的监听便是使用了 <code>eventfd</code> 和 <code>epoll</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">type IOURing struct &#123;</span><br><span class="line">    eventfd int</span><br><span class="line">    cqeSign chan struct&#123;&#125;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br><span class="line">func New() (*IOURing, error) &#123;</span><br><span class="line">    &#x2F;&#x2F; ....</span><br><span class="line">    if err :&#x3D; iour.registerEventfd(); err !&#x3D; nil &#123;</span><br><span class="line">        return nil, err</span><br><span class="line">    &#125;</span><br><span class="line">    if err :&#x3D; registerIOURing(iour); err !&#x3D; nil &#123;</span><br><span class="line">        return nil, err</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br><span class="line">func (iour *IOURing) registerEventfd() error &#123;</span><br><span class="line">    eventfd, err :&#x3D; unix.Eventfd(0, unix.EFD_NONBLOCK|unix.FD_CLOEXEC)</span><br><span class="line">    if err !&#x3D; nil &#123;</span><br><span class="line">         return os.NewSyscallError(&quot;eventfd&quot;, err)</span><br><span class="line">    &#125;</span><br><span class="line">    iour.eventfd &#x3D; eventfd</span><br><span class="line">    return iouring_syscall.IOURingRegister(</span><br><span class="line">        iour.fd,</span><br><span class="line">        iouring_syscall.IOURING_REGISTER_EVENTFD,</span><br><span class="line">        unsafe.Pointer(&amp;iour.eventfd), 1,</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line">func registerIOURing(iour *IOURing) error &#123;</span><br><span class="line">    if err :&#x3D; initpoller(); err !&#x3D; nil &#123;</span><br><span class="line">        return err</span><br><span class="line">    &#125;</span><br><span class="line">    if err :&#x3D; unix.EpollCtl(poller.fd, unix.EPOLL_CTL_ADD, iour.eventfd,</span><br><span class="line">         &amp;unix.EpollEvent&#123;Fd: int32(iour.eventfd), Events: unix.EPOLLIN | unix.EPOLLET&#125;,</span><br><span class="line">    ); err !&#x3D; nil &#123;</span><br><span class="line">         return os.NewSyscallError(&quot;epoll_ctl_add&quot;, err)</span><br><span class="line">    &#125;</span><br><span class="line">    poller.Lock()</span><br><span class="line">    poller.iours[iour.eventfd] &#x3D; iour</span><br><span class="line">    poller.Unlock()</span><br><span class="line">    return nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>poller</code> 会调用 EpollWait 等待<code>完成队列</code>中有完成事件，并通知相应的 IOURing 对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; iouring-go&#x2F;iouring.go</span><br><span class="line">func (iour *IOURing) getCQEvent(wait bool) (cqe *iouring_syscall.CompletionQueueEvent, err error) &#123;</span><br><span class="line">    var tryPeeks int</span><br><span class="line">    for &#123;</span><br><span class="line">        if cqe &#x3D; iour.cq.peek(); cqe !&#x3D; nil &#123;</span><br><span class="line">            iour.cq.advance(1)</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line">        if !wait &amp;&amp; !iour.sq.cqOverflow() &#123;</span><br><span class="line">            err &#x3D; syscall.EAGAIN</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line">        if iour.sq.cqOverflow() &#123;</span><br><span class="line">            _, err &#x3D; iouring_syscall.IOURingEnter(iour.fd, 0, 0, iouring_syscall.IORING_ENTER_FLAGS_GETEVENTS, nil)</span><br><span class="line">            if err !&#x3D; nil &#123;</span><br><span class="line">                return</span><br><span class="line">            &#125;</span><br><span class="line">            continue</span><br><span class="line">        &#125;</span><br><span class="line">        if tryPeeks++; tryPeeks &lt; 3 &#123;</span><br><span class="line">            runtime.Gosched()</span><br><span class="line">            continue</span><br><span class="line">        &#125;</span><br><span class="line">        select &#123;</span><br><span class="line">        case &lt;-iour.cqeSign:</span><br><span class="line">        case &lt;-iour.closer:</span><br><span class="line">            return nil, ErrIOURingClosed</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; iouring-go&#x2F;poller.go</span><br><span class="line">func (poller *iourPoller) run() &#123;</span><br><span class="line">    for &#123;</span><br><span class="line">        n, err :&#x3D; unix.EpollWait(poller.fd, poller.events, -1)</span><br><span class="line">        if err !&#x3D; nil &#123;</span><br><span class="line">            continue</span><br><span class="line">        &#125;</span><br><span class="line">        for i :&#x3D; 0; i &lt; n; i++ &#123;</span><br><span class="line">            fd :&#x3D; int(poller.events[i].Fd)</span><br><span class="line">            poller.Lock()</span><br><span class="line">            iour, ok :&#x3D; poller.iours[fd]</span><br><span class="line">            poller.Unlock()</span><br><span class="line">            if !ok &#123;</span><br><span class="line">                continue</span><br><span class="line">            &#125;</span><br><span class="line">            select &#123;</span><br><span class="line">            case iour.cqeSign &lt;- struct&#123;&#125;&#123;&#125;:</span><br><span class="line">            default:</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        poller.adjust()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="保证数据不丢失"><a href="#保证数据不丢失" class="headerlink" title="保证数据不丢失"></a>保证数据不丢失</h3><p>默认情况下， CQ 环的大小是 SQ 环的 两倍，为什么 SQ 环的大小会小于 CQ 环，是因为 SQ 环中的 sqe 一旦被内核发现，便会被内核消耗掉，也就意味着 sqe 的生命周期很短，而请求的完成事件都会放到 CQ 环中<br>我们也可以通过 <code>IORING_SETUP_CQSIZE</code> 或者 <code>iouring-go</code> 的 <code>WithCQSize</code> Option 里设置 CQ 环的大小<br>但是依然会存在 CQ 环溢出的情况，而内核会在内部存储溢出的时间，直到 CQ 环有空间容纳更多事件。</p>
<blockquote>
<p>可以通过 io_uring_params-&gt;features 是否设置 IORING_FEAT_NODROP 来判断当前内核是否支持该功能</p>
</blockquote>
<p>如果 CQ 环溢出，那么提交请求时可能会以 <code>-EBUSY</code> 错误失败，需要重新提交<br>并且当 CQ 环中数据被消耗后，需要调用 <code>io_uring_enter</code> 来通知内核 CQ 环中有空余空间</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">func (iour *IOURing) getCQEvent(wait bool) (cqe *iouring_syscall.CompletionQueueEvent, err error) &#123;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    if iour.sq.cqOverflow() &#123;</span><br><span class="line">        _, err :&#x3D; iour.syscall.IOURingEnter(iour.fd, 0, 0, iouring_syscall.IORING_ENTER_FLAGS_GETEVENTS, nil)</span><br><span class="line">        if err !&#x3D; nil&#123;</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line">        continue</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="io-uring-与-Go-——-iouring-go"><a href="#io-uring-与-Go-——-iouring-go" class="headerlink" title="io_uring 与 Go —— iouring-go"></a>io_uring 与 Go —— iouring-go</h1><h3 id="竞争问题"><a href="#竞争问题" class="headerlink" title="竞争问题"></a>竞争问题</h3><p>在实现 <a target="_blank" rel="noopener" href="https://github.com/iceber/iouring-go">iouring-go</a> 中遇到的问题，一个是并发导致对 <code>io_uring</code> 的竞争问题<br><strong>对于 CQ 环的竞争是使用单一的 CQ 环消费 goroutine <code>IOURing.run()</code> 来完成 <code>cqe</code> 的消费</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">func New(entries int, opts ...IOURingOption) (iour *IOURing, err error) &#123;</span><br><span class="line">    iour :&#x3D; &amp;IOURing&#123;...&#125;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    go iour.run()</span><br><span class="line">    return</span><br><span class="line">&#125;</span><br><span class="line">func (iour *IOURing) run() &#123;</span><br><span class="line">    for &#123;</span><br><span class="line">        cqe, err :&#x3D; iour.getCQEvent(true)</span><br><span class="line">        &#x2F;&#x2F; ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SQ 环的解决方案有两种</p>
<ol>
<li><strong>使用单独的提交 goroutine，将需要提交的请求通过内部 channel 发送给提交 goroutine，这样保证了 SQ 环的单一生产者</strong></li>
<li><strong>使用锁的方式，对于提交请求的函数加锁，保证同一时间只有一个 goroutine 在提交请求</strong></li>
</ol>
<p>第一种方式听起来使用 channel 更优雅一些，但是 channel 内部依然使用锁的方式以及额外的内存复制<br>另外最大的弊端就是将 <a target="_blank" rel="noopener" href="https://godoc.org/github.com/Iceber/iouring-go#IOURing"><code>IOURIng</code></a> 的<code>提交函数</code>（_将请求发送给提交 channel_）和真正将请求提交给内核（_调用 <code>io_uring_enter</code>通知内核有新的请求_）分开<br>当多个<code>提交函数</code> 向 channel 发送的请求的顺序无法保证，这样链式请求就无法实现（除非对于链式请求再次加锁）<br>第二种方式，采用加锁的方式，保证了同一时间只有一个提交函数在处理 SQ 环，并且可以立即是否真正提交成功（_调用 <code>IOURing.submit</code> 方法通知内核有新的请求_）<br><a target="_blank" rel="noopener" href="https://github.com/iceber/iouring-go">iouring-go</a> 采用了第二种方式<br>真正去解决这个问题的方式，估计可能只有 runtime 才能给出答案，为每一个 P 创建一个 io_uring 实例在 runtime 内部解决竞争问题，内部使用 eventfd 注册到 <code>netpoll</code> 中来获取<code>完成队列</code>通知</p>
<h3 id="io-uring-与-channel"><a href="#io-uring-与-channel" class="headerlink" title="io_uring 与 channel"></a>io_uring 与 channel</h3><p>对于 <a target="_blank" rel="noopener" href="https://github.com/iceber/iouring-go">iouring-go</a> 设计比较好的地方，我感觉便是对 channel 的利用，异步 IO 加上 channel，可以将异步在并发的程序中发挥出最大的作用<br><em>当然，如果只是简单的使用 channel 的话又会引入其他一些问题，后续会进行说明</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func (iour *IOURing) SubmitRequest(request PrepRequest, ch chan&lt;- Result) (Request, error)</span><br></pre></td></tr></table></figure>

<p><code>SubmitRequest</code> 方法接收一个 channel，当请求完成后，会将结果发送到 channel 中，这样通过多个请求复用同一个 channel，程序便可以监听一组请求的完成情况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">func (iour *IOURing) run() &#123;</span><br><span class="line">    for &#123;</span><br><span class="line">        cqe, err :&#x3D; iour.getCQEvent(true)</span><br><span class="line">        &#x2F;&#x2F; ...</span><br><span class="line">        userData :&#x3D; iour.userData[cqe.UserData]</span><br><span class="line">        &#x2F;&#x2F; ...</span><br><span class="line">        userData.request.complate(cqe)</span><br><span class="line">        if userData.resulter !&#x3D; nil &#123;</span><br><span class="line">            userData.resulter &lt;- userData.request</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而 <code>SubmitRequest</code> 方法同样会返回一个 Request 接口对象，通过 Request 我们同样可以去查看请求的是否完成已经它的完成结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">type Request interface &#123;</span><br><span class="line">	Result</span><br><span class="line">	Cancel() (Request, error)</span><br><span class="line">	Done() &lt;-chan struct&#123;&#125;</span><br><span class="line">	GetRes() (int, error)</span><br><span class="line">	&#x2F;&#x2F; Can Only be used in ResultResolver</span><br><span class="line">	SetResult(r0, r1 interface&#123;&#125;, err error) error</span><br><span class="line">&#125;</span><br><span class="line">type Result interface &#123;</span><br><span class="line">	Fd() int</span><br><span class="line">	Opcode() uint8</span><br><span class="line">	GetRequestBuffer() (b0, b1 []byte)</span><br><span class="line">	GetRequestBuffers() [][]byte</span><br><span class="line">	GetRequestInfo() interface&#123;&#125;</span><br><span class="line">	FreeRequestBuffer()</span><br><span class="line">	Err() error</span><br><span class="line">	ReturnValue0() interface&#123;&#125;</span><br><span class="line">	ReturnValue1() interface&#123;&#125;</span><br><span class="line">	ReturnFd() (int, error)</span><br><span class="line">	ReturnInt() (int, error)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>利用 channel 便可以完成对异步 IO 的异步监听和同步监听</p>
<h4 id="channel-带来的问题"><a href="#channel-带来的问题" class="headerlink" title="channel 带来的问题"></a>channel 带来的问题</h4><p>当然使用 channel 又会带来其他的问题，比如 channel 满了以后，对 io_uring 完成队列的消费便会阻塞在向 channel 发送数据，阻塞时间过长也会导致 CQ 环溢出<br>比较好的解决方案是，在 channel 上抽象出一层 <code>Resulter</code>，<code>Resulter</code> 会对完成事件进行自动缓冲，当然这也会带来一定的代码复杂度，所以 <a target="_blank" rel="noopener" href="https://github.com/iceber/iouring-go">iouring-go</a> 便将 channel 阻塞的问题交给使用者，要求 channel 的消费端尽快消费掉数据</p>
<h1 id="思考-io-uring-在-Go-中的发展"><a href="#思考-io-uring-在-Go-中的发展" class="headerlink" title="思考 io_uring 在 Go 中的发展"></a>思考 io_uring 在 Go 中的发展</h1><p><code>netpoll</code> 在 Linux 平台下使用了 <code>epoll</code>，而且 <code>epoll</code> 在使用上并没有竞争问题，当然如果要使用 <code>io_uring</code> 来替代 <code>epoll</code> 来实现 <code>netpoll</code> 的话并不是不可能，只是这样对于工作很好的 epoll 来说并没有什么必要，而且是否能够带来可观的性能收益也都是不确定的<br>在高并发的情况下，有限的 SQ 环和 CQ 环，对于请求数量大于完成事件的消费速度的情况，CQ 环的大量溢出带来对内核的压力以及新的请求提交带来的错误处理，都会提高真正利用 <code>io_uring</code> 的难度<br>对于 SQ 环和 CQ 环的大小限制，也许需要通过 Pool 的方式来解决，初始化多个 io_uring 实例，当一个实例的 SQ 环满，那么就使用另外的实例来提交请求<br>而使用 Pool 又会增加一定的复杂度<br><code>io_uring</code> 的功能实际可以覆盖了 <code>epoll</code> 的，比如提交的阻塞 IO 请求便相当于 <code>epoll</code> + <code>syscall</code>，另外 <code>io_uring</code> 还提供了超时设置和请求的超时控制，相当于实现了系统级的定时器以及 <code>netpoll</code> 的 deadline<br>但是 epoll 自身的优势，比如没有竞争问题，没有监听文件描述符的数量限制，都让 epoll 在实际的使用中更加好用，而这些问题对于 <code>io_uring</code> 在本身设计上就会导致的问题<br>比如竞争问题，使用环形缓冲区可以协调应用和内核对请求队列的访问，但是应用中多个线程或者 goroutine 就会引发对环形缓冲区的竞争问题<br>而请求数量的限制，那么就需要考虑到请求完成事件的溢出问题，内核不能无限制的去保存溢出的完成事件，当然这个问题通过应用中在 <code>io_uring</code> 实例上抽象出 <code>io_uring 池</code>的方式来解决<br>使用 <code>io_uring</code> 来实现异步网络框架，对已有的网络模型会是非常大的冲击，怎么去使用 <code>io_uring</code> 来发挥最大的能力依然处于探索阶段，毕竟 <code>io_uring</code> 是一个出现才 1 年的技术<br>而对于普通的磁盘 IO 来说，<code>io_uring</code> 还是有很大的发挥空间的，利用 Go 中已有的并发机制，结合具体的性能评估，对于文件服务器来说，也许会带来极大的提升<br><strong>另外一个问题便是，对于 5.1 引入，5.6 开始功能变得丰富成熟的 <code>io_uring</code> 来说，现在大量的环境处于 3.X，4.X，甚至 2.X ， <code>io_uring</code> 仍然需要等待时机才能去发挥它真正的作用，而这段时间便是留给我们去探讨怎么让 <code>io_uring</code> 更好用</strong></p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2021/03/15/yuque/Go%20%E4%B8%8E%E5%BC%82%E6%AD%A5%20IO%20-%20io_uring%20%E7%9A%84%E6%80%9D%E8%80%83/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/2/">&amp;laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/19/">19</a><a class="extend next" rel="next" href="/page/4/">Next &amp;raquo;</a>
    </nav>
  


          </div>
        </div>
      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2021 Murphy Yi
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		mathjax: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		toc_hide_index: true,
		root: "/",
		innerArchive: true,
		showTags: false
	}
</script>

<script>!function(t){function n(e){if(r[e])return r[e].exports;var i=r[e]={exports:{},id:e,loaded:!1};return t[e].call(i.exports,i,i.exports,n),i.loaded=!0,i.exports}var r={};n.m=t,n.c=r,n.p="./",n(0)}([function(t,n,r){r(195),t.exports=r(191)},function(t,n,r){var e=r(3),i=r(52),o=r(27),u=r(28),c=r(53),f="prototype",a=function(t,n,r){var s,l,h,v,p=t&a.F,d=t&a.G,y=t&a.S,g=t&a.P,b=t&a.B,m=d?e:y?e[n]||(e[n]={}):(e[n]||{})[f],x=d?i:i[n]||(i[n]={}),w=x[f]||(x[f]={});d&&(r=n);for(s in r)l=!p&&m&&void 0!==m[s],h=(l?m:r)[s],v=b&&l?c(h,e):g&&"function"==typeof h?c(Function.call,h):h,m&&u(m,s,h,t&a.U),x[s]!=h&&o(x,s,v),g&&w[s]!=h&&(w[s]=h)};e.core=i,a.F=1,a.G=2,a.S=4,a.P=8,a.B=16,a.W=32,a.U=64,a.R=128,t.exports=a},function(t,n,r){var e=r(6);t.exports=function(t){if(!e(t))throw TypeError(t+" is not an object!");return t}},function(t,n){var r=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=r)},function(t,n){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,n){var r=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=r)},function(t,n){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,n,r){var e=r(126)("wks"),i=r(76),o=r(3).Symbol,u="function"==typeof o;(t.exports=function(t){return e[t]||(e[t]=u&&o[t]||(u?o:i)("Symbol."+t))}).store=e},function(t,n){var r={}.hasOwnProperty;t.exports=function(t,n){return r.call(t,n)}},function(t,n,r){var e=r(94),i=r(33);t.exports=function(t){return e(i(t))}},function(t,n,r){t.exports=!r(4)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,n,r){var e=r(2),i=r(167),o=r(50),u=Object.defineProperty;n.f=r(10)?Object.defineProperty:function(t,n,r){if(e(t),n=o(n,!0),e(r),i)try{return u(t,n,r)}catch(t){}if("get"in r||"set"in r)throw TypeError("Accessors not supported!");return"value"in r&&(t[n]=r.value),t}},function(t,n,r){t.exports=!r(18)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,n,r){var e=r(14),i=r(22);t.exports=r(12)?function(t,n,r){return e.f(t,n,i(1,r))}:function(t,n,r){return t[n]=r,t}},function(t,n,r){var e=r(20),i=r(58),o=r(42),u=Object.defineProperty;n.f=r(12)?Object.defineProperty:function(t,n,r){if(e(t),n=o(n,!0),e(r),i)try{return u(t,n,r)}catch(t){}if("get"in r||"set"in r)throw TypeError("Accessors not supported!");return"value"in r&&(t[n]=r.value),t}},function(t,n,r){var e=r(40)("wks"),i=r(23),o=r(5).Symbol,u="function"==typeof o;(t.exports=function(t){return e[t]||(e[t]=u&&o[t]||(u?o:i)("Symbol."+t))}).store=e},function(t,n,r){var e=r(67),i=Math.min;t.exports=function(t){return t>0?i(e(t),9007199254740991):0}},function(t,n,r){var e=r(46);t.exports=function(t){return Object(e(t))}},function(t,n){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,n,r){var e=r(63),i=r(34);t.exports=Object.keys||function(t){return e(t,i)}},function(t,n,r){var e=r(21);t.exports=function(t){if(!e(t))throw TypeError(t+" is not an object!");return t}},function(t,n){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,n){t.exports=function(t,n){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:n}}},function(t,n){var r=0,e=Math.random();t.exports=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++r+e).toString(36))}},function(t,n){var r={}.hasOwnProperty;t.exports=function(t,n){return r.call(t,n)}},function(t,n){var r=t.exports={version:"2.4.0"};"number"==typeof __e&&(__e=r)},function(t,n){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,n,r){var e=r(11),i=r(66);t.exports=r(10)?function(t,n,r){return e.f(t,n,i(1,r))}:function(t,n,r){return t[n]=r,t}},function(t,n,r){var e=r(3),i=r(27),o=r(24),u=r(76)("src"),c="toString",f=Function[c],a=(""+f).split(c);r(52).inspectSource=function(t){return f.call(t)},(t.exports=function(t,n,r,c){var f="function"==typeof r;f&&(o(r,"name")||i(r,"name",n)),t[n]!==r&&(f&&(o(r,u)||i(r,u,t[n]?""+t[n]:a.join(String(n)))),t===e?t[n]=r:c?t[n]?t[n]=r:i(t,n,r):(delete t[n],i(t,n,r)))})(Function.prototype,c,function(){return"function"==typeof this&&this[u]||f.call(this)})},function(t,n,r){var e=r(1),i=r(4),o=r(46),u=function(t,n,r,e){var i=String(o(t)),u="<"+n;return""!==r&&(u+=" "+r+'="'+String(e).replace(/"/g,"&quot;")+'"'),u+">"+i+"</"+n+">"};t.exports=function(t,n){var r={};r[t]=n(u),e(e.P+e.F*i(function(){var n=""[t]('"');return n!==n.toLowerCase()||n.split('"').length>3}),"String",r)}},function(t,n,r){var e=r(115),i=r(46);t.exports=function(t){return e(i(t))}},function(t,n,r){var e=r(116),i=r(66),o=r(30),u=r(50),c=r(24),f=r(167),a=Object.getOwnPropertyDescriptor;n.f=r(10)?a:function(t,n){if(t=o(t),n=u(n,!0),f)try{return a(t,n)}catch(t){}if(c(t,n))return i(!e.f.call(t,n),t[n])}},function(t,n,r){var e=r(24),i=r(17),o=r(145)("IE_PROTO"),u=Object.prototype;t.exports=Object.getPrototypeOf||function(t){return t=i(t),e(t,o)?t[o]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?u:null}},function(t,n){t.exports=function(t){if(void 0==t)throw TypeError("Can't call method on  "+t);return t}},function(t,n){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,n){t.exports={}},function(t,n){t.exports=!0},function(t,n){n.f={}.propertyIsEnumerable},function(t,n,r){var e=r(14).f,i=r(8),o=r(15)("toStringTag");t.exports=function(t,n,r){t&&!i(t=r?t:t.prototype,o)&&e(t,o,{configurable:!0,value:n})}},function(t,n,r){var e=r(40)("keys"),i=r(23);t.exports=function(t){return e[t]||(e[t]=i(t))}},function(t,n,r){var e=r(5),i="__core-js_shared__",o=e[i]||(e[i]={});t.exports=function(t){return o[t]||(o[t]={})}},function(t,n){var r=Math.ceil,e=Math.floor;t.exports=function(t){return isNaN(t=+t)?0:(t>0?e:r)(t)}},function(t,n,r){var e=r(21);t.exports=function(t,n){if(!e(t))return t;var r,i;if(n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;if("function"==typeof(r=t.valueOf)&&!e(i=r.call(t)))return i;if(!n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;throw TypeError("Can't convert object to primitive value")}},function(t,n,r){var e=r(5),i=r(25),o=r(36),u=r(44),c=r(14).f;t.exports=function(t){var n=i.Symbol||(i.Symbol=o?{}:e.Symbol||{});"_"==t.charAt(0)||t in n||c(n,t,{value:u.f(t)})}},function(t,n,r){n.f=r(15)},function(t,n){var r={}.toString;t.exports=function(t){return r.call(t).slice(8,-1)}},function(t,n){t.exports=function(t){if(void 0==t)throw TypeError("Can't call method on  "+t);return t}},function(t,n,r){var e=r(4);t.exports=function(t,n){return!!t&&e(function(){n?t.call(null,function(){},1):t.call(null)})}},function(t,n,r){var e=r(53),i=r(115),o=r(17),u=r(16),c=r(203);t.exports=function(t,n){var r=1==t,f=2==t,a=3==t,s=4==t,l=6==t,h=5==t||l,v=n||c;return function(n,c,p){for(var d,y,g=o(n),b=i(g),m=e(c,p,3),x=u(b.length),w=0,S=r?v(n,x):f?v(n,0):void 0;x>w;w++)if((h||w in b)&&(d=b[w],y=m(d,w,g),t))if(r)S[w]=y;else if(y)switch(t){case 3:return!0;case 5:return d;case 6:return w;case 2:S.push(d)}else if(s)return!1;return l?-1:a||s?s:S}}},function(t,n,r){var e=r(1),i=r(52),o=r(4);t.exports=function(t,n){var r=(i.Object||{})[t]||Object[t],u={};u[t]=n(r),e(e.S+e.F*o(function(){r(1)}),"Object",u)}},function(t,n,r){var e=r(6);t.exports=function(t,n){if(!e(t))return t;var r,i;if(n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;if("function"==typeof(r=t.valueOf)&&!e(i=r.call(t)))return i;if(!n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;throw TypeError("Can't convert object to primitive value")}},function(t,n,r){var e=r(5),i=r(25),o=r(91),u=r(13),c="prototype",f=function(t,n,r){var a,s,l,h=t&f.F,v=t&f.G,p=t&f.S,d=t&f.P,y=t&f.B,g=t&f.W,b=v?i:i[n]||(i[n]={}),m=b[c],x=v?e:p?e[n]:(e[n]||{})[c];v&&(r=n);for(a in r)(s=!h&&x&&void 0!==x[a])&&a in b||(l=s?x[a]:r[a],b[a]=v&&"function"!=typeof x[a]?r[a]:y&&s?o(l,e):g&&x[a]==l?function(t){var n=function(n,r,e){if(this instanceof t){switch(arguments.length){case 0:return new t;case 1:return new t(n);case 2:return new t(n,r)}return new t(n,r,e)}return t.apply(this,arguments)};return n[c]=t[c],n}(l):d&&"function"==typeof l?o(Function.call,l):l,d&&((b.virtual||(b.virtual={}))[a]=l,t&f.R&&m&&!m[a]&&u(m,a,l)))};f.F=1,f.G=2,f.S=4,f.P=8,f.B=16,f.W=32,f.U=64,f.R=128,t.exports=f},function(t,n){var r=t.exports={version:"2.4.0"};"number"==typeof __e&&(__e=r)},function(t,n,r){var e=r(26);t.exports=function(t,n,r){if(e(t),void 0===n)return t;switch(r){case 1:return function(r){return t.call(n,r)};case 2:return function(r,e){return t.call(n,r,e)};case 3:return function(r,e,i){return t.call(n,r,e,i)}}return function(){return t.apply(n,arguments)}}},function(t,n,r){var e=r(183),i=r(1),o=r(126)("metadata"),u=o.store||(o.store=new(r(186))),c=function(t,n,r){var i=u.get(t);if(!i){if(!r)return;u.set(t,i=new e)}var o=i.get(n);if(!o){if(!r)return;i.set(n,o=new e)}return o},f=function(t,n,r){var e=c(n,r,!1);return void 0!==e&&e.has(t)},a=function(t,n,r){var e=c(n,r,!1);return void 0===e?void 0:e.get(t)},s=function(t,n,r,e){c(r,e,!0).set(t,n)},l=function(t,n){var r=c(t,n,!1),e=[];return r&&r.forEach(function(t,n){e.push(n)}),e},h=function(t){return void 0===t||"symbol"==typeof t?t:String(t)},v=function(t){i(i.S,"Reflect",t)};t.exports={store:u,map:c,has:f,get:a,set:s,keys:l,key:h,exp:v}},function(t,n,r){"use strict";if(r(10)){var e=r(69),i=r(3),o=r(4),u=r(1),c=r(127),f=r(152),a=r(53),s=r(68),l=r(66),h=r(27),v=r(73),p=r(67),d=r(16),y=r(75),g=r(50),b=r(24),m=r(180),x=r(114),w=r(6),S=r(17),_=r(137),O=r(70),E=r(32),P=r(71).f,j=r(154),F=r(76),M=r(7),A=r(48),N=r(117),T=r(146),I=r(155),k=r(80),L=r(123),R=r(74),C=r(130),D=r(160),U=r(11),W=r(31),G=U.f,B=W.f,V=i.RangeError,z=i.TypeError,q=i.Uint8Array,K="ArrayBuffer",J="Shared"+K,Y="BYTES_PER_ELEMENT",H="prototype",$=Array[H],X=f.ArrayBuffer,Q=f.DataView,Z=A(0),tt=A(2),nt=A(3),rt=A(4),et=A(5),it=A(6),ot=N(!0),ut=N(!1),ct=I.values,ft=I.keys,at=I.entries,st=$.lastIndexOf,lt=$.reduce,ht=$.reduceRight,vt=$.join,pt=$.sort,dt=$.slice,yt=$.toString,gt=$.toLocaleString,bt=M("iterator"),mt=M("toStringTag"),xt=F("typed_constructor"),wt=F("def_constructor"),St=c.CONSTR,_t=c.TYPED,Ot=c.VIEW,Et="Wrong length!",Pt=A(1,function(t,n){return Tt(T(t,t[wt]),n)}),jt=o(function(){return 1===new q(new Uint16Array([1]).buffer)[0]}),Ft=!!q&&!!q[H].set&&o(function(){new q(1).set({})}),Mt=function(t,n){if(void 0===t)throw z(Et);var r=+t,e=d(t);if(n&&!m(r,e))throw V(Et);return e},At=function(t,n){var r=p(t);if(r<0||r%n)throw V("Wrong offset!");return r},Nt=function(t){if(w(t)&&_t in t)return t;throw z(t+" is not a typed array!")},Tt=function(t,n){if(!(w(t)&&xt in t))throw z("It is not a typed array constructor!");return new t(n)},It=function(t,n){return kt(T(t,t[wt]),n)},kt=function(t,n){for(var r=0,e=n.length,i=Tt(t,e);e>r;)i[r]=n[r++];return i},Lt=function(t,n,r){G(t,n,{get:function(){return this._d[r]}})},Rt=function(t){var n,r,e,i,o,u,c=S(t),f=arguments.length,s=f>1?arguments[1]:void 0,l=void 0!==s,h=j(c);if(void 0!=h&&!_(h)){for(u=h.call(c),e=[],n=0;!(o=u.next()).done;n++)e.push(o.value);c=e}for(l&&f>2&&(s=a(s,arguments[2],2)),n=0,r=d(c.length),i=Tt(this,r);r>n;n++)i[n]=l?s(c[n],n):c[n];return i},Ct=function(){for(var t=0,n=arguments.length,r=Tt(this,n);n>t;)r[t]=arguments[t++];return r},Dt=!!q&&o(function(){gt.call(new q(1))}),Ut=function(){return gt.apply(Dt?dt.call(Nt(this)):Nt(this),arguments)},Wt={copyWithin:function(t,n){return D.call(Nt(this),t,n,arguments.length>2?arguments[2]:void 0)},every:function(t){return rt(Nt(this),t,arguments.length>1?arguments[1]:void 0)},fill:function(t){return C.apply(Nt(this),arguments)},filter:function(t){return It(this,tt(Nt(this),t,arguments.length>1?arguments[1]:void 0))},find:function(t){return et(Nt(this),t,arguments.length>1?arguments[1]:void 0)},findIndex:function(t){return it(Nt(this),t,arguments.length>1?arguments[1]:void 0)},forEach:function(t){Z(Nt(this),t,arguments.length>1?arguments[1]:void 0)},indexOf:function(t){return ut(Nt(this),t,arguments.length>1?arguments[1]:void 0)},includes:function(t){return ot(Nt(this),t,arguments.length>1?arguments[1]:void 0)},join:function(t){return vt.apply(Nt(this),arguments)},lastIndexOf:function(t){return st.apply(Nt(this),arguments)},map:function(t){return Pt(Nt(this),t,arguments.length>1?arguments[1]:void 0)},reduce:function(t){return lt.apply(Nt(this),arguments)},reduceRight:function(t){return ht.apply(Nt(this),arguments)},reverse:function(){for(var t,n=this,r=Nt(n).length,e=Math.floor(r/2),i=0;i<e;)t=n[i],n[i++]=n[--r],n[r]=t;return n},some:function(t){return nt(Nt(this),t,arguments.length>1?arguments[1]:void 0)},sort:function(t){return pt.call(Nt(this),t)},subarray:function(t,n){var r=Nt(this),e=r.length,i=y(t,e);return new(T(r,r[wt]))(r.buffer,r.byteOffset+i*r.BYTES_PER_ELEMENT,d((void 0===n?e:y(n,e))-i))}},Gt=function(t,n){return It(this,dt.call(Nt(this),t,n))},Bt=function(t){Nt(this);var n=At(arguments[1],1),r=this.length,e=S(t),i=d(e.length),o=0;if(i+n>r)throw V(Et);for(;o<i;)this[n+o]=e[o++]},Vt={entries:function(){return at.call(Nt(this))},keys:function(){return ft.call(Nt(this))},values:function(){return ct.call(Nt(this))}},zt=function(t,n){return w(t)&&t[_t]&&"symbol"!=typeof n&&n in t&&String(+n)==String(n)},qt=function(t,n){return zt(t,n=g(n,!0))?l(2,t[n]):B(t,n)},Kt=function(t,n,r){return!(zt(t,n=g(n,!0))&&w(r)&&b(r,"value"))||b(r,"get")||b(r,"set")||r.configurable||b(r,"writable")&&!r.writable||b(r,"enumerable")&&!r.enumerable?G(t,n,r):(t[n]=r.value,t)};St||(W.f=qt,U.f=Kt),u(u.S+u.F*!St,"Object",{getOwnPropertyDescriptor:qt,defineProperty:Kt}),o(function(){yt.call({})})&&(yt=gt=function(){return vt.call(this)});var Jt=v({},Wt);v(Jt,Vt),h(Jt,bt,Vt.values),v(Jt,{slice:Gt,set:Bt,constructor:function(){},toString:yt,toLocaleString:Ut}),Lt(Jt,"buffer","b"),Lt(Jt,"byteOffset","o"),Lt(Jt,"byteLength","l"),Lt(Jt,"length","e"),G(Jt,mt,{get:function(){return this[_t]}}),t.exports=function(t,n,r,f){f=!!f;var a=t+(f?"Clamped":"")+"Array",l="Uint8Array"!=a,v="get"+t,p="set"+t,y=i[a],g=y||{},b=y&&E(y),m=!y||!c.ABV,S={},_=y&&y[H],j=function(t,r){var e=t._d;return e.v[v](r*n+e.o,jt)},F=function(t,r,e){var i=t._d;f&&(e=(e=Math.round(e))<0?0:e>255?255:255&e),i.v[p](r*n+i.o,e,jt)},M=function(t,n){G(t,n,{get:function(){return j(this,n)},set:function(t){return F(this,n,t)},enumerable:!0})};m?(y=r(function(t,r,e,i){s(t,y,a,"_d");var o,u,c,f,l=0,v=0;if(w(r)){if(!(r instanceof X||(f=x(r))==K||f==J))return _t in r?kt(y,r):Rt.call(y,r);o=r,v=At(e,n);var p=r.byteLength;if(void 0===i){if(p%n)throw V(Et);if((u=p-v)<0)throw V(Et)}else if((u=d(i)*n)+v>p)throw V(Et);c=u/n}else c=Mt(r,!0),u=c*n,o=new X(u);for(h(t,"_d",{b:o,o:v,l:u,e:c,v:new Q(o)});l<c;)M(t,l++)}),_=y[H]=O(Jt),h(_,"constructor",y)):L(function(t){new y(null),new y(t)},!0)||(y=r(function(t,r,e,i){s(t,y,a);var o;return w(r)?r instanceof X||(o=x(r))==K||o==J?void 0!==i?new g(r,At(e,n),i):void 0!==e?new g(r,At(e,n)):new g(r):_t in r?kt(y,r):Rt.call(y,r):new g(Mt(r,l))}),Z(b!==Function.prototype?P(g).concat(P(b)):P(g),function(t){t in y||h(y,t,g[t])}),y[H]=_,e||(_.constructor=y));var A=_[bt],N=!!A&&("values"==A.name||void 0==A.name),T=Vt.values;h(y,xt,!0),h(_,_t,a),h(_,Ot,!0),h(_,wt,y),(f?new y(1)[mt]==a:mt in _)||G(_,mt,{get:function(){return a}}),S[a]=y,u(u.G+u.W+u.F*(y!=g),S),u(u.S,a,{BYTES_PER_ELEMENT:n,from:Rt,of:Ct}),Y in _||h(_,Y,n),u(u.P,a,Wt),R(a),u(u.P+u.F*Ft,a,{set:Bt}),u(u.P+u.F*!N,a,Vt),u(u.P+u.F*(_.toString!=yt),a,{toString:yt}),u(u.P+u.F*o(function(){new y(1).slice()}),a,{slice:Gt}),u(u.P+u.F*(o(function(){return[1,2].toLocaleString()!=new y([1,2]).toLocaleString()})||!o(function(){_.toLocaleString.call([1,2])})),a,{toLocaleString:Ut}),k[a]=N?A:T,e||N||h(_,bt,T)}}else t.exports=function(){}},function(t,n){var r={}.toString;t.exports=function(t){return r.call(t).slice(8,-1)}},function(t,n,r){var e=r(21),i=r(5).document,o=e(i)&&e(i.createElement);t.exports=function(t){return o?i.createElement(t):{}}},function(t,n,r){t.exports=!r(12)&&!r(18)(function(){return 7!=Object.defineProperty(r(57)("div"),"a",{get:function(){return 7}}).a})},function(t,n,r){"use strict";var e=r(36),i=r(51),o=r(64),u=r(13),c=r(8),f=r(35),a=r(96),s=r(38),l=r(103),h=r(15)("iterator"),v=!([].keys&&"next"in[].keys()),p="keys",d="values",y=function(){return this};t.exports=function(t,n,r,g,b,m,x){a(r,n,g);var w,S,_,O=function(t){if(!v&&t in F)return F[t];switch(t){case p:case d:return function(){return new r(this,t)}}return function(){return new r(this,t)}},E=n+" Iterator",P=b==d,j=!1,F=t.prototype,M=F[h]||F["@@iterator"]||b&&F[b],A=M||O(b),N=b?P?O("entries"):A:void 0,T="Array"==n?F.entries||M:M;if(T&&(_=l(T.call(new t)))!==Object.prototype&&(s(_,E,!0),e||c(_,h)||u(_,h,y)),P&&M&&M.name!==d&&(j=!0,A=function(){return M.call(this)}),e&&!x||!v&&!j&&F[h]||u(F,h,A),f[n]=A,f[E]=y,b)if(w={values:P?A:O(d),keys:m?A:O(p),entries:N},x)for(S in w)S in F||o(F,S,w[S]);else i(i.P+i.F*(v||j),n,w);return w}},function(t,n,r){var e=r(20),i=r(100),o=r(34),u=r(39)("IE_PROTO"),c=function(){},f="prototype",a=function(){var t,n=r(57)("iframe"),e=o.length;for(n.style.display="none",r(93).appendChild(n),n.src="javascript:",t=n.contentWindow.document,t.open(),t.write("<script>document.F=Object<\/script>"),t.close(),a=t.F;e--;)delete a[f][o[e]];return a()};t.exports=Object.create||function(t,n){var r;return null!==t?(c[f]=e(t),r=new c,c[f]=null,r[u]=t):r=a(),void 0===n?r:i(r,n)}},function(t,n,r){var e=r(63),i=r(34).concat("length","prototype");n.f=Object.getOwnPropertyNames||function(t){return e(t,i)}},function(t,n){n.f=Object.getOwnPropertySymbols},function(t,n,r){var e=r(8),i=r(9),o=r(90)(!1),u=r(39)("IE_PROTO");t.exports=function(t,n){var r,c=i(t),f=0,a=[];for(r in c)r!=u&&e(c,r)&&a.push(r);for(;n.length>f;)e(c,r=n[f++])&&(~o(a,r)||a.push(r));return a}},function(t,n,r){t.exports=r(13)},function(t,n,r){var e=r(76)("meta"),i=r(6),o=r(24),u=r(11).f,c=0,f=Object.isExtensible||function(){return!0},a=!r(4)(function(){return f(Object.preventExtensions({}))}),s=function(t){u(t,e,{value:{i:"O"+ ++c,w:{}}})},l=function(t,n){if(!i(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!o(t,e)){if(!f(t))return"F";if(!n)return"E";s(t)}return t[e].i},h=function(t,n){if(!o(t,e)){if(!f(t))return!0;if(!n)return!1;s(t)}return t[e].w},v=function(t){return a&&p.NEED&&f(t)&&!o(t,e)&&s(t),t},p=t.exports={KEY:e,NEED:!1,fastKey:l,getWeak:h,onFreeze:v}},function(t,n){t.exports=function(t,n){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:n}}},function(t,n){var r=Math.ceil,e=Math.floor;t.exports=function(t){return isNaN(t=+t)?0:(t>0?e:r)(t)}},function(t,n){t.exports=function(t,n,r,e){if(!(t instanceof n)||void 0!==e&&e in t)throw TypeError(r+": incorrect invocation!");return t}},function(t,n){t.exports=!1},function(t,n,r){var e=r(2),i=r(173),o=r(133),u=r(145)("IE_PROTO"),c=function(){},f="prototype",a=function(){var t,n=r(132)("iframe"),e=o.length;for(n.style.display="none",r(135).appendChild(n),n.src="javascript:",t=n.contentWindow.document,t.open(),t.write("<script>document.F=Object<\/script>"),t.close(),a=t.F;e--;)delete a[f][o[e]];return a()};t.exports=Object.create||function(t,n){var r;return null!==t?(c[f]=e(t),r=new c,c[f]=null,r[u]=t):r=a(),void 0===n?r:i(r,n)}},function(t,n,r){var e=r(175),i=r(133).concat("length","prototype");n.f=Object.getOwnPropertyNames||function(t){return e(t,i)}},function(t,n,r){var e=r(175),i=r(133);t.exports=Object.keys||function(t){return e(t,i)}},function(t,n,r){var e=r(28);t.exports=function(t,n,r){for(var i in n)e(t,i,n[i],r);return t}},function(t,n,r){"use strict";var e=r(3),i=r(11),o=r(10),u=r(7)("species");t.exports=function(t){var n=e[t];o&&n&&!n[u]&&i.f(n,u,{configurable:!0,get:function(){return this}})}},function(t,n,r){var e=r(67),i=Math.max,o=Math.min;t.exports=function(t,n){return t=e(t),t<0?i(t+n,0):o(t,n)}},function(t,n){var r=0,e=Math.random();t.exports=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++r+e).toString(36))}},function(t,n,r){var e=r(33);t.exports=function(t){return Object(e(t))}},function(t,n,r){var e=r(7)("unscopables"),i=Array.prototype;void 0==i[e]&&r(27)(i,e,{}),t.exports=function(t){i[e][t]=!0}},function(t,n,r){var e=r(53),i=r(169),o=r(137),u=r(2),c=r(16),f=r(154),a={},s={},n=t.exports=function(t,n,r,l,h){var v,p,d,y,g=h?function(){return t}:f(t),b=e(r,l,n?2:1),m=0;if("function"!=typeof g)throw TypeError(t+" is not iterable!");if(o(g)){for(v=c(t.length);v>m;m++)if((y=n?b(u(p=t[m])[0],p[1]):b(t[m]))===a||y===s)return y}else for(d=g.call(t);!(p=d.next()).done;)if((y=i(d,b,p.value,n))===a||y===s)return y};n.BREAK=a,n.RETURN=s},function(t,n){t.exports={}},function(t,n,r){var e=r(11).f,i=r(24),o=r(7)("toStringTag");t.exports=function(t,n,r){t&&!i(t=r?t:t.prototype,o)&&e(t,o,{configurable:!0,value:n})}},function(t,n,r){var e=r(1),i=r(46),o=r(4),u=r(150),c="["+u+"]",f="​",a=RegExp("^"+c+c+"*"),s=RegExp(c+c+"*$"),l=function(t,n,r){var i={},c=o(function(){return!!u[t]()||f[t]()!=f}),a=i[t]=c?n(h):u[t];r&&(i[r]=a),e(e.P+e.F*c,"String",i)},h=l.trim=function(t,n){return t=String(i(t)),1&n&&(t=t.replace(a,"")),2&n&&(t=t.replace(s,"")),t};t.exports=l},function(t,n,r){t.exports={default:r(86),__esModule:!0}},function(t,n,r){t.exports={default:r(87),__esModule:!0}},function(t,n,r){"use strict";function e(t){return t&&t.__esModule?t:{default:t}}n.__esModule=!0;var i=r(84),o=e(i),u=r(83),c=e(u),f="function"==typeof c.default&&"symbol"==typeof o.default?function(t){return typeof t}:function(t){return t&&"function"==typeof c.default&&t.constructor===c.default&&t!==c.default.prototype?"symbol":typeof t};n.default="function"==typeof c.default&&"symbol"===f(o.default)?function(t){return void 0===t?"undefined":f(t)}:function(t){return t&&"function"==typeof c.default&&t.constructor===c.default&&t!==c.default.prototype?"symbol":void 0===t?"undefined":f(t)}},function(t,n,r){r(110),r(108),r(111),r(112),t.exports=r(25).Symbol},function(t,n,r){r(109),r(113),t.exports=r(44).f("iterator")},function(t,n){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,n){t.exports=function(){}},function(t,n,r){var e=r(9),i=r(106),o=r(105);t.exports=function(t){return function(n,r,u){var c,f=e(n),a=i(f.length),s=o(u,a);if(t&&r!=r){for(;a>s;)if((c=f[s++])!=c)return!0}else for(;a>s;s++)if((t||s in f)&&f[s]===r)return t||s||0;return!t&&-1}}},function(t,n,r){var e=r(88);t.exports=function(t,n,r){if(e(t),void 0===n)return t;switch(r){case 1:return function(r){return t.call(n,r)};case 2:return function(r,e){return t.call(n,r,e)};case 3:return function(r,e,i){return t.call(n,r,e,i)}}return function(){return t.apply(n,arguments)}}},function(t,n,r){var e=r(19),i=r(62),o=r(37);t.exports=function(t){var n=e(t),r=i.f;if(r)for(var u,c=r(t),f=o.f,a=0;c.length>a;)f.call(t,u=c[a++])&&n.push(u);return n}},function(t,n,r){t.exports=r(5).document&&document.documentElement},function(t,n,r){var e=r(56);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==e(t)?t.split(""):Object(t)}},function(t,n,r){var e=r(56);t.exports=Array.isArray||function(t){return"Array"==e(t)}},function(t,n,r){"use strict";var e=r(60),i=r(22),o=r(38),u={};r(13)(u,r(15)("iterator"),function(){return this}),t.exports=function(t,n,r){t.prototype=e(u,{next:i(1,r)}),o(t,n+" Iterator")}},function(t,n){t.exports=function(t,n){return{value:n,done:!!t}}},function(t,n,r){var e=r(19),i=r(9);t.exports=function(t,n){for(var r,o=i(t),u=e(o),c=u.length,f=0;c>f;)if(o[r=u[f++]]===n)return r}},function(t,n,r){var e=r(23)("meta"),i=r(21),o=r(8),u=r(14).f,c=0,f=Object.isExtensible||function(){return!0},a=!r(18)(function(){return f(Object.preventExtensions({}))}),s=function(t){u(t,e,{value:{i:"O"+ ++c,w:{}}})},l=function(t,n){if(!i(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!o(t,e)){if(!f(t))return"F";if(!n)return"E";s(t)}return t[e].i},h=function(t,n){if(!o(t,e)){if(!f(t))return!0;if(!n)return!1;s(t)}return t[e].w},v=function(t){return a&&p.NEED&&f(t)&&!o(t,e)&&s(t),t},p=t.exports={KEY:e,NEED:!1,fastKey:l,getWeak:h,onFreeze:v}},function(t,n,r){var e=r(14),i=r(20),o=r(19);t.exports=r(12)?Object.defineProperties:function(t,n){i(t);for(var r,u=o(n),c=u.length,f=0;c>f;)e.f(t,r=u[f++],n[r]);return t}},function(t,n,r){var e=r(37),i=r(22),o=r(9),u=r(42),c=r(8),f=r(58),a=Object.getOwnPropertyDescriptor;n.f=r(12)?a:function(t,n){if(t=o(t),n=u(n,!0),f)try{return a(t,n)}catch(t){}if(c(t,n))return i(!e.f.call(t,n),t[n])}},function(t,n,r){var e=r(9),i=r(61).f,o={}.toString,u="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],c=function(t){try{return i(t)}catch(t){return u.slice()}};t.exports.f=function(t){return u&&"[object Window]"==o.call(t)?c(t):i(e(t))}},function(t,n,r){var e=r(8),i=r(77),o=r(39)("IE_PROTO"),u=Object.prototype;t.exports=Object.getPrototypeOf||function(t){return t=i(t),e(t,o)?t[o]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?u:null}},function(t,n,r){var e=r(41),i=r(33);t.exports=function(t){return function(n,r){var o,u,c=String(i(n)),f=e(r),a=c.length;return f<0||f>=a?t?"":void 0:(o=c.charCodeAt(f),o<55296||o>56319||f+1===a||(u=c.charCodeAt(f+1))<56320||u>57343?t?c.charAt(f):o:t?c.slice(f,f+2):u-56320+(o-55296<<10)+65536)}}},function(t,n,r){var e=r(41),i=Math.max,o=Math.min;t.exports=function(t,n){return t=e(t),t<0?i(t+n,0):o(t,n)}},function(t,n,r){var e=r(41),i=Math.min;t.exports=function(t){return t>0?i(e(t),9007199254740991):0}},function(t,n,r){"use strict";var e=r(89),i=r(97),o=r(35),u=r(9);t.exports=r(59)(Array,"Array",function(t,n){this._t=u(t),this._i=0,this._k=n},function(){var t=this._t,n=this._k,r=this._i++;return!t||r>=t.length?(this._t=void 0,i(1)):"keys"==n?i(0,r):"values"==n?i(0,t[r]):i(0,[r,t[r]])},"values"),o.Arguments=o.Array,e("keys"),e("values"),e("entries")},function(t,n){},function(t,n,r){"use strict";var e=r(104)(!0);r(59)(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,n=this._t,r=this._i;return r>=n.length?{value:void 0,done:!0}:(t=e(n,r),this._i+=t.length,{value:t,done:!1})})},function(t,n,r){"use strict";var e=r(5),i=r(8),o=r(12),u=r(51),c=r(64),f=r(99).KEY,a=r(18),s=r(40),l=r(38),h=r(23),v=r(15),p=r(44),d=r(43),y=r(98),g=r(92),b=r(95),m=r(20),x=r(9),w=r(42),S=r(22),_=r(60),O=r(102),E=r(101),P=r(14),j=r(19),F=E.f,M=P.f,A=O.f,N=e.Symbol,T=e.JSON,I=T&&T.stringify,k="prototype",L=v("_hidden"),R=v("toPrimitive"),C={}.propertyIsEnumerable,D=s("symbol-registry"),U=s("symbols"),W=s("op-symbols"),G=Object[k],B="function"==typeof N,V=e.QObject,z=!V||!V[k]||!V[k].findChild,q=o&&a(function(){return 7!=_(M({},"a",{get:function(){return M(this,"a",{value:7}).a}})).a})?function(t,n,r){var e=F(G,n);e&&delete G[n],M(t,n,r),e&&t!==G&&M(G,n,e)}:M,K=function(t){var n=U[t]=_(N[k]);return n._k=t,n},J=B&&"symbol"==typeof N.iterator?function(t){return"symbol"==typeof t}:function(t){return t instanceof N},Y=function(t,n,r){return t===G&&Y(W,n,r),m(t),n=w(n,!0),m(r),i(U,n)?(r.enumerable?(i(t,L)&&t[L][n]&&(t[L][n]=!1),r=_(r,{enumerable:S(0,!1)})):(i(t,L)||M(t,L,S(1,{})),t[L][n]=!0),q(t,n,r)):M(t,n,r)},H=function(t,n){m(t);for(var r,e=g(n=x(n)),i=0,o=e.length;o>i;)Y(t,r=e[i++],n[r]);return t},$=function(t,n){return void 0===n?_(t):H(_(t),n)},X=function(t){var n=C.call(this,t=w(t,!0));return!(this===G&&i(U,t)&&!i(W,t))&&(!(n||!i(this,t)||!i(U,t)||i(this,L)&&this[L][t])||n)},Q=function(t,n){if(t=x(t),n=w(n,!0),t!==G||!i(U,n)||i(W,n)){var r=F(t,n);return!r||!i(U,n)||i(t,L)&&t[L][n]||(r.enumerable=!0),r}},Z=function(t){for(var n,r=A(x(t)),e=[],o=0;r.length>o;)i(U,n=r[o++])||n==L||n==f||e.push(n);return e},tt=function(t){for(var n,r=t===G,e=A(r?W:x(t)),o=[],u=0;e.length>u;)!i(U,n=e[u++])||r&&!i(G,n)||o.push(U[n]);return o};B||(N=function(){if(this instanceof N)throw TypeError("Symbol is not a constructor!");var t=h(arguments.length>0?arguments[0]:void 0),n=function(r){this===G&&n.call(W,r),i(this,L)&&i(this[L],t)&&(this[L][t]=!1),q(this,t,S(1,r))};return o&&z&&q(G,t,{configurable:!0,set:n}),K(t)},c(N[k],"toString",function(){return this._k}),E.f=Q,P.f=Y,r(61).f=O.f=Z,r(37).f=X,r(62).f=tt,o&&!r(36)&&c(G,"propertyIsEnumerable",X,!0),p.f=function(t){return K(v(t))}),u(u.G+u.W+u.F*!B,{Symbol:N});for(var nt="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),rt=0;nt.length>rt;)v(nt[rt++]);for(var nt=j(v.store),rt=0;nt.length>rt;)d(nt[rt++]);u(u.S+u.F*!B,"Symbol",{for:function(t){return i(D,t+="")?D[t]:D[t]=N(t)},keyFor:function(t){if(J(t))return y(D,t);throw TypeError(t+" is not a symbol!")},useSetter:function(){z=!0},useSimple:function(){z=!1}}),u(u.S+u.F*!B,"Object",{create:$,defineProperty:Y,defineProperties:H,getOwnPropertyDescriptor:Q,getOwnPropertyNames:Z,getOwnPropertySymbols:tt}),T&&u(u.S+u.F*(!B||a(function(){var t=N();return"[null]"!=I([t])||"{}"!=I({a:t})||"{}"!=I(Object(t))})),"JSON",{stringify:function(t){if(void 0!==t&&!J(t)){for(var n,r,e=[t],i=1;arguments.length>i;)e.push(arguments[i++]);return n=e[1],"function"==typeof n&&(r=n),!r&&b(n)||(n=function(t,n){if(r&&(n=r.call(this,t,n)),!J(n))return n}),e[1]=n,I.apply(T,e)}}}),N[k][R]||r(13)(N[k],R,N[k].valueOf),l(N,"Symbol"),l(Math,"Math",!0),l(e.JSON,"JSON",!0)},function(t,n,r){r(43)("asyncIterator")},function(t,n,r){r(43)("observable")},function(t,n,r){r(107);for(var e=r(5),i=r(13),o=r(35),u=r(15)("toStringTag"),c=["NodeList","DOMTokenList","MediaList","StyleSheetList","CSSRuleList"],f=0;f<5;f++){var a=c[f],s=e[a],l=s&&s.prototype;l&&!l[u]&&i(l,u,a),o[a]=o.Array}},function(t,n,r){var e=r(45),i=r(7)("toStringTag"),o="Arguments"==e(function(){return arguments}()),u=function(t,n){try{return t[n]}catch(t){}};t.exports=function(t){var n,r,c;return void 0===t?"Undefined":null===t?"Null":"string"==typeof(r=u(n=Object(t),i))?r:o?e(n):"Object"==(c=e(n))&&"function"==typeof n.callee?"Arguments":c}},function(t,n,r){var e=r(45);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==e(t)?t.split(""):Object(t)}},function(t,n){n.f={}.propertyIsEnumerable},function(t,n,r){var e=r(30),i=r(16),o=r(75);t.exports=function(t){return function(n,r,u){var c,f=e(n),a=i(f.length),s=o(u,a);if(t&&r!=r){for(;a>s;)if((c=f[s++])!=c)return!0}else for(;a>s;s++)if((t||s in f)&&f[s]===r)return t||s||0;return!t&&-1}}},function(t,n,r){"use strict";var e=r(3),i=r(1),o=r(28),u=r(73),c=r(65),f=r(79),a=r(68),s=r(6),l=r(4),h=r(123),v=r(81),p=r(136);t.exports=function(t,n,r,d,y,g){var b=e[t],m=b,x=y?"set":"add",w=m&&m.prototype,S={},_=function(t){var n=w[t];o(w,t,"delete"==t?function(t){return!(g&&!s(t))&&n.call(this,0===t?0:t)}:"has"==t?function(t){return!(g&&!s(t))&&n.call(this,0===t?0:t)}:"get"==t?function(t){return g&&!s(t)?void 0:n.call(this,0===t?0:t)}:"add"==t?function(t){return n.call(this,0===t?0:t),this}:function(t,r){return n.call(this,0===t?0:t,r),this})};if("function"==typeof m&&(g||w.forEach&&!l(function(){(new m).entries().next()}))){var O=new m,E=O[x](g?{}:-0,1)!=O,P=l(function(){O.has(1)}),j=h(function(t){new m(t)}),F=!g&&l(function(){for(var t=new m,n=5;n--;)t[x](n,n);return!t.has(-0)});j||(m=n(function(n,r){a(n,m,t);var e=p(new b,n,m);return void 0!=r&&f(r,y,e[x],e),e}),m.prototype=w,w.constructor=m),(P||F)&&(_("delete"),_("has"),y&&_("get")),(F||E)&&_(x),g&&w.clear&&delete w.clear}else m=d.getConstructor(n,t,y,x),u(m.prototype,r),c.NEED=!0;return v(m,t),S[t]=m,i(i.G+i.W+i.F*(m!=b),S),g||d.setStrong(m,t,y),m}},function(t,n,r){"use strict";var e=r(27),i=r(28),o=r(4),u=r(46),c=r(7);t.exports=function(t,n,r){var f=c(t),a=r(u,f,""[t]),s=a[0],l=a[1];o(function(){var n={};return n[f]=function(){return 7},7!=""[t](n)})&&(i(String.prototype,t,s),e(RegExp.prototype,f,2==n?function(t,n){return l.call(t,this,n)}:function(t){return l.call(t,this)}))}
},function(t,n,r){"use strict";var e=r(2);t.exports=function(){var t=e(this),n="";return t.global&&(n+="g"),t.ignoreCase&&(n+="i"),t.multiline&&(n+="m"),t.unicode&&(n+="u"),t.sticky&&(n+="y"),n}},function(t,n){t.exports=function(t,n,r){var e=void 0===r;switch(n.length){case 0:return e?t():t.call(r);case 1:return e?t(n[0]):t.call(r,n[0]);case 2:return e?t(n[0],n[1]):t.call(r,n[0],n[1]);case 3:return e?t(n[0],n[1],n[2]):t.call(r,n[0],n[1],n[2]);case 4:return e?t(n[0],n[1],n[2],n[3]):t.call(r,n[0],n[1],n[2],n[3])}return t.apply(r,n)}},function(t,n,r){var e=r(6),i=r(45),o=r(7)("match");t.exports=function(t){var n;return e(t)&&(void 0!==(n=t[o])?!!n:"RegExp"==i(t))}},function(t,n,r){var e=r(7)("iterator"),i=!1;try{var o=[7][e]();o.return=function(){i=!0},Array.from(o,function(){throw 2})}catch(t){}t.exports=function(t,n){if(!n&&!i)return!1;var r=!1;try{var o=[7],u=o[e]();u.next=function(){return{done:r=!0}},o[e]=function(){return u},t(o)}catch(t){}return r}},function(t,n,r){t.exports=r(69)||!r(4)(function(){var t=Math.random();__defineSetter__.call(null,t,function(){}),delete r(3)[t]})},function(t,n){n.f=Object.getOwnPropertySymbols},function(t,n,r){var e=r(3),i="__core-js_shared__",o=e[i]||(e[i]={});t.exports=function(t){return o[t]||(o[t]={})}},function(t,n,r){for(var e,i=r(3),o=r(27),u=r(76),c=u("typed_array"),f=u("view"),a=!(!i.ArrayBuffer||!i.DataView),s=a,l=0,h="Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array".split(",");l<9;)(e=i[h[l++]])?(o(e.prototype,c,!0),o(e.prototype,f,!0)):s=!1;t.exports={ABV:a,CONSTR:s,TYPED:c,VIEW:f}},function(t,n){"use strict";var r={versions:function(){var t=window.navigator.userAgent;return{trident:t.indexOf("Trident")>-1,presto:t.indexOf("Presto")>-1,webKit:t.indexOf("AppleWebKit")>-1,gecko:t.indexOf("Gecko")>-1&&-1==t.indexOf("KHTML"),mobile:!!t.match(/AppleWebKit.*Mobile.*/),ios:!!t.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),android:t.indexOf("Android")>-1||t.indexOf("Linux")>-1,iPhone:t.indexOf("iPhone")>-1||t.indexOf("Mac")>-1,iPad:t.indexOf("iPad")>-1,webApp:-1==t.indexOf("Safari"),weixin:-1==t.indexOf("MicroMessenger")}}()};t.exports=r},function(t,n,r){"use strict";var e=r(85),i=function(t){return t&&t.__esModule?t:{default:t}}(e),o=function(){function t(t,n,e){return n||e?String.fromCharCode(n||e):r[t]||t}function n(t){return e[t]}var r={"&quot;":'"',"&lt;":"<","&gt;":">","&amp;":"&","&nbsp;":" "},e={};for(var u in r)e[r[u]]=u;return r["&apos;"]="'",e["'"]="&#39;",{encode:function(t){return t?(""+t).replace(/['<> "&]/g,n).replace(/\r?\n/g,"<br/>").replace(/\s/g,"&nbsp;"):""},decode:function(n){return n?(""+n).replace(/<br\s*\/?>/gi,"\n").replace(/&quot;|&lt;|&gt;|&amp;|&nbsp;|&apos;|&#(\d+);|&#(\d+)/g,t).replace(/\u00a0/g," "):""},encodeBase16:function(t){if(!t)return t;t+="";for(var n=[],r=0,e=t.length;e>r;r++)n.push(t.charCodeAt(r).toString(16).toUpperCase());return n.join("")},encodeBase16forJSON:function(t){if(!t)return t;t=t.replace(/[\u4E00-\u9FBF]/gi,function(t){return escape(t).replace("%u","\\u")});for(var n=[],r=0,e=t.length;e>r;r++)n.push(t.charCodeAt(r).toString(16).toUpperCase());return n.join("")},decodeBase16:function(t){if(!t)return t;t+="";for(var n=[],r=0,e=t.length;e>r;r+=2)n.push(String.fromCharCode("0x"+t.slice(r,r+2)));return n.join("")},encodeObject:function(t){if(t instanceof Array)for(var n=0,r=t.length;r>n;n++)t[n]=o.encodeObject(t[n]);else if("object"==(void 0===t?"undefined":(0,i.default)(t)))for(var e in t)t[e]=o.encodeObject(t[e]);else if("string"==typeof t)return o.encode(t);return t},loadScript:function(t){var n=document.createElement("script");document.getElementsByTagName("body")[0].appendChild(n),n.setAttribute("src",t)},addLoadEvent:function(t){var n=window.onload;"function"!=typeof window.onload?window.onload=t:window.onload=function(){n(),t()}}}}();t.exports=o},function(t,n,r){"use strict";var e=r(17),i=r(75),o=r(16);t.exports=function(t){for(var n=e(this),r=o(n.length),u=arguments.length,c=i(u>1?arguments[1]:void 0,r),f=u>2?arguments[2]:void 0,a=void 0===f?r:i(f,r);a>c;)n[c++]=t;return n}},function(t,n,r){"use strict";var e=r(11),i=r(66);t.exports=function(t,n,r){n in t?e.f(t,n,i(0,r)):t[n]=r}},function(t,n,r){var e=r(6),i=r(3).document,o=e(i)&&e(i.createElement);t.exports=function(t){return o?i.createElement(t):{}}},function(t,n){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,n,r){var e=r(7)("match");t.exports=function(t){var n=/./;try{"/./"[t](n)}catch(r){try{return n[e]=!1,!"/./"[t](n)}catch(t){}}return!0}},function(t,n,r){t.exports=r(3).document&&document.documentElement},function(t,n,r){var e=r(6),i=r(144).set;t.exports=function(t,n,r){var o,u=n.constructor;return u!==r&&"function"==typeof u&&(o=u.prototype)!==r.prototype&&e(o)&&i&&i(t,o),t}},function(t,n,r){var e=r(80),i=r(7)("iterator"),o=Array.prototype;t.exports=function(t){return void 0!==t&&(e.Array===t||o[i]===t)}},function(t,n,r){var e=r(45);t.exports=Array.isArray||function(t){return"Array"==e(t)}},function(t,n,r){"use strict";var e=r(70),i=r(66),o=r(81),u={};r(27)(u,r(7)("iterator"),function(){return this}),t.exports=function(t,n,r){t.prototype=e(u,{next:i(1,r)}),o(t,n+" Iterator")}},function(t,n,r){"use strict";var e=r(69),i=r(1),o=r(28),u=r(27),c=r(24),f=r(80),a=r(139),s=r(81),l=r(32),h=r(7)("iterator"),v=!([].keys&&"next"in[].keys()),p="keys",d="values",y=function(){return this};t.exports=function(t,n,r,g,b,m,x){a(r,n,g);var w,S,_,O=function(t){if(!v&&t in F)return F[t];switch(t){case p:case d:return function(){return new r(this,t)}}return function(){return new r(this,t)}},E=n+" Iterator",P=b==d,j=!1,F=t.prototype,M=F[h]||F["@@iterator"]||b&&F[b],A=M||O(b),N=b?P?O("entries"):A:void 0,T="Array"==n?F.entries||M:M;if(T&&(_=l(T.call(new t)))!==Object.prototype&&(s(_,E,!0),e||c(_,h)||u(_,h,y)),P&&M&&M.name!==d&&(j=!0,A=function(){return M.call(this)}),e&&!x||!v&&!j&&F[h]||u(F,h,A),f[n]=A,f[E]=y,b)if(w={values:P?A:O(d),keys:m?A:O(p),entries:N},x)for(S in w)S in F||o(F,S,w[S]);else i(i.P+i.F*(v||j),n,w);return w}},function(t,n){var r=Math.expm1;t.exports=!r||r(10)>22025.465794806718||r(10)<22025.465794806718||-2e-17!=r(-2e-17)?function(t){return 0==(t=+t)?t:t>-1e-6&&t<1e-6?t+t*t/2:Math.exp(t)-1}:r},function(t,n){t.exports=Math.sign||function(t){return 0==(t=+t)||t!=t?t:t<0?-1:1}},function(t,n,r){var e=r(3),i=r(151).set,o=e.MutationObserver||e.WebKitMutationObserver,u=e.process,c=e.Promise,f="process"==r(45)(u);t.exports=function(){var t,n,r,a=function(){var e,i;for(f&&(e=u.domain)&&e.exit();t;){i=t.fn,t=t.next;try{i()}catch(e){throw t?r():n=void 0,e}}n=void 0,e&&e.enter()};if(f)r=function(){u.nextTick(a)};else if(o){var s=!0,l=document.createTextNode("");new o(a).observe(l,{characterData:!0}),r=function(){l.data=s=!s}}else if(c&&c.resolve){var h=c.resolve();r=function(){h.then(a)}}else r=function(){i.call(e,a)};return function(e){var i={fn:e,next:void 0};n&&(n.next=i),t||(t=i,r()),n=i}}},function(t,n,r){var e=r(6),i=r(2),o=function(t,n){if(i(t),!e(n)&&null!==n)throw TypeError(n+": can't set as prototype!")};t.exports={set:Object.setPrototypeOf||("__proto__"in{}?function(t,n,e){try{e=r(53)(Function.call,r(31).f(Object.prototype,"__proto__").set,2),e(t,[]),n=!(t instanceof Array)}catch(t){n=!0}return function(t,r){return o(t,r),n?t.__proto__=r:e(t,r),t}}({},!1):void 0),check:o}},function(t,n,r){var e=r(126)("keys"),i=r(76);t.exports=function(t){return e[t]||(e[t]=i(t))}},function(t,n,r){var e=r(2),i=r(26),o=r(7)("species");t.exports=function(t,n){var r,u=e(t).constructor;return void 0===u||void 0==(r=e(u)[o])?n:i(r)}},function(t,n,r){var e=r(67),i=r(46);t.exports=function(t){return function(n,r){var o,u,c=String(i(n)),f=e(r),a=c.length;return f<0||f>=a?t?"":void 0:(o=c.charCodeAt(f),o<55296||o>56319||f+1===a||(u=c.charCodeAt(f+1))<56320||u>57343?t?c.charAt(f):o:t?c.slice(f,f+2):u-56320+(o-55296<<10)+65536)}}},function(t,n,r){var e=r(122),i=r(46);t.exports=function(t,n,r){if(e(n))throw TypeError("String#"+r+" doesn't accept regex!");return String(i(t))}},function(t,n,r){"use strict";var e=r(67),i=r(46);t.exports=function(t){var n=String(i(this)),r="",o=e(t);if(o<0||o==1/0)throw RangeError("Count can't be negative");for(;o>0;(o>>>=1)&&(n+=n))1&o&&(r+=n);return r}},function(t,n){t.exports="\t\n\v\f\r   ᠎             　\u2028\u2029\ufeff"},function(t,n,r){var e,i,o,u=r(53),c=r(121),f=r(135),a=r(132),s=r(3),l=s.process,h=s.setImmediate,v=s.clearImmediate,p=s.MessageChannel,d=0,y={},g="onreadystatechange",b=function(){var t=+this;if(y.hasOwnProperty(t)){var n=y[t];delete y[t],n()}},m=function(t){b.call(t.data)};h&&v||(h=function(t){for(var n=[],r=1;arguments.length>r;)n.push(arguments[r++]);return y[++d]=function(){c("function"==typeof t?t:Function(t),n)},e(d),d},v=function(t){delete y[t]},"process"==r(45)(l)?e=function(t){l.nextTick(u(b,t,1))}:p?(i=new p,o=i.port2,i.port1.onmessage=m,e=u(o.postMessage,o,1)):s.addEventListener&&"function"==typeof postMessage&&!s.importScripts?(e=function(t){s.postMessage(t+"","*")},s.addEventListener("message",m,!1)):e=g in a("script")?function(t){f.appendChild(a("script"))[g]=function(){f.removeChild(this),b.call(t)}}:function(t){setTimeout(u(b,t,1),0)}),t.exports={set:h,clear:v}},function(t,n,r){"use strict";var e=r(3),i=r(10),o=r(69),u=r(127),c=r(27),f=r(73),a=r(4),s=r(68),l=r(67),h=r(16),v=r(71).f,p=r(11).f,d=r(130),y=r(81),g="ArrayBuffer",b="DataView",m="prototype",x="Wrong length!",w="Wrong index!",S=e[g],_=e[b],O=e.Math,E=e.RangeError,P=e.Infinity,j=S,F=O.abs,M=O.pow,A=O.floor,N=O.log,T=O.LN2,I="buffer",k="byteLength",L="byteOffset",R=i?"_b":I,C=i?"_l":k,D=i?"_o":L,U=function(t,n,r){var e,i,o,u=Array(r),c=8*r-n-1,f=(1<<c)-1,a=f>>1,s=23===n?M(2,-24)-M(2,-77):0,l=0,h=t<0||0===t&&1/t<0?1:0;for(t=F(t),t!=t||t===P?(i=t!=t?1:0,e=f):(e=A(N(t)/T),t*(o=M(2,-e))<1&&(e--,o*=2),t+=e+a>=1?s/o:s*M(2,1-a),t*o>=2&&(e++,o/=2),e+a>=f?(i=0,e=f):e+a>=1?(i=(t*o-1)*M(2,n),e+=a):(i=t*M(2,a-1)*M(2,n),e=0));n>=8;u[l++]=255&i,i/=256,n-=8);for(e=e<<n|i,c+=n;c>0;u[l++]=255&e,e/=256,c-=8);return u[--l]|=128*h,u},W=function(t,n,r){var e,i=8*r-n-1,o=(1<<i)-1,u=o>>1,c=i-7,f=r-1,a=t[f--],s=127&a;for(a>>=7;c>0;s=256*s+t[f],f--,c-=8);for(e=s&(1<<-c)-1,s>>=-c,c+=n;c>0;e=256*e+t[f],f--,c-=8);if(0===s)s=1-u;else{if(s===o)return e?NaN:a?-P:P;e+=M(2,n),s-=u}return(a?-1:1)*e*M(2,s-n)},G=function(t){return t[3]<<24|t[2]<<16|t[1]<<8|t[0]},B=function(t){return[255&t]},V=function(t){return[255&t,t>>8&255]},z=function(t){return[255&t,t>>8&255,t>>16&255,t>>24&255]},q=function(t){return U(t,52,8)},K=function(t){return U(t,23,4)},J=function(t,n,r){p(t[m],n,{get:function(){return this[r]}})},Y=function(t,n,r,e){var i=+r,o=l(i);if(i!=o||o<0||o+n>t[C])throw E(w);var u=t[R]._b,c=o+t[D],f=u.slice(c,c+n);return e?f:f.reverse()},H=function(t,n,r,e,i,o){var u=+r,c=l(u);if(u!=c||c<0||c+n>t[C])throw E(w);for(var f=t[R]._b,a=c+t[D],s=e(+i),h=0;h<n;h++)f[a+h]=s[o?h:n-h-1]},$=function(t,n){s(t,S,g);var r=+n,e=h(r);if(r!=e)throw E(x);return e};if(u.ABV){if(!a(function(){new S})||!a(function(){new S(.5)})){S=function(t){return new j($(this,t))};for(var X,Q=S[m]=j[m],Z=v(j),tt=0;Z.length>tt;)(X=Z[tt++])in S||c(S,X,j[X]);o||(Q.constructor=S)}var nt=new _(new S(2)),rt=_[m].setInt8;nt.setInt8(0,2147483648),nt.setInt8(1,2147483649),!nt.getInt8(0)&&nt.getInt8(1)||f(_[m],{setInt8:function(t,n){rt.call(this,t,n<<24>>24)},setUint8:function(t,n){rt.call(this,t,n<<24>>24)}},!0)}else S=function(t){var n=$(this,t);this._b=d.call(Array(n),0),this[C]=n},_=function(t,n,r){s(this,_,b),s(t,S,b);var e=t[C],i=l(n);if(i<0||i>e)throw E("Wrong offset!");if(r=void 0===r?e-i:h(r),i+r>e)throw E(x);this[R]=t,this[D]=i,this[C]=r},i&&(J(S,k,"_l"),J(_,I,"_b"),J(_,k,"_l"),J(_,L,"_o")),f(_[m],{getInt8:function(t){return Y(this,1,t)[0]<<24>>24},getUint8:function(t){return Y(this,1,t)[0]},getInt16:function(t){var n=Y(this,2,t,arguments[1]);return(n[1]<<8|n[0])<<16>>16},getUint16:function(t){var n=Y(this,2,t,arguments[1]);return n[1]<<8|n[0]},getInt32:function(t){return G(Y(this,4,t,arguments[1]))},getUint32:function(t){return G(Y(this,4,t,arguments[1]))>>>0},getFloat32:function(t){return W(Y(this,4,t,arguments[1]),23,4)},getFloat64:function(t){return W(Y(this,8,t,arguments[1]),52,8)},setInt8:function(t,n){H(this,1,t,B,n)},setUint8:function(t,n){H(this,1,t,B,n)},setInt16:function(t,n){H(this,2,t,V,n,arguments[2])},setUint16:function(t,n){H(this,2,t,V,n,arguments[2])},setInt32:function(t,n){H(this,4,t,z,n,arguments[2])},setUint32:function(t,n){H(this,4,t,z,n,arguments[2])},setFloat32:function(t,n){H(this,4,t,K,n,arguments[2])},setFloat64:function(t,n){H(this,8,t,q,n,arguments[2])}});y(S,g),y(_,b),c(_[m],u.VIEW,!0),n[g]=S,n[b]=_},function(t,n,r){var e=r(3),i=r(52),o=r(69),u=r(182),c=r(11).f;t.exports=function(t){var n=i.Symbol||(i.Symbol=o?{}:e.Symbol||{});"_"==t.charAt(0)||t in n||c(n,t,{value:u.f(t)})}},function(t,n,r){var e=r(114),i=r(7)("iterator"),o=r(80);t.exports=r(52).getIteratorMethod=function(t){if(void 0!=t)return t[i]||t["@@iterator"]||o[e(t)]}},function(t,n,r){"use strict";var e=r(78),i=r(170),o=r(80),u=r(30);t.exports=r(140)(Array,"Array",function(t,n){this._t=u(t),this._i=0,this._k=n},function(){var t=this._t,n=this._k,r=this._i++;return!t||r>=t.length?(this._t=void 0,i(1)):"keys"==n?i(0,r):"values"==n?i(0,t[r]):i(0,[r,t[r]])},"values"),o.Arguments=o.Array,e("keys"),e("values"),e("entries")},function(t,n){function r(t,n){t.classList?t.classList.add(n):t.className+=" "+n}t.exports=r},function(t,n){function r(t,n){if(t.classList)t.classList.remove(n);else{var r=new RegExp("(^|\\b)"+n.split(" ").join("|")+"(\\b|$)","gi");t.className=t.className.replace(r," ")}}t.exports=r},function(t,n){function r(){throw new Error("setTimeout has not been defined")}function e(){throw new Error("clearTimeout has not been defined")}function i(t){if(s===setTimeout)return setTimeout(t,0);if((s===r||!s)&&setTimeout)return s=setTimeout,setTimeout(t,0);try{return s(t,0)}catch(n){try{return s.call(null,t,0)}catch(n){return s.call(this,t,0)}}}function o(t){if(l===clearTimeout)return clearTimeout(t);if((l===e||!l)&&clearTimeout)return l=clearTimeout,clearTimeout(t);try{return l(t)}catch(n){try{return l.call(null,t)}catch(n){return l.call(this,t)}}}function u(){d&&v&&(d=!1,v.length?p=v.concat(p):y=-1,p.length&&c())}function c(){if(!d){var t=i(u);d=!0;for(var n=p.length;n;){for(v=p,p=[];++y<n;)v&&v[y].run();y=-1,n=p.length}v=null,d=!1,o(t)}}function f(t,n){this.fun=t,this.array=n}function a(){}var s,l,h=t.exports={};!function(){try{s="function"==typeof setTimeout?setTimeout:r}catch(t){s=r}try{l="function"==typeof clearTimeout?clearTimeout:e}catch(t){l=e}}();var v,p=[],d=!1,y=-1;h.nextTick=function(t){var n=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)n[r-1]=arguments[r];p.push(new f(t,n)),1!==p.length||d||i(c)},f.prototype.run=function(){this.fun.apply(null,this.array)},h.title="browser",h.browser=!0,h.env={},h.argv=[],h.version="",h.versions={},h.on=a,h.addListener=a,h.once=a,h.off=a,h.removeListener=a,h.removeAllListeners=a,h.emit=a,h.prependListener=a,h.prependOnceListener=a,h.listeners=function(t){return[]},h.binding=function(t){throw new Error("process.binding is not supported")},h.cwd=function(){return"/"},h.chdir=function(t){throw new Error("process.chdir is not supported")},h.umask=function(){return 0}},function(t,n,r){var e=r(45);t.exports=function(t,n){if("number"!=typeof t&&"Number"!=e(t))throw TypeError(n);return+t}},function(t,n,r){"use strict";var e=r(17),i=r(75),o=r(16);t.exports=[].copyWithin||function(t,n){var r=e(this),u=o(r.length),c=i(t,u),f=i(n,u),a=arguments.length>2?arguments[2]:void 0,s=Math.min((void 0===a?u:i(a,u))-f,u-c),l=1;for(f<c&&c<f+s&&(l=-1,f+=s-1,c+=s-1);s-- >0;)f in r?r[c]=r[f]:delete r[c],c+=l,f+=l;return r}},function(t,n,r){var e=r(79);t.exports=function(t,n){var r=[];return e(t,!1,r.push,r,n),r}},function(t,n,r){var e=r(26),i=r(17),o=r(115),u=r(16);t.exports=function(t,n,r,c,f){e(n);var a=i(t),s=o(a),l=u(a.length),h=f?l-1:0,v=f?-1:1;if(r<2)for(;;){if(h in s){c=s[h],h+=v;break}if(h+=v,f?h<0:l<=h)throw TypeError("Reduce of empty array with no initial value")}for(;f?h>=0:l>h;h+=v)h in s&&(c=n(c,s[h],h,a));return c}},function(t,n,r){"use strict";var e=r(26),i=r(6),o=r(121),u=[].slice,c={},f=function(t,n,r){if(!(n in c)){for(var e=[],i=0;i<n;i++)e[i]="a["+i+"]";c[n]=Function("F,a","return new F("+e.join(",")+")")}return c[n](t,r)};t.exports=Function.bind||function(t){var n=e(this),r=u.call(arguments,1),c=function(){var e=r.concat(u.call(arguments));return this instanceof c?f(n,e.length,e):o(n,e,t)};return i(n.prototype)&&(c.prototype=n.prototype),c}},function(t,n,r){"use strict";var e=r(11).f,i=r(70),o=r(73),u=r(53),c=r(68),f=r(46),a=r(79),s=r(140),l=r(170),h=r(74),v=r(10),p=r(65).fastKey,d=v?"_s":"size",y=function(t,n){var r,e=p(n);if("F"!==e)return t._i[e];for(r=t._f;r;r=r.n)if(r.k==n)return r};t.exports={getConstructor:function(t,n,r,s){var l=t(function(t,e){c(t,l,n,"_i"),t._i=i(null),t._f=void 0,t._l=void 0,t[d]=0,void 0!=e&&a(e,r,t[s],t)});return o(l.prototype,{clear:function(){for(var t=this,n=t._i,r=t._f;r;r=r.n)r.r=!0,r.p&&(r.p=r.p.n=void 0),delete n[r.i];t._f=t._l=void 0,t[d]=0},delete:function(t){var n=this,r=y(n,t);if(r){var e=r.n,i=r.p;delete n._i[r.i],r.r=!0,i&&(i.n=e),e&&(e.p=i),n._f==r&&(n._f=e),n._l==r&&(n._l=i),n[d]--}return!!r},forEach:function(t){c(this,l,"forEach");for(var n,r=u(t,arguments.length>1?arguments[1]:void 0,3);n=n?n.n:this._f;)for(r(n.v,n.k,this);n&&n.r;)n=n.p},has:function(t){return!!y(this,t)}}),v&&e(l.prototype,"size",{get:function(){return f(this[d])}}),l},def:function(t,n,r){var e,i,o=y(t,n);return o?o.v=r:(t._l=o={i:i=p(n,!0),k:n,v:r,p:e=t._l,n:void 0,r:!1},t._f||(t._f=o),e&&(e.n=o),t[d]++,"F"!==i&&(t._i[i]=o)),t},getEntry:y,setStrong:function(t,n,r){s(t,n,function(t,n){this._t=t,this._k=n,this._l=void 0},function(){for(var t=this,n=t._k,r=t._l;r&&r.r;)r=r.p;return t._t&&(t._l=r=r?r.n:t._t._f)?"keys"==n?l(0,r.k):"values"==n?l(0,r.v):l(0,[r.k,r.v]):(t._t=void 0,l(1))},r?"entries":"values",!r,!0),h(n)}}},function(t,n,r){var e=r(114),i=r(161);t.exports=function(t){return function(){if(e(this)!=t)throw TypeError(t+"#toJSON isn't generic");return i(this)}}},function(t,n,r){"use strict";var e=r(73),i=r(65).getWeak,o=r(2),u=r(6),c=r(68),f=r(79),a=r(48),s=r(24),l=a(5),h=a(6),v=0,p=function(t){return t._l||(t._l=new d)},d=function(){this.a=[]},y=function(t,n){return l(t.a,function(t){return t[0]===n})};d.prototype={get:function(t){var n=y(this,t);if(n)return n[1]},has:function(t){return!!y(this,t)},set:function(t,n){var r=y(this,t);r?r[1]=n:this.a.push([t,n])},delete:function(t){var n=h(this.a,function(n){return n[0]===t});return~n&&this.a.splice(n,1),!!~n}},t.exports={getConstructor:function(t,n,r,o){var a=t(function(t,e){c(t,a,n,"_i"),t._i=v++,t._l=void 0,void 0!=e&&f(e,r,t[o],t)});return e(a.prototype,{delete:function(t){if(!u(t))return!1;var n=i(t);return!0===n?p(this).delete(t):n&&s(n,this._i)&&delete n[this._i]},has:function(t){if(!u(t))return!1;var n=i(t);return!0===n?p(this).has(t):n&&s(n,this._i)}}),a},def:function(t,n,r){var e=i(o(n),!0);return!0===e?p(t).set(n,r):e[t._i]=r,t},ufstore:p}},function(t,n,r){t.exports=!r(10)&&!r(4)(function(){return 7!=Object.defineProperty(r(132)("div"),"a",{get:function(){return 7}}).a})},function(t,n,r){var e=r(6),i=Math.floor;t.exports=function(t){return!e(t)&&isFinite(t)&&i(t)===t}},function(t,n,r){var e=r(2);t.exports=function(t,n,r,i){try{return i?n(e(r)[0],r[1]):n(r)}catch(n){var o=t.return;throw void 0!==o&&e(o.call(t)),n}}},function(t,n){t.exports=function(t,n){return{value:n,done:!!t}}},function(t,n){t.exports=Math.log1p||function(t){return(t=+t)>-1e-8&&t<1e-8?t-t*t/2:Math.log(1+t)}},function(t,n,r){"use strict";var e=r(72),i=r(125),o=r(116),u=r(17),c=r(115),f=Object.assign;t.exports=!f||r(4)(function(){var t={},n={},r=Symbol(),e="abcdefghijklmnopqrst";return t[r]=7,e.split("").forEach(function(t){n[t]=t}),7!=f({},t)[r]||Object.keys(f({},n)).join("")!=e})?function(t,n){for(var r=u(t),f=arguments.length,a=1,s=i.f,l=o.f;f>a;)for(var h,v=c(arguments[a++]),p=s?e(v).concat(s(v)):e(v),d=p.length,y=0;d>y;)l.call(v,h=p[y++])&&(r[h]=v[h]);return r}:f},function(t,n,r){var e=r(11),i=r(2),o=r(72);t.exports=r(10)?Object.defineProperties:function(t,n){i(t);for(var r,u=o(n),c=u.length,f=0;c>f;)e.f(t,r=u[f++],n[r]);return t}},function(t,n,r){var e=r(30),i=r(71).f,o={}.toString,u="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],c=function(t){try{return i(t)}catch(t){return u.slice()}};t.exports.f=function(t){return u&&"[object Window]"==o.call(t)?c(t):i(e(t))}},function(t,n,r){var e=r(24),i=r(30),o=r(117)(!1),u=r(145)("IE_PROTO");t.exports=function(t,n){var r,c=i(t),f=0,a=[];for(r in c)r!=u&&e(c,r)&&a.push(r);for(;n.length>f;)e(c,r=n[f++])&&(~o(a,r)||a.push(r));return a}},function(t,n,r){var e=r(72),i=r(30),o=r(116).f;t.exports=function(t){return function(n){for(var r,u=i(n),c=e(u),f=c.length,a=0,s=[];f>a;)o.call(u,r=c[a++])&&s.push(t?[r,u[r]]:u[r]);return s}}},function(t,n,r){var e=r(71),i=r(125),o=r(2),u=r(3).Reflect;t.exports=u&&u.ownKeys||function(t){var n=e.f(o(t)),r=i.f;return r?n.concat(r(t)):n}},function(t,n,r){var e=r(3).parseFloat,i=r(82).trim;t.exports=1/e(r(150)+"-0")!=-1/0?function(t){var n=i(String(t),3),r=e(n);return 0===r&&"-"==n.charAt(0)?-0:r}:e},function(t,n,r){var e=r(3).parseInt,i=r(82).trim,o=r(150),u=/^[\-+]?0[xX]/;t.exports=8!==e(o+"08")||22!==e(o+"0x16")?function(t,n){var r=i(String(t),3);return e(r,n>>>0||(u.test(r)?16:10))}:e},function(t,n){t.exports=Object.is||function(t,n){return t===n?0!==t||1/t==1/n:t!=t&&n!=n}},function(t,n,r){var e=r(16),i=r(149),o=r(46);t.exports=function(t,n,r,u){var c=String(o(t)),f=c.length,a=void 0===r?" ":String(r),s=e(n);if(s<=f||""==a)return c;var l=s-f,h=i.call(a,Math.ceil(l/a.length));return h.length>l&&(h=h.slice(0,l)),u?h+c:c+h}},function(t,n,r){n.f=r(7)},function(t,n,r){"use strict";var e=r(164);t.exports=r(118)("Map",function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},{get:function(t){var n=e.getEntry(this,t);return n&&n.v},set:function(t,n){return e.def(this,0===t?0:t,n)}},e,!0)},function(t,n,r){r(10)&&"g"!=/./g.flags&&r(11).f(RegExp.prototype,"flags",{configurable:!0,get:r(120)})},function(t,n,r){"use strict";var e=r(164);t.exports=r(118)("Set",function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},{add:function(t){return e.def(this,t=0===t?0:t,t)}},e)},function(t,n,r){"use strict";var e,i=r(48)(0),o=r(28),u=r(65),c=r(172),f=r(166),a=r(6),s=u.getWeak,l=Object.isExtensible,h=f.ufstore,v={},p=function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},d={get:function(t){if(a(t)){var n=s(t);return!0===n?h(this).get(t):n?n[this._i]:void 0}},set:function(t,n){return f.def(this,t,n)}},y=t.exports=r(118)("WeakMap",p,d,f,!0,!0);7!=(new y).set((Object.freeze||Object)(v),7).get(v)&&(e=f.getConstructor(p),c(e.prototype,d),u.NEED=!0,i(["delete","has","get","set"],function(t){var n=y.prototype,r=n[t];o(n,t,function(n,i){if(a(n)&&!l(n)){this._f||(this._f=new e);var o=this._f[t](n,i);return"set"==t?this:o}return r.call(this,n,i)})}))},,,,function(t,n){"use strict";function r(){var t=document.querySelector("#page-nav");if(t&&!document.querySelector("#page-nav .extend.prev")&&(t.innerHTML='<a class="extend prev disabled" rel="prev">&laquo; Prev</a>'+t.innerHTML),t&&!document.querySelector("#page-nav .extend.next")&&(t.innerHTML=t.innerHTML+'<a class="extend next disabled" rel="next">Next &raquo;</a>'),yiliaConfig&&yiliaConfig.open_in_new){document.querySelectorAll(".article-entry a:not(.article-more-a)").forEach(function(t){var n=t.getAttribute("target");n&&""!==n||t.setAttribute("target","_blank")})}if(yiliaConfig&&yiliaConfig.toc_hide_index){document.querySelectorAll(".toc-number").forEach(function(t){t.style.display="none"})}var n=document.querySelector("#js-aboutme");n&&0!==n.length&&(n.innerHTML=n.innerText)}t.exports={init:r}},function(t,n,r){"use strict";function e(t){return t&&t.__esModule?t:{default:t}}function i(t,n){var r=/\/|index.html/g;return t.replace(r,"")===n.replace(r,"")}function o(){for(var t=document.querySelectorAll(".js-header-menu li a"),n=window.location.pathname,r=0,e=t.length;r<e;r++){var o=t[r];i(n,o.getAttribute("href"))&&(0,h.default)(o,"active")}}function u(t){for(var n=t.offsetLeft,r=t.offsetParent;null!==r;)n+=r.offsetLeft,r=r.offsetParent;return n}function c(t){for(var n=t.offsetTop,r=t.offsetParent;null!==r;)n+=r.offsetTop,r=r.offsetParent;return n}function f(t,n,r,e,i){var o=u(t),f=c(t)-n;if(f-r<=i){var a=t.$newDom;a||(a=t.cloneNode(!0),(0,d.default)(t,a),t.$newDom=a,a.style.position="fixed",a.style.top=(r||f)+"px",a.style.left=o+"px",a.style.zIndex=e||2,a.style.width="100%",a.style.color="#fff"),a.style.visibility="visible",t.style.visibility="hidden"}else{t.style.visibility="visible";var s=t.$newDom;s&&(s.style.visibility="hidden")}}function a(){var t=document.querySelector(".js-overlay"),n=document.querySelector(".js-header-menu");f(t,document.body.scrollTop,-63,2,0),f(n,document.body.scrollTop,1,3,0)}function s(){document.querySelector("#container").addEventListener("scroll",function(t){a()}),window.addEventListener("scroll",function(t){a()}),a()}var l=r(156),h=e(l),v=r(157),p=(e(v),r(382)),d=e(p),y=r(128),g=e(y),b=r(190),m=e(b),x=r(129);(function(){g.default.versions.mobile&&window.screen.width<800&&(o(),s())})(),(0,x.addLoadEvent)(function(){m.default.init()}),t.exports={}},,,,function(t,n,r){(function(t){"use strict";function n(t,n,r){t[n]||Object[e](t,n,{writable:!0,configurable:!0,value:r})}if(r(381),r(391),r(198),t._babelPolyfill)throw new Error("only one instance of babel-polyfill is allowed");t._babelPolyfill=!0;var e="defineProperty";n(String.prototype,"padLeft","".padStart),n(String.prototype,"padRight","".padEnd),"pop,reverse,shift,keys,values,entries,indexOf,every,some,forEach,map,filter,find,findIndex,includes,join,slice,concat,push,splice,unshift,sort,lastIndexOf,reduce,reduceRight,copyWithin,fill".split(",").forEach(function(t){[][t]&&n(Array,t,Function.call.bind([][t]))})}).call(n,function(){return this}())},,,function(t,n,r){r(210),t.exports=r(52).RegExp.escape},,,,function(t,n,r){var e=r(6),i=r(138),o=r(7)("species");t.exports=function(t){var n;return i(t)&&(n=t.constructor,"function"!=typeof n||n!==Array&&!i(n.prototype)||(n=void 0),e(n)&&null===(n=n[o])&&(n=void 0)),void 0===n?Array:n}},function(t,n,r){var e=r(202);t.exports=function(t,n){return new(e(t))(n)}},function(t,n,r){"use strict";var e=r(2),i=r(50),o="number";t.exports=function(t){if("string"!==t&&t!==o&&"default"!==t)throw TypeError("Incorrect hint");return i(e(this),t!=o)}},function(t,n,r){var e=r(72),i=r(125),o=r(116);t.exports=function(t){var n=e(t),r=i.f;if(r)for(var u,c=r(t),f=o.f,a=0;c.length>a;)f.call(t,u=c[a++])&&n.push(u);return n}},function(t,n,r){var e=r(72),i=r(30);t.exports=function(t,n){for(var r,o=i(t),u=e(o),c=u.length,f=0;c>f;)if(o[r=u[f++]]===n)return r}},function(t,n,r){"use strict";var e=r(208),i=r(121),o=r(26);t.exports=function(){for(var t=o(this),n=arguments.length,r=Array(n),u=0,c=e._,f=!1;n>u;)(r[u]=arguments[u++])===c&&(f=!0);return function(){var e,o=this,u=arguments.length,a=0,s=0;if(!f&&!u)return i(t,r,o);if(e=r.slice(),f)for(;n>a;a++)e[a]===c&&(e[a]=arguments[s++]);for(;u>s;)e.push(arguments[s++]);return i(t,e,o)}}},function(t,n,r){t.exports=r(3)},function(t,n){t.exports=function(t,n){var r=n===Object(n)?function(t){return n[t]}:n;return function(n){return String(n).replace(t,r)}}},function(t,n,r){var e=r(1),i=r(209)(/[\\^$*+?.()|[\]{}]/g,"\\$&");e(e.S,"RegExp",{escape:function(t){return i(t)}})},function(t,n,r){var e=r(1);e(e.P,"Array",{copyWithin:r(160)}),r(78)("copyWithin")},function(t,n,r){"use strict";var e=r(1),i=r(48)(4);e(e.P+e.F*!r(47)([].every,!0),"Array",{every:function(t){return i(this,t,arguments[1])}})},function(t,n,r){var e=r(1);e(e.P,"Array",{fill:r(130)}),r(78)("fill")},function(t,n,r){"use strict";var e=r(1),i=r(48)(2);e(e.P+e.F*!r(47)([].filter,!0),"Array",{filter:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(1),i=r(48)(6),o="findIndex",u=!0;o in[]&&Array(1)[o](function(){u=!1}),e(e.P+e.F*u,"Array",{findIndex:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0)}}),r(78)(o)},function(t,n,r){"use strict";var e=r(1),i=r(48)(5),o="find",u=!0;o in[]&&Array(1)[o](function(){u=!1}),e(e.P+e.F*u,"Array",{find:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0)}}),r(78)(o)},function(t,n,r){"use strict";var e=r(1),i=r(48)(0),o=r(47)([].forEach,!0);e(e.P+e.F*!o,"Array",{forEach:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(53),i=r(1),o=r(17),u=r(169),c=r(137),f=r(16),a=r(131),s=r(154);i(i.S+i.F*!r(123)(function(t){Array.from(t)}),"Array",{from:function(t){var n,r,i,l,h=o(t),v="function"==typeof this?this:Array,p=arguments.length,d=p>1?arguments[1]:void 0,y=void 0!==d,g=0,b=s(h);if(y&&(d=e(d,p>2?arguments[2]:void 0,2)),void 0==b||v==Array&&c(b))for(n=f(h.length),r=new v(n);n>g;g++)a(r,g,y?d(h[g],g):h[g]);else for(l=b.call(h),r=new v;!(i=l.next()).done;g++)a(r,g,y?u(l,d,[i.value,g],!0):i.value);return r.length=g,r}})},function(t,n,r){"use strict";var e=r(1),i=r(117)(!1),o=[].indexOf,u=!!o&&1/[1].indexOf(1,-0)<0;e(e.P+e.F*(u||!r(47)(o)),"Array",{indexOf:function(t){return u?o.apply(this,arguments)||0:i(this,t,arguments[1])}})},function(t,n,r){var e=r(1);e(e.S,"Array",{isArray:r(138)})},function(t,n,r){"use strict";var e=r(1),i=r(30),o=[].join;e(e.P+e.F*(r(115)!=Object||!r(47)(o)),"Array",{join:function(t){return o.call(i(this),void 0===t?",":t)}})},function(t,n,r){"use strict";var e=r(1),i=r(30),o=r(67),u=r(16),c=[].lastIndexOf,f=!!c&&1/[1].lastIndexOf(1,-0)<0;e(e.P+e.F*(f||!r(47)(c)),"Array",{lastIndexOf:function(t){if(f)return c.apply(this,arguments)||0;var n=i(this),r=u(n.length),e=r-1;for(arguments.length>1&&(e=Math.min(e,o(arguments[1]))),e<0&&(e=r+e);e>=0;e--)if(e in n&&n[e]===t)return e||0;return-1}})},function(t,n,r){"use strict";var e=r(1),i=r(48)(1);e(e.P+e.F*!r(47)([].map,!0),"Array",{map:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(1),i=r(131);e(e.S+e.F*r(4)(function(){function t(){}return!(Array.of.call(t)instanceof t)}),"Array",{of:function(){for(var t=0,n=arguments.length,r=new("function"==typeof this?this:Array)(n);n>t;)i(r,t,arguments[t++]);return r.length=n,r}})},function(t,n,r){"use strict";var e=r(1),i=r(162);e(e.P+e.F*!r(47)([].reduceRight,!0),"Array",{reduceRight:function(t){return i(this,t,arguments.length,arguments[1],!0)}})},function(t,n,r){"use strict";var e=r(1),i=r(162);e(e.P+e.F*!r(47)([].reduce,!0),"Array",{reduce:function(t){return i(this,t,arguments.length,arguments[1],!1)}})},function(t,n,r){"use strict";var e=r(1),i=r(135),o=r(45),u=r(75),c=r(16),f=[].slice;e(e.P+e.F*r(4)(function(){i&&f.call(i)}),"Array",{slice:function(t,n){var r=c(this.length),e=o(this);if(n=void 0===n?r:n,"Array"==e)return f.call(this,t,n);for(var i=u(t,r),a=u(n,r),s=c(a-i),l=Array(s),h=0;h<s;h++)l[h]="String"==e?this.charAt(i+h):this[i+h];return l}})},function(t,n,r){"use strict";var e=r(1),i=r(48)(3);e(e.P+e.F*!r(47)([].some,!0),"Array",{some:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(1),i=r(26),o=r(17),u=r(4),c=[].sort,f=[1,2,3];e(e.P+e.F*(u(function(){f.sort(void 0)})||!u(function(){f.sort(null)})||!r(47)(c)),"Array",{sort:function(t){return void 0===t?c.call(o(this)):c.call(o(this),i(t))}})},function(t,n,r){r(74)("Array")},function(t,n,r){var e=r(1);e(e.S,"Date",{now:function(){return(new Date).getTime()}})},function(t,n,r){"use strict";var e=r(1),i=r(4),o=Date.prototype.getTime,u=function(t){return t>9?t:"0"+t};e(e.P+e.F*(i(function(){return"0385-07-25T07:06:39.999Z"!=new Date(-5e13-1).toISOString()})||!i(function(){new Date(NaN).toISOString()})),"Date",{toISOString:function(){
if(!isFinite(o.call(this)))throw RangeError("Invalid time value");var t=this,n=t.getUTCFullYear(),r=t.getUTCMilliseconds(),e=n<0?"-":n>9999?"+":"";return e+("00000"+Math.abs(n)).slice(e?-6:-4)+"-"+u(t.getUTCMonth()+1)+"-"+u(t.getUTCDate())+"T"+u(t.getUTCHours())+":"+u(t.getUTCMinutes())+":"+u(t.getUTCSeconds())+"."+(r>99?r:"0"+u(r))+"Z"}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(50);e(e.P+e.F*r(4)(function(){return null!==new Date(NaN).toJSON()||1!==Date.prototype.toJSON.call({toISOString:function(){return 1}})}),"Date",{toJSON:function(t){var n=i(this),r=o(n);return"number"!=typeof r||isFinite(r)?n.toISOString():null}})},function(t,n,r){var e=r(7)("toPrimitive"),i=Date.prototype;e in i||r(27)(i,e,r(204))},function(t,n,r){var e=Date.prototype,i="Invalid Date",o="toString",u=e[o],c=e.getTime;new Date(NaN)+""!=i&&r(28)(e,o,function(){var t=c.call(this);return t===t?u.call(this):i})},function(t,n,r){var e=r(1);e(e.P,"Function",{bind:r(163)})},function(t,n,r){"use strict";var e=r(6),i=r(32),o=r(7)("hasInstance"),u=Function.prototype;o in u||r(11).f(u,o,{value:function(t){if("function"!=typeof this||!e(t))return!1;if(!e(this.prototype))return t instanceof this;for(;t=i(t);)if(this.prototype===t)return!0;return!1}})},function(t,n,r){var e=r(11).f,i=r(66),o=r(24),u=Function.prototype,c="name",f=Object.isExtensible||function(){return!0};c in u||r(10)&&e(u,c,{configurable:!0,get:function(){try{var t=this,n=(""+t).match(/^\s*function ([^ (]*)/)[1];return o(t,c)||!f(t)||e(t,c,i(5,n)),n}catch(t){return""}}})},function(t,n,r){var e=r(1),i=r(171),o=Math.sqrt,u=Math.acosh;e(e.S+e.F*!(u&&710==Math.floor(u(Number.MAX_VALUE))&&u(1/0)==1/0),"Math",{acosh:function(t){return(t=+t)<1?NaN:t>94906265.62425156?Math.log(t)+Math.LN2:i(t-1+o(t-1)*o(t+1))}})},function(t,n,r){function e(t){return isFinite(t=+t)&&0!=t?t<0?-e(-t):Math.log(t+Math.sqrt(t*t+1)):t}var i=r(1),o=Math.asinh;i(i.S+i.F*!(o&&1/o(0)>0),"Math",{asinh:e})},function(t,n,r){var e=r(1),i=Math.atanh;e(e.S+e.F*!(i&&1/i(-0)<0),"Math",{atanh:function(t){return 0==(t=+t)?t:Math.log((1+t)/(1-t))/2}})},function(t,n,r){var e=r(1),i=r(142);e(e.S,"Math",{cbrt:function(t){return i(t=+t)*Math.pow(Math.abs(t),1/3)}})},function(t,n,r){var e=r(1);e(e.S,"Math",{clz32:function(t){return(t>>>=0)?31-Math.floor(Math.log(t+.5)*Math.LOG2E):32}})},function(t,n,r){var e=r(1),i=Math.exp;e(e.S,"Math",{cosh:function(t){return(i(t=+t)+i(-t))/2}})},function(t,n,r){var e=r(1),i=r(141);e(e.S+e.F*(i!=Math.expm1),"Math",{expm1:i})},function(t,n,r){var e=r(1),i=r(142),o=Math.pow,u=o(2,-52),c=o(2,-23),f=o(2,127)*(2-c),a=o(2,-126),s=function(t){return t+1/u-1/u};e(e.S,"Math",{fround:function(t){var n,r,e=Math.abs(t),o=i(t);return e<a?o*s(e/a/c)*a*c:(n=(1+c/u)*e,r=n-(n-e),r>f||r!=r?o*(1/0):o*r)}})},function(t,n,r){var e=r(1),i=Math.abs;e(e.S,"Math",{hypot:function(t,n){for(var r,e,o=0,u=0,c=arguments.length,f=0;u<c;)r=i(arguments[u++]),f<r?(e=f/r,o=o*e*e+1,f=r):r>0?(e=r/f,o+=e*e):o+=r;return f===1/0?1/0:f*Math.sqrt(o)}})},function(t,n,r){var e=r(1),i=Math.imul;e(e.S+e.F*r(4)(function(){return-5!=i(4294967295,5)||2!=i.length}),"Math",{imul:function(t,n){var r=65535,e=+t,i=+n,o=r&e,u=r&i;return 0|o*u+((r&e>>>16)*u+o*(r&i>>>16)<<16>>>0)}})},function(t,n,r){var e=r(1);e(e.S,"Math",{log10:function(t){return Math.log(t)/Math.LN10}})},function(t,n,r){var e=r(1);e(e.S,"Math",{log1p:r(171)})},function(t,n,r){var e=r(1);e(e.S,"Math",{log2:function(t){return Math.log(t)/Math.LN2}})},function(t,n,r){var e=r(1);e(e.S,"Math",{sign:r(142)})},function(t,n,r){var e=r(1),i=r(141),o=Math.exp;e(e.S+e.F*r(4)(function(){return-2e-17!=!Math.sinh(-2e-17)}),"Math",{sinh:function(t){return Math.abs(t=+t)<1?(i(t)-i(-t))/2:(o(t-1)-o(-t-1))*(Math.E/2)}})},function(t,n,r){var e=r(1),i=r(141),o=Math.exp;e(e.S,"Math",{tanh:function(t){var n=i(t=+t),r=i(-t);return n==1/0?1:r==1/0?-1:(n-r)/(o(t)+o(-t))}})},function(t,n,r){var e=r(1);e(e.S,"Math",{trunc:function(t){return(t>0?Math.floor:Math.ceil)(t)}})},function(t,n,r){"use strict";var e=r(3),i=r(24),o=r(45),u=r(136),c=r(50),f=r(4),a=r(71).f,s=r(31).f,l=r(11).f,h=r(82).trim,v="Number",p=e[v],d=p,y=p.prototype,g=o(r(70)(y))==v,b="trim"in String.prototype,m=function(t){var n=c(t,!1);if("string"==typeof n&&n.length>2){n=b?n.trim():h(n,3);var r,e,i,o=n.charCodeAt(0);if(43===o||45===o){if(88===(r=n.charCodeAt(2))||120===r)return NaN}else if(48===o){switch(n.charCodeAt(1)){case 66:case 98:e=2,i=49;break;case 79:case 111:e=8,i=55;break;default:return+n}for(var u,f=n.slice(2),a=0,s=f.length;a<s;a++)if((u=f.charCodeAt(a))<48||u>i)return NaN;return parseInt(f,e)}}return+n};if(!p(" 0o1")||!p("0b1")||p("+0x1")){p=function(t){var n=arguments.length<1?0:t,r=this;return r instanceof p&&(g?f(function(){y.valueOf.call(r)}):o(r)!=v)?u(new d(m(n)),r,p):m(n)};for(var x,w=r(10)?a(d):"MAX_VALUE,MIN_VALUE,NaN,NEGATIVE_INFINITY,POSITIVE_INFINITY,EPSILON,isFinite,isInteger,isNaN,isSafeInteger,MAX_SAFE_INTEGER,MIN_SAFE_INTEGER,parseFloat,parseInt,isInteger".split(","),S=0;w.length>S;S++)i(d,x=w[S])&&!i(p,x)&&l(p,x,s(d,x));p.prototype=y,y.constructor=p,r(28)(e,v,p)}},function(t,n,r){var e=r(1);e(e.S,"Number",{EPSILON:Math.pow(2,-52)})},function(t,n,r){var e=r(1),i=r(3).isFinite;e(e.S,"Number",{isFinite:function(t){return"number"==typeof t&&i(t)}})},function(t,n,r){var e=r(1);e(e.S,"Number",{isInteger:r(168)})},function(t,n,r){var e=r(1);e(e.S,"Number",{isNaN:function(t){return t!=t}})},function(t,n,r){var e=r(1),i=r(168),o=Math.abs;e(e.S,"Number",{isSafeInteger:function(t){return i(t)&&o(t)<=9007199254740991}})},function(t,n,r){var e=r(1);e(e.S,"Number",{MAX_SAFE_INTEGER:9007199254740991})},function(t,n,r){var e=r(1);e(e.S,"Number",{MIN_SAFE_INTEGER:-9007199254740991})},function(t,n,r){var e=r(1),i=r(178);e(e.S+e.F*(Number.parseFloat!=i),"Number",{parseFloat:i})},function(t,n,r){var e=r(1),i=r(179);e(e.S+e.F*(Number.parseInt!=i),"Number",{parseInt:i})},function(t,n,r){"use strict";var e=r(1),i=r(67),o=r(159),u=r(149),c=1..toFixed,f=Math.floor,a=[0,0,0,0,0,0],s="Number.toFixed: incorrect invocation!",l="0",h=function(t,n){for(var r=-1,e=n;++r<6;)e+=t*a[r],a[r]=e%1e7,e=f(e/1e7)},v=function(t){for(var n=6,r=0;--n>=0;)r+=a[n],a[n]=f(r/t),r=r%t*1e7},p=function(){for(var t=6,n="";--t>=0;)if(""!==n||0===t||0!==a[t]){var r=String(a[t]);n=""===n?r:n+u.call(l,7-r.length)+r}return n},d=function(t,n,r){return 0===n?r:n%2==1?d(t,n-1,r*t):d(t*t,n/2,r)},y=function(t){for(var n=0,r=t;r>=4096;)n+=12,r/=4096;for(;r>=2;)n+=1,r/=2;return n};e(e.P+e.F*(!!c&&("0.000"!==8e-5.toFixed(3)||"1"!==.9.toFixed(0)||"1.25"!==1.255.toFixed(2)||"1000000000000000128"!==(0xde0b6b3a7640080).toFixed(0))||!r(4)(function(){c.call({})})),"Number",{toFixed:function(t){var n,r,e,c,f=o(this,s),a=i(t),g="",b=l;if(a<0||a>20)throw RangeError(s);if(f!=f)return"NaN";if(f<=-1e21||f>=1e21)return String(f);if(f<0&&(g="-",f=-f),f>1e-21)if(n=y(f*d(2,69,1))-69,r=n<0?f*d(2,-n,1):f/d(2,n,1),r*=4503599627370496,(n=52-n)>0){for(h(0,r),e=a;e>=7;)h(1e7,0),e-=7;for(h(d(10,e,1),0),e=n-1;e>=23;)v(1<<23),e-=23;v(1<<e),h(1,1),v(2),b=p()}else h(0,r),h(1<<-n,0),b=p()+u.call(l,a);return a>0?(c=b.length,b=g+(c<=a?"0."+u.call(l,a-c)+b:b.slice(0,c-a)+"."+b.slice(c-a))):b=g+b,b}})},function(t,n,r){"use strict";var e=r(1),i=r(4),o=r(159),u=1..toPrecision;e(e.P+e.F*(i(function(){return"1"!==u.call(1,void 0)})||!i(function(){u.call({})})),"Number",{toPrecision:function(t){var n=o(this,"Number#toPrecision: incorrect invocation!");return void 0===t?u.call(n):u.call(n,t)}})},function(t,n,r){var e=r(1);e(e.S+e.F,"Object",{assign:r(172)})},function(t,n,r){var e=r(1);e(e.S,"Object",{create:r(70)})},function(t,n,r){var e=r(1);e(e.S+e.F*!r(10),"Object",{defineProperties:r(173)})},function(t,n,r){var e=r(1);e(e.S+e.F*!r(10),"Object",{defineProperty:r(11).f})},function(t,n,r){var e=r(6),i=r(65).onFreeze;r(49)("freeze",function(t){return function(n){return t&&e(n)?t(i(n)):n}})},function(t,n,r){var e=r(30),i=r(31).f;r(49)("getOwnPropertyDescriptor",function(){return function(t,n){return i(e(t),n)}})},function(t,n,r){r(49)("getOwnPropertyNames",function(){return r(174).f})},function(t,n,r){var e=r(17),i=r(32);r(49)("getPrototypeOf",function(){return function(t){return i(e(t))}})},function(t,n,r){var e=r(6);r(49)("isExtensible",function(t){return function(n){return!!e(n)&&(!t||t(n))}})},function(t,n,r){var e=r(6);r(49)("isFrozen",function(t){return function(n){return!e(n)||!!t&&t(n)}})},function(t,n,r){var e=r(6);r(49)("isSealed",function(t){return function(n){return!e(n)||!!t&&t(n)}})},function(t,n,r){var e=r(1);e(e.S,"Object",{is:r(180)})},function(t,n,r){var e=r(17),i=r(72);r(49)("keys",function(){return function(t){return i(e(t))}})},function(t,n,r){var e=r(6),i=r(65).onFreeze;r(49)("preventExtensions",function(t){return function(n){return t&&e(n)?t(i(n)):n}})},function(t,n,r){var e=r(6),i=r(65).onFreeze;r(49)("seal",function(t){return function(n){return t&&e(n)?t(i(n)):n}})},function(t,n,r){var e=r(1);e(e.S,"Object",{setPrototypeOf:r(144).set})},function(t,n,r){"use strict";var e=r(114),i={};i[r(7)("toStringTag")]="z",i+""!="[object z]"&&r(28)(Object.prototype,"toString",function(){return"[object "+e(this)+"]"},!0)},function(t,n,r){var e=r(1),i=r(178);e(e.G+e.F*(parseFloat!=i),{parseFloat:i})},function(t,n,r){var e=r(1),i=r(179);e(e.G+e.F*(parseInt!=i),{parseInt:i})},function(t,n,r){"use strict";var e,i,o,u=r(69),c=r(3),f=r(53),a=r(114),s=r(1),l=r(6),h=r(26),v=r(68),p=r(79),d=r(146),y=r(151).set,g=r(143)(),b="Promise",m=c.TypeError,x=c.process,w=c[b],x=c.process,S="process"==a(x),_=function(){},O=!!function(){try{var t=w.resolve(1),n=(t.constructor={})[r(7)("species")]=function(t){t(_,_)};return(S||"function"==typeof PromiseRejectionEvent)&&t.then(_)instanceof n}catch(t){}}(),E=function(t,n){return t===n||t===w&&n===o},P=function(t){var n;return!(!l(t)||"function"!=typeof(n=t.then))&&n},j=function(t){return E(w,t)?new F(t):new i(t)},F=i=function(t){var n,r;this.promise=new t(function(t,e){if(void 0!==n||void 0!==r)throw m("Bad Promise constructor");n=t,r=e}),this.resolve=h(n),this.reject=h(r)},M=function(t){try{t()}catch(t){return{error:t}}},A=function(t,n){if(!t._n){t._n=!0;var r=t._c;g(function(){for(var e=t._v,i=1==t._s,o=0;r.length>o;)!function(n){var r,o,u=i?n.ok:n.fail,c=n.resolve,f=n.reject,a=n.domain;try{u?(i||(2==t._h&&I(t),t._h=1),!0===u?r=e:(a&&a.enter(),r=u(e),a&&a.exit()),r===n.promise?f(m("Promise-chain cycle")):(o=P(r))?o.call(r,c,f):c(r)):f(e)}catch(t){f(t)}}(r[o++]);t._c=[],t._n=!1,n&&!t._h&&N(t)})}},N=function(t){y.call(c,function(){var n,r,e,i=t._v;if(T(t)&&(n=M(function(){S?x.emit("unhandledRejection",i,t):(r=c.onunhandledrejection)?r({promise:t,reason:i}):(e=c.console)&&e.error&&e.error("Unhandled promise rejection",i)}),t._h=S||T(t)?2:1),t._a=void 0,n)throw n.error})},T=function(t){if(1==t._h)return!1;for(var n,r=t._a||t._c,e=0;r.length>e;)if(n=r[e++],n.fail||!T(n.promise))return!1;return!0},I=function(t){y.call(c,function(){var n;S?x.emit("rejectionHandled",t):(n=c.onrejectionhandled)&&n({promise:t,reason:t._v})})},k=function(t){var n=this;n._d||(n._d=!0,n=n._w||n,n._v=t,n._s=2,n._a||(n._a=n._c.slice()),A(n,!0))},L=function(t){var n,r=this;if(!r._d){r._d=!0,r=r._w||r;try{if(r===t)throw m("Promise can't be resolved itself");(n=P(t))?g(function(){var e={_w:r,_d:!1};try{n.call(t,f(L,e,1),f(k,e,1))}catch(t){k.call(e,t)}}):(r._v=t,r._s=1,A(r,!1))}catch(t){k.call({_w:r,_d:!1},t)}}};O||(w=function(t){v(this,w,b,"_h"),h(t),e.call(this);try{t(f(L,this,1),f(k,this,1))}catch(t){k.call(this,t)}},e=function(t){this._c=[],this._a=void 0,this._s=0,this._d=!1,this._v=void 0,this._h=0,this._n=!1},e.prototype=r(73)(w.prototype,{then:function(t,n){var r=j(d(this,w));return r.ok="function"!=typeof t||t,r.fail="function"==typeof n&&n,r.domain=S?x.domain:void 0,this._c.push(r),this._a&&this._a.push(r),this._s&&A(this,!1),r.promise},catch:function(t){return this.then(void 0,t)}}),F=function(){var t=new e;this.promise=t,this.resolve=f(L,t,1),this.reject=f(k,t,1)}),s(s.G+s.W+s.F*!O,{Promise:w}),r(81)(w,b),r(74)(b),o=r(52)[b],s(s.S+s.F*!O,b,{reject:function(t){var n=j(this);return(0,n.reject)(t),n.promise}}),s(s.S+s.F*(u||!O),b,{resolve:function(t){if(t instanceof w&&E(t.constructor,this))return t;var n=j(this);return(0,n.resolve)(t),n.promise}}),s(s.S+s.F*!(O&&r(123)(function(t){w.all(t).catch(_)})),b,{all:function(t){var n=this,r=j(n),e=r.resolve,i=r.reject,o=M(function(){var r=[],o=0,u=1;p(t,!1,function(t){var c=o++,f=!1;r.push(void 0),u++,n.resolve(t).then(function(t){f||(f=!0,r[c]=t,--u||e(r))},i)}),--u||e(r)});return o&&i(o.error),r.promise},race:function(t){var n=this,r=j(n),e=r.reject,i=M(function(){p(t,!1,function(t){n.resolve(t).then(r.resolve,e)})});return i&&e(i.error),r.promise}})},function(t,n,r){var e=r(1),i=r(26),o=r(2),u=(r(3).Reflect||{}).apply,c=Function.apply;e(e.S+e.F*!r(4)(function(){u(function(){})}),"Reflect",{apply:function(t,n,r){var e=i(t),f=o(r);return u?u(e,n,f):c.call(e,n,f)}})},function(t,n,r){var e=r(1),i=r(70),o=r(26),u=r(2),c=r(6),f=r(4),a=r(163),s=(r(3).Reflect||{}).construct,l=f(function(){function t(){}return!(s(function(){},[],t)instanceof t)}),h=!f(function(){s(function(){})});e(e.S+e.F*(l||h),"Reflect",{construct:function(t,n){o(t),u(n);var r=arguments.length<3?t:o(arguments[2]);if(h&&!l)return s(t,n,r);if(t==r){switch(n.length){case 0:return new t;case 1:return new t(n[0]);case 2:return new t(n[0],n[1]);case 3:return new t(n[0],n[1],n[2]);case 4:return new t(n[0],n[1],n[2],n[3])}var e=[null];return e.push.apply(e,n),new(a.apply(t,e))}var f=r.prototype,v=i(c(f)?f:Object.prototype),p=Function.apply.call(t,v,n);return c(p)?p:v}})},function(t,n,r){var e=r(11),i=r(1),o=r(2),u=r(50);i(i.S+i.F*r(4)(function(){Reflect.defineProperty(e.f({},1,{value:1}),1,{value:2})}),"Reflect",{defineProperty:function(t,n,r){o(t),n=u(n,!0),o(r);try{return e.f(t,n,r),!0}catch(t){return!1}}})},function(t,n,r){var e=r(1),i=r(31).f,o=r(2);e(e.S,"Reflect",{deleteProperty:function(t,n){var r=i(o(t),n);return!(r&&!r.configurable)&&delete t[n]}})},function(t,n,r){"use strict";var e=r(1),i=r(2),o=function(t){this._t=i(t),this._i=0;var n,r=this._k=[];for(n in t)r.push(n)};r(139)(o,"Object",function(){var t,n=this,r=n._k;do{if(n._i>=r.length)return{value:void 0,done:!0}}while(!((t=r[n._i++])in n._t));return{value:t,done:!1}}),e(e.S,"Reflect",{enumerate:function(t){return new o(t)}})},function(t,n,r){var e=r(31),i=r(1),o=r(2);i(i.S,"Reflect",{getOwnPropertyDescriptor:function(t,n){return e.f(o(t),n)}})},function(t,n,r){var e=r(1),i=r(32),o=r(2);e(e.S,"Reflect",{getPrototypeOf:function(t){return i(o(t))}})},function(t,n,r){function e(t,n){var r,c,s=arguments.length<3?t:arguments[2];return a(t)===s?t[n]:(r=i.f(t,n))?u(r,"value")?r.value:void 0!==r.get?r.get.call(s):void 0:f(c=o(t))?e(c,n,s):void 0}var i=r(31),o=r(32),u=r(24),c=r(1),f=r(6),a=r(2);c(c.S,"Reflect",{get:e})},function(t,n,r){var e=r(1);e(e.S,"Reflect",{has:function(t,n){return n in t}})},function(t,n,r){var e=r(1),i=r(2),o=Object.isExtensible;e(e.S,"Reflect",{isExtensible:function(t){return i(t),!o||o(t)}})},function(t,n,r){var e=r(1);e(e.S,"Reflect",{ownKeys:r(177)})},function(t,n,r){var e=r(1),i=r(2),o=Object.preventExtensions;e(e.S,"Reflect",{preventExtensions:function(t){i(t);try{return o&&o(t),!0}catch(t){return!1}}})},function(t,n,r){var e=r(1),i=r(144);i&&e(e.S,"Reflect",{setPrototypeOf:function(t,n){i.check(t,n);try{return i.set(t,n),!0}catch(t){return!1}}})},function(t,n,r){function e(t,n,r){var f,h,v=arguments.length<4?t:arguments[3],p=o.f(s(t),n);if(!p){if(l(h=u(t)))return e(h,n,r,v);p=a(0)}return c(p,"value")?!(!1===p.writable||!l(v)||(f=o.f(v,n)||a(0),f.value=r,i.f(v,n,f),0)):void 0!==p.set&&(p.set.call(v,r),!0)}var i=r(11),o=r(31),u=r(32),c=r(24),f=r(1),a=r(66),s=r(2),l=r(6);f(f.S,"Reflect",{set:e})},function(t,n,r){var e=r(3),i=r(136),o=r(11).f,u=r(71).f,c=r(122),f=r(120),a=e.RegExp,s=a,l=a.prototype,h=/a/g,v=/a/g,p=new a(h)!==h;if(r(10)&&(!p||r(4)(function(){return v[r(7)("match")]=!1,a(h)!=h||a(v)==v||"/a/i"!=a(h,"i")}))){a=function(t,n){var r=this instanceof a,e=c(t),o=void 0===n;return!r&&e&&t.constructor===a&&o?t:i(p?new s(e&&!o?t.source:t,n):s((e=t instanceof a)?t.source:t,e&&o?f.call(t):n),r?this:l,a)};for(var d=u(s),y=0;d.length>y;)!function(t){t in a||o(a,t,{configurable:!0,get:function(){return s[t]},set:function(n){s[t]=n}})}(d[y++]);l.constructor=a,a.prototype=l,r(28)(e,"RegExp",a)}r(74)("RegExp")},function(t,n,r){r(119)("match",1,function(t,n,r){return[function(r){"use strict";var e=t(this),i=void 0==r?void 0:r[n];return void 0!==i?i.call(r,e):new RegExp(r)[n](String(e))},r]})},function(t,n,r){r(119)("replace",2,function(t,n,r){return[function(e,i){"use strict";var o=t(this),u=void 0==e?void 0:e[n];return void 0!==u?u.call(e,o,i):r.call(String(o),e,i)},r]})},function(t,n,r){r(119)("search",1,function(t,n,r){return[function(r){"use strict";var e=t(this),i=void 0==r?void 0:r[n];return void 0!==i?i.call(r,e):new RegExp(r)[n](String(e))},r]})},function(t,n,r){r(119)("split",2,function(t,n,e){"use strict";var i=r(122),o=e,u=[].push,c="split",f="length",a="lastIndex";if("c"=="abbc"[c](/(b)*/)[1]||4!="test"[c](/(?:)/,-1)[f]||2!="ab"[c](/(?:ab)*/)[f]||4!="."[c](/(.?)(.?)/)[f]||"."[c](/()()/)[f]>1||""[c](/.?/)[f]){var s=void 0===/()??/.exec("")[1];e=function(t,n){var r=String(this);if(void 0===t&&0===n)return[];if(!i(t))return o.call(r,t,n);var e,c,l,h,v,p=[],d=(t.ignoreCase?"i":"")+(t.multiline?"m":"")+(t.unicode?"u":"")+(t.sticky?"y":""),y=0,g=void 0===n?4294967295:n>>>0,b=new RegExp(t.source,d+"g");for(s||(e=new RegExp("^"+b.source+"$(?!\\s)",d));(c=b.exec(r))&&!((l=c.index+c[0][f])>y&&(p.push(r.slice(y,c.index)),!s&&c[f]>1&&c[0].replace(e,function(){for(v=1;v<arguments[f]-2;v++)void 0===arguments[v]&&(c[v]=void 0)}),c[f]>1&&c.index<r[f]&&u.apply(p,c.slice(1)),h=c[0][f],y=l,p[f]>=g));)b[a]===c.index&&b[a]++;return y===r[f]?!h&&b.test("")||p.push(""):p.push(r.slice(y)),p[f]>g?p.slice(0,g):p}}else"0"[c](void 0,0)[f]&&(e=function(t,n){return void 0===t&&0===n?[]:o.call(this,t,n)});return[function(r,i){var o=t(this),u=void 0==r?void 0:r[n];return void 0!==u?u.call(r,o,i):e.call(String(o),r,i)},e]})},function(t,n,r){"use strict";r(184);var e=r(2),i=r(120),o=r(10),u="toString",c=/./[u],f=function(t){r(28)(RegExp.prototype,u,t,!0)};r(4)(function(){return"/a/b"!=c.call({source:"a",flags:"b"})})?f(function(){var t=e(this);return"/".concat(t.source,"/","flags"in t?t.flags:!o&&t instanceof RegExp?i.call(t):void 0)}):c.name!=u&&f(function(){return c.call(this)})},function(t,n,r){"use strict";r(29)("anchor",function(t){return function(n){return t(this,"a","name",n)}})},function(t,n,r){"use strict";r(29)("big",function(t){return function(){return t(this,"big","","")}})},function(t,n,r){"use strict";r(29)("blink",function(t){return function(){return t(this,"blink","","")}})},function(t,n,r){"use strict";r(29)("bold",function(t){return function(){return t(this,"b","","")}})},function(t,n,r){"use strict";var e=r(1),i=r(147)(!1);e(e.P,"String",{codePointAt:function(t){return i(this,t)}})},function(t,n,r){"use strict";var e=r(1),i=r(16),o=r(148),u="endsWith",c=""[u];e(e.P+e.F*r(134)(u),"String",{endsWith:function(t){var n=o(this,t,u),r=arguments.length>1?arguments[1]:void 0,e=i(n.length),f=void 0===r?e:Math.min(i(r),e),a=String(t);return c?c.call(n,a,f):n.slice(f-a.length,f)===a}})},function(t,n,r){"use strict";r(29)("fixed",function(t){return function(){return t(this,"tt","","")}})},function(t,n,r){"use strict";r(29)("fontcolor",function(t){return function(n){return t(this,"font","color",n)}})},function(t,n,r){"use strict";r(29)("fontsize",function(t){return function(n){return t(this,"font","size",n)}})},function(t,n,r){var e=r(1),i=r(75),o=String.fromCharCode,u=String.fromCodePoint;e(e.S+e.F*(!!u&&1!=u.length),"String",{fromCodePoint:function(t){for(var n,r=[],e=arguments.length,u=0;e>u;){if(n=+arguments[u++],i(n,1114111)!==n)throw RangeError(n+" is not a valid code point");r.push(n<65536?o(n):o(55296+((n-=65536)>>10),n%1024+56320))}return r.join("")}})},function(t,n,r){"use strict";var e=r(1),i=r(148),o="includes";e(e.P+e.F*r(134)(o),"String",{includes:function(t){return!!~i(this,t,o).indexOf(t,arguments.length>1?arguments[1]:void 0)}})},function(t,n,r){"use strict";r(29)("italics",function(t){return function(){return t(this,"i","","")}})},function(t,n,r){"use strict";var e=r(147)(!0);r(140)(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,n=this._t,r=this._i;return r>=n.length?{value:void 0,done:!0}:(t=e(n,r),this._i+=t.length,{value:t,done:!1})})},function(t,n,r){"use strict";r(29)("link",function(t){return function(n){return t(this,"a","href",n)}})},function(t,n,r){var e=r(1),i=r(30),o=r(16);e(e.S,"String",{raw:function(t){for(var n=i(t.raw),r=o(n.length),e=arguments.length,u=[],c=0;r>c;)u.push(String(n[c++])),c<e&&u.push(String(arguments[c]));return u.join("")}})},function(t,n,r){var e=r(1);e(e.P,"String",{repeat:r(149)})},function(t,n,r){"use strict";r(29)("small",function(t){return function(){return t(this,"small","","")}})},function(t,n,r){"use strict";var e=r(1),i=r(16),o=r(148),u="startsWith",c=""[u];e(e.P+e.F*r(134)(u),"String",{startsWith:function(t){var n=o(this,t,u),r=i(Math.min(arguments.length>1?arguments[1]:void 0,n.length)),e=String(t);return c?c.call(n,e,r):n.slice(r,r+e.length)===e}})},function(t,n,r){"use strict";r(29)("strike",function(t){return function(){return t(this,"strike","","")}})},function(t,n,r){"use strict";r(29)("sub",function(t){return function(){return t(this,"sub","","")}})},function(t,n,r){"use strict";r(29)("sup",function(t){return function(){return t(this,"sup","","")}})},function(t,n,r){"use strict";r(82)("trim",function(t){return function(){return t(this,3)}})},function(t,n,r){"use strict";var e=r(3),i=r(24),o=r(10),u=r(1),c=r(28),f=r(65).KEY,a=r(4),s=r(126),l=r(81),h=r(76),v=r(7),p=r(182),d=r(153),y=r(206),g=r(205),b=r(138),m=r(2),x=r(30),w=r(50),S=r(66),_=r(70),O=r(174),E=r(31),P=r(11),j=r(72),F=E.f,M=P.f,A=O.f,N=e.Symbol,T=e.JSON,I=T&&T.stringify,k="prototype",L=v("_hidden"),R=v("toPrimitive"),C={}.propertyIsEnumerable,D=s("symbol-registry"),U=s("symbols"),W=s("op-symbols"),G=Object[k],B="function"==typeof N,V=e.QObject,z=!V||!V[k]||!V[k].findChild,q=o&&a(function(){return 7!=_(M({},"a",{get:function(){return M(this,"a",{value:7}).a}})).a})?function(t,n,r){var e=F(G,n);e&&delete G[n],M(t,n,r),e&&t!==G&&M(G,n,e)}:M,K=function(t){var n=U[t]=_(N[k]);return n._k=t,n},J=B&&"symbol"==typeof N.iterator?function(t){return"symbol"==typeof t}:function(t){return t instanceof N},Y=function(t,n,r){return t===G&&Y(W,n,r),m(t),n=w(n,!0),m(r),i(U,n)?(r.enumerable?(i(t,L)&&t[L][n]&&(t[L][n]=!1),r=_(r,{enumerable:S(0,!1)})):(i(t,L)||M(t,L,S(1,{})),t[L][n]=!0),q(t,n,r)):M(t,n,r)},H=function(t,n){m(t);for(var r,e=g(n=x(n)),i=0,o=e.length;o>i;)Y(t,r=e[i++],n[r]);return t},$=function(t,n){return void 0===n?_(t):H(_(t),n)},X=function(t){var n=C.call(this,t=w(t,!0));return!(this===G&&i(U,t)&&!i(W,t))&&(!(n||!i(this,t)||!i(U,t)||i(this,L)&&this[L][t])||n)},Q=function(t,n){if(t=x(t),n=w(n,!0),t!==G||!i(U,n)||i(W,n)){var r=F(t,n);return!r||!i(U,n)||i(t,L)&&t[L][n]||(r.enumerable=!0),r}},Z=function(t){for(var n,r=A(x(t)),e=[],o=0;r.length>o;)i(U,n=r[o++])||n==L||n==f||e.push(n);return e},tt=function(t){for(var n,r=t===G,e=A(r?W:x(t)),o=[],u=0;e.length>u;)!i(U,n=e[u++])||r&&!i(G,n)||o.push(U[n]);return o};B||(N=function(){if(this instanceof N)throw TypeError("Symbol is not a constructor!");var t=h(arguments.length>0?arguments[0]:void 0),n=function(r){this===G&&n.call(W,r),i(this,L)&&i(this[L],t)&&(this[L][t]=!1),q(this,t,S(1,r))};return o&&z&&q(G,t,{configurable:!0,set:n}),K(t)},c(N[k],"toString",function(){return this._k}),E.f=Q,P.f=Y,r(71).f=O.f=Z,r(116).f=X,r(125).f=tt,o&&!r(69)&&c(G,"propertyIsEnumerable",X,!0),p.f=function(t){return K(v(t))}),u(u.G+u.W+u.F*!B,{Symbol:N});for(var nt="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),rt=0;nt.length>rt;)v(nt[rt++]);for(var nt=j(v.store),rt=0;nt.length>rt;)d(nt[rt++]);u(u.S+u.F*!B,"Symbol",{for:function(t){return i(D,t+="")?D[t]:D[t]=N(t)},keyFor:function(t){if(J(t))return y(D,t);throw TypeError(t+" is not a symbol!")},useSetter:function(){z=!0},useSimple:function(){z=!1}}),u(u.S+u.F*!B,"Object",{create:$,defineProperty:Y,defineProperties:H,getOwnPropertyDescriptor:Q,getOwnPropertyNames:Z,getOwnPropertySymbols:tt}),T&&u(u.S+u.F*(!B||a(function(){var t=N();return"[null]"!=I([t])||"{}"!=I({a:t})||"{}"!=I(Object(t))})),"JSON",{stringify:function(t){if(void 0!==t&&!J(t)){for(var n,r,e=[t],i=1;arguments.length>i;)e.push(arguments[i++]);return n=e[1],"function"==typeof n&&(r=n),!r&&b(n)||(n=function(t,n){if(r&&(n=r.call(this,t,n)),!J(n))return n}),e[1]=n,I.apply(T,e)}}}),N[k][R]||r(27)(N[k],R,N[k].valueOf),l(N,"Symbol"),l(Math,"Math",!0),l(e.JSON,"JSON",!0)},function(t,n,r){"use strict";var e=r(1),i=r(127),o=r(152),u=r(2),c=r(75),f=r(16),a=r(6),s=r(3).ArrayBuffer,l=r(146),h=o.ArrayBuffer,v=o.DataView,p=i.ABV&&s.isView,d=h.prototype.slice,y=i.VIEW,g="ArrayBuffer";e(e.G+e.W+e.F*(s!==h),{ArrayBuffer:h}),e(e.S+e.F*!i.CONSTR,g,{isView:function(t){return p&&p(t)||a(t)&&y in t}}),e(e.P+e.U+e.F*r(4)(function(){return!new h(2).slice(1,void 0).byteLength}),g,{slice:function(t,n){if(void 0!==d&&void 0===n)return d.call(u(this),t);for(var r=u(this).byteLength,e=c(t,r),i=c(void 0===n?r:n,r),o=new(l(this,h))(f(i-e)),a=new v(this),s=new v(o),p=0;e<i;)s.setUint8(p++,a.getUint8(e++));return o}}),r(74)(g)},function(t,n,r){var e=r(1);e(e.G+e.W+e.F*!r(127).ABV,{DataView:r(152).DataView})},function(t,n,r){r(55)("Float32",4,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Float64",8,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Int16",2,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Int32",4,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Int8",1,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Uint16",2,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Uint32",4,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Uint8",1,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Uint8",1,function(t){return function(n,r,e){return t(this,n,r,e)}},!0)},function(t,n,r){"use strict";var e=r(166);r(118)("WeakSet",function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},{add:function(t){return e.def(this,t,!0)}},e,!1,!0)},function(t,n,r){"use strict";var e=r(1),i=r(117)(!0);e(e.P,"Array",{includes:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0)}}),r(78)("includes")},function(t,n,r){var e=r(1),i=r(143)(),o=r(3).process,u="process"==r(45)(o);e(e.G,{asap:function(t){var n=u&&o.domain;i(n?n.bind(t):t)}})},function(t,n,r){var e=r(1),i=r(45);e(e.S,"Error",{isError:function(t){return"Error"===i(t)}})},function(t,n,r){var e=r(1);e(e.P+e.R,"Map",{toJSON:r(165)("Map")})},function(t,n,r){var e=r(1);e(e.S,"Math",{iaddh:function(t,n,r,e){var i=t>>>0,o=n>>>0,u=r>>>0;return o+(e>>>0)+((i&u|(i|u)&~(i+u>>>0))>>>31)|0}})},function(t,n,r){var e=r(1);e(e.S,"Math",{imulh:function(t,n){var r=65535,e=+t,i=+n,o=e&r,u=i&r,c=e>>16,f=i>>16,a=(c*u>>>0)+(o*u>>>16);return c*f+(a>>16)+((o*f>>>0)+(a&r)>>16)}})},function(t,n,r){var e=r(1);e(e.S,"Math",{isubh:function(t,n,r,e){var i=t>>>0,o=n>>>0,u=r>>>0;return o-(e>>>0)-((~i&u|~(i^u)&i-u>>>0)>>>31)|0}})},function(t,n,r){var e=r(1);e(e.S,"Math",{umulh:function(t,n){var r=65535,e=+t,i=+n,o=e&r,u=i&r,c=e>>>16,f=i>>>16,a=(c*u>>>0)+(o*u>>>16);return c*f+(a>>>16)+((o*f>>>0)+(a&r)>>>16)}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(26),u=r(11);r(10)&&e(e.P+r(124),"Object",{__defineGetter__:function(t,n){u.f(i(this),t,{get:o(n),enumerable:!0,configurable:!0})}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(26),u=r(11);r(10)&&e(e.P+r(124),"Object",{__defineSetter__:function(t,n){u.f(i(this),t,{set:o(n),enumerable:!0,configurable:!0})}})},function(t,n,r){var e=r(1),i=r(176)(!0);e(e.S,"Object",{entries:function(t){return i(t)}})},function(t,n,r){var e=r(1),i=r(177),o=r(30),u=r(31),c=r(131);e(e.S,"Object",{getOwnPropertyDescriptors:function(t){for(var n,r=o(t),e=u.f,f=i(r),a={},s=0;f.length>s;)c(a,n=f[s++],e(r,n));return a}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(50),u=r(32),c=r(31).f;r(10)&&e(e.P+r(124),"Object",{__lookupGetter__:function(t){var n,r=i(this),e=o(t,!0);do{if(n=c(r,e))return n.get}while(r=u(r))}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(50),u=r(32),c=r(31).f;r(10)&&e(e.P+r(124),"Object",{__lookupSetter__:function(t){var n,r=i(this),e=o(t,!0);do{if(n=c(r,e))return n.set}while(r=u(r))}})},function(t,n,r){var e=r(1),i=r(176)(!1);e(e.S,"Object",{values:function(t){return i(t)}})},function(t,n,r){"use strict";var e=r(1),i=r(3),o=r(52),u=r(143)(),c=r(7)("observable"),f=r(26),a=r(2),s=r(68),l=r(73),h=r(27),v=r(79),p=v.RETURN,d=function(t){return null==t?void 0:f(t)},y=function(t){var n=t._c;n&&(t._c=void 0,n())},g=function(t){return void 0===t._o},b=function(t){g(t)||(t._o=void 0,y(t))},m=function(t,n){a(t),this._c=void 0,this._o=t,t=new x(this);try{var r=n(t),e=r;null!=r&&("function"==typeof r.unsubscribe?r=function(){e.unsubscribe()}:f(r),this._c=r)}catch(n){return void t.error(n)}g(this)&&y(this)};m.prototype=l({},{unsubscribe:function(){b(this)}});var x=function(t){this._s=t};x.prototype=l({},{next:function(t){var n=this._s;if(!g(n)){var r=n._o;try{var e=d(r.next);if(e)return e.call(r,t)}catch(t){try{b(n)}finally{throw t}}}},error:function(t){var n=this._s;if(g(n))throw t;var r=n._o;n._o=void 0;try{var e=d(r.error);if(!e)throw t;t=e.call(r,t)}catch(t){try{y(n)}finally{throw t}}return y(n),t},complete:function(t){var n=this._s;if(!g(n)){var r=n._o;n._o=void 0;try{var e=d(r.complete);t=e?e.call(r,t):void 0}catch(t){try{y(n)}finally{throw t}}return y(n),t}}});var w=function(t){s(this,w,"Observable","_f")._f=f(t)};l(w.prototype,{subscribe:function(t){return new m(t,this._f)},forEach:function(t){var n=this;return new(o.Promise||i.Promise)(function(r,e){f(t);var i=n.subscribe({next:function(n){try{return t(n)}catch(t){e(t),i.unsubscribe()}},error:e,complete:r})})}}),l(w,{from:function(t){var n="function"==typeof this?this:w,r=d(a(t)[c]);if(r){var e=a(r.call(t));return e.constructor===n?e:new n(function(t){return e.subscribe(t)})}return new n(function(n){var r=!1;return u(function(){if(!r){try{if(v(t,!1,function(t){if(n.next(t),r)return p})===p)return}catch(t){if(r)throw t;return void n.error(t)}n.complete()}}),function(){r=!0}})},of:function(){for(var t=0,n=arguments.length,r=Array(n);t<n;)r[t]=arguments[t++];return new("function"==typeof this?this:w)(function(t){var n=!1;return u(function(){if(!n){for(var e=0;e<r.length;++e)if(t.next(r[e]),n)return;t.complete()}}),function(){n=!0}})}}),h(w.prototype,c,function(){return this}),e(e.G,{Observable:w}),r(74)("Observable")},function(t,n,r){var e=r(54),i=r(2),o=e.key,u=e.set;e.exp({defineMetadata:function(t,n,r,e){u(t,n,i(r),o(e))}})},function(t,n,r){var e=r(54),i=r(2),o=e.key,u=e.map,c=e.store;e.exp({deleteMetadata:function(t,n){var r=arguments.length<3?void 0:o(arguments[2]),e=u(i(n),r,!1);if(void 0===e||!e.delete(t))return!1;if(e.size)return!0;var f=c.get(n);return f.delete(r),!!f.size||c.delete(n)}})},function(t,n,r){var e=r(185),i=r(161),o=r(54),u=r(2),c=r(32),f=o.keys,a=o.key,s=function(t,n){var r=f(t,n),o=c(t);if(null===o)return r;var u=s(o,n);return u.length?r.length?i(new e(r.concat(u))):u:r};o.exp({getMetadataKeys:function(t){return s(u(t),arguments.length<2?void 0:a(arguments[1]))}})},function(t,n,r){var e=r(54),i=r(2),o=r(32),u=e.has,c=e.get,f=e.key,a=function(t,n,r){if(u(t,n,r))return c(t,n,r);var e=o(n);return null!==e?a(t,e,r):void 0};e.exp({getMetadata:function(t,n){return a(t,i(n),arguments.length<3?void 0:f(arguments[2]))}})},function(t,n,r){var e=r(54),i=r(2),o=e.keys,u=e.key;e.exp({getOwnMetadataKeys:function(t){
return o(i(t),arguments.length<2?void 0:u(arguments[1]))}})},function(t,n,r){var e=r(54),i=r(2),o=e.get,u=e.key;e.exp({getOwnMetadata:function(t,n){return o(t,i(n),arguments.length<3?void 0:u(arguments[2]))}})},function(t,n,r){var e=r(54),i=r(2),o=r(32),u=e.has,c=e.key,f=function(t,n,r){if(u(t,n,r))return!0;var e=o(n);return null!==e&&f(t,e,r)};e.exp({hasMetadata:function(t,n){return f(t,i(n),arguments.length<3?void 0:c(arguments[2]))}})},function(t,n,r){var e=r(54),i=r(2),o=e.has,u=e.key;e.exp({hasOwnMetadata:function(t,n){return o(t,i(n),arguments.length<3?void 0:u(arguments[2]))}})},function(t,n,r){var e=r(54),i=r(2),o=r(26),u=e.key,c=e.set;e.exp({metadata:function(t,n){return function(r,e){c(t,n,(void 0!==e?i:o)(r),u(e))}}})},function(t,n,r){var e=r(1);e(e.P+e.R,"Set",{toJSON:r(165)("Set")})},function(t,n,r){"use strict";var e=r(1),i=r(147)(!0);e(e.P,"String",{at:function(t){return i(this,t)}})},function(t,n,r){"use strict";var e=r(1),i=r(46),o=r(16),u=r(122),c=r(120),f=RegExp.prototype,a=function(t,n){this._r=t,this._s=n};r(139)(a,"RegExp String",function(){var t=this._r.exec(this._s);return{value:t,done:null===t}}),e(e.P,"String",{matchAll:function(t){if(i(this),!u(t))throw TypeError(t+" is not a regexp!");var n=String(this),r="flags"in f?String(t.flags):c.call(t),e=new RegExp(t.source,~r.indexOf("g")?r:"g"+r);return e.lastIndex=o(t.lastIndex),new a(e,n)}})},function(t,n,r){"use strict";var e=r(1),i=r(181);e(e.P,"String",{padEnd:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0,!1)}})},function(t,n,r){"use strict";var e=r(1),i=r(181);e(e.P,"String",{padStart:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0,!0)}})},function(t,n,r){"use strict";r(82)("trimLeft",function(t){return function(){return t(this,1)}},"trimStart")},function(t,n,r){"use strict";r(82)("trimRight",function(t){return function(){return t(this,2)}},"trimEnd")},function(t,n,r){r(153)("asyncIterator")},function(t,n,r){r(153)("observable")},function(t,n,r){var e=r(1);e(e.S,"System",{global:r(3)})},function(t,n,r){for(var e=r(155),i=r(28),o=r(3),u=r(27),c=r(80),f=r(7),a=f("iterator"),s=f("toStringTag"),l=c.Array,h=["NodeList","DOMTokenList","MediaList","StyleSheetList","CSSRuleList"],v=0;v<5;v++){var p,d=h[v],y=o[d],g=y&&y.prototype;if(g){g[a]||u(g,a,l),g[s]||u(g,s,d),c[d]=l;for(p in e)g[p]||i(g,p,e[p],!0)}}},function(t,n,r){var e=r(1),i=r(151);e(e.G+e.B,{setImmediate:i.set,clearImmediate:i.clear})},function(t,n,r){var e=r(3),i=r(1),o=r(121),u=r(207),c=e.navigator,f=!!c&&/MSIE .\./.test(c.userAgent),a=function(t){return f?function(n,r){return t(o(u,[].slice.call(arguments,2),"function"==typeof n?n:Function(n)),r)}:t};i(i.G+i.B+i.F*f,{setTimeout:a(e.setTimeout),setInterval:a(e.setInterval)})},function(t,n,r){r(330),r(269),r(271),r(270),r(273),r(275),r(280),r(274),r(272),r(282),r(281),r(277),r(278),r(276),r(268),r(279),r(283),r(284),r(236),r(238),r(237),r(286),r(285),r(256),r(266),r(267),r(257),r(258),r(259),r(260),r(261),r(262),r(263),r(264),r(265),r(239),r(240),r(241),r(242),r(243),r(244),r(245),r(246),r(247),r(248),r(249),r(250),r(251),r(252),r(253),r(254),r(255),r(317),r(322),r(329),r(320),r(312),r(313),r(318),r(323),r(325),r(308),r(309),r(310),r(311),r(314),r(315),r(316),r(319),r(321),r(324),r(326),r(327),r(328),r(231),r(233),r(232),r(235),r(234),r(220),r(218),r(224),r(221),r(227),r(229),r(217),r(223),r(214),r(228),r(212),r(226),r(225),r(219),r(222),r(211),r(213),r(216),r(215),r(230),r(155),r(302),r(307),r(184),r(303),r(304),r(305),r(306),r(287),r(183),r(185),r(186),r(342),r(331),r(332),r(337),r(340),r(341),r(335),r(338),r(336),r(339),r(333),r(334),r(288),r(289),r(290),r(291),r(292),r(295),r(293),r(294),r(296),r(297),r(298),r(299),r(301),r(300),r(343),r(369),r(372),r(371),r(373),r(374),r(370),r(375),r(376),r(354),r(357),r(353),r(351),r(352),r(355),r(356),r(346),r(368),r(377),r(345),r(347),r(349),r(348),r(350),r(359),r(360),r(362),r(361),r(364),r(363),r(365),r(366),r(367),r(344),r(358),r(380),r(379),r(378),t.exports=r(52)},function(t,n){function r(t,n){if("string"==typeof n)return t.insertAdjacentHTML("afterend",n);var r=t.nextSibling;return r?t.parentNode.insertBefore(n,r):t.parentNode.appendChild(n)}t.exports=r},,,,,,,,,function(t,n,r){(function(n,r){!function(n){"use strict";function e(t,n,r,e){var i=n&&n.prototype instanceof o?n:o,u=Object.create(i.prototype),c=new p(e||[]);return u._invoke=s(t,r,c),u}function i(t,n,r){try{return{type:"normal",arg:t.call(n,r)}}catch(t){return{type:"throw",arg:t}}}function o(){}function u(){}function c(){}function f(t){["next","throw","return"].forEach(function(n){t[n]=function(t){return this._invoke(n,t)}})}function a(t){function n(r,e,o,u){var c=i(t[r],t,e);if("throw"!==c.type){var f=c.arg,a=f.value;return a&&"object"==typeof a&&m.call(a,"__await")?Promise.resolve(a.__await).then(function(t){n("next",t,o,u)},function(t){n("throw",t,o,u)}):Promise.resolve(a).then(function(t){f.value=t,o(f)},u)}u(c.arg)}function e(t,r){function e(){return new Promise(function(e,i){n(t,r,e,i)})}return o=o?o.then(e,e):e()}"object"==typeof r&&r.domain&&(n=r.domain.bind(n));var o;this._invoke=e}function s(t,n,r){var e=P;return function(o,u){if(e===F)throw new Error("Generator is already running");if(e===M){if("throw"===o)throw u;return y()}for(r.method=o,r.arg=u;;){var c=r.delegate;if(c){var f=l(c,r);if(f){if(f===A)continue;return f}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(e===P)throw e=M,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);e=F;var a=i(t,n,r);if("normal"===a.type){if(e=r.done?M:j,a.arg===A)continue;return{value:a.arg,done:r.done}}"throw"===a.type&&(e=M,r.method="throw",r.arg=a.arg)}}}function l(t,n){var r=t.iterator[n.method];if(r===g){if(n.delegate=null,"throw"===n.method){if(t.iterator.return&&(n.method="return",n.arg=g,l(t,n),"throw"===n.method))return A;n.method="throw",n.arg=new TypeError("The iterator does not provide a 'throw' method")}return A}var e=i(r,t.iterator,n.arg);if("throw"===e.type)return n.method="throw",n.arg=e.arg,n.delegate=null,A;var o=e.arg;return o?o.done?(n[t.resultName]=o.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=g),n.delegate=null,A):o:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,A)}function h(t){var n={tryLoc:t[0]};1 in t&&(n.catchLoc=t[1]),2 in t&&(n.finallyLoc=t[2],n.afterLoc=t[3]),this.tryEntries.push(n)}function v(t){var n=t.completion||{};n.type="normal",delete n.arg,t.completion=n}function p(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(h,this),this.reset(!0)}function d(t){if(t){var n=t[w];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var r=-1,e=function n(){for(;++r<t.length;)if(m.call(t,r))return n.value=t[r],n.done=!1,n;return n.value=g,n.done=!0,n};return e.next=e}}return{next:y}}function y(){return{value:g,done:!0}}var g,b=Object.prototype,m=b.hasOwnProperty,x="function"==typeof Symbol?Symbol:{},w=x.iterator||"@@iterator",S=x.asyncIterator||"@@asyncIterator",_=x.toStringTag||"@@toStringTag",O="object"==typeof t,E=n.regeneratorRuntime;if(E)return void(O&&(t.exports=E));E=n.regeneratorRuntime=O?t.exports:{},E.wrap=e;var P="suspendedStart",j="suspendedYield",F="executing",M="completed",A={},N={};N[w]=function(){return this};var T=Object.getPrototypeOf,I=T&&T(T(d([])));I&&I!==b&&m.call(I,w)&&(N=I);var k=c.prototype=o.prototype=Object.create(N);u.prototype=k.constructor=c,c.constructor=u,c[_]=u.displayName="GeneratorFunction",E.isGeneratorFunction=function(t){var n="function"==typeof t&&t.constructor;return!!n&&(n===u||"GeneratorFunction"===(n.displayName||n.name))},E.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,c):(t.__proto__=c,_ in t||(t[_]="GeneratorFunction")),t.prototype=Object.create(k),t},E.awrap=function(t){return{__await:t}},f(a.prototype),a.prototype[S]=function(){return this},E.AsyncIterator=a,E.async=function(t,n,r,i){var o=new a(e(t,n,r,i));return E.isGeneratorFunction(n)?o:o.next().then(function(t){return t.done?t.value:o.next()})},f(k),k[_]="Generator",k.toString=function(){return"[object Generator]"},E.keys=function(t){var n=[];for(var r in t)n.push(r);return n.reverse(),function r(){for(;n.length;){var e=n.pop();if(e in t)return r.value=e,r.done=!1,r}return r.done=!0,r}},E.values=d,p.prototype={constructor:p,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=g,this.done=!1,this.delegate=null,this.method="next",this.arg=g,this.tryEntries.forEach(v),!t)for(var n in this)"t"===n.charAt(0)&&m.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=g)},stop:function(){this.done=!0;var t=this.tryEntries[0],n=t.completion;if("throw"===n.type)throw n.arg;return this.rval},dispatchException:function(t){function n(n,e){return o.type="throw",o.arg=t,r.next=n,e&&(r.method="next",r.arg=g),!!e}if(this.done)throw t;for(var r=this,e=this.tryEntries.length-1;e>=0;--e){var i=this.tryEntries[e],o=i.completion;if("root"===i.tryLoc)return n("end");if(i.tryLoc<=this.prev){var u=m.call(i,"catchLoc"),c=m.call(i,"finallyLoc");if(u&&c){if(this.prev<i.catchLoc)return n(i.catchLoc,!0);if(this.prev<i.finallyLoc)return n(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return n(i.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return n(i.finallyLoc)}}}},abrupt:function(t,n){for(var r=this.tryEntries.length-1;r>=0;--r){var e=this.tryEntries[r];if(e.tryLoc<=this.prev&&m.call(e,"finallyLoc")&&this.prev<e.finallyLoc){var i=e;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=n&&n<=i.finallyLoc&&(i=null);var o=i?i.completion:{};return o.type=t,o.arg=n,i?(this.method="next",this.next=i.finallyLoc,A):this.complete(o)},complete:function(t,n){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&n&&(this.next=n),A},finish:function(t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),v(r),A}},catch:function(t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc===t){var e=r.completion;if("throw"===e.type){var i=e.arg;v(r)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:d(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=g),A}}}("object"==typeof n?n:"object"==typeof window?window:"object"==typeof self?self:this)}).call(n,function(){return this}(),r(158))}])</script><script src="/./main.0cf68a.js"></script><script>!function(){!function(e){var t=document.createElement("script");document.getElementsByTagName("body")[0].appendChild(t),t.setAttribute("src",e)}("/slider.e37972.js")}()</script>


<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


    
<div class="tools-col" q-class="show:isShow,hide:isShow|isFalse" q-on="click:stop(e)">
  <div class="tools-nav header-menu">
    
    
      
      
      
    
      
      
      
    
      
      
      
    
    

    <ul style="width: 70%">
    
    
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'innerArchive')"><a href="javascript:void(0)" q-class="active:innerArchive">所有文章</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'friends')"><a href="javascript:void(0)" q-class="active:friends">友链</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'aboutme')"><a href="javascript:void(0)" q-class="active:aboutme">关于我</a></li>
      
        
    </ul>
  </div>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all" q-show="innerArchive">
        <div class="search-wrap">
          <input class="search-ipt" q-model="search" type="text" placeholder="find something…">
          <i class="icon-search icon" q-show="search|isEmptyStr"></i>
          <i class="icon-close icon" q-show="search|isNotEmptyStr" q-on="click:clearChose(e)"></i>
        </div>
        <div class="widget tagcloud search-tag">
          <p class="search-tag-wording">tag:</p>
          <label class="search-switch">
            <input type="checkbox" q-on="click:toggleTag(e)" q-attr="checked:showTags">
          </label>
          <ul class="article-tag-list" q-show="showTags">
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">http</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">learn</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">java</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">mysql</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">docker</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">Hexo</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">read</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">数据库</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">linux</a>
              </li>
            
            <div class="clearfix"></div>
          </ul>
        </div>
        <ul class="search-ul">
          <p q-show="jsonFail" style="padding: 20px; font-size: 12px;">
            缺失模块。<br/>1、请确保node版本大于6.2<br/>2、在博客根目录（注意不是yilia根目录）执行以下命令：<br/> npm i hexo-generator-json-content --save<br/><br/>
            3、在根目录_config.yml里添加配置：
<pre style="font-size: 12px;" q-show="jsonFail">
  jsonContent:
    meta: false
    pages: false
    posts:
      title: true
      date: true
      path: true
      text: false
      raw: false
      content: false
      slug: false
      updated: false
      comments: false
      link: false
      permalink: false
      excerpt: false
      categories: false
      tags: true
</pre>
          </p>
          <li class="search-li" q-repeat="items" q-show="isShow">
            <a q-attr="href:path|urlformat" class="search-title"><i class="icon-quo-left icon"></i><span q-text="title"></span></a>
            <p class="search-time">
              <i class="icon-calendar icon"></i>
              <span q-text="date|dateformat"></span>
            </p>
            <p class="search-tag">
              <i class="icon-price-tags icon"></i>
              <span q-repeat="tags" q-on="click:choseTag(e, name)" q-text="name|tagformat"></span>
            </p>
          </li>
        </ul>
    	</section>
    

    
    	<section class="tools-section tools-section-friends" q-show="friends">
  		
        <ul class="search-ul">
          
            <li class="search-li">
              <a href="http://wallquick.vip" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>墙快</a>
            </li>
          
            <li class="search-li">
              <a href="https://www.murphyyi.com" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>墨菲主页</a>
            </li>
          
        </ul>
  		
    	</section>
    

    
    	<section class="tools-section tools-section-me" q-show="aboutme">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">很惭愧&lt;br&gt;&lt;br&gt;只做了一点微小的工作&lt;br&gt;谢谢大家</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>